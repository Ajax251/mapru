<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" id="favicon" href="img/tab.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <title>Форматирование таблицы</title>
    <style>
        :root {
            --table-font-size: 9pt;
            --table-font-family: Arial, Helvetica, sans-serif;
            --primary-color: #0078D4;
            --secondary-color: #6395ee;
            --danger-color: #ed2100;
            --success-color: #107C10;
            --hover-primary: #005a9e;
            --hover-danger: #c51900;
            --hover-success: #0b530b;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #ccc;
            --header-bg: #e9ecef;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* This variable is no longer used by .container */
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color var(--transition-speed) ease;
        }

        .container {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: none;
            margin: 20px 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        .container:hover {
            box-shadow: none;
            transform: translateY(-2px);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }

        .input-area {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
        }

        .input-area label {
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.05em;
        }

        #excelInput {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.95em;
            resize: vertical;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        #excelInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }

        .controls {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

               .controls button, .template-actions button, #applyReplaceButton, #undoReplaceButton {
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all var(--transition-speed) ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            line-height: 1;
        }
        
        .controls button:disabled, .template-actions button:disabled, #applyReplaceButton:disabled, #undoReplaceButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .controls button i, .template-actions button i, #applyReplaceButton i, #undoReplaceButton i {
            margin: 0;
            font-size: 1.1em;
        }

        .controls button span, .template-actions button span, #applyReplaceButton span, #undoReplaceButton span {
            line-height: 1;
        }

        .controls button:not(:disabled):hover, .template-actions button:not(:disabled):hover, #applyReplaceButton:not(:disabled):hover, #undoReplaceButton:not(:disabled):hover {
            background-color: var(--hover-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .controls button:active, .template-actions button:active, #applyReplaceButton:active, #undoReplaceButton:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .controls button.secondary, .template-actions button.secondary, #applyReplaceButton.secondary, #undoReplaceButton.secondary {
            background-color: var(--danger-color);
        }

        .controls button.secondary:not(:disabled):hover, .template-actions button.secondary:not(:disabled):hover, #applyReplaceButton.secondary:not(:disabled):hover, #undoReplaceButton.secondary:not(:disabled):hover {
            background-color: var(--hover-danger);
        }
        
        .controls button.success {
            background-color: var(--success-color);
        }
        .controls button.success:not(:disabled):hover {
            background-color: var(--hover-success);
        }

        #tableCustomizationArea {
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
            width: 100%;
        }

        .options-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            border-radius: 8px;
            background-color: rgba(99, 149, 238, 0.05);
            border: 1px solid rgba(99, 149, 238, 0.2);
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .template-actions {
            display: flex;
            gap: 10px;
            margin-left: auto; /* Pushes the button group to the right */
        }

        .option-item label {
            font-size: 0.95em;
            color: var(--text-color);
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
        }

        .option-item input[type="checkbox"] {
            width: 17px;
            height: 17px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        .option-item input[type="text"],
        .option-item input[type="number"],
        .option-item select {
            padding: 7px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.9em;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        
        .option-item input[type="text"]:focus,
        .option-item input[type="number"]:focus,
        .option-item select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .option-item input[type="text"] {
             min-width: 150px;
        }

        .option-item input[type="number"] {
            width: 70px;
        }

        .option-item select {
            min-width: 120px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        #customPageSizeInputs label {
            font-size: 0.85em;
        }
        #customPageSizeInputs input[type="number"] {
            width: 60px;
        }

        #tableRenderContainer {
            overflow-x: auto;
            flex-grow: 1;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            border-radius: 8px;
            transition: box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease, border var(--transition-speed) ease;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0;
        }
        #tableRenderContainer.preview-active {
            background-color: var(--bg-color);
            border: none;
            padding: 20px 0;
            overflow: auto;
        }


        #tableRenderContainer:hover:not(.preview-active) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #printPreviewPage {
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            margin: 0;
            overflow: hidden;
            position: relative;
            transform-origin: center top;
        }

        #printPreviewPage > table {
            width: 100%;
            margin:0;
        }
        
.row-num-col {
    width: 45px !important;
    min-width: 45px !important;
    max-width: 45px !important;
    text-align: center !important;
    white-space: nowrap;
    padding-left: 5px !important;
    padding-right: 5px !important;
    box-sizing: border-box !important; 
}

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: var(--table-font-size);
            font-family: var(--table-font-family);
            background-color: var(--card-bg);
        }


        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            color: var(--text-color);
            background-color: var(--card-bg);
            transition: background-color 0.2s ease;
        }
         #printPreviewPage th, #printPreviewPage td {
            background-color: white;
         }


     th {
    background: linear-gradient(180deg, #e8f2fc, #d4e6f9) !important;
    font-weight: bold;
    position: relative;
    text-align: center;
}
        
        td {
            text-align: left;
        }

        td.text-center {
            text-align: center !important;
        }

        tr:hover td {
            background-color: rgba(99, 149, 238, 0.05);
        }
         #printPreviewPage tr:hover td {
            background-color: #f0f8ff;
         }

        .resizer {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            background-color: rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease;
            z-index:10;
        }

        .resizer:hover {
            background-color: var(--primary-color);
        }
        
        .column-width-controls h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--text-color);
            font-weight: 600;
        }

        .column-width-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; 
        }

        .column-width-input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: rgba(0,0,0,0.02);
        }
        
        .column-width-input-group > div:not(:first-child) {
             margin-top: 8px;
        }

        .column-width-input-group label { 
            font-size: 0.9em;
            color: var(--text-color);
            font-weight: 500;
        }

        .column-width-input-group input[type="number"] {
            width: 70px; 
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
         .column-width-input-group input[type="checkbox"] {
            width: auto;
            height: auto;
            accent-color: var(--primary-color);
            vertical-align: middle;
        }

        .column-width-input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }


th {
    background: linear-gradient(180deg, #e8f2fc, #d4e6f9) !important;
    font-weight: bold;
    position: relative;
    text-align: center;
    cursor: pointer;
    user-select: none;
    border-color: #b8d4f0;
}

.sort-icon {
    display: inline-block;
    margin-left: 6px;
    font-size: 0.8em;
    color: rgba(0, 0, 0, 0.4);
    transition: color 0.2s ease;
}

th:hover .sort-icon {
    color: rgba(0, 0, 0, 0.7);
}

th.sort-asc .sort-icon::after {
    content: '▲';
    color: var(--primary-color);
}

th.sort-desc .sort-icon::after {
    content: '▼';
    color: var(--primary-color);
}

th:not(.sort-asc):not(.sort-desc) .sort-icon::after {
    content: '⇅';
}


/* Export Dialog */
.export-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeInOverlay 0.2s ease;
}

@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}

.export-dialog {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 30px;
    min-width: 320px;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideInDialog 0.3s ease;
}

@keyframes slideInDialog {
    from { opacity: 0; transform: translateY(-30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.export-dialog h2 {
    margin: 0 0 20px 0;
    font-size: 1.3em;
    color: var(--text-color);
    text-align: center;
}

.export-dialog-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.export-dialog-options button {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    cursor: pointer;
    font-size: 1em;
    font-weight: 500;
    color: var(--text-color);
    transition: all 0.2s ease;
}

.export-dialog-options button:hover {
    border-color: var(--primary-color);
    background: rgba(0, 120, 212, 0.06);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.export-dialog-options button i {
    font-size: 1.4em;
    width: 28px;
    text-align: center;
}

.export-dialog-options button .export-icon-xlsx { color: #107C10; }
.export-dialog-options button .export-icon-docx { color: #2B579A; }
.export-dialog-options button .export-icon-csv { color: #E87400; }
.export-dialog-options button .export-icon-html { color: #E44D26; }

.export-dialog-cancel {
    margin-top: 18px;
    text-align: center;
}

.export-dialog-cancel button {
    padding: 10px 32px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-color);
    cursor: pointer;
    font-size: 0.95em;
    font-weight: 600;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.export-dialog-cancel button:hover {
    border-color: var(--danger-color);
    color: var(--danger-color);
    background: rgba(237, 33, 0, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(237, 33, 0, 0.12);
}

.export-dialog-cancel button:active {
    transform: translateY(0);
    box-shadow: none;
}


/* Column filter dropdown */
.th-filter-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border: none;
    background: transparent;
    cursor: pointer;
    color: rgba(0,0,0,0.35);
    font-size: 0.75em;
    padding: 0;
    margin-left: 4px;
    border-radius: 3px;
    transition: all 0.2s;
    vertical-align: middle;
}

.th-filter-btn:hover {
    color: var(--primary-color);
    background: rgba(0,120,212,0.1);
}

.th-filter-btn.active {
    color: #fff;
    background: var(--primary-color);
}

.col-filter-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9998;
}

.col-filter-dropdown {
    position: fixed;
    z-index: 9999;
    background: #fff;
    border: 1px solid #b8d4f0;
    border-radius: 8px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.18);
    min-width: 220px;
    max-width: 320px;
    max-height: 370px;
    display: flex;
    flex-direction: column;
    animation: fadeInDropdown 0.15s ease;
    font-size: 13px;
}

@keyframes fadeInDropdown {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
}

.col-filter-dropdown .cfd-search {
    padding: 8px 10px;
    border-bottom: 1px solid #e8eff7;
}

.col-filter-dropdown .cfd-search input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 13px;
    outline: none;
    box-sizing: border-box;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.col-filter-dropdown .cfd-search input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0,120,212,0.15);
}

.col-filter-dropdown .cfd-actions-top {
    display: flex;
    gap: 6px;
    padding: 6px 10px;
    border-bottom: 1px solid #e8eff7;
}

.col-filter-dropdown .cfd-actions-top a {
    font-size: 12px;
    color: var(--primary-color);
    cursor: pointer;
    text-decoration: none;
    white-space: nowrap;
}

.col-filter-dropdown .cfd-actions-top a:hover {
    text-decoration: underline;
}

.col-filter-dropdown .cfd-list {
    overflow-y: auto;
    flex: 1;
    padding: 4px 0;
    min-height: 60px;
    max-height: 230px;
}

.col-filter-dropdown .cfd-list label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    cursor: pointer;
    transition: background 0.15s;
    font-weight: normal;
    font-size: 13px;
    line-height: 1.5;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.col-filter-dropdown .cfd-list label:hover {
    background: rgba(0,120,212,0.06);
}

.col-filter-dropdown .cfd-list input[type="checkbox"] {
    width: 15px;
    height: 15px;
    accent-color: var(--primary-color);
    flex-shrink: 0;
}

.col-filter-dropdown .cfd-list .cfd-empty {
    padding: 12px;
    text-align: center;
    color: #999;
    font-style: italic;
}

.col-filter-dropdown .cfd-bottom {
    display: flex;
    gap: 8px;
    padding: 8px 10px;
    border-top: 1px solid #e8eff7;
    justify-content: flex-end;
}

.col-filter-dropdown .cfd-bottom button {
    padding: 5px 14px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.col-filter-dropdown .cfd-bottom button.cfd-ok {
    background: var(--primary-color);
    color: #fff;
    border-color: var(--primary-color);
}

.col-filter-dropdown .cfd-bottom button.cfd-ok:hover {
    background: var(--hover-primary);
}

.col-filter-dropdown .cfd-bottom button.cfd-cancel:hover {
    border-color: var(--danger-color);
    color: var(--danger-color);
}

th .th-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
}

th .th-content:hover {
    color: var(--primary-color);
}

#printPreviewPage th {
    background: linear-gradient(180deg, #e8f2fc, #d4e6f9) !important;
}


        #tablePlaceholder {
            text-align: center;
            color: #777;
            padding: 30px;
            font-size: 1.1em;
            animation: pulse 2s infinite ease-in-out;
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; margin: 10px 0; }
            .controls { flex-direction: row; justify-content: flex-start; }
            .options-bar { gap: 10px; padding: 10px; }
             .template-actions { margin-left: 0; width: 100%; justify-content: flex-start; }
            .column-width-inputs { gap: 15px; }
            .column-width-input-group { width: calc(50% - 10px); }
            .column-width-input-group input[type="number"] { width: 60px; }
        }
         @media (max-width: 480px) {
            .column-width-input-group { width: 100%; }
            .options-bar { flex-direction: column; align-items: stretch; }
            .option-item { justify-content: space-between; }
            .option-item select, .option-item input[type="number"], .option-item input[type="text"] { min-width: 100px; width: auto; }
            #customPageSizeInputs { flex-direction: column; gap: 5px; align-items: stretch; }
            #customPageSizeInputs label { display: inline-block; width: auto; margin-right: 5px; }
            #customPageSizeInputs input[type="number"]{ width: 100%; }
        }


        @media print {
            /* Styles for printing remain unchanged */
            body * { visibility: hidden !important; }
            
            .th-filter-btn { display: none !important; }
.col-filter-dropdown, .col-filter-overlay { display: none !important; }

            #tableRenderContainer, #tableRenderContainer *, #printPreviewPage, #printPreviewPage *, table, thead, tbody, tr, th, td { visibility: visible !important; }
            body { font-family: var(--table-font-family) !important; font-size: 10pt !important; background-color: #ffffff !important; color: #000000 !important; margin: 0 !important; padding: 0 !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            .container { width: 100% !important; max-width: none !important; padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; background-color: #ffffff !important; }
            h1, .input-area, .controls, #tableCustomizationArea, #tablePlaceholder:not(:empty), .resizer { display: none !important; }
            #tableRenderContainer, #tableRenderContainer.preview-active { display: block !important; width: 100% !important; overflow: visible !important; border: none !important; background-color: #ffffff !important; margin: 0 !important; padding: 0 !important; position: static !important; }
            #printPreviewPage { width: auto !important; height: auto !important; transform: none !important; box-shadow: none !important; background-color: transparent !important; margin: 0 !important; padding: 0 !important; overflow: visible !important; }
            #tableRenderContainer > table, #printPreviewPage > table { display: table !important; width: 100% !important; font-size: var(--table-font-size) !important; font-family: inherit !important; table-layout: fixed !important; border-collapse: collapse !important; background-color: #ffffff !important; margin: 0 auto !important; page-break-inside: auto !important; }
            thead { display: table-header-group !important; }
            tbody { display: table-row-group !important; }
            tr { display: table-row !important; page-break-inside: avoid !important; }
            th, td { display: table-cell !important; border: 1px solid #000000 !important; padding: 4px 6px !important; word-wrap: break-word !important; overflow-wrap: break-word !important; color: #000000 !important; background-color: #ffffff !important; vertical-align: top !important; }
            th[style*="display: none"], td[style*="display: none"] { display: none !important; }
            tr[style*="display: none"] { display: none !important; } /* Hide filtered rows when printing */
          th { font-weight: bold !important; background: #e8f2fc !important; text-align: center !important; }
.column-filter-input { display: none !important; }
            td.text-center { text-align: center !important; }
            td:not(.text-center) { text-align: left !important; }
            * { box-sizing: border-box; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Форматирование таблицы для печати</h1>

        <div class="input-area">
            <label for="excelInput">Вставьте скопированные ячейки из таблицы сюда (разделитель - табуляция):</label>
            <textarea id="excelInput" rows="8" placeholder="Например:
Заголовок1	Заголовок2	Заголовок3
Данные1А	Данные2А	Данные3А с очень длинным текстом, который должен переноситься
Данные1Б	Данные2Б	Данные3Б"></textarea>
        </div>

        <div class="controls">
            <button id="toggleColumnWidthsButton" style="display:none;" title="Настроить ширину колонок"><i class="fas fa-arrows-alt-h"></i><span>&nbsp;Ширина</span></button>
            <button id="applyLastTemplateButton" style="display:none;" title="Применить последний использованный шаблон"><i class="fas fa-wand-magic-sparkles"></i><span>&nbsp;Шаблон</span></button>
            <button id="printButton" style="display:none;" title="Распечатать"><i class="fas fa-print"></i><span>&nbsp;Печать</span></button>
            <button id="exportXlsxButton" class="success" style="display:none;" title="Экспорт в XLSX"><i class="fas fa-file-excel"></i><span>&nbsp;Экспорт</span></button>
            <button id="clearButton" class="secondary" style="display:none;" title="Очистить"><i class="fas fa-trash-alt"></i><span>&nbsp;Очистить</span></button>
        </div>
        
        <div id="tableCustomizationArea" style="display:none;">
            <!-- Filter and Replace Area -->
       <div class="options-bar" style="flex-direction: column; align-items: stretch;">
                <div class="option-item" style="margin-bottom: 10px;">
                     <label for="filterInput">Фильтр по таблице:</label>
                     <input type="text" id="filterInput" placeholder="Фильтр по тексту..." style="width: 100%; max-width: 300px;">
                </div>
                <div class="option-item" style="flex-direction: column; align-items: flex-start; width: 100%;">
                     <label for="replaceRulesInput" style="margin-bottom: 5px;">Правила автозамены (формат: <b>Что#На что</b>, каждое правило с новой строки):</label>
              <textarea id="replaceRulesInput" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical; font-family: inherit;" placeholder="Общество с ограниченной ответственностью#ООО&#10;##ул. Садовая (удалит весь текст в ячейке ДО этого слова, само слово останется)&#10;##ул. Садовая# (удалит весь текст в ячейке ДО этого слова и само слово)"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="applyReplaceButton" title="Выполнить автозамену во всей таблице"><i class="fas fa-exchange-alt"></i><span>&nbsp;Применить автозамену</span></button>
                    <button id="undoReplaceButton" class="secondary" style="display:none;" title="Отменить замену и вернуть исходный текст"><i class="fas fa-undo"></i><span>&nbsp;Отмена</span></button>
                </div>
            </div>

            <!-- Table Style and Font Area -->
            <div class="options-bar">
                <div class="option-item">
                    <input type="checkbox" id="useHeaderCheckbox" checked />
                    <label for="useHeaderCheckbox">Заголовок</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="centerAlignCheckbox" />
                    <label for="centerAlignCheckbox">Центрировать</label>
                </div>
                <div class="option-item">
                    <label for="fontSizeInput">Размер:</label>
                    <input type="number" id="fontSizeInput" value="9" min="6" max="24" step="0.5"/>
                </div>
                <div class="option-item">
                    <label for="fontFamilySelect">Шрифт:</label>
                    <select id="fontFamilySelect">
                        <option value="Arial, Helvetica, sans-serif">Arial</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="Verdana, Geneva, sans-serif">Verdana</option>
                        <option value="Tahoma, Geneva, sans-serif">Tahoma</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="Calibri, Candara, Segoe, 'Segoe UI', Optima, Arial, sans-serif">Calibri</option>
                        <option value="Cambria, Cochin, Georgia, Times, 'Times New Roman', serif">Cambria</option>
                    </select>
                </div>
            </div>

            <!-- Page Preview Setup Area -->
            <div id="pageSetupBar" class="options-bar">
                <div class="option-item">
                    <input type="checkbox" id="enablePreviewCheckbox" />
                    <label for="enablePreviewCheckbox">Предпросмотр</label>
                </div>
                
              <div class="option-item">
                    <input type="checkbox" id="rowNumbersCheckbox" />
                    <label for="rowNumbersCheckbox" style="font-weight: 600; color: var(--primary-color);">Порядковый №</label>
                </div>
                
                <div class="option-item preview-option" style="display:none;">
                    <label for="pageSizeSelect">Формат:</label>
                    <select id="pageSizeSelect">
                        <option value="A4">A4</option>
                        <option value="A3">A3</option>
                        <option value="Letter">Letter (US)</option>
                        <option value="Legal">Legal (US)</option>
                        <option value="Custom">Свой</option>
                    </select>
                </div>
                <div class="option-item preview-option" id="customPageSizeInputs" style="display:none;">
                     <label for="customWidth">Шир(мм):</label>
                     <input type="number" id="customWidth" value="210" min="50">
                     <label for="customHeight">Выс(мм):</label>
                     <input type="number" id="customHeight" value="297" min="50">
                </div>
                <div class="option-item preview-option" style="display:none;">
                    <label for="pageOrientationSelect">Ориентация:</label>
                    <select id="pageOrientationSelect">
                        <option value="portrait">Портретная</option>
                        <option value="landscape">Альбомная</option>
                    </select>
                </div>
                 <div class="option-item preview-option" style="display:none;">
                    <label for="pageScaleInput">Масштаб (%):</label>
                    <input type="number" id="pageScaleInput" value="70" min="10" max="150" step="5">
                </div>
            </div>

            <!-- Template Management Area -->
            <div class="options-bar">
                <div class="option-item">
                    <label for="templateSelect">Шаблоны:</label>
                    <select id="templateSelect"></select>
                </div>
                <div class="template-actions">
                    <button id="loadTemplateButton" title="Загрузить выбранный шаблон"><i class="fas fa-download"></i><span>&nbsp;Загрузить</span></button>
                    <button id="saveTemplateButton" title="Сохранить текущие настройки колонок как шаблон"><i class="fas fa-save"></i><span>&nbsp;Сохранить</span></button>
                    <button id="deleteTemplateButton" class="secondary" title="Удалить выбранный шаблон"><i class="fas fa-trash-alt"></i><span>&nbsp;Удалить</span></button>
                </div>
            </div>

            <!-- Column Width Controls Area -->
            <div id="columnWidthControlsContainer" class="column-width-controls" style="display:none;">
                 <h3>Настройка ширины столбцов (в %):</h3>
                 <div id="columnWidthInputs" class="column-width-inputs">
                 </div>
            </div>
        </div>

        <div id="tableRenderContainer">
            <p id="tablePlaceholder" style="text-align: center; color: #777; padding: 20px;"></p>
        </div>
    </div>
    
    <!-- External library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Constants for DOM elements
        const excelInput = document.getElementById('excelInput');
        const printButton = document.getElementById('printButton');
        const exportXlsxButton = document.getElementById('exportXlsxButton');
        const clearButton = document.getElementById('clearButton');
        const toggleColumnWidthsButton = document.getElementById('toggleColumnWidthsButton');
        const tableRenderContainer = document.getElementById('tableRenderContainer');
        const tablePlaceholder = document.getElementById('tablePlaceholder');
        
        const tableCustomizationArea = document.getElementById('tableCustomizationArea');
        const columnWidthControlsContainer = document.getElementById('columnWidthControlsContainer');
        const columnWidthInputsDiv = document.getElementById('columnWidthInputs');
        
        const useHeaderCheckbox = document.getElementById('useHeaderCheckbox'); 
        const centerAlignCheckbox = document.getElementById('centerAlignCheckbox');
        const fontSizeInput = document.getElementById('fontSizeInput');
        const fontFamilySelect = document.getElementById('fontFamilySelect');

        // Preview Controls
        const enablePreviewCheckbox = document.getElementById('enablePreviewCheckbox');
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        const pageOrientationSelect = document.getElementById('pageOrientationSelect');
        const pageScaleInput = document.getElementById('pageScaleInput');
        const customPageSizeInputs = document.getElementById('customPageSizeInputs');
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');
        
        // Text Replace and Filter Controls
        const filterInput = document.getElementById('filterInput');
              const replaceRulesInput = document.getElementById('replaceRulesInput');
        const undoReplaceButton = document.getElementById('undoReplaceButton');
        let originalExcelData = null; 
        const applyReplaceButton = document.getElementById('applyReplaceButton');
        
        // Template Controls
        const templateSelect = document.getElementById('templateSelect');
        const saveTemplateButton = document.getElementById('saveTemplateButton');
        const loadTemplateButton = document.getElementById('loadTemplateButton');
        const deleteTemplateButton = document.getElementById('deleteTemplateButton');
        const applyLastTemplateButton = document.getElementById('applyLastTemplateButton');

        // Global state variables
        let currentTable = null;
        let columnHeaders = [];
        let debounceTimer;
        let printPreviewPageDiv = null;
        
        let columnFilters = {}; // { colIndex: Set of allowed values }
let activeFilterDropdown = null;
        
        let currentSortColumn = null;
let currentSortOrder = 'asc';


        const DPI = 96;
        const pageDimensions = {
            'A4': { width: 210, height: 297 }, 'A3': { width: 297, height: 420 },
            'Letter': { width: 215.9, height: 279.4 }, 'Legal': { width: 215.9, height: 355.6 }
        };
        
   
        // --- Core Functions ---
        
        
        function sortTable(columnIndex, thElement) {
    if (!currentTable || thElement.style.display === 'none') return;

    const allThs = Array.from(currentTable.querySelectorAll('thead th'));
    allThs.forEach(h => {
        if (h !== thElement) h.classList.remove('sort-asc', 'sort-desc');
    });

    if (currentSortColumn === columnIndex) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortOrder = 'asc';
    }
    currentSortColumn = columnIndex;

    const tbody = currentTable.tBodies[0];
    const allRows = Array.from(tbody.rows);

    allRows.sort((a, b) => {
        const aVal = (a.cells[columnIndex]?.textContent || '').trim();
        const bVal = (b.cells[columnIndex]?.textContent || '').trim();
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return currentSortOrder === 'asc' ? aNum - bNum : bNum - aNum;
        }
        return currentSortOrder === 'asc'
            ? aVal.localeCompare(bVal, 'ru')
            : bVal.localeCompare(aVal, 'ru');
    });

    allRows.forEach(row => tbody.appendChild(row));

    thElement.classList.remove('sort-asc', 'sort-desc');
    thElement.classList.add(currentSortOrder === 'asc' ? 'sort-asc' : 'sort-desc');

    applyAllColumnFilters();
}

function generateTable(preserveState = false) {
    const data = excelInput.value.trim();
    
    // СОХРАНЯЕМ НАСТРОЙКИ КОЛОНОК ПЕРЕД ПЕРЕРИСОВКОЙ
    let savedColStates = null;
    if (preserveState && currentTable && columnHeaders.length > 0) {
        savedColStates = columnHeaders.map((th, idx) => {
            const hideCb = document.getElementById(`hideColCheckbox-${idx}`);
            return {
                width: th.style.width,
                hidden: hideCb ? hideCb.checked : (th.style.display === 'none')
            };
        });
    }

    tableRenderContainer.innerHTML = '';
    columnWidthInputsDiv.innerHTML = '';
    columnHeaders = [];
    currentTable = null;
    currentSortColumn = null;
    currentSortOrder = 'asc';
        if (!preserveState) columnFilters = {};

    if (!data) {
        if (enablePreviewCheckbox.checked) {
            if (!printPreviewPageDiv) {
                printPreviewPageDiv = document.createElement('div');
                printPreviewPageDiv.id = 'printPreviewPage';
            }
            printPreviewPageDiv.innerHTML = '';
            tableRenderContainer.appendChild(printPreviewPageDiv);
            applyPreviewPageSettings();
        } else {
            if (printPreviewPageDiv && printPreviewPageDiv.parentNode) printPreviewPageDiv.parentNode.removeChild(printPreviewPageDiv);
            tableRenderContainer.appendChild(tablePlaceholder);
            tablePlaceholder.style.display = 'block';
            tablePlaceholder.textContent = 'Здесь появится таблица после обработки данных.';
        }
        updateControlsVisibility();
        return;
    }

    const allLines = data.split('\n').filter(row => row.trim() !== '');
    if (allLines.length === 0) { 
        generateTable(); 
        return; 
    }
    
    const table = document.createElement('table');
    currentTable = table;
    const thead = table.createTHead();
    const tbody = table.createTBody();
    const useFirstRowAsHeaderCurrent = useHeaderCheckbox.checked; 

    let numCols = 0;
    const parsedRows = allLines.map(line => {
        const cells = line.split('\t');
        if (cells.length > numCols) numCols = cells.length;
        return cells;
    });

    if (numCols === 0) {
        tableRenderContainer.appendChild(tablePlaceholder);
        tablePlaceholder.textContent = 'Ошибка обработки. Проверьте данные и попробуйте снова.';
        updateControlsVisibility();
        return;
    }
    
    const useRowNumbers = document.getElementById('rowNumbersCheckbox').checked;
    const colOffset = useRowNumbers ? 1 : 0;

    const headerRowElement = thead.insertRow();

    // Добавление заголовка "№"
    if (useRowNumbers) {
        const thNum = document.createElement('th');
        thNum.textContent = '№';
        thNum.className = 'row-num-col';
        thNum.style.width = '45px';
        thNum.style.minWidth = '45px';
        thNum.style.maxWidth = '45px';
        headerRowElement.appendChild(thNum);
    }

    let actualHeaderTexts = useFirstRowAsHeaderCurrent && parsedRows.length > 0
        ? parsedRows[0].slice(0, numCols).concat(Array(Math.max(0, numCols - parsedRows[0].length)).fill(''))
        : Array(numCols).fill('');
        
        

 actualHeaderTexts.forEach((text, i) => {
        const actualColIndex = i + colOffset;
        const th = document.createElement('th');

        const thContent = document.createElement('div');
        thContent.className = 'th-content';
        thContent.innerHTML = `${text.trim()}<span class="sort-icon"></span>`;
        thContent.addEventListener('click', () => sortTable(actualColIndex, th));
        th.appendChild(thContent);

        const filterBtn = document.createElement('button');
        filterBtn.className = 'th-filter-btn';
        filterBtn.innerHTML = '<i class="fas fa-filter"></i>';
        filterBtn.title = 'Фильтр по колонке';
        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openColumnFilterDropdown(actualColIndex, filterBtn);
        });
        thContent.appendChild(filterBtn);

        th.dataset.columnIndex = actualColIndex;
        headerRowElement.appendChild(th);
        columnHeaders.push(th);

        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.addEventListener('click', (e) => e.stopPropagation());
        th.appendChild(resizer);
        addResizerEvents(resizer, th);
        createColumnWidthInput(i, th, numCols);
    });

    const dataRowStartIndex = (useFirstRowAsHeaderCurrent && parsedRows.length > 0) ? 1 : 0;
    let rowCount = 1;
    for (let i = dataRowStartIndex; i < parsedRows.length; i++) {
        const dataRowElement = tbody.insertRow();
        
        if (useRowNumbers) {
            const tdNum = dataRowElement.insertCell();
            tdNum.textContent = rowCount++;
            tdNum.className = 'row-num-col';
        }

        for(let j = 0; j < numCols; j++) { 
            const td = dataRowElement.insertCell();
            td.textContent = (parsedRows[i][j] || '').trim(); 
        }
    }
    
    if (enablePreviewCheckbox.checked) {
        if (!printPreviewPageDiv) {
            printPreviewPageDiv = document.createElement('div');
            printPreviewPageDiv.id = 'printPreviewPage';
        }
        printPreviewPageDiv.innerHTML = '';
        printPreviewPageDiv.appendChild(currentTable);
        tableRenderContainer.appendChild(printPreviewPageDiv);
        applyPreviewPageSettings();
    } else {
        tableRenderContainer.appendChild(currentTable);
    }
    if(tablePlaceholder.parentNode) tablePlaceholder.parentNode.removeChild(tablePlaceholder);

    // Проверяем валидность сохраненных состояний
    let totalSavedWidth = 0;
    let hasValidSavedWidths = false;

    if (savedColStates && savedColStates.length > 0) {
        savedColStates.forEach(state => {
            const width = parseFloat(state.width);
            if (!isNaN(width) && !state.hidden) {
                totalSavedWidth += width;
            }
        });
        hasValidSavedWidths = totalSavedWidth >= 90 && totalSavedWidth <= 105;
    }

    const totalWidthAvailable = useRowNumbers ? 95 : 100;
    const initialWidth = totalWidthAvailable / Math.max(1, columnHeaders.length);

    columnHeaders.forEach((th, index) => {
        let w = `${initialWidth}%`;
        let isHidden = false;

        if (savedColStates && savedColStates[index]) {
            isHidden = savedColStates[index].hidden;
            if (hasValidSavedWidths) {
                w = savedColStates[index].width || w;
            } else if (useRowNumbers && !savedColStates[index].hidden) {
                const visibleColumns = savedColStates.filter(s => !s.hidden).length;
                w = `${(95 / visibleColumns).toFixed(3)}%`;
            }
        }

        th.style.width = w;
        th.style.display = isHidden ? 'none' : '';
        
        const input = document.getElementById(`colWidthInput-${index}`);
        if (input) { 
            input.value = parseFloat(w) ? parseFloat(w).toFixed(1) : 0; 
            input.disabled = isHidden; 
        }
        
        const hideCheckbox = document.getElementById(`hideColCheckbox-${index}`);
        if (hideCheckbox) hideCheckbox.checked = isHidden;
        
        const dataRows = currentTable?.tBodies[0]?.rows;
        if(dataRows) {
            const cellIdx = index + colOffset; 
            for (let i = 0; i < dataRows.length; i++) {
                if (dataRows[i].cells[cellIdx]) {
                    dataRows[i].cells[cellIdx].style.display = isHidden ? 'none' : '';
                }
            }
        }
    });
    
    applyTableStyles();
    applyFilter();
    updateControlsVisibility();
}
        
        
                function updateRowNumbers() {
            const rowNumbersCheckbox = document.getElementById('rowNumbersCheckbox');
            if (!rowNumbersCheckbox || !rowNumbersCheckbox.checked || !currentTable) return;
            let currentNum = 1;
            const rows = currentTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    if (row.cells[0]) row.cells[0].textContent = currentNum++;
                }
            });
        }
        
        
        function updateControlsVisibility() {
            const hasContentForTable = excelInput.value.trim() !== '';
            const isPreviewSystemActive = enablePreviewCheckbox.checked;

            printButton.style.display = hasContentForTable ? 'inline-flex' : 'none';
            exportXlsxButton.style.display = hasContentForTable ? 'inline-flex' : 'none';
            clearButton.style.display = (hasContentForTable || excelInput.value.length > 0 || isPreviewSystemActive) ? 'inline-flex' : 'none';
            toggleColumnWidthsButton.style.display = hasContentForTable ? 'inline-flex' : 'none';
            applyLastTemplateButton.style.display = hasContentForTable ? 'inline-flex' : 'none';

            if (hasContentForTable || isPreviewSystemActive) {
                tableCustomizationArea.style.display = 'block';
                document.querySelectorAll('.preview-option').forEach(opt => opt.style.display = isPreviewSystemActive ? 'flex' : 'none');
                customPageSizeInputs.style.display = (pageSizeSelect.value === 'Custom' && isPreviewSystemActive) ? 'flex' : 'none';
                
                const colWidthsButtonIsActive = toggleColumnWidthsButton.innerHTML.includes('fa-eye-slash');
                columnWidthControlsContainer.style.display = (hasContentForTable && colWidthsButtonIsActive) ? 'block' : 'none';
            } else {
                tableCustomizationArea.style.display = 'none';
                columnWidthControlsContainer.style.display = 'none';
            }
            
            const hasLastTemplate = !!localStorage.getItem('lastUsedTemplateName');
            applyLastTemplateButton.disabled = !hasContentForTable || !hasLastTemplate;
            saveTemplateButton.disabled = !hasContentForTable;
        }

  function applyFilter() {
    applyAllColumnFilters();
}

        
function applyAllColumnFilters() {
    if (!currentTable) return;
    const globalFilter = filterInput.value.trim().toLowerCase();
    const tbody = currentTable.tBodies[0];
    const rows = Array.from(tbody.rows);

    rows.forEach(row => {
        const cells = row.cells;
        let visible = true;

        // Global text filter
        if (globalFilter) {
            const rowText = row.textContent.toLowerCase();
            if (!rowText.includes(globalFilter)) visible = false;
        }

        // Per-column checkbox filters
        if (visible) {
            for (const colIdx in columnFilters) {
                const allowed = columnFilters[colIdx];
                if (!allowed) continue;
                const ci = parseInt(colIdx);
                const cellVal = (cells[ci]?.textContent || '').trim();
                if (!allowed.has(cellVal)) { visible = false; break; }
            }
        }

        row.style.display = visible ? '' : 'none';
    });

    updateRowNumbers();
    updateFilterButtonStates();
}

function updateFilterButtonStates() {
    if (!currentTable) return;
    currentTable.querySelectorAll('.th-filter-btn').forEach(btn => {
        const th = btn.closest('th');
        const colIdx = parseInt(th.dataset.columnIndex);
        if (columnFilters[colIdx]) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function getColumnUniqueValues(colIndex) {
    if (!currentTable) return [];
    const tbody = currentTable.tBodies[0];
    const rows = Array.from(tbody.rows);
    const valuesSet = new Set();

    rows.forEach(row => {
        // При подсчёте уникальных — учитываем только строки, видимые по ДРУГИМ фильтрам
        const cells = row.cells;
        let passesOther = true;

        const globalFilter = filterInput.value.trim().toLowerCase();
        if (globalFilter) {
            const rowText = row.textContent.toLowerCase();
            if (!rowText.includes(globalFilter)) passesOther = false;
        }

        if (passesOther) {
            for (const ci in columnFilters) {
                if (parseInt(ci) === colIndex) continue; // skip current column
                const allowed = columnFilters[ci];
                if (!allowed) continue;
                const cellVal = (cells[parseInt(ci)]?.textContent || '').trim();
                if (!allowed.has(cellVal)) { passesOther = false; break; }
            }
        }

        if (passesOther) {
            const val = (cells[colIndex]?.textContent || '').trim();
            valuesSet.add(val);
        }
    });

    return Array.from(valuesSet).sort((a, b) => {
        const an = parseFloat(a), bn = parseFloat(b);
        if (!isNaN(an) && !isNaN(bn)) return an - bn;
        return a.localeCompare(b, 'ru');
    });
}

function openColumnFilterDropdown(colIndex, btnElement) {
    closeColumnFilterDropdown();

    const uniqueValues = getColumnUniqueValues(colIndex);
    const currentAllowed = columnFilters[colIndex] || null;
    const tempSelected = new Set(currentAllowed ? currentAllowed : uniqueValues);

    // Overlay
    const overlay = document.createElement('div');
    overlay.className = 'col-filter-overlay';
    overlay.addEventListener('click', closeColumnFilterDropdown);

    // Dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'col-filter-dropdown';

    // Position
    const rect = btnElement.getBoundingClientRect();
    let left = rect.left;
    let top = rect.bottom + 4;
    if (left + 260 > window.innerWidth) left = window.innerWidth - 270;
    if (top + 370 > window.innerHeight) top = rect.top - 374;
    if (left < 5) left = 5;
    if (top < 5) top = 5;
    dropdown.style.left = left + 'px';
    dropdown.style.top = top + 'px';

    // Search
    const searchDiv = document.createElement('div');
    searchDiv.className = 'cfd-search';
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Поиск...';
    searchDiv.appendChild(searchInput);
    dropdown.appendChild(searchDiv);

    // Actions top
    const actionsTop = document.createElement('div');
    actionsTop.className = 'cfd-actions-top';
    const selectAllLink = document.createElement('a');
    selectAllLink.textContent = 'Выбрать все';
    selectAllLink.addEventListener('click', () => {
        const visibleLabels = listDiv.querySelectorAll('label:not([style*="display: none"])');
        visibleLabels.forEach(lbl => {
            const cb = lbl.querySelector('input');
            cb.checked = true;
            tempSelected.add(cb.value);
        });
    });
    const deselectAllLink = document.createElement('a');
    deselectAllLink.textContent = 'Снять все';
    deselectAllLink.addEventListener('click', () => {
        const visibleLabels = listDiv.querySelectorAll('label:not([style*="display: none"])');
        visibleLabels.forEach(lbl => {
            const cb = lbl.querySelector('input');
            cb.checked = false;
            tempSelected.delete(cb.value);
        });
    });
    actionsTop.appendChild(selectAllLink);
    actionsTop.appendChild(deselectAllLink);
    dropdown.appendChild(actionsTop);

    // List
    const listDiv = document.createElement('div');
    listDiv.className = 'cfd-list';

    if (uniqueValues.length === 0) {
        const emptyP = document.createElement('div');
        emptyP.className = 'cfd-empty';
        emptyP.textContent = 'Нет данных';
        listDiv.appendChild(emptyP);
    } else {
        uniqueValues.forEach(val => {
            const lbl = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = val;
            cb.checked = tempSelected.has(val);
            cb.addEventListener('change', () => {
                if (cb.checked) tempSelected.add(val);
                else tempSelected.delete(val);
            });
            const span = document.createElement('span');
            span.textContent = val === '' ? '(Пустые)' : val;
            span.title = val;
            lbl.appendChild(cb);
            lbl.appendChild(span);
            listDiv.appendChild(lbl);
        });
    }

    dropdown.appendChild(listDiv);

    // Search filter
    searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim().toLowerCase();
        listDiv.querySelectorAll('label').forEach(lbl => {
            const text = lbl.querySelector('span').textContent.toLowerCase();
            lbl.style.display = text.includes(q) ? '' : 'none';
        });
    });

    // Bottom buttons
    const bottomDiv = document.createElement('div');
    bottomDiv.className = 'cfd-bottom';

    const okBtn = document.createElement('button');
    okBtn.className = 'cfd-ok';
    okBtn.textContent = 'ОК';
    okBtn.addEventListener('click', () => {
        if (tempSelected.size === uniqueValues.length || tempSelected.size === 0) {
            delete columnFilters[colIndex];
        } else {
            columnFilters[colIndex] = new Set(tempSelected);
        }
        closeColumnFilterDropdown();
        applyAllColumnFilters();
    });

    const clearBtn = document.createElement('button');
    clearBtn.className = 'cfd-cancel';
    clearBtn.textContent = 'Сбросить';
    clearBtn.addEventListener('click', () => {
        delete columnFilters[colIndex];
        closeColumnFilterDropdown();
        applyAllColumnFilters();
    });

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'cfd-cancel';
    cancelBtn.textContent = 'Отмена';
    cancelBtn.addEventListener('click', closeColumnFilterDropdown);

    bottomDiv.appendChild(okBtn);
    bottomDiv.appendChild(clearBtn);
    bottomDiv.appendChild(cancelBtn);
    dropdown.appendChild(bottomDiv);

    document.body.appendChild(overlay);
    document.body.appendChild(dropdown);
    activeFilterDropdown = { overlay, dropdown };

    searchInput.focus();
}

function closeColumnFilterDropdown() {
    if (activeFilterDropdown) {
        activeFilterDropdown.overlay.remove();
        activeFilterDropdown.dropdown.remove();
        activeFilterDropdown = null;
    }
}
        
function showExportDialog() {
    if (!currentTable) { alert('Нет таблицы для экспорта.'); return; }

    const overlay = document.createElement('div');
    overlay.className = 'export-dialog-overlay';
    overlay.innerHTML = `
        <div class="export-dialog">
            <h2><i class="fas fa-file-export" style="margin-right:8px; color:var(--primary-color);"></i>Экспорт таблицы</h2>
            <div class="export-dialog-options">
                <button data-format="xlsx">
                    <i class="fas fa-file-excel export-icon-xlsx"></i>
                    <div><strong>XLSX</strong><br><small style="color:#888;">Книга Microsoft Excel</small></div>
                </button>
                <button data-format="docx">
                    <i class="fas fa-file-word export-icon-docx"></i>
                    <div><strong>DOCX</strong><br><small style="color:#888;">Документ Microsoft Word</small></div>
                </button>
                <button data-format="csv">
                    <i class="fas fa-file-csv export-icon-csv"></i>
                    <div><strong>CSV</strong><br><small style="color:#888;">Текст с разделителем «;»</small></div>
                </button>
                <button data-format="html">
                    <i class="fas fa-file-code export-icon-html"></i>
                    <div><strong>HTML</strong><br><small style="color:#888;">Веб-страница с таблицей</small></div>
                </button>
            </div>
           <div class="export-dialog-cancel">
    <button data-action="cancel"><i class="fas fa-times"></i> Отмена</button>
</div>
        </div>
    `;

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay || e.target.closest('[data-action="cancel"]')) {
            overlay.remove();
        }
        const formatBtn = e.target.closest('[data-format]');
        if (formatBtn) {
            const format = formatBtn.dataset.format;
            overlay.remove();
            switch (format) {
                case 'xlsx': exportToXlsx(); break;
                case 'docx': exportToDocx(); break;
                case 'csv': exportToCsv(); break;
                case 'html': exportToHtml(); break;
            }
        }
    });

    document.body.appendChild(overlay);
}

function getVisibleTableData() {
    if (!currentTable) return [];
    const data = [];
    const rows = currentTable.querySelectorAll('tr');
    rows.forEach(tr => {
        if (tr.style.display !== 'none') {
            const rowData = [];
            Array.from(tr.cells).forEach(cell => {
                if (cell.style.display !== 'none') {
                    let text;
                    if (cell.tagName.toLowerCase() === 'th') {
                        const thContent = cell.querySelector('.th-content');
                        text = thContent ? thContent.childNodes[0].textContent : cell.textContent;
                        text = text.replace(/[▲▼⇅]/g, '').trim();
                    } else {
                        text = cell.textContent;
                    }
                    rowData.push(text);
                }
            });
            data.push(rowData);
        }
    });
    return data;
}

function exportToXlsx() {
    const data = getVisibleTableData();
    if (data.length <= 1) { alert("Нет видимых данных для экспорта."); return; }
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Данные');
    const date = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `export-${date}.xlsx`);
}

function exportToCsv() {
    const data = getVisibleTableData();
    if (data.length <= 1) { alert("Нет видимых данных для экспорта."); return; }
    const csvContent = data.map(row =>
        row.map(cell => {
            const escaped = String(cell).replace(/"/g, '""');
            return (escaped.includes(';') || escaped.includes('"') || escaped.includes('\n'))
                ? `"${escaped}"` : escaped;
        }).join(';')
    ).join('\r\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, `export-${new Date().toISOString().slice(0, 10)}.csv`);
}



function exportToHtml() {
    if (!currentTable) return;
    const data = getVisibleTableData();
    if (data.length <= 1) { alert("Нет видимых данных для экспорта."); return; }

    const fontSize = fontSizeInput.value + 'pt';
    const fontFamily = fontFamilySelect.value;
    const hasHeader = useHeaderCheckbox.checked;

    let theadHtml = '';
    let tbodyHtml = '';

    data.forEach((row, ri) => {
        if (ri === 0 && hasHeader) {
            theadHtml += '<tr>';
            row.forEach((c, ci) => {
                const safe = c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                theadHtml += '<th data-col="' + ci + '">' +
                    '<div class="th-content" data-col="' + ci + '">' + safe +
                    ' <span class="sort-icon">\u21C5</span>' +
                    ' <button class="th-filter-btn" data-col="' + ci + '" title="Фильтр"><i class="fa fa-filter"></i></button>' +
                    '</div></th>';
            });
            theadHtml += '</tr>';
        } else {
            tbodyHtml += '<tr>';
            row.forEach(c => {
                tbodyHtml += '<td>' + c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</td>';
            });
            tbodyHtml += '</tr>';
        }
    });

    if (!hasHeader) {
        tbodyHtml = '';
        data.forEach(row => {
            tbodyHtml += '<tr>';
            row.forEach(c => {
                tbodyHtml += '<td>' + c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</td>';
            });
            tbodyHtml += '</tr>';
        });
    }

    const scriptCode = [
        '(function(){',
        'var table=document.getElementById("dataTable");',
        'var globalInput=document.getElementById("filterInput");',
        'var countEl=document.getElementById("rowCount");',
        'var hasHeader=' + hasHeader + ';',
        'var tbody=table.tBodies[0];',
        'if(!tbody)return;',
        'var dataRows=Array.from(tbody.rows);',
        'var origTexts=dataRows.map(function(r){return Array.from(r.cells).map(function(c){return c.textContent;});});',
        'var sortCol=null,sortOrder="asc";',
        'var colFilters={};',
        'var activeDrop=null;',
        '',
        'function updateCount(){',
        '  var v=dataRows.filter(function(r){return r.style.display!=="none";}).length;',
        '  countEl.textContent=v+" из "+dataRows.length;',
        '}',
        '',
        'function updateBtns(){',
        '  table.querySelectorAll(".th-filter-btn").forEach(function(b){',
        '    var ci=parseInt(b.dataset.col);',
        '    b.classList.toggle("active",!!colFilters[ci]);',
        '  });',
        '}',
        '',
        'function filterAll(){',
        '  var gVal=globalInput.value.trim().toLowerCase();',
        '  dataRows.forEach(function(row,ri){',
        '    var texts=origTexts[ri];',
        '    var full=texts.join(" ").toLowerCase();',
        '    var vis=true;',
        '    if(gVal&&full.indexOf(gVal)===-1)vis=false;',
        '    if(vis){',
        '      for(var ci in colFilters){',
        '        if(!colFilters[ci])continue;',
        '        var cv=(texts[parseInt(ci)]||"").trim();',
        '        if(!colFilters[ci].has(cv)){vis=false;break;}',
        '      }',
        '    }',
        '    row.style.display=vis?"":"none";',
        '  });',
        '  updateCount();updateBtns();',
        '}',
        '',
        'function getUnique(ci){',
        '  var gVal=globalInput.value.trim().toLowerCase();',
        '  var s=new Set();',
        '  dataRows.forEach(function(r,ri){',
        '    var texts=origTexts[ri];',
        '    var full=texts.join(" ").toLowerCase();',
        '    var ok=true;',
        '    if(gVal&&full.indexOf(gVal)===-1)ok=false;',
        '    if(ok){for(var c in colFilters){if(parseInt(c)===ci)continue;if(!colFilters[c])continue;var cv=(texts[parseInt(c)]||"").trim();if(!colFilters[c].has(cv)){ok=false;break;}}}',
        '    if(ok)s.add((texts[ci]||"").trim());',
        '  });',
        '  return Array.from(s).sort(function(a,b){var an=parseFloat(a),bn=parseFloat(b);if(!isNaN(an)&&!isNaN(bn))return an-bn;return a.localeCompare(b,"ru");});',
        '}',
        '',
        'function closeDrop(){if(activeDrop){activeDrop.ov.remove();activeDrop.dd.remove();activeDrop=null;}}',
        '',
        'function openDrop(ci,btn){',
        '  closeDrop();',
        '  var vals=getUnique(ci);',
        '  var cur=colFilters[ci]||null;',
        '  var sel=new Set(cur?cur:vals);',
        '  var ov=document.createElement("div");ov.className="cfo";ov.addEventListener("click",closeDrop);',
        '  var dd=document.createElement("div");dd.className="cfd";',
        '  var rc=btn.getBoundingClientRect();',
        '  var l=rc.left,t=rc.bottom+4;',
        '  if(l+260>window.innerWidth)l=window.innerWidth-270;',
        '  if(t+370>window.innerHeight)t=rc.top-374;',
        '  if(l<5)l=5;if(t<5)t=5;',
        '  dd.style.left=l+"px";dd.style.top=t+"px";',
        '  var sh=document.createElement("div");sh.className="cfd-search";',
        '  var si=document.createElement("input");si.type="text";si.placeholder="Поиск...";sh.appendChild(si);dd.appendChild(sh);',
        '  var at=document.createElement("div");at.className="cfd-at";',
        '  var sa=document.createElement("a");sa.textContent="Выбрать все";',
        '  sa.addEventListener("click",function(){ld.querySelectorAll("label").forEach(function(lb){if(lb.style.display!=="none"){var cb=lb.querySelector("input");cb.checked=true;sel.add(cb.value);}});});',
        '  var da=document.createElement("a");da.textContent="Снять все";',
        '  da.addEventListener("click",function(){ld.querySelectorAll("label").forEach(function(lb){if(lb.style.display!=="none"){var cb=lb.querySelector("input");cb.checked=false;sel.delete(cb.value);}});});',
        '  at.appendChild(sa);at.appendChild(da);dd.appendChild(at);',
        '  var ld=document.createElement("div");ld.className="cfd-list";',
        '  vals.forEach(function(v){',
        '    var lb=document.createElement("label");',
        '    var cb=document.createElement("input");cb.type="checkbox";cb.value=v;cb.checked=sel.has(v);',
        '    cb.addEventListener("change",function(){if(cb.checked)sel.add(v);else sel.delete(v);});',
        '    var sp=document.createElement("span");sp.textContent=v===""?"(Пустые)":v;sp.title=v;',
        '    lb.appendChild(cb);lb.appendChild(sp);ld.appendChild(lb);',
        '  });',
        '  dd.appendChild(ld);',
        '  si.addEventListener("input",function(){var q=si.value.trim().toLowerCase();ld.querySelectorAll("label").forEach(function(lb){lb.style.display=lb.querySelector("span").textContent.toLowerCase().indexOf(q)!==-1?"":"none";});});',
        '  var bt=document.createElement("div");bt.className="cfd-bottom";',
        '  var ok=document.createElement("button");ok.className="cfd-ok";ok.textContent="ОК";',
        '  ok.addEventListener("click",function(){if(sel.size===vals.length||sel.size===0)delete colFilters[ci];else colFilters[ci]=new Set(sel);closeDrop();filterAll();});',
        '  var cl=document.createElement("button");cl.className="cfd-cancel";cl.textContent="Сбросить";',
        '  cl.addEventListener("click",function(){delete colFilters[ci];closeDrop();filterAll();});',
        '  var cn=document.createElement("button");cn.className="cfd-cancel";cn.textContent="Отмена";',
        '  cn.addEventListener("click",closeDrop);',
        '  bt.appendChild(ok);bt.appendChild(cl);bt.appendChild(cn);dd.appendChild(bt);',
        '  document.body.appendChild(ov);document.body.appendChild(dd);',
        '  activeDrop={ov:ov,dd:dd};si.focus();',
        '}',
        '',
        'function doSort(ci,thEl){',
        '  var allTh=Array.from(table.querySelectorAll("thead th"));',
        '  allTh.forEach(function(h){if(h!==thEl){h.classList.remove("sort-asc","sort-desc");var s=h.querySelector(".sort-icon");if(s)s.textContent="\\u21C5";}});',
        '  if(sortCol===ci){sortOrder=sortOrder==="asc"?"desc":"asc";}else{sortOrder="asc";}',
        '  sortCol=ci;',
        '  var rd=dataRows.map(function(r,i){return{row:r,texts:origTexts[i]};});',
        '  rd.sort(function(a,b){var av=(a.texts[ci]||"").trim(),bv=(b.texts[ci]||"").trim();var an=parseFloat(av),bn=parseFloat(bv);if(!isNaN(an)&&!isNaN(bn))return sortOrder==="asc"?an-bn:bn-an;return sortOrder==="asc"?av.localeCompare(bv,"ru"):bv.localeCompare(av,"ru");});',
        '  dataRows=rd.map(function(d){return d.row;});origTexts=rd.map(function(d){return d.texts;});',
        '  dataRows.forEach(function(r){tbody.appendChild(r);});',
        '  thEl.classList.remove("sort-asc","sort-desc");thEl.classList.add(sortOrder==="asc"?"sort-asc":"sort-desc");',
        '  var s=thEl.querySelector(".sort-icon");if(s)s.textContent=sortOrder==="asc"?"\\u25B2":"\\u25BC";',
        '  filterAll();',
        '}',
        '',
        'table.querySelectorAll(".th-content").forEach(function(el){',
        '  el.addEventListener("click",function(e){',
        '    if(e.target.closest(".th-filter-btn"))return;',
        '    doSort(parseInt(el.dataset.col),el.closest("th"));',
        '  });',
        '});',
        '',
        'table.querySelectorAll(".th-filter-btn").forEach(function(b){',
        '  b.addEventListener("click",function(e){e.stopPropagation();openDrop(parseInt(b.dataset.col),b);});',
        '});',
        '',
        'globalInput.addEventListener("input",filterAll);',
        'updateCount();',
        '})();'
    ].join('\n');

    const html = '<!DOCTYPE html>\n' +
        '<html><head><meta charset="UTF-8"><title>Экспорт таблицы</title>\n' +
        '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">\n' +
        '<style>\n' +
        '*{box-sizing:border-box;margin:0;padding:0;}\n' +
        'body{font-family:' + fontFamily + ';font-size:' + fontSize + ';margin:0;padding:20px;background:#f0f2f5;color:#333;}\n' +
        '.filter-bar{position:sticky;top:0;z-index:100;background:#fff;padding:12px 16px;margin-bottom:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;align-items:center;gap:10px;}\n' +
        '.filter-bar label{font-weight:600;white-space:nowrap;}\n' +
        '.filter-bar input{flex:1;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:1em;outline:none;transition:border-color .2s,box-shadow .2s;}\n' +
        '.filter-bar input:focus{border-color:#0078D4;box-shadow:0 0 0 3px rgba(0,120,212,0.2);}\n' +
        '.filter-bar .count{font-size:0.85em;color:#888;white-space:nowrap;min-width:80px;text-align:right;}\n' +
        'table{width:100%;border-collapse:collapse;table-layout:fixed;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);}\n' +
        'th,td{border:1px solid #b8d4f0;padding:6px 8px;vertical-align:top;word-wrap:break-word;}\n' +
        'th{background:linear-gradient(180deg,#e8f2fc,#d4e6f9);font-weight:bold;text-align:center;position:relative;}\n' +
        '.th-content{display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;user-select:none;}\n' +
        '.th-content:hover{color:#0078D4;}\n' +
        '.sort-icon{font-size:0.8em;color:rgba(0,0,0,0.4);}\n' +
        'th.sort-asc .sort-icon,th.sort-desc .sort-icon{color:#0078D4;}\n' +
        '.th-filter-btn{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:none;background:transparent;cursor:pointer;color:rgba(0,0,0,0.35);font-size:0.75em;padding:0;margin-left:4px;border-radius:3px;transition:all .2s;}\n' +
        '.th-filter-btn:hover{color:#0078D4;background:rgba(0,120,212,0.1);}\n' +
        '.th-filter-btn.active{color:#fff;background:#0078D4;}\n' +
        '.cfo{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9998;}\n' +
        '.cfd{position:fixed;z-index:9999;background:#fff;border:1px solid #b8d4f0;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.18);min-width:220px;max-width:320px;max-height:370px;display:flex;flex-direction:column;font-size:13px;}\n' +
        '.cfd .cfd-search{padding:8px 10px;border-bottom:1px solid #e8eff7;}\n' +
        '.cfd .cfd-search input{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:5px;font-size:13px;outline:none;box-sizing:border-box;}\n' +
        '.cfd .cfd-search input:focus{border-color:#0078D4;box-shadow:0 0 0 2px rgba(0,120,212,0.15);}\n' +
        '.cfd .cfd-at{display:flex;gap:6px;padding:6px 10px;border-bottom:1px solid #e8eff7;}\n' +
        '.cfd .cfd-at a{font-size:12px;color:#0078D4;cursor:pointer;text-decoration:none;white-space:nowrap;}\n' +
        '.cfd .cfd-at a:hover{text-decoration:underline;}\n' +
        '.cfd .cfd-list{overflow-y:auto;flex:1;padding:4px 0;min-height:60px;max-height:230px;}\n' +
        '.cfd .cfd-list label{display:flex;align-items:center;gap:8px;padding:4px 12px;cursor:pointer;transition:background .15s;font-weight:normal;font-size:13px;line-height:1.5;}\n' +
        '.cfd .cfd-list label:hover{background:rgba(0,120,212,0.06);}\n' +
        '.cfd .cfd-list input[type=checkbox]{width:15px;height:15px;accent-color:#0078D4;flex-shrink:0;}\n' +
        '.cfd .cfd-bottom{display:flex;gap:8px;padding:8px 10px;border-top:1px solid #e8eff7;justify-content:flex-end;}\n' +
        '.cfd .cfd-bottom button{padding:5px 14px;border-radius:5px;border:1px solid #ccc;background:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all .2s;}\n' +
        '.cfd .cfd-bottom button.cfd-ok{background:#0078D4;color:#fff;border-color:#0078D4;}\n' +
        '.cfd .cfd-bottom button.cfd-ok:hover{background:#005a9e;}\n' +
        '.cfd .cfd-bottom button.cfd-cancel:hover{border-color:#ed2100;color:#ed2100;}\n' +
        'tr:hover td{background:rgba(0,120,212,0.04);}\n' +
        'mark{background:#fff3a8;padding:0 1px;border-radius:2px;}\n' +
        '@media print{.filter-bar,.th-filter-btn,.cfo,.cfd{display:none!important;}tr[style*="display: none"]{display:none!important;}}\n' +
        '</style></head><body>\n' +
        '<div class="filter-bar">\n' +
        '<label for="filterInput">\u{1F50D} Общий фильтр:</label>\n' +
        '<input type="text" id="filterInput" placeholder="Поиск по всей таблице...">\n' +
        '<span class="count" id="rowCount"></span>\n' +
        '</div>\n' +
        '<table id="dataTable">\n' +
        (hasHeader ? '<thead>' + theadHtml + '</thead>\n' : '') +
        '<tbody>\n' + tbodyHtml + '\n</tbody>\n' +
        '</table>\n' +
        '<script>\n' + scriptCode + '\n<\/script>\n' +
        '</body></html>';

    const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
    downloadBlob(blob, `export-${new Date().toISOString().slice(0, 10)}.html`);
}


function exportToDocx() {
    const data = getVisibleTableData();
    if (data.length <= 1) { alert("Нет видимых данных для экспорта."); return; }

    const fontSize = Math.round(parseFloat(fontSizeInput.value) * 2); // half-points

    let tableXml = '';
    const colCount = data[0]?.length || 1;
    const colWidth = Math.floor(9000 / colCount);

    data.forEach((row, ri) => {
        const isHeader = ri === 0 && useHeaderCheckbox.checked;
        tableXml += '<w:tr>';
        row.forEach(cell => {
            const bold = isHeader ? '<w:b/>' : '';
            const jc = isHeader ? '<w:jc w:val="center"/>' : '';
            const shading = isHeader ? '<w:shd w:val="clear" w:color="auto" w:fill="E9ECEF"/>' : '';
            tableXml += `<w:tc>
                <w:tcPr><w:tcW w:w="${colWidth}" w:type="dxa"/>${shading}</w:tcPr>
                <w:p><w:pPr>${jc}<w:rPr><w:sz w:val="${fontSize}"/><w:szCs w:val="${fontSize}"/></w:rPr></w:pPr>
                <w:r><w:rPr>${bold}<w:sz w:val="${fontSize}"/><w:szCs w:val="${fontSize}"/></w:rPr>
                <w:t xml:space="preserve">${escapeXml(cell)}</w:t></w:r></w:p>
            </w:tc>`;
        });
        tableXml += '</w:tr>';
    });

    const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
xmlns:mo="http://schemas.microsoft.com/office/mac/office/2008/main"
xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
xmlns:mv="urn:schemas-microsoft-com:mac:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
xmlns:w10="urn:schemas-microsoft-com:office:word"
xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml">
<w:body>
<w:tbl>
<w:tblPr>
<w:tblStyle w:val="TableGrid"/>
<w:tblW w:w="0" w:type="auto"/>
<w:tblBorders>
<w:top w:val="single" w:sz="4" w:space="0" w:color="999999"/>
<w:left w:val="single" w:sz="4" w:space="0" w:color="999999"/>
<w:bottom w:val="single" w:sz="4" w:space="0" w:color="999999"/>
<w:right w:val="single" w:sz="4" w:space="0" w:color="999999"/>
<w:insideH w:val="single" w:sz="4" w:space="0" w:color="999999"/>
<w:insideV w:val="single" w:sz="4" w:space="0" w:color="999999"/>
</w:tblBorders>
<w:tblLook w:val="04A0"/>
</w:tblPr>
${tableXml}
</w:tbl>
</w:body></w:document>`;

    const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`;

    const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

    const wordRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`;

    // Build ZIP using JSZip-like manual approach with the XLSX library's ZIP utility
    const zip = new JSZip();
    zip.file('[Content_Types].xml', contentTypes);
    zip.folder('_rels').file('.rels', rels);
    zip.folder('word').file('document.xml', docXml);
    zip.folder('word/_rels').file('document.xml.rels', wordRels);

    zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
        .then(blob => {
            downloadBlob(blob, `export-${new Date().toISOString().slice(0, 10)}.docx`);
        });
}

function escapeXml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
}

function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


        // --- Event Listeners and Handlers ---

document.addEventListener('DOMContentLoaded', async () => {
    document.documentElement.style.setProperty('--table-font-size', `${fontSizeInput.value}pt`);
    document.documentElement.style.setProperty('--table-font-family', fontFamilySelect.value);
    tablePlaceholder.textContent = 'Здесь появится таблица после обработки данных. Введите данные.';
    
    // 1. СНАЧАЛА инициализируем интерфейс (шаблоны и кнопки)
    populateTemplateSelect();
    updateControlsVisibility();

    // 2. ЗАТЕМ пытаемся автоматически прочитать буфер обмена (не блокируя интерфейс)
    if (excelInput.value.trim() === '') {
        try {
            const text = await navigator.clipboard.readText();
            if (text && text.includes('\t')) {
                excelInput.value = text;
                generateTable(); // Генерируем таблицу, если вставили из буфера
            }
        } catch (err) {
            console.warn('Авто-чтение буфера обмена заблокировано браузером до первого взаимодействия со страницей:', err);
        }
    } else {
        generateTable();
    }
});

          excelInput.addEventListener('input', () => {
            originalExcelData = null; // Сбрасываем возможность отмены при ручном вводе
            undoReplaceButton.style.display = 'none';
            
            if (excelInput.value.trim() === '') {
                clearTimeout(debounceTimer); 
                generateTable(); 
            } else {
                debouncedGenerateTable(); 
            }
        });
        
        
    const debouncedGenerateTable = debounce(() => generateTable(true), 500);
        excelInput.addEventListener('input', () => {
            if (excelInput.value.trim() === '') {
                clearTimeout(debounceTimer); 
                generateTable(); 
            } else {
                debouncedGenerateTable(); 
            }
        });

        filterInput.addEventListener('input', applyFilter);

function applyReplacements() {
    const rulesText = replaceRulesInput.value.trim();
    if (!rulesText) return;

    if (originalExcelData === null) {
        originalExcelData = excelInput.value;
    }

    let newData = originalExcelData; 
    
    newData = newData.replace(/[\u00A0\u202F\u2007\u2060]/g, ' ')
                     .replace(/[\u200B-\u200D\uFEFF\u00AD\u200E\u200F]/g, '')
                     .replace(/ {2,}/g, ' ');

    const rawRules = rulesText.split(/\r?\n/); 
    const parsedRules = [];

    rawRules.forEach((rule, index) => {
        if (!rule.trim()) return;

        let find = rule;
        let replaceText = '';
        let isPrefixDelete = false;
        
        if (find.startsWith('##')) {
            isPrefixDelete = true;
            find = find.substring(2);
        }

        const separatorIndex = find.indexOf('#');
        if (separatorIndex !== -1) {
            replaceText = find.substring(separatorIndex + 1);
            find = find.substring(0, separatorIndex);
        } else if (isPrefixDelete) {
            replaceText = find; 
        }
        
        if (find) {
            find = find.replace(/[\u00A0\u202F\u2007\u2060]/g, ' ')
                       .replace(/[\u200B-\u200D\uFEFF\u00AD\u200E\u200F]/g, '')
                       .replace(/ {2,}/g, ' ');

            parsedRules.push({
                originalIndex: index + 1, 
                find: find,
                replaceText: replaceText,
                isPrefixDelete: isPrefixDelete
            });
        }
    });

    parsedRules.sort((a, b) => b.find.length - a.find.length);

    parsedRules.forEach((rule) => {
        const escapedFind = rule.find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const flexFind = escapedFind.replace(/ /g, ' +');
        
        let regex;
        let replaceStr;

        if (rule.isPrefixDelete) {
            regex = new RegExp('(^|[\\t\\n\\r])[^\\t\\n\\r]*?(' + flexFind + ')', 'g');
            replaceStr = '$1' + rule.replaceText;
        } else {
            regex = new RegExp(flexFind, 'g');
            replaceStr = rule.replaceText;
        }
        
        newData = newData.replace(regex, replaceStr);
    });

    if (excelInput.value !== newData) {
        excelInput.value = newData;
        generateTable(true);
    }
    
    undoReplaceButton.style.display = 'inline-flex';
}

        applyReplaceButton.addEventListener('click', applyReplacements);

        undoReplaceButton.addEventListener('click', () => {
            if (originalExcelData !== null) {
                excelInput.value = originalExcelData;
                originalExcelData = null;
                generateTable();
                undoReplaceButton.style.display = 'none';
            }
        });
     
     
clearButton.addEventListener('click', () => {
            excelInput.value = '';
            filterInput.value = '';
            originalExcelData = null;
            undoReplaceButton.style.display = 'none';
                        columnFilters = {};
            closeColumnFilterDropdown();
            generateTable();
            useHeaderCheckbox.checked = true; 
            updateControlsVisibility();
        });
        
        
        printButton.addEventListener('click', () => {
            if (currentTable) window.print();
            else alert('Сначала вставьте данные для создания таблицы.');
        });
        
     exportXlsxButton.addEventListener('click', showExportDialog);
        
        toggleColumnWidthsButton.addEventListener('click', () => {
            const isVisible = columnWidthControlsContainer.style.display === 'block';
            columnWidthControlsContainer.style.display = isVisible ? 'none' : 'block';
            toggleColumnWidthsButton.innerHTML = isVisible
                ? '<i class="fas fa-arrows-alt-h"></i><span>&nbsp;Ширина</span>'
                : '<i class="fas fa-eye-slash"></i><span>&nbsp;Скрыть</span>';
            toggleColumnWidthsButton.title = isVisible ? 'Настроить ширину колонок' : 'Скрыть настройки ширины';
        });
        
        // --- Template Functions and Listeners ---
        
function getSavedTemplates() {
            try {
                return JSON.parse(localStorage.getItem('tableTemplates') || '{}');
            } catch (e) {
                console.warn('Ошибка чтения шаблонов из localStorage:', e);
                return {};
            }
        }
        
function populateTemplateSelect() {
            templateSelect.innerHTML = ''; 
            
            const fileOption = document.createElement('option');
            fileOption.value = '-file-';
            fileOption.textContent = '-Файл-';
            templateSelect.appendChild(fileOption);

            const templates = getSavedTemplates();
            const names = Object.keys(templates);

            if (names.length > 0) {
                names.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    templateSelect.appendChild(option);
                });
            }
            
            deleteTemplateButton.disabled = (templateSelect.value === '-file-');
            loadTemplateButton.disabled = false; 
        }
        
        
        
function saveTemplate() {
            if (!currentTable) { alert('Нет таблицы для сохранения шаблона.'); return; }

            const templateData = {
                columns: columnHeaders.map(th => ({
                    width: th.style.width,
                    hidden: th.style.display === 'none'
                })),
                filter: filterInput.value.trim(),
                replaceRules: replaceRulesInput.value // Сохраняем правила
            };

            // Если выбран пункт Файл — скачиваем настройки как JSON
            if (templateSelect.value === '-file-') {
                const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'table_template.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                return;
            }

            const name = prompt('Введите имя для нового шаблона:', '');
            if (!name || !name.trim()) return;

            const templates = getSavedTemplates();
            templates[name.trim()] = templateData;
            localStorage.setItem('tableTemplates', JSON.stringify(templates));
            localStorage.setItem('lastUsedTemplateName', name.trim());
            
            populateTemplateSelect();
            templateSelect.value = name.trim();
            updateControlsVisibility();
            alert(`Шаблон "${name.trim()}" сохранен.`);
        }
        
function loadTemplate(templateName) {
            const name = templateName || templateSelect.value;
            if (!name || !currentTable) return;
            
            // Если выбран Файл — открываем диалог выбора файла
            if (name === '-file-') {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const savedData = JSON.parse(event.target.result);
                            applyTemplateData(savedData);
                        } catch (err) {
                            alert("Ошибка при чтении файла шаблона. Неверный формат.");
                        }
                    };
                    reader.readAsText(file);
                };
                fileInput.click();
                return;
            }
            
            // Иначе грузим из LocalStorage
          const templates = getSavedTemplates();
            const savedData = templates[name];
            if (!savedData) { alert(`Шаблон "${name}" не найден.`); return; }
            
            applyTemplateData(savedData);
            localStorage.setItem('lastUsedTemplateName', name);
        }
        
             function applyTemplateData(savedData) {
            const isOldFormat = Array.isArray(savedData);
            const templateData = isOldFormat ? savedData : savedData.columns;
            const filterText = isOldFormat ? '' : (savedData.filter || '');
            const replaceRulesText = isOldFormat ? '' : (savedData.replaceRules || '');
            
            // 1. Применяем правила автозамены
            replaceRulesInput.value = replaceRulesText;
            if (replaceRulesText.trim() !== '') {
                applyReplacements(); // Запускает замену и перегенерацию таблицы (generateTable)
            } else if (originalExcelData !== null) {
                undoReplaceButton.click(); // Отменяем замену, если в шаблоне её нет
            }

            // 2. Применяем настройки колонок (ширина, скрытие)
            const colOffset = document.getElementById('rowNumbersCheckbox').checked ? 1 : 0; // Смещение из-за колонки №
            columnHeaders.forEach((th, index) => {
                const colData = templateData[index];
                if (!colData) return;

                const isHidden = colData.hidden;
                
                // Применяем скрытие/показ ячеек (учитываем смещение)
                for (let i = 0; i < currentTable.rows.length; i++) {
                    const cell = currentTable.rows[i].cells[index + colOffset];
                    if (cell) cell.style.display = isHidden ? 'none' : '';
                }
                
                // Применяем скрытие/показ заголовка
                th.style.display = isHidden ? 'none' : '';
                
                // Восстанавливаем ширину (если колонка не скрыта)
                if (!isHidden) th.style.width = colData.width || `${100 / columnHeaders.length}%`;
                
                // Обновляем настройки в интерфейсе
                const widthInput = document.getElementById(`colWidthInput-${index}`);
                const hideCheckbox = document.getElementById(`hideColCheckbox-${index}`);
                if (widthInput) {
                    widthInput.value = isHidden ? '0' : parseFloat(colData.width).toFixed(1);
                    widthInput.disabled = isHidden;
                }
                if (hideCheckbox) hideCheckbox.checked = isHidden;
            });

            // 3. Применяем фильтр
            filterInput.value = filterText;
            applyFilter(); 

            // 4. Обновляем нумерацию строк (если включена)
            updateRowNumbers();

            // 5. Обновляем состояние кнопок
            updateControlsVisibility();
        }

        function deleteTemplate() {
            const name = templateSelect.value;
            if (!name) { alert('Выберите шаблон для удаления.'); return; }
            if (!confirm(`Вы уверены, что хотите удалить шаблон "${name}"?`)) return;

           const templates = getSavedTemplates();
            delete templates[name];
            localStorage.setItem('tableTemplates', JSON.stringify(templates));

            if (localStorage.getItem('lastUsedTemplateName') === name) {
                localStorage.removeItem('lastUsedTemplateName');
            }

            alert(`Шаблон "${name}" удален.`);
            populateTemplateSelect();
            updateControlsVisibility();
        }

        saveTemplateButton.addEventListener('click', saveTemplate);
        loadTemplateButton.addEventListener('click', () => loadTemplate());
        deleteTemplateButton.addEventListener('click', deleteTemplate);
        applyLastTemplateButton.addEventListener('click', () => {
            const lastName = localStorage.getItem('lastUsedTemplateName');
            if (lastName) loadTemplate(lastName);
            else alert('Последний использованный шаблон не найден.');
        });
        
                templateSelect.addEventListener('change', () => {
            deleteTemplateButton.disabled = (templateSelect.value === '-file-');
        });
        
        
        // --- Remaining UI functions and listeners ---
        
      useHeaderCheckbox.addEventListener('change', () => { if (excelInput.value.trim() !== '') generateTable(true); });
        centerAlignCheckbox.addEventListener('change', applyTableStyles);
        fontSizeInput.addEventListener('input', applyTableStyles);
        fontFamilySelect.addEventListener('change', applyTableStyles);
        
        enablePreviewCheckbox.addEventListener('change', togglePreviewMode);
        pageSizeSelect.addEventListener('change', () => {
            customPageSizeInputs.style.display = (pageSizeSelect.value === 'Custom' && enablePreviewCheckbox.checked) ? 'flex' : 'none';
            applyPreviewPageSettings();
        });
        [pageOrientationSelect, pageScaleInput, customWidthInput, customHeightInput].forEach(el => {
            el.addEventListener('change', applyPreviewPageSettings);
            if (el.type === 'number') el.addEventListener('input', applyPreviewPageSettings);
        });

        function applyTableStyles() {
            const rootStyle = document.documentElement.style;
            rootStyle.setProperty('--table-font-size', `${fontSizeInput.value}pt`);
            rootStyle.setProperty('--table-font-family', fontFamilySelect.value);
            if (!currentTable) return;
            const alignCenter = centerAlignCheckbox.checked;
            currentTable.querySelectorAll('tbody td').forEach(cell => {
                cell.classList.toggle('text-center', alignCenter);
            });
        }

        function togglePreviewMode() {
            const isPreviewEnabled = enablePreviewCheckbox.checked;
            tableRenderContainer.innerHTML = '';
            tableRenderContainer.classList.toggle('preview-active', isPreviewEnabled);
            if (isPreviewEnabled) {
                if (!printPreviewPageDiv) {
                    printPreviewPageDiv = document.createElement('div');
                    printPreviewPageDiv.id = 'printPreviewPage';
                }
                printPreviewPageDiv.innerHTML = '';
                if (currentTable) printPreviewPageDiv.appendChild(currentTable);
                tableRenderContainer.appendChild(printPreviewPageDiv);
                applyPreviewPageSettings();
            } else {
                if (printPreviewPageDiv && printPreviewPageDiv.parentNode) printPreviewPageDiv.parentNode.removeChild(printPreviewPageDiv);
                if (currentTable) tableRenderContainer.appendChild(currentTable);
                else if (excelInput.value.trim() === '') {
                    tableRenderContainer.appendChild(tablePlaceholder);
                    tablePlaceholder.style.display = 'block';
                    tablePlaceholder.textContent = 'Здесь появится таблица после обработки данных.';
                }
            }
            updateControlsVisibility();
        }

        function applyPreviewPageSettings() {
            if (!enablePreviewCheckbox.checked || !printPreviewPageDiv?.parentNode) return; 
            const selectedSize = pageSizeSelect.value;
            let paperWidthMM = selectedSize === 'Custom' ? (parseFloat(customWidthInput.value) || 210) : pageDimensions[selectedSize].width;
            let paperHeightMM = selectedSize === 'Custom' ? (parseFloat(customHeightInput.value) || 297) : pageDimensions[selectedSize].height;
            if (pageOrientationSelect.value === 'landscape') [paperWidthMM, paperHeightMM] = [paperHeightMM, paperWidthMM];
            
            const scalePercent = parseFloat(pageScaleInput.value) || 100;
            printPreviewPageDiv.style.width = `${(paperWidthMM / 25.4) * DPI}px`;
            printPreviewPageDiv.style.height = `${(paperHeightMM / 25.4) * DPI}px`;
            printPreviewPageDiv.style.transform = `scale(${scalePercent / 100})`;
        }

        function createColumnWidthInput(index, thElement) {
            const group = document.createElement('div');
            group.className = 'column-width-input-group';
            group.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 1em;">Колонка ${index + 1}</div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="colWidthInput-${index}">Ширина (%):</label>
                    <input type="number" id="colWidthInput-${index}" min="0.5" max="100" step="0.1">
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="hideColCheckbox-${index}">
                    <label for="hideColCheckbox-${index}" style="font-weight: normal; cursor: pointer; margin-bottom: 0;">Скрыть</label>
                </div>
            `;
            const widthInput = group.querySelector(`#colWidthInput-${index}`);
            widthInput.addEventListener('input', e => {
                let newWidth = parseFloat(e.target.value);
                if (!isNaN(newWidth) && newWidth >= 0.5 && newWidth <= 100 && thElement.style.display !== 'none') {
                    thElement.style.width = `${newWidth}%`;
                }
            });
            const hideCheckbox = group.querySelector(`#hideColCheckbox-${index}`);
            hideCheckbox.addEventListener('change', e => {
                const isHidden = e.target.checked;
                const columnIndex = columnHeaders.indexOf(thElement);
                if (columnIndex === -1 || !currentTable) return;

                for (let i = 0; i < currentTable.rows.length; i++) {
                    const cell = currentTable.rows[i].cells[columnIndex];
                    if (cell) {
                        cell.style.display = isHidden ? 'none' : '';
                    }
                }
                widthInput.disabled = isHidden;
            });
            columnWidthInputsDiv.appendChild(group);
        }
        
          document.getElementById('rowNumbersCheckbox').addEventListener('change', () => { if (excelInput.value.trim() !== '') generateTable(true); });
                
                templateSelect.addEventListener('change', () => {
    deleteTemplateButton.disabled = (templateSelect.value === '-file-');
});

        function addResizerEvents(resizer, th) {
            let x, currentThWidth, tableTotalWidth;
            const mouseDownHandler = function (e) {
                if (th.style.display === 'none' || !currentTable) return; 
                e.preventDefault();
                x = e.clientX;
                currentThWidth = th.offsetWidth;
                tableTotalWidth = currentTable.offsetWidth;
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = 'col-resize'; 
                currentTable.style.userSelect = 'none';
                columnHeaders.forEach(h => { if(h !== th && h.querySelector('.resizer')) h.querySelector('.resizer').style.pointerEvents = 'none'; });
            };
            const mouseMoveHandler = function (e) {
                if (!currentTable || th.style.display === 'none' || tableTotalWidth === 0) return;
                const dx = e.clientX - x;
                let newWidthPx = Math.max(10, currentThWidth + dx);
                const newWidthPercent = (newWidthPx / tableTotalWidth) * 100;
                if (newWidthPercent > 0.1 && newWidthPercent < 100) { 
                    th.style.width = `${newWidthPercent.toFixed(3)}%`; 
                    const colIndex = columnHeaders.indexOf(th);
                    const input = document.getElementById(`colWidthInput-${colIndex}`);
                    if (input) input.value = newWidthPercent.toFixed(1);
                }
            };
            const mouseUpHandler = function () {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = 'default';
                if (currentTable) currentTable.style.userSelect = '';
                columnHeaders.forEach(h => { if(h.querySelector('.resizer')) h.querySelector('.resizer').style.pointerEvents = 'auto'; });
            };
            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç –≤—ã–Ω–æ—Å–∞ —Ç–æ—á–µ–∫</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìç</text></svg>">
    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .app-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 2fr; gap: 30px; height: calc(100vh - 40px); }
        .control-panel { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; overflow-y: auto; }
        .document-preview { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .preview-header { padding: 20px 30px; border-bottom: 2px solid #f0f2f5; display: flex; justify-content: space-between; align-items: center; background: #fafbfc; flex-shrink: 0; }
        .preview-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
        .document-content { flex-grow: 1; overflow-y: auto; padding: 30px; background-color: #f0f2f5; }

        /* --- –§–û–†–ú–ê –í–í–û–î–ê --- */
        .form-section { margin-bottom: 25px; }
        .section-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #3498db; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: #34495e; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: #fafbfc; }
        .form-group input:focus, .form-group textarea:focus { border-color: #3498db; background: white; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .form-group textarea { min-height: 120px; resize: vertical; font-family: 'Consolas', 'Courier New', monospace; }
        .hint { font-size: 12px; color: #7f8c8d; margin-top: 5px; }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–õ–ï–ô --- */
        .margin-controls { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        .margin-control-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .margin-control label { display: block; margin-bottom: 5px; font-size: 13px; color: #34495e; }
        .margin-control .slider-container { display: flex; align-items: center; gap: 10px; }
        .margin-control input[type="range"] { width: 100%; flex: 1; margin: 0; }
        .margin-control .value { background: #ecf0f1; padding: 4px 8px; border-radius: 4px; font-size: 12px; min-width: 45px; text-align: center; }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .action-buttons { display: grid; gap: 12px; margin-top: 30px; }
        .btn { padding: 15px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3); }
        .btn-success { background: linear-gradient(135deg, #27ae60, #219a52); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3); }
        .btn-info { background: linear-gradient(135deg, #34b3db, #299fb9); color: white; }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(52, 179, 219, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3); }


        /* --- –î–û–ö–£–ú–ï–ù–¢ --- */
        #printableDocument { background: white; font-family: 'Times New Roman', Times, serif; font-size: 14pt; line-height: 1.6; color: #2c3e50; padding: 2cm; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); width: 100%; max-width: 21cm; height: auto; aspect-ratio: 210 / 297; outline: none; }
        #printableDocument[contenteditable="true"]:focus { box-shadow: 0 0 20px rgba(0,0,0,0.1), 0 0 0 3px rgba(52, 152, 219, 0.5); }
        #printableDocument p { text-align: justify; margin: 0.8em 0; text-indent: 1.5em; }
        #printableDocument .no-indent { text-indent: 0; }
        #printableDocument .center { text-align: center; text-indent: 0; }
        #printableDocument strong { font-weight: bold; }
        .field-line { display: inline-block; border-bottom: 1.5px solid #2c3e50; min-height: 1.2em; vertical-align: bottom; padding: 0 5px 2px 5px; margin: 0 3px; min-width: 20px; }
        .signature-section { margin-top: 3em; }
        .signature-line { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 1em; padding-bottom: 1em; }
        .signature-field { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .signature-field .line { border-bottom: 1.5px solid #2c3e50; min-width: 150px; margin-bottom: 5px; }
        .signature-field .caption { font-size: 10pt; color: #555; }
        #printableDocument table { width: 100%; border-collapse: collapse; margin: 1.5em 0; font-size: 12pt; }
        #printableDocument th, #printableDocument td { border: 1px solid #555; padding: 8px; text-align: center; }
        #printableDocument th { background-color: #f2f2f2; font-weight: bold; }
        
        @media (max-width: 1200px) { .app-container { grid-template-columns: 1fr; height: auto; } .document-preview { order: 2; min-height: 80vh; } .control-panel { order: 1; } }
        @media print { @page { size: A4 portrait; margin: 0; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: none; margin: 0; } .control-panel, .preview-header, .status-indicator, .ai-modal-overlay { display: none !important; } .app-container, .document-preview, .document-content { display: block !important; padding: 0 !important; margin: 0 !important; height: auto !important; box-shadow: none !important; border: none !important; overflow: hidden !important; } #printableDocument { box-shadow: none !important; margin: 0; width: 21cm; height: 29.7cm; max-width: none; aspect-ratio: auto; overflow: hidden !important; page-break-inside: avoid; } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; } ::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #95a5a6; }
        .status-indicator { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #27ae60; color: white; border-radius: 25px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; pointer-events: none; }
        .status-indicator.show { opacity: 1; transform: translateY(0); } .status-indicator.error { background-color: #e74c3c; }
        .ai-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; } .ai-modal-content { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 800px; display: flex; flex-direction: column; position: relative; } .ai-modal-content h2 { margin-top: 0; margin-bottom: 20px; text-align: center; color: #333; font-size: 1.3em; } .ai-modal-close-button { position: absolute; top: 10px; right: 15px; font-size: 32px; font-weight: bold; color: #888; cursor: pointer; line-height: 1; padding: 0 5px; } .ai-modal-close-button:hover { color: #555; } #ai-data-input { width: 100%; height: 25vh; padding: 15px; font-size: 16px; border: 2px solid #ccc; border-radius: 5px; resize: vertical; margin-bottom: 15px; } #ai-data-input:focus { border-color: #3498db; outline: none; } #ai-modal-submit { width: 100%; } #ai-modal-loading { text-align: center; padding: 20px; font-size: 1.2em; color: #555; display: none; } #ai-modal-loading i { font-size: 2.5em; color: #3498db; margin-bottom: 10px; } .image-previews-wrapper { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; } .ai-modal-image-preview-container { text-align: center; display: none; position: relative; border: 1px solid #ddd; border-radius: 5px; padding: 5px; } .ai-modal-image-preview { max-width: 300px; max-height: 120px; border-radius: 3px; } .ai-modal-clear-image { position: absolute; top: -8px; right: -8px; background: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #e74c3c; box-shadow: 0 0 5px rgba(0,0,0,0.2); font-weight: bold; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="control-panel">
            <div class="form-section">
                <div class="section-title"><i class="fas fa-user-tie"></i> –î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</div>
                <div class="form-group">
                    <label for="executorFio">–§–ò–û –≥–µ–æ–¥–µ–∑–∏—Å—Ç–∞/–∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞:</label>
                    <input type="text" id="executorFio" placeholder="">
                </div>
                <div class="form-group">
                    <label for="executorTitle">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                    <input type="text" id="executorTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –∏–Ω–∂–µ–Ω–µ—Ä">
                </div>
            </div>
             <div class="form-section">
                <div class="section-title"><i class="fas fa-user"></i> –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—á–∏–∫–∞</div>
                 <div class="form-group">
                    <label for="customerFio">–§–ò–û –∑–∞–∫–∞–∑—á–∏–∫–∞:</label>
                    <input type="text" id="customerFio" placeholder="">
                </div>
            </div>
            <div class="form-section">
                <div class="section-title"><i class="fas fa-map-marked-alt"></i> –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞</div>
                <div class="form-group">
                    <label for="cadastralNumber">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä:</label>
                    <input type="text" id="cadastralNumber" placeholder="">
                </div>
                <div class="form-group">
                    <label for="address">–ê–¥—Ä–µ—Å —É—á–∞—Å—Ç–∫–∞:</label>
                    <textarea id="address" placeholder=""></textarea>
                </div>
            </div>
            <div class="form-section">
                <div class="section-title"><i class="fas fa-satellite-dish"></i> –î–∞–Ω–Ω—ã–µ –æ —Ä–∞–±–æ—Ç–∞—Ö</div>
                 <div class="form-group">
                    <label for="contractNumber">–ù–æ–º–µ—Ä –∏ –¥–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</label>
                    <input type="text" id="contractNumber" placeholder="">
                </div>
                <div class="form-group">
                    <label for="workDate">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç:</label>
                    <input type="text" id="workDate" placeholder="">
                </div>
                 <div class="form-group">
                    <label for="equipment">–ò—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</label>
                    <textarea id="equipment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: GPS/–ì–õ–û–ù–ê–°–° –ø—Ä–∏–µ–º–Ω–∏–∫ Stonex S900A, –∑–∞–≤–æ–¥—Å–∫–æ–π ‚Ññ12345, —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ –ø–æ–≤–µ—Ä–∫–µ ‚Ññ54321 –æ—Ç 01.01.2025"></textarea>
                </div>
            </div>
             <div class="form-section">
                <div class="section-title"><i class="fas fa-ruler-combined"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫</div>
                <div class="form-group">
                    <label for="coordinates">–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (X Y):</label>
                    <textarea id="coordinates" placeholder=""></textarea>
                    <div class="hint">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å - –ø—Ä–æ–±–µ–ª.</div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">üìè –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
                <div class="margin-controls">
                    <div class="margin-control-group">
                        <div class="margin-control"><label>–õ–µ–≤–æ–µ:</label><div class="slider-container"><input type="range" id="marginLeft" min="1" max="4" value="2" step="0.1"><span class="value" id="marginLeftValue">2.0—Å–º</span></div></div>
                        <div class="margin-control"><label>–ü—Ä–∞–≤–æ–µ:</label><div class="slider-container"><input type="range" id="marginRight" min="1" max="4" value="2" step="0.1"><span class="value" id="marginRightValue">2.0—Å–º</span></div></div>
                    </div>
                    <div class="margin-control-group">
                        <div class="margin-control"><label>–í–µ—Ä—Ö–Ω–µ–µ:</label><div class="slider-container"><input type="range" id="marginTop" min="1" max="4" value="2" step="0.1"><span class="value" id="marginTopValue">2.0—Å–º</span></div></div>
                        <div class="margin-control"><label>–ù–∏–∂–Ω–µ–µ:</label><div class="slider-container"><input type="range" id="marginBottom" min="1" max="4" value="2" step="0.1"><span class="value" id="marginBottomValue">2.0—Å–º</span></div></div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-info" onclick="openAiModal()"><i class="fas fa-atom"></i> –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
                <button class="btn btn-primary" onclick="fillTemplate()"><i class="fas fa-pen-to-square"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ê–∫—Ç</button>
                <button class="btn btn-success" onclick="printDocument()"><i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å</button>
                <button class="btn btn-warning" onclick="exportToJPG()"><i class="fas fa-file-image"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ JPG</button>
                <button class="btn btn-danger" onclick="clearData()"><i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <div class="document-preview">
            <div class="preview-header"><div class="preview-title">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</div></div>
            <div class="document-content"><div id="printableDocument" contenteditable="true"></div></div>
        </div>
    </div>

    <div class="status-indicator" id="statusIndicator"></div>

    <!-- AI Modals (HTML is unchanged) -->
    <div id="aiDataExtractorModal" class="ai-modal-overlay" style="display: none;"><div class="ai-modal-content"><span class="ai-modal-close-button" onclick="closeAiModal()">&times;</span><h2>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</h2><div id="ai-modal-loading"><i class="fas fa-spinner fa-spin"></i><p id="ai-loading-status">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...</p></div><div id="ai-modal-form"><div class="image-previews-wrapper"><div id="ai-modal-image-preview-container-1" class="ai-modal-image-preview-container"><img id="ai-modal-image-preview-1" class="ai-modal-image-preview" src="#" alt="Image 1"/><span class="ai-modal-clear-image" onclick="clearAiImage(0)">&times;</span></div><div id="ai-modal-image-preview-container-2" class="ai-modal-image-preview-container"><img id="ai-modal-image-preview-2" class="ai-modal-image-preview" src="#" alt="Image 2"/><span class="ai-modal-clear-image" onclick="clearAiImage(1)">&times;</span></div></div><textarea id="ai-data-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –≤—ã–ø–∏—Å–∫—É –ï–ì–†–ù –∏–ª–∏ –¥–æ –¥–≤—É—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."></textarea><button id="ai-modal-submit" class="btn btn-primary" onclick="submitToAI()"><i class="fas fa-cogs"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å</button></div></div></div>
    <div id="crop-image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:10001; justify-content:center; align-items:center; flex-direction: column;"><div style="background-color:white; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; overflow:auto; text-align:center;"><h3 style="margin-top:0;">–û–±—Ä–µ–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3><p style="font-size:0.9em; color:#555;">–ù–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ–±–ª–∞—Å—Ç—å.</p><div id="crop-image-container" style="position:relative; display:inline-block; border:1px dashed #ccc; user-select:none; touch-action:none; max-width:100%; max-height:calc(85vh - 120px); overflow:hidden; cursor:crosshair;"><img id="crop-image-preview" src="#" alt="Preview" style="display:block; max-width:100%; max-height:100%; user-select:none; -webkit-user-drag:none;" /><div id="crop-selection-rectangle" style="position:absolute; border:2px solid rgba(0,123,255,0.7); background-color:rgba(0,123,255,0.1); display:none; pointer-events:none;"></div></div><div style="margin-top:15px; display: flex; justify-content: center; gap: 15px;"><button id="crop-image-button-confirm" style="padding:10px 20px; background-color:#4CAF50; color:white; border:none; border-radius:8px; cursor:pointer; font-size: 1rem;"><i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button><button id="crop-image-button-cancel" style="padding:10px 20px; background-color:#f44336; color:white; border:none; border-radius:8px; cursor:pointer; font-size: 1rem;"><i class="fas fa-times"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—ë</button></div></div></div>

    <script>
        const STORAGE_KEY = 'aktVynosaTochekData_v2';
        const formInputIds = [
            'executorFio', 'executorTitle', 'customerFio', 'cadastralNumber',
            'address', 'contractNumber', 'workDate', 'equipment', 'coordinates'
        ];

        // --- –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ---
        function saveData() {
            const data = {};
            formInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) data[id] = element.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                formInputIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && data[id]) {
                        element.value = data[id];
                    }
                });
                showStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
            }
        }
        
        function clearData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –∏ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.removeItem(STORAGE_KEY);
                formInputIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
                fillTemplate(); // –û–±–Ω–æ–≤–∏—Ç—å –ø—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω
                showStatus('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', false);
            }
        }

        // --- –°–ï–ö–¶–ò–Ø –õ–û–ì–ò–ö–ò –ò–ò ---
        const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
        const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
        const PROXY_MODE = 1; 
        let aiInputImages = [];
        const MAX_IMAGES = 2;

        async function submitToAI() {
            const textInput = document.getElementById('ai-data-input').value.trim();
            if (aiInputImages.length === 0 && textInput === '') { showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.', true); return; }
            
            document.getElementById('ai-modal-form').style.display = 'none';
            document.getElementById('ai-modal-loading').style.display = 'block';
            const loadingStatus = document.getElementById('ai-loading-status');

            try {
                let combinedText = textInput;
                if (aiInputImages.length > 0) {
                    for (let i = 0; i < aiInputImages.length; i++) {
                        loadingStatus.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${i+1}/${aiInputImages.length}...`;
                        const ocrText = await performOcrForImage(aiInputImages[i]);
                        combinedText += "\n\n" + ocrText;
                    }
                }
                
                loadingStatus.textContent = "–ê–Ω–∞–ª–∏–∑ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...";

                const extractionPrompt = `
                    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è "–ê–∫—Ç–∞ –≤—ã–Ω–æ—Å–∞ —Ç–æ—á–µ–∫".
                    –í–µ—Ä–Ω–∏ JSON-–æ–±—ä–µ–∫—Ç —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–ª—é—á–∞–º–∏. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π "".
                    
                    - "executorFio": –§–ò–û –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–≥–µ–æ–¥–µ–∑–∏—Å—Ç–∞ –∏–ª–∏ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞).
                    - "executorTitle": –î–æ–ª–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –∏–Ω–∂–µ–Ω–µ—Ä").
                    - "customerFio": –§–ò–û –∑–∞–∫–∞–∑—á–∏–∫–∞ —Ä–∞–±–æ—Ç.
                    - "contractNumber": –ù–æ–º–µ—Ä –∏ –¥–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–î–æ–≥–æ–≤–æ—Ä 15007 –æ—Ç 19.05.2025").
                    - "cadastralNumber": –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞.
                    - "address": –ê–¥—Ä–µ—Å –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞.
                    - "workDate": –î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç.
                    - "equipment": –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä –∏ —Å–≤–µ–¥–µ–Ω–∏—è –æ –ø–æ–≤–µ—Ä–∫–µ –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
                    - "coordinates": –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ø–∞—Ä—ã X –∏ Y). –í–µ—Ä–Ω–∏ –∏—Ö –≤ –≤–∏–¥–µ –µ–¥–∏–Ω–æ–π —Å—Ç—Ä–æ–∫–∏. –ö–∞–∂–¥–∞—è –ø–∞—Ä–∞ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ, X –∏ Y —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø—Ä–æ–±–µ–ª–æ–º.
                    
                    –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                    –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n---\n${combinedText.trim()}`;

                const modelId = "gemini-2.5-flash-lite-preview-06-17";
                let apiUrl, requestBody;

                if (PROXY_MODE === 1) {
                    apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                    requestBody = { model: modelId, messages: [{ role: "user", content: extractionPrompt }], max_tokens: 2048, response_format: { type: "json_object" } };
                } else {
                    apiUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`;
                    requestBody = { contents: [{ parts: [{ text: extractionPrompt }] }], generationConfig: { responseMimeType: "application/json" } };
                }

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const data = await response.json();
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ API –∞–Ω–∞–ª–∏–∑–∞: ${data?.error?.message || response.statusText}`);

                let aiResponseText = (PROXY_MODE === 1) ? data.choices?.[0]?.message?.content : data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiResponseText) throw new Error('–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.');
                
                const cleanedText = aiResponseText.trim().replace(/^```json\s*|\s*```$/g, '');
                const parsedData = JSON.parse(cleanedText);
                
                populateForm(parsedData);
                fillTemplate();
                closeAiModal();
                showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ò–ò:', error);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, true);
                document.getElementById('ai-modal-form').style.display = 'block';
                document.getElementById('ai-modal-loading').style.display = 'none';
            }
        }
        
        function populateForm(data) {
            for (const key in data) {
                const element = document.getElementById(key);
                if (element && typeof data[key] === 'string') {
                    element.value = data[key];
                }
            }
            saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ò–ò
        }
        
        // --- –°–ï–ö–¶–ò–Ø –†–ê–ë–û–¢–´ –° –®–ê–ë–õ–û–ù–û–ú ---
        function createField(value, width = '200px') { return value && value.trim() ? `<strong>${value}</strong>` : `<span class="field-line" style="min-width: ${width};">&nbsp;</span>`; }
        
        function parseCoordinates(coordText) {
            if (!coordText || coordText.trim() === '') return '';
            const lines = coordText.trim().split('\n');
            let tableRows = '';
            lines.forEach((line, index) => {
                const parts = line.trim().split(/\s+/);
                const x = parts[0] || '';
                const y = parts[1] || '';
                tableRows += `<tr><td>${index + 1}</td><td>${x}</td><td>${y}</td></tr>`;
            });
            return `<table><thead><tr><th>‚Ññ —Ç–æ—á–∫–∏</th><th>X</th><th>Y</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        }

        function fillTemplate() {
            const data = {};
            formInputIds.forEach(id => data[id] = document.getElementById(id).value);
            
            const coordinatesTable = parseCoordinates(data.coordinates);

            const documentHtml = `
                <p class="center"><strong>–ê–ö–¢</strong></p>
                <p class="center"><strong>–≤—ã–Ω–æ—Å–∞ –≤ –Ω–∞—Ç—É—Ä—É (–Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å) –º–µ–∂–µ–≤—ã—Ö –∑–Ω–∞–∫–æ–≤<br>–∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º ${createField(data.cadastralNumber, '180px')}</strong></p>
                <p class="no-indent">
                    –≥. <span class="field-line" style="min-width: 150px;">&nbsp;</span>
                    <span style="float: right;">¬´<span class="field-line" style="min-width: 40px;">&nbsp;</span>¬ª <span class="field-line" style="min-width: 120px;">&nbsp;</span> 202<span class="field-line" style="min-width: 20px;">&nbsp;</span> –≥.</span>
                </p>
                <p>–ú—ã, –Ω–∏–∂–µ–ø–æ–¥–ø–∏—Å–∞–≤—à–∏–µ—Å—è, –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äì ${createField(data.executorTitle, '200px')} ${createField(data.executorFio, '300px')}, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏ –ó–∞–∫–∞–∑—á–∏–∫ ‚Äì ${createField(data.customerFio, '300px')}, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ ${createField(data.contractNumber, '250px')}, —Å–æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –∞–∫—Ç –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º:</p>
                <p>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${createField(data.workDate, '200px')} –ø—Ä–æ–∏–∑–≤–µ–ª —Ä–∞–±–æ—Ç—ã –ø–æ –≤—ã–Ω–æ—Å—É –≤ –Ω–∞—Ç—É—Ä—É (–Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å) –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—é –º–µ–∂–µ–≤—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º ${createField(data.cadastralNumber, '180px')}, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ –∞–¥—Ä–µ—Å—É: ${createField(data.address, '100%')}.</p>
                <p>–ü–æ–≤–æ—Ä–æ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–µ–≤—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏ (–∞—Ä–º–∞—Ç—É—Ä–∞). –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ:</p>
                ${coordinatesTable || '<p class="center">(–¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å)</p>'}
                <p>–†–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${createField(data.equipment, '100%')}.</p>
                <p>–ó–∞–∫–∞–∑—á–∏–∫ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π –∫ –∫–∞—á–µ—Å—Ç–≤—É –∏ –æ–±—ä–µ–º—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –Ω–µ –∏–º–µ–µ—Ç. –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–µ–∂–µ–≤—ã—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –µ–º—É –ø–æ–∫–∞–∑–∞–Ω–æ –∏ —Å –Ω–∏–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ.</p>
                <div class="signature-section">
                    <div class="signature-line">
                        <div class="signature-field">
                            <div><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></div>
                            <div class="line">&nbsp;</div>
                            <div class="caption">(–ø–æ–¥–ø–∏—Å—å) / ${data.executorFio || '–§–ò–û'}</div>
                        </div>
                        <div class="signature-field">
                            <div><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong></div>
                            <div class="line">&nbsp;</div>
                            <div class="caption">(–ø–æ–¥–ø–∏—Å—å) / ${data.customerFio || '–§–ò–û'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printableDocument').innerHTML = documentHtml;
        }

        // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´ ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            fillTemplate();
            updateDocumentMargins();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
            formInputIds.forEach(id => {
                document.getElementById(id).addEventListener('input', saveData);
            });
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.addEventListener('input', updateDocumentMargins);
            });
            document.getElementById('ai-data-input').addEventListener('paste', handleAiModalPaste);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Å–ª–∞–π–¥–µ—Ä–æ–≤
            ['marginLeft', 'marginRight', 'marginTop', 'marginBottom'].forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');
                valueSpan.textContent = parseFloat(slider.value).toFixed(1) + '—Å–º';
            });
        });

        function updateDocumentMargins() { const doc = document.getElementById('printableDocument'); ['Left', 'Right', 'Top', 'Bottom'].forEach(dir => { const slider = document.getElementById('margin' + dir); const valueSpan = document.getElementById('margin' + dir + 'Value'); valueSpan.textContent = parseFloat(slider.value).toFixed(1) + '—Å–º'; doc.style['padding' + dir] = slider.value + 'cm'; }); }
        function printDocument() { window.print(); }
        function showStatus(message, isError = false) { const indicator = document.getElementById('statusIndicator'); indicator.textContent = message; indicator.classList.toggle('error', isError); indicator.classList.add('show'); setTimeout(() => { indicator.classList.remove('show'); }, 3000); }
        function exportToJPG() { showStatus('–°–æ–∑–¥–∞–Ω–∏–µ JPG, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...'); html2canvas(document.getElementById('printableDocument'), { scale: 2, useCORS: true, logging: false }).then(canvas => { const ctx = canvas.getContext('2d'); if (ctx) { const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); const data = imageData.data; for (let i = 0; i < data.length; i += 4) { const brightness = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]; const color = brightness > 140 ? 255 : 0; data[i] = color; data[i+1] = color; data[i+2] = color; } ctx.putImageData(imageData, 0, 0); } const link = document.createElement('a'); link.download = 'akt_vynosa_tochek.jpg'; link.href = canvas.toDataURL('image/jpeg', 1.0); link.click(); showStatus('–§–∞–π–ª JPG —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'); }).catch(err => { console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ JPG:', err); showStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞!', true); }); }
        
        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ò–ò –∏ –æ–±—Ä–µ–∑–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function openAiModal() { document.getElementById('aiDataExtractorModal').style.display = 'flex'; }
        function closeAiModal() { document.getElementById('aiDataExtractorModal').style.display = 'none'; document.getElementById('ai-modal-form').style.display = 'block'; document.getElementById('ai-modal-loading').style.display = 'none'; clearAiImage(-1); }
        function clearAiImage(index) { if (index === -1) { aiInputImages = []; for(let i=1; i <= MAX_IMAGES; i++) { document.getElementById(`ai-modal-image-preview-container-${i}`).style.display = 'none'; document.getElementById(`ai-modal-image-preview-${i}`).src = '#'; } } else { if (aiInputImages[index]) { aiInputImages.splice(index, 1); redrawImages(); } } }
        function redrawImages() { for(let i=0; i < MAX_IMAGES; i++) { const container = document.getElementById(`ai-modal-image-preview-container-${i+1}`); const imgEl = document.getElementById(`ai-modal-image-preview-${i+1}`); if (aiInputImages[i]) { imgEl.src = aiInputImages[i]; container.style.display = 'block'; } else { container.style.display = 'none'; } } }
        async function handleAiModalPaste(e) { if (aiInputImages.length >= MAX_IMAGES) { showStatus(`–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${MAX_IMAGES} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.`, true); return; } const items = (e.clipboardData || window.clipboardData).items; let imageFile = null; for (let i = 0; i < items.length; i++) { if (items[i].kind === 'file' && items[i].type.startsWith('image/')) { imageFile = items[i].getAsFile(); break; } } if (imageFile) { e.preventDefault(); showStatus('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ. –û–±—Ä–∞–±–æ—Ç–∫–∞...'); try { const imageDataUrl = await showCropModal(imageFile); if (!imageDataUrl) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è."); aiInputImages.push(imageDataUrl); redrawImages(); showStatus(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${aiInputImages.length} –¥–æ–±–∞–≤–ª–µ–Ω–æ.`); } catch (error) { console.error("Image Paste/Crop Error:", error); showStatus("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " + error.message, true); } } }
        async function performOcrForImage(base64DataUrl) { const ocrPrompt = "Extract all text from the image. Return ONLY the extracted text."; const base64ImageData = base64DataUrl.split(',')[1]; const modelId = "gemini-2.5-flash-lite-preview-06-17"; let apiUrl, requestBody; if (PROXY_MODE === 1) { apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`; requestBody = { model: modelId, messages: [{ role: "user", content: [{ type: "text", text: ocrPrompt }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64ImageData}` } }] }], max_tokens: 4096 }; } else { apiUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`; requestBody = { contents: [{ role: "user", parts: [{ text: ocrPrompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] }; } const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); const data = await response.json(); if (!response.ok) { throw new Error(`–û—à–∏–±–∫–∞ OCR API: ${data?.error?.message || response.statusText}`); } return (PROXY_MODE === 1) ? (data.choices?.[0]?.message?.content || "") : (data.candidates?.[0]?.content?.parts?.[0]?.text || ""); }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result);  reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        function showCropModal(imageFile) { return new Promise((resolve) => { const modal = document.getElementById('crop-image-modal'); const imgPreview = document.getElementById('crop-image-preview'); const cropContainer = document.getElementById('crop-image-container'); const selectionRectDiv = document.getElementById('crop-selection-rectangle'); const confirmButton = document.getElementById('crop-image-button-confirm'); const cancelButton = document.getElementById('crop-image-button-cancel'); let cropSelection = { startX: 0, startY: 0, endX: 0, endY: 0, isDrawing: false }; let imageNaturalSize = { width: 0, height: 0 }; let imageDisplaySize = { width: 0, height: 0 }; selectionRectDiv.style.display = 'none'; cropSelection.isDrawing = false; const reader = new FileReader(); reader.onload = function(e) { imgPreview.src = e.target.result; modal.style.display = 'flex'; imgPreview.onload = () => { imageNaturalSize.width = imgPreview.naturalWidth; imageNaturalSize.height = imgPreview.naturalHeight; imageDisplaySize.width = imgPreview.offsetWidth; imageDisplaySize.height = imgPreview.offsetHeight; }; }; reader.readAsDataURL(imageFile); function updateSelectionRect() { const x = Math.min(cropSelection.startX, cropSelection.endX); const y = Math.min(cropSelection.startY, cropSelection.endY); const width = Math.abs(cropSelection.endX - cropSelection.startX); const height = Math.abs(cropSelection.endY - cropSelection.startY); selectionRectDiv.style.left = `${x}px`; selectionRectDiv.style.top = `${y}px`; selectionRectDiv.style.width = `${width}px`; selectionRectDiv.style.height = `${height}px`; } function getMousePos(event) { const rect = cropContainer.getBoundingClientRect(); let x = event.clientX - rect.left; let y = event.clientY - rect.top; x = Math.max(0, Math.min(x, imageDisplaySize.width)); y = Math.max(0, Math.min(y, imageDisplaySize.height)); return { x, y }; } const onMouseDown = (e) => { e.preventDefault(); cropSelection.isDrawing = true; const pos = getMousePos(e.touches ? e.touches[0] : e); cropSelection.startX = pos.x; cropSelection.startY = pos.y; cropSelection.endX = pos.x; cropSelection.endY = pos.y; selectionRectDiv.style.display = 'block'; updateSelectionRect(); cropContainer.addEventListener('mousemove', onMouseMove); cropContainer.addEventListener('touchmove', onMouseMove, { passive: false }); window.addEventListener('mouseup', onMouseUp); window.addEventListener('touchend', onMouseUp); }; const onMouseMove = (e) => { if (!cropSelection.isDrawing) return; e.preventDefault(); const pos = getMousePos(e.touches ? e.touches[0] : e); cropSelection.endX = pos.x; cropSelection.endY = pos.y; updateSelectionRect(); }; const onMouseUp = () => { if (!cropSelection.isDrawing) return; cropSelection.isDrawing = false; cropContainer.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); cropContainer.removeEventListener('touchmove', onMouseMove); window.removeEventListener('touchend', onMouseUp); }; cropContainer.addEventListener('mousedown', onMouseDown); cropContainer.addEventListener('touchstart', onMouseDown, { passive: false }); const handleConfirm = () => { const selWidth = Math.abs(cropSelection.endX - cropSelection.startX); const selHeight = Math.abs(cropSelection.endY - cropSelection.startY); if (selWidth < 10 || selHeight < 10 || selectionRectDiv.style.display === 'none') { handleCancel(); return; } const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const scaleX = imageNaturalSize.width / imageDisplaySize.width; const scaleY = imageNaturalSize.height / imageDisplaySize.height; const sX = Math.min(cropSelection.startX, cropSelection.endX) * scaleX; const sY = Math.min(cropSelection.startY, cropSelection.endY) * scaleY; const sWidth = selWidth * scaleX; const sHeight = selHeight * scaleY; canvas.width = sWidth; canvas.height = sHeight; ctx.drawImage(imgPreview, sX, sY, sWidth, sHeight, 0, 0, sWidth, sHeight); const croppedImageDataUrl = canvas.toDataURL(imageFile.type || 'image/jpeg'); resolve(croppedImageDataUrl); cleanupModal(); }; const handleCancel = () => { fileToBase64(imageFile).then(base64 => resolve(base64)); cleanupModal(); }; const cleanupModal = () => { modal.style.display = 'none'; imgPreview.src = '#'; imgPreview.onload = null; cropContainer.removeEventListener('mousedown', onMouseDown); cropContainer.removeEventListener('touchstart', onMouseDown); confirmButton.onclick = null; cancelButton.onclick = null; }; confirmButton.onclick = handleConfirm; cancelButton.onclick = handleCancel; }); }
    </script>
</body>
</html>
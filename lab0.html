<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лаборатория</title>

   <link rel="shortcut icon" href="img/lab.png" type="image/x-icon">
    <link rel="stylesheet" href="webfonts/katex.min.css">
    <script defer src="webfonts/katex.min.js"></script>

      <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            --background-color: #eef1f5;
            --table-bg-color: #ffffff;
            --text-color: #3d4a5c;
            --header-color: #2c3e50;
            --shadow-color: rgba(44, 62, 80, 0.15);
            --primary-action-color: #3498db;
            --primary-action-hover: #2980b9;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --modal-header-bg: #f7f9fc;
            
            --s-block-bg: #ff8a80;
            --p-block-bg: #fdfd96;
            --d-block-bg: #90e0ef;
            --f-block-bg: #98fb98;
            --unknown-bg: #e0e0e0;
        }

        html { height: 100%; }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            /* ИЗМЕНЕНО: Анимированный градиентный фон */
            background: linear-gradient(-45deg, #a8c0ff, #89f7fe, #66a6ff, #a8c0ff);
            background-size: 400% 400%;
            animation: animateGradient 20s ease infinite;
            
            margin: 0;
            color: var(--text-color);
            height: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Ключевые кадры для анимации фона */
        @keyframes animateGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .main-container::-webkit-scrollbar { width: 12px; }
        .main-container::-webkit-scrollbar-track { background: #e2e8f0; }
        .main-container::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--primary-action-color), var(--primary-action-hover)); border-radius: 6px; }
        .main-container::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #5dade2, #3498db); }

        #periodic-table-container {
            padding: 20px;
            /* ИЗМЕНЕНО: Полупрозрачный фон с размытием */
            background: rgba(255, 255, 255, 0.85);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);

            border-radius: 16px;
            box-shadow: 0 8px 32px var(--shadow-color);
            overflow-x: auto;
            max-width: fit-content;
            margin: 0 auto;
        }
        
        #periodic-table-container::-webkit-scrollbar { height: 12px; }
        #periodic-table-container::-webkit-scrollbar-track { background: #eef1f5; border-radius: 10px; }
        #periodic-table-container::-webkit-scrollbar-thumb { background: linear-gradient(90deg, #a8b5c9, #8d9db5); border-radius: 10px; border: 2px solid #eef1f5; }
        #periodic-table-container::-webkit-scrollbar-thumb:hover { background: linear-gradient(90deg, var(--primary-action-color), var(--primary-action-hover)); }
        
        #periodic-table { display: grid; grid-template-columns: repeat(18, 62px); grid-template-rows: repeat(10, 62px); gap: 5px; width: max-content; padding-bottom: 10px; }
        .element { border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; transition: transform 0.25s ease, box-shadow 0.25s ease; text-align: center; padding: 4px; box-sizing: border-box; position: relative; color: var(--text-color); }
        .element[data-block="s"] { background-color: var(--s-block-bg); }
        .element[data-block="p"] { background-color: var(--p-block-bg); }
        .element[data-block="d"] { background-color: var(--d-block-bg); }
        .element[data-block="f"] { background-color: var(--f-block-bg); }
        .element:not([data-block]) { background-color: var(--unknown-bg); }
        .element:active { cursor: grabbing; transform: scale(0.95); }
        .element:hover { transform: scale(1.1) translateY(-5px); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-color: rgba(0,0,0,0.3); }
        .element.dragging { opacity: 0.5; transform: scale(0.9); }
        .element .symbol { font-size: 1.3rem; font-weight: 500; }
        .element .name { font-size: 0.6rem; line-height: 1.1; word-break: break-word; }
        .element .number { font-size: 0.65rem; position: absolute; top: 4px; left: 5px; opacity: 0.7; }
        
        @media screen and (min-width: 1440px) {
            #periodic-table { grid-template-columns: repeat(18, 72px); grid-template-rows: repeat(10, 72px); }
            .element .symbol { font-size: 1.6rem; }
            .element .name { font-size: 0.7rem; }
            .element .number { font-size: 0.75rem; }
        }

        #lab-toggle-button {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background-color: var(--primary-action-color);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        #lab-toggle-button:hover { background-color: var(--primary-action-hover); transform: translateY(-50%) scale(1.1) rotate(10deg); }
        #lab-toggle-button svg { width: 32px; height: 32px; fill: white; }
        
        #settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        #settings-btn:hover { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); box-shadow: 0 6px 20px rgba(142, 68, 173, 0.5); transform: scale(1.1) rotate(15deg); }
        #settings-btn svg { width: 30px; height: 30px; fill: white; }

        #lab-panel { position: fixed; top: 150px; left: 150px; width: 340px; background-color: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(44, 62, 80, 0.25); z-index: 1000; display: none; flex-direction: column; border: 1px solid #dfe4ea; opacity: 0; transform: scale(0.95); transition: opacity 0.3s, transform 0.3s; }
        #lab-panel.show { display: flex; opacity: 1; transform: scale(1); }
        .lab-header { padding: 12px 20px; background-color: var(--modal-header-bg); border-bottom: 1px solid #dfe4ea; border-radius: 12px 12px 0 0; cursor: move; display: flex; justify-content: space-between; align-items: center; }
        .lab-header h3 { margin: 0; font-size: 1.1rem; color: var(--header-color); font-weight: 500; }
        .lab-close-btn { font-size: 1.8rem; color: #aaa; cursor: pointer; line-height: 1; transition: color 0.2s; }
        .lab-close-btn:hover { color: var(--danger-color); }
        .lab-content { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; }
        #drop-zone { flex-grow: 1; border: 2px dashed #d9d9d9; border-radius: 8px; padding: 10px; margin-bottom: 20px; transition: all .3s; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; min-height: 160px; }
        #drop-zone.drag-over { border-color: var(--primary-action-color); background-color: #eaf5ff; }
        .lab-element-chip { background-color: #eef1f5; border-radius: 20px; padding: 6px 12px; display: flex; align-items: center; gap: 8px; font-weight: 500; color: var(--text-color); }
        .lab-element-chip .remove-btn { cursor: pointer; color: #f3686a; font-size: 1.2rem; line-height: 1; transition: color 0.2s; }
        .lab-element-chip .remove-btn:hover { color: #c0392b; }
        #start-experiment-btn { width: 100%; padding: 15px; font-size: 1.1rem; background-color: var(--primary-action-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all .2s; font-weight: 500; }
        #start-experiment-btn:hover:not(:disabled) { background-color: var(--primary-action-hover); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); }
        #start-experiment-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4); }
        #start-experiment-btn:disabled { background-color:#bdc3c7; cursor: not-allowed; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 20, 30, 0.7); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-overlay.show .modal-content { animation: fadeInScaleUp 0.35s ease-out forwards; }
        .modal-content { background: white; border-radius: 16px; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; position: relative; }
        .modal-header { padding: 15px 60px 15px 30px; border-bottom: 1px solid #e5e9f2; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h2 { margin: 0; color: var(--header-color); font-weight: 500; font-size: 1.5rem; }
        .modal-body { padding: 30px; overflow-y: auto; }
        .modal-content .close-btn { position: absolute; top: 14px; right: 14px; width: 36px; height: 36px; background: #f1f5f9; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .modal-content .close-btn svg { width: 18px; height: 18px; stroke: #6c757d; transition: all 0.3s ease; }
        .modal-content .close-btn:hover { background-color: var(--danger-color); transform: rotate(90deg); }
        .modal-content .close-btn:hover svg { stroke: white; }

        #result-modal .modal-content {
            width: 90vw;
            max-width: 1100px;
        }
        .result-section ul { list-style: none; padding-left: 0; margin: 0; }
        .result-section li { margin-bottom: 10px; line-height: 1.6; }
        .result-section h3 { border-bottom: 2px solid var(--primary-action-color); padding-bottom: 8px; margin-top: 25px; margin-bottom: 15px; color: var(--header-color); font-size: 1.2rem; }
        
        #element-detail-modal .modal-content { width: 90vw; height: 90vh; }
        #element-detail-body { display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; padding: 30px 40px; }
        .properties-list { list-style: none; padding: 0; margin: 0; }
        .properties-list li { display: flex; align-items: center; margin-bottom: 15px; font-size: 1rem; }
        .properties-list svg { width: 22px; height: 22px; margin-right: 15px; fill: #5c677d; flex-shrink: 0; }
        .properties-list b { color: var(--header-color); font-weight: 500; }
        .summary-section h3 { margin-top: 0; color: var(--header-color); border-bottom: 1px solid #e5e9f2; padding-bottom: 10px; font-weight: 500; }
        .summary-section p { line-height: 1.7; }
        .summary-section a { color: var(--primary-action-color); text-decoration: none; font-weight: 500; }
        .summary-section a:hover { text-decoration: underline; }
        .image-container { text-align: center; margin-bottom: 20px; }
        .image-container img { max-width: 100%; max-height: 280px; border-radius: 8px; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .image-container .attribution { font-size: 0.8em; color: #7f8c8d; margin-top: 10px; }

        .modal-body::-webkit-scrollbar { width: 10px; }
        .modal-body::-webkit-scrollbar-track { background: #f8fafc; }
        .modal-body::-webkit-scrollbar-thumb { background-color: var(--primary-action-color); border-radius: 10px; border: 2px solid #f8fafc; }
        .modal-body::-webkit-scrollbar-thumb:hover { background-color: var(--primary-action-hover); }

        .loader-container{text-align:center;padding:40px 0}.beaker{width:100px;height:120px;border:5px solid #777;border-top:none;border-radius:0 0 15px 15px;margin:0 auto;position:relative;background:linear-gradient(to top,#6c9eff,#a3c4ff)}.beaker::before,.beaker::after{content:'';position:absolute;width:12px;height:12px;background:white;border-radius:50%;bottom:10px;animation:bubble 2s infinite ease-in-out}.beaker::before{left:30%;animation-delay:0s}.beaker::after{left:60%;animation-delay:1s}@keyframes bubble{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-90px) scale(1.5);opacity:0}}
    
        #settings-modal .modal-content { width: 90%; max-width: 500px; }
        .settings-grid { display: flex; flex-direction: column; gap: 20px; }
        .settings-group { display: flex; flex-direction: column; }
        .settings-group label { margin-bottom: 8px; font-size: 0.9rem; color: var(--text-color); font-weight: 500; }
        .settings-group select, .settings-group input { width: 100%; padding: 12px 15px; border: 1px solid #dfe4ea; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background-color: #f8fafc; color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s; }
        .settings-group select:focus, .settings-group input:focus { outline: none; border-color: var(--primary-action-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        #api-key-input-group { display: none; }
        #save-settings-btn { margin-top: 25px; width: 100%; padding: 15px; background-color: var(--primary-action-color); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 500; cursor: pointer; transition: background-color .2s; }
        #save-settings-btn:hover { background-color: var(--primary-action-hover); }

        .reaction-effect {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid transparent;
        }
        .reaction-effect svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        .effect-fire {
            background-color: #fff8e1;
            border-color: #ffecb3;
            color: #f57f17;
        }
        .effect-explosion {
            background-color: #ffebee;
            border-color: #ffcdd2;
            color: var(--danger-color);
        }
        .effect-gas {
            background-color: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }
        .effect-toxic {
            background-color: #f3e5f5;
            border-color: #e1bee7;
            color: #6a1b9a;
        }
        .katex-display {
            margin: 1em 0;
            padding: 1em;
            background: #f8f9fa;
            border-left: 4px solid var(--primary-action-color);
            border-radius: 0 8px 8px 0;
            white-space: normal;
            word-break: break-all;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="main-container"><div id="periodic-table-container"><div id="periodic-table"></div></div></div>
    <button id="lab-toggle-button" title="Открыть лабораторию"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5,2C5.9,2,5.4,2.2,5,2.6L2.6,5C2.2,5.4,2,5.9,2,6.5V11C2,12.7,2.8,14.2,4,15.2V19C4,20.1,4.9,21,6,21H10C11.1,21,12,20.1,12,19V15.2C13.2,14.2,14,12.7,14,11V6.5C14,5.9,13.8,5.4,13.4,5L11,2.6C10.6,2.2,10.1,2,9.5,2H6.5M6,8V10H10V8H6M16,2V5H18V2H16M19,2V5H21V2H19M16,6V9H18V6H16M19,6V9H21V6H19M16,10V13H18V10H16M19,10V13H21V10H19M16,14V17H18V14H16M19,14V17H21V14H19M16,18V21H18V18H16M19,18V21H21V18H19Z"/></svg></button>
    <button id="settings-btn" title="Настройки ИИ Лаборанта"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14,12.94C19.07,12.44 19,11.94 19,11.44C19,10.94 19.07,10.44 19.14,9.94L21.12,8.4C21.27,8.27 21.31,8.08 21.21,7.91L19.26,4.5C19.16,4.33 18.96,4.26 18.79,4.33L16.4,5.29C15.92,4.92 15.38,4.62 14.79,4.4L14.47,2.1C14.43,1.92 14.26,1.8 14.08,1.8H10.08C9.9,1.8 9.73,1.92 9.69,2.1L9.37,4.4C8.78,4.62 8.24,4.92 7.76,5.29L5.37,4.33C5.2,4.26 5,4.33 4.9,4.5L2.95,7.91C2.85,8.08 2.89,8.27 3.04,8.4L5.02,9.94C4.93,10.44 4.86,10.94 4.86,11.44C4.86,11.94 4.93,12.44 5.02,12.94L3.04,14.47C2.89,14.59 2.85,14.78 2.95,14.95L4.9,18.36C5,18.53 5.2,18.6 5.37,18.53L7.76,17.57C8.24,17.94 8.78,18.24 9.37,18.46L9.69,20.76C9.73,20.94 9.9,21.06 10.08,21.06H14.08C14.26,21.06 14.43,20.94 14.47,20.76L14.79,18.46C15.38,18.24 15.92,17.94 16.4,17.57L18.79,18.53C18.96,18.6 19.16,18.53 19.26,18.36L21.21,14.95C21.31,14.78 21.27,14.59 21.12,14.47L19.14,12.94M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z" /></svg></button>
    <div id="lab-panel"><div class="lab-header"><h3>Лаборатория</h3><span class="lab-close-btn">&times;</span></div><div class="lab-content"><p style="text-align: center; font-size: 0.9em; color: #666; margin: 0 0 10px;">Перетащите сюда до 5 элементов</p><div id="drop-zone"></div><button id="start-experiment-btn" disabled>Химический опыт</button></div></div>
    <div class="modal-overlay" id="result-modal"><div class="modal-content"><div class="modal-header"><h2>Результаты эксперимента</h2><button class="close-btn" title="Закрыть"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-body" id="modal-body"></div></div></div>
    <div class="modal-overlay" id="element-detail-modal"><div class="modal-content"><div class="modal-header" id="element-detail-header"></div><div class="modal-body" id="element-detail-body"></div></div></div>
    <div class="modal-overlay" id="settings-modal"><div class="modal-content"><div class="modal-header"><h2>Настройки ИИ Лаборанта</h2><button class="close-btn" title="Закрыть"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-body"><p style="text-align: center; color: #6c757d; margin-top: 0; margin-bottom: 25px;">Выберите модель ИИ и режим подключения. Для прямого режима требуется API-ключ от Google (Gemini).</p><div class="settings-grid"><div class="settings-group"><label for="model-selector">1. Выберите модель</label><select id="model-selector"></select></div><div class="settings-group"><label for="api-mode-selector">2. Режим подключения</label><select id="api-mode-selector"><option value="mapruapp" selected>Прокси (mapruapp)</option><option value="vercel">Прокси (Vercel)</option><option value="direct">Прямой (Gemini)</option></select></div><div class="settings-group" id="api-key-input-group"><label for="api-key-input">3. Введите ваш API ключ Gemini</label><input type="password" id="api-key-input" placeholder="Ваш ключ..."></div></div><button id="save-settings-btn">Сохранить и закрыть</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const periodicTableContainer = document.getElementById('periodic-table');
            const labToggleButton = document.getElementById('lab-toggle-button');
            const labPanel = document.getElementById('lab-panel');
            const labHeader = labPanel.querySelector('.lab-header');
            const labCloseBtn = labPanel.querySelector('.lab-close-btn');
            const dropZone = document.getElementById('drop-zone');
            const startExperimentBtn = document.getElementById('start-experiment-btn');
            const resultModal = document.getElementById('result-modal');
            const resultModalBody = document.getElementById('modal-body');
            const resultModalCloseBtn = resultModal.querySelector('.close-btn');
            const detailModal = document.getElementById('element-detail-modal');
            const detailModalHeader = document.getElementById('element-detail-header');
            const detailModalBody = document.getElementById('element-detail-body');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsModalCloseBtn = settingsModal.querySelector('.close-btn');
            const modelSelector = document.getElementById('model-selector');
            const apiModeSelector = document.getElementById('api-mode-selector');
            const apiKeyInputGroup = document.getElementById('api-key-input-group');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            let draggedElement = null;

            const VERCEL_PROXY_BASE_URL="https://ver-olive-delta.vercel.app",MAPRUAPP_PROXY_BASE_URL="https://mapruapp.ru",MODELS=[{id:"gemini-2.5-flash-lite-preview-06-17",uiName:"Gemini 2.5 Flash Lite",apiType:"gemini",tier:'lite'},{id:"gemini-2.5-flash",uiName:"Gemini 2.5 Flash",apiType:"gemini",tier:'standard'},{id:"claude-sonnet-4-20250514",uiName:"Claude 4 Sonnet",apiType:"anthropic",tier:'standard'},{id:"cypher-alpha",uiName:"Cypher Alpha",apiType:"openrouter",tier:'standard'}],API_MODES={'mapruapp':{url:()=>`${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`},'vercel':{geminiUrl:modelId=>`${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`,claudeUrl:()=>`${VERCEL_PROXY_BASE_URL}/proxy/langdock/anthropic/eu/v1/messages`},'direct':{geminiUrl:(modelId,key)=>`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`}};
            const DEFAULT_MODEL_ID = "gemini-2.5-flash";
            let apiKey = null, currentApiMode = 'mapruapp', currentModelId = DEFAULT_MODEL_ID, currentApiType = "gemini";

            const iconLib={effect:{fire:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13.5,1.5C13.5,1.5 13.5,1.5 14,3C14.5,4.5 14,6.5 12,6.5C10,6.5 9.5,4.5 10,3C10.5,1.5 10.5,1.5 10.5,1.5S10.5,2.5 10,3C9.5,3.5 8,5.5 8,7.5C8,9.5 9.5,11 11.5,11S15,9.5 15,7.5C15,5.5 13.5,3.5 13,3C12.5,2.5 13.5,1.5 13.5,1.5M11.5,12C9.5,12 8,13 8,15C8,17 9.5,19.5 11.5,22.5C13.5,19.5 15,17 15,15C15,13 13.5,12 11.5,12Z" /></svg>',explosion:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M16,2V5H14V2H10V5H8V2H5V5H2V7H5V9H2V11H5V13H2V15H5V17H2V19H5V22H8V19H10V22H14V19H16V22H19V19H22V17H19V15H22V13H19V11H22V9H19V7H22V5H19V2H16M14,7V9H10V7H14M14,11V13H10V11H14M14,15V17H10V15H14Z" /></svg>',gas:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.5,11.5C12.5,10.1 11.4,9 10,9C8.6,9 7.5,10.1 7.5,11.5C7.5,12.9 8.6,14 10,14C11.4,14 12.5,12.9 12.5,11.5M17.5,7.5C17.5,6.1 16.4,5 15,5C13.6,5 12.5,6.1 12.5,7.5C12.5,8.9 13.6,10 15,10C16.4,10 17.5,8.9 17.5,7.5M6,16C6,15.2 5.5,14.5 4.8,14.2C4.1,13.9 3.2,14.1 2.7,14.7C2.1,15.2 1.9,16.1 2.2,16.8C2.5,17.5 3.2,18 4,18H14C14.8,18 15.5,17.5 15.8,16.8C16.1,16.1 15.9,15.2 15.3,14.7C14.8,14.1 13.9,13.9 13.2,14.2C12.5,14.5 12,15.2 12,16V20H6V16Z" /></svg>',toxic:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z" /></svg>'}};
            const effectMap=[{tag:'FIRE',icon:iconLib.effect.fire,class:'effect-fire'},{tag:'EXPLOSION',icon:iconLib.effect.explosion,class:'effect-explosion'},{tag:'GAS',icon:iconLib.effect.gas,class:'effect-gas'},{tag:'TOXIC',icon:iconLib.effect.toxic,class:'effect-toxic'}];

            fetch('https://vsemap.ru/periodictableru.json').then(r => r.json()).then(d => createPeriodicTable(d.elements)).catch(e => { console.error(e); periodicTableContainer.innerHTML = `<p>Ошибка</p>` });

            function createPeriodicTable(elements) { for (let i = 0; i < 180; i++) { periodicTableContainer.appendChild(document.createElement('div')) } elements.forEach(el => { const d = document.createElement('div'); d.className = 'element'; d.draggable = true; d.dataset.elementInfo = JSON.stringify(el); d.dataset.block = el.block; d.innerHTML = `<div class="number">${el.number}</div><div class="symbol">${el.symbol}</div><div class="name">${el.name}</div>`; d.addEventListener('dblclick', () => showElementInModal(el)); const p = periodicTableContainer.children[(el.ypos - 1) * 18 + (el.xpos - 1)]; if (p) periodicTableContainer.replaceChild(d, p) }) }
            function showElementInModal(element) { const N_A = 'н/д'; const icons = { number: '<svg viewBox="0 0 24 24"><path d="M9 7V9H11V17H13V9H15V7H9M5 3H19C20.1 3 21 3.9 21 5V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3Z" /></svg>', mass: '<svg viewBox="0 0 24 24"><path d="M12 3C10.6 3 9.4 3.7 8.8 4.8L4.3 12.8C3.7 13.9 4.2 15.3 5.3 15.8C5.8 16.1 6.3 16.2 6.8 16.2C7.8 16.2 8.7 15.6 9.2 14.7L10.8 11.7C10.9 11.5 11.2 11.3 11.5 11.3H12.5C12.8 11.3 13.1 11.5 13.2 11.7L14.8 14.7C15.3 15.6 16.2 16.2 17.2 16.2C17.7 16.2 18.2 16.1 18.7 15.8C19.8 15.3 20.3 13.9 19.7 12.8L15.2 4.8C14.6 3.7 13.4 3 12 3M12 6.3L13.7 9.8H10.3L12 6.3M6 18V20H18V18H6Z" /></svg>', category: '<svg viewBox="0 0 24 24"><path d="M12,2L1,21H23M12,6L19.53,19H4.47" /></svg>', phase: '<svg viewBox="0 0 24 24"><path d="M7.5,12.5A1.5,1.5 0 0,1 6,11A1.5,1.5 0 0,1 7.5,9.5A1.5,1.5 0 0,1 9,11A1.5,1.5 0 0,1 7.5,12.5M16.5,12.5A1.5,1.5 0 0,1 15,11A1.5,1.5 0 0,1 16.5,9.5A1.5,1.5 0 0,1 18,11A1.5,1.5 0 0,1 16.5,12.5M12,7A3,3 0 0,1 15,10C15,11.5 13.84,12.75 12.42,12.96C13.32,13.66 14,14.74 14,16V18H10V16C10,14.74 10.68,13.66 11.58,12.96C10.16,12.75 9,11.5 9,10A3,3 0 0,1 12,7M20,2H4A2,2 0 0,0 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4A2,2 0 0,0 20,2Z" /></svg>', density: '<svg viewBox="0 0 24 24"><path d="M17 3H7C5.9 3 5 3.9 5 5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V5C19 3.9 18.1 3 17 3M17 19H7V5H17V19M12 6C10.34 6 9 7.34 9 9S10.34 12 12 12 15 10.66 15 9 13.66 6 12 6Z" /></svg>', melt: '<svg viewBox="0 0 24 24"><path d="M12 2A2 2 0 0 1 14 4V11.27C16.62 12.33 18.5 14.94 18.5 18A6.5 6.5 0 0 1 12 24.5A6.5 6.5 0 0 1 5.5 18C5.5 14.94 7.38 12.33 10 11.27V4A2 2 0 0 1 12 2M12 13C12 13 10 15 10 17C10 18.11 10.9 19 12 19S14 18.11 14 17C14 15 12 13 12 13Z" /></svg>', boil: '<svg viewBox="0 0 24 24"><path d="M12 2A2 2 0 0 1 14 4V8.5C16.89 8.55 19.23 10.63 19.47 13.5H19.5A4.5 4.5 0 0 1 15 18A4.5 4.5 0 0 1 10.5 13.5C10.5 11.29 12.04 9.47 14 8.82V4H12M8 19H6V22H8V19M12 19H10V22H12V19M16 19H14V22H16V19Z" /></svg>', config: '<svg viewBox="0 0 24 24"><path d="M4,8A4,4 0 0,1 8,4A4,4 0 0,1 12,8A4,4 0 0,1 8,12A4,4 0 0,1 4,8M16,16A4,4 0 0,1 20,12A4,4 0 0,1 24,16A4,4 0 0,1 20,20A4,4 0 0,1 16,16M8,16A4,4 0 0,1 12,12A4,4 0 0,1 16,16A4,4 0 0,1 12,20A4,4 0 0,1 8,16Z" /></svg>', discovery: '<svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>' }; let imageHTML = ''; if (element.image && element.image.url) { imageHTML = `<div class="image-container"><img src="${element.image.url}" alt="${element.name}"><p class="attribution"><em>${element.image.title || ''}</em> ${element.image.attribution ? ' - ' + element.image.attribution : ''}</p></div>` } detailModalHeader.innerHTML = `<h2>${element.name} (${element.symbol})</h2><button class="close-btn" id="detail-modal-close-btn" title="Закрыть"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`; detailModalBody.innerHTML = `<div class="properties-section"><h3>Свойства</h3><ul class="properties-list"><li>${icons.number}<div><b>Номер:</b> ${element.number}</div></li><li>${icons.mass}<div><b>Атомная масса:</b> ${element.atomic_mass ? element.atomic_mass.toFixed(4) : N_A}</div></li><li>${icons.category}<div><b>Категория:</b> ${element.category || N_A}</div></li><li>${icons.phase}<div><b>Фаза (н.у.):</b> ${element.phase || N_A}</div></li><li>${icons.density}<div><b>Плотность:</b> ${element.density ? `${element.density} г/см³` : N_A}</div></li><li>${icons.melt}<div><b>Темп. плавления:</b> ${element.melt ? `${(element.melt - 273.15).toFixed(2)} °C` : N_A}</div></li><li>${icons.boil}<div><b>Темп. кипения:</b> ${element.boil ? `${(element.boil - 273.15).toFixed(2)} °C` : N_A}</div></li><li>${icons.config}<div><b>Конфигурация:</b> ${element.electron_configuration_semantic || N_A}</div></li><li>${icons.discovery}<div><b>Первооткрыватель:</b> ${element.discovered_by || N_A}</div></li></ul></div><div class="summary-section">${imageHTML}<h3>Описание</h3><p>${element.summary || 'Описание отсутствует.'}</p><hr style="border:0;border-top:1px solid #e5e9f2;margin:20px 0"><p><a href="${element.source || '#'}" target="_blank" rel="noopener noreferrer">Википедия</a></p></div>`; detailModal.classList.add('show'); document.getElementById('detail-modal-close-btn').addEventListener('click', () => detailModal.classList.remove('show')) }
            function updateExperimentButtonState() { startExperimentBtn.disabled = dropZone.children.length < 2 } let isDragging = !1, offsetX, offsetY; labHeader.addEventListener('mousedown', e => { isDragging = !0; offsetX = e.clientX - labPanel.offsetLeft; offsetY = e.clientY - labPanel.offsetTop; labPanel.style.transition = 'none'; document.body.style.userSelect = 'none' }); document.addEventListener('mousemove', e => { if (isDragging) { labPanel.style.left = `${e.clientX - offsetX}px`; labPanel.style.top = `${e.clientY - offsetY}px` } }); document.addEventListener('mouseup', () => { isDragging = !1; labPanel.style.transition = ''; document.body.style.userSelect = '' }); document.addEventListener('dragstart', e => { if (e.target.classList.contains('element')) { draggedElement = e.target; e.target.classList.add('dragging') } }); document.addEventListener('dragend', e => { if (draggedElement) { draggedElement.classList.remove('dragging'); draggedElement = null } }); dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over') }); dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over')); dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); if (!draggedElement) return; const elInfo = JSON.parse(draggedElement.dataset.elementInfo); const isAlreadyInLab = [...dropZone.children].some(c => c.dataset.number === String(elInfo.number)); if (dropZone.children.length < 5 && !isAlreadyInLab) { const c = document.createElement('div'); c.className = 'lab-element-chip'; c.dataset.number = elInfo.number; c.dataset.name = elInfo.name; c.innerHTML = `<span>${elInfo.symbol}</span> <span class="remove-btn">&times;</span>`; c.querySelector('.remove-btn').addEventListener('click', () => { c.remove(); updateExperimentButtonState() }); dropZone.appendChild(c); updateExperimentButtonState() } else if (isAlreadyInLab) alert("Этот элемент уже в лаборатории!"); else alert("В лаборатории не может быть больше 5 элементов!") });
            function showResultModal() { resultModal.classList.add('show') }
            function hideResultModal() { resultModal.classList.remove('show') }
            function showLoader() { resultModalBody.innerHTML = `<h2 style="text-align:center;">Идет химический опыт...</h2><div class="loader-container"><div class="beaker"></div></div><p style="text-align:center; color: #666;">Пожалуйста, подождите, ИИ-лаборант анализирует реакцию...</p>` }
            function displayError(e) { resultModalBody.innerHTML = `<h3 style="color:var(--danger-color);">Ошибка</h3><p>${e}</p>` }

                     function displayResult(summary, reaction) {
                const processText = (text) => {
                    if (!text) return '';
                    let html = text;

                    // 1. Обрабатываем теги эффектов, ИЗВЛЕКАЯ из них текст
                    effectMap.forEach(item => {
                        // Регулярное выражение, которое находит тег и "захватывает" текст внутри него.
                        // Флаг 'gs' означает глобальный поиск по всему тексту и многострочный режим.
                        const regex = new RegExp(`\\[EFFECT:${item.tag}\\](.*?)\\[\\/EFFECT:${item.tag}\\]`, 'gs');
                        // В $1 находится текст, который был внутри тегов.
                        html = html.replace(regex, `<li class="reaction-effect ${item.class}">${item.icon}$1</li>`);
                    });

                    // 2. Рендерим формулы с помощью KaTeX
                    html = html.replace(/\$(.*?)\$/g, (match, equation) => {
                        try {
                            if (typeof katex === 'undefined') {
                                console.error("KaTeX library is not loaded.");
                                return `<div class="katex-error">Ошибка: KaTeX не загружен. Формула: ${equation}</div>`;
                            }
                            return katex.renderToString(equation, { throwOnError: false, displayMode: true });
                        } catch (e) {
                            console.error("KaTeX Error:", e);
                            return `<div class="katex-error">Ошибка рендеринга: ${equation}</div>`;
                        }
                    });
                    
                    // 3. Базовое форматирование Markdown, которое осталось
                    html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                               .replace(/###\s*(.*?)(?:\n|<br>)/g, "<h3>$1</h3>")
                               .replace(/-\s(.*?)(?:\n|<br>)/g, "<li>$1</li>")
                               .replace(/\n/g, '<br>');

                    // 4. Очистка от пустых тегов <li>, которые могли остаться после обработки
                    html = html.replace(/<li>\s*<br>\s*<\/li>/g, '').replace(/<li>\s*<\/li>/g, '');

                    return html;
                };

                const summaryHtml = processText(summary);
                const reactionHtml = processText(reaction);
                resultModalBody.innerHTML = `<div class="result-section"><ul>${summaryHtml}</ul></div> <div class="result-section"><ul>${reactionHtml}</ul></div>`;
            }

            function openSettingsModal() { settingsModal.classList.add('show') }
            function closeSettingsModal() { settingsModal.classList.remove('show') }
            function populateModelSelector() { modelSelector.innerHTML = ''; MODELS.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = m.uiName; o.dataset.apiType = m.apiType; modelSelector.appendChild(o) }) }
            function updateSettingsUI() { currentApiMode = apiModeSelector.value; const sel = modelSelector.options[modelSelector.selectedIndex]; currentApiType = sel.dataset.apiType; apiKeyInputGroup.style.display = currentApiMode === 'direct' ? 'block' : 'none'; const d = apiModeSelector.querySelector('option[value="direct"]'); d.disabled = currentApiType !== 'gemini'; if (d.disabled && currentApiMode === 'direct') { apiModeSelector.value = 'mapruapp'; currentApiMode = 'mapruapp'; apiKeyInputGroup.style.display = 'none' } }
            function saveSettings() { const key = apiKeyInput.value.trim(); currentModelId = modelSelector.value; currentApiMode = apiModeSelector.value; const sel = modelSelector.options[modelSelector.selectedIndex]; currentApiType = sel.dataset.apiType; if (currentApiMode === 'direct' && currentApiType === 'gemini' && !key) { alert('Для прямого режима "Gemini" необходимо ввести API ключ.'); return } apiKey = key; localStorage.setItem('periodicTableApiKey', key); localStorage.setItem('periodicTableModelId', currentModelId); localStorage.setItem('periodicTableApiMode', currentApiMode); closeSettingsModal() }
            function loadSettings() { apiKey = localStorage.getItem('periodicTableApiKey') || ''; apiKeyInput.value = apiKey; modelSelector.value = localStorage.getItem('periodicTableModelId') || DEFAULT_MODEL_ID; apiModeSelector.value = localStorage.getItem('periodicTableApiMode') || 'mapruapp'; updateSettingsUI() }
            
            settingsBtn.addEventListener('click', openSettingsModal);
            settingsModalCloseBtn.addEventListener('click', closeSettingsModal);
            settingsModal.addEventListener('click', e => { if (e.target === settingsModal) closeSettingsModal() });
            saveSettingsBtn.addEventListener('click', saveSettings);
            apiModeSelector.addEventListener('change', updateSettingsUI);
            modelSelector.addEventListener('change', updateSettingsUI);
            labToggleButton.addEventListener('click', () => labPanel.classList.toggle('show'));
            labCloseBtn.addEventListener('click', () => labPanel.classList.remove('show'));
            detailModal.addEventListener('click', e => { if (e.target === detailModal) detailModal.classList.remove('show') });
            resultModalCloseBtn.addEventListener('click', hideResultModal);
            resultModal.addEventListener('click', e => { if (e.target === resultModal) hideResultModal() });

            async function getAIReaction(elements) {
                if (currentApiMode === 'direct' && currentApiType === 'gemini' && !apiKey) {
                    openSettingsModal();
                    throw new Error("API ключ не настроен. Пожалуйста, введите ключ в настройках.");
                }
                const systemPrompt = `Ты — опытный химик-исследователь. Пользователь хочет провести виртуальный опыт, смешав: ${elements.join(", ")}.
Твоя задача — дать структурированный, подробный и визуально понятный ответ.
Ответь строго по следующему формату, используя маркеры [SUMMARY] и [REACTION].

### ПРАВИЛА ОФОРМЛЕНИЯ:
1.  **Формулы:** Все химические уравнения ОБЯЗАТЕЛЬНО заключай в знаки доллара, используя синтаксис KaTeX/LaTeX. Например: \`$2\\text{Na} + \\text{Cl}_2 \\rightarrow 2\\text{NaCl}$\`.
2.  **Эффекты:** Все важные наблюдаемые эффекты (горение, взрыв, выделение газа, токсичность) ОБЯЗАТЕЛЬНО заключай в специальные теги. Используй только эти теги:
    *   \`[EFFECT:FIRE]текст о горении[/EFFECT:FIRE]\`
    *   \`[EFFECT:EXPLOSION]текст о взрыве[/EFFECT:EXPLOSION]\`
    *   \`[EFFECT:GAS]текст о выделении газа[/EFFECT:GAS]\`
    *   \`[EFFECT:TOXIC]текст о токсичности[/EFFECT:TOXIC]\`
    Пример: \`[EFFECT:FIRE]Натрий горит ярким желтым пламенем.[/EFFECT:FIRE]\`

### ФОРМАТ ОТВЕТА:
[SUMMARY]
### Исходные вещества:
- **Название элемента 1:** Краткая характеристика (агрегатное состояние при н.у., тип, основное свойство).
- **Название элемента 2:** Краткая характеристика.
... и так далее для всех элементов.

[REACTION]
### Результат взаимодействия:
Подробно опиши, что произойдет при попытке смешать эти вещества.
- *Условия:* (температура, давление, катализатор).
- *Уравнения реакции:* (если применимо, используй KaTeX-формат).
- *Продукты реакции:* (перечисли продукты).
- *Наблюдаемые эффекты:* (опиши эффекты, используя теги).
- *Опасности:* (опиши опасности, используя теги).
`;
                let apiUrl, requestBody; const fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } }; const apiModeConfig = API_MODES[currentApiMode]; if (currentApiMode === 'mapruapp') { apiUrl = apiModeConfig.url(); requestBody = { model: currentModelId, messages: [{ role: "user", content: systemPrompt }], temperature: 0.5, max_tokens: 2048 } } else if (currentApiMode === 'vercel') { if (currentApiType === 'gemini') { apiUrl = apiModeConfig.geminiUrl(currentModelId); requestBody = { contents: [{ parts: [{ "text": systemPrompt }] }] } } else if (currentApiType === 'anthropic') { apiUrl = apiModeConfig.claudeUrl(); requestBody = { model: currentModelId, messages: [{ "role": "user", "content": systemPrompt }], max_tokens: 4096 } } else { apiUrl = apiModeConfig.url(); requestBody = { model: currentModelId, messages: [{ role: "user", content: systemPrompt }], temperature: 0.5, max_tokens: 2048 } } } else if (currentApiMode === 'direct' && currentApiType === 'gemini') { apiUrl = apiModeConfig.geminiUrl(currentModelId, apiKey); requestBody = { contents: [{ parts: [{ "text": systemPrompt }] }] } } else { throw new Error(`Выбранный режим (${currentApiMode}) несовместим с моделью (${currentModelId}).`) }
                fetchOptions.body = JSON.stringify(requestBody); const response = await fetch(apiUrl, fetchOptions); if (!response.ok) { const errorText = await response.text(); throw new Error(`Ошибка ответа ИИ: ${response.status}. ${errorText}`) }
                const data = await response.json(); let aiResponseText; if (currentApiMode === 'mapruapp' || (currentApiMode === 'vercel' && currentApiType === 'anthropic')) { aiResponseText = data.choices?.[0]?.message?.content || data.content?.[0]?.text } else if (currentApiType === 'gemini') { aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text } if (!aiResponseText) { throw new Error('ИИ вернул пустой или некорректный ответ.') }
                const summary = aiResponseText.split("[REACTION]")[0].replace("[SUMMARY]", "").trim(); const reaction = aiResponseText.split("[REACTION]")[1] ? aiResponseText.split("[REACTION]")[1].trim() : "ИИ не предоставил описание реакции."; return { summary, reaction }
            }

            startExperimentBtn.addEventListener('click', async () => {
                const elements = [...dropZone.children].map(chip => chip.dataset.name);
                showResultModal();
                showLoader();
                try {
                    const result = await getAIReaction(elements);
                    displayResult(result.summary, result.reaction);
                } catch (error) {
                    console.error("AI Error:", error);
                    displayError(`Произошла ошибка при связи с ИИ. ${error.message}`);
                }
            });

            populateModelSelector();
            loadSettings();
        });
    </script>
</body>
</html>
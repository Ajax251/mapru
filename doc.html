<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –î–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #3b82f6; --primary-hover: #2563eb; --primary-light: #bfdbfe;
            --secondary-color: #8b5cf6; --secondary-light: #ddd6fe; --success-color: #10b981;
            --success-light: #d1fae5; --error-color: #ef4444; --error-light: #fee2e2;
            --warning-color: #f59e0b; --warning-light: #fef3c7; --gray-50: #f8fafc;
            --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1;
            --gray-500: #64748b; --gray-700: #334155; --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --header-color: #202124;
            --border-color: #dadce0;
            --accent-color: #1a73e8;
            --option-hover: #f1f3f4;
            --option-selected: #e8f0fe;
            --option-selected-border: #1a73e8;
            --button-bg: #1a73e8;
            --button-bg-hover: #1765cc;
            --button-color: white;
            --input-bg: #ffffff;
            --input-border: #dadce0;
            --input-text: #202124;
            --message-bot-color: #202124;
        }
        body.dark-theme {
            --primary-color: #60a5fa; --primary-hover: #3b82f6; --primary-light: #374151;
            --secondary-color: #a78bfa; --secondary-light: #4b5563; --success-color: #34d399;
            --success-light: #1f2937; --error-color: #f87171; --error-light: #374151;
            --warning-color: #fbbf24; --warning-light: #374151; --gray-50: #1f2937;
            --gray-100: #374151; --gray-200: #4b5563; --gray-300: #6b7280;
            --gray-500: #9ca3af; --gray-700: #d1d5db; --gray-900: #f9fafb;
            --bg-color: #111827;
            --container-bg: #1f2937;
            --header-color: #e0eafe;
            --border-color: #374151;
            --accent-color: #56c8fa;
            --option-hover: #374151;
            --option-selected: #223e60;
            --option-selected-border: #3edbea;
            --button-bg: #259af7;
            --button-bg-hover: #41c6e0;
            --button-color: #07111f;
            --input-bg: #1f2937;
            --input-border: #4b5563;
            --input-text: #e4f0f4;
            --message-bot-color: #f3f9fb;
        }

        /* Basic Styles & Layout */
        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--gray-900); line-height: 1.6; }
        .page-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Header */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background-color: var(--container-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .header-title { font-size: 20px; font-weight: 500; color: var(--header-color); display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .theme-toggle { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .theme-toggle:hover { background-color: var(--option-hover); }
        .theme-toggle svg { width: 20px; height: 20px; fill: var(--accent-color); }
        .sun-icon { display: block; } .moon-icon { display: none; }
        body.dark-theme .sun-icon { display: none; } body.dark-theme .moon-icon { display: block; }

        /* API Selectors */
        .selector-container { position: relative; }
        .selector-button { padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--container-bg); cursor: pointer; font-size: 14px; color: var(--message-bot-color); display: flex; align-items: center; gap: 8px; min-width: 180px; }
        .selector-button:hover { background: var(--option-hover); }
        .selector-options { position: absolute; top: calc(100% + 5px); right: 0; background: var(--container-bg); border-radius: 8px; box-shadow: var(--shadow-lg); padding: 8px 0; list-style: none; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; z-index: 100; border: 1px solid var(--border-color); width: 250px; }
        .selector-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .selector-option { padding: 10px 16px; cursor: pointer; font-size: 13px; color: var(--message-bot-color); display: flex; align-items: center; gap: 10px; }
        .selector-option:hover { background-color: var(--option-hover); }
        .selector-option.selected { background-color: var(--option-selected); border-left: 3px solid var(--option-selected-border); font-weight: 500; padding-left: 13px; }
        .selector-option .icon { width: 16px; height: 16px; fill: var(--accent-color); }
        
        /* Main Content */
        .main-container { width: 100%; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .form-container { background: var(--container-bg); border-radius: 16px; box-shadow: var(--shadow-md); padding: 2.5rem; }
        .form-control-group { margin-bottom: 1.5rem; }
        .form-control-group label { display: block; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; font-size: 0.95rem; }
        .mode-selector { display: flex; gap: 0.5rem; background-color: var(--gray-100); padding: 0.5rem; border-radius: 12px; }
        .mode-btn { flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 8px; background-color: transparent; color: var(--gray-500); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .mode-btn:hover { background-color: var(--primary-light); color: var(--primary-color); }
        .mode-btn.active { background-color: var(--primary-color); color: white; box-shadow: var(--shadow-sm); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        select.custom-select { width: 100%; padding: 0.75rem; border: 2px solid var(--input-border); border-radius: 12px; font-size: 0.9rem; background: var(--input-bg); color: var(--input-text); }
        #user-query { width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--input-border); border-radius: 12px; font-size: 1rem; resize: vertical; background: var(--input-bg); color: var(--input-text); }
        #user-query:focus { outline: none; border-color: var(--primary-color); }
        .generate-btn { flex: 1; padding: 1rem 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .generate-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .generate-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .spinner { width: 24px; height: 24px; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Document Preview Section */
        #preview-section { margin-top: 2.5rem; background: var(--container-bg); border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden; display: none;}
        #preview-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #preview-header h2 { font-size: 1.25rem; color: var(--header-color); }
        #preview-actions button { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--gray-700); border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; }
        #preview-actions button:hover { background-color: var(--option-hover); }
        #document-preview-container { padding: 2rem; }
        #document-preview-container.loading { display: flex; justify-content: center; align-items: center; min-height: 200px; }

        /* Styles for content INSIDE the preview */
        #document-preview-container h1 { font-size: 1.8em; margin-bottom: 1em; text-align: center; color: var(--gray-900); }
        #document-preview-container h2 { font-size: 1.5em; margin-top: 1.5em; margin-bottom: 0.8em; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.3em; color: var(--gray-800); }
        #document-preview-container h3 { font-size: 1.2em; margin-top: 1.2em; margin-bottom: 0.6em; color: var(--gray-700); }
        #document-preview-container p { margin-bottom: 1em; text-align: justify; text-indent: 1.5em; }
        #document-preview-container p:first-of-type { text-indent: 0; }
        #document-preview-container ul, #document-preview-container ol { margin-left: 2em; margin-bottom: 1em; }
        #document-preview-container li { margin-bottom: 0.5em; }
        #document-preview-container table { width: 100%; border-collapse: collapse; margin-bottom: 1.5em; }
        #document-preview-container th, #document-preview-container td { border: 1px solid var(--gray-300); padding: 0.8em; text-align: left; }
        #document-preview-container th { background-color: var(--gray-100); font-weight: 600; }
        #document-preview-container blockquote { border-left: 4px solid var(--primary-color); padding-left: 1em; margin: 1em 0; color: var(--gray-500); font-style: italic; }
        #document-preview-container .placeholder { color: var(--gray-500); text-align: center; font-style: italic; }

        /* Notification */
        .notification { position: fixed; top: 1.5rem; right: 1.5rem; padding: 1rem 1.5rem; border-radius: 8px; z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.4s ease; background-color: var(--success-light); color: var(--success-color); box-shadow: var(--shadow-lg); }
        .notification.error { background-color: var(--error-light); color: var(--error-color); }
        .notification.show { opacity: 1; transform: translateX(0); }
        
        /* Print Styles */
        @media print {
            body, .page-wrapper { background: none; color: black; }
            .header, .main-container > .form-container, #preview-header, .notification { display: none !important; }
            #preview-section { box-shadow: none; border: none; margin: 0; border-radius: 0; }
            #document-preview-container {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                color: black !important;
            }
            #document-preview-container * { color: black !important; background-color: transparent !important; }
            body * { visibility: hidden; }
        }
        @media (max-width: 768px) {
            .header-controls { flex-direction: column; align-items: flex-end; gap: 0.5rem; }
            .main-container { margin: 1rem auto; }
            .form-container { padding: 1.5rem; }
            .controls-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="page-wrapper">
        <header class="header">
            <div class="header-title">
                <i class="fas fa-file-alt fa-fw"></i>
                <span>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –î–æ–∫—É–º–µ–Ω—Ç–æ–≤</span>
            </div>
            <div class="header-controls">
                 <!-- Model Selector -->
                 <div class="selector-container">
                    <button class="selector-button" id="model-selector-button">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...</button>
                    <ul class="selector-options" id="model-options"></ul>
                </div>

                <!-- API Mode Selector -->
                <div class="selector-container">
                    <button class="selector-button" id="api-mode-selector-button">
                        <!-- Content generated by JS -->
                    </button>
                    <ul class="selector-options" id="api-mode-options"></ul>
                </div>
                <button class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                     <svg class="sun-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z..."></path></svg>
                     <svg class="moon-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
                </button>
            </div>
        </header>

        <main class="main-container">
            <div class="form-container">
                <div class="form-control-group">
                    <label for="mode-selector"><i class="fas fa-sliders-h"></i> –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                    <div class="mode-selector" id="mode-selector">
                        <button class="mode-btn active" data-mode="create"><i class="fas fa-magic"></i> –°–æ–∑–¥–∞–Ω–∏–µ</button>
                        <button class="mode-btn" data-mode="refine"><i class="fas fa-search"></i> –î–æ—Ä–∞–±–æ—Ç–∫–∞</button>
                    </div>
                </div>

                <div class="controls-grid">
                    <div class="form-control-group">
                        <label for="role-selector"><i class="fas fa-user-tie"></i> –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
                        <select id="role-selector" class="custom-select">
                            <option value="deloproizvoditel">–î–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</option>
                            <option value="general_jurist">–Æ—Ä–∏—Å—Ç</option>
                            <option value="hr_specialist">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–∞–º</option>
                            <option value="accountant">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
                            <option value="real_estate">–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</option>
                        </select>
                    </div>
                    <div class="form-control-group">
                        <label for="detail-selector"><i class="fas fa-align-left"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</label>
                        <div class="mode-selector" id="detail-selector">
                            <button class="mode-btn" data-level="short">–ö—Ä–∞—Ç–∫–æ</button>
                            <button class="mode-btn active" data-level="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ</button>
                            <button class="mode-btn" data-level="detailed">–ü–æ–¥—Ä–æ–±–Ω–æ</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-control-group">
                    <label for="user-query"><i class="fas fa-edit"></i> –û–ø–∏—à–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏</label>
                    <textarea id="user-query" rows="8" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–∏–∫–∞–∑ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ –ø–æ–∂–∞—Ä–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"></textarea>
                </div>
                
                <div class="form-control-group">
                    <button id="generate-btn" class="generate-btn">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
            </div>

            <section id="preview-section">
                <div id="preview-header">
                    <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
                    <div id="preview-actions">
                        <button id="save-pdf-btn"><i class="fas fa-file-pdf"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF</button>
                        <button id="save-html-btn"><i class="fas fa-file-code"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ HTML</button>
                    </div>
                </div>
                <div id="document-preview-container">
                    <p class="placeholder">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç...</p>
                </div>
            </section>
        </main>
    </div>

    <div class="notification"></div>
    
    <div class="modal-overlay" id="api-key-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: flex; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--container-bg); padding: 25px; border-radius: 10px; width: 90%; max-width: 450px;">
            <h2 id="api-key-modal-title">API –∫–ª—é—á</h2>
            <p id="api-key-modal-text" style="margin: 1rem 0; color: var(--gray-700);"></p>
            <p><a id="api-key-modal-link" href="#" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color);">–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á</a></p>
            <input type="password" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á..." style="width: 100%; padding: 10px; margin: 1rem 0; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--input-text);">
            <button id="save-api-key-btn" style="padding: 10px 20px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 6px; cursor: pointer; width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
    class DocumentGenerator {
        constructor() {
            this.elements = {
                // UI Elements
                generateBtn: document.getElementById('generate-btn'),
                queryInput: document.getElementById('user-query'),
                modeSelector: document.getElementById('mode-selector'),
                roleSelector: document.getElementById('role-selector'),
                detailSelector: document.getElementById('detail-selector'),
                previewSection: document.getElementById('preview-section'),
                previewContainer: document.getElementById('document-preview-container'),
                savePdfBtn: document.getElementById('save-pdf-btn'),
                saveHtmlBtn: document.getElementById('save-html-btn'),
                notification: document.querySelector('.notification'),
                themeToggle: document.querySelector('.theme-toggle'),
                // API Selectors
                modelSelectorButton: document.getElementById('model-selector-button'),
                modelOptionsList: document.getElementById('model-options'),
                apiModeSelectorButton: document.getElementById('api-mode-selector-button'),
                apiModeOptionsList: document.getElementById('api-mode-options'),
                // API Key Modal
                apiKeyModal: document.getElementById('api-key-modal-overlay'),
                apiKeyInput: document.getElementById('api-key-input'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                apiKeyModalTitle: document.getElementById('api-key-modal-title'),
                apiKeyModalText: document.getElementById('api-key-modal-text'),
                apiKeyModalLink: document.getElementById('api-key-modal-link'),
            };

            this.config = {
                // API Proxies
                VERCEL_PROXY_BASE_URL: "https://ver-olive-delta.vercel.app",
                MAPRUAPP_PROXY_BASE_URL: "https://mapruapp.ru",

                // Models Configuration
                MODELS: [
                    { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini" },
                    { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini" },
                    { id: "magistral-medium-2506", uiName: "Mistral Magistral", apiType: "mistral" },
                ],
                
                // API Modes Configuration
                API_MODES: {
                    'mapruapp': { uiName: '–ü—Ä–æ–∫—Å–∏ (mapruapp)', icon: '<i class="fas fa-server fa-fw"></i>' },
                    'vercel': { uiName: '–ü—Ä–æ–∫—Å–∏ (vercel)', icon: '<i class="fas fa-cloud fa-fw"></i>' },
                    'direct_gemini': { uiName: '–ü—Ä—è–º–æ–π (Gemini)', icon: '<i class="fas fa-key fa-fw"></i>' },
                    'direct_mistral': { uiName: '–ü—Ä—è–º–æ–π (Mistral)', icon: '<i class="fas fa-key fa-fw"></i>' },
                },

                // Prompts
                PROMPTS: {
                    ROLES: {
                        deloproizvoditel: "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –¥–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, –º–∞—Å—Ç–µ—Ä—Å–∫–∏ –≤–ª–∞–¥–µ—é—â–∏–π –ì–û–°–¢–∞–º–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
                        general_jurist: "–¢—ã ‚Äî –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç —Å —à–∏—Ä–æ–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π, —Å–ø–æ—Å–æ–±–Ω—ã–π —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã.",
                        hr_specialist: "–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–∞–º, –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –∑–Ω–∞—é—â–∏–π —Ç—Ä—É–¥–æ–≤–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∏ –∫–∞–¥—Ä–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç.",
                        accountant: "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö.",
                        real_estate: "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏, –∞—Ä–µ–Ω–¥—ã –∏ –¥—Ä—É–≥–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –æ–±–æ—Ä–æ—Ç–æ–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.",
                    },
                    SYSTEM_PROMPT: "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –¢–û–õ–¨–ö–û –≤ –≤–∏–¥–µ –æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ, —Ü–µ–ª—å–Ω–æ–≥–æ, —Ö–æ—Ä–æ—à–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ HTML –±–ª–æ–∫–∞ `<div class='document-content'>...</div>`. –í–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏: `<h1>` –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞, `<h2>` –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤, `<p>` –¥–ª—è –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤, `<table>` –¥–ª—è —Ç–∞–±–ª–∏—Ü, `<ul>`/`<ol>` –¥–ª—è —Å–ø–∏—Å–∫–æ–≤. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–≥–∏ `<html>`, `<body>`, `<head>`. –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏–ª–∏ markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ (```html) –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ HTML-–±–ª–æ–∫–∞. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `<div` –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è `</div>`.",
                    TASKS: {
                        create: "–°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é:",
                        refine: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –º–æ–∏–º —É–∫–∞–∑–∞–Ω–∏—è–º:"
                    },
                    DETAIL_LEVELS: {
                        short: "–°–¥–µ–ª–∞–π –¥–æ–∫—É–º–µ–Ω—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–∏–º, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å.",
                        standard: "–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–ª—è —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞.",
                        detailed: "–°–¥–µ–ª–∞–π –¥–æ–∫—É–º–µ–Ω—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–º, –≤–∫–ª—é—á–∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã, –æ–≥–æ–≤–æ—Ä–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã."
                    }
                }
            };
            
            this.state = {
                // UI State
                isGenerating: false,
                isDarkTheme: true,
                // Form State
                selectedMode: 'create',
                selectedRole: 'deloproizvoditel',
                selectedDetail: 'standard',
                // API State
                currentModelId: this.config.MODELS[0].id,
                currentApiMode: 'mapruapp',
                geminiApiKey: null,
                mistralApiKey: null,
            };

            this.init();
        }

        init() {
            this.loadStateFromStorage();
            this.bindEvents();
            this.updateTheme();
            this.populateModelOptions();
            this.populateApiModeOptions();
            this.updateApiModeUI();
            this.updateModelUI();
        }
        
        loadStateFromStorage() {
            this.state.isDarkTheme = localStorage.getItem('docgen_theme') === 'true';
            this.state.currentModelId = localStorage.getItem('docgen_model') || this.config.MODELS[0].id;
            this.state.currentApiMode = localStorage.getItem('docgen_apimode') || 'mapruapp';
            this.state.geminiApiKey = localStorage.getItem('docgen_gemini_key');
            this.state.mistralApiKey = localStorage.getItem('docgen_mistral_key');
        }

        bindEvents() {
            // Form Controls
            this.elements.generateBtn.addEventListener('click', () => this.generateDocument());
            this.elements.modeSelector.addEventListener('click', e => this.handleModeSelection(e, 'selectedMode', this.elements.modeSelector));
            this.elements.detailSelector.addEventListener('click', e => this.handleModeSelection(e, 'selectedDetail', this.elements.detailSelector));
            this.elements.roleSelector.addEventListener('change', e => { this.state.selectedRole = e.target.value; });
            
            // Preview Actions
            this.elements.savePdfBtn.addEventListener('click', () => window.print());
            this.elements.saveHtmlBtn.addEventListener('click', () => this.saveAsHtml());

            // Header Controls
            this.elements.themeToggle.addEventListener('click', () => {
                this.state.isDarkTheme = !this.state.isDarkTheme;
                localStorage.setItem('docgen_theme', this.state.isDarkTheme);
                this.updateTheme();
            });
            
            // API Selectors
            this.elements.modelSelectorButton.addEventListener('click', e => { e.stopPropagation(); this.elements.modelOptionsList.classList.toggle('show'); });
            this.elements.apiModeSelectorButton.addEventListener('click', e => { e.stopPropagation(); this.elements.apiModeOptionsList.classList.toggle('show'); });
            document.addEventListener('click', () => {
                this.elements.modelOptionsList.classList.remove('show');
                this.elements.apiModeOptionsList.classList.remove('show');
            });
            
            // API Key Modal
            this.elements.saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
            this.elements.apiKeyModal.addEventListener('click', e => { if (e.target === this.elements.apiKeyModal) this.hideApiKeyModal(); });
        }
        
        // --- UI Update Methods ---
        
        updateTheme() {
            document.body.classList.toggle('dark-theme', this.state.isDarkTheme);
        }

        handleModeSelection(event, stateKey, container) {
            const button = event.target.closest('.mode-btn');
            if (!button) return;
            this.state[stateKey] = button.dataset.mode || button.dataset.level;
            container.querySelector('.active')?.classList.remove('active');
            button.classList.add('active');
        }
        
        setLoadingState(loading) {
            this.state.isGenerating = loading;
            this.elements.generateBtn.disabled = loading;
            if (loading) {
                this.elements.generateBtn.innerHTML = `<div class="spinner"></div><span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>`;
                this.elements.previewSection.style.display = 'block';
                this.elements.previewContainer.classList.add('loading');
                this.elements.previewContainer.innerHTML = `<div class="spinner" style="border-top-color: var(--primary-color);"></div>`;
            } else {
                this.elements.generateBtn.innerHTML = `<i class="fas fa-wand-magic-sparkles"></i><span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>`;
                this.elements.previewContainer.classList.remove('loading');
            }
        }

        showNotification(message, isError = false) {
            this.elements.notification.textContent = message;
            this.elements.notification.className = `notification ${isError ? 'error' : ''}`;
            this.elements.notification.classList.add('show');
            setTimeout(() => this.elements.notification.classList.remove('show'), 4000);
        }

        // --- API & Model Selection Logic ---

        populateModelOptions() {
            this.elements.modelOptionsList.innerHTML = '';
            this.config.MODELS.forEach(model => {
                const li = document.createElement('li');
                li.className = 'selector-option';
                li.dataset.modelId = model.id;
                li.innerHTML = `<span>${model.uiName}</span>`;
                li.addEventListener('click', () => {
                    this.state.currentModelId = model.id;
                    localStorage.setItem('docgen_model', model.id);
                    this.updateModelUI();
                    this.elements.modelOptionsList.classList.remove('show');
                });
                this.elements.modelOptionsList.appendChild(li);
            });
        }
        
        populateApiModeOptions() {
            this.elements.apiModeOptionsList.innerHTML = '';
            Object.entries(this.config.API_MODES).forEach(([modeId, modeConfig]) => {
                const li = document.createElement('li');
                li.className = 'selector-option';
                li.dataset.apiMode = modeId;
                li.innerHTML = `${modeConfig.icon} <span>${modeConfig.uiName}</span>`;
                li.addEventListener('click', () => {
                    this.state.currentApiMode = modeId;
                    localStorage.setItem('docgen_apimode', modeId);
                    this.updateApiModeUI();
                    this.elements.apiModeOptionsList.classList.remove('show');
                    if (modeId.startsWith('direct_') && !this.getApiKeyForCurrentMode()) {
                        this.showApiKeyModal();
                    }
                });
                this.elements.apiModeOptionsList.appendChild(li);
            });
        }

        updateModelUI() {
            const model = this.config.MODELS.find(m => m.id === this.state.currentModelId);
            this.elements.modelSelectorButton.innerHTML = `<span>${model.uiName}</span><i class="fas fa-chevron-down fa-xs"></i>`;
            this.elements.modelOptionsList.querySelectorAll('.selector-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.modelId === this.state.currentModelId);
            });
        }

        updateApiModeUI() {
            const modeConfig = this.config.API_MODES[this.state.currentApiMode];
            this.elements.apiModeSelectorButton.innerHTML = `${modeConfig.icon} <span>${modeConfig.uiName}</span>`;
            this.elements.apiModeOptionsList.querySelectorAll('.selector-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.apiMode === this.state.currentApiMode);
            });
        }
        
        // --- API Key Modal Logic ---
        
        showApiKeyModal() {
            const isMistral = this.state.currentApiMode === 'direct_mistral';
            this.elements.apiKeyModalTitle.textContent = isMistral ? 'API –ö–ª—é—á Mistral' : 'API –ö–ª—é—á Gemini';
            this.elements.apiKeyModalText.textContent = `–î–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω—É–∂–µ–Ω –≤–∞—à API –∫–ª—é—á. –û–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.`;
            this.elements.apiKeyModalLink.href = isMistral ? 'https://console.mistral.ai/api-keys/' : 'https://aistudio.google.com/app/apikey';
            this.elements.apiKeyInput.value = isMistral ? (this.state.mistralApiKey || '') : (this.state.geminiApiKey || '');
            this.elements.apiKeyModal.style.display = 'flex';
            this.elements.apiKeyInput.focus();
        }

        hideApiKeyModal() { this.elements.apiKeyModal.style.display = 'none'; }
        
        saveApiKey() {
            const key = this.elements.apiKeyInput.value.trim();
            const isMistral = this.state.currentApiMode === 'direct_mistral';
            if (isMistral) {
                this.state.mistralApiKey = key;
                localStorage.setItem('docgen_mistral_key', key);
            } else {
                this.state.geminiApiKey = key;
                localStorage.setItem('docgen_gemini_key', key);
            }
            this.showNotification('API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
            this.hideApiKeyModal();
        }

        getApiKeyForCurrentMode() {
            if (this.state.currentApiMode === 'direct_gemini') return this.state.geminiApiKey;
            if (this.state.currentApiMode === 'direct_mistral') return this.state.mistralApiKey;
            return null;
        }

        // --- Core Generation Logic ---

        buildPrompt() {
            const { ROLES, SYSTEM_PROMPT, TASKS, DETAIL_LEVELS } = this.config.PROMPTS;
            const role_prompt = ROLES[this.state.selectedRole];
            const task_prompt = TASKS[this.state.selectedMode];
            const detail_prompt = DETAIL_LEVELS[this.state.selectedDetail];
            const user_text = this.elements.queryInput.value;
            
            const full_user_prompt = `${task_prompt}\n\n${detail_prompt}\n\n–ó–∞–ø—Ä–æ—Å: "${user_text}"`;
            const full_system_prompt = `${role_prompt}\n${SYSTEM_PROMPT}`;
            
            return { system: full_system_prompt, user: full_user_prompt };
        }
        
        async generateDocument() {
            const userQuery = this.elements.queryInput.value.trim();
            if (!userQuery) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç.', true);
                return;
            }

            if (this.state.currentApiMode.startsWith('direct_') && !this.getApiKeyForCurrentMode()) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞.', true);
                this.showApiKeyModal();
                return;
            }

            this.setLoadingState(true);
            
            const { system, user } = this.buildPrompt();
            const messages = [
                { role: 'system', content: system },
                { role: 'user', content: user }
            ];

            try {
                const response = await this.callApi(messages);
                this.elements.previewContainer.innerHTML = response;
            } catch (error) {
                this.elements.previewContainer.innerHTML = `<p class="placeholder" style="color: var(--error-color);"><b>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</b><br>${error.message}</p>`;
                this.showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, true);
                console.error(error);
            } finally {
                this.setLoadingState(false);
            }
        }
        
        async callApi(messages) {
            const modelConfig = this.config.MODELS.find(m => m.id === this.state.currentModelId);
            let url, body, headers = { 'Content-Type': 'application/json' };

            switch(this.state.currentApiMode) {
                case 'mapruapp':
                    url = `${this.config.MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                    body = { model: modelConfig.id, messages: messages, max_tokens: 4096 };
                    break;
                case 'vercel':
                    url = `${this.config.VERCEL_PROXY_BASE_URL}/proxy/mistral/chat/completions`;
                    body = { model: modelConfig.id, messages: messages, max_tokens: 4096 };
                    break;
                case 'direct_gemini':
                    url = `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.id}:generateContent?key=${this.state.geminiApiKey}`;
                    body = { contents: [{ role: 'user', parts: [{text: messages[0].content + '\n' + messages[1].content }] }] };
                    break;
                case 'direct_mistral':
                    url = `https://api.mistral.ai/v1/chat/completions`;
                    headers['Authorization'] = `Bearer ${this.state.mistralApiKey}`;
                    body = { model: modelConfig.id, messages: messages, max_tokens: 4096 };
                    break;
                default:
                    throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º API");
            }

            const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data?.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            // Extract text based on API response structure
            if (this.state.currentApiMode === 'direct_gemini') {
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            } else {
                return data.choices?.[0]?.message?.content || '';
            }
        }

        // --- Save Functionality ---

        saveAsHtml() {
            const content = this.elements.previewContainer.innerHTML;
            if (!content || content.includes('placeholder')) {
                this.showNotification("–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.", true);
                return;
            }
            const title = this.elements.previewContainer.querySelector('h1')?.textContent || 'document';
            const cleanTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            
            const htmlTemplate = `
                <!DOCTYPE html>
                <html lang="ru">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
                        h1, h2, h3 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin: 1em 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            const blob = new Blob([htmlTemplate], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cleanTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new DocumentGenerator();
    });
    </script>
</body>
</html>
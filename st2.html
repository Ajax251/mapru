<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî¨</text></svg>">
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-color: #333;
        --primary-color: #007bff;
        --primary-color-dark: #0056b3;
        --secondary-text-color: #555;
        --border-color: #e0e6ec;
        --danger-color: #dc3545;
        --danger-bg-color: #f8d7da;
        --print-color: #28a745;
        --print-dark-color: #218838;
        --new-chat-color: #FFA500;
        --new-chat-dark-color: #E86100;
        --settings-color-proxy-lite: #007bff;
        --settings-color-proxy-standard: #0056b3;
        --settings-color-direct-lite: #FFA500;
        --settings-color-direct-standard: #dc3545;
        --settings-color-claude: #28a745;
    }
    html, body {
        height: 100%; margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    .app-container {
        display: flex; flex-direction: column;
        height: 100dvh;
        background-color: var(--card-bg-color);
    }
    .app-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 25px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .app-header h1 {
        grid-column: 2 / 3;
        margin: 0; font-size: 24px; font-weight: 500;
        color: var(--primary-color);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .header-right-controls {
        grid-column: 3 / 4;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative;
    }
    .app-header h1 i { margin-right: 12px; }

    #settings-btn {
        background: transparent;
        border: 1px solid transparent;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--primary-color);
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    #settings-btn:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }

    .header-right-controls-movable { display: none; }
    
    .api-mode-selector-container { position: relative; width: 100%; }
    #api-mode-selector-button {
        width: 100%;
        padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; background-color: white;
        cursor: pointer; transition: all 0.2s ease; font-size: 16px;
        color: var(--text-color); display: flex; align-items: center; gap: 10px;
        text-align: left;
    }
    #api-mode-selector-button:hover { border-color: var(--primary-color); }
    #api-mode-selector-button .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    #api-mode-selector-button .text { flex-grow: 1; }
    #api-mode-selector-button::after {
        content: ''; width: 8px; height: 8px;
        border-right: 2px solid var(--secondary-text-color);
        border-bottom: 2px solid var(--secondary-text-color);
        transform: rotate(45deg); margin-left: auto;
    }
    #api-mode-options {
        position: absolute; list-style: none; padding: 0; margin: 5px 0 0 0;
        background-color: white; border: 1px solid var(--border-color);
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%; z-index: 1011; display: none;
    }
    .api-mode-option {
        padding: 12px 15px; cursor: pointer; display: flex;
        align-items: center; gap: 10px; font-size: 16px;
    }
    .api-mode-option:hover { background-color: var(--bg-color); }
    .api-mode-option .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    .api-mode-option.selected { font-weight: 500; background-color: #eaf4ff; }
    
    .response-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .response-actions {
        padding: 10px 25px; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color);
        display: none; gap: 10px; flex-shrink: 0; align-items: center;
    }
    .action-btn {
        padding: 8px 15px; border-radius: 5px; cursor: pointer;
        font-size: 14px; font-weight: 500; color: white; transition: all 0.2s ease; border: none;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn i { margin-right: 8px; }
    #copy-btn { background-color: var(--primary-color); }
    #copy-btn:hover { background-color: var(--primary-color-dark); }
    #print-btn { background-color: var(--print-color); }
    #print-btn:hover { background-color: var(--print-dark-color); }
    #new-chat-btn { background-color: var(--new-chat-color); margin-left: auto; }
    #new-chat-btn:hover { background-color: var(--new-chat-dark-color); }
    .response-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .welcome-message { text-align: center; color: var(--secondary-text-color); padding-top: 15vh; animation: fadeInUp 0.5s ease forwards; }
    .welcome-message i { font-size: 48px; margin-bottom: 20px; color: var(--primary-color); opacity: 0.8; }
    .welcome-message h2 { font-weight: 500; font-size: 22px; color: var(--text-color); margin-bottom: 10px; }
    .welcome-message p { font-size: 16px; line-height: 1.6; }
    
    #ai-response { line-height: 1.7; font-size: 16px; }
    #ai-response h1, #ai-response h2, #ai-response h3 {
        font-weight: 500; color: var(--text-color); margin-top: 30px; margin-bottom: 15px;
        padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    #ai-response h1 { font-size: 22px; text-align: center; border-bottom: 2px solid var(--primary-color); }
    #ai-response h2 { font-size: 20px; }
    #ai-response h3 { font-size: 18px; }
    #ai-response ul, #ai-response ol { padding-left: 25px; }
    #ai-response li { margin-bottom: 8px; }
    #ai-response strong { color: var(--primary-color-dark); font-weight: 500; }
    #ai-response hr { border: none; border-top: 3px dotted #ced4da; margin: 40px 20%; }
    #ai-response table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    #ai-response th, #ai-response td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
    #ai-response th { background-color: #f8f9fa; font-weight: 500; }
    #ai-response .disclaimer {
        display: block; background-color: #fffbe6; border: 1px solid #ffe58f; color: #d46b08;
        padding: 15px; border-radius: 8px; font-size: 15px; line-height: 1.6; margin-top: 30px;
        text-align: left; font-weight: 500 !important;
    }

    .loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
    .loader p { margin-top: 20px; color: var(--secondary-text-color); font-size: 16px; }
    #cancel-btn { margin-top: 15px; background-color: var(--new-chat-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    #cancel-btn:hover { background-color: var(--new-chat-dark-color); }
    .loader .loader-icon { font-size: 64px; color: var(--primary-color); opacity: 0.8; margin-bottom: 10px; animation: pulse-loader 2s ease-in-out infinite;}
    @keyframes pulse-loader { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    .input-panel { display: flex; padding: 15px 25px; gap: 15px; border-top: 1px solid var(--border-color); background-color: #f8f9fa; flex-shrink: 0; align-items: center; }
    #user-query {
        flex-grow: 1; padding: 12px 15px; font-size: 16px; font-family: 'Roboto', sans-serif; border-radius: 22px;
        border: 1px solid var(--border-color); resize: none; height: 24px; line-height: 24px; transition: all 0.2s ease; max-height: 200px;
    }
    #user-query:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    #send-btn {
        flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: none; background-color: var(--primary-color);
        color: white; font-size: 20px; cursor: pointer; transition: all 0.2s ease;
        display: flex; align-items: center; justify-content: center;
    }
    #send-btn:hover { background-color: var(--primary-color-dark); }
    #user-query:disabled, #send-btn:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px;
        display: flex; flex-direction: column;
    }
    .modal-content h2 { margin-top: 0; color: var(--primary-color); text-align: center;}
    .modal-content p { color: var(--secondary-text-color); line-height: 1.6; text-align: center;}
    .modal-content a { color: var(--primary-color-dark); text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }

    .settings-controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .settings-control-group { text-align: left; }
    .settings-control-group label { display: block; margin-bottom: 8px; color: var(--secondary-text-color); font-size: 14px; }
    .settings-control-group select, .settings-control-group input[type="password"] {
        width: 100%; padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; font-size: 16px; box-sizing: border-box;
    }
    #api-key-input-group { display: none; }
    #save-settings-btn {
        margin-top: 25px; width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s;
    }
    #save-settings-btn:hover { background-color: var(--primary-color-dark); }


@media print {
    .app-header, .input-panel, .response-actions, #settings-btn {
        display: none !important;
    }
    body, .app-container {
        background-color: #ffffff !important; box-shadow: none !important;
        height: auto !important; overflow: visible !important; color: #000000 !important;
    }
    .response-area, .response-wrapper {
        height: auto !important; overflow: visible !important; display: block !important;
        padding: 0 !important; flex-grow: 0 !important;
    }
    #ai-response { line-height: 1.4; font-size: 12pt; }
    #ai-response table { box-shadow: none !important; page-break-inside: auto; }
    #ai-response tr { page-break-inside: avoid; }
}

@media (max-width: 768px) {
    .app-header { grid-template-columns: auto 1fr auto; gap: 10px; padding: 10px 15px; }
    .app-header h1 { grid-column: 2 / 3; font-size: 20px; }
    .header-right-controls { grid-column: 3 / 4; }
    .response-wrapper, .input-panel, .response-actions { padding: 15px; }
    .welcome-message { padding-top: 10vh; }
    #ai-response { font-size: 15px; }
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ --- */
.extracted-links-container {
    margin-top: 40px;
    border-top: 2px solid var(--border-color);
    padding-top: 20px;
}
.extracted-links-container summary {
    cursor: pointer;
    font-weight: 500;
    font-size: 18px;
    color: var(--primary-color);
    transition: color 0.2s ease;
}
.extracted-links-container summary:hover {
    color: var(--primary-color-dark);
}
.extracted-links-container ul {
    margin-top: 15px;
    padding-left: 0;
    list-style-type: none;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    background-color: #fdfdfd;
}
html[dark-theme] .extracted-links-container ul { /* –î–ª—è –±—É–¥—É—â–µ–π —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    background-color: #1a2b41;
}
.extracted-links-container li {
    margin-bottom: 8px;
    font-size: 14px;
    word-break: break-all;
}
.extracted-links-container li a {
    color: var(--secondary-text-color);
    text-decoration: none;
}
.extracted-links-container li a:hover {
    text-decoration: underline;
    color: var(--primary-color);
}
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left"></div>
            <h1><i class="fa-solid fa-magnifying-glass-chart"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫</h1>
            <div class="header-right-controls">
                <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <i class="fas fa-cog"></i>
                    <i class="fas fa-key" style="display: none;"></i>
                </button>
            </div>
        </header>

        <div class="header-right-controls-movable">
             <div class="api-mode-selector-container">
                <button id="api-mode-selector-button"></button>
                <ul id="api-mode-options"></ul>
            </div>
        </div>

        <main class="response-area">
            <div class="response-actions" id="response-actions">
                <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i>–ü–µ—á–∞—Ç—å</button>
                <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus-circle"></i>–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</button>
            </div>
            <div class="response-wrapper" id="response-wrapper">
                <div id="ai-response"></div>
            </div>
        </main>

        <div class="input-panel">
            <textarea id="user-query" placeholder="–í–≤–µ–¥–∏—Ç–µ URL —Å–∞–π—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–∞–º–º–∞—Ä–∏..." rows="1"></textarea>
            <button id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>


    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
            <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –∏ —Ä–µ–∂–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –î–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞ "Gemini" —Ç—Ä–µ–±—É–µ—Ç—Å—è API-–∫–ª—é—á.</p>
            <div class="settings-controls-wrapper">
                <div class="settings-control-group">
                    <label for="model-selector">1. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</label>
                    <select id="model-selector">
                        <option value="gemini-2.5-flash" data-api-type="gemini">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-flash-lite-preview-06-17" data-api-type="gemini" selected>Gemini 2.5 Flash Lite</option>
                        <option value="claude-3-7-sonnet-20250219" data-api-type="anthropic">Claude 3.7 Sonnet</option>
                    </select>
                </div>
                <div class="settings-control-group">
                    <label>2. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                    <div id="modal-api-controls-placeholder"></div>
                </div>
                <div class="settings-control-group" id="api-key-input-group">
                    <label for="api-key-input">3. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á Gemini</label>
                    <input type="password" id="api-key-input" placeholder="–í–∞—à –∫–ª—é—á...">
                     <small style="display: block; margin-top: 5px; color: #777;">–ö–ª—é—á –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a></small>
                </div>
            </div>
            <button id="save-settings-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
<script>
window.addEventListener('load', () => {
    // --- CONFIGURATION ---
    const LINK_EXTRACTOR_API_BASE = "https://linkextractor.vercel.app";
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
    const DEFAULT_MODEL_ID = "gemini-2.5-flash-lite-preview-06-17";

    // --- SYSTEM PROMPT ---
    const AI_SYSTEM_PROMPT_ANALYST = `–¢—ã ‚Äî "–ê–Ω–∞–ª–∏—Ç–∏–∫", –ò–ò-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é, –∞–Ω–∞–ª–∏–∑—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü –∏ —Ç–µ–∫—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —á–µ—Ç–∫–∏–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç—á–µ—Ç.

### **–ê–õ–ì–û–†–ò–¢–ú –†–ê–ë–û–¢–´:**

1.  **–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.**

2.  **–ï–°–õ–ò –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞–Ω HTML-–∫–æ–¥ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
    *   **–®–∞–≥ 1. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:** –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: –Ω–æ–≤–æ—Å—Ç–Ω–∞—è —Å—Ç–∞—Ç—å—è, –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–º–ø–∞–Ω–∏–∏, –∑–∞–ø–∏—Å—å –≤ –±–ª–æ–≥–µ, –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞, —Ñ–æ—Ä—É–º –∏ —Ç.–¥.).
    *   **–®–∞–≥ 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—Ç–∏:** –ù–∞–π–¥–∏ –∏ –∏–∑–≤–ª–µ–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–º—ã—Å–ª–æ–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞), **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É—è** –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ–Ω—é, —Ä–µ–∫–ª–∞–º–Ω—ã–µ –±–ª–æ–∫–∏, –±–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏, –ø–æ–¥–≤–∞–ª—ã —Å–∞–π—Ç–∞ (—Ñ—É—Ç–µ—Ä—ã) –∏ –ø—Ä–æ—á–∏–π —Å–ª—É–∂–µ–±–Ω—ã–π "—à—É–º".
    *   **–®–∞–≥ 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—å–µ:** –ù–∞ –æ—Å–Ω–æ–≤–µ –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ —á–∏—Å—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –¥–æ—Å—å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ, —á–µ—Å—Ç–Ω–æ —É–∫–∞–∑—ã–≤–∞–π "–ù–µ –Ω–∞–π–¥–µ–Ω–æ".
    *   **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è HTML:**
        # üìú –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: [–ò–∑–≤–ª–µ–∫–∏ –∏ –≤—Å—Ç–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ —Ç–µ–≥–∞ <title> –∏–ª–∏ <h1>]

        ### üéØ –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
        *   **–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã:** [–¢–≤–æ–π –≤—ã–≤–æ–¥ –æ —Ç–∏–ø–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã]
        *   **–û—Å–Ω–æ–≤–Ω–∞—è –º—ã—Å–ª—å:** [–í 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö, –æ —á–µ–º —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞]

        ### üîë –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
        [–ü—Ä–µ–¥—Å—Ç–∞–≤—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–∏, —Ñ–∞–∫—Ç—ã, –≤—ã–≤–æ–¥—ã –∏–ª–∏ —ç—Ç–∞–ø—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –≤–∏–¥–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ–º–∫–∏–º –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.]

        ### üë§ –ê–≤—Ç–æ—Ä –∏ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        *   **–ê–≤—Ç–æ—Ä:** [–ò–º—è –∞–≤—Ç–æ—Ä–∞, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ –∏–ª–∏ –º–µ—Ç–∞-—Ç–µ–≥–∞—Ö]
        *   **–î–∞—Ç–∞:** [–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞]

        *(–ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –≤–∞–∂–Ω—ã–µ —Å–ø–∏—Å–∫–∏, —Å–æ—Ö—Ä–∞–Ω–∏ –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ)*

3.  **–ï–°–õ–ò –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞–Ω –æ–±—ã—á–Ω—ã–π –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç:**
    *   **–®–∞–≥ 1. –ì–ª—É–±–æ–∫–æ–µ —á—Ç–µ–Ω–∏–µ:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –µ–≥–æ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É, –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
    *   **–®–∞–≥ 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∞–º–º–∞—Ä–∏:** –°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è —Ç–∞–±–ª–∏—Ü—É** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏.
    *   **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¢–ï–ö–°–¢–ê:**
        # üìä –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞

        ### üìù –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
        [–í 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö –∏–∑–ª–æ–∂–∏ –≥–ª–∞–≤–Ω—É—é —Å—É—Ç—å –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.]

        ---

        ### üìã –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä
        | –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ / –†–∞–∑–¥–µ–ª | –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã | –ì–ª–∞–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –ø–æ —Ä–∞–∑–¥–µ–ª—É |
        |---|---|---|
        | **[–û–ø—Ä–µ–¥–µ–ª–∏ –∏ –Ω–∞–∑–æ–≤–∏ –ø–µ—Ä–≤—É—é —Ç–µ–º—É]** | [–í—ã–¥–µ–ª–∏ 2-3 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏–ª–∏ —Ñ–∞–∫—Ç–∞ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ] | [–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –∏–ª–∏ –∏—Ç–æ–≥ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞] |
        | **[–û–ø—Ä–µ–¥–µ–ª–∏ –∏ –Ω–∞–∑–æ–≤–∏ –≤—Ç–æ—Ä—É—é —Ç–µ–º—É]** | [–í—ã–¥–µ–ª–∏ 2-3 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏–ª–∏ —Ñ–∞–∫—Ç–∞ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ] | [–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –∏–ª–∏ –∏—Ç–æ–≥ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞] |
        | *(–ü—Ä–æ–¥–æ–ª–∂–∞–π, –ø–æ–∫–∞ –Ω–µ —Ä–∞–∑–±–µ—Ä–µ—à—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞)* | | |
    
        ### üèÅ –û–±—â–∏–π –≤—ã–≤–æ–¥
        [–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥ –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –µ–≥–æ —á–∞—Å—Ç–µ–π.]

---

**–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê, –ö–û–¢–û–†–´–ï –ù–ï–õ–¨–ó–Ø –ù–ê–†–£–®–ê–¢–¨:**
*   **–ê–ë–°–û–õ–Æ–¢–ù–ê–Ø –¢–û–ß–ù–û–°–¢–¨:** –ù–µ –¥–æ–¥—É–º—ã–≤–∞–π, –Ω–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π –∏ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –ø–∏—à–∏ "–ù–µ –Ω–∞–π–¥–µ–Ω–æ" –∏–ª–∏ "–ù–µ —É–∫–∞–∑–∞–Ω–æ".
*   **–Ø–ó–´–ö:** –û—Ç–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ.
*   **–ë–ï–ó –°–°–´–õ–û–ö:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π URL –∏–ª–∏ –≤–µ–±-—Å—Å—ã–ª–∫–∏ –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ.
*   **–§–û–ö–£–° –ù–ê –ö–û–ù–¢–ï–ù–¢–ï:** –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ HTML –∏–≥–Ω–æ—Ä–∏—Ä—É–π —Å–∞–º –∫–æ–¥ (—Ç–µ–≥–∏, —Å–∫—Ä–∏–ø—Ç—ã) –∏ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—Å—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.`;


    const MODELS = [
        { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini", tier: 'standard' },
        { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
        { id: "claude-3-7-sonnet-20250219", uiName: "Claude 3.7 Sonnet", apiType: "anthropic", tier: 'standard' },
    ];

    // --- DOM ELEMENTS ---
    const queryInput = document.getElementById('user-query');
    const sendButton = document.getElementById('send-btn');
    const responseContainer = document.getElementById('ai-response');
    const responseActions = document.getElementById('response-actions');
    const copyButton = document.getElementById('copy-btn');
    const printButton = document.getElementById('print-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModalOverlay = document.getElementById('settings-modal-overlay');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    const apiKeyInputGroup = document.getElementById('api-key-input-group');
    const modelSelector = document.getElementById('model-selector');
    const apiModeSelectorButton = document.getElementById('api-mode-selector-button');
    const apiModeOptions = document.getElementById('api-mode-options');
    const modalApiControlsPlaceholder = document.getElementById('modal-api-controls-placeholder');
    const originalApiControlsParent = document.querySelector('.header-right-controls-movable');

    // --- STATE VARIABLES ---
    let apiKey = null;
    let currentApiMode = 'mapruapp'; // Default to mapruapp
    let currentModelId = DEFAULT_MODEL_ID;
    let currentApiType = "gemini";
    let isLoading = false;
    let controller = null;
    let conversationHistory = [];
    let lastExtractedLinks = []; 
    
    const welcomeMessageHTML = `<div class="welcome-message"><i class="fa-solid fa-file-import"></i><h2>–ì–æ—Ç–æ–≤ –∫ –∞–Ω–∞–ª–∏–∑—É</h2><p>–í—Å—Ç–∞–≤—å—Ç–µ URL-–∞–¥—Ä–µ—Å —Å–∞–π—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—å–µ –Ω–∞ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ,<br>–∏–ª–∏ –±–æ–ª—å—à–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∞–º–º–∞—Ä–∏.</p></div>`;

    // --- CORE FUNCTIONS ---

    const initializeApp = () => {
        const renderer = new marked.Renderer();
        renderer.link = (href, title, text) => `<a href="${href}" title="${title}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        marked.setOptions({ renderer, sanitize: false, gfm: true });

        loadSettings();
        startNewAnalysis();

        sendButton.addEventListener('click', handleRequest);
        queryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } });
        copyButton.addEventListener('click', copyResponse);
        printButton.addEventListener('click', printResponse);
        newChatBtn.addEventListener('click', startNewAnalysis);
        
        settingsBtn.addEventListener('click', openSettingsModal);
        saveSettingsBtn.addEventListener('click', saveSettings);
        settingsModalOverlay.addEventListener('click', (e) => { if (e.target === settingsModalOverlay) closeSettingsModal(); });

        populateApiModeOptions();
        modelSelector.addEventListener('change', () => {
            const selectedOption = modelSelector.options[modelSelector.selectedIndex];
            currentModelId = selectedOption.value;
            currentApiType = selectedOption.dataset.apiType;
            updateSettingsUI();
        });
        
        apiModeSelectorButton.addEventListener('click', (e) => {
             e.stopPropagation();
             apiModeOptions.style.display = apiModeOptions.style.display === 'block' ? 'none' : 'block';
        });
        
        document.addEventListener('click', (event) => {
            if (!apiModeSelectorButton.contains(event.target) && !apiModeOptions.contains(event.target)) {
                apiModeOptions.style.display = 'none';
            }
        });

        queryInput.addEventListener('input', () => {
            queryInput.style.height = 'auto';
            const newHeight = Math.min(queryInput.scrollHeight, 200);
            queryInput.style.height = `${newHeight}px`;
        });
    };
    
const handleRequest = async () => {
    const userQuery = queryInput.value.trim();
    if (!userQuery || isLoading) return;

    if (currentApiType === 'gemini' && currentApiMode === 'direct' && !apiKey) {
        openSettingsModal();
        return;
    }

    isLoading = true;
    controller = new AbortController();
    lastExtractedLinks = []; // <<< –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    updateUIOnRequestStart();
    
    let finalPromptForAI = userQuery;
    
    const urlPattern = new RegExp('^(https?:\\/\\/)?'+
        '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+
        '((\\d{1,3}\\.){3}\\d{1,3}))'+
        '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+
        '(\\?[;&a-z\\d%_.~+=-]*)?'+
        '(\\#[-a-z\\d_]*)?$','i');

    try {
        if (urlPattern.test(userQuery)) {
            responseContainer.innerHTML = getLoaderHTML('–ò–∑–≤–ª–µ–∫–∞—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const pageData = await fetchPageSource(userQuery);
            finalPromptForAI = pageData.sourceHtml;
            lastExtractedLinks = pageData.links; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏
        }
        
        responseContainer.innerHTML = getLoaderHTML('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...');
        
        conversationHistory.push({ role: 'user', content: finalPromptForAI });
        
        const aiResponseText = await getAIResponse();

        conversationHistory.push({ role: 'model', content: aiResponseText });
        const finalHtml = marked.parse(aiResponseText);
        responseContainer.innerHTML = finalHtml;
        
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –ü–û–°–õ–ï –∞–Ω–∞–ª–∏–∑–∞
        displayExtractedLinks(lastExtractedLinks);

        responseActions.style.display = 'flex';

    } catch (error) {
        conversationHistory.pop();
        if (error.name !== 'AbortError') {
             responseContainer.innerHTML = getFriendlyErrorHTML(error.message, error.cause?.isKeyError);
        } else {
             responseContainer.innerHTML = getFriendlyErrorHTML("–ó–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω.");
        }
        responseActions.style.display = 'none';
    } finally {
        isLoading = false;
        controller = null;
        sendButton.disabled = false;
        queryInput.disabled = false;
    }
};
    
async function fetchPageSource(url) {
    const formData = new FormData();
    let fullUrl = url.startsWith('http://') || url.startsWith('https://') ? url : `http://${url}`;
    formData.append('url_input', fullUrl);
    
    const response = await fetch(`${LINK_EXTRACTOR_API_BASE}/extract-from-url/`, {
        method: 'POST',
        body: formData,
        signal: controller?.signal
    });

    if (!response.ok) {
        try {
            const errorData = await response.json();
            throw new Error(errorData.detail || `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É: ${response.statusText}`);
        } catch(e) {
             throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω. –°—Ç–∞—Ç—É—Å: ${response.status}`);
        }
    }
    
    const data = await response.json();
    if (!data.source_html) {
        throw new Error('–°–µ—Ä–≤–∏—Å –Ω–µ —Å–º–æ–≥ –∏–∑–≤–ª–µ—á—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –í–æ–∑–º–æ–∂–Ω–æ, —Å–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞.');
    }
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏
    return {
        sourceHtml: data.source_html,
        links: data.links || [] 
    };
}

function displayExtractedLinks(links) {
    if (!links || links.length === 0) return;

    const listItems = links.map(link => {
        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å HTML
        const safeLink = link.replace(/"/g, '"');
        return `<li><a href="${safeLink}" target="_blank" rel="noopener noreferrer">${safeLink}</a></li>`;
    }).join('');

    const linksHtml = `
        <div class="extracted-links-container">
            <details>
                <summary>üîç –ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (${links.length})</summary>
                <ul>${listItems}</ul>
            </details>
        </div>
    `;
    responseContainer.innerHTML += linksHtml;
}
    async function getAIResponse() {
        let apiUrl, requestBody;
        const fetchOptions = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal
        };
        
        const isMapruappProxy = currentApiMode === 'mapruapp';

        if (isMapruappProxy) {
            apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
            const messages = [
                { role: 'system', content: AI_SYSTEM_PROMPT_ANALYST },
                ...conversationHistory.map(msg => ({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content }))
            ];
            requestBody = { model: currentModelId, messages: messages, max_tokens: 4096 };
        } else { // Vercel Proxy or Direct
            if (currentApiType === 'gemini') {
                apiUrl = currentApiMode === 'direct' 
                    ? `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`
                    : `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                
                const geminiContents = conversationHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                }));
                // CORRECTED PAYLOAD STRUCTURE
                const systemInstruction = { parts: [{ text: AI_SYSTEM_PROMPT_ANALYST }] };
                requestBody = { contents: geminiContents, systemInstruction: systemInstruction };
            
            } else if (currentApiType === 'anthropic') {
                apiUrl = `${VERCEL_PROXY_BASE_URL}/proxy/langdock/anthropic/eu/v1/messages`;
                const claudeMessages = conversationHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content
                }));
                requestBody = { model: currentModelId, messages: claudeMessages, system: AI_SYSTEM_PROMPT_ANALYST, max_tokens: 4096 };
            }
        }
        
        fetchOptions.body = JSON.stringify(requestBody);
        const response = await fetch(apiUrl, fetchOptions);

        if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            let errorMessage = errorBody.error?.message || JSON.stringify(errorBody) || `HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`;
            const isKeyError = response.status === 400 && /API_KEY|INVALID_ARGUMENT/i.test(errorMessage.toUpperCase());
            throw new Error(errorMessage, { cause: { isKeyError } });
        }
        
        const data = await response.json();
        let aiResponseText = "";

        if (isMapruappProxy) {
             aiResponseText = data.choices?.[0]?.message?.content;
        } else if (currentApiType === 'gemini') {
            aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        } else if (currentApiType === 'anthropic') {
            aiResponseText = data.content?.[0]?.text;
        }

        if (!aiResponseText) {
            const reason = data.promptFeedback?.blockReason || '–û—Ç–≤–µ—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ø—É—Å—Ç.';
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`);
        }
        return aiResponseText;
    }

    // --- UI & STATE MANAGEMENT ---

const startNewAnalysis = () => {
    if (isLoading && controller) {
        controller.abort();
    }
    isLoading = false;
    controller = null;
    conversationHistory = [];
    lastExtractedLinks = []; // <<< –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£
    responseContainer.innerHTML = welcomeMessageHTML;
    responseActions.style.display = 'none';
    queryInput.value = '';
    queryInput.style.height = 'auto';
    queryInput.disabled = false;
    sendButton.disabled = false;
};

    const updateUIOnRequestStart = () => {
        queryInput.value = '';
        queryInput.style.height = 'auto';
        queryInput.disabled = true;
        sendButton.disabled = true;
        responseActions.style.display = 'none';
    };

    const getLoaderHTML = (text) => {
        const html = `<div class="loader"><i class="fa-solid fa-flask-vial loader-icon"></i><p>${text}</p><button id="cancel-btn">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>`;
        // We need to re-add the event listener every time the loader is created.
        setTimeout(() => {
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => { if(controller) controller.abort(); });
        }, 0);
        return html;
    };
    
    const getFriendlyErrorHTML = (errorMsg, isKeyError = false) => {
        let keyInfo = isKeyError ? `<p style="margin-top:10px;"><small>–ü–æ—Ö–æ–∂–µ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ API-–∫–ª—é—á–µ.</small></p>` : '';
        let buttonHTML = isKeyError
            ? `<button class="action-btn" id="check-settings-btn" style="background-color: var(--new-chat-color); margin-top: 20px;"><i class="fa-solid fa-key"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>`
            : `<button class="action-btn" id="retry-btn" style="background-color: var(--primary-color); margin-top: 20px;"><i class="fa-solid fa-rotate-right"></i> –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>`;
        
        setTimeout(() => {
            const checkSettingsBtn = document.getElementById('check-settings-btn');
            const retryBtn = document.getElementById('retry-btn');
            if (checkSettingsBtn) checkSettingsBtn.addEventListener('click', openSettingsModal);
            if (retryBtn) retryBtn.addEventListener('click', startNewAnalysis);
        }, 0);

        return `<div class="welcome-message" style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation fa-2x"></i><h3 style="color: var(--danger-color); border: none; margin-top:15px;">–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</h3><p>${errorMsg}</p>${keyInfo}${buttonHTML}</div>`;
    };

    // --- SETTINGS ---
    const API_MODES = {
        'mapruapp': { // RESTORED
            uiName: '–ü—Ä–æ–∫—Å–∏ (MapRuApp)',
            icon: '<i class="fa-solid fa-server icon"></i>'
        },
        'proxy': {
            uiName: '–ü—Ä–æ–∫—Å–∏ (Vercel)',
            icon: '<i class="fa-solid fa-cloud icon"></i>'
        },
        'direct': {
            uiName: '–ü—Ä—è–º–æ–π (Gemini)',
            icon: '<i class="fa-solid fa-key icon"></i>'
        }
    };
    
    const openSettingsModal = () => {
        const apiModeSelector = originalApiControlsParent.querySelector('.api-mode-selector-container');
        if (apiModeSelector) {
            modalApiControlsPlaceholder.appendChild(apiModeSelector);
        }
        settingsModalOverlay.style.display = 'flex';
    };

    const closeSettingsModal = () => {
        const apiModeSelector = modalApiControlsPlaceholder.querySelector('.api-mode-selector-container');
        if (apiModeSelector) {
            originalApiControlsParent.appendChild(apiModeSelector);
        }
        settingsModalOverlay.style.display = 'none';
    };

    const updateApiKeyInputVisibility = () => {
        apiKeyInputGroup.style.display = (currentApiMode === 'direct' && currentApiType === 'gemini') ? 'block' : 'none';
    };
    
    const updateSettingsUI = () => {
        const settingsBtn = document.getElementById('settings-btn');
        if (!settingsBtn) return;
        const cogIcon = settingsBtn.querySelector('.fa-cog');
        const keyIcon = settingsBtn.querySelector('.fa-key');

        const isDirect = currentApiMode === 'direct';
        const selectedModel = MODELS.find(m => m.id === currentModelId) || MODELS[0];
        
        let colorVar;
        if(currentApiType === 'anthropic') {
            colorVar = '--settings-color-claude';
        } else if (isDirect) {
            colorVar = selectedModel.tier === 'standard' ? '--settings-color-direct-standard' : '--settings-color-direct-lite';
        } else {
            colorVar = selectedModel.tier === 'standard' ? '--settings-color-proxy-standard' : '--settings-color-proxy-lite';
        }
        settingsBtn.style.color = `var(${colorVar})`;

        if (cogIcon && keyIcon) {
            cogIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'none' : 'inline-block';
            keyIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'inline-block' : 'none';
        }

        const modelName = selectedModel.uiName.split('(')[0].trim();
        const modeName = API_MODES[currentApiMode]?.uiName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        settingsBtn.title = `–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (${modelName}, ${modeName})`;
        
        const mode = API_MODES[currentApiMode];
        if (mode && apiModeSelectorButton) {
            apiModeSelectorButton.innerHTML = `${mode.icon}<span class="text">${mode.uiName}</span>`;
        }
        
        document.querySelectorAll('.api-mode-option').forEach(option => {
            const isDirectOption = option.dataset.apiMode === 'direct';
            option.style.display = (isDirectOption && currentApiType !== 'gemini') ? 'none' : 'flex';
        });
        
        if (currentApiType !== 'gemini' && currentApiMode === 'direct') {
            currentApiMode = 'proxy';
            localStorage.setItem('analystApiMode', currentApiMode);
            updateSettingsUI();
        }
        
        updateApiKeyInputVisibility();
    };

    const saveSettings = () => {
        const key = apiKeyInput.value.trim();
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];

        currentModelId = selectedOption.value;
        currentApiType = selectedOption.dataset.apiType;

        if (currentApiType === 'gemini' && currentApiMode === 'direct' && !key) {
            alert('–î–ª—è —Ä–µ–∂–∏–º–∞ "–ü—Ä—è–º–æ–π (Gemini)" –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ API –∫–ª—é—á.');
            return;
        }

        apiKey = key;
        localStorage.setItem('analystApiKey', key);
        localStorage.setItem('analystModelId', currentModelId);
        localStorage.setItem('analystApiMode', currentApiMode);

        closeSettingsModal();
        updateSettingsUI();
    };

    const loadSettings = () => {
        apiKey = localStorage.getItem('analystApiKey') || '';
        apiKeyInput.value = apiKey;
        
        const savedModelId = localStorage.getItem('analystModelId') || DEFAULT_MODEL_ID;
        const savedModelOption = modelSelector.querySelector(`option[value="${savedModelId}"]`);
        currentModelId = savedModelOption ? savedModelId : DEFAULT_MODEL_ID;
        modelSelector.value = currentModelId;

        const savedApiMode = localStorage.getItem('analystApiMode');
        currentApiMode = API_MODES[savedApiMode] ? savedApiMode : 'mapruapp';
        
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];
        if(selectedOption) currentApiType = selectedOption.dataset.apiType;
        
        updateSettingsUI();
    };
    
    const populateApiModeOptions = () => {
        apiModeOptions.innerHTML = '';
        Object.keys(API_MODES).forEach(modeId => {
            const mode = API_MODES[modeId];
            const option = document.createElement('li');
            option.className = 'api-mode-option';
            option.dataset.apiMode = modeId;
            option.innerHTML = `${mode.icon} <span>${mode.uiName}</span>`;
            option.addEventListener('click', () => {
                currentApiMode = modeId;
                document.querySelectorAll('.api-mode-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                apiModeOptions.style.display = 'none';
                updateSettingsUI();
            });
            apiModeOptions.appendChild(option);
        });
    };

    // --- UTILITIES ---
    const copyResponse = () => {
        navigator.clipboard.writeText(responseContainer.innerText)
            .then(() => alert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.'))
            .catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err));
    };

    const printResponse = () => window.print();

    // --- LET'S GO ---
    initializeApp();
});
</script>
</body>
</html>
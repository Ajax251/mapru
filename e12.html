<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Исследователь</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU&load=package.full" type="text/javascript"></script>
    <link id="favicon" rel="icon" href="img/explorer.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #f8fafc;
            --panel-bg: #ffffff;
            --text-color: #1e293b;
            --text-light: #64748b;
            --primary-color: #3b82f6;
            --primary-color-dark: #1d4ed8;
            --primary-color-light: #dbeafe;
            --border-color: #e2e8f0;
            --highlight-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-text-fill-color: var(--text-color) !important;
            -webkit-box-shadow: 0 0 0px 1000px white inset !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #detail-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: var(--panel-bg);
            box-shadow: var(--shadow-xl);
            z-index: 12;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            border-right: 1px solid var(--border-color);
        }

        #detail-panel.visible { transform: translateX(0); }

        .detail-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-panel-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color-dark);
        }

        #detail-close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--highlight-bg);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        #detail-close-btn:hover {
            background: var(--error-color);
            color: white;
            transform: rotate(90deg);
        }
        
        .detail-panel-content-wrapper {
             overflow-y: auto;
             flex-grow: 1;
             padding: 24px;
             font-size: 15px;
             line-height: 1.7;
             color: var(--text-color);
        }

        #side-panel {
            width: 300px;
            height: 100%;
            background: var(--panel-bg);
            box-shadow: var(--shadow-xl);
            z-index: 10;
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
            opacity: 0;
            position: fixed;
            right: 0;
            top: 0;
            border-left: 1px solid var(--border-color);
        }

        #side-panel.visible {
            transform: translateX(0);
            opacity: 1;
        }

        .panel-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            background: var(--panel-bg);
        }

        .panel-title {
            padding: 0 0 20px 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color-dark);
            word-break: break-all;
        }

        .panel-tabs {
            display: flex;
            gap: 4px;
            background: var(--highlight-bg);
            border-radius: 12px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--primary-color-light);
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            box-shadow: var(--shadow-md);
        }

        .panel-content-wrapper {
            overflow-y: auto;
            flex-grow: 1;
            padding: 10px;
            background: var(--bg-color);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #panel-welcome {
            text-align: center;
            padding: 60px 20px;
            margin: 10px;
            color: var(--text-light);
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        #panel-welcome i { 
            font-size: 64px; 
            color: var(--primary-color);
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        #panel-welcome h3 { margin: 0 0 16px 0; font-size: 24px; color: var(--text-color); font-weight: 600; }
        #panel-welcome p { font-size: 16px; line-height: 1.6; max-width: 300px; margin: 0 auto; }

        .panel-item {
            padding: 20px; margin: 0 10px 12px 10px; border-radius: 16px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color); background: white;
        }

        .panel-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }
        
        .panel-item.highlighted {
            border-color: var(--primary-color);
            background: var(--primary-color-light);
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px) scale(1.02);
        }

        .panel-item-name { font-weight: 600; font-size: 16px; color: var(--text-color); margin-bottom: 8px; }
        .panel-item-desc { font-size: 14px; color: var(--text-light); line-height: 1.5; }
        
        .route-item {
            border: 1px solid var(--border-color); border-radius: 16px; margin: 0 10px 16px 10px;
            overflow: hidden; background: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .route-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--primary-color); }
        .route-header { padding: 20px; cursor: pointer; transition: all 0.3s ease; }
        .route-header:hover { background: rgba(59, 130, 246, 0.05); }
        .route-name { font-weight: 600; font-size: 16px; color: var(--primary-color-dark); margin-bottom: 8px; }
        .route-details { font-size: 13px; color: var(--text-light); }
        .route-description { padding: 20px; font-size: 14px; line-height: 1.6; border-top: 1px solid var(--border-color); background: var(--highlight-bg); }
        
        #input-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            box-sizing: border-box;
        }
        
        .input-wrapper {
            display: flex; 
            width: 100%; 
            max-width: 650px;
            box-shadow: var(--shadow-xl); 
            border-radius: 50px;
            background: white; 
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 21;
        }

        .input-wrapper:focus-within { 
            box-shadow: var(--shadow-xl), 0 0 0 4px var(--primary-color-light); 
            border-color: var(--primary-color); 
        }
        
        #wiki-btn {
            flex-shrink: 0; 
            width: 56px; 
            height: 56px; 
            border: none;
            background: transparent; 
            color: var(--text-color);
            font-size: 22px; 
            cursor: pointer; 
            border-radius: 50px 0 0 50px;
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-right: 1px solid var(--border-color);
            position: relative;
            z-index: 22;
        }
        #wiki-btn:hover { background-color: var(--highlight-bg); color: var(--text-color); }
        #wiki-btn:disabled { color: var(--text-light); cursor: not-allowed; }

        #query-input {
            flex-grow: 1; 
            padding: 18px 20px; 
            font-size: 16px; 
            border: none; 
            border-radius: 0;
            outline: none; 
            background: transparent; 
            color: var(--text-color); 
            font-weight: 500;
            text-align: center;
        }
        
        #send-btn {
            flex-shrink: 0; 
            width: 56px; 
            height: 56px; 
            border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark)); 
            color: white;
            font-size: 18px; 
            cursor: pointer; 
            border-radius: 0 50px 50px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            z-index: 22;
        }
        #send-btn:hover { background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color)); }
        #send-btn:active { transform: scale(0.95); }
        #send-btn:disabled { background: var(--error-color); cursor: not-allowed; transform: none; box-shadow: none; }
        
        #settings-btn-container {
            position: fixed; bottom: 120px; right: 20px; z-index: 15;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #side-panel.visible ~ #settings-btn-container { right: 420px; }
        #settings-btn {
            width: 56px; height: 56px; border-radius: 50%; border: 1px solid var(--border-color);
            background: white; color: var(--primary-color); font-size: 20px; cursor: pointer;
            box-shadow: var(--shadow-lg); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center;
        }
        #settings-btn:hover { transform: scale(1.1) rotate(90deg); background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark)); color: white; }
        
        .loader { width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-dark { width: 20px; height: 20px; border: 2px solid rgba(0, 0, 0, 0.1); border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
            align-items: center; z-index: 1000; backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content {
            background: white; padding: 32px; border-radius: 24px; box-shadow: var(--shadow-xl);
            width: 90%; max-width: 500px; display: flex; flex-direction: column;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid var(--border-color);
            max-height: 80vh; overflow-y: auto;
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .modal-content h2 { margin-top: 0; color: var(--primary-color-dark); text-align: center; font-size: 24px; font-weight: 700; }
        .modal-content p { color: var(--text-light); line-height: 1.6; text-align: center; margin-bottom: 24px; }
        .settings-controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .settings-control-group label { display: block; margin-bottom: 8px; color: var(--text-color); font-size: 14px; font-weight: 500; }
        .settings-control-group select, .settings-control-group input[type="password"] {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: 12px; font-size: 16px; box-sizing: border-box;
            transition: all 0.3s ease; background: white; color: var(--text-color);
        }
        .settings-control-group select:focus, .settings-control-group input[type="password"]:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color-light);
        }
        .api-key-group { display: none; }
        .api-key-group.visible { display: block; }
        #save-settings-btn {
            margin-top: 24px; width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark)); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #save-settings-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .modal-content a { color: var(--primary-color); text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
        .modal-content a:hover { color: var(--primary-color-dark); text-decoration: underline; }

        .error-message {
            background: #fee2e2; color: var(--error-color); padding: 16px;
            border-radius: 12px; margin: 10px; border: 1px solid #fca5a5;
            animation: shake 0.5s ease-in-out; text-align: center;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .wiki-search-header {
            text-align: center;
            padding: 20px;
            margin: 10px;
            background: linear-gradient(135deg, var(--primary-color-light), #e0e7ff);
            border-radius: 16px;
            border: 1px solid var(--primary-color);
        }
        
        .wiki-search-header i {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }
        
        .wiki-search-header h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color-dark);
            font-size: 16px;
        }
        
        .wiki-search-header p {
            margin: 0;
            font-size: 13px;
            color: var(--text-light);
        }
        
        .wiki-article-item {
            padding: 16px 20px;
            margin: 0 10px 10px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            background: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .wiki-article-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
            background: var(--primary-color-light);
        }
        
        .wiki-article-item i {
            color: var(--primary-color);
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .wiki-article-item span {
            font-size: 15px;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .wiki-cancel-btn {
            margin: 10px;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--highlight-bg);
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .wiki-cancel-btn:hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }
        
        .panel-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            margin: 10px;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        
        .panel-loader .loader-big {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .panel-loader p {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            margin: 0;
        }


.custom-balloon {
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    border-radius: 16px;
    padding: 0;
    box-shadow: 0 10px 40px rgba(59, 130, 246, 0.25);
    border: 2px solid #dbeafe;
    min-width: 280px;
    max-width: 350px;
    overflow: hidden;
}

.custom-balloon-header {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 16px 20px;
    font-weight: 700;
    font-size: 16px;
    line-height: 1.3;
}

.custom-balloon-body {
    padding: 16px 20px;
    color: #334155;
    font-size: 14px;
    line-height: 1.6;
}



        .model-tier {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }
        .model-tier.lite { background: #dbeafe; color: #1d4ed8; }
        .model-tier.standard { background: #dcfce7; color: #166534; }
        
        
        /* --- Анимация книжки --- */
.book {
    --color: #3b82f6;
    --duration: 6.8s;
    width: 32px;
    height: 12px;
    position: relative;
    margin: 40px 0 20px 0;
    zoom: 1.5;
}

.book .inner {
    width: 32px;
    height: 12px;
    position: relative;
    transform-origin: 2px 2px;
    transform: rotateZ(-90deg);
    animation: book var(--duration) ease infinite;
}

.book .inner .left,
.book .inner .right {
    width: 60px;
    height: 4px;
    top: 0;
    border-radius: 2px;
    background: var(--color);
    position: absolute;
}

.book .inner .left:before,
.book .inner .right:before {
    content: '';
    width: 48px;
    height: 4px;
    border-radius: 2px;
    background: inherit;
    position: absolute;
    top: -10px;
    left: 6px;
}

.book .inner .left {
    right: 28px;
    transform-origin: 58px 2px;
    transform: rotateZ(90deg);
    animation: left var(--duration) ease infinite;
}

.book .inner .right {
    left: 28px;
    transform-origin: 2px 2px;
    transform: rotateZ(-90deg);
    animation: right var(--duration) ease infinite;
}

.book .inner .middle {
    width: 32px;
    height: 12px;
    border: 4px solid var(--color);
    border-top: 0;
    border-radius: 0 0 9px 9px;
    transform: translateY(2px);
}

.book ul {
    margin: 0;
    padding: 0;
    list-style: none;
    position: absolute;
    left: 50%;
    top: 0;
}

.book ul li {
    height: 4px;
    border-radius: 2px;
    transform-origin: 100% 2px;
    width: 48px;
    right: 0;
    top: -10px;
    position: absolute;
    background: var(--color);
    transform: rotateZ(0deg) translateX(-18px);
    animation-duration: var(--duration);
    animation-timing-function: ease;
    animation-iteration-count: infinite;
}

.book ul li:nth-child(0) {
    animation-name: page-0;
}

.book ul li:nth-child(1) {
    animation-name: page-1;
}

.book ul li:nth-child(2) {
    animation-name: page-2;
}

.book ul li:nth-child(3) {
    animation-name: page-3;
}

.book ul li:nth-child(4) {
    animation-name: page-4;
}

.book ul li:nth-child(5) {
    animation-name: page-5;
}

.book ul li:nth-child(6) {
    animation-name: page-6;
}

.book ul li:nth-child(7) {
    animation-name: page-7;
}

.book ul li:nth-child(8) {
    animation-name: page-8;
}

.book ul li:nth-child(9) {
    animation-name: page-9;
}

.book ul li:nth-child(10) {
    animation-name: page-10;
}

.book ul li:nth-child(11) {
    animation-name: page-11;
}

.book ul li:nth-child(12) {
    animation-name: page-12;
}

.book ul li:nth-child(13) {
    animation-name: page-13;
}

.book ul li:nth-child(14) {
    animation-name: page-14;
}

.book ul li:nth-child(15) {
    animation-name: page-15;
}

.book ul li:nth-child(16) {
    animation-name: page-16;
}

.book ul li:nth-child(17) {
    animation-name: page-17;
}

.book ul li:nth-child(18) {
    animation-name: page-18;
}

@keyframes page-0 { 4% { transform: rotateZ(0deg) translateX(-18px); } 13%, 54% { transform: rotateZ(180deg) translateX(-18px); } 63% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-1 { 5.86% { transform: rotateZ(0deg) translateX(-18px); } 14.74%, 55.86% { transform: rotateZ(180deg) translateX(-18px); } 64.74% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-2 { 7.72% { transform: rotateZ(0deg) translateX(-18px); } 16.48%, 57.72% { transform: rotateZ(180deg) translateX(-18px); } 66.48% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-3 { 9.58% { transform: rotateZ(0deg) translateX(-18px); } 18.22%, 59.58% { transform: rotateZ(180deg) translateX(-18px); } 68.22% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-4 { 11.44% { transform: rotateZ(0deg) translateX(-18px); } 19.96%, 61.44% { transform: rotateZ(180deg) translateX(-18px); } 69.96% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-5 { 13.3% { transform: rotateZ(0deg) translateX(-18px); } 21.7%, 63.3% { transform: rotateZ(180deg) translateX(-18px); } 71.7% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-6 { 15.16% { transform: rotateZ(0deg) translateX(-18px); } 23.44%, 65.16% { transform: rotateZ(180deg) translateX(-18px); } 73.44% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-7 { 17.02% { transform: rotateZ(0deg) translateX(-18px); } 25.18%, 67.02% { transform: rotateZ(180deg) translateX(-18px); } 75.18% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-8 { 18.88% { transform: rotateZ(0deg) translateX(-18px); } 26.92%, 68.88% { transform: rotateZ(180deg) translateX(-18px); } 76.92% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-9 { 20.74% { transform: rotateZ(0deg) translateX(-18px); } 28.66%, 70.74% { transform: rotateZ(180deg) translateX(-18px); } 78.66% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-10 { 22.6% { transform: rotateZ(0deg) translateX(-18px); } 30.4%, 72.6% { transform: rotateZ(180deg) translateX(-18px); } 80.4% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-11 { 24.46% { transform: rotateZ(0deg) translateX(-18px); } 32.14%, 74.46% { transform: rotateZ(180deg) translateX(-18px); } 82.14% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-12 { 26.32% { transform: rotateZ(0deg) translateX(-18px); } 33.88%, 76.32% { transform: rotateZ(180deg) translateX(-18px); } 83.88% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-13 { 28.18% { transform: rotateZ(0deg) translateX(-18px); } 35.62%, 78.18% { transform: rotateZ(180deg) translateX(-18px); } 85.62% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-14 { 30.04% { transform: rotateZ(0deg) translateX(-18px); } 37.36%, 80.04% { transform: rotateZ(180deg) translateX(-18px); } 87.36% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-15 { 31.9% { transform: rotateZ(0deg) translateX(-18px); } 39.1%, 81.9% { transform: rotateZ(180deg) translateX(-18px); } 89.1% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-16 { 33.76% { transform: rotateZ(0deg) translateX(-18px); } 40.84%, 83.76% { transform: rotateZ(180deg) translateX(-18px); } 90.84% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-17 { 35.62% { transform: rotateZ(0deg) translateX(-18px); } 42.58%, 85.62% { transform: rotateZ(180deg) translateX(-18px); } 92.58% { transform: rotateZ(0deg) translateX(-18px); } }
@keyframes page-18 { 37.48% { transform: rotateZ(0deg) translateX(-18px); } 44.32%, 87.48% { transform: rotateZ(180deg) translateX(-18px); } 94.32% { transform: rotateZ(0deg) translateX(-18px); } }

@keyframes left {
    4% { transform: rotateZ(90deg); }
    10%, 40% { transform: rotateZ(0deg); }
    46%, 54% { transform: rotateZ(90deg); }
    60%, 90% { transform: rotateZ(0deg); }
    96% { transform: rotateZ(90deg); }
}

@keyframes right {
    4% { transform: rotateZ(-90deg); }
    10%, 40% { transform: rotateZ(0deg); }
    46%, 54% { transform: rotateZ(-90deg); }
    60%, 90% { transform: rotateZ(0deg); }
    96% { transform: rotateZ(-90deg); }
}

@keyframes book {
    4% { transform: rotateZ(-90deg); }
    10%, 40% { transform: rotateZ(0deg); transform-origin: 2px 2px; }
    40.01%, 59.99% { transform-origin: 30px 2px; }
    46%, 54% { transform: rotateZ(90deg); }
    60%, 90% { transform: rotateZ(0deg); transform-origin: 2px 2px; }
    96% { transform: rotateZ(-90deg); }
}

.panel-loader-book {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    min-height: 450px;
    gap: 30px;
}

.panel-loader-book .loader-status {
    text-align: center;
    color: var(--text-color);
    font-size: 15px;
    font-weight: 600;
    margin-top: 16px;
    order: 2;
}

.panel-loader-book .book {
    order: 1;
}

.panel-loader-book .loader-stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
    padding: 16px;
    background: var(--highlight-bg);
    border-radius: 12px;
    width: 100%;
    max-width: 250px;
    order: 3;
}

.panel-loader-book .loader-stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-light);
}

.panel-loader-book .loader-stat-label {
    display: flex;
    align-items: center;
    gap: 8px;
}

.panel-loader-book .loader-stat-value {
    font-weight: 600;
    color: var(--primary-color);
}


.route-nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: white;
    color: var(--primary-color);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    margin-left: 12px;
}

.route-nav-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.1);
}

.route-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}


    </style>
</head>
<body>
    <div id="app-container">
        <aside id="detail-panel">
            <div class="detail-panel-header">
                <div id="detail-panel-title" class="detail-panel-title"></div>
                <button id="detail-close-btn" title="Закрыть" type="button"><i class="fas fa-times"></i></button>
            </div>
            <div id="detail-panel-content" class="detail-panel-content-wrapper"></div>
        </aside>

        <div id="map"></div>
        
        <aside id="side-panel">
            <div class="panel-header">
                <div class="panel-title">Результаты</div>
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="places" type="button"><i class="fas fa-map-marker-alt"></i> Места</button>
                    <button class="tab-btn" data-tab="routes" type="button"><i class="fas fa-route"></i> Маршруты</button>
                </div>
            </div>
            <div class="panel-content-wrapper">
                <div id="places-content" class="tab-content active">
                    <div id="panel-welcome">
                        <i class="fas fa-globe-europe"></i>
                        <h3>Исследователь</h3>
                        <p>Введите имя исторической личности, событие или объект, чтобы увидеть связанные с ним места и маршруты на карте.</p>
                    </div>
                </div>
                <div id="routes-content" class="tab-content"></div>
            </div>
        </aside>
    </div>
    
    <div id="settings-btn-container">
        <button id="settings-btn" title="Настройки AI" type="button"><i class="fas fa-cog"></i></button>
    </div>

    <div id="input-panel">
        <div class="input-wrapper">
            <button id="wiki-btn" title="Искать в Википедии" type="button"><i class="fab fa-wikipedia-w"></i></button>
            <input 
                type="text" 
                id="query-input" 
                placeholder="Например: Шелковый путь"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
                data-lpignore="true"
                data-1p-ignore="true"
                data-form-type="other"
            >
            <button id="send-btn" title="Спросить ИИ" type="button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fas fa-cog"></i> Настройки подключения</h2>
            <p>Выберите модель ИИ и режим подключения.</p>
            <div class="settings-controls-wrapper">
                <div class="settings-control-group">
                    <label for="model-selector"><i class="fas fa-atom"></i> 1. Выберите модель</label>
                    <select id="model-selector"></select>
                </div>
                <div class="settings-control-group">
                    <label for="api-mode-selector"><i class="fas fa-server"></i> 2. Выберите режим подключения</label>
                    <select id="api-mode-selector"></select>
                </div>
                <div class="settings-control-group api-key-group" id="gemini-key-group">
                    <label for="gemini-api-key"><i class="fas fa-key"></i> API ключ Gemini</label>
                    <input 
                        type="password" 
                        id="gemini-api-key" 
                        placeholder="Ваш ключ Gemini..."
                        autocomplete="new-password"
                        data-lpignore="true"
                        data-1p-ignore="true"
                        data-form-type="other"
                    >
                    <small style="display: block; margin-top: 5px; color: var(--text-light);">Ключ можно получить в <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a></small>
                </div>
                <div class="settings-control-group api-key-group" id="mistral-key-group">
                    <label for="mistral-api-key"><i class="fas fa-key"></i> API ключ Mistral</label>
                    <input 
                        type="password" 
                        id="mistral-api-key" 
                        placeholder="Ваш ключ Mistral..."
                        autocomplete="new-password"
                        data-lpignore="true"
                        data-1p-ignore="true"
                        data-form-type="other"
                    >
                    <small style="display: block; margin-top: 5px; color: var(--text-light);">Ключ можно получить в <a href="https://console.mistral.ai/api-keys/" target="_blank" rel="noopener noreferrer">Mistral Console</a></small>
                </div>
            </div>
            <button id="save-settings-btn" type="button">Сохранить и закрыть</button>
        </div>
    </div>

<script src="webfonts/supabase-js@2.js"></script>

<script>
// --- КОНФИГУРАЦИЯ ---
const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";

const MODELS = [
    { id: "gemini-2.5-flash-lite-preview-06-2025", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
    { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini", tier: 'standard' },
    { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini", tier: 'standard' },
    { id: "gemini-3-pro-preview", uiName: "Gemini 3 Pro Preview", apiType: "gemini", tier: 'standard' },
    { id: "nvidia/nemotron-3-nano-30b-a3b:free", uiName: "NVIDIA Nemotron 3 Nano 30B", apiType: "openrouter", tier: 'standard' },
    { id: "gpt-oss-20b-free", uiName: "OpenAI GPT-OSS 20B", apiType: "openrouter", tier: 'standard' },
    { id: "mistral-large-2512", uiName: "Mistral Large", apiType: "mistral", tier: 'standard' },
    { id: "mistral-medium-2508", uiName: "Mistral Medium", apiType: "mistral", tier: 'standard' },
];

const API_MODES = {
    'mapruapp': { uiName: 'Прокси (MapRuApp)', requiresKey: null },
    'vercel': { uiName: 'Прокси (Vercel)', requiresKey: null },
    'direct': { uiName: 'Прямой (Gemini)', requiresKey: 'gemini' },
    'direct_mistral': { uiName: 'Прямой (Mistral)', requiresKey: 'mistral' }
};

const WIKI_API_URL = "https://ru.wikipedia.org/w/api.php";

const ICON_DEFAULT = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2Ij48cGF0aCBmaWxsPSIjM2I4MmY2IiBkPSJNMTIgMiBDNi40OCAyIDIgNi40OCAyIDEyIEMyIDE5LjI4IDEyIDIyIDEyIDIyIEMxMiAyMiAyMiAxOS4yOCAyMiAxMiBDMjIgNi40OCAxNy41MiAyIDEyIDJaIi8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDEyIGE0IDQgMCAxIDAgMCAtOCBhNCA0IDAgMCAwIDAgOFoiLz48L3N2Zz4=';
const ICON_SELECTED = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2Ij48cGF0aCBmaWxsPSIjZWY0NDQ0IiBkPSJNMTIgMiBDNi40OCAyIDIgNi40OCAyIDEyIEMyIDE5LjI4IDEyIDIyIDEyIDIyIEMxMiAyMiAyMiAxOS4yOCAyMiAxMiBDMjIgNi40OCAxNy41MiAyIDEyIDJaIi8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDEyIGE0IDQgMCAxIDAgMCAtOCBhNCA0IDAgMCAwIDAgOFoiLz48L3N2Zz4=';

// --- ПРОМПТЫ ---
const AI_SYSTEM_PROMPT_PLACES = `
Ты — гео-исторический эксперт. Твоя задача — на основе запроса пользователя найти связанные с ним географические места.
Ты должен вернуть ответ СТРОГО в формате JSON. Никакого другого текста, только чистый JSON.
JSON должен быть массивом объектов. Каждый объект представляет одно место и должен иметь следующую структуру:
{"name": "Краткое название", "short_description": "Краткое описание на 1-2 предложения", "full_description": "Подробное описание на 2-4 предложения", "coordinates": { "lat": 55.75, "lon": 37.61 }}`;

const AI_SYSTEM_PROMPT_ROUTES = `
Ты — эксперт по историческим и географическим маршрутам. Твоя задача — на основе запроса пользователя найти 1-3 связанных с ним маршрута.
Ты должен вернуть ответ СТРОГО в формате JSON. Никакого другого текста, только чистый JSON.
JSON должен быть объектом с одним ключом "routes", который является массивом. Каждый объект в массиве представляет один маршрут и должен иметь следующую структуру:
{"routeName": "Название", "routeDescription": "Описание маршрута", "totalDistance": "Примерное расстояние", "waypoints": [{"name": "Точка 1", "lat": 55.75, "lon": 37.61}, {"name": "Точка 2", "lat": 48.85, "lon": 2.35}]}`;

const AI_PROMPT_WIKI_EXTRACTOR_PLACES = `
Проанализируй предоставленный текст статьи из Википедии.
Извлеки из него все упомянутые географические места (города, поселения, достопримечательности, локации битв и т.д.).
Для каждого места найди или оцени примерные координаты.
Верни ответ СТРОГО в формате JSON (массив объектов), как в примере:
[{"name": "Название места", "short_description": "Контекст упоминания в статье (1 предл.)", "full_description": "Более полное описание связи места с темой статьи (2-3 предл.)", "coordinates": { "lat": 55.75, "lon": 37.61 }}]
Если точных координат в тексте нет, используй общеизвестные координаты этих мест.
`;

const AI_PROMPT_WIKI_EXTRACTOR_ROUTES = `
Проанализируй предоставленный текст статьи из Википедии.
Найди и извлеки из него маршруты, путешествия, походы, миграции или перемещения, упомянутые в статье.
Это могут быть: путешествия личности, военные походы, торговые пути, миграции народов и т.д.
Верни ответ СТРОГО в формате JSON с ключом "routes", как в примере:
{"routes": [{"routeName": "Название маршрута/путешествия", "routeDescription": "Описание маршрута на основе статьи", "totalDistance": "Примерное расстояние (если известно)", "waypoints": [{"name": "Начальная точка", "lat": 55.75, "lon": 37.61}, {"name": "Промежуточная точка", "lat": 50.0, "lon": 30.0}, {"name": "Конечная точка", "lat": 48.85, "lon": 2.35}]}]}
Если в статье нет явных маршрутов, попробуй составить логический маршрут на основе упомянутых мест и событий.
Если маршрутов совсем нет, верни: {"routes": []}
`;

// --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
let map = null;
let currentMapObjects = null;
let placesGeoCollection = null;
let selectedPlacemark = null;
let geminiApiKey = '';
let mistralApiKey = '';
let currentApiMode = 'mapruapp';
let currentModelId = MODELS[0].id;
let isProcessing = false;
let isWikiSelectionMode = false;

// --- DOM ЭЛЕМЕНТЫ ---
const queryInput = document.getElementById('query-input');
const sendButton = document.getElementById('send-btn');
const wikiButton = document.getElementById('wiki-btn');
const sidePanel = document.getElementById('side-panel');
const panelTitle = document.querySelector('.panel-title');
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const placesContent = document.getElementById('places-content');
const routesContent = document.getElementById('routes-content');
const settingsBtn = document.getElementById('settings-btn');
const settingsModalOverlay = document.getElementById('settings-modal-overlay');
const saveSettingsBtn = document.getElementById('save-settings-btn');
const modelSelector = document.getElementById('model-selector');
const apiModeSelector = document.getElementById('api-mode-selector');
const geminiKeyInput = document.getElementById('gemini-api-key');
const mistralKeyInput = document.getElementById('mistral-api-key');
const geminiKeyGroup = document.getElementById('gemini-key-group');
const mistralKeyGroup = document.getElementById('mistral-key-group');
const detailPanel = document.getElementById('detail-panel');
const detailPanelTitle = document.getElementById('detail-panel-title');
const detailPanelContent = document.getElementById('detail-panel-content');
const detailCloseBtn = document.getElementById('detail-close-btn');


let supabaseClient = null;
const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';

function initSupabase() {
    if (typeof supabase !== 'undefined') {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase инициализирован');
    } else {
        console.error('❌ Библиотека Supabase не загружена');
    }
}

async function getArticleFromCache(title) {
    if (!supabaseClient) return null;
    
    try {
        const { data, error } = await supabaseClient
            .from('wiki_articles')
            .select('*')
            .eq('title', title)
            .single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                return null;
            }
            throw error;
        }
        
        return data;
    } catch (error) {
        console.error('Ошибка получения из кэша:', error);
        return null;
    }
}

async function saveArticleToCache(title, places, routes) {
    if (!supabaseClient) return false;
    
    try {
        const { data, error } = await supabaseClient
            .from('wiki_articles')
            .insert({
                title: title,
                places: places,
                routes: routes
            })
            .select()
            .single();
        
        if (error) throw error;
        
        console.log('✅ Статья сохранена в кэш:', title);
        return true;
    } catch (error) {
        console.error('Ошибка сохранения в кэш:', error);
        return false;
    }
}

async function updateArticleInCache(title, places, routes) {
    if (!supabaseClient) return false;
    
    try {
        const { data, error } = await supabaseClient
            .from('wiki_articles')
            .update({
                places: places,
                routes: routes,
                updated_at: new Date().toISOString()
            })
            .eq('title', title)
            .select()
            .single();
        
        if (error) throw error;
        
        console.log('✅ Статья обновлена в кэше:', title);
        return true;
    } catch (error) {
        console.error('Ошибка обновления в кэше:', error);
        return false;
    }
}



// --- ИНИЦИАЛИЗАЦИЯ СЕЛЕКТОРОВ ---
function initSelectors() {
    // Заполняем список моделей
    modelSelector.innerHTML = '';
    MODELS.forEach(function(model) {
        const option = document.createElement('option');
        option.value = model.id;
        option.dataset.apiType = model.apiType;
        option.dataset.tier = model.tier;
        option.textContent = model.uiName;
        modelSelector.appendChild(option);
    });

    // Заполняем список режимов API
    apiModeSelector.innerHTML = '';
    Object.keys(API_MODES).forEach(function(modeKey) {
        const mode = API_MODES[modeKey];
        const option = document.createElement('option');
        option.value = modeKey;
        option.textContent = mode.uiName;
        apiModeSelector.appendChild(option);
    });
}

// --- ФУНКЦИИ НАСТРОЕК ---
function openSettingsModal() { settingsModalOverlay.style.display = 'flex'; }
function closeSettingsModal() { settingsModalOverlay.style.display = 'none'; }

function updateApiKeyInputVisibility() {
    const mode = API_MODES[currentApiMode];
    geminiKeyGroup.classList.remove('visible');
    mistralKeyGroup.classList.remove('visible');
    
    if (mode && mode.requiresKey === 'gemini') {
        geminiKeyGroup.classList.add('visible');
    } else if (mode && mode.requiresKey === 'mistral') {
        mistralKeyGroup.classList.add('visible');
    }
}

function getCurrentModel() {
    return MODELS.find(function(m) { return m.id === currentModelId; }) || MODELS[0];
}

function saveSettings() {
    const selectedModelOption = modelSelector.options[modelSelector.selectedIndex];
    currentModelId = selectedModelOption.value;
    currentApiMode = apiModeSelector.value;
    geminiApiKey = geminiKeyInput.value.trim();
    mistralApiKey = mistralKeyInput.value.trim();
    
    const mode = API_MODES[currentApiMode];
    if (mode.requiresKey === 'gemini' && !geminiApiKey) {
        alert('Для режима "Прямой (Gemini)" необходимо ввести API ключ Gemini.');
        return;
    }
    if (mode.requiresKey === 'mistral' && !mistralApiKey) {
        alert('Для режима "Прямой (Mistral)" необходимо ввести API ключ Mistral.');
        return;
    }
    
    localStorage.setItem('geoExplorerGeminiKey', geminiApiKey);
    localStorage.setItem('geoExplorerMistralKey', mistralApiKey);
    localStorage.setItem('geoExplorerModelId', currentModelId);
    localStorage.setItem('geoExplorerApiMode', currentApiMode);
    closeSettingsModal();
}

function loadSettings() {
    geminiApiKey = localStorage.getItem('geoExplorerGeminiKey') || '';
    mistralApiKey = localStorage.getItem('geoExplorerMistralKey') || '';
    geminiKeyInput.value = geminiApiKey;
    mistralKeyInput.value = mistralApiKey;
    
    // Загрузка модели с проверкой существования
    const savedModelId = localStorage.getItem('geoExplorerModelId');
    if (savedModelId) {
        const modelExists = MODELS.some(function(m) { return m.id === savedModelId; });
        if (modelExists) {
            modelSelector.value = savedModelId;
            currentModelId = savedModelId;
        } else {
            console.warn('Сохранённая модель "' + savedModelId + '" не найдена, используется модель по умолчанию');
            localStorage.removeItem('geoExplorerModelId');
            currentModelId = MODELS[0].id;
            modelSelector.value = currentModelId;
        }
    } else {
        currentModelId = MODELS[0].id;
        modelSelector.value = currentModelId;
    }
    
    // Загрузка режима API с проверкой
    const savedApiMode = localStorage.getItem('geoExplorerApiMode');
    if (savedApiMode && API_MODES[savedApiMode]) {
        apiModeSelector.value = savedApiMode;
        currentApiMode = savedApiMode;
    } else {
        if (savedApiMode) localStorage.removeItem('geoExplorerApiMode');
        currentApiMode = 'mapruapp';
        apiModeSelector.value = currentApiMode;
    }
    
    updateApiKeyInputVisibility();
}

function renderError(container, message) {
    container.innerHTML = '<div class="error-message">' + message + '</div>';
}

function renderLoader(container, message) {
    message = message || "Загрузка...";
    container.innerHTML = '<div class="panel-loader"><div class="loader-big"></div><p>' + message + '</p></div>';
}

// --- ФУНКЦИИ КАРТЫ ---
function initMap() {
    map = new ymaps.Map('map', { 
        center: [40, 65], zoom: 3, controls: [] 
    });
    map.controls.add('zoomControl', { position: { right: 15, top: 15 } });
    map.controls.add('fullscreenControl', { position: { right: 15, top: 105 } });
    map.controls.add('typeSelector', { position: { right: 15, bottom: 120 } });
    map.controls.add('rulerControl', { position: { right: 15, bottom: 170 } });
    
    if (!currentMapObjects) currentMapObjects = new ymaps.GeoObjectCollection({}, {});
    if (!placesGeoCollection) placesGeoCollection = new ymaps.GeoObjectCollection({}, {});
    
    map.geoObjects.add(currentMapObjects);
}

function clearMap() {
    if (currentMapObjects) {
        currentMapObjects.removeAll();
    }
}

function showAllPlacesOnMap() {
    clearMap();
    if (map && placesGeoCollection && placesGeoCollection.getLength() > 0) {
        currentMapObjects.add(placesGeoCollection);
        map.setBounds(placesGeoCollection.getBounds(), {
            checkZoomRange: true, duration: 500,
            margin: [10, 420, 10, 10] 
        }).catch(function(err) { console.error("Ошибка установки границ:", err); });
    }
}

function hideDetailsPanel() {
    if (selectedPlacemark) {
        selectedPlacemark.options.set('iconImageHref', ICON_DEFAULT);
        const panelItem = document.querySelector('.panel-item[data-id="' + selectedPlacemark.options.get('id') + '"]');
        if (panelItem) {
            panelItem.classList.remove('highlighted');
        }
    }
    selectedPlacemark = null;
    detailPanel.classList.remove('visible');
}

function showDetailsPanel(place, placemark) {
    if (selectedPlacemark && selectedPlacemark !== placemark) {
        hideDetailsPanel();
    }
    selectedPlacemark = placemark;

    detailPanelTitle.textContent = place.name;
    detailPanelContent.innerHTML = '<p>' + place.full_description + '</p>';
    detailPanel.classList.add('visible');

    placemark.options.set('iconImageHref', ICON_SELECTED);

    document.querySelectorAll('.panel-item').forEach(function(item) { item.classList.remove('highlighted'); });
    const panelItem = document.querySelector('.panel-item[data-id="' + placemark.options.get('id') + '"]');
    if (panelItem) {
        panelItem.classList.add('highlighted');
    }
}

function displayPlaces(places) {
    if (placesGeoCollection) placesGeoCollection.removeAll();
    placesContent.innerHTML = '';
    
    const count = places ? places.length : 0;
    const placesTab = document.querySelector('.tab-btn[data-tab="places"]');
    if (placesTab) {
        placesTab.innerHTML = '<i class="fas fa-map-marker-alt"></i> Места (' + count + ')';
    }

    if (!places || places.length === 0) {
        placesContent.innerHTML = '<div id="panel-welcome"><p>Связанные места не найдены.</p></div>';
        return;
    }

    if (typeof ymaps === 'undefined' || !placesGeoCollection) {
        renderError(placesContent, "Карта не инициализирована.");
        return;
    }

    // Создаем красивый balloon layout (без footer)
    const CustomBalloonLayout = ymaps.templateLayoutFactory.createClass(
        '<div class="custom-balloon">' +
            '<div class="custom-balloon-header">$[properties.balloonContentHeader]</div>' +
            '<div class="custom-balloon-body">$[properties.balloonContentBody]</div>' +
        '</div>', {
            build: function () {
                this.constructor.superclass.build.call(this);
                this._element = this.getParentElement().querySelector('.custom-balloon');
            }
        }
    );

    places.forEach(function(place, index) {
        if (!place.coordinates || typeof place.coordinates.lat !== 'number' || typeof place.coordinates.lon !== 'number') return;
        
        const placemark = new ymaps.Placemark(
            [place.coordinates.lat, place.coordinates.lon], 
            { 
                balloonContentHeader: place.name,
                balloonContentBody: place.short_description
            }, 
            { 
                iconLayout: 'default#image',
                iconImageHref: ICON_DEFAULT,
                iconImageSize: [36, 36],
                iconImageOffset: [-18, -36],
                id: 'place-' + index,
                balloonLayout: CustomBalloonLayout,
                balloonPanelMaxMapArea: 0,
                hideIconOnBalloonOpen: false
            }
        );
        
        placesGeoCollection.add(placemark);

        const panelItem = document.createElement('div');
        panelItem.className = 'panel-item';
        panelItem.dataset.id = 'place-' + index;
        panelItem.innerHTML = '<div class="panel-item-name">' + place.name + '</div><div class="panel-item-desc">' + place.short_description + '</div>';
        placesContent.appendChild(panelItem);
        
        const selectAction = function() {
            if (map) {
                map.panTo(placemark.geometry.getCoordinates(), { flying: true, duration: 1500, zoom: Math.max(map.getZoom(), 10) });
            }
            showDetailsPanel(place, placemark);
            panelItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        // При клике на элемент панели или метку - открываем детальную панель
        panelItem.addEventListener('click', selectAction);
        placemark.events.add('click', function(e) {
            placemark.balloon.close(); // Закрываем balloon если был открыт
            selectAction();
        });
        
        // При наведении - открываем balloon
        placemark.events.add('mouseenter', function() {
            placemark.balloon.open();
        });
        
        // При уходе курсора - закрываем balloon
        placemark.events.add('mouseleave', function() {
            placemark.balloon.close();
        });
    });
}

  

function displayRoutes(routesData) {
    routesContent.innerHTML = '';
    const routes = (routesData && routesData.routes) ? routesData.routes : [];
    
    const count = routes.length;
    const routesTab = document.querySelector('.tab-btn[data-tab="routes"]');
    if (routesTab) {
        routesTab.innerHTML = '<i class="fas fa-route"></i> Маршруты (' + count + ')';
    }

    if (routes.length === 0) {
        routesContent.innerHTML = '<div id="panel-welcome"><p>Связанные маршруты не найдены.</p></div>';
        return;
    }

    routes.forEach(function(route, index) {
        const routeItem = document.createElement('div');
        routeItem.className = 'route-item';
        routeItem.innerHTML = 
            '<div class="route-header">' +
                '<div style="flex: 1;">' +
                    '<div class="route-name"><i class="fas fa-route" style="color:var(--primary-color); margin-right: 8px;"></i>' + route.routeName + '</div>' +
                    '<div class="route-details"><i class="fas fa-ruler-horizontal" style="color:var(--warning-color); margin-right: 8px;"></i>Расстояние: ' + (route.totalDistance || 'не указано') + '</div>' +
                '</div>' +
                '<button class="route-nav-btn" title="Открыть в Яндекс.Навигаторе" type="button">' +
                    '<i class="fas fa-external-link-alt"></i>' +
                '</button>' +
            '</div>' +
            '<div class="route-description">' + route.routeDescription + '</div>';
        routesContent.appendChild(routeItem);
        
        const navBtn = routeItem.querySelector('.route-nav-btn');
        navBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            openRouteInNewTab(route);
        });
        
        routeItem.querySelector('.route-header').addEventListener('click', function() {
            showRouteOnMap(route, index);
        });
    });
}

function showRouteOnMap(route, routeIndex) {
    if (!route.waypoints || route.waypoints.length === 0) {
        alert('У маршрута нет точек для отображения.');
        return;
    }
    
    clearMap();
    hideDetailsPanel();
    
    const routeGeoCollection = new ymaps.GeoObjectCollection({}, {});
    
    const CustomBalloonLayout = ymaps.templateLayoutFactory.createClass(
        '<div class="custom-balloon">' +
            '<div class="custom-balloon-header">$[properties.balloonContentHeader]</div>' +
            '<div class="custom-balloon-body">$[properties.balloonContentBody]</div>' +
        '</div>', {
            build: function () {
                this.constructor.superclass.build.call(this);
                this._element = this.getParentElement().querySelector('.custom-balloon');
            }
        }
    );
    
    route.waypoints.forEach(function(waypoint, wpIndex) {
        if (!waypoint.lat || !waypoint.lon) return;
        
        const placemark = new ymaps.Placemark(
            [waypoint.lat, waypoint.lon],
            {
                balloonContentHeader: waypoint.name,
                balloonContentBody: 'Точка ' + (wpIndex + 1) + ' маршрута "' + route.routeName + '"'
            },
            {
                iconLayout: 'default#image',
                iconImageHref: ICON_DEFAULT,
                iconImageSize: [36, 36],
                iconImageOffset: [-18, -36],
                id: 'route-' + routeIndex + '-wp-' + wpIndex,
                balloonLayout: CustomBalloonLayout,
                balloonPanelMaxMapArea: 0,
                hideIconOnBalloonOpen: false
            }
        );
        
        placemark.events.add('mouseenter', function() {
            placemark.balloon.open();
        });
        
        placemark.events.add('mouseleave', function() {
            placemark.balloon.close();
        });
        
        routeGeoCollection.add(placemark);
    });
    
    if (routeGeoCollection.getLength() > 0) {
        currentMapObjects.add(routeGeoCollection);
        map.setBounds(routeGeoCollection.getBounds(), {
            checkZoomRange: true, 
            duration: 500,
            margin: [50, 50, 50, 50]
        }).catch(function(err) { 
            console.error("Ошибка установки границ:", err); 
        });
    }
}

function openRouteInNewTab(route) {
    if (!route.waypoints || route.waypoints.length < 2) {
        alert('Недостаточно точек для построения маршрута.');
        return;
    }
    const pointsString = route.waypoints.map(function(wp) { return wp.lat + ',' + wp.lon; }).join('~');
    const url = 'https://yandex.ru/maps/?rtext=' + pointsString + '&rtt=auto';
    window.open(url, '_blank');
}

// --- API ФУНКЦИИ ---
function tryFixTruncatedJson(jsonString) {
    let fixed = jsonString.trim();
    
    // Если JSON явно обрезан, пробуем закрыть его
    if (fixed.startsWith('[')) {
        // Массив объектов
        // Находим последний полный объект
        let lastCompleteIndex = -1;
        let braceCount = 0;
        let inString = false;
        let escapeNext = false;
        
        for (let i = 0; i < fixed.length; i++) {
            const char = fixed[i];
            
            if (escapeNext) {
                escapeNext = false;
                continue;
            }
            
            if (char === '\\') {
                escapeNext = true;
                continue;
            }
            
            if (char === '"' && !escapeNext) {
                inString = !inString;
                continue;
            }
            
            if (inString) continue;
            
            if (char === '{') {
                braceCount++;
            } else if (char === '}') {
                braceCount--;
                if (braceCount === 0) {
                    lastCompleteIndex = i;
                }
            }
        }
        
        if (lastCompleteIndex > 0) {
            // Обрезаем до последнего полного объекта и закрываем массив
            fixed = fixed.substring(0, lastCompleteIndex + 1);
            // Убираем возможную запятую в конце
            fixed = fixed.replace(/,\s*$/, '');
            fixed = fixed + ']';
        }
    } else if (fixed.startsWith('{')) {
        // Объект с routes
        // Ищем последний полный waypoint или route
        let lastCompleteIndex = fixed.lastIndexOf('}');
        if (lastCompleteIndex > 0) {
            fixed = fixed.substring(0, lastCompleteIndex + 1);
            
            // Проверяем, нужно ли закрыть массивы и объекты
            let openBraces = (fixed.match(/{/g) || []).length;
            let closeBraces = (fixed.match(/}/g) || []).length;
            let openBrackets = (fixed.match(/\[/g) || []).length;
            let closeBrackets = (fixed.match(/]/g) || []).length;
            
            // Убираем запятую в конце
            fixed = fixed.replace(/,\s*$/, '');
            
            // Закрываем недостающие скобки
            while (closeBrackets < openBrackets) {
                fixed += ']';
                closeBrackets++;
            }
            while (closeBraces < openBraces) {
                fixed += '}';
                closeBraces++;
            }
        }
    }
    
    return fixed;
}

// Задержка для retry
function delay(ms) {
    return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

// --- API ФУНКЦИИ ---
async function fetchAI(systemPrompt, userQuery, retryCount) {
    retryCount = retryCount || 0;
    const maxRetries = 3;
    
    const model = getCurrentModel();
    let apiUrl, requestBody;
    const fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } };
    
    if (currentApiMode === 'mapruapp') {
        apiUrl = MAPRUAPP_PROXY_BASE_URL + '/ai/api/v1/chat/completions';
        requestBody = { 
            model: currentModelId, 
            messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userQuery}], 
            max_tokens: 16000 
        };
    } else if (currentApiMode === 'vercel') {
        if (model.apiType === 'gemini') {
            apiUrl = VERCEL_PROXY_BASE_URL + '/v1beta/models/' + currentModelId + ':generateContent';
            requestBody = { 
                contents: [{ role: 'user', parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{text: systemPrompt}] },
                generationConfig: { maxOutputTokens: 16000 }
            };
        } else if (model.apiType === 'openrouter') {
            apiUrl = VERCEL_PROXY_BASE_URL + '/proxy/openrouter/api/v1/chat/completions';
            requestBody = { 
                model: currentModelId, 
                messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userQuery}], 
                max_tokens: 16000 
            };
        } else if (model.apiType === 'mistral') {
            apiUrl = VERCEL_PROXY_BASE_URL + '/proxy/mistral/v1/chat/completions';
            requestBody = { 
                model: currentModelId, 
                messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userQuery}], 
                max_tokens: 16000 
            };
        }
    } else if (currentApiMode === 'direct') {
        apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/' + currentModelId + ':generateContent?key=' + geminiApiKey;
        requestBody = { 
            contents: [{ role: 'user', parts: [{ text: userQuery }] }], 
            systemInstruction: { parts: [{text: systemPrompt}] },
            generationConfig: { maxOutputTokens: 16000 }
        };
    } else if (currentApiMode === 'direct_mistral') {
        apiUrl = 'https://api.mistral.ai/v1/chat/completions';
        fetchOptions.headers['Authorization'] = 'Bearer ' + mistralApiKey;
        requestBody = { 
            model: currentModelId, 
            messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userQuery}], 
            max_tokens: 16000 
        };
    }
    
    fetchOptions.body = JSON.stringify(requestBody);
    
    let response;
    try {
        response = await fetch(apiUrl, fetchOptions);
    } catch (networkError) {
        throw new Error('Сетевая ошибка: ' + networkError.message);
    }
    
    // Обработка rate limiting с retry
    if (response.status === 429) {
        if (retryCount < maxRetries) {
            // Пытаемся извлечь время ожидания из ответа
            let waitTime = 5000 * (retryCount + 1); // базовое время с экспоненциальным ростом
            
            try {
                const errorData = await response.json();
                const errorMsg = errorData.error && errorData.error.message || '';
                // Ищем время в сообщении об ошибке (например: "Please retry in 37.208198551s")
                const timeMatch = errorMsg.match(/retry in (\d+\.?\d*)/i);
                if (timeMatch) {
                    waitTime = Math.ceil(parseFloat(timeMatch[1]) * 1000) + 1000; // +1 сек запас
                }
            } catch (e) {
                // Игнорируем ошибки парсинга
            }
            
            console.log('Rate limit, ожидание ' + (waitTime/1000) + ' сек, попытка ' + (retryCount + 1) + '/' + maxRetries);
            await delay(waitTime);
            return fetchAI(systemPrompt, userQuery, retryCount + 1);
        } else {
            throw new Error('Превышен лимит запросов. Попробуйте позже или смените модель/режим.');
        }
    }
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error('Ошибка ' + response.status + ': ' + errorText.substring(0, 200));
    }
    
    const data = await response.json();
    
    let aiResponseText;
    
    // Парсинг ответа в зависимости от API
    if (currentApiMode === 'mapruapp' || currentApiMode === 'direct_mistral' || 
        (currentApiMode === 'vercel' && (model.apiType === 'openrouter' || model.apiType === 'mistral'))) {
        aiResponseText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    } else if (model.apiType === 'gemini' || currentApiMode === 'direct') {
        aiResponseText = data.candidates && data.candidates[0] && data.candidates[0].content && 
                        data.candidates[0].content.parts && data.candidates[0].content.parts[0] && 
                        data.candidates[0].content.parts[0].text;
    }
    
    if (!aiResponseText) throw new Error('AI вернул пустой ответ.');
    
    if (systemPrompt.includes("JSON")) {
        let cleanedJsonString = aiResponseText.replace(/^```json\s*|```\s*$/g, '').trim();
        
        // Первая попытка парсинга
        try {
            return JSON.parse(cleanedJsonString);
        } catch (e) {
            console.warn("Первая попытка парсинга не удалась, пробуем исправить JSON...");
            
            // Пробуем исправить обрезанный JSON
            try {
                const fixedJson = tryFixTruncatedJson(cleanedJsonString);
                console.log("Исправленный JSON:", fixedJson.substring(0, 200) + "...");
                const parsed = JSON.parse(fixedJson);
                console.log("JSON успешно исправлен!");
                return parsed;
            } catch (e2) {
                console.error("Не удалось исправить JSON:", e2);
                console.error("Оригинальная строка (первые 500 символов):", cleanedJsonString.substring(0, 500));
                throw new Error('AI вернул некорректный JSON. Попробуйте повторить запрос.');
            }
        }
    } else {
        return aiResponseText;
    }
}

async function searchWikipedia(query) {
    const url = WIKI_API_URL + '?action=query&list=search&srsearch=' + encodeURIComponent(query) + '&format=json&origin=*&srlimit=15';
    const response = await fetch(url);
    if (!response.ok) throw new Error("Ошибка поиска в Википедии");
    const data = await response.json();
    return data.query.search.map(function(item) {
        return {
            title: item.title,
            snippet: item.snippet.replace(/<[^>]*>/g, '')
        };
    });
}

async function getWikipediaContent(title) {
    const url = WIKI_API_URL + '?action=query&prop=extracts&explaintext=1&titles=' + encodeURIComponent(title) + '&format=json&origin=*';
    const response = await fetch(url);
    if (!response.ok) throw new Error("Ошибка получения статьи Википедии");
    const data = await response.json();
    const pages = data.query.pages;
    const pageId = Object.keys(pages)[0];
    if (pageId === "-1") throw new Error("Статья не найдена");
    return pages[pageId].extract;
}

// --- ФУНКЦИИ WIKIPEDIA ---
function displayWikiSearchResults(results, query) {
    isWikiSelectionMode = true;
    sidePanel.classList.add('visible');
    panelTitle.textContent = 'Поиск: "' + query + '"';
    
    document.querySelector('[data-tab="places"]').classList.add('active');
    document.querySelector('[data-tab="routes"]').classList.remove('active');
    placesContent.classList.add('active');
    routesContent.classList.remove('active');
    
    placesContent.innerHTML = 
        '<div class="wiki-search-header">' +
            '<i class="fab fa-wikipedia-w"></i>' +
            '<h4>Найдено статей: ' + results.length + '</h4>' +
            '<p>Выберите статью для анализа</p>' +
        '</div>';
    
    results.forEach(function(result) {
        const item = document.createElement('div');
        item.className = 'wiki-article-item';
        item.innerHTML = '<i class="fas fa-file-alt"></i><span>' + result.title + '</span>';
        item.addEventListener('click', function() {
            isWikiSelectionMode = false;
            processWikiArticle(result.title);
        });
        placesContent.appendChild(item);
    });
    
    const cancelBtn = document.createElement('div');
    cancelBtn.className = 'wiki-cancel-btn';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Отменить поиск';
    cancelBtn.addEventListener('click', function() {
        isWikiSelectionMode = false;
        sidePanel.classList.remove('visible');
        placesContent.innerHTML = 
            '<div id="panel-welcome">' +
                '<i class="fas fa-globe-europe"></i>' +
                '<h3>Исследователь</h3>' +
                '<p>Введите имя исторической личности, событие или объект, чтобы увидеть связанные с ним места и маршруты на карте.</p>' +
            '</div>';
    });
    placesContent.appendChild(cancelBtn);
    
    routesContent.innerHTML = '<div id="panel-welcome"><p>Сначала выберите статью из списка.</p></div>';
}


function cleanWikiText(text) {
    const stopSections = [
        'Примечания',
        'Литература',
        'Ссылки',
        'См. также',
        'Источники',
        'Библиография'
    ];

    let cutIndex = text.length;

    stopSections.forEach(section => {
        const regex = new RegExp(`\\n\\s*==+\\s*${section}\\s*==+`, 'i');
        const match = text.match(regex);
        
        if (match && match.index < cutIndex) {
            cutIndex = match.index;
        }
    });

    return text.substring(0, cutIndex).trim();
}


function renderBookLoader(container, status, stats) {
    const statsHtml = stats ? 
        '<div class="loader-stats">' +
            (stats.chars ? '<div class="loader-stat-item"><span class="loader-stat-label"><i class="fas fa-book-open"></i> Извлечено символов</span><span class="loader-stat-value">' + stats.chars.toLocaleString() + '</span></div>' : '') +
            (stats.words ? '<div class="loader-stat-item"><span class="loader-stat-label"><i class="fas fa-align-left"></i> Извлечено слов</span><span class="loader-stat-value">' + stats.words.toLocaleString() + '</span></div>' : '') +
            (stats.tokens ? '<div class="loader-stat-item"><span class="loader-stat-label"><i class="fas fa-microchip"></i> Отправлено токенов</span><span class="loader-stat-value">~' + stats.tokens.toLocaleString() + '</span></div>' : '') +
        '</div>' : '';
    
    container.innerHTML = 
        '<div class="panel-loader-book">' +
            '<div class="book">' +
                '<div class="inner">' +
                    '<div class="left"></div>' +
                    '<div class="middle"></div>' +
                    '<div class="right"></div>' +
                '</div>' +
                '<ul>' +
                    '<li></li><li></li><li></li><li></li><li></li><li></li>' +
                    '<li></li><li></li><li></li><li></li><li></li><li></li>' +
                    '<li></li><li></li><li></li><li></li><li></li><li></li>' +
                '</ul>' +
            '</div>' +
            '<div class="loader-status">' + status + '</div>' +
            statsHtml +
        '</div>';
}


async function processWikiArticle(title, forceRefresh = false) {
    isProcessing = true;
    wikiButton.disabled = true;
    wikiButton.innerHTML = '<div class="loader-dark"></div>';
    
    document.querySelector('.tab-btn[data-tab="places"]').innerHTML = '<i class="fas fa-map-marker-alt"></i> Места';
    document.querySelector('.tab-btn[data-tab="routes"]').innerHTML = '<i class="fas fa-route"></i> Маршруты';
    
    clearMap();
    hideDetailsPanel();
    
    const wikiUrl = 'https://ru.wikipedia.org/wiki/' + encodeURIComponent(title);
    
    panelTitle.innerHTML = 
        '<div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">' +
            '<div style="display: flex; align-items: center; overflow: hidden;">' +
                '<button id="refresh-wiki-btn" style="background: none; border: none; cursor: pointer; padding: 4px 8px; margin-right: 8px; color: #64748b; transition: all 0.2s; border-radius: 6px;" title="Обновить данные из Wikipedia">' +
                    '<i class="fab fa-wikipedia-w" style="font-size: 1.2em;"></i>' +
                '</button>' +
                '<span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px;" title="' + title + '">' + title + '</span>' +
            '</div>' +
            '<a href="' + wikiUrl + '" target="_blank" rel="noopener noreferrer" title="Читать статью на Википедии" ' +
               'style="flex-shrink: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; ' +
                      'background: #f1f5f9; border-radius: 50%; color: #3b82f6; text-decoration: none; ' +
                      'border: 1px solid #e2e8f0; transition: all 0.2s;" ' +
               'onmouseover="this.style.background=\'#dbeafe\'; this.style.color=\'#1d4ed8\';" ' +
               'onmouseout="this.style.background=\'#f1f5f9\'; this.style.color=\'#3b82f6\';">' +
                '<i class="fas fa-external-link-alt" style="font-size: 14px;"></i>' +
            '</a>' +
        '</div>';
    
    const refreshBtn = document.getElementById('refresh-wiki-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('mouseenter', function() {
            this.style.background = '#e0f2fe';
            this.style.color = '#0284c7';
        });
        refreshBtn.addEventListener('mouseleave', function() {
            this.style.background = 'none';
            this.style.color = '#64748b';
        });
        refreshBtn.addEventListener('click', function() {
            processWikiArticle(title, true);
        });
    }
    
    if (!sidePanel.classList.contains('visible')) {
        sidePanel.classList.add('visible');
    }
    
    if (!forceRefresh) {
        renderBookLoader(placesContent, "Проверка кэша", null);
        renderBookLoader(routesContent, "Проверка кэша", null);
        
        const cachedArticle = await getArticleFromCache(title);
        
        if (cachedArticle && cachedArticle.places && cachedArticle.routes) {
            console.log('📦 Загружено из кэша:', title);
            
            displayPlaces(cachedArticle.places);
            showAllPlacesOnMap();
            displayRoutes(cachedArticle.routes);
            
            isProcessing = false;
            wikiButton.disabled = false;
            wikiButton.innerHTML = '<i class="fab fa-wikipedia-w"></i>';
            return;
        }
    }
    
    renderBookLoader(placesContent, forceRefresh ? "Обновление статьи из Wikipedia" : "Загрузка статьи из Wikipedia", null);
    renderBookLoader(routesContent, forceRefresh ? "Обновление статьи из Wikipedia" : "Загрузка статьи из Wikipedia", null);
    
    try {
        const rawArticleText = await getWikipediaContent(title);
        const cleanedText = cleanWikiText(rawArticleText);
        
        const originalCharCount = rawArticleText.length;
        const cleanedCharCount = cleanedText.length;
        const LIMIT_CHARS = 50000;
        
        const truncatedText = cleanedText.substring(0, LIMIT_CHARS);
        const analysisPrompt = 'Статья: "' + title + '". Текст статьи: \n' + truncatedText;
        
        const requestCharCount = analysisPrompt.length;
        const estimatedTokens = Math.ceil(requestCharCount / 4);
        const words = truncatedText.split(/\s+/).length;

        console.group('%c 🕵️‍♂️ Debug: Wiki & AI Stats', 'background: #222; color: #bada55; padding: 4px; border-radius: 4px;');
        console.log('📄 Статья: "' + title + '"');
        console.log('🗑️ Было символов:     ' + originalCharCount);
        console.log('✨ Стало после чистки: ' + cleanedCharCount + ' (удалено : ' + (originalCharCount - cleanedCharCount) + ')');
        console.log('✂️ Лимит обрезки:      ' + LIMIT_CHARS);
        console.log('🤖 Отправлено в AI:    %c' + truncatedText.length + ' символов', 'color: cyan');
        console.log('🪙 Примерно токенов:     %c~' + estimatedTokens, 'background: #333; color: white; padding: 2px 5px; border-radius: 3px;');
        console.groupEnd();
        
        renderBookLoader(placesContent, "Извлечение географических мест", { chars: truncatedText.length, words: words, tokens: estimatedTokens });
        renderBookLoader(routesContent, "Поиск исторических маршрутов", { chars: truncatedText.length, words: words, tokens: estimatedTokens });
        
        let placesResult, routesResult;
        
        try {
            const places = await fetchAI(AI_PROMPT_WIKI_EXTRACTOR_PLACES, analysisPrompt);
            placesResult = { status: 'fulfilled', value: places };
        } catch (e) {
            placesResult = { status: 'rejected', reason: e };
        }
        
        await delay(1000);
        
        try {
            const routes = await fetchAI(AI_PROMPT_WIKI_EXTRACTOR_ROUTES, analysisPrompt);
            routesResult = { status: 'fulfilled', value: routes };
        } catch (e) {
            routesResult = { status: 'rejected', reason: e };
        }
        
        if (placesResult.status === 'fulfilled') {
            displayPlaces(placesResult.value);
            showAllPlacesOnMap();
        } else {
            renderError(placesContent, 'Не удалось извлечь места: <br><small>' + placesResult.reason.message + '</small>');
        }
        
        if (routesResult.status === 'fulfilled') {
            displayRoutes(routesResult.value);
        } else {
            renderError(routesContent, 'Не удалось извлечь маршруты: <br><small>' + routesResult.reason.message + '</small>');
        }
        
        if (placesResult.status === 'fulfilled' && routesResult.status === 'fulfilled') {
            if (forceRefresh) {
                await updateArticleInCache(title, placesResult.value, routesResult.value);
            } else {
                await saveArticleToCache(title, placesResult.value, routesResult.value);
            }
        }

    } catch (error) {
        console.error("Critical error in processWikiArticle:", error);
        renderError(placesContent, 'Ошибка обработки статьи: ' + error.message);
        renderError(routesContent, 'Ошибка обработки статьи: ' + error.message);
    } finally {
        isProcessing = false;
        wikiButton.disabled = false;
        wikiButton.innerHTML = '<i class="fab fa-wikipedia-w"></i>';
    }
}

// --- ОБРАБОТЧИКИ СОБЫТИЙ ---
async function handleWikiSearch() {
    const query = queryInput.value.trim();
    if (!query || isProcessing) return;

    isProcessing = true;
    wikiButton.disabled = true;
    wikiButton.innerHTML = '<div class="loader-dark"></div>';
    
    clearMap();
    hideDetailsPanel();
    sidePanel.classList.remove('visible');
    
    try {
        const searchResults = await searchWikipedia(query);

        if (searchResults.length === 0) {
            sidePanel.classList.add('visible');
            panelTitle.textContent = 'Результаты';
            renderError(placesContent, "Статьи в Википедии по такому запросу не найдены.");
            routesContent.innerHTML = '';
        } else {
            displayWikiSearchResults(searchResults, query);
        }

    } catch (error) {
        sidePanel.classList.add('visible');
        renderError(placesContent, 'Ошибка поиска в Wikipedia: ' + error.message);
    } finally {
        isProcessing = false;
        wikiButton.disabled = false;
        wikiButton.innerHTML = '<i class="fab fa-wikipedia-w"></i>';
    }
}

async function handleRequest() {
    const query = queryInput.value.trim();
    if (!query || isProcessing) return;

    isProcessing = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<div class="loader"></div>';
    
     document.querySelector('.tab-btn[data-tab="places"]').innerHTML = '<i class="fas fa-map-marker-alt"></i> Места';
    document.querySelector('.tab-btn[data-tab="routes"]').innerHTML = '<i class="fas fa-route"></i> Маршруты';
    
    clearMap();
    hideDetailsPanel();
    sidePanel.classList.remove('visible');
    placesContent.innerHTML = '';
    routesContent.innerHTML = '';

    try {
        sidePanel.classList.add('visible');
        panelTitle.textContent = 'Результаты: "' + query + '"';
        
        renderLoader(placesContent, "Поиск мест...");
        renderLoader(routesContent, "Поиск маршрутов...");
        
        const [placesResult, routesResult] = await Promise.allSettled([
            fetchAI(AI_SYSTEM_PROMPT_PLACES, query),
            fetchAI(AI_SYSTEM_PROMPT_ROUTES, query)
        ]);
        
        if (placesResult.status === 'fulfilled') {
            displayPlaces(placesResult.value);
            showAllPlacesOnMap();
        } else {
            renderError(placesContent, 'Не удалось загрузить места: <br><small>' + placesResult.reason.message + '</small>');
        }

        if (routesResult.status === 'fulfilled') {
            displayRoutes(routesResult.value);
        } else {
            renderError(routesContent, 'Не удалось загрузить маршруты: <br><small>' + routesResult.reason.message + '</small>');
        }

    } catch (error) {
        sidePanel.classList.add('visible');
        renderError(placesContent, 'Произошла непредвиденная ошибка: ' + error.message);
    } finally {
        isProcessing = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
}

// --- ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ---
document.addEventListener('DOMContentLoaded', function() {
    initSelectors();
    loadSettings();

    // Обработчики кнопок
    sendButton.addEventListener('click', function(e) {
        e.preventDefault();
        if (!isProcessing) handleRequest();
    });
    
    wikiButton.addEventListener('click', function(e) {
        e.preventDefault();
        if (!isProcessing) handleWikiSearch();
    });
    
    queryInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !isProcessing) {
            e.preventDefault();
            handleRequest();
        }
    });
    
    detailCloseBtn.addEventListener('click', hideDetailsPanel);
    
    // Табы
    tabButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            if (isWikiSelectionMode) return;
            
            tabButtons.forEach(function(btn) { btn.classList.remove('active'); });
            tabContents.forEach(function(content) { content.classList.remove('active'); });
            button.classList.add('active');
            document.getElementById(button.dataset.tab + '-content').classList.add('active');
            hideDetailsPanel();
            if (button.dataset.tab === 'places') showAllPlacesOnMap();
            else if (button.dataset.tab === 'routes') clearMap();
        });
    });

    // Настройки
    settingsBtn.addEventListener('click', openSettingsModal);
    saveSettingsBtn.addEventListener('click', saveSettings);
    settingsModalOverlay.addEventListener('click', function(e) { if (e.target === settingsModalOverlay) closeSettingsModal(); });
    
    apiModeSelector.addEventListener('change', function() { 
        currentApiMode = apiModeSelector.value; 
        updateApiKeyInputVisibility(); 
    });
    
    modelSelector.addEventListener('change', function() { 
        currentModelId = modelSelector.value;
    });
    
    // Хак для отключения автозаполнения
    setTimeout(function() {
        queryInput.setAttribute('autocomplete', 'off');
        queryInput.setAttribute('readonly', 'readonly');
        setTimeout(function() { queryInput.removeAttribute('readonly'); }, 100);
    }, 100);
});

// Инициализация Яндекс.Карт
ymaps.ready(function() {
    try {
        currentMapObjects = new ymaps.GeoObjectCollection({}, {});
        placesGeoCollection = new ymaps.GeoObjectCollection({}, {});
        initMap();
        initSupabase();
    } catch (error) {
        console.error("Ошибка инициализации карты:", error);
    }
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица</title>
    <link rel="icon" href="https://i.ibb.co/B28zDrny/excel.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #217346;
            --primary-hover: #1e5c39;
            --primary-light: #e8f5e9;
            --header-bg: #217346;
            --header-text: #ffffff;
            --row-even: #fafafa;
            --row-hover: #f0f7f0;
            --border-color: #e5e5e5;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #007aff;
            --danger-color: #ff3b30;
            --danger-hover: #d70015;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-secondary);
            user-select: none;
            font-size: 14px;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        .ribbon {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .ribbon-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 4px 8px;
            border-right: 1px solid var(--border-color);
        }
        
        .ribbon-group:last-child {
            border-right: none;
        }
        
        .ribbon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            font-size: 11px;
            color: var(--text-primary);
            transition: all 0.2s ease;
            min-width: 56px;
        }
        
        .ribbon-btn:hover {
            background: var(--bg-secondary);
        }
        
        .ribbon-btn:active {
            background: var(--border-color);
            transform: scale(0.97);
        }
        
        .ribbon-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .ribbon-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color);
        }
        
        .ribbon-btn#ai-btn svg {
            fill: var(--accent-blue);
        }
        
        .ribbon-btn#ai-btn:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .ribbon-btn-toggle.active {
            background: var(--primary-light);
        }
        
        #file-input {
            display: none;
        }
        
        .table-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 8px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .table-header-container {
            flex-shrink: 0;
            overflow: hidden;
            background: var(--header-bg);
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }
        
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            min-width: 80px;
        }
        
        th {
            background: var(--header-bg);
            color: var(--header-text);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-color: rgba(255,255,255,0.15);
        }
        
        th .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        th .header-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .sort-icon, .filter-icon {
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .sort-icon:hover, .filter-icon:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
        }
        
        .sort-icon.asc::after { content: '▲'; font-size: 10px; }
        .sort-icon.desc::after { content: '▼'; font-size: 10px; }
        .sort-icon:not(.asc):not(.desc)::after { content: '⇅'; font-size: 11px; opacity: 0.5; }
        .filter-icon::after { content: '▼'; font-size: 8px; }
        .filter-icon.active { color: #ffd700; opacity: 1; }
        
        tbody tr {
            transition: background-color 0.15s ease;
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--row-even);
        }
        
        tbody tr:hover {
            background-color: var(--row-hover);
        }
        
        tbody tr.selected {
            background-color: #d4edda !important;
        }
        
        td {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        td.editing {
            padding: 2px;
        }
        
        td.editing input {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }
        
        .row-number, th.row-number, td.row-number {
            width: 50px !important;
            min-width: 50px !important;
            max-width: 50px !important;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            text-align: center;
            border-right: 2px solid var(--border-color);
            font-size: 11px;
        }
        
        th.row-number {
            background: rgba(0,0,0,0.1);
        }
        
        .status-bar {
            background: var(--bg-primary);
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        #sheet-selector {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-primary);
        }
        
        #filter-input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            width: 200px;
            background: var(--bg-primary);
            transition: all 0.2s;
        }
        
        #filter-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(14px);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 40px;
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .empty-state h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .empty-state-btn {
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .empty-state-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        
        .loader-overlay.active {
            display: flex;
        }
        
        .loader-spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader-text {
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .loader-progress {
            width: 280px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            min-width: 380px;
            max-width: 90vw;
            max-height: 85vh;
            overflow: hidden;
            flex-direction: column;
        }
        
        .dialog-header {
            padding: 16px 20px;
            background: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .dialog-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .dialog-footer {
            padding: 14px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dialog-btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .dialog-btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .dialog-btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .dialog-btn-secondary:hover {
            background: var(--bg-secondary);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-radio, .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .form-radio input, .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .preview-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            max-height: 140px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }
        
        .context-menu {
            display: none;
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            padding: 6px 0;
            min-width: 180px;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.1s;
        }
        
        .context-menu-item:hover {
            background: var(--bg-secondary);
        }
        
        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 6px 0;
        }
        
        .column-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .column-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .column-list-item:last-child { border-bottom: none; }
        .column-list-item:hover { background: var(--bg-secondary); }
        
        .column-list-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .column-list-actions button {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }
        
        .column-list-actions button:hover {
            background: var(--bg-secondary);
        }
        
        .hidden-columns-badge {
            background: var(--warning-color);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .filter-dropdown {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            width: 280px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .filter-dropdown-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filter-dropdown-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .filter-dropdown-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            max-height: 240px;
        }
        
        .filter-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .filter-dropdown-item:hover { background: var(--bg-secondary); }
        
        .filter-dropdown-item.select-all {
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            padding-bottom: 12px;
        }
        
        .filter-dropdown-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .filter-dropdown-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .filter-dropdown-footer .btn-apply {
            background: var(--primary-color);
            color: white;
        }
        
        .filter-dropdown-footer .btn-reset {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .column-resizer {
            position: absolute;
            top: 0;
            right: -4px;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
        }
        
        .column-resizer:hover { background: rgba(255,255,255,0.3); }
        
        .resize-line {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent-blue);
            z-index: 9999;
            pointer-events: none;
            display: none;
        }
        
        .table-container.manual-width table { table-layout: fixed; width: max-content; min-width: 100%; }
        .table-container.manual-width th:not(.row-number),
        .table-container.manual-width td:not(.row-number) { min-width: 40px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .ai-panel {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 440px;
            max-height: 600px;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            z-index: 1500;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .ai-panel.active { display: flex; }
        
        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
        }
        
        .ai-panel-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .ai-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .ai-panel-close:hover { background: rgba(255,255,255,0.3); }
        
        .ai-panel-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .ai-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 180px;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
            background: var(--bg-primary);
        }
        
        .ai-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .ai-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .ai-checkbox-group input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }
        
        .ai-checkbox-group span { font-size: 14px; }
        .ai-checkbox-group small { font-size: 12px; color: var(--text-secondary); margin-left: auto; }
        
        .ai-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .ai-example-btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-example-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .ai-settings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-settings-toggle:hover {
            background: var(--bg-secondary);
            color: var(--accent-blue);
        }
        
        .ai-settings-panel {
            display: none;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .ai-settings-panel.active { display: block; }
        
        .ai-settings-panel .form-group { margin-bottom: 14px; }
        .ai-settings-panel .form-group:last-child { margin-bottom: 0; }
        .ai-settings-panel label { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        
        .ai-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            color: var(--text-secondary);
        }
        
        .ai-loading.active { display: flex; }
        .ai-loading i { font-size: 20px; color: var(--accent-blue); }
        
        .ai-response-area {
            display: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            max-height: 180px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .ai-response-area.active { display: block; }
        .ai-response-area.error { background: #fff2f2; color: #d00; border: 1px solid #ffcdd2; }
        .ai-response-area.success { background: #f0fff4; color: #1b7a1b; border: 1px solid #a5d6a7; }
        
        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }
        
        .ai-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .ai-btn-primary {
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
        }
        
        .ai-btn-primary:hover { box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4); transform: translateY(-1px); }
        .ai-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .ai-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .ai-btn-secondary:hover { background: var(--border-color); }
        
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: fa-spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="container">
        <div class="ribbon">
            <div class="ribbon-group">
                <button class="ribbon-btn" id="open-btn" title="Открыть файл (Ctrl+O)">
                    <svg viewBox="0 0 24 24"><path d="M19 20H5c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h6l2 2h6c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2z"/></svg>
                    <span>Открыть</span>
                </button>
                <button class="ribbon-btn" id="save-btn" title="Сохранить (Ctrl+S)">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    <span>Сохранить</span>
                </button>
                <button class="ribbon-btn" id="save-as-btn" title="Сохранить как...">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    <span>Сохр. как</span>
                </button>
            </div>
            <div class="ribbon-group">
                <button class="ribbon-btn" id="create-btn" title="Создать (Ctrl+N)">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <span>Создать</span>
                </button>
                <button class="ribbon-btn ribbon-btn-toggle active" id="autosize-btn" title="Авторазмер">
                    <svg viewBox="0 0 24 24"><path d="M4 11h6V9H4v2zm0 4h6v-2H4v2zm0 4h6v-2H4v2zm16-4h-6v2h6v-2zm-6-8v2h6V7h-6zm6 8h-6v2h6v-2zM11 7h2v10h-2z"/></svg>
                    <span>Авторазмер</span>
                </button>
            </div>
            <div class="ribbon-group">
                <button class="ribbon-btn" id="undo-btn" title="Отменить (Ctrl+Z)">
                    <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05 1.04-6.93 2.73L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                    <span>Отменить</span>
                </button>
                <button class="ribbon-btn" id="redo-btn" title="Повторить (Ctrl+Y)">
                    <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                    <span>Повторить</span>
                </button>
            </div>
            <div class="ribbon-group">
                <button class="ribbon-btn" id="columns-btn" title="Столбцы">
                    <svg viewBox="0 0 24 24"><path d="M10 18h5V5h-5v13zm-6 0h5V5H4v13zM16 5v13h5V5h-5z"/></svg>
                    <span>Столбцы</span>
                </button>
                <button class="ribbon-btn" id="sort-btn" title="Сброс сортировки">
                    <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></svg>
                    <span>Сортировка</span>
                </button>
            </div>
            <div class="ribbon-group">
                <button class="ribbon-btn" id="ai-btn" title="AI Помощник">
                    <svg viewBox="0 0 24 24" style="fill: #007aff;"><circle cx="12" cy="12" r="3"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5" transform="rotate(60 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5" transform="rotate(-60 12 12)"/></svg>
                    <span>AI</span>
                </button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept=".csv,.txt,.xlsx">
        
        <div class="table-wrapper">
            <div class="empty-state" id="empty-state">
                <img src="https://i.ibb.co/B28zDrny/excel.png" alt="Excel" class="empty-state-icon">
                <h2>Нет открытых файлов</h2>
                <p>Нажмите, чтобы открыть CSV, TXT или Excel файл</p>
                <button class="empty-state-btn" id="open-file-btn">Открыть файл</button>
            </div>
            <div class="table-header-container" id="table-header-container" style="display: none;">
                <table id="header-table"><thead><tr id="header-row"></tr></thead></table>
            </div>
            <div class="table-container" id="table-container" style="display: none;">
                <div class="virtual-scroll-container" id="virtual-scroll-container">
                    <div class="virtual-scroll-content" id="virtual-scroll-content">
                        <table id="data-table"><tbody id="table-body"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-bar-left">
                <select id="sheet-selector" style="display: none;"></select>
                <span id="status-message">Готов</span>
                <span id="hidden-columns-indicator" style="display: none;">
                    <span class="hidden-columns-badge" id="hidden-columns-count">0 скрыто</span>
                </span>
            </div>
            <div class="status-bar-right">
                <div class="filter-bar">
                    <input type="text" id="filter-input" placeholder="Поиск...">
                    <div class="filter-mode-toggle" style="display:flex;align-items:center;gap:6px;font-size:12px;">
                        <span>ячейка</span>
                        <label class="switch"><input type="checkbox" id="filter-mode-toggle"><span class="slider"></span></label>
                        <span>строка</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loader-overlay" id="loader-overlay">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">Загрузка...</div>
        <div class="loader-progress"><div class="loader-progress-bar" id="loader-progress-bar"></div></div>
        <div class="loader-details" id="loader-details"></div>
    </div>
    
    <div class="dialog-overlay" id="dialog-overlay"></div>
    
    <div class="dialog" id="separator-dialog" style="display: none;">
        <div class="dialog-header">Параметры импорта</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Разделитель</label>
                <div class="form-radio-group">
                    <label class="form-radio"><input type="radio" name="separator" value=","> Запятая (,)</label>
                    <label class="form-radio"><input type="radio" name="separator" value=";" checked> Точка с запятой (;)</label>
                    <label class="form-radio"><input type="radio" name="separator" value="\t"> Табуляция</label>
                    <label class="form-radio"><input type="radio" name="separator" value=" "> Пробел</label>
                    <label class="form-radio"><input type="radio" name="separator" value="custom"> Другой: <input type="text" id="custom-separator" style="width:50px;margin-left:8px;" maxlength="1"></label>
                </div>
            </div>
            <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="first-row-header" checked> Первая строка — заголовки</label></div>
            <div class="form-group">
                <label>Кодировка</label>
                <select id="encoding-select"><option value="utf-8" selected>UTF-8</option><option value="windows-1251">Windows-1251</option></select>
            </div>
            <div class="preview-box" id="preview"></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="separator-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="separator-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="save-dialog" style="display: none;">
        <div class="dialog-header">Сохранить файл</div>
        <div class="dialog-body">
            <div class="form-group"><label>Формат</label><select id="save-format"><option value="csv">CSV</option><option value="txt">TXT</option><option value="xlsx">Excel (XLSX)</option></select></div>
            <div class="form-group" id="save-separator-group"><label>Разделитель</label><select id="save-separator"><option value=";">Точка с запятой</option><option value=",">Запятая</option><option value="\t">Табуляция</option></select></div>
            <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="save-visible-only"> Только видимые столбцы</label></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="save-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="save-confirm">Сохранить</button>
        </div>
    </div>
    
    <div class="dialog" id="rename-dialog" style="display: none;">
        <div class="dialog-header">Переименовать столбец</div>
        <div class="dialog-body"><div class="form-group"><label>Новое название</label><input type="text" id="rename-input"></div></div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="rename-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="rename-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="columns-dialog" style="display: none;">
        <div class="dialog-header">Скрыть/показать столбцы</div>
        <div class="dialog-body">
            <div class="column-list-actions"><button id="columns-show-all">Показать все</button><button id="columns-hide-all">Скрыть все</button><button id="columns-invert">Инвертировать</button></div>
            <div class="column-list" id="column-list"></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="columns-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="columns-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="move-column-dialog" style="display: none;">
        <div class="dialog-header">Переместить столбец</div>
        <div class="dialog-body"><div class="form-group"><label>Переместить перед:</label><select id="move-column-select"></select></div></div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="move-column-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="move-column-confirm">Переместить</button>
        </div>
    </div>
    
    <div class="dialog" id="move-row-dialog" style="display: none;">
        <div class="dialog-header">Переместить строку</div>
        <div class="dialog-body"><div class="form-group"><label>Переместить перед строкой:</label><select id="move-row-select"></select></div></div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="move-row-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="move-row-confirm">Переместить</button>
        </div>
    </div>
    
    <div class="dialog" id="create-dialog" style="display: none;">
        <div class="dialog-header">Создать новый файл</div>
        <div class="dialog-body">
            <div class="form-group"><label>Строк:</label><input type="number" id="create-rows" value="10" min="1" max="100000"></div>
            <div class="form-group"><label>Столбцов:</label><input type="number" id="create-cols" value="5" min="1" max="100"></div>
            <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="create-with-headers" checked> С заголовками</label></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="create-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="create-confirm">Создать</button>
        </div>
    </div>
    
    <div class="dialog" id="replace-empty-dialog" style="display: none;">
        <div class="dialog-header">Заменить пустые</div>
        <div class="dialog-body"><div class="form-group"><label>Заменить на:</label><input type="text" id="replace-empty-input"></div></div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="replace-empty-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="replace-empty-confirm">Применить</button>
        </div>
    </div>
    
    <div class="resize-line" id="resize-line"></div>
    <div class="context-menu" id="context-menu"></div>
    
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
            <h3><i class="fas fa-atom"></i> AI Помощник</h3>
            <button class="ai-panel-close" id="ai-panel-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-panel-body">
            <textarea class="ai-textarea" id="ai-query" placeholder="Опишите задачу для таблицы..."></textarea>
            <label class="ai-checkbox-group">
                <input type="checkbox" id="ai-include-data" checked>
                <span>Отправить данные таблицы</span>
                <small id="ai-data-info">0 строк</small>
            </label>
            <div class="ai-examples">
                <button class="ai-example-btn" data-prompt="Заполни пустые ячейки логичными значениями">Заполнить пустые</button>
                <button class="ai-example-btn" data-prompt="Добавь столбец с категориями">Категории</button>
                <button class="ai-example-btn" data-prompt="Исправь опечатки">Опечатки</button>
                <button class="ai-example-btn" data-prompt="Проанализируй данные">Анализ</button>
            </div>
            <button class="ai-settings-toggle" id="ai-settings-toggle"><i class="fas fa-cog"></i> Настройки</button>
            <div class="ai-settings-panel" id="ai-settings-panel">
                <div class="form-group"><label>Модель</label><select id="ai-model-selector"></select></div>
                <div class="form-group"><label>Режим</label><select id="ai-mode-selector"></select></div>
                <div class="form-group" id="ai-key-group" style="display:none;"><label>API ключ</label><input type="password" id="ai-api-key" placeholder="Ключ..."></div>
            </div>
            <div class="ai-loading" id="ai-loading"><i class="fas fa-spinner fa-spin"></i><span>Обработка...</span></div>
            <div class="ai-response-area" id="ai-response"></div>
            <div class="ai-actions">
                <button class="ai-btn ai-btn-secondary" id="ai-cancel" style="display:none;">Отмена</button>
                <button class="ai-btn ai-btn-primary" id="ai-send"><i class="fas fa-paper-plane"></i> Отправить</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('file-input');
        const emptyState = document.getElementById('empty-state');
        const tableHeaderContainer = document.getElementById('table-header-container');
        const tableContainer = document.getElementById('table-container');
        const virtualScrollContainer = document.getElementById('virtual-scroll-container');
        const virtualScrollContent = document.getElementById('virtual-scroll-content');
        const headerRow = document.getElementById('header-row');
        const tableBody = document.getElementById('table-body');
        const statusMessage = document.getElementById('status-message');
        const sheetSelector = document.getElementById('sheet-selector');
        const filterInput = document.getElementById('filter-input');
        const filterModeToggle = document.getElementById('filter-mode-toggle');
        const dialogOverlay = document.getElementById('dialog-overlay');
        const contextMenu = document.getElementById('context-menu');
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const loaderProgressBar = document.getElementById('loader-progress-bar');
        const loaderDetails = document.getElementById('loader-details');
        const hiddenColumnsIndicator = document.getElementById('hidden-columns-indicator');
        const hiddenColumnsCount = document.getElementById('hidden-columns-count');

        let allData = [];
        let filteredIndices = [];
        let headers = [];
        let hiddenColumns = new Set();
        let activeFilters = {};
        let sortState = { column: null, direction: null };
        let currentSeparator = ';';
        let currentFilename = null;
        let currentFileSize = null;
        let workbook = null;
        let modified = false;
        let autoSizeEnabled = true;
        let columnWidths = {};
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;
        const ROW_HEIGHT = 36;
        const BUFFER_ROWS = 10;
        let visibleStartIndex = 0;
        let visibleEndIndex = 0;
        let contextTarget = { type: null, index: null, rowIndex: null, colIndex: null };

        const savedAutoSize = localStorage.getItem('autoSizeEnabled');
        if (savedAutoSize !== null) autoSizeEnabled = savedAutoSize === 'true';
        const savedWidths = localStorage.getItem('columnWidths');
        if (savedWidths) try { columnWidths = JSON.parse(savedWidths); } catch(e) { columnWidths = {}; }

        function showLoader(text = 'Загрузка...', details = '') {
            loaderText.textContent = text;
            loaderDetails.textContent = details;
            loaderProgressBar.style.width = '0%';
            loaderOverlay.classList.add('active');
        }
        function updateLoader(text, progress, details = '') {
            if (text) loaderText.textContent = text;
            if (details) loaderDetails.textContent = details;
            if (progress !== undefined) loaderProgressBar.style.width = progress + '%';
        }
        function hideLoader() { loaderOverlay.classList.remove('active'); }
        function showDialog(dialogId) { dialogOverlay.style.display = 'block'; document.getElementById(dialogId).style.display = 'flex'; }
        function hideDialog(dialogId) { dialogOverlay.style.display = 'none'; document.getElementById(dialogId).style.display = 'none'; }
        function hideAllDialogs() { dialogOverlay.style.display = 'none'; document.querySelectorAll('.dialog').forEach(d => d.style.display = 'none'); }

        function saveState(action, data) {
            undoStack.push({ action, data, timestamp: Date.now() });
            if (undoStack.length > MAX_HISTORY) undoStack.shift();
            redoStack = [];
            modified = true;
            updateUndoRedoButtons();
        }
        function undo() { if (undoStack.length === 0) return; const state = undoStack.pop(); redoStack.push(state); applyUndo(state); updateUndoRedoButtons(); }
        function redo() { if (redoStack.length === 0) return; const state = redoStack.pop(); undoStack.push(state); applyRedo(state); updateUndoRedoButtons(); }
        function applyUndo(state) {
            switch (state.action) {
                case 'editCell': allData[state.data.row][state.data.col] = state.data.oldValue; break;
                case 'deleteRow': allData.splice(state.data.index, 0, state.data.row); break;
                case 'insertRow': allData.splice(state.data.index, 1); break;
                case 'deleteColumn': headers.splice(state.data.index, 0, state.data.header); allData.forEach((row, i) => row.splice(state.data.index, 0, state.data.values[i])); break;
                case 'insertColumn': headers.splice(state.data.index, 1); allData.forEach(row => row.splice(state.data.index, 1)); break;
                case 'renameColumn': headers[state.data.index] = state.data.oldName; break;
            }
            applyFiltersAndSort(); renderTable(); updateStatus('Отменено');
        }
        function applyRedo(state) {
            switch (state.action) {
                case 'editCell': allData[state.data.row][state.data.col] = state.data.newValue; break;
                case 'deleteRow': allData.splice(state.data.index, 1); break;
                case 'insertRow': allData.splice(state.data.index, 0, state.data.row); break;
                case 'deleteColumn': headers.splice(state.data.index, 1); allData.forEach(row => row.splice(state.data.index, 1)); break;
                case 'insertColumn': headers.splice(state.data.index, 0, state.data.header); allData.forEach((row, i) => row.splice(state.data.index, 0, state.data.values[i])); break;
                case 'renameColumn': headers[state.data.index] = state.data.newName; break;
            }
            applyFiltersAndSort(); renderTable(); updateStatus('Повторено');
        }
        function updateUndoRedoButtons() {
            document.getElementById('undo-btn').classList.toggle('disabled', undoStack.length === 0);
            document.getElementById('redo-btn').classList.toggle('disabled', redoStack.length === 0);
        }

        function processFile(file) {
            if (!file) return;
            const fileName = file.name.toLowerCase();
            currentFilename = file.name;
            currentFileSize = Math.round(file.size / 1024);
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) processExcelFile(file);
            else showSeparatorDialog(file);
        }

        function processExcelFile(file) {
            showLoader('Чтение Excel...', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateLoader('Парсинг...', 30);
                    workbook = XLSX.read(e.target.result, { type: 'array' });
                    sheetSelector.innerHTML = '';
                    workbook.SheetNames.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; sheetSelector.appendChild(option); });
                    sheetSelector.style.display = workbook.SheetNames.length > 1 ? 'inline-block' : 'none';
                    loadSheet(workbook.SheetNames[0]);
                } catch (error) { hideLoader(); alert('Ошибка: ' + error.message); }
            };
            reader.onerror = function() { hideLoader(); alert('Ошибка чтения'); };
            reader.readAsArrayBuffer(file);
        }

        function isEmptyValue(value) { return value === '' || value === null || value === undefined || String(value).trim() === ''; }
        function removeEmptyColumns(hdrs, data) {
            const keep = [];
            for (let c = 0; c < hdrs.length; c++) { for (let r = 0; r < data.length; r++) { if (!isEmptyValue(data[r][c])) { keep.push(c); break; } } }
            return { headers: keep.map(i => hdrs[i]), data: data.map(row => keep.map(i => row[i])), removed: hdrs.length - keep.length };
        }
        function removeEmptyRows(data) { const f = data.filter(row => row.some(cell => !isEmptyValue(cell))); return { data: f, removed: data.length - f.length }; }

        function createNewFile(rows, cols, withHeaders) {
            headers = []; for (let i = 0; i < cols; i++) headers.push(withHeaders ? 'Столбец ' + (i+1) : 'Столбец ' + (i+1));
            allData = []; for (let i = 0; i < rows; i++) { const row = []; for (let j = 0; j < cols; j++) row.push(''); allData.push(row); }
            resetFiltersAndSort(); currentFilename = null; currentFileSize = null; workbook = null; modified = false; undoStack = []; redoStack = [];
            columnWidths = {}; localStorage.removeItem('columnWidths'); initializeTable(); updateStatus('Создан: ' + rows + ' × ' + cols);
        }

        function loadSheet(sheetName) {
            updateLoader('Загрузка: ' + sheetName, 50);
            const ws = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
            if (json.length === 0) { hideLoader(); alert('Лист пуст'); return; }
            let tempHeaders = json[0].map(h => String(h || ''));
            let tempData = json.slice(1);
            updateLoader('Очистка...', 60);
            const rowRes = removeEmptyRows(tempData); tempData = rowRes.data;
            const colRes = removeEmptyColumns(tempHeaders, tempData);
            headers = colRes.headers; tempData = colRes.data;
            if (headers.length === 0 || tempData.length === 0) { hideLoader(); alert('Нет данных'); return; }
            allData = [];
            processDataChunks(tempData, tempData.length, () => {
                resetFiltersAndSort(); initializeTable(); hideLoader();
                updateStatus('Лист "' + sheetName + '" загружен');
            });
        }

        function processDataChunks(rows, total, callback) {
            const CHUNK = 5000; let idx = 0;
            function chunk() {
                const end = Math.min(idx + CHUNK, rows.length);
                for (let i = idx; i < end; i++) { const row = rows[i]; const filled = []; for (let j = 0; j < headers.length; j++) filled.push(row[j] !== undefined ? String(row[j]) : ''); allData.push(filled); }
                idx = end;
                updateLoader('Обработка...', 50 + Math.round((idx/total)*40), idx + ' / ' + total);
                if (idx < rows.length) requestAnimationFrame(chunk); else callback();
            }
            chunk();
        }

        function showSeparatorDialog(file) {
            const preview = document.getElementById('preview');
            const encSel = document.getElementById('encoding-select');
            const reader = new FileReader();
            reader.onload = function(e) { const dec = new TextDecoder(encSel.value); preview.textContent = dec.decode(new Uint8Array(e.target.result)).split(/\r?\n/).slice(0,10).join('\n'); };
            reader.readAsArrayBuffer(file);
            encSel.onchange = () => { const r = new FileReader(); r.onload = function(e) { const d = new TextDecoder(encSel.value); preview.textContent = d.decode(new Uint8Array(e.target.result)).split(/\r?\n/).slice(0,10).join('\n'); }; r.readAsArrayBuffer(file); };
            showDialog('separator-dialog'); fileInput._pendingFile = file;
        }

        function processCSVFile(file, separator, encoding, firstRowHeader) {
            showLoader('Чтение...', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                updateLoader('Декодирование...', 20);
                const dec = new TextDecoder(encoding);
                const content = dec.decode(new Uint8Array(e.target.result));
                updateLoader('Парсинг...', 40);
                const lines = content.split(/\r?\n/).filter(l => l.trim());
                if (lines.length === 0) { hideLoader(); alert('Файл пуст'); return; }
                currentSeparator = separator;
                if (firstRowHeader) { headers = parseCSVLine(lines[0], separator); parseCSVData(lines.slice(1), separator, finishCSV); }
                else { const first = parseCSVLine(lines[0], separator); headers = first.map((_,i) => 'Столбец '+(i+1)); parseCSVData(lines, separator, finishCSV); }
                function finishCSV() {
                    updateLoader('Очистка...', 85);
                    const rowRes = removeEmptyRows(allData); allData = rowRes.data;
                    const colRes = removeEmptyColumns(headers, allData); headers = colRes.headers; allData = colRes.data;
                    resetFiltersAndSort(); initializeTable(); hideLoader(); updateStatus('Загружен: ' + file.name);
                }
            };
            reader.onerror = () => { hideLoader(); alert('Ошибка чтения'); };
            reader.readAsArrayBuffer(file);
        }

        function parseCSVLine(line, sep) {
            const res = []; let cur = '', inQ = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (c === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
                else if (c === sep && !inQ) { res.push(cur.trim()); cur = ''; }
                else cur += c;
            }
            res.push(cur.trim()); return res;
        }

        function parseCSVData(lines, sep, cb) {
            allData = []; const total = lines.length; const CHUNK = 5000; let idx = 0;
            function chunk() {
                const end = Math.min(idx + CHUNK, lines.length);
                for (let i = idx; i < end; i++) { if (!lines[i].trim()) continue; const row = parseCSVLine(lines[i], sep); while (row.length < headers.length) row.push(''); allData.push(row); }
                idx = end; updateLoader('Парсинг...', 40 + Math.round((idx/total)*45), idx + ' / ' + total);
                if (idx < lines.length) requestAnimationFrame(chunk); else cb();
            }
            chunk();
        }

        function resetFiltersAndSort() { activeFilters = {}; sortState = { column: null, direction: null }; hiddenColumns.clear(); filteredIndices = allData.map((_,i) => i); columnWidths = {}; localStorage.removeItem('columnWidths'); }

        function applyFiltersAndSort() {
            const gf = filterInput.value.trim().toLowerCase();
            const gm = filterModeToggle.checked ? 'row' : 'cell';
            const terms = gf.split(/\s+/).filter(t => t);
            filteredIndices = [];
            for (let i = 0; i < allData.length; i++) {
                const row = allData[i]; let vis = true;
                for (const ci in activeFilters) { const av = activeFilters[ci]; if (av.length === 0 || !av.includes(row[ci])) { vis = false; break; } }
                if (vis && terms.length > 0) {
                    if (gm === 'cell') { let match = false; for (const cell of row) { if (terms.every(t => String(cell).toLowerCase().includes(t))) { match = true; break; } } vis = match; }
                    else vis = terms.every(t => row.join(' ').toLowerCase().includes(t));
                }
                if (vis) filteredIndices.push(i);
            }
            if (sortState.column !== null && sortState.direction) {
                const col = sortState.column; const dir = sortState.direction === 'asc' ? 1 : -1;
                filteredIndices.sort((a,b) => { const vA = allData[a][col]; const vB = allData[b][col]; const nA = parseFloat(vA); const nB = parseFloat(vB); if (!isNaN(nA) && !isNaN(nB)) return (nA - nB) * dir; return String(vA).localeCompare(String(vB), 'ru') * dir; });
            }
        }

        let filterTimer = null;
        function onFilterInput() {
            clearTimeout(filterTimer);
            if (allData.length <= 5000) { applyFiltersAndSort(); renderVisibleRows(); updateStatus(); }
            else { filterTimer = setTimeout(() => { showLoader('Фильтрация...'); requestAnimationFrame(() => { applyFiltersAndSort(); renderVisibleRows(); updateStatus(); hideLoader(); }); }, 300); }
        }

        function createColGroup(tableId) {
            const table = document.getElementById(tableId);
            let old = table.querySelector('colgroup'); if (old) old.remove();
            const cg = document.createElement('colgroup');
            const cn = document.createElement('col'); cn.style.width = '50px'; cg.appendChild(cn);
            headers.forEach((_,idx) => { if (hiddenColumns.has(idx)) return; const c = document.createElement('col'); c.dataset.colIndex = idx; c.style.width = (columnWidths[idx] || 120) + 'px'; cg.appendChild(c); });
            table.insertBefore(cg, table.firstChild); return cg;
        }
        function updateColWidths(ci, w) { ['header-table','data-table'].forEach(id => { const c = document.querySelector('#'+id+' colgroup col[data-col-index="'+ci+'"]'); if(c) c.style.width = w + 'px'; }); }

        let resizeState = { active: false, colIndex: null, startX: 0, startWidth: 0 };
        function startColumnResize(e, ci) {
            const col = document.querySelector('#header-table colgroup col[data-col-index="'+ci+'"]');
            if (!col) return;
            resizeState = { active: true, colIndex: ci, startX: e.pageX, startWidth: parseInt(col.style.width) || 120 };
            document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none';
            const rl = document.getElementById('resize-line'); rl.style.left = e.pageX + 'px'; rl.style.display = 'block';
            document.addEventListener('mousemove', onResizeMove); document.addEventListener('mouseup', onResizeEnd);
        }
        function onResizeMove(e) {
            if (!resizeState.active) return;
            const diff = e.pageX - resizeState.startX;
            const nw = Math.max(40, resizeState.startWidth + diff);
            document.getElementById('resize-line').style.left = e.pageX + 'px';
            updateColWidths(resizeState.colIndex, nw);
        }
        function onResizeEnd(e) {
            if (!resizeState.active) return;
            const diff = e.pageX - resizeState.startX;
            const fw = Math.max(40, resizeState.startWidth + diff);
            columnWidths[resizeState.colIndex] = fw; localStorage.setItem('columnWidths', JSON.stringify(columnWidths));
            updateColWidths(resizeState.colIndex, fw);
            document.getElementById('resize-line').style.display = 'none';
            document.body.style.cursor = ''; document.body.style.userSelect = '';
            resizeState.active = false;
            document.removeEventListener('mousemove', onResizeMove); document.removeEventListener('mouseup', onResizeEnd);
        }
        function addColumnResizers() {
            document.querySelectorAll('.column-resizer').forEach(r => r.remove());
            createColGroup('header-table'); createColGroup('data-table');
            document.querySelectorAll('#header-table thead th[data-col-index]').forEach(th => {
                const di = parseInt(th.dataset.colIndex); th.style.position = 'relative';
                const rs = document.createElement('div'); rs.className = 'column-resizer'; rs.dataset.columnIndex = di;
                rs.addEventListener('mousedown', function(e) { e.preventDefault(); e.stopPropagation(); startColumnResize(e, di); });
                th.appendChild(rs);
            });
        }

        function toggleAutoSize() {
            autoSizeEnabled = !autoSizeEnabled;
            const btn = document.getElementById('autosize-btn'); const cont = document.querySelector('.table-container');
            if (autoSizeEnabled) { btn.classList.add('active'); cont.classList.remove('manual-width'); document.querySelectorAll('.column-resizer').forEach(r => r.remove()); document.querySelectorAll('colgroup').forEach(cg => cg.remove()); updateStatus('Авторазмер вкл'); }
            else { btn.classList.remove('active'); cont.classList.add('manual-width'); setTimeout(() => addColumnResizers(), 50); updateStatus('Ручной размер'); }
            localStorage.setItem('autoSizeEnabled', autoSizeEnabled);
        }

        function initializeTable() {
            applyFiltersAndSort(); emptyState.style.display = 'none'; tableHeaderContainer.style.display = 'block'; tableContainer.style.display = 'block';
            renderHeader(); setupVirtualScroll(); renderVisibleRows(); updateStatus(); updateHiddenColumnsIndicator();
            const cont = document.querySelector('.table-container');
            if (!autoSizeEnabled) { cont.classList.add('manual-width'); setTimeout(() => addColumnResizers(), 50); } else cont.classList.remove('manual-width');
        }

        function renderHeader() {
            headerRow.innerHTML = '';
            const thN = document.createElement('th'); thN.className = 'row-number'; thN.textContent = '#'; headerRow.appendChild(thN);
            headers.forEach((h, idx) => {
                if (hiddenColumns.has(idx)) return;
                const th = document.createElement('th'); th.dataset.colIndex = idx;
                const cont = document.createElement('div'); cont.className = 'header-content';
                const title = document.createElement('span'); title.className = 'header-title'; title.textContent = h || 'Столбец '+(idx+1);
                const acts = document.createElement('div'); acts.className = 'header-actions';
                const si = document.createElement('span'); si.className = 'sort-icon'; if (sortState.column === idx) si.classList.add(sortState.direction); si.onclick = (e) => { e.stopPropagation(); toggleSort(idx); };
                const fi = document.createElement('span'); fi.className = 'filter-icon'; if (activeFilters[idx]) fi.classList.add('active'); fi.onclick = (e) => { e.stopPropagation(); showColumnFilterDropdown(idx, fi); };
                acts.appendChild(si); acts.appendChild(fi); cont.appendChild(title); cont.appendChild(acts); th.appendChild(cont); headerRow.appendChild(th);
            });
            syncHeaderWidth();
        }
        function syncHeaderWidth() { const ht = document.getElementById('header-table'); const dt = document.getElementById('data-table'); const tw = Math.max(virtualScrollContainer.scrollWidth, virtualScrollContainer.clientWidth); ht.style.width = tw + 'px'; dt.style.width = tw + 'px'; }
        function setupVirtualScroll() { virtualScrollContent.style.height = filteredIndices.length * ROW_HEIGHT + 'px'; virtualScrollContainer.onscroll = () => { renderVisibleRows(); tableHeaderContainer.scrollLeft = virtualScrollContainer.scrollLeft; }; }

        function renderVisibleRows() {
            const st = virtualScrollContainer.scrollTop; const ch = virtualScrollContainer.clientHeight;
            visibleStartIndex = Math.max(0, Math.floor(st / ROW_HEIGHT) - BUFFER_ROWS);
            visibleEndIndex = Math.min(filteredIndices.length, Math.ceil((st + ch) / ROW_HEIGHT) + BUFFER_ROWS);
            virtualScrollContent.style.height = filteredIndices.length * ROW_HEIGHT + 'px';
            tableBody.style.transform = 'translateY(' + (visibleStartIndex * ROW_HEIGHT) + 'px)';
            tableBody.innerHTML = '';
            const visCols = headers.map((_,i) => i).filter(i => !hiddenColumns.has(i));
            for (let i = visibleStartIndex; i < visibleEndIndex; i++) {
                const di = filteredIndices[i]; if (di === undefined) continue; const row = allData[di];
                const tr = document.createElement('tr'); tr.dataset.dataIndex = di; tr.dataset.visibleIndex = i;
                const tdN = document.createElement('td'); tdN.className = 'row-number'; tdN.textContent = di + 1; tr.appendChild(tdN);
                visCols.forEach(ci => { const td = document.createElement('td'); td.dataset.row = di; td.dataset.col = ci; td.textContent = row[ci] || ''; td.ondblclick = () => editCell(td, di, ci); tr.appendChild(td); });
                tableBody.appendChild(tr);
            }
        }
        function renderTable() { renderHeader(); setupVirtualScroll(); renderVisibleRows(); }

        function editCell(td, ri, ci) {
            if (td.classList.contains('editing')) return;
            const old = allData[ri][ci];
            td.classList.add('editing');
            const inp = document.createElement('input'); inp.type = 'text'; inp.value = old; td.textContent = ''; td.appendChild(inp); inp.focus(); inp.select();
            const finish = () => { const nv = inp.value; td.classList.remove('editing'); td.textContent = nv; if (nv !== old) { saveState('editCell', { row: ri, col: ci, oldValue: old, newValue: nv }); allData[ri][ci] = nv; updateStatus('Изменено'); } };
            inp.onblur = finish;
            inp.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); finish(); } else if (e.key === 'Escape') { td.classList.remove('editing'); td.textContent = old; } };
        }

        function toggleSort(ci) {
            if (sortState.column === ci) { if (sortState.direction === 'asc') sortState.direction = 'desc'; else if (sortState.direction === 'desc') { sortState.column = null; sortState.direction = null; } else sortState.direction = 'asc'; }
            else { sortState.column = ci; sortState.direction = 'asc'; }
            if (allData.length > 10000) { showLoader('Сортировка...'); requestAnimationFrame(() => { applyFiltersAndSort(); renderTable(); updateStatus(); hideLoader(); }); }
            else { applyFiltersAndSort(); renderTable(); updateStatus(); }
        }

        let currentFilterDropdown = null;
        function closeFilterDropdown() { if (currentFilterDropdown) { currentFilterDropdown.remove(); currentFilterDropdown = null; } }
        function showColumnFilterDropdown(ci, iconEl) {
            closeFilterDropdown();
            const valSet = new Set(); const mx = Math.min(allData.length, 10000); for (let i = 0; i < mx; i++) valSet.add(allData[i][ci]);
            const uniq = [...valSet].sort((a,b) => { if (a === '') return 1; if (b === '') return -1; return String(a).localeCompare(String(b), 'ru'); });
            const curFilt = activeFilters[ci];
            const dd = document.createElement('div'); dd.className = 'filter-dropdown'; dd.onclick = e => e.stopPropagation();
            const hdr = document.createElement('div'); hdr.className = 'filter-dropdown-header';
            const sinp = document.createElement('input'); sinp.type = 'text'; sinp.className = 'filter-dropdown-search'; sinp.placeholder = 'Поиск...'; hdr.appendChild(sinp); dd.appendChild(hdr);
            const list = document.createElement('div'); list.className = 'filter-dropdown-list';
            const sai = document.createElement('label'); sai.className = 'filter-dropdown-item select-all';
            const sac = document.createElement('input'); sac.type = 'checkbox'; sac.checked = !curFilt; sai.appendChild(sac); sai.appendChild(document.createTextNode('(Все)')); list.appendChild(sai);
            const vcbs = [];
            uniq.forEach(v => { const itm = document.createElement('label'); itm.className = 'filter-dropdown-item'; itm.dataset.value = v; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !curFilt || curFilt.includes(v); cb.dataset.value = v; vcbs.push(cb); itm.appendChild(cb); itm.appendChild(document.createTextNode(v === '' ? '(Пустые)' : v)); list.appendChild(itm); });
            dd.appendChild(list);
            const ftr = document.createElement('div'); ftr.className = 'filter-dropdown-footer';
            const rbtn = document.createElement('button'); rbtn.className = 'btn-reset'; rbtn.textContent = 'Сбросить';
            const abtn = document.createElement('button'); abtn.className = 'btn-apply'; abtn.textContent = 'Применить';
            ftr.appendChild(rbtn); ftr.appendChild(abtn); dd.appendChild(ftr);
            document.body.appendChild(dd);
            const rect = iconEl.getBoundingClientRect(); dd.style.left = Math.min(rect.left, window.innerWidth - 290) + 'px'; dd.style.top = (rect.bottom + 5) + 'px';
            currentFilterDropdown = dd;
            function updSA() { const vis = vcbs.filter(cb => cb.closest('.filter-dropdown-item').style.display !== 'none'); const chk = vis.filter(cb => cb.checked).length; if (chk === 0) { sac.checked = false; sac.indeterminate = false; } else if (chk === vis.length) { sac.checked = true; sac.indeterminate = false; } else { sac.checked = false; sac.indeterminate = true; } }
            sac.onchange = () => { const vis = vcbs.filter(cb => cb.closest('.filter-dropdown-item').style.display !== 'none'); vis.forEach(cb => cb.checked = sac.checked); };
            vcbs.forEach(cb => cb.onchange = updSA);
            sinp.oninput = () => { const st = sinp.value.toLowerCase(); vcbs.forEach(cb => { const itm = cb.closest('.filter-dropdown-item'); itm.style.display = itm.textContent.toLowerCase().includes(st) ? '' : 'none'; }); updSA(); };
            rbtn.onclick = () => { delete activeFilters[ci]; iconEl.classList.remove('active'); closeFilterDropdown(); applyFiltersAndSort(); renderVisibleRows(); updateStatus(); };
            abtn.onclick = () => { const sel = vcbs.filter(cb => cb.checked).map(cb => cb.dataset.value); if (sel.length === 0) { activeFilters[ci] = []; iconEl.classList.add('active'); } else if (sel.length === uniq.length) { delete activeFilters[ci]; iconEl.classList.remove('active'); } else { activeFilters[ci] = sel; iconEl.classList.add('active'); } closeFilterDropdown(); applyFiltersAndSort(); renderVisibleRows(); updateStatus(); };
            updSA();
        }

        function showColumnsDialog() {
            const list = document.getElementById('column-list'); list.innerHTML = '';
            headers.forEach((h, idx) => { const itm = document.createElement('label'); itm.className = 'column-list-item'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !hiddenColumns.has(idx); cb.dataset.index = idx; itm.appendChild(cb); itm.appendChild(document.createTextNode(h || 'Столбец '+(idx+1))); list.appendChild(itm); });
            showDialog('columns-dialog');
        }
        function updateHiddenColumnsIndicator() { if (hiddenColumns.size > 0) { hiddenColumnsIndicator.style.display = 'inline'; hiddenColumnsCount.textContent = hiddenColumns.size + ' скрыто'; } else hiddenColumnsIndicator.style.display = 'none'; }

        function showContextMenu(e) {
            e.preventDefault(); hideContextMenu(); closeFilterDropdown(); contextMenu.innerHTML = '';
            const tgt = e.target.closest('th, td');
            if (!tgt) { if (currentFilename || allData.length > 0) { addCMI('Сохранить', () => saveFile()); addCMI('Сохранить как...', () => showDialog('save-dialog')); } else addCMI('Открыть', () => fileInput.click()); }
            else if (tgt.tagName === 'TH' && !tgt.classList.contains('row-number')) { const ci = parseInt(tgt.dataset.colIndex); contextTarget = { type: 'header', colIndex: ci }; addCMI('Переименовать', () => showRenameDialog(ci)); addCMI('Скрыть', () => hideColumn(ci)); addCMS(); addCMI('Вставить слева', () => insertColumn(ci)); addCMI('Вставить справа', () => insertColumn(ci+1)); addCMS(); addCMI('Заменить пустые...', () => showReplaceEmptyDialog(ci)); addCMI('Переместить...', () => showMoveColumnDialog(ci)); addCMS(); addCMI('Удалить', () => deleteColumn(ci)); }
            else if (tgt.tagName === 'TD' && !tgt.classList.contains('row-number')) { const ri = parseInt(tgt.dataset.row); const ci = parseInt(tgt.dataset.col); contextTarget = { type: 'cell', rowIndex: ri, colIndex: ci }; addCMI('Копировать ячейку', () => copyClip(allData[ri][ci])); addCMI('Копировать строку', () => copyClip(allData[ri].join('\t'))); addCMI('Редактировать', () => editCell(tgt, ri, ci)); addCMS(); addCMI('Вставить строку выше', () => insertRow(ri)); addCMI('Вставить строку ниже', () => insertRow(ri+1)); addCMS(); addCMI('Переместить...', () => showMoveRowDialog(ri)); addCMI('Удалить строку', () => deleteRow(ri)); }
            else if (tgt.classList.contains('row-number') && tgt.tagName === 'TD') { const tr = tgt.closest('tr'); const ri = parseInt(tr.dataset.dataIndex); contextTarget = { type: 'row', rowIndex: ri }; addCMI('Копировать строку', () => copyClip(allData[ri].join('\t'))); addCMS(); addCMI('Вставить выше', () => insertRow(ri)); addCMI('Вставить ниже', () => insertRow(ri+1)); addCMS(); addCMI('Переместить...', () => showMoveRowDialog(ri)); addCMI('Удалить', () => deleteRow(ri)); }
            if (contextMenu.children.length === 0) return;
            contextMenu.style.display = 'block'; contextMenu.style.left = e.pageX + 'px'; contextMenu.style.top = e.pageY + 'px';
            const rect = contextMenu.getBoundingClientRect(); if (rect.right > window.innerWidth) contextMenu.style.left = (e.pageX - rect.width) + 'px'; if (rect.bottom > window.innerHeight) contextMenu.style.top = (e.pageY - rect.height) + 'px';
        }
        function addCMI(txt, fn) { const itm = document.createElement('div'); itm.className = 'context-menu-item'; itm.textContent = txt; itm.onclick = () => { hideContextMenu(); fn(); }; contextMenu.appendChild(itm); }
        function addCMS() { const s = document.createElement('div'); s.className = 'context-menu-separator'; contextMenu.appendChild(s); }
        function hideContextMenu() { contextMenu.style.display = 'none'; }

        function insertColumn(idx) { const nh = 'Столбец ' + (headers.length+1); const vals = allData.map(() => ''); saveState('insertColumn', { index: idx, header: nh, values: vals }); headers.splice(idx, 0, nh); allData.forEach(row => row.splice(idx, 0, '')); renderTable(); updateStatus('Столбец добавлен'); }
        function deleteColumn(idx) { if (headers.length <= 1) { alert('Нельзя удалить последний'); return; } if (!confirm('Удалить "'+headers[idx]+'"?')) return; const h = headers[idx]; const vals = allData.map(row => row[idx]); saveState('deleteColumn', { index: idx, header: h, values: vals }); headers.splice(idx, 1); allData.forEach(row => row.splice(idx, 1)); delete activeFilters[idx]; hiddenColumns.delete(idx); if (sortState.column === idx) sortState = { column: null, direction: null }; applyFiltersAndSort(); renderTable(); updateHiddenColumnsIndicator(); updateStatus('Столбец удален'); }
        function hideColumn(idx) { hiddenColumns.add(idx); renderTable(); updateHiddenColumnsIndicator(); updateStatus('Столбец скрыт'); }
        function insertRow(idx) { const nr = headers.map(() => ''); saveState('insertRow', { index: idx, row: nr }); allData.splice(idx, 0, nr); applyFiltersAndSort(); renderVisibleRows(); updateStatus('Строка добавлена'); }
        function deleteRow(idx) { if (!confirm('Удалить строку?')) return; const row = [...allData[idx]]; saveState('deleteRow', { index: idx, row: row }); allData.splice(idx, 1); applyFiltersAndSort(); renderVisibleRows(); updateStatus('Строка удалена'); }
        function showRenameDialog(ci) { const inp = document.getElementById('rename-input'); inp.value = headers[ci]; showDialog('rename-dialog'); inp.focus(); inp.select(); document.getElementById('rename-confirm').onclick = () => { const nn = inp.value.trim(); if (nn) { const on = headers[ci]; saveState('renameColumn', { index: ci, oldName: on, newName: nn }); headers[ci] = nn; renderHeader(); updateStatus('Переименовано'); } hideDialog('rename-dialog'); }; }
        function showReplaceEmptyDialog(ci) { const inp = document.getElementById('replace-empty-input'); inp.value = ''; showDialog('replace-empty-dialog'); inp.focus(); document.getElementById('replace-empty-confirm').onclick = () => { const rep = inp.value; let cnt = 0; allData.forEach(row => { if (row[ci] === '' || row[ci] === null || row[ci] === undefined) { row[ci] = rep; cnt++; } }); hideDialog('replace-empty-dialog'); if (cnt > 0) { renderVisibleRows(); modified = true; updateStatus('Заменено: ' + cnt); } else updateStatus('Пустых нет'); }; }
        function showMoveColumnDialog(from) { const sel = document.getElementById('move-column-select'); sel.innerHTML = ''; headers.forEach((h, idx) => { if (idx === from) return; const opt = document.createElement('option'); opt.value = idx; opt.textContent = h || 'Столбец '+(idx+1); sel.appendChild(opt); }); const end = document.createElement('option'); end.value = headers.length; end.textContent = '(В конец)'; sel.appendChild(end); showDialog('move-column-dialog'); document.getElementById('move-column-confirm').onclick = () => { moveColumn(from, parseInt(sel.value)); hideDialog('move-column-dialog'); }; }
        function moveColumn(from, to) { if (from === to) return; const h = headers.splice(from, 1)[0]; const adj = to > from ? to - 1 : to; headers.splice(adj, 0, h); allData.forEach(row => { const c = row.splice(from, 1)[0]; row.splice(adj, 0, c); }); renderTable(); modified = true; updateStatus('Перемещено'); }
        function showMoveRowDialog(from) { const sel = document.getElementById('move-row-select'); sel.innerHTML = ''; const mx = Math.min(allData.length, 1000); for (let i = 0; i < mx; i++) { if (i === from) continue; const opt = document.createElement('option'); opt.value = i; opt.textContent = 'Строка ' + (i+1); sel.appendChild(opt); } if (allData.length > mx) { const opt = document.createElement('option'); opt.value = allData.length; opt.textContent = '(В конец)'; sel.appendChild(opt); } showDialog('move-row-dialog'); document.getElementById('move-row-confirm').onclick = () => { moveRow(from, parseInt(sel.value)); hideDialog('move-row-dialog'); }; }
        function moveRow(from, to) { if (from === to) return; const row = allData.splice(from, 1)[0]; const adj = to > from ? to - 1 : to; allData.splice(adj, 0, row); applyFiltersAndSort(); renderVisibleRows(); modified = true; updateStatus('Перемещено'); }

        function saveFile(filename, separator, format) {
            filename = filename || currentFilename || 'table.csv'; format = format || (filename.endsWith('.xlsx') ? 'xlsx' : filename.endsWith('.txt') ? 'txt' : 'csv'); separator = separator || currentSeparator || ';';
            const visOnly = document.getElementById('save-visible-only')?.checked || false;
            const hToSave = visOnly ? headers.filter((_,i) => !hiddenColumns.has(i)) : headers;
            const dToSave = allData.map(row => visOnly ? row.filter((_,i) => !hiddenColumns.has(i)) : row);
            if (format === 'xlsx') { const wb = XLSX.utils.book_new(); const wsData = [hToSave, ...dToSave]; const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, 'Sheet1'); XLSX.writeFile(wb, filename); }
            else { const sep = separator === '\\t' ? '\t' : separator; let content = hToSave.map(h => fmtCSV(h, sep)).join(sep) + '\r\n'; dToSave.forEach(row => { content += row.map(c => fmtCSV(c, sep)).join(sep) + '\r\n'; }); const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); URL.revokeObjectURL(link.href); }
            currentFilename = filename; modified = false; updateStatus('Сохранено: ' + filename);
        }
        function fmtCSV(v, sep) { if (v === null || v === undefined) return ''; const s = String(v); if (s.includes(sep) || s.includes('"') || s.includes('\n') || s.includes('\r')) return '"' + s.replace(/"/g, '""') + '"'; return s; }

        function updateStatus(msg) { let s = msg || 'Готов'; if (currentFilename) { s += ' | ' + currentFilename; if (currentFileSize) s += ' (' + currentFileSize + ' КБ)'; } s += ' | Строк: ' + allData.length + ' | Столбцов: ' + headers.length; if (filteredIndices.length !== allData.length) s += ' | Показано: ' + filteredIndices.length; statusMessage.textContent = s; }
        function copyClip(txt) { navigator.clipboard.writeText(txt).then(() => updateStatus('Скопировано')).catch(() => { const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); updateStatus('Скопировано'); }); }

        document.getElementById('open-btn').onclick = () => fileInput.click();
        document.getElementById('open-file-btn').onclick = () => fileInput.click();
        emptyState.onclick = (e) => { if (e.target.id !== 'open-file-btn') fileInput.click(); };
        document.getElementById('save-btn').onclick = () => { if (allData.length === 0) return; if (currentFilename) saveFile(); else showDialog('save-dialog'); };
        document.getElementById('save-as-btn').onclick = () => { if (allData.length === 0) return; showDialog('save-dialog'); };
        document.getElementById('undo-btn').onclick = undo;
        document.getElementById('redo-btn').onclick = redo;
        document.getElementById('columns-btn').onclick = () => { if (headers.length === 0) return; showColumnsDialog(); };
        document.getElementById('sort-btn').onclick = () => { if (headers.length === 0) return; sortState = { column: null, direction: null }; applyFiltersAndSort(); renderTable(); updateStatus('Сортировка сброшена'); };
        document.getElementById('autosize-btn').onclick = toggleAutoSize;
        fileInput.onchange = (e) => { if (e.target.files[0]) processFile(e.target.files[0]); };
        document.getElementById('create-btn').onclick = () => { showDialog('create-dialog'); document.getElementById('create-rows').focus(); };
        document.getElementById('create-cancel').onclick = () => hideDialog('create-dialog');
        document.getElementById('create-confirm').onclick = () => { const rows = parseInt(document.getElementById('create-rows').value) || 10; const cols = parseInt(document.getElementById('create-cols').value) || 5; const wh = document.getElementById('create-with-headers').checked; if (rows < 1 || rows > 100000) { alert('Строк: 1-100000'); return; } if (cols < 1 || cols > 100) { alert('Столбцов: 1-100'); return; } if (allData.length > 0 && modified && !confirm('Несохраненные данные будут потеряны. Продолжить?')) return; hideDialog('create-dialog'); if (rows * cols > 10000) { showLoader('Создание...'); requestAnimationFrame(() => { createNewFile(rows, cols, wh); hideLoader(); }); } else createNewFile(rows, cols, wh); };
        sheetSelector.onchange = () => loadSheet(sheetSelector.value);
        filterInput.oninput = onFilterInput;
        filterInput.onkeydown = (e) => { if (e.key === 'Enter') { applyFiltersAndSort(); renderVisibleRows(); updateStatus(); } };
        filterModeToggle.onchange = () => { applyFiltersAndSort(); renderVisibleRows(); updateStatus(); };
        document.getElementById('separator-cancel').onclick = () => { hideDialog('separator-dialog'); fileInput.value = ''; };
        document.getElementById('separator-confirm').onclick = () => { const file = fileInput._pendingFile; const sr = document.querySelector('input[name="separator"]:checked'); let sep = sr.value; if (sep === 'custom') sep = document.getElementById('custom-separator').value || ';'; else if (sep === '\\t') sep = '\t'; const enc = document.getElementById('encoding-select').value; const frh = document.getElementById('first-row-header').checked; hideDialog('separator-dialog'); processCSVFile(file, sep, enc, frh); };
        document.getElementById('save-cancel').onclick = () => hideDialog('save-dialog');
        document.getElementById('save-format').onchange = () => { document.getElementById('save-separator-group').style.display = document.getElementById('save-format').value === 'xlsx' ? 'none' : 'block'; };
        document.getElementById('save-confirm').onclick = () => { const fmt = document.getElementById('save-format').value; let sep = document.getElementById('save-separator').value; let fn = currentFilename || 'table'; fn = fn.replace(/\.[^.]+$/, '') + '.' + fmt; hideDialog('save-dialog'); saveFile(fn, sep, fmt); };
        document.getElementById('rename-cancel').onclick = () => hideDialog('rename-dialog');
        document.getElementById('rename-input').onkeydown = (e) => { if (e.key === 'Enter') document.getElementById('rename-confirm').click(); else if (e.key === 'Escape') hideDialog('rename-dialog'); };
        document.getElementById('replace-empty-cancel').onclick = () => hideDialog('replace-empty-dialog');
        document.getElementById('replace-empty-input').onkeydown = (e) => { if (e.key === 'Enter') document.getElementById('replace-empty-confirm').click(); else if (e.key === 'Escape') hideDialog('replace-empty-dialog'); };
        document.getElementById('move-column-cancel').onclick = () => hideDialog('move-column-dialog');
        document.getElementById('move-row-cancel').onclick = () => hideDialog('move-row-dialog');
        document.getElementById('columns-cancel').onclick = () => hideDialog('columns-dialog');
        document.getElementById('columns-show-all').onclick = () => document.querySelectorAll('#column-list input').forEach(cb => cb.checked = true);
        document.getElementById('columns-hide-all').onclick = () => document.querySelectorAll('#column-list input').forEach(cb => cb.checked = false);
        document.getElementById('columns-invert').onclick = () => document.querySelectorAll('#column-list input').forEach(cb => cb.checked = !cb.checked);
        document.getElementById('columns-confirm').onclick = () => { const cbs = document.querySelectorAll('#column-list input'); hiddenColumns.clear(); cbs.forEach(cb => { if (!cb.checked) hiddenColumns.add(parseInt(cb.dataset.index)); }); hideDialog('columns-dialog'); renderTable(); updateHiddenColumnsIndicator(); updateStatus(); };
        document.addEventListener('contextmenu', showContextMenu);
        document.addEventListener('click', () => { hideContextMenu(); closeFilterDropdown(); });
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'o') { e.preventDefault(); fileInput.click(); }
            if (e.ctrlKey && e.key === 'n') { e.preventDefault(); document.getElementById('create-btn').click(); }
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); if (allData.length > 0) { if (e.shiftKey || !currentFilename) showDialog('save-dialog'); else saveFile(); } }
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); filterInput.focus(); filterInput.select(); }
            if (e.key === 'Escape') { hideAllDialogs(); hideContextMenu(); closeFilterDropdown(); }
        });
        document.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
        document.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]); });
        updateUndoRedoButtons();
        updateStatus('Готов');

        const PROXY_URL = "https://mapruapp.ru";
        const AI_MODELS = [
            { id: "gemini-3-flash-preview", name: "Gemini 3 Flash", type: "gemini" },
            { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite", type: "gemini" },
            { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", type: "gemini" },
            { id: "claude-sonnet-4-5-20250929", name: "Claude Sonnet 4.5", type: "anthropic" },
            { id: "mistral-large-2512", name: "Mistral Large", type: "mistral" }
        ];
        const AI_MODES = { 'proxy': { name: 'Прокси', needsKey: false }, 'direct_gemini': { name: 'Прямой Gemini', needsKey: true }, 'direct_mistral': { name: 'Прямой Mistral', needsKey: true } };
        let aiModel = localStorage.getItem('ai_model') || 'gemini-3-flash-preview';
        let aiMode = localStorage.getItem('ai_mode') || 'proxy';
        let aiKey = localStorage.getItem('ai_key') || '';
        let aiCtrl = null;

        const aiPanel = document.getElementById('ai-panel');
        const aiQuery = document.getElementById('ai-query');
        const aiIncludeData = document.getElementById('ai-include-data');
        const aiDataInfo = document.getElementById('ai-data-info');
        const aiModelSel = document.getElementById('ai-model-selector');
        const aiModeSel = document.getElementById('ai-mode-selector');
        const aiKeyGrp = document.getElementById('ai-key-group');
        const aiKeyInp = document.getElementById('ai-api-key');
        const aiSettingsToggle = document.getElementById('ai-settings-toggle');
        const aiSettingsPanel = document.getElementById('ai-settings-panel');
        const aiLoading = document.getElementById('ai-loading');
        const aiResponse = document.getElementById('ai-response');
        const aiSendBtn = document.getElementById('ai-send');
        const aiCancelBtn = document.getElementById('ai-cancel');

        aiModelSel.innerHTML = AI_MODELS.map(m => '<option value="'+m.id+'" data-type="'+m.type+'">'+m.name+'</option>').join('');
        aiModelSel.value = aiModel;

        function updateAIModes() {
            const mdl = AI_MODELS.find(m => m.id === aiModel);
            const tp = mdl?.type || 'gemini';
            let modes = ['proxy'];
            if (tp === 'gemini') modes.push('direct_gemini');
            if (tp === 'mistral') modes.push('direct_mistral');
            aiModeSel.innerHTML = modes.map(k => '<option value="'+k+'">'+AI_MODES[k].name+'</option>').join('');
            if (!modes.includes(aiMode)) aiMode = 'proxy';
            aiModeSel.value = aiMode;
            aiKeyGrp.style.display = AI_MODES[aiMode]?.needsKey ? 'block' : 'none';
        }
        updateAIModes();
        aiKeyInp.value = aiKey;

        function toggleAIPanel() { aiPanel.classList.toggle('active'); if (aiPanel.classList.contains('active')) { if (allData.length > 0) { const n = Math.min(allData.length, 100); aiDataInfo.textContent = n + ' строк' + (allData.length > 100 ? ' (макс 100)' : ''); } else aiDataInfo.textContent = '0 строк'; aiQuery.focus(); } }
        function showAIResp(txt, type) { aiResponse.textContent = txt; aiResponse.className = 'ai-response-area active'; if (type) aiResponse.classList.add(type); }

        async function sendAI() {
            const q = aiQuery.value.trim();
            if (!q) { showAIResp('Введите запрос', 'error'); return; }
            if (allData.length === 0) { showAIResp('Сначала загрузите таблицу', 'error'); return; }
            if (AI_MODES[aiMode]?.needsKey && !aiKey) { showAIResp('Введите API ключ', 'error'); aiSettingsPanel.classList.add('active'); return; }
            const tableData = aiIncludeData.checked ? { headers: headers, rows: allData.slice(0, 100), total: allData.length } : null;
            let prompt = 'Ты AI для таблиц. Ответь JSON:\n{"actions":[{"type":"set_cell","row":0,"col":0,"value":"x"},{"type":"add_row","data":["a","b"]},{"type":"add_column","header":"X","values":["1","2"]},{"type":"message","text":"..."}]}\n';
            if (tableData) prompt += '\nТаблица:\nЗаголовки: ' + JSON.stringify(tableData.headers) + '\nДанные (' + tableData.rows.length + ' из ' + tableData.total + '):\n' + JSON.stringify(tableData.rows) + '\n';
            prompt += '\nЗадача: ' + q + '\n\nОтветь только JSON.';
            aiLoading.classList.add('active'); aiResponse.classList.remove('active'); aiSendBtn.disabled = true; aiCancelBtn.style.display = 'block';
            aiCtrl = new AbortController();
            try {
                let url, body;
                const hdrs = { 'Content-Type': 'application/json' };
                const msgs = [{ role: 'user', content: prompt }];
                if (aiMode === 'proxy') { url = PROXY_URL + '/ai/api/v1/chat/completions'; body = { model: aiModel, messages: msgs, max_tokens: 8192 }; }
                else if (aiMode === 'direct_gemini') { url = 'https://generativelanguage.googleapis.com/v1beta/models/' + aiModel + ':generateContent?key=' + aiKey; body = { contents: [{ role: 'user', parts: [{ text: prompt }] }] }; }
                else if (aiMode === 'direct_mistral') { url = 'https://api.mistral.ai/v1/chat/completions'; hdrs['Authorization'] = 'Bearer ' + aiKey; body = { model: aiModel, messages: msgs, max_tokens: 8192 }; }
                const resp = await fetch(url, { method: 'POST', headers: hdrs, body: JSON.stringify(body), signal: aiCtrl.signal });
                if (!resp.ok) { const err = await resp.json().catch(() => ({})); throw new Error(err.error?.message || 'HTTP ' + resp.status); }
                const data = await resp.json();
                let txt;
                if (aiMode === 'direct_gemini') txt = data.candidates?.[0]?.content?.parts?.[0]?.text;
                else txt = data.choices?.[0]?.message?.content;
                if (!txt) throw new Error('Пустой ответ');
                processAIResp(txt);
            } catch (err) {
                if (err.name === 'AbortError') showAIResp('Отменено', 'error');
                else showAIResp('Ошибка: ' + err.message, 'error');
            } finally { aiLoading.classList.remove('active'); aiSendBtn.disabled = false; aiCancelBtn.style.display = 'none'; aiCtrl = null; }
        }

        function processAIResp(txt) {
            let json = txt;
            const m = txt.match(/\{[\s\S]*"actions"[\s\S]*\}/);
            if (m) json = m[0];
            try {
                const res = JSON.parse(json);
                if (!res.actions || !Array.isArray(res.actions)) throw new Error('Неверный формат');
                let cnt = 0, msgs = [];
                res.actions.forEach(a => {
                    if (a.type === 'set_cell' && a.row >= 0 && a.row < allData.length && a.col >= 0 && a.col < headers.length) { allData[a.row][a.col] = String(a.value); cnt++; }
                    else if (a.type === 'add_row' && Array.isArray(a.data)) { const nr = a.data.map(v => String(v || '')); while (nr.length < headers.length) nr.push(''); allData.push(nr); cnt++; }
                    else if (a.type === 'add_column' && a.header && Array.isArray(a.values)) { headers.push(String(a.header)); allData.forEach((r, i) => r.push(String(a.values[i] || ''))); cnt++; }
                    else if (a.type === 'message' && a.text) msgs.push(a.text);
                });
                if (cnt > 0) { applyFiltersAndSort(); renderTable(); modified = true; }
                let msg = cnt > 0 ? '✅ Изменений: ' + cnt : '';
                if (msgs.length > 0) msg += (msg ? '\n\n' : '') + msgs.join('\n');
                if (!msg) msg = 'AI не внес изменений';
                showAIResp(msg, cnt > 0 ? 'success' : '');
                updateStatus('AI: ' + cnt + ' изменений');
            } catch (e) { showAIResp(txt, ''); }
        }

        document.getElementById('ai-btn').addEventListener('click', toggleAIPanel);
        document.getElementById('ai-panel-close').addEventListener('click', () => aiPanel.classList.remove('active'));
        aiSettingsToggle.addEventListener('click', () => aiSettingsPanel.classList.toggle('active'));
        aiModelSel.addEventListener('change', () => { aiModel = aiModelSel.value; localStorage.setItem('ai_model', aiModel); updateAIModes(); });
        aiModeSel.addEventListener('change', () => { aiMode = aiModeSel.value; localStorage.setItem('ai_mode', aiMode); aiKeyGrp.style.display = AI_MODES[aiMode]?.needsKey ? 'block' : 'none'; });
        aiKeyInp.addEventListener('change', () => { aiKey = aiKeyInp.value.trim(); localStorage.setItem('ai_key', aiKey); });
        aiSendBtn.addEventListener('click', sendAI);
        aiCancelBtn.addEventListener('click', () => { if (aiCtrl) aiCtrl.abort(); });
        aiQuery.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); sendAI(); } });
        document.querySelectorAll('.ai-example-btn').forEach(btn => btn.addEventListener('click', () => { aiQuery.value = btn.dataset.prompt; aiQuery.focus(); }));
        aiIncludeData.addEventListener('change', () => { if (aiIncludeData.checked && allData.length > 0) { const n = Math.min(allData.length, 100); aiDataInfo.textContent = n + ' строк'; } else aiDataInfo.textContent = '0 строк'; });
    });
    </script>
</body>
</html>
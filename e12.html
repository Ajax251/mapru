<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренировка Слов + Cloud</title>
    <link rel="icon" href="img/wordsm.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --success-dark: #059669;
            --error: #ef4444;
            --error-dark: #dc2626;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --pink: #ec4899;
            --teal: #14b8a6;
            --orange: #f97316;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100dvh; 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg);
            color: var(--text); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Animated Background --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.2), transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.2), transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.1), transparent 70%);
            animation: globalPulse 10s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes globalPulse {
            0%, 100% { opacity: 0.6; transform: scale(1) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.05) rotate(5deg); }
        }

        /* Floating particles */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(3px 3px at 50% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 80% 10%, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200px 200px, 300px 300px, 250px 250px, 180px 180px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: particleFloat 20s linear infinite;
            pointer-events: none;
        }

        @keyframes particleFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-200px); }
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            border-radius: 20px;
            padding: 18px 28px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 12px 24px -6px rgba(0, 0, 0, 0.3);
        }

        .btn:active { 
            transform: translateY(0px); 
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-secondary { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .btn-teal { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .btn-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-cloud { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        
        /* --- Auth Header --- */
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--warning);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .auth-btn {
            background: white;
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-btn.logout {
            background: #fee2e2;
            color: #dc2626;
        }

        /* --- Cloud Stats Dashboard --- */
        .cloud-stats {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }

        .stat-val {
            font-size: 28px;
            font-weight: 900;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* --- Screens --- */
        .screen { 
            display: none;
            flex-direction: column; 
            height: 100%; 
            padding: 24px; 
            position: absolute; 
            width: 100%; 
            top: 0; 
            left: 0; 
            z-index: 0;
        }

        .screen.active { 
            display: flex;
            z-index: 1;
        }

        /* --- Input Screen --- */
        .input-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: rgba(255, 255, 255, 0.98);
            border-radius: 28px; 
            box-shadow: var(--shadow-lg), 0 0 60px rgba(99, 102, 241, 0.2);
            overflow: hidden; 
            margin-bottom: 24px; 
            position: relative;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        textarea { 
            flex: 1; 
            width: 100%; 
            border: none; 
            padding: 28px; 
            font-size: 16px; 
            resize: none; 
            outline: none; 
            font-family: inherit;
            background: transparent;
            line-height: 1.8;
            color: var(--text);
        }

        textarea::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .controls-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
        }
        .full-width-btn { width: 100%; margin-top: 16px; }

        /* --- Game Screen --- */
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255, 255, 255, 0.98); 
            padding: 20px 24px; 
            border-radius: 24px; 
            box-shadow: var(--shadow), 0 0 40px rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(20px);
            margin-bottom: 24px;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .progress-bar { 
            flex: 1; 
            height: 12px; 
            background: rgba(0, 0, 0, 0.08); 
            border-radius: 12px; 
            margin: 0 24px; 
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            width: 0%; 
            transition: width 0.3s linear;
            border-radius: 12px;
            box-shadow: 0 0 20px var(--primary-light);
            position: relative;
        }

        .icon-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            color: #666; 
            cursor: pointer; 
            padding: 10px;
            border-radius: 14px;
            transition: all 0.2s;
        }
        .icon-btn:hover { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--error); 
        }

        .word-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 20vh;
            margin: 24px 0;
        }

        .game-mode-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        #target-word { 
            font-size: 48px; 
            font-weight: 900; 
            text-align: center; 
            margin-bottom: 16px;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 255, 255, 0.4);
            letter-spacing: 1px;
        }

        .word-counter { 
            font-size: 16px; 
            color: rgba(255, 255, 255, 0.95); 
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.25);
            padding: 10px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            font-weight: 700;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .options-area { 
            flex: 1.5; 
            padding: 12px; 
            overflow-y: auto;
        }

        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            height: 100%; 
            align-content: center;
        }

        .option-btn { 
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-radius: 24px; 
            padding: 24px; 
            font-size: 18px; 
            color: var(--text); 
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            min-height: 100px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            word-break: break-word;
            position: relative;
            overflow: hidden;
            animation: cardPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards;
            transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
        }
        
        @keyframes cardPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .option-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 16px 36px rgba(99, 102, 241, 0.25);
            border-color: var(--primary);
        }

        .correct-anim { 
            animation: flashGreen 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashGreen {
            0% { 
                background: #ffffff;
                color: var(--success);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--success);
                border-color: var(--success);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05);
            }
            100% { 
                background: var(--success); 
                color: white;
                border-color: var(--success-dark); 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); 
                transform: scale(1);
            }
        }

        .wrong-anim { 
            animation: flashRed 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashRed {
             0% { 
                background: #ffffff;
                color: var(--error);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--error);
                border-color: var(--error);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05);
            }
            100% { 
                background: var(--error); 
                color: white;
                border-color: var(--error-dark); 
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); 
                transform: scale(1);
            }
        }

        /* --- Result Screen --- */
        .result-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            text-align: center;
            color: white;
            overflow-y: auto;
            padding-bottom: 24px;
        }

        .score-circle { 
            width: 200px; 
            height: 200px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            margin: 40px 0; 
            position: relative;
            border: 5px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.6), 0 20px 40px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .score-val { 
            font-size: 64px; 
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .result-stats-row {
            display: flex; 
            gap: 18px; 
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat-bubble {
            font-size: 18px;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 700;
        }

        /* --- Cloud Summary --- */
        .cloud-summary {
            display: none;
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.4);
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 400px;
        }

        .cloud-summary.show {
            display: block;
        }

        .cloud-summary-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .cloud-summary-stats {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- Mistakes Section --- */
        #mistakes-section {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 20px;
            color: var(--text);
            text-align: left;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .mistake-card {
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--error);
        }
        
        .mistake-card:last-child { margin-bottom: 0; }
        
        .m-word { 
            font-weight: 800; 
            font-size: 18px; 
            color: var(--text); 
            margin-bottom: 8px;
        }
        
        .m-wrong { 
            color: var(--error); 
            font-size: 15px; 
            text-decoration: line-through; 
            margin-right: 12px; 
            font-weight: 600;
        }
        
        .m-right { 
            color: var(--success-dark); 
            font-size: 15px; 
            font-weight: 800; 
        }

        /* --- Loader --- */
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }

        .spinner { 
            width: 70px; 
            height: 70px;
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary), var(--purple), var(--pink));
            animation: spinnerPulse 1.5s infinite, spinnerRotate 2s linear infinite;
            margin-bottom: 24px; 
            box-shadow: 0 0 40px var(--primary);
            position: relative;
        }

        .spinner::after {
            content: '';
            position: absolute;
            inset: 8px;
            background: white;
            border-radius: 50%;
        }

        @keyframes spinnerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--primary); }
            50% { transform: scale(1.1); box-shadow: 0 0 60px var(--primary-light); }
        }

        @keyframes spinnerRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loader-text {
            color: var(--primary);
            font-weight: 800;
            font-size: 24px;
            margin-bottom: 12px;
        }

        #loader-sub {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            padding: 0 24px;
            max-width: 400px;
        }

        .hidden { display: none !important; }
        .hidden-file { display: none; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--primary), var(--purple)); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, var(--primary-dark), var(--purple)); 
        }

        @media (max-width: 480px) {
            body, html { padding: 0; }
            .screen { padding: 16px; }
            #target-word { font-size: 38px; }
            .option-btn { font-size: 16px; min-height: 90px; padding: 18px; }
            .score-circle { width: 170px; height: 170px; }
            .score-val { font-size: 54px; }
            .btn { padding: 16px 22px; font-size: 15px; }
            .cloud-stats { grid-template-columns: 1fr 1fr 1fr; }
            .stat-card { padding: 12px; }
            .stat-val { font-size: 22px; }
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: INPUT -->
    <div id="screen-input" class="screen active">
        <!-- Auth Header -->
        <div class="auth-header">
            <div class="user-info hidden" id="user-display">
                <div class="user-avatar" id="u-avatar">U</div>
                <span id="u-email">User</span>
            </div>
            <div class="user-info" id="guest-display">
                <i class="fas fa-user-secret"></i> Гость
            </div>
            <button class="auth-btn" id="auth-btn" onclick="handleAuth()">
                <i class="fab fa-google"></i> Войти
            </button>
        </div>

        <!-- Cloud Stats Dashboard -->
        <div class="cloud-stats" id="cloud-stats">
            <div class="stat-card">
                <span class="stat-val" style="color: var(--success)" id="stat-learned">0</span>
                <span class="stat-label"><i class="fas fa-check-circle"></i> Выучено</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" style="color: var(--warning)" id="stat-learning">0</span>
                <span class="stat-label"><i class="fas fa-book-open"></i> Учу</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" style="color: var(--primary)" id="stat-new">0</span>
                <span class="stat-label"><i class="fas fa-plus-circle"></i> Новые</span>
            </div>
        </div>

        <div class="input-wrapper">
            <textarea id="sourceText" placeholder="Вставьте текст для обработки...&#10;&#10;Или войдите, чтобы тренировать слова из облака."></textarea>
        </div>
        
        <button class="btn btn-primary full-width-btn" onclick="startProcessing()">
            <i class="fas fa-magic"></i>
            <span>Обработать текст</span>
        </button>

        <button class="btn btn-cloud full-width-btn hidden" id="btn-train-cloud" onclick="startCloudTraining()">
            <i class="fas fa-dumbbell"></i>
            <span>Тренировать (<span id="due-count">0</span>)</span>
        </button>

        <div class="controls-row">
            <button class="btn btn-teal" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-upload"></i>
                <span>Импорт</span>
            </button>
            <button class="btn btn-orange" onclick="smartReset()">
                <i class="fas fa-arrows-rotate"></i>
                <span>Сбросить</span>
            </button>
        </div>
        <input type="file" id="fileInput" class="hidden-file" accept=".words,.json" onchange="importWords(this)">
    </div>

    <!-- SCREEN 2: GAME -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span style="font-weight: 800; color: var(--primary); font-size: 18px;">
                <i class="fas fa-star" style="color: var(--warning);"></i> 
                <span id="score">0</span>
            </span>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <button class="icon-btn" onclick="exitGame()" style="margin-left: 10px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="word-area">
            <div class="game-mode-label" id="game-mode-label"></div>
            <div id="target-word">Word</div>
        </div>
        <div class="options-area">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="screen">
        <div class="result-content">
            <div class="score-circle">
                <span class="score-val" id="final-percent">0%</span>
                <span style="font-size: 17px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Точность</span>
            </div>
            <div class="result-stats-row">
                <div class="stat-bubble">
                    <i class="fas fa-list-check"></i> Всего: <strong id="res-total">0</strong>
                </div>
                <div class="stat-bubble">
                    <i class="fas fa-times-circle"></i> Ошибок: <strong id="res-errors" style="color: #ffcccc">0</strong>
                </div>
            </div>

            <!-- Cloud Summary -->
            <div class="cloud-summary" id="cloud-summary">
                <div class="cloud-summary-text">
                    <i class="fas fa-cloud-upload-alt"></i> Прогресс сохранен в облако
                </div>
                <div class="cloud-summary-stats" id="cloud-summary-stats"></div>
            </div>

            <button class="btn btn-success full-width-btn" onclick="restartGame(false)">
                <i class="fas fa-redo"></i>
                <span>Пройти заново</span>
            </button>

            <button class="btn btn-pink full-width-btn" onclick="restartGame(true)" style="margin-top: 12px;">
                <i class="fas fa-exchange-alt"></i>
                <span>Играть наоборот</span>
            </button>

            <button id="btn-show-mistakes" class="btn btn-secondary full-width-btn" onclick="toggleMistakes()" style="margin-top: 12px; display: none;">
                <i class="fas fa-clipboard-list"></i>
                <span>Работа над ошибками</span>
            </button>

            <button class="btn btn-cloud full-width-btn hidden" id="btn-save-cloud" onclick="saveCurrentWordsToCloud()" style="margin-top: 12px;">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Сохранить в словарь</span>
            </button>

            <button class="btn btn-info full-width-btn" onclick="goToInput()" style="margin-top: 12px;">
                <i class="fas fa-home"></i>
                <span>Главное меню</span>
            </button>
            
            <button class="btn btn-warning full-width-btn" onclick="exportWords()" style="margin-top: 12px;">
                <i class="fas fa-download"></i>
                <span>Экспорт словаря</span>
            </button>

            <!-- Mistakes List -->
            <div id="mistakes-section">
                <h4 style="margin: 0 0 16px 0; color: var(--primary); font-size: 20px;">
                    <i class="fas fa-exclamation-triangle"></i> Что исправить:
                </h4>
                <div id="mistakes-container"></div>
            </div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <h3 id="loader-text">Загрузка...</h3>
        <p id="loader-sub"></p>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
        
        const MAPRUAPP_PROXY = "https://mapruapp.ru/ai/api/v1/chat/completions";
        const VERCEL_PROXY = "https://ver-olive-delta.vercel.app/v1beta/models";
        const MODEL = "gemini-2.0-flash-exp";
        
        let currentProxyIndex = 0; // 0 = MAPRUAPP, 1 = VERCEL

        // ==========================================
        // SUPABASE INIT
        // ==========================================
        let sb = null;
        try {
            if (window.supabase) {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // ==========================================
        // APP STATE
        // ==========================================
        let state = {
            user: null,
            words: [],           // All available words
            gameOrder: [],       // Current game sequence
            idx: 0,
            score: 0,
            mistakes: 0,
            mistakesLog: [],
            isReversed: false,
            mode: 'instant',     // 'instant' or 'cloud'
            locked: false,
            statsCache: null,
            statsCacheTime: 0
        };

        // ==========================================
        // SAFE DOM HELPERS
        // ==========================================
        const $ = (id) => document.getElementById(id);
        const setTxt = (id, txt) => {
            const el = $(id);
            if (el) el.textContent = txt;
        };
        const setHTML = (id, html) => {
            const el = $(id);
            if (el) el.innerHTML = html;
        };
        const show = (id) => {
            const el = $(id);
            if (el) el.classList.remove('hidden');
        };
        const hide = (id) => {
            const el = $(id);
            if (el) el.classList.add('hidden');
        };

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        async function initAuth() {
            if (!sb) return;
            
            const { data: { session } } = await sb.auth.getSession();
            if (session) handleUser(session.user);

            sb.auth.onAuthStateChange((_event, session) => {
                if (session) handleUser(session.user);
                else handleLogout();
            });
        }

        function handleUser(user) {
            state.user = user;
            
            hide('guest-display');
            show('user-display');
            
            const email = user.email.split('@')[0];
            setTxt('u-email', email);
            setTxt('u-avatar', email[0].toUpperCase());
            
            const authBtn = $('auth-btn');
            if (authBtn) {
                authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Выйти';
                authBtn.onclick = signOut;
                authBtn.classList.add('logout');
            }

            const stats = $('cloud-stats');
            if (stats) stats.style.display = 'grid';
            
            show('btn-train-cloud');
            
            fetchStats();
        }

        function handleLogout() {
            state.user = null;
            
            show('guest-display');
            hide('user-display');
            
            const authBtn = $('auth-btn');
            if (authBtn) {
                authBtn.innerHTML = '<i class="fab fa-google"></i> Войти';
                authBtn.onclick = handleAuth;
                authBtn.classList.remove('logout');
            }

            const stats = $('cloud-stats');
            if (stats) stats.style.display = 'none';

            hide('btn-train-cloud');
            setTxt('due-count', '0');
        }

        async function handleAuth() {
            if (!sb) return alert("Supabase не настроен!");
            
            try {
                await sb.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
            } catch (error) {
                console.error('Auth error:', error);
                alert('Ошибка авторизации: ' + error.message);
            }
        }

        async function signOut() {
            if (!sb) return;
            await sb.auth.signOut();
            window.location.reload();
        }

        // ==========================================
        // CLOUD STATISTICS
        // ==========================================
        async function fetchStats(forceRefresh = false) {
            if (!state.user) return;
            
            // Cache for 30 seconds
            if (!forceRefresh && state.statsCache && Date.now() - state.statsCacheTime < 30000) {
                updateStatsUI(state.statsCache);
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('user_words')
                    .select('status, next_review')
                    .eq('user_id', state.user.id);
                    
                if (error) throw error;

                let learned = 0, learning = 0, newCount = 0, due = 0;
                const now = new Date();

                data.forEach(w => {
                    if (w.status === 'learned') learned++;
                    else if (w.status === 'learning') learning++;
                    else newCount++;

                    if (w.status === 'new' || new Date(w.next_review) <= now) {
                        due++;
                    }
                });

                const stats = { learned, learning, newCount, due };
                state.statsCache = stats;
                state.statsCacheTime = Date.now();
                
                updateStatsUI(stats);
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        function updateStatsUI(stats) {
            setTxt('stat-learned', stats.learned);
            setTxt('stat-learning', stats.learning);
            setTxt('stat-new', stats.newCount);
            setTxt('due-count', stats.due);

            const btn = $('btn-train-cloud');
            if (btn) {
                if (stats.due > 0) {
                    btn.style.opacity = '1';
                    btn.disabled = false;
                    setHTML('btn-train-cloud', `<i class="fas fa-dumbbell"></i><span>Тренировать (<span id="due-count">${stats.due}</span>)</span>`);
                } else {
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                    setHTML('btn-train-cloud', '<i class="fas fa-check-circle"></i><span>Всё выучено!</span>');
                }
            }
        }

        // ==========================================
        // CLOUD WORD MANAGEMENT
        // ==========================================
        async function saveCurrentWordsToCloud() {
            if (!state.user || state.words.length === 0) return;
            
            setLoading(true, "Сохранение в облако...");

            try {
                const updates = state.words.map(w => ({
                    user_id: state.user.id,
                    original: w.original.toLowerCase(),
                    translation: w.translation.toLowerCase(),
                    language: detectLanguage(w.original),
                    status: 'new',
                    level: 0,
                    correct_count: 0,
                    wrong_count: 0,
                    last_seen: new Date().toISOString(),
                    next_review: new Date().toISOString()
                }));

                // Check existing words
                const originals = updates.map(u => u.original);
                const { data: existing } = await sb
                    .from('user_words')
                    .select('original')
                    .eq('user_id', state.user.id)
                    .in('original', originals);
                
                const existingSet = new Set(existing ? existing.map(e => e.original) : []);
                const toInsert = updates.filter(u => !existingSet.has(u.original));

                if (toInsert.length > 0) {
                    const { error } = await sb.from('user_words').insert(toInsert);
                    if (error) throw error;
                    
                    alert(`✓ Сохранено ${toInsert.length} новых слов!`);
                    hide('btn-save-cloud');
                    await fetchStats(true);
                } else {
                    alert("Эти слова уже есть в вашей библиотеке.");
                }
            } catch (error) {
                console.error('Error saving words:', error);
                alert("Ошибка сохранения: " + error.message);
            } finally {
                setLoading(false);
            }
        }

        async function startCloudTraining() {
            if (!state.user) return;
            
            setLoading(true, "Загрузка слов из облака...");
            
            try {
                const now = new Date().toISOString();
                
                // Get words that need review
                const { data, error } = await sb
                    .from('user_words')
                    .select('*')
                    .eq('user_id', state.user.id)
                    .or(`status.eq.new,next_review.lte.${now}`)
                    .order('next_review', { ascending: true })
                    .limit(20);

                if (error) throw error;

                // Need at least 4 words for game
                if (data.length < 4) {
                    // Get additional words as fillers
                    const { data: filler } = await sb
                        .from('user_words')
                        .select('*')
                        .eq('user_id', state.user.id)
                        .limit(10);
                    
                    if (filler && filler.length > 0) {
                        const combined = [...data, ...filler.filter(f => !data.find(d => d.id === f.id))];
                        
                        if (combined.length < 4) {
                            setLoading(false);
                            return alert("Нужно минимум 4 слова в словаре. Добавьте новые слова!");
                        }
                        
                        state.words = combined;
                        state.gameOrder = data.length > 0 ? data : combined.slice(0, 10);
                    } else {
                        setLoading(false);
                        return alert("Словарь пуст. Сначала добавьте слова через обработку текста.");
                    }
                } else {
                    state.words = data;
                    state.gameOrder = [...data];
                }

                state.mode = 'cloud';
                state.idx = 0;
                state.score = 0;
                state.mistakes = 0;
                state.mistakesLog = [];
                state.isReversed = false;
                
                state.gameOrder.sort(() => Math.random() - 0.5);
                
                setLoading(false);
                showScreen('screen-game');
                nextWord();
            } catch (error) {
                console.error('Error loading cloud words:', error);
                setLoading(false);
                alert("Ошибка загрузки: " + error.message);
            }
        }

        async function updateWordProgress(wordId, isCorrect) {
            if (state.mode !== 'cloud' || !state.user) return;

            const word = state.words.find(w => w.id === wordId);
            if (!word) return;

            let newLevel = word.level || 0;
            let newStatus = word.status;
            let nextReview = new Date();
            let correctCount = word.correct_count || 0;
            let wrongCount = word.wrong_count || 0;

            if (isCorrect) {
                newLevel = Math.min(newLevel + 1, 5);
                correctCount++;
                
                if (newLevel >= 5) {
                    newStatus = 'learned';
                } else {
                    newStatus = 'learning';
                }

                // Spaced Repetition intervals (in days)
                const intervals = [0, 1, 3, 7, 14, 30];
                const daysToAdd = intervals[newLevel];
                nextReview.setDate(nextReview.getDate() + daysToAdd);
            } else {
                newLevel = 1;
                wrongCount++;
                newStatus = 'learning';
                nextReview.setDate(nextReview.getDate() + 1);
            }

            try {
                await sb.from('user_words').update({
                    status: newStatus,
                    level: newLevel,
                    correct_count: correctCount,
                    wrong_count: wrongCount,
                    last_seen: new Date().toISOString(),
                    next_review: nextReview.toISOString()
                }).eq('id', wordId);
            } catch (error) {
                console.error('Error updating word progress:', error);
            }
        }

        // ==========================================
        // AI TEXT PROCESSING
        // ==========================================
        async function startProcessing() {
            const text = $('sourceText').value;
            if (text.trim().length < 5) {
                alert("Введите текст для обработки.");
                return;
            }
            
            setLoading(true, "Разбиение на слова...");
            
            const rawWords = text.match(/[a-zA-Z\u00C0-\u00FF]+|[а-яА-ЯёЁ]+/g) || [];
            
            const uniqueSet = new Set();
            rawWords.forEach(w => {
                if (w.length > 2) uniqueSet.add(w.toLowerCase());
            });
            
            let wordsList = Array.from(uniqueSet);
            
            if (wordsList.length < 4) {
                setLoading(false);
                alert("Нужно минимум 4 уникальных слова.");
                return;
            }
            
            if (wordsList.length > 200) {
                if (!confirm(`Найдено ${wordsList.length} слов. Обработать первые 200?`)) {
                    setLoading(false);
                    return;
                }
                wordsList = wordsList.slice(0, 200);
            }
            
            setLoading(true, `ИИ переводит ${wordsList.length} слов...`);
            
            const prompt = `
I have a list of words. 
1. Detect the source language.
2. Translate each word from the source language to Russian.
3. If the source language IS Russian, translate them to English.

Return strictly a JSON array of objects with keys: "original" (source word) and "translation" (translated word).
Return ONLY the JSON array. No markdown, no extra text.

List of words:
${JSON.stringify(wordsList)}
            `;
            
            try {
                let jsonStr = await callAI(prompt);
                
                // Clean markdown wrappers
                jsonStr = jsonStr.replace(/
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренировка Слов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --success-dark: #059669;
            --error: #ef4444;
            --error-dark: #dc2626;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --pink: #ec4899;
            --teal: #14b8a6;
            --orange: #f97316;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100dvh; 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg);
            color: var(--text); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Animated Background --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.2), transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.2), transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.1), transparent 70%);
            animation: globalPulse 10s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes globalPulse {
            0%, 100% { opacity: 0.6; transform: scale(1) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.05) rotate(5deg); }
        }

        /* Floating particles */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(3px 3px at 50% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 80% 10%, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200px 200px, 300px 300px, 250px 250px, 180px 180px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: particleFloat 20s linear infinite;
            pointer-events: none;
        }

        @keyframes particleFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-200px); }
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            border-radius: 20px;
            padding: 18px 28px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s; /* Быстрый отклик */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Button shine effect */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 12px 24px -6px rgba(0, 0, 0, 0.3);
        }

        .btn:active { 
            transform: translateY(0px); 
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2);
        }

        /* Colorful button styles */
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-secondary { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .btn-teal { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .btn-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        
        /* New style for Review Mistakes button */
        .btn-review { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }

        /* --- Screens --- */
        .screen { 
            display: none; /* Скрываем display:none для четкости */
            flex-direction: column; 
            height: 100%; 
            padding: 24px; 
            position: absolute; 
            width: 100%; 
            top: 0; 
            left: 0; 
            /* Убраны плавные переходы opacity/transform */
            z-index: 0;
        }

        .screen.active { 
            display: flex;
            z-index: 1;
            /* Моментальное появление без анимации */
        }

        @keyframes flashAppear {
            /* Ускорено появление */
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- Input Screen --- */
        .input-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: rgba(255, 255, 255, 0.98);
            border-radius: 28px; 
            box-shadow: var(--shadow-lg), 0 0 60px rgba(99, 102, 241, 0.2);
            overflow: hidden; 
            margin-bottom: 24px; 
            position: relative;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            /* Убрана долгая анимация */
        }

        textarea { 
            flex: 1; 
            width: 100%; 
            border: none; 
            padding: 28px; 
            font-size: 16px; 
            resize: none; 
            outline: none; 
            font-family: inherit;
            background: transparent;
            line-height: 1.8;
            color: var(--text);
        }

        textarea::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .controls-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
        }
        .full-width-btn { width: 100%; margin-top: 16px; }

        /* --- Game Screen --- */
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255, 255, 255, 0.98); 
            padding: 20px 24px; 
            border-radius: 24px; 
            box-shadow: var(--shadow), 0 0 40px rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(20px);
            margin-bottom: 24px;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .progress-bar { 
            flex: 1; 
            height: 12px; 
            background: rgba(0, 0, 0, 0.08); 
            border-radius: 12px; 
            margin: 0 24px; 
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            width: 0%; 
            transition: width 0.3s linear; /* Ускорено */
            border-radius: 12px;
            box-shadow: 0 0 20px var(--primary-light);
            position: relative;
        }

        .icon-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            color: #666; 
            cursor: pointer; 
            padding: 10px;
            border-radius: 14px;
            transition: all 0.2s;
        }
        .icon-btn:hover { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--error); 
        }

        .word-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 20vh;
            margin: 24px 0;
        }

        #target-word { 
            font-size: 48px; 
            font-weight: 900; 
            text-align: center; 
            margin-bottom: 16px;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 255, 255, 0.4);
            letter-spacing: 1px;
            /* Убрана долгая анимация появления */
        }

        .word-counter { 
            font-size: 16px; 
            color: rgba(255, 255, 255, 0.95); 
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.25);
            padding: 10px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            font-weight: 700;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .options-area { 
            flex: 1.5; 
            padding: 12px; 
            overflow-y: auto;
        }

        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            height: 100%; 
            align-content: center;
        }

        .option-btn { 
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-radius: 24px; 
            padding: 24px; 
            font-size: 18px; 
            color: var(--text); 
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            min-height: 100px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            word-break: break-word;
            position: relative;
            overflow: hidden;
            /* Убрана задержка и долгая анимация появления */
            animation: cardPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards;
            transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
        }
        
        @keyframes cardPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .option-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 16px 36px rgba(99, 102, 241, 0.25);
            border-color: var(--primary);
        }

        /* --- НОВЫЕ АНИМАЦИИ (ВСПЫШКИ) --- */

        .correct-anim { 
            animation: flashGreen 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashGreen {
            0% { 
                background: #ffffff;
                color: var(--success);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--success);
                border-color: var(--success);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05); /* Легкий "поп" */
            }
            100% { 
                background: var(--success); 
                color: white;
                border-color: var(--success-dark); 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); 
                transform: scale(1);
            }
        }

        .wrong-anim { 
            animation: flashRed 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashRed {
             0% { 
                background: #ffffff;
                color: var(--error);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--error);
                border-color: var(--error);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05);
            }
            100% { 
                background: var(--error); 
                color: white;
                border-color: var(--error-dark); 
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); 
                transform: scale(1);
            }
        }

        /* --- Result Screen --- */
        .result-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            text-align: center;
            color: white;
            overflow-y: auto;
            padding-bottom: 24px;
        }

        .score-circle { 
            width: 200px; 
            height: 200px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            margin: 40px 0; 
            position: relative;
            border: 5px solid rgba(255, 255, 255, 0.6);
            /* Убрана долгая анимация */
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.6), 0 20px 40px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .score-val { 
            font-size: 64px; 
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .result-stats-row {
            display: flex; 
            gap: 18px; 
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat-bubble {
            font-size: 18px;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 700;
        }

        /* --- Mistakes Section --- */
        #mistakes-section {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 20px;
            color: var(--text);
            text-align: left;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .mistake-card {
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--error);
        }
        
        .mistake-card:last-child { margin-bottom: 0; }
        
        .m-word { 
            font-weight: 800; 
            font-size: 18px; 
            color: var(--text); 
            margin-bottom: 8px;
        }
        
        .m-wrong { 
            color: var(--error); 
            font-size: 15px; 
            text-decoration: line-through; 
            margin-right: 12px; 
            font-weight: 600;
        }
        
        .m-right { 
            color: var(--success-dark); 
            font-size: 15px; 
            font-weight: 800; 
        }

        /* --- Loader --- */
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }

        .spinner { 
            width: 70px; 
            height: 70px;
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary), var(--purple), var(--pink));
            animation: spinnerPulse 1.5s infinite, spinnerRotate 2s linear infinite;
            margin-bottom: 24px; 
            box-shadow: 0 0 40px var(--primary);
            position: relative;
        }

        .spinner::after {
            content: '';
            position: absolute;
            inset: 8px;
            background: white;
            border-radius: 50%;
        }

        @keyframes spinnerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--primary); }
            50% { transform: scale(1.1); box-shadow: 0 0 60px var(--primary-light); }
        }

        @keyframes spinnerRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loader-text {
            color: var(--primary);
            font-weight: 800;
            font-size: 24px;
            margin-bottom: 12px;
        }

        #loader-sub {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            padding: 0 24px;
            max-width: 400px;
        }

        .hidden-file { display: none; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--primary), var(--purple)); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, var(--primary-dark), var(--purple)); 
        }

        @media (max-width: 480px) {
            body, html { padding: 0; }
            .screen { padding: 16px; }
            #target-word { font-size: 38px; }
            .option-btn { font-size: 16px; min-height: 90px; padding: 18px; }
            .score-circle { width: 170px; height: 170px; }
            .score-val { font-size: 54px; }
            .btn { padding: 16px 22px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: INPUT -->
    <div id="screen-input" class="screen active">
        <div class="input-wrapper">
            <textarea id="sourceText" placeholder="Вставьте текст...&#10;&#10;Программа создаст словарь для тренировки"></textarea>
        </div>
        
        <button class="btn btn-primary full-width-btn" onclick="startProcessing()">
            <i class="fas fa-magic"></i>
            <span>Старт</span>
        </button>
        <div class="controls-row">
            <button class="btn btn-teal" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-upload"></i>
                <span>Импорт</span>
            </button>
            <button class="btn btn-orange" onclick="smartReset()">
                <i class="fas fa-arrows-rotate"></i>
                <span>Сбросить</span>
            </button>
        </div>
        <input type="file" id="fileInput" class="hidden-file" accept=".words,.json" onchange="importWords(this)">
    </div>

    <!-- SCREEN 2: GAME -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span style="font-weight: 800; color: var(--primary); font-size: 18px;">
                <i class="fas fa-star" style="color: var(--warning);"></i> 
                <span id="score">0</span>
            </span>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <button class="icon-btn" onclick="goToInput()" style="margin-left: 10px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="word-area">
            
            <div id="target-word">Word</div>
        </div>
        <div class="options-area">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="screen">
        <div class="result-content">
            <div class="score-circle">
                <span class="score-val" id="final-percent">0%</span>
                <span style="font-size: 17px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Точность</span>
            </div>
            <div class="result-stats-row">
                <div class="stat-bubble">
                    <i class="fas fa-list-check"></i> Всего: <strong id="res-total">0</strong>
                </div>
                <div class="stat-bubble">
                    <i class="fas fa-times-circle"></i> Ошибок: <strong id="res-errors" style="color: #ffcccc">0</strong>
                </div>
            </div>

            <button class="btn btn-success full-width-btn" onclick="restartGame(false)">
                <i class="fas fa-redo"></i>
                <span>Пройти заново</span>
            </button>

            <button class="btn btn-pink full-width-btn" onclick="restartGame(true)" style="margin-top: 12px;">
                <i class="fas fa-exchange-alt"></i>
                <span>Играть наоборот</span>
            </button>

            <!-- ОБНОВЛЕННАЯ КНОПКА ОШИБОК -->
            <button id="btn-show-mistakes" class="btn btn-review full-width-btn" onclick="toggleMistakes()" style="margin-top: 12px; display: none;">
                <i class="fas fa-clipboard-list"></i>
                <span>Работа над ошибками</span>
            </button>

            <button class="btn btn-info full-width-btn" onclick="goToInput()" style="margin-top: 12px;">
                <i class="fas fa-home"></i>
                <span>Главное меню</span>
            </button>
            
            <button class="btn btn-warning full-width-btn" onclick="exportWords()" style="margin-top: 12px;">
                <i class="fas fa-download"></i>
                <span>Сохранить словарь</span>
            </button>

            <!-- Mistakes List -->
            <div id="mistakes-section">
                <h4 style="margin: 0 0 16px 0; color: var(--primary); font-size: 20px;">
                    <i class="fas fa-exclamation-triangle"></i> Что исправить:
                </h4>
                <div id="mistakes-container"></div>
            </div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <h3 id="loader-text">Анализ текста...</h3>
        <p id="loader-sub"></p>
    </div>

    <script>
        // --- CONFIG ---
        const MAPRUAPP_PROXY = "https://mapruapp.ru";
        const VERCEL_PROXY = "https://ver-olive-delta.vercel.app";
        const MODEL = "gemini-2.0-flash-exp";
        
        // Dynamic proxy switching
        let currentProxyIndex = 0; // 0 = MAPRUAPP, 1 = VERCEL
        
        // --- STATE ---
        let state = {
            words: [],
            gameOrder: [],
            idx: 0,
            score: 0,
            mistakes: 0,
            mistakesLog: [],
            isReversed: false,
            locked: false
        };

        // --- 1. SMART RESET LOGIC ---
        async function smartReset() {
            const txtArea = document.getElementById('sourceText');
            txtArea.value = '';
            
            try {
                const text = await navigator.clipboard.readText();
                const wordCount = text.trim().split(/\s+/).length;
                
                if (wordCount > 10) {
                    txtArea.value = text;
                    txtArea.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    setTimeout(() => txtArea.style.background = 'transparent', 600);
                }
            } catch (err) {
                console.log('Clipboard access denied or empty');
            }
        }

        // --- 2. AUTO-LANG PROCESSING ---
        async function startProcessing() {
            const text = document.getElementById('sourceText').value;
            if (text.trim().length < 5) {
                alert("Введите текст для обработки.");
                return;
            }
            setLoading(true, "Разбиение на слова...");
            
            const rawWords = text.match(/[a-zA-Z\u00C0-\u00FF]+|[а-яА-ЯёЁ]+/g) || [];
            
            const uniqueSet = new Set();
            rawWords.forEach(w => {
                if (w.length > 2) uniqueSet.add(w.toLowerCase());
            });
            
            let wordsList = Array.from(uniqueSet);
            if (wordsList.length < 4) {
                setLoading(false);
                alert("Нужно минимум 4 уникальных слова.");
                return;
            }
            
            if (wordsList.length > 200) {
                if (!confirm(`Найдено ${wordsList.length} слов. Обработать первые 200?`)) {
                    setLoading(false); 
                    return;
                }
                wordsList = wordsList.slice(0, 200);
            }
            
            setLoading(true, `ИИ определяет язык и переводит (${wordsList.length} слов)...`);
            
            const prompt = `
I have a list of words. 
1. Detect the source language.
2. Translate each word from the source language to Russian.
3. If the source language IS Russian, translate them to English.

Return strictly a JSON array of objects with keys: "original" (source word) and "translation" (translated word).
Return ONLY the JSON array. No markdown, no extra text.

List of words:
${JSON.stringify(wordsList)}
            `;
            
            try {
                let jsonStr = await callAI(prompt);
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const translatedData = JSON.parse(jsonStr);
                if (!Array.isArray(translatedData)) throw new Error("Invalid AI response format");
                
                state.words = translatedData.filter(item => 
                    item.original && item.translation && !item.original.includes(' ')
                );
                
                if (state.words.length < 4) {
                    throw new Error("Получено недостаточно корректных переводов");
                }
                
                startGame(false);
            } catch (e) {
                console.error(e);
                alert("Ошибка ИИ: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        // --- AI CALL WITH AUTO PROXY SWITCHING ---
        async function callAI(prompt) {
            const proxies = [
                {
                    name: "MAPRUAPP",
                    url: `${MAPRUAPP_PROXY}/ai/api/v1/chat/completions`,
                    buildBody: () => ({
                        model: MODEL,
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 8000,
                        response_format: { type: "json_object" }
                    }),
                    extractContent: (data) => data.choices[0].message.content
                },
                {
                    name: "VERCEL",
                    url: `${VERCEL_PROXY}/v1beta/models/${MODEL}:generateContent`,
                    buildBody: () => ({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    }),
                    extractContent: (data) => data.candidates[0].content.parts[0].text
                }
            ];

            let attempts = 0;
            const maxAttempts = proxies.length;

            while (attempts < maxAttempts) {
                const proxy = proxies[currentProxyIndex];
                
                try {
                    console.log(`Попытка запроса через ${proxy.name}...`);
                    
                    const res = await fetch(proxy.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxy.buildBody())
                    });
                    
                    if (!res.ok) {
                        throw new Error(`${proxy.name} returned status ${res.status}`);
                    }
                    
                    const data = await res.json();
                    const content = proxy.extractContent(data);
                    
                    console.log(`✓ Успешный ответ от ${proxy.name}`);
                    return content;
                    
                } catch (error) {
                    console.error(`✗ Ошибка ${proxy.name}:`, error.message);
                    
                    // Switch to next proxy
                    currentProxyIndex = (currentProxyIndex + 1) % proxies.length;
                    attempts++;
                    
                    if (attempts < maxAttempts) {
                        console.log(`Переключение на ${proxies[currentProxyIndex].name}...`);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay before retry
                    }
                }
            }
            
            throw new Error("Все прокси недоступны. Проверьте соединение.");
        }

        // --- GAMEPLAY ---
        function startGame(reversed = false) {
            if (state.words.length < 4) {
                alert("Слишком мало слов.");
                return;
            }
            state.isReversed = reversed;
            state.gameOrder = [...state.words].sort(() => Math.random() - 0.5);
            state.idx = 0;
            state.score = 0;
            state.mistakes = 0;
            state.mistakesLog = [];
            showScreen('screen-game');
            nextWord();
        }

        function restartGame(reversed) {
            startGame(reversed);
        }

        function nextWord() {
            if (state.idx >= state.gameOrder.length) {
                endGame();
                return;
            }
            state.locked = false;
            const current = state.gameOrder[state.idx];
            
            const targetEl = document.getElementById('target-word');
            // Reset anim to keep it sharp but simple
            targetEl.style.animation = 'none';
            targetEl.offsetHeight; 
            targetEl.style.animation = 'flashAppear 0.3s ease-out';
            
            const questionText = state.isReversed ? current.translation : current.original;
            targetEl.textContent = questionText;

            document.getElementById('score').textContent = state.score;
            const pct = (state.idx / state.gameOrder.length) * 100;
            document.getElementById('progress').style.width = `${pct}%`;
            
            renderOptions(current);
        }

        function renderOptions(correct) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            let pool = state.words.filter(w => w.original !== correct.original);
            let distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3);
            let options = [correct, ...distractors].sort(() => Math.random() - 0.5);
            
            const answerKey = state.isReversed ? 'original' : 'translation';

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt[answerKey];
                // Ускорена анимация появления кнопок
                btn.style.animationDelay = (index * 0.05) + 's';
                btn.onclick = () => handleAnswer(opt, correct, btn);
                container.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btn) {
            if (state.locked) return;
            state.locked = true;
            
            const isCorrect = selected.original === correct.original;
            
            if (isCorrect) {
                btn.classList.add('correct-anim');
                state.score++;
            } else {
                btn.classList.add('wrong-anim');
                state.mistakes++;
                
                const qKey = state.isReversed ? 'translation' : 'original';
                const aKey = state.isReversed ? 'original' : 'translation';
                state.mistakesLog.push({
                    word: correct[qKey],
                    chosen: selected[aKey],
                    correct: correct[aKey]
                });

                const correctText = correct[state.isReversed ? 'original' : 'translation'];
                Array.from(document.querySelectorAll('.option-btn')).forEach(b => {
                    if (b.textContent === correctText) {
                        b.style.transition = "all 0.3s";
                        b.style.border = "4px solid var(--success)";
                        b.style.boxShadow = "0 0 30px var(--success)";
                        b.style.transform = "scale(1.05)";
                    }
                });
            }
            
            // Ускорено переключение (600ms вместо 1200ms)
            setTimeout(() => {
                state.idx++;
                nextWord();
            }, 600);
        }

        function endGame() {
            showScreen('screen-result');
            const total = state.gameOrder.length;
            const accuracy = Math.round((state.score / total) * 100);
            
            document.getElementById('final-percent').textContent = `${accuracy}%`;
            document.getElementById('res-total').textContent = total;
            document.getElementById('res-errors').textContent = state.mistakes;

            const mistakesBtn = document.getElementById('btn-show-mistakes');
            const mistakesSec = document.getElementById('mistakes-section');
            mistakesSec.style.display = 'none';
            
            if (state.mistakesLog.length > 0) {
                mistakesBtn.style.display = 'flex';
                renderMistakesList();
            } else {
                mistakesBtn.style.display = 'none';
            }
        }

        function renderMistakesList() {
            const container = document.getElementById('mistakes-container');
            container.innerHTML = '';
            state.mistakesLog.forEach(log => {
                const div = document.createElement('div');
                div.className = 'mistake-card';
                div.innerHTML = `
                    <div class="m-word"><i class="fas fa-circle-exclamation" style="color: var(--error); margin-right: 6px;"></i>${log.word}</div>
                    <div>
                        <span class="m-wrong"><i class="fas fa-xmark"></i> ${log.chosen}</span>
                        <span class="m-right"><i class="fas fa-check"></i> ${log.correct}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleMistakes() {
            const sec = document.getElementById('mistakes-section');
            const btn = document.getElementById('btn-show-mistakes');
            if (sec.style.display === 'none') {
                sec.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i><span>Скрыть ошибки</span>';
                setTimeout(() => {
                    const resContent = document.querySelector('.result-content');
                    resContent.scrollTop = resContent.scrollHeight;
                }, 100);
            } else {
                sec.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-clipboard-list"></i><span>Работа над ошибками</span>';
            }
        }

        // --- IMPORT / EXPORT ---
        function exportWords() {
            if (!state.words || state.words.length === 0) return;
            const dataStr = JSON.stringify(state.words, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dictionary_${new Date().getTime()}.words`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importWords(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json) && json.length > 0 && json[0].original) {
                        state.words = json;
                        alert(`✓ Загружено ${json.length} слов.`);
                        startGame(false);
                    } else { 
                        throw new Error("Неверный формат"); 
                    }
                } catch (err) { 
                    alert("Ошибка чтения файла: " + err.message); 
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- NAVIGATION & UI ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToInput() {
            showScreen('screen-input');
        }

        function setLoading(active, text = "") {
            document.getElementById('loader').style.display = active ? 'flex' : 'none';
            document.getElementById('loader-sub').textContent = text;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Википедия</title>
    <link rel="shortcut icon" href="img/wiki.svg" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    --bg-gradient: linear-gradient(135deg, #e8f4fc 0%, #f0f8ff 50%, #e6f2ff 100%);
    --bg-primary: #f5faff;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e8f4fc;
    --bg-hover: #d6ebfa;
    --bg-frost: rgba(255, 255, 255, 0.85);
    --text-primary: #1e3a5f;
    --text-secondary: #4a6d8c;
    --text-muted: #8ba4bc;
    --accent-color: #4facfe;
    --accent-hover: #00c6fb;
    --accent-light: #e0f4ff;
    --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --accent-glow: rgba(79, 172, 254, 0.25);
    --border-color: #c8e3f5;
    --border-light: #a8d4f0;
    --success-color: #22c997;
    --success-gradient: linear-gradient(135deg, #22c997 0%, #00d4aa 100%);
    --warning-color: #ffb347;
    --danger-color: #ff6b6b;
    --purple-color: #a78bfa;
    --purple-gradient: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
    --orange-gradient: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    --shadow-soft: 0 4px 20px rgba(79, 172, 254, 0.1);
    --shadow-card: 0 8px 32px rgba(79, 172, 254, 0.12);
    --shadow-hover: 0 12px 40px rgba(79, 172, 254, 0.18);
    --shadow-glow: 0 0 30px rgba(79, 172, 254, 0.2);
    --border-radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    height: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.5;
    overflow: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: 
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.8) 1px, transparent 1px),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,0.6) 1px, transparent 1px),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,0.7) 1px, transparent 1px);
    background-size: 100px 100px, 150px 150px, 200px 200px;
    pointer-events: none;
    z-index: 0;
}

.app-container {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 1400px;
    margin: 0 auto;
    background: var(--bg-frost);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow-card);
    border-left: 1px solid rgba(255,255,255,0.5);
    border-right: 1px solid rgba(255,255,255,0.5);
}

.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(232,244,252,0.95) 100%);
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-title img {
    width: 24px;
    height: 24px;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 38px;
    padding: 0 14px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    gap: 8px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.header-btn:hover {
    background: var(--accent-light);
    color: var(--accent-color);
    border-color: var(--accent-color);
    transform: translateY(-1px);
}

.header-btn i { font-size: 14px; }

.header-btn.icon-only {
    width: 38px;
    padding: 0;
}

.main-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.main-content::-webkit-scrollbar { width: 8px; }
.main-content::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 4px; }
.main-content::-webkit-scrollbar-thumb { 
    background: linear-gradient(180deg, var(--accent-color) 0%, #22d3ee 100%);
    border-radius: 4px; 
}

.response-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(232,244,252,0.9) 100%);
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    flex-shrink: 0;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    color: white;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-hover);
}

.action-btn i { font-size: 13px; }

#copy-btn { background: var(--accent-gradient); }
#print-btn { background: var(--success-gradient); }
#export-html-btn { background: var(--purple-gradient); }
#new-search-btn { background: var(--orange-gradient); margin-left: auto; }

.input-panel {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 20px;
    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(232,244,252,0.95) 100%);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

#query-input {
    flex: 1;
    height: 48px;
    padding: 0 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 24px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: inherit;
    text-align: center;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

#query-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: var(--shadow-glow);
}

#query-input::placeholder { color: var(--text-muted); }

.input-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 18px;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
}

#send-btn {
    background: var(--accent-gradient);
}

#send-btn:hover { 
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-glow);
}

#send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

#query-input:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.lang-selector {
    height: 48px;
    padding: 0 16px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    box-shadow: var(--shadow-soft);
}

.lang-selector:focus {
    outline: none;
    border-color: var(--accent-color);
}

.placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
}

.placeholder-icon {
    width: 90px;
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-gradient);
    border-radius: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-glow);
}

.placeholder-icon i {
    font-size: 40px;
    color: white;
}

.placeholder-icon img {
    width: 50px;
    height: 50px;
    filter: brightness(0) invert(1);
}

.placeholder h2 {
    font-size: 22px;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
}

.placeholder p {
    font-size: 15px;
    max-width: 400px;
    line-height: 1.6;
}

.loader-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 20px;
    box-shadow: var(--shadow-glow);
}

@keyframes spin { to { transform: rotate(360deg); } }

.panel {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-color);
    padding: 24px;
    animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(15px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.dossier-header {
    text-align: center;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 20px;
    margin-bottom: 24px;
}

.dossier-title-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 14px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.dossier-title-container h2 {
    font-size: 1.8rem;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
}

.wiki-link-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 50%;
    text-decoration: none;
    font-size: 16px;
    transition: all 0.2s ease;
    border: 1px solid var(--border-color);
}

.wiki-link-btn:hover {
    background: var(--accent-gradient);
    color: white;
    transform: scale(1.1);
    border-color: transparent;
}

.dossier-header p {
    font-size: 15px;
    color: var(--text-secondary);
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.7;
}

.dossier-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
}

.dossier-card {
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.dossier-card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
}

.card-header {
    font-size: 14px;
    font-weight: 600;
    padding: 14px 18px;
    background: linear-gradient(135deg, var(--accent-light) 0%, rgba(79,172,254,0.1) 100%);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
}

.card-header i {
    color: var(--accent-color);
    font-size: 16px;
}

.card-content {
    padding: 12px 18px 16px;
}

.fact-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.fact-table td {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    vertical-align: top;
}

.fact-table tr:last-child td {
    border-bottom: none;
}

.fact-table td:first-child {
    font-weight: 500;
    color: var(--text-muted);
    width: 40%;
    padding-right: 12px;
}

.fact-table td:last-child {
    color: var(--text-primary);
    word-break: break-word;
}

.fact-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.fact-list li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    gap: 16px;
    font-size: 13px;
}

.fact-list li:last-child { border-bottom: none; }

.fact-list .label {
    font-weight: 500;
    color: var(--text-muted);
    flex-shrink: 0;
    max-width: 40%;
}

.fact-list .value {
    text-align: right;
    word-break: break-word;
    color: var(--text-primary);
}

.text-expandable {
    cursor: pointer;
    color: var(--accent-color);
    transition: color 0.2s ease;
}

.text-expandable:hover {
    color: var(--accent-hover);
    text-decoration: underline;
}

.disambiguation-list {
    list-style: none;
    padding: 10px 0;
}

.disambiguation-list li {
    margin-bottom: 8px;
}

.disambiguation-link {
    display: block;
    padding: 14px 18px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    text-decoration: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.disambiguation-link:hover {
    background: var(--accent-light);
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateX(4px);
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30, 58, 95, 0.3);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(245,250,255,0.98) 100%);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    width: 100%;
    max-width: 480px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(79, 172, 254, 0.2);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
}

.modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
    margin: 0;
}

.modal-header h2 i { color: var(--accent-color); }

.modal-close {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.modal-close:hover { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color);
}

.modal-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
}

.settings-group {
    margin-bottom: 20px;
}

.settings-group:last-child { margin-bottom: 0; }

.settings-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.settings-group select,
.settings-group input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.settings-group select:focus,
.settings-group input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: var(--shadow-glow);
}

.settings-group small {
    display: block;
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-muted);
}

.settings-group small a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 500;
}

.settings-group small a:hover { text-decoration: underline; }

.save-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent-gradient);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 24px;
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
}

.save-btn:hover { 
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow);
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover {
    background: var(--accent-light);
    border-color: var(--accent-color);
}

.history-item-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.history-item-delete {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.history-item-delete:hover {
    background: var(--danger-color);
    color: white;
}

.history-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.history-empty i {
    font-size: 36px;
    margin-bottom: 12px;
    opacity: 0.5;
}

.clear-history-btn {
    width: 100%;
    padding: 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 16px;
    transition: all 0.2s ease;
}

.clear-history-btn:hover {
    background: var(--danger-color);
    color: white;
    border-color: var(--danger-color);
}

@media print {
    body::before, .app-header, .input-panel, .response-actions { display: none !important; }
    body, .app-container { background: white !important; height: auto !important; box-shadow: none !important; }
    .main-content { overflow: visible !important; padding: 0 !important; }
    .panel { box-shadow: none !important; border: none !important; }
    .dossier-card { break-inside: avoid; }
}

@media (max-width: 600px) {
    body::before { display: none; }
    .app-header { padding: 10px 14px; }
    .header-title span { display: none; }
    .main-content { padding: 14px; }
    .input-panel { padding: 12px 14px; gap: 8px; }
    #query-input { height: 44px; font-size: 14px; }
    .input-btn { width: 44px; height: 44px; }
    .lang-selector { height: 44px; padding: 0 10px; font-size: 13px; }
    .dossier-grid { grid-template-columns: 1fr; }
    .dossier-title-container h2 { font-size: 1.4rem; }
    .response-actions { gap: 8px; padding: 10px 14px; }
    .action-btn { padding: 6px 12px; font-size: 12px; }
    .action-btn span { display: none; }
    .modal-content { max-width: 100%; border-radius: 16px; }
}
</style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="header-title">
            <img src="img/wiki.svg" alt="Wiki">
            <span>Википедия</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="history-btn" title="История поиска">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <span>История</span>
            </button>
            <button class="header-btn icon-only" id="settings-btn" title="Настройки">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <div class="response-actions" id="response-actions">
        <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i><span>Копировать</span></button>
        <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i><span>Печать</span></button>
        <button class="action-btn" id="export-html-btn"><i class="fa-solid fa-file-code"></i><span>HTML</span></button>
        <button class="action-btn" id="new-search-btn"><i class="fa-solid fa-plus"></i><span>Новый</span></button>
    </div>

    <main class="main-content" id="main-content">
        <div class="placeholder">
            <div class="placeholder-icon">
                <img src="img/wiki.svg" alt="Wiki">
            </div>
            <h2>Википедия</h2>
            <p>Введите запрос, чтобы получить структурированную справку из Википедии</p>
        </div>
    </main>

    <div class="input-panel">
        <select class="lang-selector" id="lang-selector" title="Язык Wikipedia">
            <option value="ru">RU</option>
            <option value="en">EN</option>
            <option value="de">DE</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
        </select>
        <input type="text" id="query-input" placeholder="Введите запрос для поиска...">
        <button class="input-btn" id="send-btn" title="Найти"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-cog"></i> Настройки</h2>
            <button class="modal-close" id="close-settings"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="settings-group">
                <label>Модель ИИ</label>
                <select id="model-selector"></select>
            </div>
            <div class="settings-group">
                <label>Режим подключения</label>
                <select id="api-mode-selector"></select>
            </div>
            <div class="settings-group" id="api-key-group" style="display:none;">
                <label>API ключ</label>
                <input type="password" id="api-key-input" placeholder="Введите ключ...">
                <small>Получить: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> | <a href="https://console.mistral.ai/api-keys/" target="_blank">Mistral</a></small>
            </div>
            <button class="save-btn" id="save-settings">Сохранить</button>
        </div>
    </div>
</div>

<div id="history-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> История поиска</h2>
            <button class="modal-close" id="close-history"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="history-list" id="history-list"></div>
            <button class="clear-history-btn" id="clear-history">Очистить историю</button>
        </div>
    </div>
</div>

<script>
const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
const DEFAULT_MODEL = "gemini-3-flash-preview";

const MODELS = [
    { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini" },
    { id: "gemini-2.5-flash-lite-preview-06-25", uiName: "Gemini 2.5 Flash Lite Preview", apiType: "gemini" },
    { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini" },
    { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini" },
    { id: "gemini-3-pro-preview", uiName: "Gemini 3 Pro Preview", apiType: "gemini" },
    { id: "nvidia/nemotron-3-nano-30b-a3b:free", uiName: "NVIDIA Nemotron 3 Nano 30B", apiType: "openrouter" },
    { id: "gpt-oss-20b-free", uiName: "OpenAI GPT-OSS 20B", apiType: "openrouter" },
    { id: "mistral-large-2512", uiName: "Mistral Large", apiType: "mistral" },
    { id: "mistral-medium-2508", uiName: "Mistral Medium", apiType: "mistral" },
];

const API_MODES = {
    'mapruapp': { uiName: 'Прокси (MapRuApp)', icon: 'fa-solid fa-server' },
    'vercel': { uiName: 'Прокси (Vercel)', icon: 'fa-solid fa-cloud' },
    'direct': { uiName: 'Прямой (Gemini)', icon: 'fa-solid fa-key' },
    'direct_mistral': { uiName: 'Прямой (Mistral)', icon: 'fa-solid fa-bolt' }
};

const SYSTEM_PROMPT = `
Ты — ИИ-аналитик для создания структурированных справок из Википедии.
Проанализируй текст статьи и верни подробную характеристику в СТРОГОМ формате JSON.

ПРИНЦИПЫ:
1. Определи тип объекта и выбери релевантные разделы
2. Запрещено придумывать данные. Если информации нет — не включай параметр
3. Ответ ДОЛЖЕН БЫТЬ только валидным JSON без markdown-оберток
4. Значения параметров до 80 символов
5. Включай только значимую информацию

СТРУКТУРА JSON:
{
  "title": "Название объекта",
  "summary": "Резюме в 2-4 предложениях",
  "sections": [
    {
      "title": "Название раздела",
      "icon": "fa-solid fa-circle-info",
      "displayType": "table" | "list",
      "data": [
        { "label": "Параметр", "value": "Значение" }
      ]
    }
  ]
}

ПРАВИЛА:
- Минимум 3 параметра в разделе, максимум 8
- displayType "table" для технических данных
- displayType "list" для описательной информации
- Исключай пустые параметры

ИКОНКИ:
- Общая информация: "fa-solid fa-circle-info"
- Технические характеристики: "fa-solid fa-microchip"
- Биография: "fa-solid fa-book-open"
- География: "fa-solid fa-earth-americas"
- Население: "fa-solid fa-users"
`;

let currentModelId = DEFAULT_MODEL;
let currentApiMode = 'mapruapp';
let currentApiType = 'gemini';
let apiKey = '';
let currentLang = 'ru';
let searchHistory = [];
let lastDossierHtml = '';
let lastDossierTitle = '';

const $ = id => document.getElementById(id);
const queryInput = $('query-input');
const sendButton = $('send-btn');
const mainContent = $('main-content');
const responseActions = $('response-actions');
const settingsModal = $('settings-modal');
const historyModal = $('history-modal');
const modelSelector = $('model-selector');
const apiModeSelector = $('api-mode-selector');
const apiKeyGroup = $('api-key-group');
const apiKeyInput = $('api-key-input');
const langSelector = $('lang-selector');
const historyList = $('history-list');

function init() {
    loadSettings();
    renderModels();
    renderApiModes();
    renderHistory();
    bindEvents();
}

function bindEvents() {
    sendButton.onclick = handleSearch;
    queryInput.onkeydown = e => { if (e.key === 'Enter') handleSearch(); };
    
    $('settings-btn').onclick = () => { settingsModal.style.display = 'flex'; };
    $('close-settings').onclick = () => { settingsModal.style.display = 'none'; };
    settingsModal.onclick = e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; };
    $('save-settings').onclick = saveSettings;
    
    $('history-btn').onclick = () => { renderHistory(); historyModal.style.display = 'flex'; };
    $('close-history').onclick = () => { historyModal.style.display = 'none'; };
    historyModal.onclick = e => { if (e.target === historyModal) historyModal.style.display = 'none'; };
    $('clear-history').onclick = clearHistory;
    
    modelSelector.onchange = updateApiModeVisibility;
    apiModeSelector.onchange = updateApiKeyVisibility;
    langSelector.onchange = () => { currentLang = langSelector.value; };
    
    $('copy-btn').onclick = copyDossier;
    $('print-btn').onclick = () => window.print();
    $('export-html-btn').onclick = exportToHtml;
    $('new-search-btn').onclick = newSearch;
    
    mainContent.onclick = e => {
        if (e.target.classList.contains('disambiguation-link')) {
            e.preventDefault();
            fetchArticle(e.target.dataset.title);
        }
        if (e.target.classList.contains('text-expandable')) {
            toggleExpand(e.target);
        }
    };
}

function renderModels() {
    modelSelector.innerHTML = MODELS.map(m => 
        `<option value="${m.id}" data-api="${m.apiType}">${m.uiName}</option>`
    ).join('');
    modelSelector.value = currentModelId;
}

function renderApiModes() {
    apiModeSelector.innerHTML = Object.entries(API_MODES).map(([key, mode]) => 
        `<option value="${key}">${mode.uiName}</option>`
    ).join('');
    apiModeSelector.value = currentApiMode;
    updateApiModeVisibility();
}

function updateApiModeVisibility() {
    const model = MODELS.find(m => m.id === modelSelector.value);
    if (model) currentApiType = model.apiType;
    
    const options = apiModeSelector.querySelectorAll('option');
    options.forEach(opt => {
        const mode = opt.value;
        if (currentApiType === 'gemini') {
            opt.style.display = (mode === 'direct_mistral') ? 'none' : '';
        } else if (currentApiType === 'mistral') {
            opt.style.display = (mode === 'direct' || mode === 'vercel') ? 'none' : '';
        } else if (currentApiType === 'openrouter') {
            opt.style.display = (mode === 'mapruapp') ? '' : 'none';
        }
    });
    
    const currentOpt = apiModeSelector.querySelector(`option[value="${currentApiMode}"]`);
    if (currentOpt && currentOpt.style.display === 'none') {
        currentApiMode = 'mapruapp';
        apiModeSelector.value = 'mapruapp';
    }
    updateApiKeyVisibility();
}

function updateApiKeyVisibility() {
    currentApiMode = apiModeSelector.value;
    const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                     (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
    apiKeyGroup.style.display = needsKey ? 'block' : 'none';
}

function loadSettings() {
    currentModelId = localStorage.getItem('wiki_modelId') || DEFAULT_MODEL;
    currentApiMode = localStorage.getItem('wiki_apiMode') || 'mapruapp';
    apiKey = localStorage.getItem('wiki_apiKey') || '';
    currentLang = localStorage.getItem('wiki_lang') || 'ru';
    searchHistory = JSON.parse(localStorage.getItem('wiki_history') || '[]');
    
    const model = MODELS.find(m => m.id === currentModelId);
    if (model) currentApiType = model.apiType;
    
    apiKeyInput.value = apiKey;
    langSelector.value = currentLang;
}

function saveSettings() {
    currentModelId = modelSelector.value;
    const model = MODELS.find(m => m.id === currentModelId);
    if (model) currentApiType = model.apiType;
    
    currentApiMode = apiModeSelector.value;
    apiKey = apiKeyInput.value.trim();
    
    const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                     (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
    if (needsKey && !apiKey) {
        alert('Введите API ключ для прямого режима');
        return;
    }
    
    localStorage.setItem('wiki_modelId', currentModelId);
    localStorage.setItem('wiki_apiMode', currentApiMode);
    localStorage.setItem('wiki_apiKey', apiKey);
    
    settingsModal.style.display = 'none';
}

function addToHistory(query) {
    searchHistory = searchHistory.filter(h => h !== query);
    searchHistory.unshift(query);
    if (searchHistory.length > 20) searchHistory.pop();
    localStorage.setItem('wiki_history', JSON.stringify(searchHistory));
}

function renderHistory() {
    if (searchHistory.length === 0) {
        historyList.innerHTML = `
            <div class="history-empty">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <p>История поиска пуста</p>
            </div>`;
        return;
    }
    
    historyList.innerHTML = searchHistory.map((item, i) => `
        <div class="history-item" data-query="${item}">
            <span class="history-item-text">${item}</span>
            <button class="history-item-delete" data-index="${i}" title="Удалить">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    `).join('');
    
    historyList.querySelectorAll('.history-item').forEach(el => {
        el.onclick = e => {
            if (e.target.closest('.history-item-delete')) {
                const idx = e.target.closest('.history-item-delete').dataset.index;
                searchHistory.splice(idx, 1);
                localStorage.setItem('wiki_history', JSON.stringify(searchHistory));
                renderHistory();
            } else {
                queryInput.value = el.dataset.query;
                historyModal.style.display = 'none';
                handleSearch();
            }
        };
    });
}

function clearHistory() {
    searchHistory = [];
    localStorage.setItem('wiki_history', JSON.stringify(searchHistory));
    renderHistory();
}

function setUI(state, message = '') {
    sendButton.disabled = state === 'loading';
    queryInput.disabled = state === 'loading';
    responseActions.style.display = state === 'results' ? 'flex' : 'none';
    
    if (state === 'loading') {
        mainContent.innerHTML = `
            <div class="placeholder">
                <div class="loader-spinner"></div>
                <p>${message}</p>
            </div>`;
    } else if (state === 'error') {
        mainContent.innerHTML = `
            <div class="placeholder">
                <div class="placeholder-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h2 style="-webkit-text-fill-color: #ff6b6b;">Ошибка</h2>
                <p>${message}</p>
            </div>`;
    } else if (state === 'welcome') {
        mainContent.innerHTML = `
            <div class="placeholder">
                <div class="placeholder-icon">
                    <img src="img/wiki.svg" alt="Wiki">
                </div>
                <h2>Википедия</h2>
                <p>Введите запрос, чтобы получить структурированную справку из Википедии</p>
            </div>`;
    }
}

function newSearch() {
    queryInput.value = '';
    lastDossierHtml = '';
    lastDossierTitle = '';
    setUI('welcome');
}

async function handleSearch() {
    const query = queryInput.value.trim();
    if (!query) return;
    
    const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                     (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
    if (needsKey && !apiKey) {
        settingsModal.style.display = 'flex';
        return;
    }
    
    addToHistory(query);
    setUI('loading', 'Поиск в Википедии...');
    
    try {
        const wikiApi = `https://${currentLang}.wikipedia.org/w/api.php?origin=*&action=query&format=json`;
        const response = await fetch(`${wikiApi}&list=search&srlimit=5&srsearch=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('Ошибка сети при поиске');
        
        const data = await response.json();
        if (!data.query.search?.length) {
            setUI('error', 'По вашему запросу ничего не найдено');
            return;
        }
        
        if (data.query.search.length > 1) {
            showDisambiguation(data.query.search);
        } else {
            await fetchArticle(data.query.search[0].title);
        }
    } catch (error) {
        setUI('error', error.message);
    }
}

function showDisambiguation(options) {
    responseActions.style.display = 'none';
    mainContent.innerHTML = `
        <div class="panel">
            <div class="card-header">
                <i class="fa-solid fa-list"></i>
                <span>Уточните запрос</span>
            </div>
            <ul class="disambiguation-list">
                ${options.map(opt => `
                    <li>
                        <a href="#" class="disambiguation-link" data-title="${opt.title}">${opt.title}</a>
                    </li>
                `).join('')}
            </ul>
        </div>`;
}

async function fetchArticle(title) {
    setUI('loading', 'Загрузка статьи...');
    
    try {
        const wikiApi = `https://${currentLang}.wikipedia.org/w/api.php?origin=*&action=query&format=json`;
        const wikiUrl = `https://${currentLang}.wikipedia.org/wiki/${encodeURIComponent(title.replace(/ /g, '_'))}`;
        
        const response = await fetch(`${wikiApi}&prop=extracts&explaintext=1&titles=${encodeURIComponent(title)}`);
        if (!response.ok) throw new Error('Ошибка загрузки статьи');
        
        const data = await response.json();
        const pages = data.query.pages;
        const articleText = pages[Object.keys(pages)[0]].extract;
        
        if (!articleText) throw new Error('Не удалось извлечь текст статьи');
        
        await analyzeWithAI(articleText, title, wikiUrl);
    } catch (error) {
        setUI('error', error.message);
    }
}

async function analyzeWithAI(text, title, wikiUrl) {
    setUI('loading', 'Анализ с помощью ИИ...');
    
    let apiUrl, body;
    const headers = { 'Content-Type': 'application/json' };
    const userPrompt = `${SYSTEM_PROMPT}\n\nСТАТЬЯ "${title}":\n${text.substring(0, 30000)}`;
    
    if (currentApiMode === 'mapruapp') {
        apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
        body = {
            model: currentModelId,
            messages: [{ role: 'user', content: userPrompt }],
            max_tokens: 8192,
            response_format: { type: 'json_object' }
        };
    } else if (currentApiMode === 'direct_mistral') {
        apiUrl = 'https://api.mistral.ai/v1/chat/completions';
        headers['Authorization'] = `Bearer ${apiKey}`;
        body = {
            model: currentModelId,
            messages: [{ role: 'user', content: userPrompt }],
            max_tokens: 8192
        };
    } else if (currentApiType === 'gemini') {
        apiUrl = currentApiMode === 'direct'
            ? `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`
            : `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
        body = {
            contents: [{ parts: [{ text: userPrompt }] }],
            generationConfig: { responseMimeType: 'application/json' }
        };
    }
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers,
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error?.message || `Ошибка ИИ: ${response.status}`);
        }
        
        const data = await response.json();
        let aiText;
        
        if (currentApiMode === 'mapruapp' || currentApiMode === 'direct_mistral') {
            aiText = data.choices?.[0]?.message?.content;
        } else {
            aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        }
        
        if (!aiText) throw new Error('ИИ вернул пустой ответ');
        
        const parsed = JSON.parse(aiText.replace(/```json\s*|\s*```/g, ''));
        renderDossier(parsed, wikiUrl);
    } catch (error) {
        setUI('error', error.message);
    }
}

function renderDossier(data, wikiUrl) {
    lastDossierTitle = data.title || 'Справка';
    
    let html = `
        <div class="dossier-header">
            <div class="dossier-title-container">
                <h2>${lastDossierTitle}</h2>
                <a href="${wikiUrl}" target="_blank" class="wiki-link-btn" title="Открыть в Википедии">
                    <i class="fa-brands fa-wikipedia-w"></i>
                </a>
            </div>
            <p>${data.summary || ''}</p>
        </div>
        <div class="dossier-grid">`;
    
    if (data.sections?.length) {
        data.sections.forEach(section => {
            const filtered = (section.data || []).filter(d => 
                d.value && d.value.trim() && d.value.trim() !== 'н/д'
            );
            if (filtered.length) {
                html += `
                    <div class="dossier-card">
                        <div class="card-header">
                            <i class="${section.icon || 'fa-solid fa-align-left'}"></i>
                            <span>${section.title}</span>
                        </div>
                        <div class="card-content">
                            ${renderSection(filtered, section.displayType)}
                        </div>
                    </div>`;
            }
        });
    }
    
    html += '</div>';
    lastDossierHtml = html;
    
    mainContent.innerHTML = `<div class="panel">${html}</div>`;
    responseActions.style.display = 'flex';
}

function renderSection(data, type) {
    if (type === 'table') {
        return `
            <table class="fact-table">
                <tbody>
                    ${data.map(d => `
                        <tr>
                            <td>${d.label}</td>
                            <td>${expandableText(d.value)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    }
    return `
        <ul class="fact-list">
            ${data.map(d => `
                <li>
                    <span class="label">${d.label}</span>
                    <span class="value">${expandableText(d.value)}</span>
                </li>
            `).join('')}
        </ul>`;
}

function expandableText(text, max = 80) {
    if (typeof text !== 'string' || text.length <= max) return text;
    const short = text.substring(0, max) + '...';
    return `<span class="text-expandable" data-short="${short.replace(/"/g, '&quot;')}" data-full="${text.replace(/"/g, '&quot;')}" data-expanded="false">${short}</span>`;
}

function toggleExpand(el) {
    const expanded = el.dataset.expanded === 'true';
    el.textContent = expanded ? el.dataset.short : el.dataset.full;
    el.dataset.expanded = expanded ? 'false' : 'true';
}

function copyDossier() {
    const text = mainContent.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const btn = $('copy-btn');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>Скопировано!</span>';
        setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-copy"></i><span>Копировать</span>';
        }, 2000);
    });
}

function exportToHtml() {
    const htmlContent = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${lastDossierTitle}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 40px 20px; background: #f5f5f5; color: #333; }
        .dossier-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .dossier-header h2 { font-size: 2rem; color: #1e3a5f; margin: 0 0 15px; }
        .dossier-header p { color: #666; line-height: 1.7; }
        .dossier-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .dossier-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { background: #f0f9ff; padding: 15px 20px; font-weight: 600; border-bottom: 1px solid #e0e0e0; }
        .card-content { padding: 15px 20px; }
        .fact-table { width: 100%; border-collapse: collapse; }
        .fact-table td { padding: 10px 0; border-bottom: 1px solid #eee; }
        .fact-table td:first-child { color: #888; width: 40%; }
        .fact-list { list-style: none; padding: 0; margin: 0; }
        .fact-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .fact-list .label { color: #888; }
    </style>
</head>
<body>
    ${lastDossierHtml}
</body>
</html>`;
    
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${lastDossierTitle.replace(/[^a-zA-Zа-яА-Я0-9]/g, '_')}.html`;
    a.click();
    URL.revokeObjectURL(url);
}

init();
</script>
</body>
</html>
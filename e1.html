<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Star Data Miner v5 (Auto-Rename)</title>
  <script src="webfonts/supabase-js@2.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --success: #22c55e; --error: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #334155; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .layout { display: grid; grid-template-columns: 350px 1fr 400px; gap: 20px; flex: 1; min-height: 0; }
        
        .panel { background: var(--panel); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; border: 1px solid #334155; }
        .panel h2 { margin-top: 0; font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;}
        
        textarea#simple-input { background: #020617; color: #94a3b8; border: 1px solid #334155; border-radius: 4px; padding: 10px; font-family: 'Inter', sans-serif; font-size: 12px; resize: none; flex: 1; margin-bottom: 10px;}
        
        .settings-group { background: #0f172a; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #334155; }
        .settings-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 5px; }
        select, input { width: 100%; background: #1e293b; border: 1px solid #475569; color: white; padding: 5px; border-radius: 4px; box-sizing: border-box; }

        #logs { flex: 1; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; display: flex; flex-direction: column; gap: 5px; }
        .log-item { padding: 5px 8px; border-radius: 4px; border-left: 3px solid transparent; background: rgba(0,0,0,0.2); }
        .log-info { border-left-color: var(--accent); }
        .log-success { border-left-color: var(--success); color: #86efac; }
        .log-error { border-left-color: var(--error); color: #fca5a5; }
        .log-warn { border-left-color: #f59e0b; color: #fcd34d; }

        #json-preview { background: #020617; padding: 10px; border-radius: 4px; overflow: auto; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #a5b4fc; white-space: pre-wrap; flex: 1; }

        .controls { display: flex; gap: 10px; margin-top: auto; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-stop { background: var(--error); color: white; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: var(--panel); padding: 25px; border-radius: 12px; width: 500px; border: 1px solid #475569; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .wiki-list { max-height: 300px; overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 5px; }
        .wiki-item { padding: 10px; background: #334155; border-radius: 4px; cursor: pointer; border: 1px solid transparent; }
        .wiki-item:hover { border-color: var(--accent); background: #475569; }
        .progress-bar { height: 4px; background: #334155; width: 100%; border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <h1>‚≠ê Star Data Miner v5</h1>
            <span style="font-size: 12px; background: #334155; padding: 2px 8px; border-radius: 4px;">Smart Parse</span>
        </div>
        <div id="stats" style="font-size: 12px; color: #94a3b8;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </header>

    <div class="layout">
        <div class="panel">
            <h2>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="settings-group">
                <label>API –ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                <select id="api-provider">
                    <option value="google" selected>Google Direct</option>
                    <option value="proxy">MapRuApp Proxy</option>
                </select>
            </div>
            <div class="settings-group">
                <label>API –ö–ª—é—á (Google)</label>
                <input type="password" id="google-key" value="">
            </div>
            <p style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">–°–ø–∏—Å–æ–∫ –∑–≤–µ–∑–¥ (—á–µ—Ä–µ–∑ ;):</p>
            <textarea id="simple-input" placeholder="–î—É–±—Ö–µ; –ú–µ—Ä–∞–∫..."></textarea>
            <div class="controls">
                <button id="btn-parse" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
        </div>

        <div class="panel">
            <h2>2. –ü—Ä–æ—Ü–µ—Å—Å</h2>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div id="logs"></div>
            <div class="controls">
                <button id="btn-start" class="btn-primary" disabled onclick="startProcess()">üöÄ –ó–∞–ø—É—Å–∫</button>
                <button id="btn-stop" class="btn-stop" disabled onclick="stopProcess()">‚õî –°—Ç–æ–ø</button>
            </div>
        </div>

        <div class="panel">
            <h2>3. –û—Ç–≤–µ—Ç –ò–ò</h2>
            <div id="json-preview">// JSON...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ -->
    <div class="modal-overlay" id="wiki-modal">
        <div class="modal">
            <h3 style="margin-top:0">–£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h3>
            <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ: <b id="modal-star-name" style="color:var(--accent)"></b></p>
            <div class="wiki-list" id="modal-list"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="manual-wiki-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏..." style="flex:1; padding:8px; background:#0f172a; border:1px solid #475569; color:white;">
                <button onclick="resolveModalManual()" class="btn-primary" style="flex:0 0 80px;">–û–ö</button>
            </div>
            <button onclick="skipModal()" style="margin-top:10px; width:100%; background:transparent; border:1px solid #475569; color:#94a3b8;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
    
    const PROXY_URL = 'https://mapruapp.ru/ai/api/v1/chat/completions';
    const PROXY_MODEL = 'gemini-3-flash-preview';
    const GOOGLE_MODEL = 'gemini-1.5-flash'; 

    // –ö–∞—Ä—Ç–∞ –≥—Ä–µ—á–µ—Å–∫–∏—Ö –±—É–∫–≤ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    const greekMap = {
        'Œ±': '–ê–ª—å—Ñ–∞', 'Œ≤': '–ë–µ—Ç–∞', 'Œ≥': '–ì–∞–º–º–∞', 'Œ¥': '–î–µ–ª—å—Ç–∞', 'Œµ': '–≠–ø—Å–∏–ª–æ–Ω',
        'Œ∂': '–î–∑–µ—Ç–∞', 'Œ∑': '–≠—Ç–∞', 'Œ∏': '–¢–µ—Ç–∞', 'Œπ': '–ô–æ—Ç–∞', 'Œ∫': '–ö–∞–ø–ø–∞',
        'Œª': '–õ—è–º–±–¥–∞', 'Œº': '–ú—é', 'ŒΩ': '–ù—é', 'Œæ': '–ö—Å–∏', 'Œø': '–û–º–∏–∫—Ä–æ–Ω',
        'œÄ': '–ü–∏', 'œÅ': '–†–æ', 'œÉ': '–°–∏–≥–º–∞', 'œÑ': '–¢–∞—É', 'œÖ': '–ò–ø—Å–∏–ª–æ–Ω',
        'œÜ': '–§–∏', 'œá': '–•–∏', 'œà': '–ü—Å–∏', 'œâ': '–û–º–µ–≥–∞'
    };

    const supabase = supa.createClient(SUPABASE_URL, SUPABASE_KEY);

    let starsQueue = [];
    let shouldStop = false;
    let modalResolver = null;

    function log(msg, type = 'info') {
        const el = document.getElementById('logs');
        const item = document.createElement('div');
        item.className = `log-item log-${type}`;
        item.innerHTML = `<span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        el.appendChild(item);
        el.scrollTop = el.scrollHeight;
        if(type === 'error') console.error(msg);
    }

    // --- –õ–û–ì–ò–ö–ê –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò –ò–ú–ï–ù ---
    function fixStarName(rawName) {
        let name = rawName.trim();
        // –†–µ–≥—É–ª—è—Ä–∫–∞ –∏—â–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω: "–°–ª–æ–≤–∞ (–≥—Ä–µ—á.–±—É–∫–≤–∞)(—Ü–∏—Ñ—Ä–∞?)"
        // –ù–∞–ø—Ä–∏–º–µ—Ä: "–ü–µ—Ä—Å–µ—è Œ∂", "–õ–∏—Ä—ã Œ¥¬π"
        const regex = /(.+?)\s+([Œ±-œâ])([¬π¬≤¬≥]?)/;
        const match = name.match(regex);

        if (match) {
            const constellation = match[1]; // –ü–µ—Ä—Å–µ—è
            const greekChar = match[2];     // Œ∂
            const index = match[3] || "";   // ¬π (–∏–ª–∏ –ø—É—Å—Ç–æ)
            
            if (greekMap[greekChar]) {
                // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "–î–∑–µ—Ç–∞ –ü–µ—Ä—Å–µ—è" –∏–ª–∏ "–î–µ–ª—å—Ç–∞¬π –õ–∏—Ä—ã"
                return `${greekMap[greekChar]}${index} ${constellation}`;
            }
        }
        return name;
    }

    // --- –ü–ê–†–°–ò–ù–ì ---
    document.getElementById('btn-parse').addEventListener('click', () => {
        const raw = document.getElementById('simple-input').value;
        log("–ù–∞–∂–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥...", "info");

        if (!raw.trim()) {
            log("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!", "error");
            return;
        }

        // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Ç–æ—á–∫–µ —Å –∑–∞–ø—è—Ç–æ–π, —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        // raw.replace(/[\r\n]+/g, '') —É–¥–∞–ª—è–µ—Ç —ç–Ω—Ç–µ—Ä—ã –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const cleanRaw = raw.replace(/[\r\n]+/g, ' '); 
        const names = cleanRaw.split(';').map(s => s.trim()).filter(s => s.length > 0);
        
        starsQueue = names.map(name => {
            const wikiName = fixStarName(name);
            // –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ø—Ä–∏ —Ñ–∏–∫—Å–µ, –ª–æ–≥–∏—Ä—É–µ–º —ç—Ç–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (name !== wikiName) {
                console.log(`Renamed: ${name} -> ${wikiName}`);
            }
            return { 
                originalName: name, // –°–æ—Ö—Ä–∞–Ω–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                name: wikiName 
            };
        });
        
        log(`–£—Å–ø–µ—Ö! –í –æ—á–µ—Ä–µ–¥–∏: ${starsQueue.length} –∑–≤—ë–∑–¥`, 'success');
        document.getElementById('btn-start').disabled = false;
        document.getElementById('stats').textContent = `–í –æ—á–µ—Ä–µ–¥–∏: ${starsQueue.length}`;
    });

    async function startProcess() {
        if (starsQueue.length === 0) return;
        shouldStop = false;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-stop').disabled = false;
        
        for (let i = 0; i < starsQueue.length; i++) {
            if (shouldStop) break;
            const star = starsQueue[i];
            const progress = ((i + 1) / starsQueue.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('stats').textContent = `${i+1}/${starsQueue.length}: ${star.name}`;

            try {
                await processStar(star);
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –Ω–∞ ${star.name}: ${e.message}`, 'error');
            }
            
            if (i < starsQueue.length - 1 && !shouldStop) {
                log('‚è≥ –ñ–¥—É 5 —Å–µ–∫...', 'info');
                await new Promise(r => setTimeout(r, 5000));
            }
        }
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-stop').disabled = true;
        log('–ì–æ—Ç–æ–≤–æ!', 'success');
    }

    function stopProcess() { shouldStop = true; log('–°—Ç–æ–ø...', 'warn'); }

    async function processStar(star) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∏–º–µ–Ω–∏ (–ò–õ–ò –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –æ–Ω–æ –¥—Ä—É–≥–æ–µ)
        // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –≤ –±–∞–∑–µ –∑–∞–ø–∏—Å–∞–Ω–æ "–î–∑–µ—Ç–∞ –ü–µ—Ä—Å–µ—è", –∞ –º—ã –∏—â–µ–º "–î–∑–µ—Ç–∞ –ü–µ—Ä—Å–µ—è"
        const { data: existing } = await supabase
            .from('stars')
            .select('id')
            .or(`name.eq.${star.name},name.eq.${star.originalName}`)
            .maybeSingle();

        if (existing) {
            log(`–ü—Ä–æ–ø—É—Å–∫: ${star.name} (–µ—Å—Ç—å –≤ –ë–î)`, 'warn');
            return;
        }

        let wikiData = await getWikiData(star.name);
        
        // –ü–æ–ø—ã—Ç–∫–∞ 2: –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ "–î–∑–µ—Ç–∞ –ü–µ—Ä—Å–µ—è", –ø—Ä–æ–±—É–µ–º –ø–æ "–ü–µ—Ä—Å–µ—è Œ∂" (–º–∞–ª–æ –ª–∏)
        if (!wikiData && star.name !== star.originalName) {
             wikiData = await getWikiData(star.originalName);
        }

        // –ü–æ–ø—ã—Ç–∫–∞ 3: –î–æ–±–∞–≤–∏—Ç—å " (–∑–≤–µ–∑–¥–∞)"
        if (!wikiData || wikiData.isDisambiguation) {
            const autoTitle = star.name + " (–∑–≤–µ–∑–¥–∞)";
            const autoWikiData = await getWikiData(autoTitle);
            
            if (autoWikiData && !autoWikiData.isDisambiguation) {
                wikiData = autoWikiData;
                log(`–ê–≤—Ç–æ-–≤—ã–±–æ—Ä: ${wikiData.title}`, 'info');
            } else {
                // –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –Ω–∞—à–ª–∏ - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —é–∑–µ—Ä–∞
                const userChoice = await askUserForArticle(star.name);
                if (!userChoice) { log(`–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${star.name}`, 'error'); return; }
                wikiData = await getWikiData(userChoice);
            }
        }

        if (!wikiData || !wikiData.wikitext) {
            log(`–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ Wiki: ${star.name}`, 'error');
            return;
        }

        log(`Wiki OK (${wikiData.title}). –ê–Ω–∞–ª–∏–∑ AI...`, 'info');
        const aiData = await askAI(star, wikiData);
        if (!aiData) return;

        document.getElementById('json-preview').textContent = JSON.stringify(aiData, null, 2);

        const { error } = await supabase.from('stars').insert({
            name: star.name, // –ü–∏—à–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è (–î–∑–µ—Ç–∞ –ü–µ—Ä—Å–µ—è)
            constellation: aiData.constellation,
            constellation_latin: aiData.constellation_latin,
            stats: aiData.stats,
            facts: aiData.facts,
            wiki_url: `https://ru.wikipedia.org/wiki/${encodeURIComponent(wikiData.title)}`,
            raw_ai_response: aiData
        });

        if (error) log(`–û—à–∏–±–∫–∞ –ë–î: ${error.message}`, 'error');
        else log(`‚úÖ ${star.name} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`, 'success');
    }

    async function getWikiData(title) {
        const url = `https://ru.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&format=json&prop=wikitext&origin=*&redirects=1`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.error) return null;
            const wikitext = data.parse.wikitext['*'];
            const isDisambig = wikitext.includes('{{–Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å}}') || wikitext.includes('{{disambig}}');
            return { title: data.parse.title, wikitext, isDisambiguation: isDisambig };
        } catch { return null; }
    }

    async function searchWiki(query) {
        const url = `https://ru.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&format=json&origin=*`;
        const res = await fetch(url);
        const data = await res.json();
        return data[1];
    }

    async function askAI(star, wikiData) {
        const provider = document.getElementById('api-provider').value;
        const textToAnalyze = wikiData.wikitext.substring(0, 40000); 

        const systemPrompt = `Role: Astronomer. 
        Task: Extract data for star "${star.name}" from the provided Wikitext.
        Important: Identify the Constellation (Russian and Latin) from text.
        
        Output: JSON only. No markdown.
        Format:
        {
            "constellation": "String (Russian Name, e.g. –õ–µ–±–µ–¥—å)",
            "constellation_latin": "String (Latin Name, e.g. Cygnus)",
            "stats": {
                "mass_solar": Number/null,
                "radius_solar": Number/null,
                "dist_ly": Number/null,
                "temp_k": Number/null,
                "lum_solar": Number/null,
                "spectral_class": "String",
                "age_my": Number/null (million years),
                "mag_app": Number
            },
            "facts": ["Fact1", "Fact2", "Fact3"] (in Russian, interesting)
        }`;

        try {
            let jsonResponse = "";
            if (provider === 'google') {
                const apiKey = document.getElementById('google-key').value;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GOOGLE_MODEL}:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nWIKITEXT:\n" + textToAnalyze }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                jsonResponse = data.candidates[0].content.parts[0].text;
            } else {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: PROXY_MODEL,
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: textToAnalyze }],
                        temperature: 0.1
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                jsonResponse = data.choices[0].message.content;
            }
            return JSON.parse(jsonResponse.replace(/```json/g, '').replace(/```/g, '').trim());
        } catch (e) {
            log(`AI Error: ${e.message}`, 'error');
            return null;
        }
    }

    async function askUserForArticle(query) {
        const modal = document.getElementById('wiki-modal');
        const listEl = document.getElementById('modal-list');
        document.getElementById('modal-star-name').textContent = query;
        listEl.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        modal.style.display = 'flex';
        
        const suggestions = await searchWiki(query);
        const moreSuggestions = await searchWiki(query + " (–∑–≤–µ–∑–¥–∞)");
        const opts = [...new Set([...suggestions, ...moreSuggestions])];
        
        listEl.innerHTML = '';
        if(opts.length === 0) listEl.innerHTML = '–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤';
        
        opts.forEach(opt => {
            const d = document.createElement('div');
            d.className = 'wiki-item';
            d.innerHTML = `<strong>${opt}</strong>`;
            d.onclick = () => { modal.style.display='none'; if(modalResolver) modalResolver(opt); };
            listEl.appendChild(d);
        });
        return new Promise(r => modalResolver = r);
    }

    window.resolveModalManual = () => {
        const val = document.getElementById('manual-wiki-input').value;
        if(val) { document.getElementById('wiki-modal').style.display='none'; modalResolver(val); }
    };
    window.skipModal = () => {
        document.getElementById('wiki-modal').style.display='none'; modalResolver(null);
    };
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>" type="image/svg+xml" id="favicon">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --base-font-size: 15px;
    --bg-color: #f0f2f5;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --message-user-bg-solid: #667eea;
    --message-user-border: transparent;
    --message-bot-bg: #ffffff;
    --message-bot-border: #e4e6eb;
    --message-user-color: #ffffff;
    --message-bot-color: #1c1e21;
    --input-bg: #ffffff;
    --input-border: #e4e6eb;
    --input-text: #1c1e21;
    --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --button-bg-solid: #667eea;
    --button-bg-hover: #5a6fd6;
    --button-color: white;
    --accent-color: #667eea;
    --accent-secondary: #764ba2;
    --shadow-color: rgba(0, 0, 0, 0.08);
    --shadow-medium: rgba(0, 0, 0, 0.12);
    --border-color: #e4e6eb;
    --header-color: #1c1e21;
    --time-color: #65676b;
    --typing-bg: #e4e6eb;
    --typing-dot: #65676b;
    --code-bg: #f6f8fa;
    --code-header-bg: #f0f2f5;
    --code-border: #e4e6eb;
    --scrollbar-thumb: #bcc0c4;
    --scrollbar-track: #f0f2f5;
    --avatar-user-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --avatar-bot-bg: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --modal-bg: #ffffff;
    --modal-border: #e4e6eb;
    --file-chip-bg: #e4e6eb;
    --file-chip-color: #1c1e21;
    --selection-bg: #667eea;
    --selection-color: #ffffff;
    --option-hover: #f0f2f5;
    --option-selected: #e7e9ff;
    --option-selected-border: #667eea;
    --notification-bg: #667eea;
}

/* DARK THEME */
body.dark-theme {
    --bg-color: #0a0a0f;
    --container-bg: #12121a;
    --message-user-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --message-user-bg-solid: #6366f1;
    --message-user-border: transparent;
    --message-bot-bg: #1e1e2e;
    --message-bot-border: #2a2a3e;
    --message-user-color: #ffffff;
    --message-bot-color: #e4e4e7;
    --input-bg: #1e1e2e;
    --input-border: #2a2a3e;
    --input-text: #e4e4e7;
    --button-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --button-bg-solid: #6366f1;
    --button-bg-hover: #5558e3;
    --button-color: white;
    --accent-color: #818cf8;
    --accent-secondary: #a78bfa;
    --shadow-color: rgba(0, 0, 0, 0.3);
    --shadow-medium: rgba(0, 0, 0, 0.4);
    --border-color: #2a2a3e;
    --header-color: #e4e4e7;
    --time-color: #71717a;
    --typing-bg: #2a2a3e;
    --typing-dot: #818cf8;
    --code-bg: #1e1e2e;
    --code-header-bg: #2a2a3e;
    --code-border: #3a3a4e;
    --scrollbar-thumb: #3a3a4e;
    --scrollbar-track: #1e1e2e;
    --avatar-user-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --avatar-bot-bg: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    --modal-bg: #1e1e2e;
    --modal-border: #2a2a3e;
    --file-chip-bg: #2a2a3e;
    --file-chip-color: #e4e4e7;
    --selection-bg: #818cf8;
    --selection-color: #0a0a0f;
    --option-hover: #2a2a3e;
    --option-selected: #3a3a5e;
    --option-selected-border: #818cf8;
    --notification-bg: #6366f1;
}

/* POWERSHELL THEME */
body.powershell-theme {
    --bg-color: #012456;
    --container-bg: #012456;
    --message-user-bg: linear-gradient(135deg, #1e3a5f 0%, #2a4a7a 100%);
    --message-user-bg-solid: #1e3a5f;
    --message-user-border: #3a6ea5;
    --message-bot-bg: #01326e;
    --message-bot-border: #3a6ea5;
    --message-user-color: #eeedf0;
    --message-bot-color: #cccccc;
    --input-bg: #01326e;
    --input-border: #3a6ea5;
    --input-text: #eeedf0;
    --button-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --button-bg-solid: #4169e1;
    --button-bg-hover: #5a7be8;
    --button-color: #ffffff;
    --accent-color: #ffff00;
    --accent-secondary: #00ffff;
    --shadow-color: rgba(0, 0, 0, 0.4);
    --shadow-medium: rgba(0, 0, 0, 0.5);
    --border-color: #3a6ea5;
    --header-color: #eeedf0;
    --time-color: #ffff00;
    --typing-bg: #01326e;
    --typing-dot: #ffff00;
    --code-bg: #01326e;
    --code-header-bg: #1e3a5f;
    --code-border: #3a6ea5;
    --scrollbar-thumb: #3a6ea5;
    --scrollbar-track: #01326e;
    --avatar-user-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --avatar-bot-bg: linear-gradient(135deg, #ffff00 0%, #ffd700 100%);
    --modal-bg: #012456;
    --modal-border: #3a6ea5;
    --file-chip-bg: #1e3a5f;
    --file-chip-color: #eeedf0;
    --selection-bg: #ffff00;
    --selection-color: #012456;
    --option-hover: #1e3a5f;
    --option-selected: #2a4a7a;
    --option-selected-border: #ffff00;
    --notification-bg: #4169e1;
}

/* IMESSAGE THEME */
body.imessage-theme {
    --bg-color: #ffffff;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --message-user-bg-solid: #007aff;
    --message-user-border: transparent;
    --message-bot-bg: #e9e9eb;
    --message-bot-border: transparent;
    --message-user-color: #ffffff;
    --message-bot-color: #000000;
    --input-bg: #f2f2f7;
    --input-border: #c7c7cc;
    --input-text: #000000;
    --button-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --button-bg-solid: #007aff;
    --button-bg-hover: #0056b3;
    --button-color: #ffffff;
    --accent-color: #007aff;
    --accent-secondary: #5856d6;
    --shadow-color: rgba(0, 0, 0, 0.04);
    --shadow-medium: rgba(0, 0, 0, 0.08);
    --border-color: #c7c7cc;
    --header-color: #000000;
    --time-color: #8e8e93;
    --typing-bg: #e9e9eb;
    --typing-dot: #8e8e93;
    --code-bg: #f2f2f7;
    --code-header-bg: #e5e5ea;
    --code-border: #c7c7cc;
    --scrollbar-thumb: #c7c7cc;
    --scrollbar-track: #f2f2f7;
    --avatar-user-bg: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
    --avatar-bot-bg: linear-gradient(135deg, #34c759 0%, #30d158 100%);
    --modal-bg: #ffffff;
    --modal-border: #c7c7cc;
    --file-chip-bg: #e5e5ea;
    --file-chip-color: #000000;
    --selection-bg: #007aff;
    --selection-color: #ffffff;
    --option-hover: #f2f2f7;
    --option-selected: #e5f3ff;
    --option-selected-border: #007aff;
    --notification-bg: #007aff;
}

/* NORD THEME (NEW) */
body.nord-theme {
    --bg-color: #2e3440;
    --container-bg: #3b4252;
    --message-user-bg: linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%);
    --message-user-bg-solid: #5e81ac;
    --message-user-border: transparent;
    --message-bot-bg: #434c5e;
    --message-bot-border: #4c566a;
    --message-user-color: #eceff4;
    --message-bot-color: #eceff4;
    --input-bg: #434c5e;
    --input-border: #4c566a;
    --input-text: #eceff4;
    --button-bg: linear-gradient(135deg, #88c0d0 0%, #8fbcbb 100%);
    --button-bg-solid: #88c0d0;
    --button-bg-hover: #81a1c1;
    --button-color: #2e3440;
    --accent-color: #88c0d0;
    --accent-secondary: #81a1c1;
    --shadow-color: rgba(0, 0, 0, 0.2);
    --shadow-medium: rgba(0, 0, 0, 0.3);
    --border-color: #4c566a;
    --header-color: #eceff4;
    --time-color: #d8dee9;
    --typing-bg: #434c5e;
    --typing-dot: #88c0d0;
    --code-bg: #3b4252;
    --code-header-bg: #434c5e;
    --code-border: #4c566a;
    --scrollbar-thumb: #4c566a;
    --scrollbar-track: #3b4252;
    --avatar-user-bg: linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%);
    --avatar-bot-bg: linear-gradient(135deg, #a3be8c 0%, #8fbcbb 100%);
    --modal-bg: #3b4252;
    --modal-border: #4c566a;
    --file-chip-bg: #434c5e;
    --file-chip-color: #eceff4;
    --selection-bg: #88c0d0;
    --selection-color: #2e3440;
    --option-hover: #434c5e;
    --option-selected: #4c566a;
    --option-selected-border: #88c0d0;
    --notification-bg: #5e81ac;
}

html, body {
    height: 100%;
    width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--message-bot-color);
    transition: background-color 0.3s ease, color 0.3s ease;
}

::selection {
    background: var(--selection-bg);
    color: var(--selection-color);
}

.container {
    height: 100%;
    display: flex;
    flex-direction: column;
    max-width: 100%;
    margin: 0 auto;
    background-color: var(--container-bg);
    transition: background-color 0.3s ease;
}

/* HEADER */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: var(--container-bg);
    border-bottom: 1px solid var(--border-color);
    z-index: 100;
    transition: all 0.3s ease;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-logo {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: var(--avatar-bot-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 8px var(--shadow-color);
}

.header-logo:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px var(--shadow-medium);
}

.header-logo svg {
    width: 22px;
    height: 22px;
    fill: white;
}

.header-info {
    display: flex;
    flex-direction: column;
}

.header-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--header-color);
}

.header-subtitle {
    font-size: 12px;
    color: var(--time-color);
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
    color: var(--accent-color);
}

.header-btn:hover {
    background-color: var(--option-hover);
}

.header-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

/* SELECTORS */
.selector-container {
    position: relative;
}

.selector-button {
    padding: 8px 14px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--container-bg);
    cursor: pointer;
    font-size: 13px;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    max-width: 200px;
}

.selector-button:hover {
    background: var(--option-hover);
    border-color: var(--accent-color);
}

.selector-button::after {
    content: '';
    width: 6px;
    height: 6px;
    border-right: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(45deg);
    margin-left: auto;
    opacity: 0.6;
}

.selector-options {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--container-bg);
    border-radius: 12px;
    box-shadow: 0 4px 20px var(--shadow-medium);
    padding: 8px 0;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
    border: 1px solid var(--border-color);
    min-width: 220px;
    max-height: 400px;
    overflow-y: auto;
}

.selector-options.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.selector-option {
    padding: 10px 16px;
    cursor: pointer;
    font-size: 13px;
    transition: background-color 0.2s ease;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.selector-option:hover {
    background-color: var(--option-hover);
}

.selector-option.selected {
    background-color: var(--option-selected);
    color: var(--accent-color);
    font-weight: 500;
}

/* CHAT CONTAINER */
#chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: var(--bg-color);
    scroll-behavior: smooth;
}

#chat-container::-webkit-scrollbar {
    width: 6px;
}

#chat-container::-webkit-scrollbar-track {
    background: transparent;
}

#chat-container::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-thumb);
    border-radius: 3px;
}

/* MESSAGES */
.message {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    animation: messageSlide 0.3s ease;
    max-width: 85%;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user-message {
    margin-left: auto;
    flex-direction: row-reverse;
}

.message.bot-message {
    margin-right: auto;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    color: white;
    box-shadow: 0 2px 8px var(--shadow-color);
}

.user-message .message-avatar {
    background: var(--avatar-user-bg);
}

.bot-message .message-avatar {
    background: var(--avatar-bot-bg);
}

.message-avatar svg {
    width: 18px;
    height: 18px;
    fill: white;
}

.message-bubble {
    display: flex;
    flex-direction: column;
    max-width: 100%;
}

.message-content {
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.5;
    font-size: var(--base-font-size);
    word-wrap: break-word;
    white-space: pre-wrap;
    position: relative;
    box-shadow: 0 1px 2px var(--shadow-color);
}

.user-message .message-content {
    background: var(--message-user-bg);
    color: var(--message-user-color);
    border-bottom-right-radius: 6px;
}

.bot-message .message-content {
    background: var(--message-bot-bg);
    color: var(--message-bot-color);
    border: 1px solid var(--message-bot-border);
    border-bottom-left-radius: 6px;
}

.message-time {
    font-size: 11px;
    color: var(--time-color);
    margin-top: 4px;
    padding: 0 4px;
}

.user-message .message-time {
    text-align: right;
}

.message-image {
    max-width: 300px;
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.message-image:hover {
    transform: scale(1.02);
}

/* TYPING INDICATOR */
.typing-indicator {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    animation: messageSlide 0.3s ease;
}

.typing-bubble {
    background: var(--typing-bg);
    padding: 16px 20px;
    border-radius: 18px;
    border-bottom-left-radius: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--typing-dot);
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1.2); opacity: 1; }
}

/* FILE PREVIEW */
#file-preview-container {
    display: none;
    padding: 12px 20px;
    background: var(--container-bg);
    border-top: 1px solid var(--border-color);
}

#file-preview-container.visible {
    display: block;
}

.file-preview-chip {
    display: inline-flex;
    align-items: center;
    background: var(--file-chip-bg);
    color: var(--file-chip-color);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    gap: 10px;
    box-shadow: 0 1px 3px var(--shadow-color);
}

.file-preview-chip svg {
    width: 18px;
    height: 18px;
    fill: var(--accent-color);
}

.file-preview-name {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-preview-remove {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--option-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.file-preview-remove:hover {
    background: var(--border-color);
}

.file-preview-remove svg {
    width: 12px;
    height: 12px;
    fill: var(--message-bot-color);
}

.file-preview-thumb {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
}

/* INPUT CONTAINER */
#input-container {
    display: flex;
    padding: 12px 20px 20px;
    background: var(--container-bg);
    align-items: flex-end;
    gap: 12px;
    border-top: 1px solid var(--border-color);
}

#message-input {
    flex: 1;
    padding: 12px 18px;
    border: 2px solid var(--input-border);
    border-radius: 24px;
    font-size: var(--base-font-size);
    background: var(--input-bg);
    color: var(--input-text);
    resize: none;
    min-height: 48px;
    max-height: 150px;
    font-family: inherit;
    line-height: 1.4;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#message-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent);
}

#message-input::placeholder {
    color: var(--time-color);
}

.input-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

#upload-button {
    background: transparent;
    color: var(--accent-color);
}

#upload-button:hover {
    background: var(--option-hover);
}

#upload-button.has-file {
    background: var(--option-selected);
}

#upload-button svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

#send-button {
    background: var(--button-bg);
    color: var(--button-color);
    box-shadow: 0 2px 8px var(--shadow-color);
}

#send-button:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 4px 12px var(--shadow-medium);
}

#send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#send-button svg {
    width: 22px;
    height: 22px;
    fill: currentColor;
}

/* CODE BLOCKS */
.code-block {
    margin: 12px 0;
    border-radius: 12px;
    overflow: hidden;
    background: var(--code-bg);
    border: 1px solid var(--code-border);
}

.code-header {
    background: var(--code-header-bg);
    padding: 8px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--time-color);
    border-bottom: 1px solid var(--code-border);
}

.code-language {
    font-weight: 500;
    color: var(--accent-color);
}

.code-actions {
    display: flex;
    gap: 8px;
}

.code-btn {
    background: var(--container-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
}

.code-btn:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.code-btn svg {
    width: 12px;
    height: 12px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
}

.code-block pre {
    margin: 0;
    padding: 14px;
    overflow-x: auto;
}

.code-block code {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: calc(var(--base-font-size) * 0.85);
    line-height: 1.5;
}

/* INLINE CODE */
code:not(pre code) {
    background: var(--option-hover);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 0.9em;
}

/* NOTIFICATION */
.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: var(--notification-bg);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 14px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.notification.error {
    background: #ef4444;
}

/* MODALS */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--modal-bg);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--modal-border);
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--header-color);
    margin-bottom: 16px;
}

.modal-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--input-border);
    border-radius: 12px;
    font-size: var(--base-font-size);
    background: var(--input-bg);
    color: var(--input-text);
    margin-bottom: 16px;
    transition: border-color 0.2s ease;
}

.modal-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

.modal-btn {
    width: 100%;
    padding: 12px;
    background: var(--button-bg);
    color: var(--button-color);
    border: none;
    border-radius: 12px;
    font-size: var(--base-font-size);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.modal-link {
    display: block;
    text-align: center;
    margin-bottom: 16px;
    color: var(--accent-color);
    font-size: 13px;
}

/* COPY BUTTON */
.copy-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--container-bg);
    border: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}

.message:hover .copy-btn {
    opacity: 0.7;
}

.copy-btn:hover {
    opacity: 1 !important;
    background: var(--option-hover);
}

.copy-btn svg {
    width: 14px;
    height: 14px;
    stroke: var(--message-bot-color);
    fill: none;
    stroke-width: 2;
}

.user-message .copy-btn svg {
    stroke: var(--message-bot-color);
}

/* THEME ICONS */
.theme-icon { display: none; }
.theme-icon.active { display: block; }

/* RESPONSIVE */
@media (max-width: 768px) {
    .header-controls .selector-container {
        display: none;
    }
    
    .message {
        max-width: 92%;
    }
    
    #chat-container {
        padding: 16px;
    }
    
    #input-container {
        padding: 10px 16px 16px;
    }
}

@media (max-width: 480px) {
    .message-avatar {
        width: 32px;
        height: 32px;
    }
    
    .message-content {
        padding: 10px 14px;
        font-size: 14px;
    }
    
    .header {
        padding: 10px 16px;
    }
    
    .header-logo {
        width: 36px;
        height: 36px;
    }
}

/* EMPTY STATE */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--time-color);
    text-align: center;
    padding: 40px;
}

.empty-state-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--option-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.empty-state-icon svg {
    width: 40px;
    height: 40px;
    fill: var(--accent-color);
}

.empty-state-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--header-color);
    margin-bottom: 8px;
}

.empty-state-text {
    font-size: 14px;
    max-width: 300px;
}
</style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-left">
            <div class="header-logo" id="header-logo" title="–ù–æ–≤—ã–π —á–∞—Ç">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            </div>
            <div class="header-info">
                <div class="header-title" id="header-title">AI Assistant</div>
                <div class="header-subtitle" id="header-subtitle">–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å</div>
            </div>
        </div>
        <div class="header-controls">
            <div class="selector-container" id="model-selector">
                <button class="selector-button" id="model-selector-btn">
                    <span id="model-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </button>
                <ul class="selector-options" id="model-options"></ul>
            </div>
            
            <button class="header-btn" id="font-btn" title="–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞">
                <svg viewBox="0 0 24 24"><path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/></svg>
            </button>
            
            <button class="header-btn" id="theme-btn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                <svg class="theme-icon active" id="icon-light" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
                <svg class="theme-icon" id="icon-dark" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                <svg class="theme-icon" id="icon-ps" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm-2-1h-6v-2h6v2zM7.5 17l-1.41-1.41L8.67 13l-2.58-2.59L7.5 9l4 4-4 4z"/></svg>
                <svg class="theme-icon" id="icon-imsg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <svg class="theme-icon" id="icon-nord" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
            </button>
            
            <button class="header-btn" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.44.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>
    </header>

    <div id="chat-container">
        <div class="empty-state" id="empty-state">
            <div class="empty-state-icon">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <div class="empty-state-title">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
            <div class="empty-state-text">–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
        </div>
    </div>

    <div id="file-preview-container"></div>

    <div id="input-container">
        <input type="file" id="file-input" accept="image/*,application/pdf" hidden>
        <button class="input-btn" id="upload-button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
            <svg viewBox="0 -960 960 960"><path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160Zm40 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
        </button>
        <textarea id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
        <button class="input-btn" id="send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <svg viewBox="0 -960 960 960"><path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"/></svg>
        </button>
    </div>
</div>

<div class="notification" id="notification"></div>

<div class="modal-overlay" id="api-modal">
    <div class="modal-content">
        <div class="modal-title">üîë API –∫–ª—é—á</div>
        <a class="modal-link" href="https://aistudio.google.com/app/apikey" target="_blank">–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –≤ Google AI Studio ‚Üí</a>
        <input type="password" class="modal-input" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á...">
        <button class="modal-btn" id="save-api-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
        <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div id="settings-content"></div>
        <button class="modal-btn" id="close-settings-btn" style="margin-top: 16px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
// ==================== CONFIG ====================
const MODELS = [
    { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite", api: "gemini" },
    { id: "gemini-3-flash-preview", name: "Gemini 3 Flash", api: "gemini" },
    { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", api: "gemini" },
    { id: "gemini-3-pro-preview", name: "Gemini 3 Pro Preview", api: "gemini" },
    { id: "mistral-large-2512", name: "Mistral Large", api: "mistral" },
];

const THEMES = ['light', 'dark', 'powershell', 'imessage', 'nord'];
const THEME_NAMES = { light: '–°–≤–µ—Ç–ª–∞—è', dark: '–¢—ë–º–Ω–∞—è', powershell: 'PowerShell', imessage: 'iMessage', nord: 'Nord' };
const FONT_SIZES = [14, 15, 16, 17, 18];
const PROXY_URL = "https://mapruapp.ru/ai/api/v1/chat/completions";

// ==================== STATE ====================
let chatHistory = [];
let pendingFile = null;
let currentModel = localStorage.getItem('model') || 'gemini-3-flash-preview';
let currentTheme = localStorage.getItem('theme') || 'light';
let currentFontIndex = parseInt(localStorage.getItem('fontIndex')) || 1;
let apiKey = localStorage.getItem('gemini_api_key') || null;
let isGenerating = false;

// ==================== ELEMENTS ====================
const $ = id => document.getElementById(id);
const chatContainer = $('chat-container');
const messageInput = $('message-input');
const sendButton = $('send-button');
const uploadButton = $('upload-button');
const fileInput = $('file-input');
const filePreviewContainer = $('file-preview-container');
const notification = $('notification');
const emptyState = $('empty-state');
const headerTitle = $('header-title');
const headerSubtitle = $('header-subtitle');
const modelSelectorBtn = $('model-selector-btn');
const modelOptions = $('model-options');
const apiModal = $('api-modal');
const settingsModal = $('settings-modal');

// ==================== INIT ====================
function init() {
    applyTheme(currentTheme);
    applyFontSize(FONT_SIZES[currentFontIndex]);
    populateModels();
    updateModelUI();
    setupEventListeners();
}

function setupEventListeners() {
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    messageInput.addEventListener('input', autoResize);
    
    uploadButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    messageInput.addEventListener('paste', handlePaste);
    
    $('header-logo').addEventListener('click', resetChat);
    $('font-btn').addEventListener('click', cycleFontSize);
    $('theme-btn').addEventListener('click', cycleTheme);
    $('settings-btn').addEventListener('click', () => openModal(settingsModal));
    
    modelSelectorBtn.addEventListener('click', e => {
        e.stopPropagation();
        modelOptions.classList.toggle('show');
    });
    
    document.addEventListener('click', () => modelOptions.classList.remove('show'));
    
    $('save-api-btn').addEventListener('click', saveApiKey);
    $('close-settings-btn').addEventListener('click', () => closeModal(settingsModal));
    
    apiModal.addEventListener('click', e => { if (e.target === apiModal) closeModal(apiModal); });
    settingsModal.addEventListener('click', e => { if (e.target === settingsModal) closeModal(settingsModal); });
}

// ==================== THEME ====================
function applyTheme(theme) {
    document.body.className = theme === 'light' ? '' : `${theme}-theme`;
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    
    document.querySelectorAll('.theme-icon').forEach(icon => icon.classList.remove('active'));
    const iconId = { light: 'icon-light', dark: 'icon-dark', powershell: 'icon-ps', imessage: 'icon-imsg', nord: 'icon-nord' };
    $(iconId[theme])?.classList.add('active');
    
    const isDark = ['dark', 'powershell', 'nord'].includes(theme);
    $('hljs-theme').href = isDark 
        ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css'
        : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
}

function cycleTheme() {
    const idx = (THEMES.indexOf(currentTheme) + 1) % THEMES.length;
    applyTheme(THEMES[idx]);
    showNotification(`–¢–µ–º–∞: ${THEME_NAMES[THEMES[idx]]}`);
}

// ==================== FONT ====================
function applyFontSize(size) {
    document.documentElement.style.setProperty('--base-font-size', size + 'px');
}

function cycleFontSize() {
    currentFontIndex = (currentFontIndex + 1) % FONT_SIZES.length;
    applyFontSize(FONT_SIZES[currentFontIndex]);
    localStorage.setItem('fontIndex', currentFontIndex);
    showNotification(`–†–∞–∑–º–µ—Ä: ${FONT_SIZES[currentFontIndex]}px`);
}

// ==================== MODELS ====================
function populateModels() {
    modelOptions.innerHTML = MODELS.map(m => `
        <li class="selector-option ${m.id === currentModel ? 'selected' : ''}" data-id="${m.id}">
            ${m.name}
        </li>
    `).join('');
    
    modelOptions.querySelectorAll('.selector-option').forEach(opt => {
        opt.addEventListener('click', () => {
            currentModel = opt.dataset.id;
            localStorage.setItem('model', currentModel);
            updateModelUI();
            modelOptions.classList.remove('show');
        });
    });
}

function updateModelUI() {
    const model = MODELS.find(m => m.id === currentModel);
    $('model-name').textContent = model?.name || '–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å';
    headerTitle.textContent = model?.name || 'AI Assistant';
    
    modelOptions.querySelectorAll('.selector-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.id === currentModel);
    });
}

// ==================== FILE HANDLING ====================
function handleFileSelect() {
    const file = fileInput.files?.[0];
    if (!file) return;
    
    const allowed = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
    if (!allowed.includes(file.type)) {
        showNotification('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', true);
        return;
    }
    
    if (file.size > 20 * 1024 * 1024) {
        showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 20 –ú–ë)', true);
        return;
    }
    
    pendingFile = file;
    updateFilePreview();
    fileInput.value = '';
}

function handlePaste(e) {
    const items = e.clipboardData?.items;
    if (!items) return;
    
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            e.preventDefault();
            const blob = item.getAsFile();
            pendingFile = new File([blob], `image-${Date.now()}.png`, { type: blob.type });
            updateFilePreview();
            showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ');
            break;
        }
    }
}

function updateFilePreview() {
    if (!pendingFile) {
        filePreviewContainer.innerHTML = '';
        filePreviewContainer.classList.remove('visible');
        uploadButton.classList.remove('has-file');
        return;
    }
    
    uploadButton.classList.add('has-file');
    filePreviewContainer.classList.add('visible');
    
    const isPdf = pendingFile.type === 'application/pdf';
    const isImage = pendingFile.type.startsWith('image/');
    
    let thumbHtml = '';
    if (isImage) {
        const url = URL.createObjectURL(pendingFile);
        thumbHtml = `<img src="${url}" class="file-preview-thumb" alt="preview">`;
    }
    
    const icon = isPdf 
        ? '<svg viewBox="0 -960 960 960"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Z"/></svg>'
        : '<svg viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/></svg>';
    
    filePreviewContainer.innerHTML = `
        <div class="file-preview-chip">
            ${thumbHtml || icon}
            <span class="file-preview-name">${pendingFile.name}</span>
            <span class="file-preview-remove" onclick="clearPendingFile()">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </span>
        </div>
    `;
}

function clearPendingFile() {
    pendingFile = null;
    updateFilePreview();
}

// ==================== MESSAGES ====================
function displayMessage(role, text, imageUrl = null) {
    emptyState.style.display = 'none';
    
    const isUser = role === 'user';
    const avatar = isUser ? '–Ø' : '‚ú¶';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}-message`;
    
    let contentHtml = '';
    if (imageUrl) {
        contentHtml += `<img src="${imageUrl}" class="message-image" onclick="window.open(this.src)">`;
    }
    contentHtml += formatText(text);
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-bubble">
            <div class="message-content">${contentHtml}</div>
            <div class="message-time">${getCurrentTime()}</div>
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Highlight code
    messageDiv.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
    });
    
    // Add copy button for bot messages
    if (!isUser) {
        addCopyButton(messageDiv);
    }
}

function formatText(text) {
    if (!text) return '';
    
    // Code blocks
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
        const language = lang || 'plaintext';
        return `
            <div class="code-block">
                <div class="code-header">
                    <span class="code-language">${language}</span>
                    <div class="code-actions">
                        <button class="code-btn" onclick="copyCode(this)">
                            <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
                <pre><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>
            </div>
        `;
    });
    
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Italic
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    
    // Links
    text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
    
    // Line breaks
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addCopyButton(messageDiv) {
    const content = messageDiv.querySelector('.message-content');
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.innerHTML = '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
    btn.onclick = () => copyToClipboard(content.innerText);
    content.style.position = 'relative';
    content.appendChild(btn);
}

function copyCode(btn) {
    const code = btn.closest('.code-block').querySelector('code').textContent;
    copyToClipboard(code);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
    }).catch(() => {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', true);
    });
}

// ==================== TYPING INDICATOR ====================
function showTyping() {
    const div = document.createElement('div');
    div.className = 'typing-indicator';
    div.id = 'typing';
    div.innerHTML = `
        <div class="message-avatar">‚ú¶</div>
        <div class="typing-bubble">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    headerSubtitle.textContent = '–î—É–º–∞–µ—Ç...';
}

function hideTyping() {
    $('typing')?.remove();
    headerSubtitle.textContent = '–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å';
}

// ==================== SEND MESSAGE ====================
async function sendMessage() {
    const text = messageInput.value.trim();
    const file = pendingFile;
    
    if (!text && !file) return;
    if (isGenerating) return;
    
    isGenerating = true;
    sendButton.disabled = true;
    
    messageInput.value = '';
    autoResize.call(messageInput);
    clearPendingFile();
    
    let fileData = null;
    let displayUrl = null;
    
    if (file) {
        try {
            fileData = await toBase64(file);
            if (file.type.startsWith('image/')) {
                displayUrl = fileData;
            }
        } catch (err) {
            showNotification('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', true);
            isGenerating = false;
            sendButton.disabled = false;
            return;
        }
    }
    
    const displayText = text || (file ? `üìé ${file.name}` : '');
    displayMessage('user', displayText, displayUrl);
    
    const apiText = text || '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ –æ–ø–∏—à–∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.';
    chatHistory.push({
        role: 'user',
        text: apiText,
        file: file ? { data: fileData, mimeType: file.type } : null
    });
    
    showTyping();
    
    try {
        const response = await callAPI();
        hideTyping();
        
        if (response) {
            displayMessage('bot', response);
            chatHistory.push({ role: 'bot', text: response });
        }
    } catch (error) {
        hideTyping();
        displayMessage('bot', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
    
    isGenerating = false;
    sendButton.disabled = false;
}

async function callAPI() {
    const model = MODELS.find(m => m.id === currentModel);
    
    const messages = [
        { role: 'system', content: '–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º.' }
    ];
    
    chatHistory.forEach(msg => {
        const content = [];
        if (msg.text) content.push({ type: 'text', text: msg.text });
        if (msg.role === 'user' && msg.file) {
            content.push({ type: 'image_url', image_url: { url: msg.file.data } });
        }
        messages.push({
            role: msg.role === 'bot' ? 'assistant' : 'user',
            content: content.length === 1 && content[0].type === 'text' ? content[0].text : content
        });
    });
    
    const response = await fetch(PROXY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            model: currentModel,
            messages,
            max_tokens: 4096,
            provider: model?.api || 'gemini'
        })
    });
    
    if (!response.ok) {
        const error = await response.text();
        throw new Error(error.substring(0, 200));
    }
    
    const data = await response.json();
    return data.choices?.[0]?.message?.content || null;
}

// ==================== UTILS ====================
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function getCurrentTime() {
    return new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function autoResize() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
}

function showNotification(msg, isError = false) {
    notification.textContent = msg;
    notification.className = `notification show ${isError ? 'error' : ''}`;
    setTimeout(() => notification.classList.remove('show'), 2500);
}

function openModal(modal) {
    modal.style.display = 'flex';
}

function closeModal(modal) {
    modal.style.display = 'none';
}

function saveApiKey() {
    const key = $('api-key-input').value.trim();
    if (key) {
        apiKey = key;
        localStorage.setItem('gemini_api_key', key);
        showNotification('API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        closeModal(apiModal);
    }
}

function resetChat() {
    chatHistory = [];
    chatContainer.innerHTML = '';
    emptyState.style.display = 'flex';
    chatContainer.appendChild(emptyState);
    clearPendingFile();
    showNotification('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
}

// ==================== START ====================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢–µ—Å—Ç –í–µ–±-–∫–∞–º–µ—Ä—ã –∏ –ú–∏–∫—Ä–æ—Ñ–æ–Ω–∞</title>
<link id="favicon" rel="icon" href="https://img.icons8.com/?size=100&id=0CxxSR6zbNFC&format=png&color=000000" type="image/png">
<style>
/* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏ —Å–±—Ä–æ—Å --- */
html, body {
margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #fff;
}
    /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ --- */
    #video-container {
         position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: #000; z-index: 1; overflow: hidden;
    }

    /* --- –í–∏–¥–µ–æ --- */
    #webcamVideo {
        width: 100%; height: 100%; object-fit: contain; z-index: 2; display: none; transition: transform 0.15s ease-out; transform-origin: center center; transform: scale(1, 1);
    }

    /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–≤–µ—Ä–ª–µ—è --- */
    #overlay {
        position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 680px; /* Wider for more buttons */ background-color: rgba(10, 10, 10, 0.55); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.45); z-index: 10; text-align: center; opacity: 1; transition: opacity 0.3s ease-in-out, width 0.35s ease-in-out, height 0.35s ease-in-out, padding 0.35s ease-in-out, border-radius 0.35s ease-in-out, bottom 0.35s ease-in-out, background-color 0.3s ease-in-out; overflow: hidden; padding: 15px 20px; height: auto; max-height: 85vh;
    }
    #overlay.collapsed {
        width: 60px; height: 60px; padding: 0; border-radius: 50%; cursor: pointer; background-color: rgba(30, 30, 30, 0.65); bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    #overlay-content {
        width: 100%; display: flex; flex-direction: column; align-items: center; transition: opacity 0.2s ease-in-out, max-height 0.35s ease-in-out; max-height: 80vh; opacity: 1; overflow: hidden;
    }
    #overlay.collapsed #overlay-content { opacity: 0; max-height: 0; pointer-events: none; }

    /* --- –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è --- */
    .overlay-toggle-btn {
        position: absolute; background: none; border: none; color: rgba(255, 255, 255, 0.6); font-size: 24px; line-height: 1; padding: 5px; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease, opacity 0.3s ease-in-out; z-index: 11;
    }
    #collapseOverlayButton { top: 8px; right: 8px; display: block; opacity: 1; }
    #collapseOverlayButton:hover { color: #fff; transform: scale(1.1); }
    #overlay.collapsed #collapseOverlayButton { opacity: 0; pointer-events: none; display: none; }
    #showOverlayButton { top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; opacity: 0; font-size: 28px; }
    #overlay.collapsed #showOverlayButton { display: block; opacity: 1; }
    #showOverlayButton:hover { color: #fff; transform: translate(-50%, -50%) scale(1.1); }

    /* --- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è --- */
    #controls {
        margin-bottom: 15px; margin-top: 5px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 12px; width: 100%;
    }
    button {
        padding: 9px 16px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; border: none; border-radius: 20px; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }
    button:active:not(:disabled) { transform: scale(0.97); box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    button:disabled { background-color: rgba(120, 120, 120, 0.3); border-color: rgba(120, 120, 120, 0.4); cursor: not-allowed; opacity: 0.6; }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ --- */
    #startButton { background-color: rgba(26, 115, 232, 0.7); border: none; }
    #startButton:hover:not(:disabled) { background-color: rgba(26, 115, 232, 0.9); }
    #stopButton { background-color: rgba(217, 83, 79, 0.7); border: none; }
    #stopButton:hover:not(:disabled) { background-color: rgba(217, 83, 79, 0.9); }
    #switchCameraButton, #infoButton { background-color: rgba(92, 184, 92, 0.6); border: none; }
    #switchCameraButton:hover:not(:disabled), #infoButton:hover:not(:disabled) { background-color: rgba(92, 184, 92, 0.8); }
    #flipHorizontalButton, #flipVerticalButton { background-color: rgba(100, 100, 100, 0.5); border: none; }
    #flipHorizontalButton:hover:not(:disabled), #flipVerticalButton:hover:not(:disabled) { background-color: rgba(120, 120, 120, 0.7); }
    button.active-flip { background-color: rgba(26, 115, 232, 0.6); border-color: rgba(26, 115, 232, 0.8); }
    button.active-flip:hover:not(:disabled) { background-color: rgba(26, 115, 232, 0.8); }
    
    /* --- NEW: Recording buttons --- */
    #recordButton { background-color: #db4437; border: none; color: white; }
    #recordButton.recording { background-color: #f4b400; animation: pulse-rec 1.5s infinite; }
    @keyframes pulse-rec { 0% { box-shadow: 0 0 0 0 rgba(244, 180, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(244, 180, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 180, 0, 0); } }
    #playButton { background-color: #4285f4; border: none; color: white; }


    /* --- –ü—Ä–æ—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI --- */
    #status { font-weight: 500; font-size: 0.9em; min-height: 1.2em; padding: 8px 12px; border-radius: 8px; margin-top: 10px; width: calc(100% - 24px); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); background-color: rgba(0, 0, 0, 0.2); transition: background-color 0.3s ease; word-wrap: break-word; box-sizing: border-box; }
    #status.error { background-color: rgba(217, 83, 79, 0.6); }
    #status.success { background-color: rgba(92, 184, 92, 0.6); }
    #status.warning { background-color: rgba(240, 173, 78, 0.6); }

    #mic-level-container { margin-top: 10px; text-align: left; width: 100%; display: none; }
    #mic-level-container label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
    progress { width: 100%; height: 8px; border-radius: 4px; border: none; background-color: rgba(255, 255, 255, 0.15); appearance: none; -webkit-appearance: none; box-sizing: border-box; }
    progress::-webkit-progress-bar { background-color: rgba(255, 255, 255, 0.15); border-radius: 4px; }
    progress::-webkit-progress-value { background: linear-gradient(to right, #4caf50, #8bc34a); border-radius: 4px; transition: width 0.1s linear; }

    #zoom-control-container { width: 100%; margin-top: 15px; display: none; }
    #zoom-control-container label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); text-align: left; }
    #zoomValueLabel { display: block; text-align: right; margin-top: -18px; font-size: 0.85em; opacity: 0.7; pointer-events: none; }
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 3px; outline: none; opacity: 0.8; transition: opacity .2s; margin-top: 3px; cursor: pointer; box-sizing: border-box; }
    input[type=range]:hover { opacity: 1; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #1a73e8; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 0 5px rgba(0,0,0,0.3); margin-top: -6px; }

    /* --- NEW: –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ --- */
    #info-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
    }
    #info-modal-content {
        background-color: #2c2c2e; border-radius: 12px; padding: 25px 30px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; border: 1px solid rgba(255, 255, 255, 0.15);
    }
    #info-modal-close {
        position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: rgba(255,255,255,0.5); cursor: pointer; transition: color 0.2s, transform 0.2s;
    }
    #info-modal-close:hover { color: #fff; transform: scale(1.1); }
    #info-modal-content h2 { margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 15px; }
    #device-list { list-style: none; padding: 0; }
    #device-list li { background-color: rgba(255,255,255,0.05); border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; font-size: 14px; }
    #device-list li strong { display: inline-block; min-width: 80px; color: #a0a0a0; }
    #device-list li code { background-color: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; font-size: 12px; word-break: break-all; }
    #device-list .device-note { font-size: 13px; margin-top: 15px; color: #ccc; background-color: rgba(0,0,0,0.1); padding: 10px; border-radius: 6px; }

</style>


</head>
<body>
    
    <div id="video-container">
    <video id="webcamVideo" playsinline autoplay muted></video>
</div>

<div id="overlay">
     <button id="collapseOverlayButton" class="overlay-toggle-btn" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">‚åÑ</button>
    <div id="overlay-content">
        <div id="controls">
             <button id="startButton">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
             <button id="stopButton" style="display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
             <button id="switchCameraButton" style="display: none;" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É">–°–º–µ–Ω–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
             <button id="flipHorizontalButton" style="display: none;" title="–û—Ç—Ä–∞–∑–∏—Ç—å –∑–µ—Ä–∫–∞–ª—å–Ω–æ">‚Üî –ó–µ—Ä–∫–∞–ª—å–Ω–æ</button>
             <button id="flipVerticalButton" style="display: none;" title="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å">‚Üï –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
             <!-- NEW: Info and Recording Buttons -->
             <button id="infoButton" style="display: none;" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö">‚ìò –ò–Ω—Ñ–æ</button>
             <button id="recordButton" style="display: none;" title="–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∑–≤—É–∫–∞">‚ñ∂Ô∏è –ó–∞–ø–∏—Å—å</button>
             <button id="playButton" style="display: none;" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å">‚ñ∂Ô∏è –í–æ—Å–ø—Ä.</button>
        </div>

        <div id="mic-level-container">
            <label for="micLevel">–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:</label>
            <progress id="micLevel" value="0" max="100"></progress>
        </div>
        <div id="zoom-control-container">
            <label for="zoomSlider" id="zoomLabel">–£–≤–µ–ª–∏—á–µ–Ω–∏–µ (Zoom):</label>
            <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1">
            <span id="zoomValueLabel">1.0x</span>
        </div>
        <div id="status">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç"</div>
    </div>
     <button id="showOverlayButton" class="overlay-toggle-btn" aria-label="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">‚åÉ</button>
</div>

<!-- NEW: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö -->
<div id="info-modal">
    <div id="info-modal-content">
        <span id="info-modal-close" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</span>
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
        <ul id="device-list">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </ul>
        <div class="device-note">
            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ï—Å–ª–∏ —É —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏—è (label), —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤—ã –µ—â–µ –Ω–µ –¥–∞–≤–∞–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –Ω–∞ —ç—Ç–æ–º —Å–∞–π—Ç–µ. –ë—Ä–∞—É–∑–µ—Ä—ã —Å–∫—Ä—ã–≤–∞—é—Ç —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ü–µ–ª—è—Ö –∑–∞—â–∏—Ç—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.
        </div>
    </div>
</div>

<!-- NEW: –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
<audio id="playbackAudio" style="display:none;"></audio>

<script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM ---
    const videoElement = document.getElementById('webcamVideo');
    const micLevelElement = document.getElementById('micLevel');
    const micContainer = document.getElementById('mic-level-container');
    const statusElement = document.getElementById('status');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const overlay = document.getElementById('overlay');
    const collapseOverlayButton = document.getElementById('collapseOverlayButton');
    const showOverlayButton = document.getElementById('showOverlayButton');
    const videoContainer = document.getElementById('video-container');
    const zoomControlContainer = document.getElementById('zoom-control-container');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValueLabel = document.getElementById('zoomValueLabel');
    const zoomLabel = document.getElementById('zoomLabel');
    const flipHorizontalButton = document.getElementById('flipHorizontalButton');
    const flipVerticalButton = document.getElementById('flipVerticalButton');
    // NEW: –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
    const infoButton = document.getElementById('infoButton');
    const infoModal = document.getElementById('info-modal');
    const infoModalClose = document.getElementById('info-modal-close');
    const deviceListElement = document.getElementById('device-list');
    const recordButton = document.getElementById('recordButton');
    const playButton = document.getElementById('playButton');
    const playbackAudio = document.getElementById('playbackAudio');


    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let audioContext, analyser, microphone, streamVideo, streamAudio;
    let animationFrameId, videoTrack, zoomType = 'none';
    let isOverlayCollapsed = false, videoDevices = [], currentCameraIndex = 0;
    let isFlippedHorizontally = false, isFlippedVertically = false;
    // NEW: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
    let mediaRecorder, recordedChunks = [], audioUrl = null, isRecording = false;


    // --- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (startTest, stopTest, etc.) ---
    // (–í–µ—Å—å –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è startTest, stopTest, handleGetUserMediaError, updateVolumeMeter,
    // applyTransformations, setupZoomForTrack, applyHardwareZoom, toggleHorizontalFlip, toggleVerticalFlip,
    // collapseOverlay, expandOverlay, populateCameraList, switchCamera –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    // ...
    // ... [–î–õ–Ø –ö–†–ê–¢–ö–û–°–¢–ò –ó–î–ï–°–¨ –û–ü–£–©–ï–ù –£–ñ–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î JS] ...
    // ... –ù–ò–ñ–ï –ò–î–ï–¢ –ü–û–õ–ù–´–ô –ö–û–î JS –° –ò–ù–¢–ï–ì–†–ê–¶–ò–ï–ô –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô ...
    // --- –ü–æ–ª–Ω—ã–π JS –∫–æ–¥ ---
    
    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ---
    function handleGetUserMediaError(err, deviceType) {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ ${deviceType}:`, err);
        let errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ ${deviceType}.`;

        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMessage = `–î–æ—Å—Ç—É–ø –∫ ${deviceType} –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.`;
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
             if (deviceType === '–º–∏–∫—Ä–æ—Ñ–æ–Ω') {
                 errorMessage = `–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.`;
             } else {
                 errorMessage = `${deviceType.charAt(0).toUpperCase() + deviceType.slice(1)} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`;
             }
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞—Ö–≤–∞—Ç —Å ${deviceType}. –í–æ–∑–º–æ–∂–Ω–æ, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.`;
        } else if (err.name === 'OverconstrainedError') {
            errorMessage = `–ù–µ –Ω–∞–π–¥–µ–Ω ${deviceType}, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–π —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ).`;
        } else {
            errorMessage = `–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ ${deviceType}: ${err.name}`;
        }

        statusElement.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
        statusElement.className = 'status error';

        if (deviceType.startsWith('–∫–∞–º–µ—Ä–∞')) {
             stopTest(false);
             videoContainer.style.backgroundColor = '#333';
        } else if (deviceType === '–º–∏–∫—Ä–æ—Ñ–æ–Ω') {
             if (streamVideo && statusElement.className !== 'error') {
                 statusElement.textContent = '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–æ ' + errorMessage;
                 statusElement.className = 'status warning';
             }
             if (audioContext && audioContext.state !== 'closed') { audioContext.close().catch(e => console.error("AudioContext close error:", e)); }
             analyser = null; microphone = null; streamAudio = null;
             micContainer.style.display = 'none';
             // NEW: Hide recording buttons if mic fails
             recordButton.style.display = 'none';
             playButton.style.display = 'none';
        }
    }

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ ---
    function updateVolumeMeter() {
        if (!analyser || isOverlayCollapsed) {
            if(animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            return;
        }
        const array = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(array);

        let sumSquares = 0.0;
        for (const amplitude of array) {
            const deviation = (amplitude / 128.0) - 1.0;
            sumSquares += deviation * deviation;
        }
        const rms = Math.sqrt(sumSquares / array.length);
        const volume = Math.min(100, Math.max(0, rms * 350));
        micLevelElement.value = volume;
        animationFrameId = requestAnimationFrame(updateVolumeMeter);
    }

    // --- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (Zoom + Flip) ---
    function applyTransformations() {
        if (!videoElement) return;
        let currentZoom = (zoomType === 'software') ? parseFloat(zoomSlider.value) || 1.0 : 1.0;
        const scaleX = currentZoom * (isFlippedHorizontally ? -1 : 1);
        const scaleY = currentZoom * (isFlippedVertically ? -1 : 1);
        videoElement.style.transform = `scale(${scaleX}, ${scaleY})`;
        const zoomVal = parseFloat(zoomSlider.value) || 1.0;
        if (!isOverlayCollapsed) zoomValueLabel.textContent = `${zoomVal.toFixed(1)}x`;
        flipHorizontalButton.classList.toggle('active-flip', isFlippedHorizontally);
        flipVerticalButton.classList.toggle('active-flip', isFlippedVertically);
    }

    // --- –ó—É–º ---
    function setupZoomForTrack(track) {
        videoTrack = track; zoomControlContainer.style.display = 'none'; zoomType = 'none';
        applyTransformations();
        if (!track || track.readyState !== 'live') return;
        try {
            const capabilities = track.getCapabilities();
            if (capabilities.zoom) {
                zoomType = 'hardware'; zoomLabel.textContent = "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ (–∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ):";
                zoomSlider.min = capabilities.zoom.min; zoomSlider.max = capabilities.zoom.max; zoomSlider.step = capabilities.zoom.step || 0.1;
                zoomSlider.value = capabilities.zoom.min > 1 ? capabilities.zoom.min : 1.0;
                applyHardwareZoom(zoomSlider.value);
                zoomControlContainer.style.display = 'block';
            } else {
                zoomType = 'software'; zoomLabel.textContent = "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ):";
                zoomSlider.min = 1.0; zoomSlider.max = 5.0; zoomSlider.step = 0.1; zoomSlider.value = 1.0;
                applyTransformations();
                zoomControlContainer.style.display = 'block';
            }
        } catch (e) { console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã:", e); }
        applyTransformations();
    }
    async function applyHardwareZoom(value) {
        if (zoomType !== 'hardware' || !videoTrack || videoTrack.readyState !== 'live') return;
        try {
            await videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(value) }] });
            if (!isOverlayCollapsed) zoomValueLabel.textContent = `${parseFloat(value).toFixed(1)}x`;
        } catch (err) { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ –∑—É–º–∞:", err); }
    }

    // --- –û—Ç—Ä–∞–∂–µ–Ω–∏–µ ---
    function toggleHorizontalFlip() { isFlippedHorizontally = !isFlippedHorizontally; applyTransformations(); }
    function toggleVerticalFlip() { isFlippedVertically = !isFlippedVertically; applyTransformations(); }

    // --- –û–≤–µ—Ä–ª–µ–π ---
    function collapseOverlay() { if (!isOverlayCollapsed) { overlay.classList.add('collapsed'); isOverlayCollapsed = true; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } } }
    function expandOverlay() { if (isOverlayCollapsed) { overlay.classList.remove('collapsed'); isOverlayCollapsed = false; if (analyser && !animationFrameId) { updateVolumeMeter(); } applyTransformations(); } }

    // --- –ö–∞–º–µ—Ä—ã ---
    async function populateCameraList() {
        videoDevices = [];
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            devices.forEach(device => { if (device.kind === 'videoinput') { videoDevices.push({ deviceId: device.deviceId, label: device.label || `–ö–∞–º–µ—Ä–∞ ${videoDevices.length + 1}` }); } });
            if (videoDevices.length > 1) {
                switchCameraButton.style.display = 'inline-block';
                const currentDeviceId = videoTrack?.getSettings().deviceId;
                currentCameraIndex = Math.max(0, videoDevices.findIndex(dev => dev.deviceId === currentDeviceId));
                const nextIndex = (currentCameraIndex + 1) % videoDevices.length;
                switchCameraButton.title = `–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞: ${videoDevices[nextIndex]?.label || '–°–ª–µ–¥—É—é—â–∞—è –∫–∞–º–µ—Ä–∞'}`;
            } else {
                switchCameraButton.style.display = 'none'; currentCameraIndex = 0;
            }
        } catch (err) { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:", err); }
    }
    async function switchCamera() {
         if (videoDevices.length <= 1 || switchCameraButton.disabled) return;
        switchCameraButton.disabled = true; statusElement.textContent = '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã...'; statusElement.className = 'status';
        if (streamVideo) { streamVideo.getTracks().forEach(track => track.stop()); }
        videoTrack = null; isFlippedHorizontally = false; isFlippedVertically = false;
        currentCameraIndex = (currentCameraIndex + 1) % videoDevices.length;
        const nextDevice = videoDevices[currentCameraIndex];
        try {
            streamVideo = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: nextDevice.deviceId } }, audio: false });
            videoElement.srcObject = streamVideo;
            await new Promise(resolve => videoElement.onloadedmetadata = resolve);
            await videoElement.play();
            setupZoomForTrack(streamVideo.getVideoTracks()[0]);
            let statusText = `–ê–∫—Ç–∏–≤–Ω–∞ –∫–∞–º–µ—Ä–∞: ${nextDevice.label}.`;
            if(streamAudio) statusText += " –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω.";
            statusElement.textContent = statusText; statusElement.className = 'status success';
            const nextPreviewIndex = (currentCameraIndex + 1) % videoDevices.length;
            switchCameraButton.title = `–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞: ${videoDevices[nextPreviewIndex]?.label || '–°–ª–µ–¥—É—é—â–∞—è –∫–∞–º–µ—Ä–∞'}`;
        } catch (err) {
            handleGetUserMediaError(err, `–∫–∞–º–µ—Ä–∞ (${nextDevice.label})`);
            switchCameraButton.style.display = 'none'; videoElement.style.display = 'none'; videoContainer.style.backgroundColor = '#333';
        } finally {
            if (switchCameraButton.style.display !== 'none') { switchCameraButton.disabled = false; }
        }
    }
    
    // --- NEW: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ---
    async function showDeviceInfo() {
        deviceListElement.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–ø–∏—Å–∫–∞
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            let hasCameras = false, hasMics = false;
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä
            const cameras = devices.filter(d => d.kind === 'videoinput');
            if (cameras.length > 0) {
                hasCameras = true;
                const title = document.createElement('li');
                title.innerHTML = `<h3>üì∑ –ö–∞–º–µ—Ä—ã (${cameras.length})</h3>`;
                deviceListElement.appendChild(title);
                cameras.forEach(device => {
                    const item = document.createElement('li');
                    item.innerHTML = `<strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${device.label || 'N/A'}<br><strong>ID:</strong> <code>${device.deviceId}</code>`;
                    deviceListElement.appendChild(item);
                });
            }
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
            const mics = devices.filter(d => d.kind === 'audioinput');
             if (mics.length > 0) {
                hasMics = true;
                const title = document.createElement('li');
                title.innerHTML = `<h3>üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω—ã (${mics.length})</h3>`;
                deviceListElement.appendChild(title);
                mics.forEach(device => {
                    const item = document.createElement('li');
                    item.innerHTML = `<strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${device.label || 'N/A'}<br><strong>ID:</strong> <code>${device.deviceId}</code>`;
                    deviceListElement.appendChild(item);
                });
            }
            
            if (!hasCameras && !hasMics) {
                 deviceListElement.innerHTML = '<li>–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</li>';
            }
            
        } catch (e) {
            deviceListElement.innerHTML = `<li>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${e.message}</li>`;
        }
        infoModal.style.display = 'flex';
    }
    function closeDeviceInfo() {
        infoModal.style.display = 'none';
    }

    // --- NEW: –§—É–Ω–∫—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ---
    function startRecording() {
        if (!streamAudio || isRecording) return;
        
        recordedChunks = [];
        try {
            // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∫–æ–¥–µ–∫–∏, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            const options = { mimeType: 'audio/webm; codecs=opus' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                delete options.mimeType; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
            }
            mediaRecorder = new MediaRecorder(streamAudio, options);
        } catch (e) {
            statusElement.textContent = '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å MediaRecorder.';
            statusElement.className = 'status error';
            console.error("MediaRecorder creation failed: ", e);
            return;
        }
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstart = () => {
            isRecording = true;
            recordButton.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
            recordButton.classList.add('recording');
            playButton.style.display = 'none';
            playButton.disabled = true;
            statusElement.textContent = '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å –∑–≤—É–∫–∞... –ù–∞–∂–º–∏—Ç–µ "–°—Ç–æ–ø" –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.';
            statusElement.className = 'status warning';
        };
        
        mediaRecorder.onstop = () => {
            isRecording = false;
            recordButton.textContent = '‚ñ∂Ô∏è –ó–∞–ø–∏—Å—å';
            recordButton.classList.remove('recording');
            
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—Å—ã–ª–∫—É
            }
            
            const audioBlob = new Blob(recordedChunks, { 'type' : mediaRecorder.mimeType || 'audio/webm' });
            audioUrl = URL.createObjectURL(audioBlob);
            playbackAudio.src = audioUrl;
            
            playButton.style.display = 'inline-block';
            playButton.disabled = false;
            statusElement.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–í–æ—Å–ø—Ä." –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.';
            statusElement.className = 'status success';
        };
        
        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
        }
    }
    
    function handleRecordButtonClick() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }
    
    function playRecording() {
        if (audioUrl) {
            playbackAudio.play();
            playButton.disabled = true;
            playButton.textContent = "üé∂ –í–æ—Å–ø—Ä...";
            statusElement.textContent = '–ò–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏...';
            statusElement.className = 'status';
        }
    }
    playbackAudio.onended = () => {
        playButton.disabled = false;
        playButton.textContent = "‚ñ∂Ô∏è –í–æ—Å–ø—Ä.";
         statusElement.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å —Å–Ω–æ–≤–∞ –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç.';
         statusElement.className = 'status success';
    };

    // --- –°–¢–ê–†–¢ –¢–ï–°–¢–ê ---
    async function startTest() {
        stopTest(false);
        expandOverlay();
        statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º...';
        statusElement.className = 'status';
        startButton.disabled = true; startButton.style.display = 'none'; stopButton.style.display = 'inline-block';
        videoElement.style.display = 'none'; videoContainer.style.backgroundColor = '#000'; micContainer.style.display = 'none';
        zoomControlContainer.style.display = 'none'; switchCameraButton.style.display = 'none'; flipHorizontalButton.style.display = 'none';
        flipVerticalButton.style.display = 'none'; switchCameraButton.disabled = true; zoomType = 'none'; videoDevices = []; currentCameraIndex = 0;
        isFlippedHorizontally = false; isFlippedVertically = false;
        
        // NEW: Hide new buttons on start
        infoButton.style.display = 'none';
        recordButton.style.display = 'none';
        playButton.style.display = 'none';

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            handleGetUserMediaError({name: 'NotSupportedError'}, '–º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
            return;
        }
        
        infoButton.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ò–Ω—Ñ–æ —Å—Ä–∞–∑—É

        try { // Camera
            streamVideo = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            videoElement.srcObject = streamVideo; videoElement.style.display = 'block';
            await new Promise(r => videoElement.onloadedmetadata = r);
            await videoElement.play();
            applyTransformations(); setupZoomForTrack(streamVideo.getVideoTracks()[0]);
            await populateCameraList();
            flipHorizontalButton.style.display = 'inline-block'; flipVerticalButton.style.display = 'inline-block';
            if (statusElement.className !== 'error') {
                statusElement.textContent = '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                statusElement.className = 'status success';
            }
            if(switchCameraButton.style.display !== 'none') switchCameraButton.disabled = false;
        } catch (err) { handleGetUserMediaError(err, '–∫–∞–º–µ—Ä–∞'); return; }

        try { // Microphone
            streamAudio = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(streamAudio);
            analyser.fftSize = 256; microphone.connect(analyser);
            micContainer.style.display = 'block'; micLevelElement.value = 0;
            if (!isOverlayCollapsed) updateVolumeMeter();
            if (statusElement.className !== 'error' && statusElement.className !== 'warning') {
                let cameraLabel = videoDevices[currentCameraIndex]?.label || "–∫–∞–º–µ—Ä–∞";
                statusElement.textContent = `–ê–∫—Ç–∏–≤–Ω–∞ ${cameraLabel} –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω!`;
                statusElement.className = 'status success';
            }
             // NEW: Show record button
             recordButton.style.display = 'inline-block';
        } catch (err) { handleGetUserMediaError(err, '–º–∏–∫—Ä–æ—Ñ–æ–Ω'); }
    }

    // --- –û–°–¢–ê–ù–û–í–ö–ê –¢–ï–°–¢–ê ---
    function stopTest(resetStatus = true) {
        if (isRecording) { stopRecording(); }
        if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
        if (streamVideo) { streamVideo.getTracks().forEach(t => t.stop()); streamVideo = null; }
        videoTrack = null; videoElement.srcObject = null; videoElement.style.display = 'none';
        videoElement.style.transform = 'scale(1, 1)'; videoContainer.style.backgroundColor = '#000';
        if (streamAudio) { streamAudio.getTracks().forEach(t => t.stop()); streamAudio = null; }
        if (audioContext && audioContext.state !== 'closed') { audioContext.close(); }
        audioContext = null; analyser = null; microphone = null;

        // NEW: Reset recording state
        if (audioUrl) { URL.revokeObjectURL(audioUrl); audioUrl = null; }
        recordedChunks = []; mediaRecorder = null; isRecording = false;
        playbackAudio.src = '';

        // Reset UI
        micContainer.style.display = 'none'; zoomControlContainer.style.display = 'none';
        switchCameraButton.style.display = 'none'; flipHorizontalButton.style.display = 'none';
        flipVerticalButton.style.display = 'none'; infoButton.style.display = 'none'; recordButton.style.display = 'none'; playButton.style.display = 'none';
        flipHorizontalButton.classList.remove('active-flip'); flipVerticalButton.classList.remove('active-flip');
        recordButton.textContent = '‚ñ∂Ô∏è –ó–∞–ø–∏—Å—å'; recordButton.classList.remove('recording');

        if (resetStatus) {
            statusElement.textContent = '–¢–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
            statusElement.className = 'status';
        }
        startButton.disabled = false; startButton.style.display = 'inline-block'; stopButton.style.display = 'none';
    }

    // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ---
    startButton.onclick = startTest;
    stopButton.onclick = () => stopTest(true);
    switchCameraButton.onclick = switchCamera;
    flipHorizontalButton.onclick = toggleHorizontalFlip;
    flipVerticalButton.onclick = toggleVerticalFlip;
    zoomSlider.addEventListener('input', (e) => {
        if (zoomType === 'hardware') applyHardwareZoom(e.target.value);
        else if (zoomType === 'software') applyTransformations();
    });
    collapseOverlayButton.addEventListener('click', e => { e.stopPropagation(); collapseOverlay(); });
    showOverlayButton.addEventListener('click', e => { e.stopPropagation(); expandOverlay(); });
    
    // NEW: Handlers for new features
    infoButton.onclick = showDeviceInfo;
    infoModalClose.onclick = closeDeviceInfo;
    infoModal.onclick = (e) => { if (e.target === infoModal) closeDeviceInfo(); }; // Close on backdrop click
    recordButton.onclick = handleRecordButtonClick;
    playButton.onclick = playRecording;
    
    // --- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ HTTPS ---
    if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname)) {
         const warningDiv = document.createElement('div');
         warningDiv.style.cssText = 'background-color:rgba(240, 173, 78, 0.8);color:#000;padding:10px;text-align:center;position:fixed;top:0;left:0;width:100%;z-index:1000;';
         warningDiv.textContent = '–í–Ω–∏–º–∞–Ω–∏–µ: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É HTTPS.';
         document.body.prepend(warningDiv);
    }

    window.addEventListener('beforeunload', () => stopTest(false));
</script>

</body>
</html>
<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ö–Ω–∏–≥–∏</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,600;1,7..72,400&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">
  <link rel="icon" href="img/book.png" type="image/png">

<style>
    @font-face {
      font-family: 'Liberation Serif';
      src: local('Liberation Serif'), local('LiberationSerif');
    }

    :root {
      --bg-color: #faf8f5;
      --text-color: #2c2825;
      --accent-color: #8b7355;
      --accent-hover: #6d5a45;
      --surface-color: #ffffff;
      --surface-elevated: #ffffff;
      --border-color: rgba(139, 115, 85, 0.15);
      --shadow-soft: 0 2px 20px rgba(44, 40, 37, 0.06);
      --shadow-medium: 0 8px 40px rgba(44, 40, 37, 0.1);
      --shadow-strong: 0 20px 60px rgba(44, 40, 37, 0.15);
      --font-size: 19px;
      --line-height: 1.8;
      --font-family: 'Literata', serif;
      --ui-font: 'Inter', -apple-system, sans-serif;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --scrollbar-thumb: rgba(139, 115, 85, 0.4);
      --scrollbar-track: rgba(139, 115, 85, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.5);
      --float-btn-bg: rgba(255, 255, 255, 0.9);
      --hidden-opacity: 0.8;
      --float-btn-color: #5a5a5a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0; padding: 0;
      background: var(--bg-color);
      font-family: var(--ui-font);
      height: 100vh;
      overflow: hidden;
      color: var(--text-color);
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-color);
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    * { scrollbar-width: auto; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }

    /* === CUSTOM MODAL === */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-container {
      background: var(--surface-color);
      border-radius: 20px;
      padding: 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: var(--shadow-strong);
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.visible .modal-container { transform: scale(1) translateY(0); }
    .modal-icon {
      width: 56px; height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 24px;
    }
    .modal-icon.info { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); color: #0284c7; }
    .modal-icon.success { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #16a34a; }
    .modal-icon.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #d97706; }
    .modal-icon.error { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #dc2626; }
    .modal-icon.input { background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%); color: white; }
    .modal-icon.confirm { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #d97706; }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 12px;
      color: var(--text-color);
    }
    .modal-message {
      font-size: 14px;
      text-align: center;
      color: var(--text-color);
      opacity: 0.7;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .modal-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 15px;
      font-family: var(--ui-font);
      background: var(--bg-color);
      color: var(--text-color);
      outline: none;
      transition: var(--transition);
      margin-bottom: 24px;
    }
    .modal-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(139, 115, 85, 0.1); }
    .modal-input::placeholder { color: var(--text-color); opacity: 0.4; }
    .modal-buttons { display: flex; gap: 12px; justify-content: center; }
    .modal-btn {
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--ui-font);
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }
    .modal-btn.primary {
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(139, 115, 85, 0.3);
    }
    .modal-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 115, 85, 0.4); }
    .modal-btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    .modal-btn.danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4); }
    .modal-btn.secondary {
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .modal-btn.secondary:hover { background: var(--surface-elevated); border-color: var(--accent-color); }

    /* === TOAST NOTIFICATIONS === */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 10001;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      background: var(--surface-color);
      border-radius: 16px;
      box-shadow: var(--shadow-strong);
      transform: translateX(120%);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: auto;
      max-width: 360px;
      border-left: 4px solid var(--accent-color);
    }
    .toast.visible { transform: translateX(0); }
    .toast.hiding { transform: translateX(120%); opacity: 0; }
    .toast-icon {
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .toast.success .toast-icon { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #16a34a; }
    .toast.success { border-left-color: #16a34a; }
    .toast.error .toast-icon { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #dc2626; }
    .toast.error { border-left-color: #dc2626; }
    .toast.warning .toast-icon { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #d97706; }
    .toast.warning { border-left-color: #d97706; }
    .toast.info .toast-icon { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); color: #0284c7; }
    .toast.info { border-left-color: #0284c7; }
    .toast-content { flex: 1; }
    .toast-title { font-size: 14px; font-weight: 600; color: var(--text-color); margin-bottom: 2px; }
    .toast-message { font-size: 13px; color: var(--text-color); opacity: 0.7; }
    .toast-close {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--bg-color);
      color: var(--text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0.6;
      transition: var(--transition);
      flex-shrink: 0;
    }
    .toast-close:hover { opacity: 1; background: var(--border-color); }

    @media (max-width: 480px) {
      .toast-container { bottom: 16px; right: 16px; left: 16px; }
      .toast { max-width: 100%; }
      .modal-container { padding: 24px; margin: 16px; }
    }

    /* === LIBRARY SCREEN === */
    #input-screen {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-color);
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      z-index: 50;
      overflow: hidden;
    }
    #input-screen[hidden] { display: none !important; }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 24px;
      background: transparent;
    }

    .auth-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 100px;
      cursor: pointer;
      font-family: var(--ui-font);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-color);
      transition: var(--transition);
      box-shadow: var(--shadow-soft);
    }
    .auth-btn:hover {
      background: var(--surface-elevated);
      box-shadow: var(--shadow-medium);
      transform: translateY(-1px);
    }
    .auth-btn svg { opacity: 0.9; }

    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      box-shadow: var(--shadow-soft);
    }
    .logout-link {
      font-size: 13px;
      color: var(--accent-color);
      cursor: pointer;
      font-weight: 500;
      opacity: 0.8;
      transition: var(--transition);
    }
    .logout-link:hover { opacity: 1; }

    .library-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0 24px 24px;
      overflow: hidden;
    }

    #bookshelf-container {
      display: none;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    #bookshelf-container.visible { display: flex; }

    .shelf-section {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
    }

    .shelf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
    }

    /* === BOOK CARDS === */
    .book-item {
      position: relative;
      height: 200px;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    .book-item::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, transparent 30%, rgba(0,0,0,0.6) 100%);
      z-index: 1;
    }
    .book-item:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
    }
    .book-title {
      position: relative;
      z-index: 2;
      color: white;
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      font-family: var(--ui-font);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      word-break: break-word;
    }
    .book-progress {
      position: relative;
      z-index: 2;
      margin-top: 8px;
      height: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      overflow: hidden;
    }
    .book-progress-bar {
      height: 100%;
      background: white;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .book-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0;
      transition: var(--transition);
      z-index: 3;
    }
    .book-item:hover .book-delete-btn { opacity: 1; }
    .book-delete-btn:hover { background: #ef4444; transform: scale(1.1); }

    .new-book-btn {
      height: 200px;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--accent-color);
      transition: var(--transition);
      background: transparent;
      gap: 8px;
    }
    .new-book-btn:hover {
      border-color: var(--accent-color);
      background: rgba(139, 115, 85, 0.05);
      transform: translateY(-4px);
    }
    .new-book-btn .icon {
      width: 48px; height: 48px;
      border: 2px solid currentColor;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 300;
    }
    .new-book-btn span {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    textarea {
      flex: 1;
      padding: 28px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      font-size: 15px;
      resize: none;
      font-family: var(--ui-font);
      outline: none;
      background: var(--surface-color);
      color: var(--text-color);
      box-shadow: var(--shadow-soft);
      transition: var(--transition);
      line-height: 1.6;
    }
    textarea::placeholder { color: var(--accent-color); opacity: 0.5; }
    textarea:focus {
      border-color: var(--accent-color);
      box-shadow: var(--shadow-medium), 0 0 0 3px rgba(139, 115, 85, 0.1);
    }

    .start-btn {
      align-self: center;
      margin-top: 24px;
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      box-shadow: var(--shadow-medium), 0 4px 20px rgba(139, 115, 85, 0.3);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .start-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: var(--shadow-strong), 0 8px 30px rgba(139, 115, 85, 0.4);
    }
    .start-btn:active { transform: translateY(-1px) scale(1.02); }

    /* === READER SCREEN === */
    #reader-screen {
      height: 100vh;
      width: 100vw;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--bg-color);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: var(--transition);
    }
    #reader-screen[hidden] { display: none !important; }

    .floating-controls {
      position: fixed;
      bottom: 12px;
      left: 12px;
      display: flex;
      flex-direction: row;
      gap: 2px;
      z-index: 1000;
      padding: 6px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: opacity 0.4s ease;
      opacity: 1;
    }

    .floating-controls.hidden { opacity: var(--hidden-opacity, 0.8); }
    .floating-controls.hidden:hover { opacity: 1; }

    .floating-controls.dark-mode-controls {
      background: rgba(0, 0, 0, 0.65);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .float-btn {
      width: 38px;
      height: 38px;
      background: transparent;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--float-btn-color);
      position: relative;
    }
    .float-btn:hover {
      background: rgba(0, 0, 0, 0.08);
      color: var(--accent-color);
      transform: scale(1.08);
    }
    .float-btn:active { transform: scale(0.95); }
    .float-btn.active { background: var(--accent-color); color: white; }
    .float-btn.active:hover { background: var(--accent-hover); color: white; }

    .float-divider {
      width: 1px;
      height: 26px;
      background: rgba(128, 128, 128, 0.15);
      align-self: center;
      margin: 0 4px;
      border-radius: 1px;
    }

    .exit-fullscreen-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      display: none;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.6);
      z-index: 1001;
      transition: var(--transition);
      opacity: 0.35;
    }
    .exit-fullscreen-btn:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.35);
      transform: scale(1.05);
      color: white;
    }
    .exit-fullscreen-btn.visible { display: flex; }

    #book-viewport {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #book-content {
      color: var(--text-color);
      font-family: var(--font-family);
      font-size: var(--font-size);
      line-height: var(--line-height);
      text-align: justify;
      transition: var(--transition);
      box-sizing: border-box;
      -webkit-hyphens: auto;
      -ms-hyphens: auto;
      hyphens: auto;
      font-feature-settings: 'kern' 1, 'liga' 1, 'onum' 1;
    }

    #book-content p {
      margin-bottom: 1.2em;
      text-indent: 2em;
    }
    #book-content p:first-child { text-indent: 0; }
    #book-content p:first-child::first-letter {
      font-size: 3.2em;
      float: left;
      line-height: 0.8;
      padding-right: 8px;
      padding-top: 4px;
      font-weight: 600;
      color: var(--accent-color);
    }

    #book-content.mode-vertical {
      max-width: 680px;
      height: 100%;
      overflow-y: scroll !important;
      padding: 80px 48px 120px;
      margin: 0 auto;
      display: block;
    }

    #book-content.mode-paged {
      height: 82vh;
      overflow-x: auto;
      overflow-y: hidden;
      column-fill: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    #book-content.mode-paged::-webkit-scrollbar { display: none; }

    #book-content.mode-paged.paged-1 {
      width: 88vw;
      max-width: 640px;
      padding: 0 24px;
      column-width: 640px;
      column-gap: 120px;
    }

    #book-content.mode-paged.paged-2 {
      width: 92vw;
      max-width: 1300px;
      padding: 0 40px;
      column-count: 2 !important;
      column-width: auto !important;
      column-gap: 80px;
      column-rule: 1px solid var(--border-color);
    }

    #book-content.mode-paged p { scroll-snap-align: start; }

    .nav-btn {
      position: fixed;
      top: 0;
      bottom: 0;
      height: 100%;
      background: transparent;
      color: var(--text-color);
      border: none;
      width: 60px;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      transition: var(--transition);
      display: none;
      border-radius: 0;
      opacity: 0.2;
      transform: none;
    }
    .nav-btn:hover { opacity: 0.6; background: rgba(139, 115, 85, 0.05); }
    .nav-btn.visible { display: flex; align-items: center; justify-content: center; }
    #prev-page { left: 0; }
    #next-page { right: 0; }

    /* === SETTINGS PANEL === */
    #reader-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 -10px 60px rgba(0,0,0,0.08);
      padding: 18px 24px 22px;
      transform: translateY(110%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      border-top: 1px solid var(--glass-border);
    }
    #reader-controls.visible { transform: translateY(0); }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }
    .panel-close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: var(--transition);
      box-shadow: 0 2px 10px rgba(244, 63, 94, 0.3);
    }
    .panel-close-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4);
    }

    .settings-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 14px 28px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-start;
    }

    .control-group {
      flex: 1;
      min-width: 180px;
    }
    .control-group.themes-group { min-width: 320px; }
    .control-group.fonts-group { min-width: 320px; }
    .control-group.custom-colors-group { min-width: 280px; }

    .control-group label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--accent-color);
      margin-bottom: 8px;
      opacity: 0.65;
    }

    .option-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .option-btn {
      flex: 1;
      min-width: 55px;
      padding: 9px 10px;
      border: 1px solid var(--border-color);
      background: var(--surface-color);
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--ui-font);
      font-size: 11px;
      font-weight: 500;
      color: var(--text-color);
      transition: var(--transition);
      text-align: center;
      white-space: nowrap;
    }
    .option-btn:hover { border-color: var(--accent-color); background: rgba(139, 115, 85, 0.05); }
    .option-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    .theme-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .theme-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      position: relative;
      flex-shrink: 0;
    }
    .theme-btn:hover { transform: scale(1.15); }
    .theme-btn.selected {
      border-color: var(--accent-color);
      transform: scale(1.15);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .theme-btn::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }
    .theme-btn.dark-theme::after { border-color: rgba(255,255,255,0.1); }

    /* Custom Color Pickers */
    .color-picker-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    .color-picker-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .color-picker-item span {
      font-size: 11px;
      color: var(--text-color);
      opacity: 0.7;
    }
    .color-picker-input {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .color-picker-input::-webkit-color-swatch-wrapper { padding: 0; }
    .color-picker-input::-webkit-color-swatch { border: none; border-radius: 50%; }

    .bg-image-btn {
      padding: 8px 14px;
      border: 1px dashed var(--border-color);
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--ui-font);
      font-size: 11px;
      color: var(--accent-color);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .bg-image-btn:hover { border-color: var(--accent-color); background: rgba(139, 115, 85, 0.05); }
    .bg-image-btn.has-image { background: var(--accent-color); color: white; border-style: solid; }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-container span {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-color);
      min-width: 38px;
    }
    input[type="range"] {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--border-color);
      border-radius: 100px;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: var(--transition);
    }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }

    .status-bar {
      position: fixed;
      bottom: 12px;
      right: 24px;
      font-size: 11px;
      font-weight: 500;
      opacity: 0.4;
      pointer-events: none;
      font-family: var(--ui-font);
      color: var(--text-color);
      letter-spacing: 0.5px;
    }

    #night-filter {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 160, 50, 0.18);
      mix-blend-mode: multiply;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.6s ease;
      display: none;
    }
    #night-filter.active { display: block; opacity: 1; }

    .matrix-glow { text-shadow: 0 0 10px currentColor; }

    #bg-image-input { display: none; }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .top-bar { padding: 8px 16px; }
      .library-content { padding: 0 16px 16px; }
      .nav-btn { width: 44px; font-size: 18px; }
      .shelf-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .book-item { height: 160px; }
      .new-book-btn { height: 160px; }
      textarea { padding: 20px; }
      .start-btn { width: 64px; height: 64px; font-size: 24px; }
      
      .floating-controls { bottom: 10px; left: 10px; padding: 5px; border-radius: 14px; }
      .float-btn { width: 34px; height: 34px; font-size: 15px; border-radius: 8px; }
      .float-divider { width: 1px; height: 22px; margin: 0 3px; }
      
      .nav-btn { width: 44px; height: 90px; font-size: 18px; }
      #book-content.mode-vertical { padding: 60px 24px 100px; }
      #book-content.mode-paged.paged-2 { column-count: 1 !important; column-width: 100% !important; }
      
      #reader-controls { padding: 14px 16px 18px; border-top-left-radius: 20px; border-top-right-radius: 20px; }
      .settings-grid { gap: 10px 14px; }
      .control-group { min-width: 140px; }
      .control-group.themes-group, .control-group.fonts-group, .control-group.custom-colors-group { min-width: 100%; }
      .control-group label { font-size: 9px; margin-bottom: 6px; letter-spacing: 1px; }
      .option-btn { padding: 7px 8px; font-size: 10px; min-width: 45px; border-radius: 6px; }
      .theme-btn { width: 30px; height: 30px; }
      .slider-container { gap: 8px; }
      .slider-container span { font-size: 10px; min-width: 34px; }
      input[type="range"] { height: 3px; }
      input[type="range"]::-webkit-slider-thumb { width: 14px; height: 14px; }

      .exit-fullscreen-btn { top: 12px; right: 12px; width: 32px; height: 32px; font-size: 12px; border-radius: 8px; }
      .status-bar { bottom: 10px; right: 16px; font-size: 10px; }
    }

    @media (max-width: 480px) {
      .shelf-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .book-item { height: 140px; padding: 12px; }
      .book-title { font-size: 12px; }
      .settings-grid { gap: 8px 10px; }
      .control-group { min-width: 100%; }
      .option-btn { padding: 6px 6px; font-size: 9px; min-width: 40px; }
      .theme-btn { width: 28px; height: 28px; }
    }
  </style>
</head>
<body>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-container">
      <div class="modal-icon" id="modal-icon">üìñ</div>
      <div class="modal-title" id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
      <div class="modal-message" id="modal-message">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
      <input type="text" class="modal-input" id="modal-input" style="display: none;" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">
      <div class="modal-buttons" id="modal-buttons"></div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <div id="input-screen">
    <div class="top-bar">
      <div id="auth-section">
        <button class="auth-btn" id="login-btn">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
          –í–æ–π—Ç–∏
        </button>
        <div class="user-info" id="user-info" style="display:none;">
          <div class="user-avatar" id="u-avatar">U</div>
          <div class="logout-link" id="logout-btn">–í—ã–π—Ç–∏</div>
        </div>
      </div>
    </div>

    <div class="library-content">
      <div id="bookshelf-container">
        <div class="shelf-section">
          <div class="shelf-grid" id="shelf-grid"></div>
        </div>
      </div>

      <div class="input-area" id="input-area">
        <textarea id="source-text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è..."></textarea>
        <button class="start-btn" id="start-btn" type="button">üìñ</button>
      </div>
    </div>
  </div>

  <div id="reader-screen" hidden>
    <div class="floating-controls">
      <button class="float-btn" id="back-to-menu-btn" title="–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>
      <button class="float-btn" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </button>
      <button class="float-btn" id="night-mode-btn" title="–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <div class="float-divider"></div>
      <button class="float-btn" id="fullscreen-btn" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 3 21 3 21 9"></polyline>
          <polyline points="9 21 3 21 3 15"></polyline>
          <line x1="21" y1="3" x2="14" y2="10"></line>
          <line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
      </button>
      <button class="float-btn" id="save-cloud-btn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
        </svg>
      </button>
      <button class="float-btn" id="save-file-btn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ñ–∞–π–ª">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </button>
      <button class="float-btn" id="save-progress-btn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
      </button>
    </div>

    <button class="exit-fullscreen-btn" id="exit-fullscreen-btn" title="–í—ã–π—Ç–∏ (Esc)">‚úï</button>

    <button id="prev-page" class="nav-btn">‚Äπ</button>
    <div id="book-viewport">
      <div id="book-content" class="mode-vertical"></div>
    </div>
    <button id="next-page" class="nav-btn">‚Ä∫</button>

    <div class="status-bar" id="page-status"></div>
  </div>

  <div id="reader-controls">
    <div class="panel-header">
      <div class="panel-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á—Ç–µ–Ω–∏—è</div>
      <button class="panel-close-btn" id="close-menu">‚úï</button>
    </div>
    <div class="settings-grid">
      <div class="control-group">
        <label>–†–µ–∂–∏–º —á—Ç–µ–Ω–∏—è</label>
        <div class="option-group" id="layout-group">
          <button class="option-btn active" data-mode="vertical">–°–≤–∏—Ç–æ–∫</button>
          <button class="option-btn" data-mode="paged-1">–°—Ç—Ä–∞–Ω–∏—Ü–∞</button>
          <button class="option-btn" data-mode="paged-2">–†–∞–∑–≤–æ—Ä–æ—Ç</button>
        </div>
      </div>
      
      

      <div class="control-group themes-group">
        <label>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</label>
        <div class="theme-options" id="theme-group"></div>
      </div>

      <div class="control-group fonts-group">
        <label>–®—Ä–∏—Ñ—Ç</label>
        <div class="option-group" id="font-group">
          <button class="option-btn" data-font="'Literata', serif" style="font-family: 'Literata'">Literata</button>
          <button class="option-btn" data-font="'Crimson Pro', serif" style="font-family: 'Crimson Pro'">Crimson</button>
          <button class="option-btn" data-font="'Liberation Serif', 'Times New Roman', serif" style="font-family: 'Times New Roman'">Times</button>
          <button class="option-btn" data-font="'Source Serif 4', serif" style="font-family: 'Source Serif 4'">Source</button>
          <button class="option-btn" data-font="'Inter', sans-serif" style="font-family: 'Inter'">Sans</button>
          <button class="option-btn" data-font="'JetBrains Mono', monospace" style="font-family: 'JetBrains Mono'">Mono</button>
        </div>
      </div>

      <div class="control-group">
        <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</label>
        <div class="slider-container">
          <span id="fs-val">19px</span>
          <input type="range" id="font-size" min="14" max="28" value="19">
        </div>
      </div>
      
      <div class="control-group">
  <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–∞–Ω–µ–ª–∏</label>
  <div class="slider-container">
    <span id="opacity-val">80%</span>
    <input type="range" id="controls-opacity" min="10" max="100" value="80" step="10">
  </div>
</div>

      <div class="control-group custom-colors-group">
        <label>–°–≤–æ–∏ —Ü–≤–µ—Ç–∞</label>
        <div class="color-picker-row">
          <div class="color-picker-item">
            <span>–§–æ–Ω</span>
            <input type="color" class="color-picker-input" id="custom-bg-color" value="#faf8f5">
          </div>
          <div class="color-picker-item">
            <span>–¢–µ–∫—Å—Ç</span>
            <input type="color" class="color-picker-input" id="custom-text-color" value="#2c2825">
          </div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="bg-image-btn" id="bg-image-btn">
            <span>üñºÔ∏è</span> –§–æ–Ω-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          </button>
          <button class="bg-image-btn" id="clear-bg-btn" style="display: none;">
            <span>‚úï</span> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω
          </button>
        </div>
        <input type="file" id="bg-image-input" accept="image/*">
      </div>
    </div>
  </div>

  <div id="night-filter"></div>

  <script>
    // === MODAL & TOAST ===
    class Modal {
      constructor() {
        this.overlay = document.getElementById('modal-overlay');
        this.icon = document.getElementById('modal-icon');
        this.title = document.getElementById('modal-title');
        this.message = document.getElementById('modal-message');
        this.input = document.getElementById('modal-input');
        this.buttons = document.getElementById('modal-buttons');
        this.resolvePromise = null;
      }

      show(options) {
        return new Promise((resolve) => {
          this.resolvePromise = resolve;
          const iconMap = { info: 'üí°', success: '‚úì', warning: '‚ö†Ô∏è', error: '‚úï', input: '‚úèÔ∏è', confirm: '‚ùì', book: 'üìñ', delete: 'üóëÔ∏è' };
          this.icon.textContent = iconMap[options.type] || 'üìñ';
          this.icon.className = 'modal-icon ' + (options.type || 'info');
          this.title.textContent = options.title || '';
          this.message.textContent = options.message || '';
          this.message.style.display = options.message ? 'block' : 'none';
          
          if (options.input) {
            this.input.style.display = 'block';
            this.input.value = options.inputValue || '';
            this.input.placeholder = options.inputPlaceholder || '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...';
            setTimeout(() => this.input.focus(), 100);
          } else {
            this.input.style.display = 'none';
          }
          
          this.buttons.innerHTML = '';
          const buttonsConfig = options.buttons || [{ text: 'OK', primary: true }];
          buttonsConfig.forEach((btn, index) => {
            const button = document.createElement('button');
            button.className = 'modal-btn ' + (btn.danger ? 'danger' : btn.primary ? 'primary' : 'secondary');
            button.textContent = btn.text;
            button.onclick = () => this.close(btn.value !== undefined ? btn.value : index === 0);
            this.buttons.appendChild(button);
          });
          
          if (options.input) {
            this.input.onkeydown = (e) => {
              if (e.key === 'Enter') this.close(this.input.value);
              else if (e.key === 'Escape') this.close(null);
            };
          }
          
          this.overlay.classList.add('visible');
          document.body.style.overflow = 'hidden';
        });
      }

      close(result) {
        this.overlay.classList.remove('visible');
        document.body.style.overflow = '';
        if (this.resolvePromise) {
          const value = this.input.style.display !== 'none' ? (result === true ? this.input.value : result) : result;
          this.resolvePromise(value);
          this.resolvePromise = null;
        }
      }

      alert(title, message, type = 'info') {
        return this.show({ type, title, message, buttons: [{ text: 'OK', primary: true }] });
      }

      confirm(title, message, isDanger = false) {
        return this.show({
          type: isDanger ? 'delete' : 'confirm',
          title, message,
          buttons: [
            { text: '–û—Ç–º–µ–Ω–∞', value: false },
            { text: isDanger ? '–£–¥–∞–ª–∏—Ç—å' : '–î–∞', primary: !isDanger, danger: isDanger, value: true }
          ]
        });
      }

      prompt(title, message, defaultValue = '') {
        return this.show({
          type: 'input', title, message,
          input: true, inputValue: defaultValue,
          buttons: [{ text: '–û—Ç–º–µ–Ω–∞', value: null }, { text: 'OK', primary: true, value: true }]
        });
      }
    }

    class Toast {
      constructor() { this.container = document.getElementById('toast-container'); }

      show(options) {
        const toast = document.createElement('div');
        toast.className = 'toast ' + (options.type || 'info');
        const iconMap = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
        toast.innerHTML = `
          <div class="toast-icon">${iconMap[options.type] || '‚Ñπ'}</div>
          <div class="toast-content">
            <div class="toast-title">${options.title || ''}</div>
            ${options.message ? `<div class="toast-message">${options.message}</div>` : ''}
          </div>
          <button class="toast-close">‚úï</button>
        `;
        toast.querySelector('.toast-close').onclick = () => this.hide(toast);
        this.container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('visible'));
        setTimeout(() => this.hide(toast), options.duration || 4000);
        return toast;
      }

      hide(toast) {
        toast.classList.remove('visible');
        toast.classList.add('hiding');
        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 400);
      }

      success(title, message) { return this.show({ type: 'success', title, message }); }
      error(title, message) { return this.show({ type: 'error', title, message }); }
      warning(title, message) { return this.show({ type: 'warning', title, message }); }
      info(title, message) { return this.show({ type: 'info', title, message }); }
    }

    const modal = new Modal();
    const toast = new Toast();

    // === MAIN APP ===
    const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentBookId = null;
    let currentTheme = 'cream';
    let customBgImage = null;

    // –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã
    const themes = {
      cream:   { bg: '#faf8f5', text: '#2c2825', accent: '#8b7355', isDark: false },
      white:   { bg: '#ffffff', text: '#1a1a1a', accent: '#3b82f6', isDark: false },
      mint:    { bg: '#f0fdf4', text: '#14532d', accent: '#22c55e', isDark: false },
      lavender:{ bg: '#faf5ff', text: '#581c87', accent: '#a855f7', isDark: false },
      peach:   { bg: '#fff7ed', text: '#7c2d12', accent: '#f97316', isDark: false },
      sky:     { bg: '#f0f9ff', text: '#0c4a6e', accent: '#0ea5e9', isDark: false },
      rose:    { bg: '#fff1f2', text: '#881337', accent: '#f43f5e', isDark: false },
      sunset:  { bg: '#1f1f1f', text: '#fbbf24', accent: '#f59e0b', isDark: true },
      ocean:   { bg: '#0f172a', text: '#7dd3fc', accent: '#38bdf8', isDark: true },
      forest:  { bg: '#14532d', text: '#bbf7d0', accent: '#4ade80', isDark: true },
      purple:  { bg: '#2e1065', text: '#e9d5ff', accent: '#c084fc', isDark: true },
      matrix:  { bg: '#0a0a0a', text: '#00ff41', accent: '#00ff41', isDark: true, glow: true }
    };

    // –¶–≤–µ—Ç–∞ –∫–Ω–∏–≥
    const bookColors = [
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
      'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
      'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)',
      'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
      'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
      'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
      'linear-gradient(135deg, #5433ff 0%, #20bdff 50%, #a5fecb 100%)',
      'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
      'linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%)',
      'linear-gradient(135deg, #8360c3 0%, #2ebf91 100%)',
      'linear-gradient(135deg, #614385 0%, #516395 100%)'
    ];

    const dom = {
      inputScreen: document.getElementById('input-screen'),
      readerScreen: document.getElementById('reader-screen'),
      sourceText: document.getElementById('source-text'),
      content: document.getElementById('book-content'),
      controls: document.getElementById('reader-controls'),
      prevBtn: document.getElementById('prev-page'),
      nextBtn: document.getElementById('next-page'),
      status: document.getElementById('page-status'),
      shelfContainer: document.getElementById('bookshelf-container'),
      shelfGrid: document.getElementById('shelf-grid'),
      inputArea: document.getElementById('input-area'),
      loginBtn: document.getElementById('login-btn'),
      userInfo: document.getElementById('user-info'),
      userAvatar: document.getElementById('u-avatar'),
      logoutBtn: document.getElementById('logout-btn'),
      exitFullscreenBtn: document.getElementById('exit-fullscreen-btn')
    };

    let state = { layout: 'vertical', fontSize: 19 };

function loadSettings() {
  const saved = localStorage.getItem('readerSettings');
  if (saved) {
    try {
      const settings = JSON.parse(saved);
      state.layout = settings.layout || 'vertical';
      state.fontSize = settings.fontSize || 19;
      state.controlsOpacity = settings.controlsOpacity || 80;
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Ç–µ–º–∞
      currentTheme = (settings.theme && themes[settings.theme]) ? settings.theme : 'cream';
      customBgImage = settings.bgImage || null;
      return settings;
    } catch (e) { return null; }
  }
  return null;
}

function saveSettings() {
  const settings = {
    layout: state.layout,
    fontSize: state.fontSize,
    controlsOpacity: state.controlsOpacity,
    theme: currentTheme,
    font: document.documentElement.style.getPropertyValue('--font-family') || "'Literata', serif",
    nightMode: document.getElementById('night-filter').classList.contains('active'),
    customBg: dom.readerScreen.style.backgroundColor || document.getElementById('custom-bg-color').value,
    customText: dom.content.style.color || document.getElementById('custom-text-color').value,
    bgImage: customBgImage
  };
  localStorage.setItem('readerSettings', JSON.stringify(settings));
}

    async function init() {
      const savedSettings = loadSettings();

      // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–µ–º
      const themeContainer = document.getElementById('theme-group');
      Object.keys(themes).forEach(key => {
        const btn = document.createElement('div');
        btn.className = 'theme-btn';
        if (themes[key].isDark) btn.classList.add('dark-theme');
        btn.style.background = themes[key].bg;
        if (key === 'matrix') btn.style.boxShadow = 'inset 0 0 10px #00ff41';
        btn.dataset.theme = key;
        btn.title = key.charAt(0).toUpperCase() + key.slice(1);
        btn.onclick = () => { setTheme(key); saveSettings(); };
        themeContainer.appendChild(btn);
      });

      setTheme(currentTheme);

      if (savedSettings) {
        document.getElementById('font-size').value = state.fontSize;
        document.getElementById('fs-val').textContent = state.fontSize + 'px';
        document.documentElement.style.setProperty('--font-size', state.fontSize + 'px');

        if (savedSettings.font) {
          document.documentElement.style.setProperty('--font-family', savedSettings.font);
          document.querySelectorAll('#font-group .option-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.font === savedSettings.font);
          });
        }

        document.querySelectorAll('#layout-group .option-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === state.layout);
        });

        if (savedSettings.nightMode) {
          document.getElementById('night-filter').classList.add('active');
          document.getElementById('night-mode-btn').classList.add('active');
        }
        
        if (savedSettings && savedSettings.controlsOpacity !== undefined) {
  state.controlsOpacity = savedSettings.controlsOpacity;
  document.getElementById('controls-opacity').value = state.controlsOpacity;
  document.getElementById('opacity-val').textContent = state.controlsOpacity + '%';
  document.documentElement.style.setProperty('--controls-hidden-opacity', state.controlsOpacity / 100);
}

    if (savedSettings.customBg) {
    document.getElementById('custom-bg-color').value = savedSettings.customBg;
    dom.readerScreen.style.backgroundColor = savedSettings.customBg;
  }
  if (savedSettings.customText) {
    document.getElementById('custom-text-color').value = savedSettings.customText;
    dom.content.style.color = savedSettings.customText;
  }

  if (customBgImage) {
    applyBgImage(customBgImage);
  }
}
      // Event Listeners
      document.getElementById('back-to-menu-btn').onclick = () => {
        dom.readerScreen.hidden = true; 
        dom.inputScreen.hidden = false;
        dom.controls.classList.remove('visible'); 
        document.title = '–ö–Ω–∏–≥–∏';
        if (document.fullscreenElement) exitFullscreen();
      };
      
      document.getElementById('controls-opacity').addEventListener('input', (e) => {
  state.controlsOpacity = e.target.value;
  document.getElementById('opacity-val').textContent = state.controlsOpacity + '%';
  document.documentElement.style.setProperty('--controls-hidden-opacity', state.controlsOpacity / 100);
  document.querySelector('.floating-controls').style.setProperty('--hidden-opacity', state.controlsOpacity / 100);
  saveSettings();
});
  
      document.getElementById('start-btn').onclick = () => startReading(dom.sourceText.value.trim());
      document.getElementById('settings-btn').onclick = () => dom.controls.classList.toggle('visible');
      document.getElementById('close-menu').onclick = () => dom.controls.classList.remove('visible');

      document.getElementById('save-cloud-btn').onclick = saveBookToCloud;
      document.getElementById('save-file-btn').onclick = saveBookToFile;
      document.getElementById('save-progress-btn').onclick = saveProgress;

      const nightBtn = document.getElementById('night-mode-btn');
      const nightFilter = document.getElementById('night-filter');
      nightBtn.onclick = () => {
        nightFilter.classList.toggle('active');
        nightBtn.classList.toggle('active');
        saveSettings();
      };

      document.getElementById('fullscreen-btn').onclick = toggleFullscreen;
      dom.exitFullscreenBtn.onclick = exitFullscreen;
      document.addEventListener('fullscreenchange', updateFullscreenUI);
      document.addEventListener('webkitfullscreenchange', updateFullscreenUI);

      document.getElementById('font-group').addEventListener('click', (e) => {
        if (e.target.dataset.font) {
          document.documentElement.style.setProperty('--font-family', e.target.dataset.font);
          highlightBtn(document.getElementById('font-group'), e.target);
          saveSettings();
          setTimeout(updatePaginationInfo, 100);
        }
      });

      document.getElementById('font-size').addEventListener('input', (e) => {
        state.fontSize = e.target.value;
        document.documentElement.style.setProperty('--font-size', state.fontSize + 'px');
        document.getElementById('fs-val').textContent = state.fontSize + 'px';
        saveSettings();
        setTimeout(updatePaginationInfo, 100);
      });

      document.getElementById('layout-group').addEventListener('click', (e) => {
        if (e.target.dataset.mode) {
          setLayout(e.target.dataset.mode);
          highlightBtn(document.getElementById('layout-group'), e.target);
          saveSettings();
        }
      });

      // Custom colors
     document.getElementById('custom-bg-color').addEventListener('input', (e) => {
  dom.readerScreen.style.backgroundColor = e.target.value;
  saveSettings();
});

document.getElementById('custom-text-color').addEventListener('input', (e) => {
  dom.content.style.color = e.target.value;
  saveSettings();
});

      

      // Background image
      document.getElementById('bg-image-btn').onclick = () => document.getElementById('bg-image-input').click();
      document.getElementById('bg-image-input').addEventListener('change', handleBgImageUpload);
      document.getElementById('clear-bg-btn').onclick = clearBgImage;

      dom.prevBtn.onclick = () => turnPage(-1);
      dom.nextBtn.onclick = () => turnPage(1);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          dom.controls.classList.remove('visible');
          if (document.fullscreenElement) exitFullscreen();
        }
        if (dom.readerScreen.hidden) return;
        if (state.layout !== 'vertical') {
          if (e.key === 'ArrowRight' || e.key === ' ') turnPage(1);
          if (e.key === 'ArrowLeft') turnPage(-1);
        }
      });

      let isTurning = false;
      dom.content.addEventListener('wheel', (e) => {
        if (state.layout === 'vertical') return;
        e.preventDefault();
        if (isTurning) return;
        if (Math.abs(e.deltaY) < 10) return;
        if (e.deltaY > 0) turnPage(1); else turnPage(-1);
        isTurning = true;
        setTimeout(() => { isTurning = false; }, 600);
      }, { passive: false });

      dom.content.addEventListener('scroll', updatePaginationInfo);
      window.addEventListener('resize', () => { if (state.layout !== 'vertical') updatePaginationInfo(); });

      dom.loginBtn.onclick = async () => {
        await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } });
      };

      dom.logoutBtn.onclick = async () => {
        const confirmed = await modal.confirm('–í—ã—Ö–æ–¥', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?');
        if (!confirmed) return;
        try { await sb.auth.signOut({ scope: 'global' }); } catch (e) {}
        Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
        window.location.reload();
      };

      const { data: { session } } = await sb.auth.getSession();
      if (session) handleAuthSuccess(session.user);
      sb.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) handleAuthSuccess(session.user);
      });

      setTimeout(() => document.querySelector('.floating-controls').classList.add('hidden'), 10000);
    }

    function handleBgImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        customBgImage = event.target.result;
        applyBgImage(customBgImage);
        saveSettings();
      };
      reader.readAsDataURL(file);
    }

    function applyBgImage(imageData) {
      dom.readerScreen.style.backgroundImage = `url(${imageData})`;
      document.getElementById('bg-image-btn').classList.add('has-image');
      document.getElementById('clear-bg-btn').style.display = 'flex';
    }

    function clearBgImage() {
      customBgImage = null;
      dom.readerScreen.style.backgroundImage = 'none';
      document.getElementById('bg-image-btn').classList.remove('has-image');
      document.getElementById('clear-bg-btn').style.display = 'none';
      saveSettings();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        const elem = document.documentElement;
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      } else exitFullscreen();
    }

    function exitFullscreen() {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }

    function updateFullscreenUI() {
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      if (document.fullscreenElement) {
        fullscreenBtn.classList.add('active');
        dom.exitFullscreenBtn.classList.add('visible');
        fullscreenBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>`;
      } else {
        fullscreenBtn.classList.remove('active');
        dom.exitFullscreenBtn.classList.remove('visible');
        fullscreenBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>`;
      }
    }

    function handleAuthSuccess(user) {
      currentUser = user;
      dom.loginBtn.style.display = 'none';
      dom.userInfo.style.display = 'flex';
      dom.userAvatar.innerText = user.email[0].toUpperCase();
      dom.shelfContainer.classList.add('visible');
      dom.inputArea.style.flex = '0 0 auto';
      dom.sourceText.style.minHeight = '150px';
      dom.sourceText.style.flex = 'none';
      loadBookshelf();
    }

    async function loadBookshelf() {
      if (!currentUser) return;
      dom.shelfGrid.innerHTML = '';

      let { data: folders } = await sb.from('files')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('type', 'folder')
        .eq('name', '–ö–Ω–∏–≥–∏')
        .eq('parent_id', 'desktop');

      let booksFolderId = null;
      if (folders && folders.length > 0) booksFolderId = folders[0].id;
      else { renderShelf([]); return; }

      let { data: files } = await sb.from('files')
        .select('*')
        .eq('parent_id', booksFolderId)
        .eq('type', 'html')
        .order('created_at', { ascending: false });

      renderShelf(files || []);
    }

    function renderShelf(files) {
      dom.shelfGrid.innerHTML = '';

      const addBtn = document.createElement('div');
      addBtn.className = 'new-book-btn';
      addBtn.innerHTML = '<div class="icon">+</div><span>–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞</span>';
      addBtn.onclick = () => { dom.sourceText.value = ''; currentBookId = null; dom.sourceText.focus(); };
      dom.shelfGrid.appendChild(addBtn);

      if (files.length === 0) return;

      files.forEach((file, index) => {
        const book = document.createElement('div');
        book.className = 'book-item';
        book.style.background = bookColors[Math.floor(Math.random() * bookColors.length)];
        
        const name = file.name.replace('.html', '');
        const progress = file.reading_progress?.scrollPercent || 0;
        
        book.innerHTML = `
          <button class="book-delete-btn" data-id="${file.id}">‚úï</button>
          <div class="book-title">${name}</div>
          ${progress > 0 ? `<div class="book-progress"><div class="book-progress-bar" style="width: ${progress}%"></div></div>` : ''}
        `;
        
        book.querySelector('.book-delete-btn').onclick = (e) => { e.stopPropagation(); deleteBook(file.id, name); };
        book.onclick = () => loadBookFromCloud(file);
        dom.shelfGrid.appendChild(book);
      });
    }

    async function deleteBook(bookId, bookName) {
      const confirmed = await modal.confirm('–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?', `"${bookName}" –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ`, true);
      if (!confirmed) return;

      const { error } = await sb.from('files').delete().eq('id', bookId);
      if (error) {
        toast.error('–û—à–∏–±–∫–∞', error.message);
      } else {
        toast.success('–£–¥–∞–ª–µ–Ω–æ', `"${bookName}" —É–¥–∞–ª–µ–Ω–∞`);
        loadBookshelf();
      }
    }

    function loadBookFromCloud(file) {
      if (!file.content) { modal.alert('–û—à–∏–±–∫–∞', '–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω', 'error'); return; }
      currentBookId = file.id;
      dom.sourceText.value = '';
      dom.content.innerHTML = file.content;
      dom.inputScreen.hidden = true;
      dom.readerScreen.hidden = false;
      document.title = file.name.replace('.html', '');
      setLayout(state.layout);

      if (file.reading_progress) {
        const progress = file.reading_progress;
        setTimeout(() => {
          if (progress.scrollPercent > 0) {
            if (state.layout === 'vertical') {
              const scrollHeight = dom.content.scrollHeight - dom.content.clientHeight;
              dom.content.scrollTop = (progress.scrollPercent / 100) * scrollHeight;
            } else {
              const scrollWidth = dom.content.scrollWidth - dom.content.clientWidth;
              dom.content.scrollLeft = (progress.scrollPercent / 100) * scrollWidth;
            }
          }
        }, 200);
      }
      toast.success('–ö–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', file.name.replace('.html', ''));
    }

async function saveBookToCloud() {
  if (!currentUser) { await modal.alert('–ò–∑–≤–∏–Ω–∏—Ç–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç Google –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'warning'); return; }
  const title = await modal.prompt('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏', '–ú–æ—è –∫–Ω–∏–≥–∞');
  if (!title) return;

  const contentHtml = dom.content.innerHTML;
  const fileName = title.endsWith('.html') ? title : title + '.html';
  const fileSize = new Blob([contentHtml]).size;

  let { data: folders } = await sb.from('files').select('id').eq('user_id', currentUser.id).eq('type', 'folder').eq('name', '–ö–Ω–∏–≥–∏').eq('parent_id', 'desktop');
  let folderId;
  if (folders && folders.length > 0) folderId = folders[0].id;
  else {
    const { data: newFolder } = await sb.from('files').insert({ name: '–ö–Ω–∏–≥–∏', type: 'folder', parent_id: 'desktop', user_id: currentUser.id }).select();
    folderId = newFolder[0].id;
  }

  const { data, error } = await sb.from('files').insert({ name: fileName, type: 'html', parent_id: folderId, content: contentHtml, size: fileSize, user_id: currentUser.id }).select();
  if (error) toast.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', error.message);
  else { 
    toast.success('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', `"${title}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É`); 
    currentBookId = data[0].id; 
    document.title = title;
    loadBookshelf(); 
  }
}

    async function saveBookToFile() {
      const title = await modal.prompt('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ñ–∞–π–ª', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞', 'my-book');
      if (!title) return;
      dom.sourceText.value = dom.sourceText.value || '';
      const htmlContent = document.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = title.endsWith('.html') ? title : title + '.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast.success('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω', `${title}.html`);
    }
    
    async function saveProgress() {
      if (!currentUser || !currentBookId) { await modal.alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', '–í–æ–π–¥–∏—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–Ω–∏–≥—É –∏–∑ –æ–±–ª–∞–∫–∞', 'warning'); return; }
      let scrollPercent = 0;
      if (state.layout === 'vertical') {
        const scrollTop = dom.content.scrollTop;
        const scrollHeight = dom.content.scrollHeight - dom.content.clientHeight;
        scrollPercent = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
      } else {
        const scrollLeft = dom.content.scrollLeft;
        const scrollWidth = dom.content.scrollWidth - dom.content.clientWidth;
        scrollPercent = scrollWidth > 0 ? (scrollLeft / scrollWidth) * 100 : 0;
      }

      const progress = { scrollPercent: Math.round(scrollPercent * 10) / 10, layout: state.layout, lastRead: new Date().toISOString() };
      const { error } = await sb.from('files').update({ reading_progress: progress }).eq('id', currentBookId);
      if (error) toast.error('–û—à–∏–±–∫–∞', error.message);
      else {
        toast.success('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω', `${Math.round(scrollPercent)}% –ø—Ä–æ—á–∏—Ç–∞–Ω–æ`);
        const btn = document.getElementById('save-progress-btn');
        btn.classList.add('active');
        setTimeout(() => btn.classList.remove('active'), 1000);
      }
    }

    async function startReading(text) {
      if (!text && !dom.content.innerHTML) { await modal.alert('–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç', '–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è', 'warning'); return; }
      if (text) {
        const paras = text.split(/\n\s*\n/).filter(p => p.trim());
        dom.content.innerHTML = paras.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
      }
      dom.inputScreen.hidden = true;
      dom.readerScreen.hidden = false;
      setLayout(state.layout);
      document.title = '–ö–Ω–∏–≥–∏';
    }

    function setLayout(mode) {
      state.layout = mode;
      dom.content.className = '';
      if (mode === 'vertical') {
        dom.content.classList.add('mode-vertical');
        dom.prevBtn.classList.remove('visible');
        dom.nextBtn.classList.remove('visible');
        dom.status.textContent = '';
      } else {
        dom.content.classList.add('mode-paged');
        dom.content.classList.add(mode);
        dom.prevBtn.classList.add('visible');
        dom.nextBtn.classList.add('visible');
        dom.content.scrollLeft = 0;
        dom.content.scrollTop = 0;
        setTimeout(updatePaginationInfo, 100);
      }
      if (themes[currentTheme]?.glow) dom.content.classList.add('matrix-glow');
    }

    function turnPage(direction) {
      if (state.layout === 'vertical') return;
      const container = dom.content;
      const pageWidth = container.clientWidth;
      let scrollAmount = state.layout === 'paged-1' ? (pageWidth + 120) * direction : pageWidth * direction;
      container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }

    function updatePaginationInfo() {
      if (state.layout === 'vertical') return;
      const container = dom.content;
      const currentScreen = Math.round(container.scrollLeft / container.clientWidth) + 1;
      const totalScreens = Math.round(container.scrollWidth / container.clientWidth);
      dom.status.textContent = `${currentScreen} / ${totalScreens}`;
    }

function setTheme(name) {
  if (!themes[name]) name = 'cream';
  currentTheme = name;
  const t = themes[name];
  const root = document.documentElement;
  const floatingControls = document.querySelector('.floating-controls');
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ —á–∏—Ç–∞–ª–∫–µ –Ω–∞–ø—Ä—è–º—É—é
  dom.readerScreen.style.backgroundColor = t.bg;
  dom.content.style.color = t.text;
  
  // CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  root.style.setProperty('--accent-color', t.accent);
  root.style.setProperty('--text-color', t.text);
  
  document.getElementById('custom-bg-color').value = t.bg;
  document.getElementById('custom-text-color').value = t.text;

  if (t.isDark) {
    root.style.setProperty('--glass-bg', `${t.bg}ee`);
    root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.1)');
    root.style.setProperty('--border-color', 'rgba(255, 255, 255, 0.1)');
    root.style.setProperty('--float-btn-color', t.text);
    root.style.setProperty('--surface-color', t.bg);
    floatingControls?.classList.add('dark-mode-controls');
  } else {
    root.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.85)');
    root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.5)');
    root.style.setProperty('--surface-color', '#ffffff');
    root.style.setProperty('--border-color', `${t.accent}25`);
    root.style.setProperty('--float-btn-color', '#5a5a5a');
    floatingControls?.classList.remove('dark-mode-controls');
  }

  if (t.glow) dom.content.classList.add('matrix-glow');
  else dom.content.classList.remove('matrix-glow');

  document.querySelectorAll('.theme-btn').forEach(b => {
    b.classList.toggle('selected', b.dataset.theme === name);
  });
}

    function highlightBtn(group, target) {
      group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
      target.classList.add('active');
    }

    init();
  </script>
</body>
</html>

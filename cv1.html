<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Конвертер Координат</title>
    <link rel="icon" href="img/coor.png" type="image/png">
   <style>
       /* --- Общие стили --- */
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }
       
       html, body {
           height: 100%;
           overflow: hidden;
       }
       
       body { 
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
           line-height: 1.6; 
           color: #2c3e50;
           background-color: #f0f2f5;
       }
       
       .container { 
           width: 100vw;
           height: 100vh;
           padding: 25px;
           display: flex;
           flex-direction: column;
           position: relative;
           transition: background 0.8s ease-in-out;
       }
       
       .container::before {
           content: '';
           position: absolute;
           top: 0; left: 0; right: 0; bottom: 0;
           background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="%23000" opacity="0.03"/><circle cx="80" cy="40" r="1" fill="%23000" opacity="0.03"/><circle cx="40" cy="80" r="1" fill="%23000" opacity="0.03"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
           pointer-events: none;
           z-index: 0;
       }

       /* --- Стили макета (Grid + Flexbox) --- */
       .main-layout {
           display: grid;
           grid-template-columns: 1fr 1fr 120px;
           gap: 25px;
           flex: 1;
           min-height: 0;
           z-index: 1;
       }
       
       .column, .actions-panel {
           background: rgba(255, 255, 255, 0.6);
           border-radius: 20px;
           box-shadow: 0 10px 30px rgba(0,0,0,0.1);
           border: 1px solid rgba(255,255,255,0.3);
           backdrop-filter: blur(15px);
           position: relative;
           overflow: hidden;
       }

       .column {
           display: flex;
           flex-direction: column;
           min-height: 0;
           padding: 25px;
       }
       
       /* --- Стили элементов форм --- */
       .textarea-container {
           position: relative;
           flex: 1;
           display: flex;
           flex-direction: column;
           min-height: 0;
       }
       
       .swap-icon {
           position: absolute;
           top: 12px;
           right: 12px;
           width: 32px;
           height: 32px;
           background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%);
           border: none;
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           cursor: pointer;
           font-size: 14px;
           color: white;
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           z-index: 10;
           box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
       }
       
       .swap-icon:hover {
           transform: scale(1.1) rotate(180deg);
           box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
       }
       
       label { 
           display: block; 
           margin-bottom: 12px; 
           font-weight: 600;
           color: #34495e;
           font-size: 0.95rem;
           letter-spacing: 0.5px;
           text-align: center;
       }
       
       textarea, input[type="text"], select { 
           width: 100%; 
           padding: 16px 20px; 
           border: 1px solid rgba(52, 73, 94, 0.15); 
           border-radius: 15px; 
           font-size: 0.95rem;
           transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
           background: rgba(255, 255, 255, 0.8);
           box-shadow: 0 4px 15px rgba(0,0,0,0.05);
       }
       
       textarea:focus, input[type="text"]:focus, select:focus {
           outline: none;
           border-color: #4facfe;
           box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2), 0 8px 25px rgba(0,0,0,0.1);
           transform: translateY(-2px);
       }
       
       textarea { 
           flex: 1;
           resize: none;
           font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
           font-size: 0.9rem;
           line-height: 1.5;
           padding-top: 50px;
           overflow-y: auto;
           min-height: 0;
           text-align: center;
           background: #ffffff;
       }
       
       select {
           margin-bottom: 15px;
           cursor: pointer;
           appearance: none;
           background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%234facfe" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg>');
           background-repeat: no-repeat;
           background-position: right 15px center;
           background-size: 18px;
           padding-right: 45px;
           text-align: center;
           text-align-last: center;
       }
       select option {
            text-align: left;
       }

       /* --- Вертикальная панель действий --- */
       .actions-panel {
           padding: 25px 15px;
           display: flex;
           flex-direction: column;
           gap: 15px; /* Уменьшен отступ для 4-х кнопок */
           align-items: center;
       }
       
      .action-btn {
           width: 60px;
           height: 60px;
           padding: 15px;
           margin: 0;
           /* Фон будет задан через JS, убираем старое правило */
           border: 1px solid rgba(255, 255, 255, 0.2);
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
           cursor: pointer;
           box-shadow: 0 8px 25px rgba(0,0,0,0.15); /* Добавляем базовую тень */
       }
       
       .action-btn:hover {
           /* Убираем смену фона, чтобы сохранить градиент */
           border-color: rgba(255, 255, 255, 0.3);
           transform: translateY(-5px) scale(1.08);
           box-shadow: 0 15px 35px rgba(0,0,0,0.25); /* Усиливаем тень */
           filter: brightness(1.1); /* Делаем градиент чуть ярче */
       }
       
       .action-btn img {
           width: 30px;
           height: 30px;
           transition: all 0.4s ease;
           filter: brightness(0) invert(1) drop-shadow(0 2px 4px rgba(0,0,0,0.2));
       }
       
       .action-btn:hover img {
           transform: scale(1.2) rotate(5deg);
       }

       /* --- Прочее --- */
       .error { 
           color: #e74c3c !important; 
           border-color: #e74c3c !important;
           background: #fff5f5 !important;
           box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.15) !important;
       }
       
       .custom-input { display: none; margin-bottom: 15px; }
       
       textarea::-webkit-scrollbar { width: 8px; }
       textarea::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
       textarea::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); border-radius: 10px; }
       
       /* --- Адаптивность --- */
       @media (max-width: 1200px) {
           .main-layout { grid-template-columns: 1fr 1fr 120px; }
           .action-btn { width: 55px; height: 55px; }
           .action-btn img { width: 28px; height: 28px; }
       }
       @media (max-width: 768px) {
           .container { padding: 15px; }
           .main-layout { grid-template-columns: 1fr; gap: 20px; }
           .actions-panel { flex-direction: row; padding: 15px; justify-content: center; gap: 20px; }
           .column { min-height: 250px; padding: 20px; }
       }
   </style>
</head>
<body>

   <div class="container">
       <div class="main-layout">
           <div class="column">
               <label for="sourceText">Исходные координаты:</label>
               <div class="textarea-container">
                   <textarea id="sourceText" placeholder=""></textarea>
                   <div class="swap-icon" id="swapSourceBtn" title="Поменять колонки местами">↔</div>
               </div>
               <label for="sourceScSelect">Исходная система координат:</label>
               <select id="sourceScSelect"></select>
               <input type="text" id="sourceScInput" class="custom-input" placeholder="Введите код EPSG">
           </div>

           <div class="column">
               <label for="result-area">Результат:</label>
               <div class="textarea-container">
                   <textarea id="result-area" readonly></textarea>
                   <div class="swap-icon" id="swapResultBtn" title="Поменять колонки местами">↔</div>
               </div>
               <label for="destScSelect">Целевая система координат:</label>
               <select id="destScSelect"></select>
               <input type="text" id="destScInput" class="custom-input" placeholder="Введите код EPSG">
           </div>

           <!-- *** ИЗМЕНЕНИЕ: Добавлены новые кнопки и id для старых *** -->
           <div class="actions-panel">
               <button class="action-btn" id="convertBtn" title="Конвертировать координаты">
                   <img src="img/play.png" alt="Конвертировать">
               </button>
               <button class="action-btn" id="saveFileBtn" title="Копировать и открыть Схему">
                   <img src="img/xy.png" alt="Схема">
               </button>
                <button class="action-btn" id="saveXmlBtn" title="Копировать и открыть Схему XML">
                   <img src="img/sxml.png" alt="Схема XML">
               </button>
               <button class="action-btn" id="showOnMapBtn" title="Копировать и показать на Карте">
                   <img src="img/map.png" alt="Карта">
               </button>
                <button class="action-btn" id="openEditorBtn" title="Копировать и открыть Редактор">
                   <img src="img/ed.png" alt="Редактор">
               </button>
           </div>
       </div>
   </div>

   <script src="sk.js"></script>

     <script>
       document.addEventListener('DOMContentLoaded', function() {
           // --- Получение всех элементов ---
           const convertBtn = document.getElementById('convertBtn');
           const sourceTextArea = document.getElementById('sourceText');
           const resultArea = document.getElementById('result-area');
           const sourceScSelect = document.getElementById('sourceScSelect');
           const sourceScInput = document.getElementById('sourceScInput');
           const destScSelect = document.getElementById('destScSelect');
           const destScInput = document.getElementById('destScInput');
           const swapSourceBtn = document.getElementById('swapSourceBtn');
           const swapResultBtn = document.getElementById('swapResultBtn');
           const saveFileBtn = document.getElementById('saveFileBtn');
           const showOnMapBtn = document.getElementById('showOnMapBtn');
           const saveXmlBtn = document.getElementById('saveXmlBtn');
           const openEditorBtn = document.getElementById('openEditorBtn');

           // --- Градиенты и Дизайн ---
           const gradients = [
               'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)', 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
               'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)', 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
               'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)', 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)'
           ];
           const buttonGradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)','linear-gradient(135deg, #2af598 0%, #009efd 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)','linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)','linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
           ];

           function setRandomContainerGradient() {
               const container = document.querySelector('.container');
               container.style.background = gradients[Math.floor(Math.random() * gradients.length)];
           }
           function setRandomButtonGradients() {
                const actionButtons = document.querySelectorAll('.action-btn');
                actionButtons.forEach(button => {
                    button.style.background = buttonGradients[Math.floor(Math.random() * buttonGradients.length)];
                });
           }
           function setRandomSwapIconGradients() {
                const swapIcons = document.querySelectorAll('.swap-icon');
                swapIcons.forEach(icon => {
                    icon.style.background = buttonGradients[Math.floor(Math.random() * buttonGradients.length)];
                });
           }

           // --- Заполнение Select'ов ---
           function populateSelectWithOptions(selectElement, optionsArray) {
               selectElement.innerHTML = ''; 
               optionsArray.forEach(system => {
                   const option = document.createElement('option');
                   option.value = system.value;
                   option.textContent = system.text;
                   selectElement.appendChild(option);
               });
           }
           
           // --- Вспомогательные функции ---
           function toggleCustomInput(selectElement, inputElement) {
               inputElement.style.display = (selectElement.value === 'custom') ? 'block' : 'none';
           }

           function swapTextareaColumns(textarea) {
               const text = textarea.value;
               if (!text) return;
               const isReadonly = textarea.readOnly;
               if (isReadonly) textarea.readOnly = false;
               const lines = text.split('\n');
               const swappedLines = lines.map(line => {
                   const parts = line.trim().split(/\s+/);
                   if (parts.length === 2) return `${parts[1]}\t${parts[0]}`;
                   return line;
               });
               textarea.value = swappedLines.join('\n');
               if (isReadonly) textarea.readOnly = true;
           }

           function copyAndOpen(textarea, url) {
               const textToCopy = textarea.value;
               if (textToCopy.trim() === '') {
                   window.open(url, '_blank');
                   return;
               }
               navigator.clipboard.writeText(textToCopy)
                .then(() => console.log('Текст скопирован.'))
                .catch(err => console.error('Ошибка копирования: ', err))
                .finally(() => window.open(url, '_blank'));
           }
           
           function processPastedText(pastedText) {
                let lines = pastedText.trim().split('\n');
                if (lines.length > 0) {
                    const firstLine = lines[0].trim();
                    if (!firstLine.includes('\t')) {
                        const hasSingleComma = (firstLine.match(/,/g) || []).length === 1;
                        const hasSingleSemicolon = (firstLine.match(/;/g) || []).length === 1;
                        if (hasSingleComma || hasSingleSemicolon) {
                            const separator = hasSingleComma ? ',' : ';';
                            lines = lines.map(line => line.includes(separator) ? line.replace(separator, '\t') : line);
                        }
                    }
                }
                let processedText = lines.join('\n').replace(/,/g, '.');
                const firstLineProcessed = processedText.split('\n')[0].trim();
                const parts = firstLineProcessed.split(/\s+/);
                if (parts.length === 2) {
                    const hasLongDecimal = (coord) => (coord.includes('.') && coord.split('.')[1].length > 3);
                    if (hasLongDecimal(parts[0]) || hasLongDecimal(parts[1])) {
                        sourceScSelect.value = 'EPSG:3857';
                        // *** ИЗМЕНЕНИЕ: Сохраняем автоматически выбранное значение ***
                        localStorage.setItem('savedSourceSC', 'EPSG:3857');
                    }
                }
                sourceTextArea.value = processedText;
           }
           
           async function checkClipboardAndPasteOnLoad() {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text) return;
                    const lines = text.trim().split('\n');
                    if (lines.length < 2) return;
                    const isValid = lines.every(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine === '') return true;
                        if (/[a-zA-Zа-яА-Я]/.test(trimmedLine)) return false;
                        return (trimmedLine.match(/[\t,;]/g) || []).length === 1;
                    });
                    if (isValid) {
                        processPastedText(text);
                    }
                } catch (err) {
                    console.log('Не удалось прочитать буфер обмена:', err.name, err.message);
                }
           }

           // --- Назначение обработчиков событий ---
           sourceScSelect.addEventListener('change', () => {
               toggleCustomInput(sourceScSelect, sourceScInput);
               // *** ИЗМЕНЕНИЕ: Сохраняем выбор в localStorage ***
               localStorage.setItem('savedSourceSC', sourceScSelect.value);
           });
           destScSelect.addEventListener('change', () => {
               toggleCustomInput(destScSelect, destScInput);
               // *** ИЗМЕНЕНИЕ: Сохраняем выбор в localStorage ***
               localStorage.setItem('savedDestSC', destScSelect.value);
           });

           swapSourceBtn.addEventListener('click', () => swapTextareaColumns(sourceTextArea));
           swapResultBtn.addEventListener('click', () => swapTextareaColumns(resultArea));
           saveFileBtn.addEventListener('click', () => copyAndOpen(resultArea, 'схема.html'));
           showOnMapBtn.addEventListener('click', () => copyAndOpen(resultArea, 'map.html'));
           saveXmlBtn.addEventListener('click', () => copyAndOpen(resultArea, 'схема_xml.html'));
           openEditorBtn.addEventListener('click', () => copyAndOpen(resultArea, 'editor.html'));
           
           sourceTextArea.addEventListener('paste', function(event) {
               event.preventDefault();
               const pastedText = (event.clipboardData || window.clipboardData).getData('text');
               processPastedText(pastedText);
           });

           // --- Основная функция конвертации ---
           convertBtn.addEventListener('click', async () => {
               // ... (весь код этой функции остается без изменений) ...
               function getScValue(selectElement, inputElement) {
                   return selectElement.value === 'custom' 
                       ? selectElement.value.trim() 
                       : selectElement.value;
               }
               const sourceText = sourceTextArea.value.trim();
               const sourceSc = getScValue(sourceScSelect, sourceScInput);
               const destSc = getScValue(destScSelect, destScInput);
               if (!sourceText || !sourceSc || !destSc) {
                   resultArea.value = 'Ошибка: Все поля должны быть заполнены.';
                   resultArea.classList.add('error');
                   return;
               }
               resultArea.value = 'Обработка запроса...';
               resultArea.classList.remove('error');
               try {
                   const response = await fetch('https://cc-psi-livid.vercel.app/api/convert', {
                       method: 'POST',
                       headers: { 'Content-Type': 'application/json' },
                       body: JSON.stringify({ sourceText, sourceSc, destSc })
                   });
                   const result = await response.json();
                   if (!response.ok) {
                       throw new Error(result.error || `Сервер вернул ошибку ${response.status}`);
                   }
                   if (result.error && result.error.length > 0) {
                       resultArea.value = `Ошибка: ${result.error}`;
                       resultArea.classList.add('error');
                   } else if (result.destText) {
                       resultArea.value = result.destText.replace(/\r/g, '');
                   } else {
                       resultArea.value = "Не удалось найти отформатированный текст. Полный ответ:\n\n" + JSON.stringify(result, null, 2);
                   }
               } catch (error) {
                   resultArea.value = `Произошла ошибка: ${error.message}`;
                   resultArea.classList.add('error');
               }
           });
           
           // --- Инициализация при загрузке ---
           setRandomContainerGradient();
           setRandomButtonGradients();
           setRandomSwapIconGradients();
           populateSelectWithOptions(sourceScSelect, COORDINATE_SYSTEMS);
           populateSelectWithOptions(destScSelect, COORDINATE_SYSTEMS);
           
           // *** ИЗМЕНЕНИЕ: Загружаем сохраненные значения или ставим по умолчанию ***
           const savedSourceSC = localStorage.getItem('savedSourceSC');
           const savedDestSC = localStorage.getItem('savedDestSC');
           
           sourceScSelect.value = savedSourceSC || 'EPSG:3857';
           destScSelect.value = savedDestSC || 'EPSG:3857';

           // Обязательно обновляем видимость полей custom после загрузки
           toggleCustomInput(sourceScSelect, sourceScInput);
           toggleCustomInput(destScSelect, destScInput);

           checkClipboardAndPasteOnLoad();
       });
   </script>
</body>
</html>
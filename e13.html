<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="img/ai.svg" type="image/svg+xml" id="favicon">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --base-font-size: 15px;
    --bg-color: #f0f2f5;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --message-user-solid: #667eea;
    --message-bot-bg: #ffffff;
    --message-bot-border: #e4e6eb;
    --message-user-color: #ffffff;
    --message-bot-color: #1c1e21;
    --input-bg: #ffffff;
    --input-border: #dddfe2;
    --input-text: #1c1e21;
    --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --button-solid: #667eea;
    --button-hover: #5a6fd6;
    --button-color: white;
    --accent: #667eea;
    --accent-secondary: #764ba2;
    --shadow: rgba(0, 0, 0, 0.08);
    --shadow-md: rgba(0, 0, 0, 0.12);
    --border: #e4e6eb;
    --header-color: #1c1e21;
    --time-color: #65676b;
    --typing-bg: #e4e6eb;
    --typing-dot: #65676b;
    --code-bg: #f6f8fa;
    --code-header: #f0f2f5;
    --code-border: #e4e6eb;
    --scrollbar-thumb: #bcc0c4;
    --modal-bg: #ffffff;
    --modal-border: #e4e6eb;
    --chip-bg: #e4e6eb;
    --chip-color: #1c1e21;
    --selection-bg: #667eea;
    --selection-color: #ffffff;
    --hover-bg: #f0f2f5;
    --selected-bg: #e7e9ff;
    --selected-border: #667eea;
    --notify-bg: #667eea;
    --gemini-color: #4285f4;
    --gemini-secondary: #00bcd4;
    --mistral-color: #ff7000;
    --table-header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --table-row-alt: #f8f9fa;
    --table-hover: #e7e9ff;
    --checkbox-bg: #ffffff;
    --checkbox-border: #dadce0;
    --checkbox-checked-bg: #667eea;
    --checkbox-checked-border: #667eea;
}

body.dark-theme {
    --bg-color: #000000;
    --container-bg: #0a0a0a;
    --message-user-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --message-user-solid: #6366f1;
    --message-bot-bg: #111111;
    --message-bot-border: #1a1a1a;
    --message-user-color: #ffffff;
    --message-bot-color: #f5f5f5;
    --input-bg: #111111;
    --input-border: #222222;
    --input-text: #f5f5f5;
    --button-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --button-solid: #6366f1;
    --button-hover: #5558e3;
    --button-color: white;
    --accent: #818cf8;
    --accent-secondary: #a78bfa;
    --shadow: rgba(0, 0, 0, 0.6);
    --shadow-md: rgba(0, 0, 0, 0.7);
    --border: #1a1a1a;
    --header-color: #f5f5f5;
    --time-color: #666666;
    --typing-bg: #151515;
    --typing-dot: #818cf8;
    --code-bg: #0d0d0d;
    --code-header: #151515;
    --code-border: #222222;
    --scrollbar-thumb: #2a2a2a;
    --modal-bg: #0a0a0a;
    --modal-border: #1a1a1a;
    --chip-bg: #151515;
    --chip-color: #f5f5f5;
    --selection-bg: #818cf8;
    --selection-color: #000000;
    --hover-bg: #151515;
    --selected-bg: #1a1a2e;
    --selected-border: #818cf8;
    --notify-bg: #6366f1;
    --gemini-color: #60a5fa;
    --gemini-secondary: #22d3ee;
    --mistral-color: #fb923c;
    --table-header-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --table-row-alt: #0a0a0a;
    --table-hover: #151525;
    --checkbox-bg: #111111;
    --checkbox-border: #333333;
    --checkbox-checked-bg: #818cf8;
    --checkbox-checked-border: #818cf8;
}

body.night-theme {
    --bg-color: #12100a;
    --container-bg: #181510;
    --message-user-bg: linear-gradient(135deg, #a67c00 0%, #bf8f00 100%);
    --message-user-solid: #a67c00;
    --message-bot-bg: #1f1b14;
    --message-bot-border: #2d2820;
    --message-user-color: #fff8e7;
    --message-bot-color: #e5dcc8;
    --input-bg: #1f1b14;
    --input-border: #3a3428;
    --input-text: #e5dcc8;
    --button-bg: linear-gradient(135deg, #c49000 0%, #d4a020 100%);
    --button-solid: #c49000;
    --button-hover: #dab030;
    --button-color: #12100a;
    --accent: #d4a520;
    --accent-secondary: #c49000;
    --shadow: rgba(0, 0, 0, 0.5);
    --shadow-md: rgba(0, 0, 0, 0.6);
    --border: #2d2820;
    --header-color: #f0e6d0;
    --time-color: #9a8a70;
    --typing-bg: #252015;
    --typing-dot: #d4a520;
    --code-bg: #1a1712;
    --code-header: #252015;
    --code-border: #3a3428;
    --scrollbar-thumb: #3a3428;
    --modal-bg: #181510;
    --modal-border: #2d2820;
    --chip-bg: #252015;
    --chip-color: #e5dcc8;
    --selection-bg: #d4a520;
    --selection-color: #12100a;
    --hover-bg: #252015;
    --selected-bg: #302a1a;
    --selected-border: #d4a520;
    --notify-bg: #a67c00;
    --gemini-color: #d4a520;
    --gemini-secondary: #c49000;
    --mistral-color: #e09030;
    --table-header-bg: linear-gradient(135deg, #a67c00 0%, #bf8f00 100%);
    --table-row-alt: #1a1712;
    --table-hover: #302a1a;
    --checkbox-bg: #1f1b14;
    --checkbox-border: #3a3428;
    --checkbox-checked-bg: #d4a520;
    --checkbox-checked-border: #d4a520;
}

body.royalblue-theme {
    --bg-color: #012456;
    --container-bg: #012456;
    --message-user-bg: linear-gradient(135deg, #1e3a5f 0%, #2a4a7a 100%);
    --message-user-solid: #1e3a5f;
    --message-bot-bg: #01326e;
    --message-bot-border: #3a6ea5;
    --message-user-color: #eeedf0;
    --message-bot-color: #cccccc;
    --input-bg: #01326e;
    --input-border: #3a6ea5;
    --input-text: #eeedf0;
    --button-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --button-solid: #4169e1;
    --button-hover: #5a7be8;
    --button-color: #ffffff;
    --accent: #ffff00;
    --accent-secondary: #00ffff;
    --shadow: rgba(0, 0, 0, 0.4);
    --shadow-md: rgba(0, 0, 0, 0.5);
    --border: #3a6ea5;
    --header-color: #eeedf0;
    --time-color: #ffff00;
    --typing-bg: #01326e;
    --typing-dot: #ffff00;
    --code-bg: #01326e;
    --code-header: #1e3a5f;
    --code-border: #3a6ea5;
    --scrollbar-thumb: #3a6ea5;
    --modal-bg: #012456;
    --modal-border: #3a6ea5;
    --chip-bg: #1e3a5f;
    --chip-color: #eeedf0;
    --selection-bg: #ffff00;
    --selection-color: #012456;
    --hover-bg: #1e3a5f;
    --selected-bg: #2a4a7a;
    --selected-border: #ffff00;
    --notify-bg: #4169e1;
    --gemini-color: #87ceeb;
    --gemini-secondary: #dda0dd;
    --mistral-color: #ffd700;
    --table-header-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --table-row-alt: #01326e;
    --table-hover: #1e3a5f;
    --checkbox-bg: #01326e;
    --checkbox-border: #3a6ea5;
    --checkbox-checked-bg: #ffff00;
    --checkbox-checked-border: #ffff00;
}

body.imessage-theme {
    --bg-color: #ffffff;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --message-user-solid: #007aff;
    --message-bot-bg: #e9e9eb;
    --message-bot-border: transparent;
    --message-user-color: #ffffff;
    --message-bot-color: #000000;
    --input-bg: #f2f2f7;
    --input-border: #c7c7cc;
    --input-text: #000000;
    --button-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --button-solid: #007aff;
    --button-hover: #0056b3;
    --button-color: #ffffff;
    --accent: #007aff;
    --accent-secondary: #5856d6;
    --shadow: rgba(0, 0, 0, 0.04);
    --shadow-md: rgba(0, 0, 0, 0.08);
    --border: #c7c7cc;
    --header-color: #000000;
    --time-color: #8e8e93;
    --typing-bg: #e9e9eb;
    --typing-dot: #8e8e93;
    --code-bg: #f2f2f7;
    --code-header: #e5e5ea;
    --code-border: #c7c7cc;
    --scrollbar-thumb: #c7c7cc;
    --modal-bg: #ffffff;
    --modal-border: #c7c7cc;
    --chip-bg: #e5e5ea;
    --chip-color: #000000;
    --selection-bg: #007aff;
    --selection-color: #ffffff;
    --hover-bg: #f2f2f7;
    --selected-bg: #e5f3ff;
    --selected-border: #007aff;
    --notify-bg: #007aff;
    --gemini-color: #007aff;
    --gemini-secondary: #5856d6;
    --mistral-color: #ff9500;
    --table-header-bg: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
    --table-row-alt: #f2f2f7;
    --table-hover: #e5f3ff;
    --checkbox-bg: #ffffff;
    --checkbox-border: #c7c7cc;
    --checkbox-checked-bg: #007aff;
    --checkbox-checked-border: #007aff;
}

body.nature-theme {
    --bg-color: #e8f5e9;
    --container-bg: #f1f8e9;
    --message-user-bg: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
    --message-user-solid: #2e7d32;
    --message-bot-bg: #ffffff;
    --message-bot-border: #a5d6a7;
    --message-user-color: #ffffff;
    --message-bot-color: #1b5e20;
    --input-bg: #ffffff;
    --input-border: #a5d6a7;
    --input-text: #1b5e20;
    --button-bg: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
    --button-solid: #2e7d32;
    --button-hover: #1b5e20;
    --button-color: #ffffff;
    --accent: #2e7d32;
    --accent-secondary: #43a047;
    --shadow: rgba(46, 125, 50, 0.12);
    --shadow-md: rgba(46, 125, 50, 0.18);
    --border: #c8e6c9;
    --header-color: #1b5e20;
    --time-color: #558b2f;
    --typing-bg: #c8e6c9;
    --typing-dot: #2e7d32;
    --code-bg: #f1f8e9;
    --code-header: #dcedc8;
    --code-border: #a5d6a7;
    --scrollbar-thumb: #81c784;
    --modal-bg: #f1f8e9;
    --modal-border: #a5d6a7;
    --chip-bg: #c8e6c9;
    --chip-color: #1b5e20;
    --selection-bg: #2e7d32;
    --selection-color: #ffffff;
    --hover-bg: #dcedc8;
    --selected-bg: #c8e6c9;
    --selected-border: #2e7d32;
    --notify-bg: #2e7d32;
    --gemini-color: #2e7d32;
    --gemini-secondary: #66bb6a;
    --mistral-color: #ff8f00;
    --table-header-bg: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
    --table-row-alt: #e8f5e9;
    --table-hover: #c8e6c9;
    --checkbox-bg: #ffffff;
    --checkbox-border: #a5d6a7;
    --checkbox-checked-bg: #2e7d32;
    --checkbox-checked-border: #2e7d32;
}

body.arctic-theme {
    --bg-color: #e1f5fe;
    --container-bg: #e8f4fc;
    --message-user-bg: linear-gradient(135deg, #0277bd 0%, #0288d1 100%);
    --message-user-solid: #0277bd;
    --message-bot-bg: #ffffff;
    --message-bot-border: #81d4fa;
    --message-user-color: #ffffff;
    --message-bot-color: #01579b;
    --input-bg: #ffffff;
    --input-border: #81d4fa;
    --input-text: #01579b;
    --button-bg: linear-gradient(135deg, #0277bd 0%, #0288d1 100%);
    --button-solid: #0277bd;
    --button-hover: #01579b;
    --button-color: #ffffff;
    --accent: #0288d1;
    --accent-secondary: #03a9f4;
    --shadow: rgba(2, 119, 189, 0.12);
    --shadow-md: rgba(2, 119, 189, 0.18);
    --border: #b3e5fc;
    --header-color: #01579b;
    --time-color: #0277bd;
    --typing-bg: #b3e5fc;
    --typing-dot: #0288d1;
    --code-bg: #e1f5fe;
    --code-header: #b3e5fc;
    --code-border: #81d4fa;
    --scrollbar-thumb: #4fc3f7;
    --modal-bg: #e8f4fc;
    --modal-border: #81d4fa;
    --chip-bg: #b3e5fc;
    --chip-color: #01579b;
    --selection-bg: #0288d1;
    --selection-color: #ffffff;
    --hover-bg: #b3e5fc;
    --selected-bg: #b3e5fc;
    --selected-border: #0288d1;
    --notify-bg: #0277bd;
    --gemini-color: #0288d1;
    --gemini-secondary: #00bcd4;
    --mistral-color: #ff6f00;
    --table-header-bg: linear-gradient(135deg, #0277bd 0%, #0288d1 100%);
    --table-row-alt: #e1f5fe;
    --table-hover: #b3e5fc;
    --checkbox-bg: #ffffff;
    --checkbox-border: #81d4fa;
    --checkbox-checked-bg: #0288d1;
    --checkbox-checked-border: #0288d1;
}

html, body {
    height: 100%;
    width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-color);
    color: var(--message-bot-color);
    transition: all 0.3s ease;
}

::selection { background: var(--selection-bg); color: var(--selection-color); }

.container {
    height: 100%;
    display: flex;
    flex-direction: column;
    max-width: 100%;
    margin: 0 auto;
    background: var(--container-bg);
    transition: all 0.3s ease;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    background: var(--container-bg);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    gap: 12px;
    flex-shrink: 0;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    min-width: 0;
    flex: 1;
}

.header-logo {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
    position: relative;
    overflow: visible;
}

.header-logo.gemini {
    background: linear-gradient(135deg, 
        rgba(27, 161, 227, 0.1) 0%, 
        rgba(84, 137, 214, 0.1) 35%, 
        rgba(155, 114, 203, 0.1) 65%, 
        rgba(217, 101, 112, 0.1) 100%
    );
    border: 1px solid rgba(84, 137, 214, 0.25);
}

.header-logo.mistral {
    background: linear-gradient(135deg, rgba(255, 112, 0, 0.12) 0%, rgba(255, 152, 0, 0.12) 100%);
    border: 1px solid rgba(255, 112, 0, 0.25);
}

.header-logo.other {
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.12) 0%, rgba(156, 163, 175, 0.12) 100%);
    border: 1px solid rgba(107, 114, 128, 0.25);
}

.header-logo:hover { transform: scale(1.05); }

.gemini-star {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gemini-star svg {
    width: 100%;
    height: 100%;
    shape-rendering: geometricPrecision;
}

.header-logo .gemini-star { width: 24px; height: 24px; }
.msg-avatar .gemini-star { width: 18px; height: 18px; }

.header-logo.loading .gemini-star svg {
    animation: starRotate 2s ease-in-out infinite;
}

@keyframes starRotate {
    0% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(90deg) scale(1.1); }
    50% { transform: rotate(180deg) scale(1); }
    75% { transform: rotate(270deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}

body.dark-theme .header-logo.gemini,
body.dark-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, 
        rgba(27, 161, 227, 0.15) 0%, 
        rgba(84, 137, 214, 0.15) 35%, 
        rgba(155, 114, 203, 0.15) 65%, 
        rgba(217, 101, 112, 0.15) 100%
    );
    border: 1px solid rgba(96, 165, 250, 0.3);
}

body.night-theme .header-logo.gemini,
body.night-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(212, 165, 32, 0.12) 0%, rgba(196, 144, 0, 0.12) 100%);
    border: 1px solid rgba(212, 165, 32, 0.25);
}

body.royalblue-theme .header-logo.gemini,
body.royalblue-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(65, 105, 225, 0.15) 0%, rgba(90, 123, 232, 0.15) 100%);
    border: 1px solid rgba(65, 105, 225, 0.3);
}

body.imessage-theme .header-logo.gemini,
body.imessage-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(88, 86, 214, 0.1) 100%);
    border: 1px solid rgba(0, 122, 255, 0.2);
}

body.nature-theme .header-logo.gemini,
body.nature-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(46, 125, 50, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%);
    border: 1px solid rgba(46, 125, 50, 0.2);
}

body.arctic-theme .header-logo.gemini,
body.arctic-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(2, 119, 189, 0.1) 0%, rgba(3, 169, 244, 0.1) 100%);
    border: 1px solid rgba(2, 136, 209, 0.2);
}

.mistral-icon { width: 20px; height: 20px; }
.mistral-icon svg { width: 100%; height: 100%; fill: white; }

.other-icon { width: 20px; height: 20px; }
.other-icon svg { width: 100%; height: 100%; fill: white; }

.header-info { 
    display: flex; 
    flex-direction: column; 
    min-width: 0;
    flex: 1;
}

.header-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--header-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-subtitle {
    font-size: 11px;
    color: var(--time-color);
    white-space: nowrap;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.h-btn {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    background: transparent;
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: var(--accent);
}

.h-btn:hover { background: var(--hover-bg); }
.h-btn.active { background: var(--selected-bg); border-color: var(--accent); }
.h-btn svg { width: 18px; height: 18px; fill: currentColor; }

.selector { position: relative; }

.sel-btn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--container-bg);
    cursor: pointer;
    font-size: 12px;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.sel-btn:hover { background: var(--hover-bg); border-color: var(--accent); }

.sel-btn::after {
    content: '';
    width: 5px;
    height: 5px;
    border-right: 1.5px solid currentColor;
    border-bottom: 1.5px solid currentColor;
    transform: rotate(45deg);
    margin-left: auto;
    flex-shrink: 0;
    opacity: 0.6;
}

.sel-opts {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: var(--container-bg);
    border-radius: 10px;
    box-shadow: 0 4px 20px var(--shadow-md);
    padding: 6px 0;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
    border: 1px solid var(--border);
    min-width: 200px;
    max-height: 350px;
    overflow-y: auto;
}

.sel-opts.show { opacity: 1; visibility: visible; transform: translateY(0); }

.sel-opt {
    padding: 8px 14px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.sel-opt:hover { background: var(--hover-bg); }
.sel-opt.selected { background: var(--selected-bg); color: var(--accent); font-weight: 500; }

#chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-color);
    scroll-behavior: smooth;
}

#chat-container::-webkit-scrollbar { width: 6px; }
#chat-container::-webkit-scrollbar-track { background: transparent; }
#chat-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

.message {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    animation: msgSlide 0.3s ease;
    max-width: 88%;
}

@keyframes msgSlide {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user { margin-left: auto; flex-direction: row-reverse; }
.message.bot { margin-right: auto; }

.msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    position: relative;
}

.msg-avatar.user-avatar { background: var(--message-user-solid); }

.msg-avatar.gemini {
    background: linear-gradient(135deg, 
        rgba(27, 161, 227, 0.1) 0%, 
        rgba(84, 137, 214, 0.1) 35%, 
        rgba(155, 114, 203, 0.1) 65%, 
        rgba(217, 101, 112, 0.1) 100%
    );
    border: 1px solid rgba(84, 137, 214, 0.2);
}

.msg-avatar.mistral {
    background: linear-gradient(135deg, var(--mistral-color) 0%, #ff9800 100%);
}

.msg-avatar.other {
    background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
}

.msg-avatar svg { width: 14px; height: 14px; fill: white; }

.msg-avatar.thinking .gemini-star svg {
    animation: miniStarSpin 1.5s linear infinite;
}

@keyframes miniStarSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.msg-bubble { display: flex; flex-direction: column; max-width: 100%; min-width: 0; }

.msg-content {
    padding: 10px 14px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: var(--base-font-size);
    word-wrap: break-word;
    position: relative;
}

.user .msg-content {
    background: var(--message-user-bg);
    color: var(--message-user-color);
    border-bottom-right-radius: 4px;
}

.bot .msg-content {
    background: var(--message-bot-bg);
    color: var(--message-bot-color);
    border: 1px solid var(--message-bot-border);
    border-bottom-left-radius: 4px;
}

.msg-time {
    font-size: 10px;
    color: var(--time-color);
    margin-top: 4px;
    padding: 0 4px;
}

.user .msg-time { text-align: right; }

.msg-image {
    max-width: 280px;
    border-radius: 10px;
    margin-bottom: 6px;
    cursor: pointer;
}

.typing {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    animation: msgSlide 0.3s ease;
}

.typing-bubble {
    background: var(--typing-bg);
    padding: 14px 18px;
    border-radius: 16px;
    border-bottom-left-radius: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.typing-dot {
    width: 7px;
    height: 7px;
    background: var(--typing-dot);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1.2); opacity: 1; }
}

#file-preview {
    display: none;
    padding: 10px 16px;
    background: var(--container-bg);
    border-top: 1px solid var(--border);
}

#file-preview.visible { display: block; }

.file-chip {
    display: inline-flex;
    align-items: center;
    background: var(--chip-bg);
    color: var(--chip-color);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    gap: 8px;
}

.file-chip svg { width: 16px; height: 16px; fill: var(--accent); }
.file-chip img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; }

.file-chip-remove {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--hover-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.file-chip-remove:hover { background: var(--border); }
.file-chip-remove svg { width: 10px; height: 10px; fill: var(--message-bot-color); }

/* Compress Checkbox Container */
.compress-checkbox-container {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--hover-bg);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--message-bot-color);
}

.compress-checkbox-container.visible { display: flex; }

.custom-checkbox {
    position: relative;
    width: 18px;
    height: 18px;
    border: 2px solid var(--checkbox-border);
    border-radius: 4px;
    background-color: var(--checkbox-bg);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.custom-checkbox.checked {
    background-color: var(--checkbox-checked-bg);
    border-color: var(--checkbox-checked-border);
}

.custom-checkbox.checked::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

body.royalblue-theme .custom-checkbox.checked::after { color: #012456; }
body.night-theme .custom-checkbox.checked::after { color: #12100a; }

.compress-checkbox-label {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
}

.file-size-info {
    color: var(--accent);
    font-weight: 500;
}

.compression-info {
    font-size: 11px;
    color: var(--time-color);
    margin-left: auto;
}

#input-container {
    display: flex;
    padding: 8px 12px 12px;
    background: var(--container-bg);
    align-items: flex-end;
    gap: 8px;
    border-top: 1px solid var(--border);
}

#message-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--input-border);
    border-radius: 20px;
    font-size: var(--base-font-size);
    background: var(--input-bg);
    color: var(--input-text);
    resize: none;
    min-height: 42px;
    max-height: 120px;
    font-family: inherit;
    line-height: 1.4;
    transition: border-color 0.2s ease;
}

#message-input:focus {
    outline: none;
    border-color: var(--accent);
}

#message-input::placeholder { color: var(--time-color); }

.in-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

#upload-btn {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--border);
}

#upload-btn:hover { background: var(--hover-bg); }
#upload-btn.has-file { background: var(--selected-bg); border-color: var(--accent); }
#upload-btn svg { width: 20px; height: 20px; fill: currentColor; }

#send-btn {
    background: var(--button-bg);
    color: var(--button-color);
}

#send-btn:hover:not(:disabled) { transform: scale(1.05); }
#send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
#send-btn svg { width: 20px; height: 20px; fill: currentColor; }

.msg-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 12px 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px var(--shadow);
}

.msg-content thead { background: var(--table-header-bg); }

.msg-content th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: white;
    font-size: 12px;
}

.msg-content td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
}

.msg-content tbody tr:last-child td { border-bottom: none; }
.msg-content tbody tr:nth-child(even) { background: var(--table-row-alt); }
.msg-content tbody tr:hover { background: var(--table-hover); }

.msg-content pre {
    background: var(--code-bg);
    border: 1px solid var(--code-border);
    border-radius: 10px;
    margin: 10px 0;
    overflow: hidden;
}

.code-header {
    background: var(--code-header);
    padding: 6px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--time-color);
    border-bottom: 1px solid var(--code-border);
}

.code-lang { font-weight: 500; color: var(--accent); }

.code-copy {
    background: var(--container-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 10px;
    cursor: pointer;
    color: var(--message-bot-color);
    transition: all 0.2s ease;
}

.code-copy:hover { border-color: var(--accent); color: var(--accent); }

.msg-content pre code {
    display: block;
    padding: 12px;
    overflow-x: auto;
    font-family: 'SF Mono', Consolas, monospace;
    font-size: calc(var(--base-font-size) * 0.85);
    line-height: 1.5;
}

.msg-content code:not(pre code) {
    background: var(--hover-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', Consolas, monospace;
    font-size: 0.9em;
}

.notify {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--notify-bg);
    color: white;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s ease;
}

.notify.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.notify.error { background: #ef4444; }

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
    padding: 16px;
}

.modal-box {
    background: var(--modal-bg);
    border-radius: 14px;
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--modal-border);
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
}

.modal-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--header-color);
}

.modal-close {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    background: var(--hover-bg);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--message-bot-color);
}

.modal-close:hover { background: var(--border); }
.modal-close svg { width: 14px; height: 14px; fill: currentColor; }

.modal-body {
    padding: 18px;
    overflow-y: auto;
    flex: 1;
}

.set-group { margin-bottom: 18px; }
.set-group:last-child { margin-bottom: 0; }

.set-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--time-color);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.set-select, .set-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    color: var(--input-text);
    font-size: 13px;
    font-family: inherit;
}

.set-select:focus, .set-input:focus {
    outline: none;
    border-color: var(--accent);
}

.api-modes { display: flex; flex-direction: column; gap: 8px; }

.api-mode {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.api-mode:hover { border-color: var(--accent); background: var(--hover-bg); }
.api-mode.selected { border-color: var(--accent); background: var(--selected-bg); }
.api-mode svg { width: 16px; height: 16px; fill: var(--accent); flex-shrink: 0; }
.api-mode span { font-size: 13px; color: var(--message-bot-color); }

.set-row { display: flex; gap: 8px; flex-wrap: wrap; }

.set-row .h-btn {
    flex: 1;
    min-width: 100px;
    width: auto;
    height: 38px;
    font-size: 12px;
    gap: 6px;
}

.set-row .h-btn span { display: block; }

.set-btn {
    width: 100%;
    padding: 12px;
    background: var(--button-bg);
    color: var(--button-color);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 18px;
}

.set-btn:hover { opacity: 0.9; }

.set-link {
    display: block;
    margin-top: 8px;
    font-size: 11px;
    color: var(--accent);
    text-decoration: none;
}

.set-link:hover { text-decoration: underline; }

/* Theme Grid - без названий */
.theme-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.theme-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--input-bg);
    aspect-ratio: 1;
}

.theme-option:hover { border-color: var(--accent); transform: scale(1.05); }
.theme-option.selected { border-color: var(--accent); background: var(--selected-bg); }

.theme-preview {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.1);
}

.theme-preview.light { background: linear-gradient(135deg, #fff 50%, #667eea 50%); }
.theme-preview.dark { background: linear-gradient(135deg, #000 50%, #818cf8 50%); }
.theme-preview.night { background: linear-gradient(135deg, #12100a 50%, #d4a520 50%); }
.theme-preview.royalblue { background: linear-gradient(135deg, #012456 50%, #ffff00 50%); }
.theme-preview.imessage { background: linear-gradient(135deg, #fff 50%, #007aff 50%); }
.theme-preview.nature { background: linear-gradient(135deg, #e8f5e9 50%, #2e7d32 50%); }
.theme-preview.arctic { background: linear-gradient(135deg, #e1f5fe 50%, #0288d1 50%); }

.font-size-control {
    display: flex;
    align-items: center;
    gap: 12px;
}

.font-size-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--input-bg);
    color: var(--accent);
    font-size: 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.font-size-btn:hover { border-color: var(--accent); background: var(--hover-bg); }

.font-size-value {
    flex: 1;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--header-color);
}

.table-modal .modal-box {
    max-width: 95vw;
    width: 95vw;
    height: 90vh;
    max-height: 90vh;
}

.table-modal .modal-head { flex-shrink: 0; }
.table-modal .modal-body { padding: 0; overflow: auto; }

.table-actions {
    display: flex;
    gap: 8px;
}

.table-actions button {
    padding: 6px 12px;
    background: var(--hover-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 4px;
}

.table-actions button:hover { border-color: var(--accent); color: var(--accent); }
.table-actions button svg { width: 14px; height: 14px; fill: currentColor; }

#table-content { padding: 20px; min-height: 100%; }

#table-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px var(--shadow);
}

#table-content thead { background: var(--table-header-bg); }

#table-content th {
    padding: 14px 18px;
    text-align: left;
    font-weight: 600;
    color: white;
    font-size: 13px;
    white-space: nowrap;
}

#table-content td {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--message-bot-color);
}

#table-content tbody tr:last-child td { border-bottom: none; }
#table-content tbody tr:nth-child(even) { background: var(--table-row-alt); }
#table-content tbody tr:hover { background: var(--table-hover); }

.empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--time-color);
    text-align: center;
    padding: 40px;
}

.empty-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: var(--hover-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
}

.empty-icon svg { width: 32px; height: 32px; fill: var(--accent); }
.empty-title { font-size: 18px; font-weight: 600; color: var(--header-color); margin-bottom: 6px; }
.empty-text { font-size: 13px; max-width: 280px; }

/* Crop Modal */
#crop-modal {
    z-index: 10001;
}

#crop-modal .modal-box {
    max-width: 95vw;
    max-height: 95vh;
    width: auto;
}

.crop-container {
    position: relative;
    display: inline-block;
    border: 1px dashed var(--border);
    user-select: none;
    touch-action: none;
    cursor: crosshair;
    margin: 15px auto;
    max-width: 100%;
    max-height: calc(80vh - 150px);
    overflow: hidden;
}

.crop-container img {
    display: block;
    max-width: 100%;
    max-height: calc(80vh - 150px);
    width: auto;
    height: auto;
    object-fit: contain;
    user-select: none;
    -webkit-user-drag: none;
}

.crop-selection {
    position: absolute;
    border: 2px solid var(--accent);
    background-color: rgba(102, 126, 234, 0.15);
    display: none;
    pointer-events: none;
}

.crop-info {
    font-size: 12px;
    color: var(--time-color);
    text-align: center;
    margin-bottom: 10px;
}

.crop-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 15px;
}

.crop-buttons button {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.crop-btn-confirm {
    background: #22c55e;
    color: white;
}

.crop-btn-confirm:hover { background: #16a34a; }

.crop-btn-cancel {
    background: #ef4444;
    color: white;
}

.crop-btn-cancel:hover { background: #dc2626; }

body.royalblue-theme .crop-btn-confirm { background: #00ff00; color: #012456; }
body.night-theme .crop-btn-confirm { background: #d4a520; color: #12100a; }

@media (max-width: 768px) {
    .sel-btn { max-width: 180px; }
    .theme-grid { grid-template-columns: repeat(4, 1fr); }
}

@media (max-width: 600px) {
    .header { padding: 8px 10px; gap: 8px; }
    .header-left { gap: 8px; }
    .header-logo { width: 36px; height: 36px; }
    .header-logo .gemini-star { width: 20px; height: 20px; }
    .header-title { font-size: 13px; }
    .header-subtitle { font-size: 10px; }
    .header-controls { gap: 4px; }
    .header-controls .selector { display: none; }
    .h-btn { width: 32px; height: 32px; }
    .h-btn svg { width: 16px; height: 16px; }
    #chat-container { padding: 12px; }
    #input-container { padding: 6px 10px 10px; gap: 6px; }
    .message { max-width: 94%; }
    .in-btn { width: 38px; height: 38px; }
    #message-input { min-height: 38px; padding: 8px 12px; }
    .modal-box { max-width: 100%; border-radius: 12px; }
    .theme-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .theme-option { padding: 6px; }
    .theme-preview { width: 28px; height: 28px; }
    .table-actions { flex-wrap: wrap; }
    .table-actions button span { display: none; }
}

/* Message Copy Button */
.msg-copy {
    position: absolute;
    bottom: -12px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--container-bg);
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s ease;
    z-index: 10;
    color: var(--time-color);
    box-shadow: 0 2px 6px var(--shadow);
}

.msg-copy svg {
    width: 12px;
    height: 12px;
    fill: currentColor;
}

.msg-copy:hover {
    background: var(--hover-bg);
    border-color: var(--accent);
    color: var(--accent);
}

.msg-copy.copied {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
}

.msg-bubble:hover .msg-copy {
    opacity: 1;
    transform: scale(1);
}

/* Mobile: always visible */
@media (hover: none) and (pointer: coarse) {
    .msg-copy {
        opacity: 0.6;
        transform: scale(1);
    }
    
    .msg-copy:active {
        opacity: 1;
        transform: scale(0.95);
    }
}

.msg-bubble {
    position: relative;
}

.user .msg-copy {
    background: var(--container-bg);
    border-color: var(--border);
    color: var(--time-color);
}

.user .msg-copy:hover {
    border-color: var(--accent);
    color: var(--accent);
}

.user .msg-copy.copied {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
}

/* Mobile: always visible */
@media (hover: none) and (pointer: coarse) {
    .msg-copy {
        opacity: 0.7;
        transform: scale(1);
    }
    
    .msg-copy:active {
        opacity: 1;
        transform: scale(0.95);
    }
}

.msg-bubble {
    position: relative;
}

.user .msg-copy {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.8);
}

.user .msg-copy:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
}

.user .msg-copy.copied {
    background: rgba(255, 255, 255, 0.9);
    border-color: transparent;
    color: #22c55e;
}

@media (max-width: 400px) {
    .header { padding: 6px 8px; }
    .header-logo { width: 32px; height: 32px; }
    .header-logo .gemini-star { width: 18px; height: 18px; }
    .header-info { gap: 1px; }
    .header-title { font-size: 12px; }
    .header-subtitle { font-size: 9px; }
    .h-btn { width: 30px; height: 30px; }
    .h-btn svg { width: 14px; height: 14px; }
    #input-container { padding: 6px 8px 8px; }
    .in-btn { width: 36px; height: 36px; }
    #message-input { padding: 8px 10px; font-size: 14px; }
    .modal-body { padding: 14px; }
    .theme-preview { width: 24px; height: 24px; }
    .font-size-btn { width: 36px; height: 36px; }
}

#file-preview {
    display: none;
    padding: 10px 16px;
    background: var(--container-bg);
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 8px;
}

#file-preview.visible { 
    display: flex; 
}

.image-preview-modal {
    background: rgba(0, 0, 0, 0.9);
    cursor: zoom-out;
}

.image-preview-modal img {
    max-width: 95vw;
    max-height: 95vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    cursor: default;
}

.image-preview-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
}

.image-preview-close:hover {
    background: rgba(255, 255, 255, 0.25);
}

.image-preview-close svg {
    width: 20px;
    height: 20px;
    fill: white;
}


.header-logo.qwen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: 1px solid rgba(118, 75, 162, 0.3);
}

.msg-avatar.qwen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.qwen-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: white; }
.qwen-icon svg { width: 100%; height: 100%; fill: white; }

/* Стили для превью видео */
.file-chip video {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    object-fit: cover;
    background: #000;
}

.msg-video {
    max-width: 280px;
    border-radius: 10px;
    margin-bottom: 6px;
    cursor: pointer;
    background: black;
}

</style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-left" id="header-left">
            <div class="header-logo gemini" id="header-logo">
                <div class="gemini-star">
                    <svg viewBox="0 0 32 32" width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="gemini-grad-h" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#1BA1E3"/>
                                <stop offset="30%" stop-color="#5489D6"/>
                                <stop offset="60%" stop-color="#9B72CB"/>
                                <stop offset="100%" stop-color="#D96570"/>
                            </linearGradient>
                        </defs>
                        <path fill="url(#gemini-grad-h)" d="M16 0C16 8.837 8.837 16 0 16C8.837 16 16 23.163 16 32C16 23.163 23.163 16 32 16C23.163 16 16 8.837 16 0Z"/>
                    </svg>
                </div>
            </div>
            <div class="header-info">
                <div class="header-title" id="header-title">Gemini 3 Flash</div>
                <div class="header-subtitle" id="header-subtitle"></div>
            </div>
        </div>
        <div class="header-controls">
            <div class="selector" id="model-selector">
                <button class="sel-btn" id="model-btn"><span id="model-name">Gemini 3 Flash</span></button>
                <ul class="sel-opts" id="model-opts"></ul>
            </div>
            
            <button class="h-btn" id="table-btn" title="Режим таблицы">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v2H7V7zm0 4h2v2H7v-2zm0 4h2v2H7v-2zm4-8h6v2h-6V7zm0 4h6v2h-6v-2zm0 4h6v2h-6v-2z"/></svg>
            </button>
            
            <button class="h-btn" id="settings-btn" title="Настройки">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.44.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>
    </header>

    <!-- Compress Checkbox -->
    <div class="compress-checkbox-container" id="compress-container">
        <div class="custom-checkbox" id="compress-checkbox"></div>
        <label class="compress-checkbox-label" id="compress-label">
            <span>Сжать изображение</span>
            <span class="file-size-info" id="file-size-info"></span>
        </label>
        <span class="compression-info">50% размер, 80% качество</span>
    </div>

    <div id="chat-container">
        <div class="empty" id="empty">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <div class="empty-title">Начните диалог</div>
            <div class="empty-text">Напишите сообщение или прикрепите файл</div>
        </div>
    </div>

    <div id="file-preview"></div>

    <div id="input-container">
    <input type="file" id="file-input" accept="image/*,application/pdf,video/*" hidden>
        <button class="in-btn" id="upload-btn" title="Прикрепить">
            <svg viewBox="0 -960 960 960"><path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160Zm40 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
        </button>
        <textarea id="message-input" placeholder="Сообщение..." rows="1"></textarea>
        <button class="in-btn" id="send-btn" title="Отправить">
            <svg viewBox="0 -960 960 960"><path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"/></svg>
        </button>
    </div>
</div>

<div class="notify" id="notify"></div>

<!-- Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">⚙️ Настройки</div>
            <button class="modal-close" id="close-settings">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="set-group">
                <label class="set-label">Модель</label>
                <select class="set-select" id="set-model"></select>
            </div>
            
            <div class="set-group">
                <label class="set-label">Режим API</label>
                <div class="api-modes" id="api-modes"></div>
            </div>
            
            <div class="set-group" id="api-key-group" style="display:none;">
                <label class="set-label">API ключ</label>
                <input type="password" class="set-input" id="api-key-input" placeholder="Введите ключ...">
                <a class="set-link" id="api-link" href="#" target="_blank">Получить ключ →</a>
            </div>
            
            <div class="set-group">
                <label class="set-label">Тема</label>
                <div class="theme-grid" id="theme-grid">
                    <div class="theme-option selected" data-theme="light" title="Светлая">
                        <div class="theme-preview light"></div>
                    </div>
                    <div class="theme-option" data-theme="dark" title="Тёмная">
                        <div class="theme-preview dark"></div>
                    </div>
                    <div class="theme-option" data-theme="night" title="Ночная">
                        <div class="theme-preview night"></div>
                    </div>
                    <div class="theme-option" data-theme="royalblue" title="Powershell">
                        <div class="theme-preview royalblue"></div>
                    </div>
                    <div class="theme-option" data-theme="imessage" title="iMessage">
                        <div class="theme-preview imessage"></div>
                    </div>
                    <div class="theme-option" data-theme="nature" title="Природа">
                        <div class="theme-preview nature"></div>
                    </div>
                    <div class="theme-option" data-theme="arctic" title="Arctic">
                        <div class="theme-preview arctic"></div>
                    </div>
                </div>
            </div>
            
            <div class="set-group">
                <label class="set-label">Размер шрифта</label>
                <div class="font-size-control">
                    <button class="font-size-btn" id="font-decrease">−</button>
                    <span class="font-size-value" id="font-size-value">15px</span>
                    <button class="font-size-btn" id="font-increase">+</button>
                </div>
            </div>
            
            <div class="set-group">
                <label class="set-label">Действия</label>
                <div class="set-row">
                    <button class="h-btn" id="set-clear">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        <span>Очистить чат</span>
                    </button>
                </div>
            </div>
            
            <button class="set-btn" id="save-settings">Сохранить</button>
        </div>
    </div>
</div>

<!-- Table Modal -->
<div class="modal table-modal" id="table-modal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">📊 Результат в таблице</div>
            <div class="table-actions">
                <button id="table-copy">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    <span>Копировать</span>
                </button>
                <button id="table-html">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    <span>Скачать</span>
                </button>
                <button id="table-newtab">
                    <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                    <span>Открыть</span>
                </button>
            </div>
            <button class="modal-close" id="close-table">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="table-content"></div>
        </div>
    </div>
</div>

<!-- Crop Modal -->
<div class="modal" id="crop-modal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">✂️ Обрезать изображение</div>
            <button class="modal-close" id="close-crop">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-body" style="text-align:center;">
            <p class="crop-info">Выделите область для обрезки или нажмите "Использовать всё"</p>
            <div class="crop-container" id="crop-container">
                <img id="crop-image" src="" alt="Preview">
                <div class="crop-selection" id="crop-selection"></div>
            </div>
            <div class="crop-buttons">
                <button class="crop-btn-confirm" id="crop-confirm">✓ Применить</button>
                <button class="crop-btn-cancel" id="crop-use-all">Использовать всё</button>
            </div>
        </div>
    </div>
</div>

<div class="modal image-preview-modal" id="image-preview-modal">
    <button class="image-preview-close" id="close-image-preview">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
    <img id="image-preview-img" src="" alt="Preview">
</div>

<script>
// ===== CONFIG =====
const MODELS = [
    { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite", api: "gemini" },
    { id: "gemini-2.5-flash-lite-preview-09-25", name: "Gemini 2.5 Flash Lite Preview", api: "gemini" },
    { id: "gemini-3-flash-preview", name: "Gemini 3 Flash", api: "gemini" },
    { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", api: "gemini" },
    { id: "gemini-3-pro-preview", name: "Gemini 3 Pro Preview", api: "gemini" },
    { id: "nvidia/nemotron-3-nano-30b-a3b:free", name: "NVIDIA Nemotron 3 Nano", api: "openrouter" },
    { id: "gpt-oss-20b-free", name: "OpenAI GPT-OSS 20B", api: "openrouter" },
    { id: "mistral-large-2512", name: "Mistral Large", api: "mistral" },
    { id: "mistral-medium-2508", name: "Mistral Medium", api: "mistral" },
    
     { id: "qwen-max-latest", name: "Qwen Max (Latest)", api: "qwen" },
    { id: "qwen-image", name: "Qwen VL (Image)", api: "qwen" },
    { id: "qwen-video", name: "Qwen Video", api: "qwen" },
];

const API_MODES = {
    mapruapp: { name: 'Прокси (MapRuApp)', icon: 'server' },
    vercel: { name: 'Прокси (Vercel)', icon: 'cloud' },
    direct: { name: 'Прямой (Gemini)', icon: 'key' },
    direct_mistral: { name: 'Прямой (Mistral)', icon: 'bolt' }
};

const THEMES = ['light', 'dark', 'night', 'royalblue', 'imessage', 'nature', 'arctic'];
const FONTS = [12, 13, 14, 15, 16, 17, 18, 19, 20];

const PROXY_MAP = "https://mapruapp.ru/ai/api/v1/chat/completions";
const PROXY_VER = "https://ver-olive-delta.vercel.app";

const TABLE_PROMPT = `Отвечай ТОЛЬКО в формате Markdown таблиц. Структурируй ВСЮ информацию в таблицы.`;

// Image processing constants
const COMPRESS_THRESHOLD_BYTES = 1 * 1024 * 1024; // 1 MB
const CROP_DIMENSION_THRESHOLD = 800; // pixels

// ===== STATE =====
let history = [];
let pendingFiles = [];
let model = localStorage.getItem('model') || 'gemini-3-flash-preview';
let apiMode = localStorage.getItem('apiMode') || 'mapruapp';
let apiKey = localStorage.getItem('apiKey') || '';
let theme = localStorage.getItem('theme') || 'light';
let fontIdx = parseInt(localStorage.getItem('fontIdx')) || 3;
let tableMode = localStorage.getItem('tableMode') === 'true';
let compressEnabled = localStorage.getItem('compressEnabled') !== 'false';
let isLoading = false;
let lastTableHtml = '';

// Crop state
let cropResolve = null;
let cropSelection = { startX: 0, startY: 0, endX: 0, endY: 0, isDrawing: false };
let imageNaturalSize = { width: 0, height: 0 };
let imageDisplaySize = { width: 0, height: 0 };

// ===== ELEMENTS =====
const $ = id => document.getElementById(id);
const chat = $('chat-container');
const input = $('message-input');
const sendBtn = $('send-btn');
const uploadBtn = $('upload-btn');
const fileInput = $('file-input');
const filePreview = $('file-preview');
const notify = $('notify');
const empty = $('empty');
const headerTitle = $('header-title');
const headerSub = $('header-subtitle');
const headerLogo = $('header-logo');
const modelBtn = $('model-btn');
const modelOpts = $('model-opts');
const tableBtn = $('table-btn');
const settingsModal = $('settings-modal');
const tableModal = $('table-modal');
const cropModal = $('crop-modal');
const compressContainer = $('compress-container');
const compressCheckbox = $('compress-checkbox');
const fileSizeInfo = $('file-size-info');

// ===== SVG TEMPLATES =====
const GEMINI_STAR = `
<div class="gemini-star">
    <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <linearGradient id="g-star" x1="0" y1="0" x2="28" y2="28" gradientUnits="userSpaceOnUse">
                <stop stop-color="#4285F4"/>
                <stop offset="0.5" stop-color="#9B72CB"/>
                <stop offset="1" stop-color="#D96570"/>
            </linearGradient>
        </defs>
        <path fill="url(#g-star)" d="M14 0C14 7.732 7.732 14 0 14C7.732 14 14 20.268 14 28C14 20.268 20.268 14 28 14C20.268 14 14 7.732 14 0Z"/>
    </svg>
</div>`;

const MISTRAL_ICON = `<div class="mistral-icon"><svg viewBox="0 0 24 24"><path d="M13 3L4 14h7l-2 7 9-11h-7l2-7z"/></svg></div>`;
const OTHER_ICON = `<div class="other-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>`;


const QWEN_ICON_SVG = `<div class="qwen-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>`; 

const ICONS = {
    server: `<svg viewBox="0 0 24 24"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>`,
    cloud: `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`,
    key: `<svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>`,
    bolt: `<svg viewBox="0 0 24 24"><path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/></svg>`
};

// ===== INIT =====
function init() {
    marked.setOptions({ gfm: true, breaks: true });
    applyTheme(theme);
    applyFont(FONTS[fontIdx]);
    renderModels();
    renderApiModes();
    updateUI();
    setupEvents();
    updateCompressCheckboxUI();
    
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.theme === theme);
    });
    document.getElementById('message-input').focus();
}


function setupEvents() {
    sendBtn.onclick = send;
    input.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } };
    input.oninput = autoResize;
    
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = handleFile;
    input.onpaste = handlePaste;
    
    $('header-left').onclick = resetChat;
    $('settings-btn').onclick = () => openModal(settingsModal);
    tableBtn.onclick = toggleTableMode;
    
    modelBtn.onclick = e => { e.stopPropagation(); modelOpts.classList.toggle('show'); };
    document.onclick = () => modelOpts.classList.remove('show');
    
    $('close-settings').onclick = () => closeModal(settingsModal);
    settingsModal.onclick = e => { if (e.target === settingsModal) closeModal(settingsModal); };
    $('save-settings').onclick = saveSettings;
    $('set-model').onchange = e => { model = e.target.value; updateUI(); };
    $('set-clear').onclick = () => { resetChat(); closeModal(settingsModal); };
    
    $('close-image-preview').onclick = () => closeModal($('image-preview-modal'));
$('image-preview-modal').onclick = e => {
    if (e.target === $('image-preview-modal')) closeModal($('image-preview-modal'));
};

    
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.onclick = () => {
            applyTheme(opt.dataset.theme);
        
        };
    });
    
    $('font-decrease').onclick = () => {
        if (fontIdx > 0) { fontIdx--; applyFont(FONTS[fontIdx]); localStorage.setItem('fontIdx', fontIdx); }
    };
    $('font-increase').onclick = () => {
        if (fontIdx < FONTS.length - 1) { fontIdx++; applyFont(FONTS[fontIdx]); localStorage.setItem('fontIdx', fontIdx); }
    };
    
    $('close-table').onclick = () => closeModal(tableModal);
    tableModal.onclick = e => { if (e.target === tableModal) closeModal(tableModal); };
    $('table-copy').onclick = copyTable;
    $('table-html').onclick = downloadTableHtml;
    $('table-newtab').onclick = openTableNewTab;
    
    // Compress checkbox
    compressCheckbox.onclick = toggleCompressCheckbox;
    $('compress-label').onclick = toggleCompressCheckbox;
    
    // Crop modal
    $('close-crop').onclick = () => { if (cropResolve) cropResolve(null); closeModal(cropModal); };
    cropModal.onclick = e => { if (e.target === cropModal) { if (cropResolve) cropResolve(null); closeModal(cropModal); } };
    
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        closeModal(settingsModal);
        closeModal(tableModal);
        closeModal($('image-preview-modal'));
        if (cropResolve) cropResolve(null);
        closeModal(cropModal);
        modelOpts.classList.remove('show');
    }
});
}

async function stitchImagesVertically(base64Images) {
    const images = await Promise.all(base64Images.map(src => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }));
    
    const maxWidth = Math.max(...images.map(img => img.width));
    const totalHeight = images.reduce((sum, img) => sum + img.height, 0);
    
    const canvas = document.createElement('canvas');
    canvas.width = maxWidth;
    canvas.height = totalHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, maxWidth, totalHeight);
    
    let y = 0;
    for (const img of images) {
        const x = Math.round((maxWidth - img.width) / 2);
        ctx.drawImage(img, x, y);
        y += img.height;
    }
    
    return canvas.toDataURL('image/jpeg', 0.92);
}

// ===== COMPRESS CHECKBOX =====
function toggleCompressCheckbox() {
    compressEnabled = !compressEnabled;
    localStorage.setItem('compressEnabled', compressEnabled);
    updateCompressCheckboxUI();
}

function updateCompressCheckboxUI() {
    compressCheckbox.classList.toggle('checked', compressEnabled);
}

function updateCompressVisibility() {
    const imageFiles = pendingFiles.filter(f => f.type.startsWith('image/'));
    const totalSize = imageFiles.reduce((sum, f) => sum + f.size, 0);
    
    if (imageFiles.length > 0 && totalSize >= COMPRESS_THRESHOLD_BYTES) {
        const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        fileSizeInfo.textContent = `(${sizeMB} MB)`;
        compressContainer.classList.add('visible');
    } else {
        compressContainer.classList.remove('visible');
    }
}

window.removeFile = function(idx) {
    pendingFiles.splice(idx, 1);
    updateFilePreview();
    updateCompressVisibility();
};

window.clearFile = function() {
    pendingFiles = [];
    updateFilePreview();
    compressContainer.classList.remove('visible');
};
// ===== IMAGE COMPRESSION =====
async function compressImage(base64Data, quality = 0.8, scale = 0.5) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const newWidth = Math.round(img.width * scale);
            const newHeight = Math.round(img.height * scale);
            
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, newWidth, newHeight);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = base64Data;
    });
}

async function compressToTargetSize(base64Data, targetBytes = COMPRESS_THRESHOLD_BYTES, maxAttempts = 5) {
    let currentData = base64Data;
    let attempt = 0;
    
    while (attempt < maxAttempts) {
        const base64Content = currentData.split(',')[1] || currentData;
        const sizeBytes = Math.round((base64Content.length * 3) / 4);
        
        if (sizeBytes < targetBytes) return currentData;
        
        attempt++;
        showNotify(`Сжатие: попытка ${attempt}...`, false);
        currentData = await compressImage(currentData, 0.8, 0.5);
    }
    
    return currentData;
}

// ===== CROP MODAL =====
function showCropModal(file, currentIndex = 1, totalCount = 1) {
    return new Promise((resolve) => {
        cropResolve = resolve;
        const imgEl = $('crop-image');
        const container = $('crop-container');
        const selection = $('crop-selection');
        const modalTitle = cropModal.querySelector('.modal-title');
        
        if (totalCount > 1) {
            modalTitle.textContent = `✂️ Обрезать изображение ${currentIndex}/${totalCount}`;
        } else {
            modalTitle.textContent = '✂️ Обрезать изображение';
        }
        
        selection.style.display = 'none';
        cropSelection = { startX: 0, startY: 0, endX: 0, endY: 0, isDrawing: false };
        
        const reader = new FileReader();
        reader.onload = (e) => {
            imgEl.src = e.target.result;
            openModal(cropModal);
            
            imgEl.onload = () => {
                imageNaturalSize = { width: imgEl.naturalWidth, height: imgEl.naturalHeight };
                requestAnimationFrame(() => {
                    imageDisplaySize = { width: imgEl.offsetWidth, height: imgEl.offsetHeight };
                });
            };
        };
        reader.readAsDataURL(file);
        
        function getPos(e) {
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: Math.max(0, Math.min(clientX - rect.left, imageDisplaySize.width)),
                y: Math.max(0, Math.min(clientY - rect.top, imageDisplaySize.height))
            };
        }
        
        function updateRect() {
            const x = Math.min(cropSelection.startX, cropSelection.endX);
            const y = Math.min(cropSelection.startY, cropSelection.endY);
            const w = Math.abs(cropSelection.endX - cropSelection.startX);
            const h = Math.abs(cropSelection.endY - cropSelection.startY);
            selection.style.left = x + 'px';
            selection.style.top = y + 'px';
            selection.style.width = w + 'px';
            selection.style.height = h + 'px';
        }
        
        const onStart = (e) => {
            e.preventDefault();
            cropSelection.isDrawing = true;
            const pos = getPos(e);
            cropSelection.startX = cropSelection.endX = pos.x;
            cropSelection.startY = cropSelection.endY = pos.y;
            selection.style.display = 'block';
            selection.style.width = '0';
            selection.style.height = '0';
        };
        
        const onMove = (e) => {
            if (!cropSelection.isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            cropSelection.endX = pos.x;
            cropSelection.endY = pos.y;
            updateRect();
        };
        
        const onEnd = () => {
            cropSelection.isDrawing = false;
            const w = Math.abs(cropSelection.endX - cropSelection.startX);
            const h = Math.abs(cropSelection.endY - cropSelection.startY);
            if (w < 10 || h < 10) selection.style.display = 'none';
        };
        
        container.onmousedown = onStart;
        container.ontouchstart = onStart;
        container.onmousemove = onMove;
        container.ontouchmove = onMove;
        window.onmouseup = onEnd;
        window.ontouchend = onEnd;
        
        $('crop-confirm').onclick = () => {
            const w = Math.abs(cropSelection.endX - cropSelection.startX);
            const h = Math.abs(cropSelection.endY - cropSelection.startY);
            
            if (w < 10 || h < 10 || selection.style.display === 'none') {
                toBase64(file).then(data => {
                    cleanup();
                    resolve({ cropped: false, data });
                });
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scaleX = imageNaturalSize.width / imageDisplaySize.width;
            const scaleY = imageNaturalSize.height / imageDisplaySize.height;
            
            const sx = Math.min(cropSelection.startX, cropSelection.endX) * scaleX;
            const sy = Math.min(cropSelection.startY, cropSelection.endY) * scaleY;
            const sw = w * scaleX;
            const sh = h * scaleY;
            
            canvas.width = sw;
            canvas.height = sh;
            ctx.drawImage(imgEl, sx, sy, sw, sh, 0, 0, sw, sh);
            
            cleanup();
            resolve({ cropped: true, data: canvas.toDataURL(file.type || 'image/png') });
        };
        
        $('crop-use-all').onclick = () => {
            toBase64(file).then(data => {
                cleanup();
                resolve({ cropped: false, data });
            });
        };
        
        function cleanup() {
            closeModal(cropModal);
            container.onmousedown = null;
            container.ontouchstart = null;
            container.onmousemove = null;
            container.ontouchmove = null;
            window.onmouseup = null;
            window.ontouchend = null;
            cropResolve = null;
        }
    });
}

// ===== THEME =====
function applyTheme(t) {
    document.body.className = '';
    if (t !== 'light') document.body.classList.add(`${t}-theme`);
    theme = t;
    localStorage.setItem('theme', t);
    
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.theme === t);
    });
    
    const isDark = ['dark', 'night', 'royalblue'].includes(t);
    $('hljs-theme').href = isDark 
        ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css'
        : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
}

// ===== FONT =====
function applyFont(size) {
    document.documentElement.style.setProperty('--base-font-size', size + 'px');
    $('font-size-value').textContent = size + 'px';
}

// ===== TABLE MODE =====
function toggleTableMode() {
    tableMode = !tableMode;
    localStorage.setItem('tableMode', tableMode);
    tableBtn.classList.toggle('active', tableMode);
    showNotify(tableMode ? 'Вывод ответа в таблице включен' : 'Режим таблицы отключен');
}

// ===== UI =====
function updateUI() {
    const m = MODELS.find(x => x.id === model) || MODELS[2];
    headerTitle.textContent = m.name;
    $('model-name').textContent = m.name;
    
    const cls = m.api === 'gemini' ? 'gemini' : m.api === 'mistral' ? 'mistral' : m.api === 'qwen' ? 'qwen' : 'other';
    const icon = m.api === 'gemini' ? GEMINI_STAR : m.api === 'mistral' ? MISTRAL_ICON : m.api === 'qwen' ? QWEN_ICON_SVG : OTHER_ICON;
    
    headerLogo.className = 'header-logo ' + cls;
    headerLogo.innerHTML = icon;
    
    modelOpts.querySelectorAll('.sel-opt').forEach(o => o.classList.toggle('selected', o.dataset.id === model));
    $('set-model').value = model;
    updateApiModesVisibility(m.api);
    tableBtn.classList.toggle('active', tableMode);
    updateContextSize();
}

function updateContextSize() {
    if (history.length === 0) { headerSub.textContent = ''; return; }
    let chars = 0, bytes = 0;
    history.forEach(m => {
        if (m.text) { chars += m.text.length; bytes += new TextEncoder().encode(m.text).length; }
        if (m.file?.data) bytes += m.file.data.length;
    });
    headerSub.textContent = `~${Math.round(chars/4).toLocaleString()} токенов · ${(bytes/1024).toFixed(1)} КБ`;
}

function updateApiModesVisibility(apiType) {
    const modes = $('api-modes');
    modes.querySelectorAll('.api-mode').forEach(m => {
        const mode = m.dataset.mode;
        if (apiType === 'gemini') m.style.display = mode === 'direct_mistral' ? 'none' : 'flex';
        else if (apiType === 'mistral') m.style.display = (mode === 'direct' || mode === 'vercel') ? 'none' : 'flex';
        else m.style.display = mode === 'mapruapp' ? 'flex' : 'none';
    });
    
    const currentEl = modes.querySelector(`[data-mode="${apiMode}"]`);
    if (currentEl && currentEl.style.display === 'none') {
        apiMode = 'mapruapp';
        modes.querySelectorAll('.api-mode').forEach(m => m.classList.toggle('selected', m.dataset.mode === apiMode));
    }
    
    const needsKey = (apiMode === 'direct' || apiMode === 'direct_mistral');
    $('api-key-group').style.display = needsKey ? 'block' : 'none';
    $('api-link').href = apiMode === 'direct' ? 'https://aistudio.google.com/app/apikey' : 'https://console.mistral.ai/api-keys/';
}

function renderModels() {
    modelOpts.innerHTML = MODELS.map(m => `<li class="sel-opt ${m.id === model ? 'selected' : ''}" data-id="${m.id}">${m.name}</li>`).join('');
    modelOpts.querySelectorAll('.sel-opt').forEach(o => {
        o.onclick = e => { e.stopPropagation(); model = o.dataset.id; localStorage.setItem('model', model); modelOpts.classList.remove('show'); updateUI(); };
    });
    $('set-model').innerHTML = MODELS.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
    $('set-model').value = model;
}

function renderApiModes() {
    const modes = $('api-modes');
    modes.innerHTML = Object.entries(API_MODES).map(([key, val]) => `
        <div class="api-mode ${key === apiMode ? 'selected' : ''}" data-mode="${key}">
            ${ICONS[val.icon]}<span>${val.name}</span>
        </div>
    `).join('');
    modes.querySelectorAll('.api-mode').forEach(m => {
        m.onclick = () => {
            apiMode = m.dataset.mode;
            modes.querySelectorAll('.api-mode').forEach(x => x.classList.toggle('selected', x.dataset.mode === apiMode));
            updateApiModesVisibility(MODELS.find(x => x.id === model)?.api || 'gemini');
        };
    });
    $('api-key-input').value = apiKey;
}

function saveSettings() {
    model = $('set-model').value;
    apiKey = $('api-key-input').value.trim();
    localStorage.setItem('model', model);
    localStorage.setItem('apiMode', apiMode);
    localStorage.setItem('apiKey', apiKey);
    closeModal(settingsModal);
    updateUI();
    showNotify('Настройки сохранены');
}

// ===== FILE =====
function handleFile() {
    const file = fileInput.files?.[0];
    if (!file) return;
    
    // Добавлена поддержка видео
    const allowed = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'video/mp4', 'video/webm', 'video/quicktime'];
    
    if (!allowed.includes(file.type)) { showNotify('Формат не поддерживается', true); return; }
    
    // Увеличенный лимит для видео (50 МБ), для картинок 20 МБ
    const limit = file.type.startsWith('video/') ? 50 * 1024 * 1024 : 20 * 1024 * 1024;
    
    if (file.size > limit) { showNotify(`Файл слишком большой (>${limit/1024/1024}MB)`, true); return; }
    
    if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
        if (pendingFiles.length >= 5) { showNotify('Максимум 5 файлов', true); return; }
        pendingFiles.push(file);
    } else {
        pendingFiles = [file];
    }
    
    updateFilePreview();
    updateCompressVisibility();
    fileInput.value = '';
}

function handlePaste(e) {
    const items = e.clipboardData?.items;
    if (!items) return;
    
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            e.preventDefault();
            
            if (pendingFiles.length >= 5) { 
                showNotify('Максимум 5 изображений', true); 
                return; 
            }
            
            const blob = item.getAsFile();
            const file = new File([blob], `image-${Date.now()}.png`, { type: blob.type });
            pendingFiles.push(file);
            updateFilePreview();
            updateCompressVisibility();
            showNotify(`Изображение ${pendingFiles.length}/5 добавлено`);
            break;
        }
    }
}

function updateFilePreview() {
    if (pendingFiles.length === 0) {
        filePreview.innerHTML = '';
        filePreview.classList.remove('visible');
        uploadBtn.classList.remove('has-file');
        return;
    }
    
    uploadBtn.classList.add('has-file');
    filePreview.classList.add('visible');
    
    const chips = pendingFiles.map((file, idx) => {
        const isImg = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');
        
        let preview;
        if (isImg) {
            preview = `<img src="${URL.createObjectURL(file)}" alt="">`;
        } else if (isVideo) {
            preview = `<video src="${URL.createObjectURL(file)}"></video>`;
        } else {
            preview = `<svg viewBox="0 -960 960 960"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Z"/></svg>`;
        }
        
        return `
            <div class="file-chip">
                ${preview}
                <span style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${isImg || isVideo ? `#${idx + 1}` : file.name}</span>
                <span class="file-chip-remove" onclick="removeFile(${idx})">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </span>
            </div>
        `;
    }).join('');
    
    filePreview.innerHTML = chips;
}

window.clearFile = function() {
    pendingFile = null;
    updateFilePreview();
    compressContainer.classList.remove('visible');
};

// ===== MESSAGES =====
function getAvatarHtml(role, apiType) {
    if (role === 'user') return '<div class="msg-avatar user-avatar">Я</div>';
    const cls = apiType === 'gemini' ? 'gemini' : apiType === 'mistral' ? 'mistral' : apiType === 'qwen' ? 'qwen' : 'other';
    const icon = apiType === 'gemini' ? GEMINI_STAR : apiType === 'mistral' ? MISTRAL_ICON : apiType === 'qwen' ? QWEN_ICON_SVG : OTHER_ICON;
    return `<div class="msg-avatar ${cls}">${icon}</div>`;
}

function addMessage(role, text, mediaUrl = null, mediaType = null) {
    empty.style.display = 'none';
    const m = MODELS.find(x => x.id === model);
    const div = document.createElement('div');
    div.className = `message ${role}`;
    
    let content = '';
    
    if (mediaUrl) {
        if (mediaType && mediaType.startsWith('video/')) {
            content += `<video src="${mediaUrl}" class="msg-video" controls></video>`;
        } else {
            content += `<img src="${mediaUrl}" class="msg-image" data-full="${mediaUrl}" onclick="openImagePreview(this.dataset.full)">`;
        }
    }
    
    content += formatText(text);
    
    div.innerHTML = `
        ${getAvatarHtml(role, m?.api)}
        <div class="msg-bubble">
            <button class="msg-copy" onclick="copyMessage(this, \`${text.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)" title="Копировать">
                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
            <div class="msg-content">${content}</div>
            <div class="msg-time">${new Date().toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'})}</div>
        </div>
    `;
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
    updateContextSize();
}

window.openImagePreview = function(dataUrl) {
    $('image-preview-img').src = dataUrl;
    openModal($('image-preview-modal'));
};


window.copyMessage = function(btn, text) {
    // Decode escaped characters
    const decoded = text.replace(/\\`/g, '`').replace(/\\\\/g, '\\');
    navigator.clipboard.writeText(decoded).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
        }, 1500);
    });
};


function formatText(text) {
    if (!text) return '';
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
        const l = lang || 'plaintext';
        return `<pre><div class="code-header"><span class="code-lang">${l}</span><button class="code-copy" onclick="copyCode(this)">Копировать</button></div><code class="language-${l}">${escapeHtml(code.trim())}</code></pre>`;
    });
    return marked.parse(text);
}

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

window.copyCode = function(btn) {
    const code = btn.closest('pre').querySelector('code').textContent;
    navigator.clipboard.writeText(code);
    btn.textContent = 'Скопировано!';
    setTimeout(() => btn.textContent = 'Копировать', 1500);
};

// ===== TYPING =====
function showTyping() {
    headerLogo.classList.add('loading');
    const m = MODELS.find(x => x.id === model);
    const cls = m?.api === 'gemini' ? 'gemini thinking' : m?.api === 'mistral' ? 'mistral' : 'other';
    const icon = m?.api === 'gemini' ? GEMINI_STAR : m?.api === 'mistral' ? MISTRAL_ICON : OTHER_ICON;
    
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.innerHTML = `
        <div class="msg-avatar ${cls}">${icon}</div>
        <div class="typing-bubble">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
    $('typing')?.remove();
    headerLogo.classList.remove('loading');
}

// ===== SEND =====
async function send() {
    const text = input.value.trim();
    const files = [...pendingFiles];
    
    if (!text && files.length === 0) return;
    if (isLoading) return;
    
    const needsKey = (apiMode === 'direct' || apiMode === 'direct_mistral');
    if (needsKey && !apiKey) {
        openModal(settingsModal);
        showNotify('Введите API ключ', true);
        return;
    }
    
    isLoading = true;
    sendBtn.disabled = true;
    
    input.value = '';
    autoResize.call(input);
    clearFile();
    
    let fileData = null;
    let displayUrl = null;
    let displayType = null;
    
    if (files.length > 0) {
        try {
            const videoFile = files.find(f => f.type.startsWith('video/'));
            const imageFiles = files.filter(f => f.type.startsWith('image/'));
            const pdfFile = files.find(f => f.type === 'application/pdf');
            
            if (videoFile) {
                const result = await toBase64(videoFile);
                fileData = {
                    dataUrl: result,
                    base64: result.split(',')[1],
                    mimeType: videoFile.type
                };
                displayUrl = result;
                displayType = videoFile.type;
            } else if (pdfFile) {
                const result = await toBase64(pdfFile);
                fileData = {
                    dataUrl: result,
                    base64: result.split(',')[1],
                    mimeType: pdfFile.type
                };
            } else if (imageFiles.length > 0) {
                const processedImages = [];
                const totalCount = imageFiles.length;
                
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    
                    const tempImg = new Image();
                    const objectUrl = URL.createObjectURL(file);
                    
                    await new Promise((resolve, reject) => {
                        tempImg.onload = resolve;
                        tempImg.onerror = reject;
                        tempImg.src = objectUrl;
                    });
                    
                    URL.revokeObjectURL(objectUrl);
                    
                    let base64Data;
                    
                    if (tempImg.width > CROP_DIMENSION_THRESHOLD || tempImg.height > CROP_DIMENSION_THRESHOLD) {
                        const cropResult = await showCropModal(file, i + 1, totalCount);
                        if (!cropResult) {
                            isLoading = false;
                            sendBtn.disabled = false;
                            return;
                        }
                        base64Data = cropResult.data;
                    } else {
                        base64Data = await toBase64(file);
                    }
                    
                    processedImages.push(base64Data);
                }
                
                let finalImage;
                if (processedImages.length === 1) {
                    finalImage = processedImages[0];
                } else {
                    finalImage = await stitchImagesVertically(processedImages);
                }
                
                const totalSize = Math.round(((finalImage.split(',')[1] || finalImage).length * 3) / 4);
                if (totalSize >= COMPRESS_THRESHOLD_BYTES && compressEnabled) {
                    finalImage = await compressToTargetSize(finalImage, COMPRESS_THRESHOLD_BYTES);
                }
                
                fileData = {
                    dataUrl: finalImage,
                    base64: finalImage.split(',')[1],
                    mimeType: 'image/jpeg'
                };
                displayUrl = finalImage;
                displayType = 'image/jpeg';
            }
        } catch (e) {
            showNotify('Ошибка обработки', true);
            isLoading = false;
            sendBtn.disabled = false;
            return;
        }
    }
    
    const displayText = text || (files.length > 0 ? (displayType?.startsWith('video/') ? '📹 Видео' : `📎 ${files.length} файл(ов)`) : '');
    addMessage('user', displayText, displayUrl, displayType);
    
    const apiText = text || 'Проанализируй этот контент.';
    
    history.push({ role: 'user', text: apiText, file: fileData });
    
    showTyping();
    
    try {
        const response = await callAPI();
        hideTyping();
        
        if (response) {
            addMessage('bot', response);
            history.push({ role: 'bot', text: response });
            
            if (tableMode && response.includes('|')) {
                lastTableHtml = marked.parse(response);
                $('table-content').innerHTML = lastTableHtml;
                openModal(tableModal);
            }
        }
    } catch (e) {
        hideTyping();
        addMessage('bot', `❌ Ошибка: ${e.message}`);
    }
    
    isLoading = false;
    sendBtn.disabled = false;
}



async function callAPI() {
    const m = MODELS.find(x => x.id === model);
    const sysPrompt = tableMode ? TABLE_PROMPT : 'Отвечай на русском языке.';
    
    let url, body, headers = { 'Content-Type': 'application/json' };
    
    if (apiMode === 'mapruapp') {
        url = PROXY_MAP;
        const messages = [{ role: 'system', content: sysPrompt }];
        
        history.forEach(h => {
            if (h.role === 'user') {
                const content = [];
                content.push({ type: 'text', text: h.text });
                if (h.file) {
                    content.push({ type: 'image_url', image_url: { url: h.file.dataUrl } });
                }
                messages.push({ role: 'user', content });
            } else {
                messages.push({ role: 'assistant', content: h.text });
            }
        });
        
        body = { model, messages, max_tokens: 8192 };
        if (m.api === 'qwen') {
            body.provider = 'qwen';
        }
        
    } else if (apiMode === 'vercel' || apiMode === 'direct') {
        url = apiMode === 'direct' 
            ? `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`
            : `${PROXY_VER}/v1beta/models/${model}:generateContent`;
        
        const contents = history.map(h => {
            const parts = [];
            if (h.text) parts.push({ text: h.text });
            if (h.role === 'user' && h.file) {
                parts.push({ inlineData: { mimeType: h.file.mimeType, data: h.file.base64 } });
            }
            return { role: h.role === 'user' ? 'user' : 'model', parts };
        });
        
        body = { contents, systemInstruction: { parts: [{ text: sysPrompt }] } };
        
    } else if (apiMode === 'direct_mistral') {
        url = 'https://api.mistral.ai/v1/chat/completions';
        headers['Authorization'] = `Bearer ${apiKey}`;
        
        const messages = [{ role: 'system', content: sysPrompt }];
        history.forEach(h => {
            if (h.role === 'user') {
                const content = [];
                content.push({ type: 'text', text: h.text });
                if (h.file) content.push({ type: 'image_url', image_url: { url: h.file.dataUrl } });
                messages.push({ role: 'user', content });
            } else {
                messages.push({ role: 'assistant', content: h.text });
            }
        });
        
        body = { model, messages, max_tokens: 8192 };
    }
    
    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
    
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || `HTTP ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.choices) return data.choices[0]?.message?.content || '';
    if (data.candidates) return data.candidates[0]?.content?.parts?.[0]?.text || '';
    return '';
}

// ===== TABLE EXPORT =====
function copyTable() {
    navigator.clipboard.writeText($('table-content').innerText);
    showNotify('Скопировано');
}

function downloadTableHtml() {
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Таблица</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th{background:#667eea;color:white;padding:12px}td{padding:12px;border-bottom:1px solid #eee}tr:hover{background:#f5f5f5}</style></head><body>${lastTableHtml}</body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `table_${Date.now()}.html`;
    a.click();
}

function openTableNewTab() {
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th{background:#667eea;color:white;padding:12px}td{padding:12px;border-bottom:1px solid #eee}</style></head><body>${lastTableHtml}</body></html>`;
    window.open(URL.createObjectURL(new Blob([html], { type: 'text/html' })), '_blank');
}

// ===== UTILS =====
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
    });
}

function autoResize() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
}

function showNotify(msg, isErr = false) {
    notify.textContent = msg;
    notify.className = `notify show ${isErr ? 'error' : ''}`;
    setTimeout(() => notify.classList.remove('show'), 2500);
}

function openModal(m) { m.style.display = 'flex'; }
function closeModal(m) { m.style.display = 'none'; }

function resetChat() {
    history = [];
    chat.innerHTML = '';
    empty.style.display = 'flex';
    chat.appendChild(empty);
    clearFile();
    updateContextSize();
  
}

// ===== START =====
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
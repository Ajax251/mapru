<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="format-detection" content="telephone=no">
    <title>Просмотр PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <link id="favicon" rel="icon" href="https://img.icons8.com/?size=100&id=3IEVgAKImW4C&format=png&color=000000" type="image/png">
    <style>
        :root {
            --primary-color: #e3f2fd;
            --secondary-color: #bbdefb;
            --accent-color: #64b5f6;
            --text-color: #212121;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --fileinfo-bg: #f8f9fa;
            --fileinfo-border: #ced4da;
            --fileinfo-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --control-hover: rgba(255, 255, 255, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #90caf9;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        #viewer {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            scroll-behavior: smooth;
            background-color: var(--secondary-color);
            transition: background-color 0.3s ease;
            position: relative;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        #pdfContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 98%;
            gap: 20px;
            padding-top: 70px;
            padding-bottom: 80px;
            box-sizing: border-box;
        }

        canvas.page-canvas {
            box-shadow: 0 0 20px var(--shadow-color);
            background-color: white;
            transition: box-shadow 0.3s ease, border 0.3s ease;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: block;
            max-width: 100%;
            box-sizing: border-box;
        }

        div.page-placeholder {
            background-color: #e0e0e0;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #757575;
            font-size: 0.9em;
            box-sizing: border-box;
            min-height: 100px;
            max-width: 100%;
        }

        #controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: var(--glass-bg);
            background-color: rgba(255, 255, 255, 0.85);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 10px 15px;
            border-radius: 30px;
            z-index: 10;
            align-items: center;
            transition: all 0.3s ease;
        }

        #controls:hover {
            background-color: var(--control-hover);
            transform: translate(-50%, -2px);
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.5);
        }

        #fileInfo {
            position: fixed;
            bottom: 65px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--fileinfo-bg);
            border: 1px solid var(--fileinfo-border);
            box-shadow: var(--fileinfo-shadow);
            padding: 8px 20px;
            border-radius: 20px;
            min-width: 300px;
            max-width: 80%;
            text-align: center;
            font-size: 14px;
            z-index: 11;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #fullscreenBtn:hover + #fileInfo, #controls:hover #fileInfo {
            opacity: 1;
        }

        #pdfSelector {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: none;
            width: auto;
            max-width: 350px;
            box-sizing: border-box;
        }

        #pdfSelector select {
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer;
            display: block;
            width: 100%;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            -webkit-appearance: none;
            appearance: none;
        }

        #pdfSelector select:focus {
            box-shadow: none;
        }

        .btn {
            background-color: transparent;
            border: none;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--glass-border);
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        #upload { display: none; }

        #startScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-color);
            text-align: center;
            background-color: var(--primary-color);
            transition: background-color 0.3s ease;
        }

        #dropArea {
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 40px;
            width: 300px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #dropArea p {
            margin: 10px 0;
            color: var(--text-color);
        }

        #dropArea:hover {
            background-color: var(--secondary-color);
            border-color: var(--accent-color);
            box-shadow: 0 6px 12px var(--shadow-color);
            transform: translateY(-5px);
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #openBtn {
            margin-top: 15px;
            background-color: transparent;
        }

        .highlighted {
            background-color: var(--secondary-color);
            border-color: var(--accent-color);
        }

        #fullscreenBtn {
            position: relative;
        }

        #pageInfo {
            color: var(--text-color);
            padding: 0 5px;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: var(--accent-color);
            display: none;
            z-index: 300;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #thumbnailOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #thumbnailViewArea {
            width: 90%;
            height: 90%;
            background-color: var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #thumbnailViewActions {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 101;
        }

        #closeThumbnailViewBtn {
            position: static;
            font-size: 2.5em;
            width: auto;
            height: auto;
            border-radius: 50%;
            padding: 0 8px;
            line-height: 1;
        }

        .thumbnail-action-btn {
            background: rgba(255, 255, 255, 0.7);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .thumbnail-action-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }

        #mergePdfsBtn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: rgba(200, 200, 200, 0.5);
        }

        #thumbnailContainer {
            flex-grow: 1;
            overflow-y: auto;
            display: grid;
            gap: 15px;
            padding: 10px;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        #thumbnailContainer::-webkit-scrollbar { width: 8px; height: 8px; }
        #thumbnailContainer::-webkit-scrollbar-track { background: var(--primary-color); border-radius: 10px; }
        #thumbnailContainer::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; border: 2px solid var(--primary-color); }
        #thumbnailContainer::-webkit-scrollbar-thumb:hover { background-color: #4a90e2; }

        .thumbnail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: var(--secondary-color);
            box-sizing: border-box;
        }

        .thumbnail-item:hover {
            border-color: var(--accent-color);
            background-color: var(--glass-bg);
        }

        .thumbnail-item.current-thumbnail {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .thumbnail-canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            background-color: white;
            display: block;
            border-radius: 2px;
        }

        .thumbnail-pagenum {
            font-size: 0.8em;
            margin-top: 8px;
            color: var(--text-color);
            text-align: center;
        }

        .thumbnail-pdf-separator {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            margin: 10px 0 5px 0;
            color: var(--text-color);
            overflow: hidden;
        }

        .thumbnail-pdf-separator::before,
        .thumbnail-pdf-separator::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background-color: var(--accent-color);
            margin: 0 10px;
        }

        .thumbnail-pdf-separator-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
            padding: 0 5px;
            box-sizing: border-box;
        }

        .thumbnail-pdf-error {
            grid-column: 1 / -1;
            text-align: center;
            color: red;
            padding: 5px 0;
        }

        #tooltipPreview {
            position: fixed;
            z-index: 250;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 5px;
            pointer-events: none;
            opacity: 0;
            max-width: 85vw;
            max-height: 85vh;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #tooltipPreview.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        #tooltipCanvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        #tooltipSpinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #mergeModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        #mergeModal {
            background: var(--primary-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #mergeModal h2 {
            margin-top: 0;
            color: var(--text-color);
        }

        #mergeModal p {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 20px;
        }

        #mergeFileList {
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 20px;
            background: var(--secondary-color);
            border-radius: 8px;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .merge-file-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            border-radius: 4px;
            margin-bottom: 5px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .merge-file-item:last-child {
            border-bottom: none;
        }

        .merge-file-item.dragging {
            opacity: 0.5;
            background-color: var(--accent-color);
        }

        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: #777;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .merge-file-name {
            font-size: 1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .merge-page-range-input {
            width: 120px;
            padding: 5px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }

        .merge-page-count {
            font-size: 0.85em;
            color: #666;
            min-width: 70px;
            text-align: right;
        }

        #mergeModalActions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        #mergeModalActions .btn {
            padding: 8px 20px;
            width: auto;
            height: auto;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #cancelMergeBtn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }

        #cancelMergeBtn:hover {
            background: var(--secondary-color);
            color: var(--text-color);
        }

        #executeMergeBtn {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
        }

        #executeMergeBtn:hover {
            background: #4a90e2;
            border-color: #4a90e2;
        }

        #mergeModalActions .btn .icon {
            width: 18px;
            height: 18px;
        }

        /* Mobile fixes */
        @media (max-width: 600px) {
            #pdfSelector {
                left: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
            }

            #controls {
                padding: 8px 10px;
                gap: 6px;
            }

            .btn {
                width: 36px;
                height: 36px;
            }

            .icon {
                width: 20px;
                height: 20px;
            }

            #mergeModal {
                padding: 15px;
                width: 95%;
            }

            .merge-file-item {
                grid-template-columns: auto 1fr auto;
            }

            .merge-page-count {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="startScreen">
            <div id="dropArea">
                <p>Открыть PDF или ZIP</p>
                <button class="btn" id="openBtn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div id="viewer" style="display: none;">
            <div id="pdfSelector">
                <select id="pdfSelectDropdown"></select>
            </div>
            <div id="pdfContainer"></div>
        </div>
        <div class="loading-indicator">Загрузка...</div>

        <div id="controls" style="display: none;">
            <button class="btn" id="openFile">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
            </button>
            <button class="btn" id="prevPage">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <div id="pageInfo">0/0</div>
            <button class="btn" id="nextPage">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
            <button class="btn" id="thumbnailToggleBtn" title="Показать эскизы">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
                </svg>
            </button>
            <button class="btn" id="toggleFit">
                <svg class="icon" id="fitIcon" viewBox="0 0 24 24">
                    <path d="M19 12h-2v3h-3v2h5v-5zM7 9h3V7H5v5h2V9zm14-6H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16.01H3V4.99h18v14.02z"/>
                </svg>
            </button>
            <button class="btn" id="fullscreenBtn">
                <svg class="icon" id="fullscreenIcon" viewBox="0 0 24 24">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                <div id="fileInfo"></div>
            </button>
        </div>

        <input type="file" id="upload" accept="application/pdf,application/zip,application/x-zip-compressed" multiple />
    </div>

    <div id="thumbnailOverlay">
        <div id="thumbnailViewArea">
            <div id="thumbnailViewActions">
                <button id="mergePdfsBtn" class="btn thumbnail-action-btn" title="Объединить PDF">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M17 20.41L18.41 19 15 15.59 13.59 17 17 20.41zM7.5 8H11v5.59L5.59 19 7 20.41l6-6V8h3.5L12 3.5 7.5 8z"/></svg>
                </button>
                <button id="closeThumbnailViewBtn" class="thumbnail-action-btn" title="Закрыть эскизы">×</button>
            </div>
            <div id="thumbnailContainer"></div>
        </div>
    </div>

    <div id="tooltipPreview">
        <div id="tooltipSpinner"></div>
        <canvas id="tooltipCanvas"></canvas>
    </div>

    <div id="mergeModalOverlay">
        <div id="mergeModal">
            <h2>Объединить PDF</h2>
            <p>Укажите диапазоны страниц для каждого файла (например: 1-5 7 9-10). Оставьте поле пустым, чтобы включить все страницы.</p>
            <div id="mergeFileList"></div>
            <div id="mergeModalActions">
                <button id="cancelMergeBtn" class="btn">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    Отмена
                </button>
                <button id="executeMergeBtn" class="btn">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg>
                    Объединить
                </button>
            </div>
        </div>
    </div>

    <script>
        // Polyfill for older browsers
        if (typeof Symbol === 'undefined' || typeof Symbol.iterator === 'undefined') {
            console.error('Browser does not support ES6 features');
        }

        // Check for required APIs
        (function() {
            var missingFeatures = [];
            if (typeof Promise === 'undefined') missingFeatures.push('Promise');
            if (typeof Map === 'undefined') missingFeatures.push('Map');
            if (typeof Set === 'undefined') missingFeatures.push('Set');
            if (!window.IntersectionObserver) missingFeatures.push('IntersectionObserver');

            if (missingFeatures.length > 0) {
                console.warn('Missing features: ' + missingFeatures.join(', '));
            }
        })();

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        var pdfDoc = null;
        var pageNum = 1;
        var canvasMap = new Map();
        var renderTaskMap = new Map();
        var fitMode = 'width';
        var isFullscreen = false;
        var observer = null;
        var resizeTimeout;

        var currentFile = null;
        var extractedPdfs = new Map();
        var originalFilesMap = new Map();
        var currentArchiveName = '';
        var currentFilesMode = null;

        var thumbnailsGenerated = false;
        var tooltipPdfDocCache = new Map();
        var tooltipCurrentPdfName = null;
        var draggedItem = null;

        function debounce(func, delay) {
            var timeout;
            return function() {
                var context = this;
                var args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }

        // Safe Map iteration helper for older browsers
        function mapForEach(map, callback) {
            if (map.forEach) {
                map.forEach(callback);
            } else {
                var keys = [];
                var iterator = map.keys();
                var result = iterator.next();
                while (!result.done) {
                    keys.push(result.value);
                    result = iterator.next();
                }
                for (var i = 0; i < keys.length; i++) {
                    callback(map.get(keys[i]), keys[i], map);
                }
            }
        }

        // Safe Array.from alternative
        function mapToArray(map) {
            var arr = [];
            if (map.forEach) {
                map.forEach(function(value, key) {
                    arr.push([key, value]);
                });
            } else {
                var iterator = map.entries();
                var result = iterator.next();
                while (!result.done) {
                    arr.push(result.value);
                    result = iterator.next();
                }
            }
            return arr;
        }

        function getMapKeys(map) {
            var keys = [];
            if (map.forEach) {
                map.forEach(function(value, key) {
                    keys.push(key);
                });
            } else if (map.keys) {
                var iterator = map.keys();
                var result = iterator.next();
                while (!result.done) {
                    keys.push(result.value);
                    result = iterator.next();
                }
            }
            return keys;
        }

        document.addEventListener('DOMContentLoaded', function() {
            var uploadInput = document.getElementById('upload');
            if (uploadInput) uploadInput.multiple = true;

            document.getElementById('openBtn').addEventListener('click', function() {
                document.getElementById('upload').click();
            });
            document.getElementById('openFile').addEventListener('click', function() {
                document.getElementById('upload').click();
            });
            document.getElementById('prevPage').addEventListener('click', onPrevPage);
            document.getElementById('nextPage').addEventListener('click', onNextPage);
            document.getElementById('upload').addEventListener('change', handleFileSelect);
            document.getElementById('toggleFit').addEventListener('click', toggleFitMode);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('pdfSelectDropdown').addEventListener('change', function(event) {
                handlePdfSelectionChange(event);
            });
            document.getElementById('thumbnailToggleBtn').addEventListener('click', toggleThumbnailView);
            document.getElementById('closeThumbnailViewBtn').addEventListener('click', hideThumbnailView);

            document.getElementById('mergePdfsBtn').addEventListener('click', showMergeModal);
            document.getElementById('cancelMergeBtn').addEventListener('click', hideMergeModal);
            document.getElementById('executeMergeBtn').addEventListener('click', executeMerge);
            document.getElementById('mergeModalOverlay').addEventListener('click', function(e) {
                if (e.target.id === 'mergeModalOverlay') {
                    hideMergeModal();
                }
            });

            document.getElementById('thumbnailOverlay').addEventListener('click', function(e) {
                if (e.target === document.getElementById('thumbnailOverlay')) {
                    hideThumbnailView();
                }
            });

            var tooltipPreview = document.getElementById('tooltipPreview');
            tooltipPreview.addEventListener('click', function(e) {
                e.stopPropagation();
                hideTooltipPreview();
            });

            document.addEventListener('click', function() {
                if (tooltipPreview.classList.contains('visible')) {
                    hideTooltipPreview();
                }
            });

            var dropArea = document.getElementById('dropArea');
            var container = document.getElementById('container');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
                dropArea.addEventListener(eventName, preventDefaults, false);
                container.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(function(eventName) {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(function(eventName) {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);
            container.addEventListener('drop', handleDrop, false);

            document.addEventListener('keydown', function(e) {
                var thumbOverlay = document.getElementById('thumbnailOverlay');
                if (thumbOverlay.style.display === 'flex' && e.key === 'Escape') {
                    hideThumbnailView();
                    return;
                }
                if (pdfDoc && !e.target.closest('select') && !e.target.closest('input') && thumbOverlay.style.display !== 'flex') {
                    if (e.key === 'ArrowRight' || e.key === ' ') onNextPage();
                    else if (e.key === 'ArrowLeft') onPrevPage();
                }
            });

            window.addEventListener('resize', debounce(handleResize, 250));

            ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(function(event) {
                document.addEventListener(event, updateFullscreenIcon);
            });

            // Drag and Drop for Merge List
            var mergeFileList = document.getElementById('mergeFileList');

            mergeFileList.addEventListener('dragstart', function(e) {
                if (e.target.classList && e.target.classList.contains('merge-file-item')) {
                    draggedItem = e.target;
                    setTimeout(function() {
                        if (draggedItem) draggedItem.classList.add('dragging');
                    }, 0);
                }
            });

            mergeFileList.addEventListener('dragend', function(e) {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });

            mergeFileList.addEventListener('dragover', function(e) {
                e.preventDefault();
                var afterElement = getDragAfterElement(mergeFileList, e.clientY);
                var currentDragged = document.querySelector('.dragging');
                if (currentDragged) {
                    if (afterElement == null) {
                        mergeFileList.appendChild(currentDragged);
                    } else {
                        mergeFileList.insertBefore(currentDragged, afterElement);
                    }
                }
            });

            // Touch support for drag
            mergeFileList.addEventListener('touchstart', handleTouchStart, {passive: false});
            mergeFileList.addEventListener('touchmove', handleTouchMove, {passive: false});
            mergeFileList.addEventListener('touchend', handleTouchEnd, {passive: false});

            updateFitIcon();
        });

        var touchStartY = 0;
        var touchedItem = null;

        function handleTouchStart(e) {
            var handle = e.target.closest('.drag-handle');
            if (handle) {
                var item = handle.closest('.merge-file-item');
                if (item) {
                    touchedItem = item;
                    touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                }
            }
        }

        function handleTouchMove(e) {
            if (!touchedItem) return;
            e.preventDefault();

            var mergeFileList = document.getElementById('mergeFileList');
            var touchY = e.touches[0].clientY;
            var afterElement = getDragAfterElement(mergeFileList, touchY);

            if (afterElement == null) {
                mergeFileList.appendChild(touchedItem);
            } else {
                mergeFileList.insertBefore(touchedItem, afterElement);
            }
        }

        function handleTouchEnd(e) {
            if (touchedItem) {
                touchedItem.classList.remove('dragging');
                touchedItem = null;
            }
        }

        function getDragAfterElement(container, y) {
            var draggableElements = Array.prototype.slice.call(
                container.querySelectorAll('.merge-file-item:not(.dragging)')
            );

            var closest = {offset: Number.NEGATIVE_INFINITY, element: null};

            draggableElements.forEach(function(child) {
                var box = child.getBoundingClientRect();
                var offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    closest = {offset: offset, element: child};
                }
            });

            return closest.element;
        }

        function handleResize() {
            updatePlaceholders();
            adjustAllPages();
            if (document.getElementById('thumbnailOverlay').style.display === 'flex') {
                var container = document.getElementById('thumbnailContainer');
                var currentContainerWidth = container.clientWidth;
                if (currentContainerWidth > 0) {
                    thumbnailsGenerated = false;
                    _calculateGridAndRenderThumbnails(currentContainerWidth);
                }
            }
        }

        function toggleFullscreen() {
            var docEl = document.documentElement;
            var requestFullScreen = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
            var exitFullScreen = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;

            if (!isFullscreen) {
                if (requestFullScreen) {
                    try {
                        requestFullScreen.call(docEl);
                    } catch (err) {
                        console.error('Fullscreen error:', err);
                    }
                }
            } else {
                if (exitFullScreen) {
                    try {
                        exitFullScreen.call(document);
                    } catch (err) {
                        console.error('Exit fullscreen error:', err);
                    }
                }
            }
        }

        function updateFullscreenIcon() {
            isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            var fullscreenIcon = document.getElementById('fullscreenIcon');
            if (fullscreenIcon) {
                fullscreenIcon.innerHTML = isFullscreen
                    ? '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>'
                    : '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
            }
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            document.getElementById('dropArea').classList.add('highlighted');
        }

        function unhighlight() {
            document.getElementById('dropArea').classList.remove('highlighted');
        }

        function handleDrop(e) {
            unhighlight();
            var files = e.dataTransfer.files;
            if (files && files.length > 0) {
                processFileList(files);
            }
        }

        function handleFileSelect(event) {
            var files = event.target.files;
            if (files && files.length > 0) {
                processFileList(files);
            }
            event.target.value = null;
        }

        function processFileList(fileList) {
            if (!fileList || fileList.length === 0) return;

            thumbnailsGenerated = false;
            var thumbnailContainer = document.getElementById('thumbnailContainer');
            if (thumbnailContainer) {
                thumbnailContainer.innerHTML = '';
            }

            showLoading(true);
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('viewer').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('pdfSelector').style.display = 'none';

            extractedPdfs.clear();
            originalFilesMap.clear();
            tooltipPdfDocCache.clear();
            currentArchiveName = '';
            currentFile = null;
            pdfDoc = null;
            updatePageCounter();

            if (fileList.length === 1) {
                var file = fileList[0];
                currentFile = file;
                currentArchiveName = file.name;
                updateFileInfo(file);

                var fileReader = new FileReader();
                fileReader.onload = function(event) {
                    var data = event.target.result;
                    var fileName = file.name.toLowerCase();

                    if (file.type === 'application/zip' || file.type === 'application/x-zip-compressed' || fileName.endsWith('.zip')) {
                        currentFilesMode = 'zip';
                        handleZipFile(data, file.name);
                    } else if (file.type === 'application/pdf' || fileName.endsWith('.pdf')) {
                        currentFilesMode = 'single_pdf';
                        var pdfDataUint8 = new Uint8Array(data);
                        extractedPdfs.set(file.name, pdfDataUint8);
                        originalFilesMap.set(file.name, file);
                        loadPdf(pdfDataUint8, file.name);
                        document.getElementById('pdfSelector').style.display = 'none';
                    } else {
                        showError('Unsupported file type: ' + (file.type || 'unknown') + ' for file ' + file.name);
                        showLoading(false);
                    }
                };
                fileReader.onerror = function() {
                    showError('Error reading file: ' + file.name);
                    showLoading(false);
                };
                fileReader.readAsArrayBuffer(file);

            } else {
                currentFilesMode = 'multiple_files';
                currentArchiveName = "Multiple Files";
                updateFileInfo(null);

                var pdfFilesFromList = [];
                for (var i = 0; i < fileList.length; i++) {
                    var f = fileList[i];
                    if (f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')) {
                        pdfFilesFromList.push(f);
                    }
                }

                if (pdfFilesFromList.length === 0) {
                    showError("No PDF files found in the selection.");
                    showLoading(false);
                    return;
                }

                pdfFilesFromList.sort(function(a, b) {
                    return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
                });

                processMultiplePdfs(pdfFilesFromList);
            }
        }

        function processMultiplePdfs(pdfFiles) {
            var processed = 0;
            var total = pdfFiles.length;

            pdfFiles.forEach(function(pdfFile) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var pdfDataUint8 = new Uint8Array(e.target.result);
                    extractedPdfs.set(pdfFile.name, pdfDataUint8);
                    originalFilesMap.set(pdfFile.name, pdfFile);

                    processed++;
                    if (processed === total) {
                        var pdfNames = pdfFiles.map(function(f) { return f.name; });
                        populatePdfSelector(pdfNames);
                        document.getElementById('pdfSelector').style.display = 'block';
                        showThumbnailView();
                        showLoading(false);
                    }
                };
                reader.onerror = function() {
                    processed++;
                    console.error("Error reading: " + pdfFile.name);
                    if (processed === total) {
                        showLoading(false);
                    }
                };
                reader.readAsArrayBuffer(pdfFile);
            });
        }

        function handleZipFile(data, zipFileName) {
            currentArchiveName = zipFileName;
            currentFilesMode = 'zip';
            thumbnailsGenerated = false;

            var thumbnailContainer = document.getElementById('thumbnailContainer');
            if (thumbnailContainer) {
                thumbnailContainer.innerHTML = '';
            }

            var zip = new JSZip();

            var decodeFilename = function(bytes) {
                try {
                    return new TextDecoder("utf-8", {fatal: true}).decode(bytes);
                } catch (e) {
                    try {
                        return new TextDecoder("cp866", {fatal: true}).decode(bytes);
                    } catch (e2) {
                        try {
                            return new TextDecoder("windows-1251", {fatal: true}).decode(bytes);
                        } catch (e3) {
                            return new TextDecoder().decode(bytes);
                        }
                    }
                }
            };

            zip.loadAsync(data, {decodeFileName: decodeFilename}).then(function(loadedZip) {
                var pdfFiles = [];
                loadedZip.forEach(function(relativePath, zipEntry) {
                    if (!zipEntry.dir && zipEntry.name.toLowerCase().endsWith('.pdf')) {
                        pdfFiles.push(zipEntry);
                    }
                });

                if (pdfFiles.length === 0) {
                    showError("No PDF files found in the ZIP archive.");
                    showLoading(false);
                    return;
                }

                pdfFiles.sort(function(a, b) {
                    return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
                });

                extractedPdfs.clear();

                var loadCount = 0;
                pdfFiles.forEach(function(pdfFile) {
                    pdfFile.async("uint8array").then(function(pdfDataArray) {
                        extractedPdfs.set(pdfFile.name, pdfDataArray);
                        loadCount++;

                        if (loadCount === pdfFiles.length) {
                            var pdfNames = pdfFiles.map(function(f) { return f.name; });
                            populatePdfSelector(pdfNames);
                            document.getElementById('pdfSelector').style.display = 'block';
                            showThumbnailView();
                            showLoading(false);
                        }
                    }).catch(function(err) {
                        console.error("Error extracting: " + pdfFile.name, err);
                        loadCount++;
                        if (loadCount === pdfFiles.length) {
                            showLoading(false);
                        }
                    });
                });

            }).catch(function(error) {
                console.error("Error processing ZIP file:", error);
                showError("Could not read the ZIP file. It might be corrupted or in an unsupported format.");
                showLoading(false);
            });
        }

        function populatePdfSelector(pdfNames) {
            var select = document.getElementById('pdfSelectDropdown');
            if (!select) return;
            select.innerHTML = '';
            pdfNames.forEach(function(name) {
                var option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function handlePdfSelectionChange(event, targetPageNum) {
            targetPageNum = targetPageNum || 1;
            var selectedPdfName = event.target.value;
            if (extractedPdfs.has(selectedPdfName)) {
                showLoading(true);
                thumbnailsGenerated = false;
                tooltipPdfDocCache.clear();
                var thumbContainer = document.getElementById('thumbnailContainer');
                if (thumbContainer) thumbContainer.innerHTML = '';

                var pdfData = extractedPdfs.get(selectedPdfName);
                loadPdf(copyUint8Array(pdfData), selectedPdfName, targetPageNum).then(function(loadedPdfDoc) {
                    if (loadedPdfDoc) {
                        setTimeout(function() {
                            scrollToPage(pageNum);
                        }, 100);
                    }
                }).catch(function(err) {
                    console.error("Error in PDF selection change load: ", err);
                    showError('Failed to load selected PDF: ' + selectedPdfName);
                });
            }
        }

        function copyUint8Array(arr) {
            if (!arr) return null;
            var copy = new Uint8Array(arr.length);
            copy.set(arr);
            return copy;
        }

        function updateFileInfo(fileObj, pdfNameInZip) {
            var fileInfoElement = document.getElementById('fileInfo');
            if (!fileInfoElement) return;

            var fileNameToShow = '';
            var fileDate = '-';
            var fileSize = '-';

            if (currentFilesMode === 'single_pdf') {
                fileNameToShow = currentArchiveName;
                if (fileObj) {
                    try {
                        fileDate = new Date(fileObj.lastModified).toLocaleDateString();
                        fileSize = formatFileSize(fileObj.size);
                    } catch (e) {}
                }
            } else if (currentFilesMode === 'zip') {
                if (pdfNameInZip) {
                    fileNameToShow = currentArchiveName + ' > ' + pdfNameInZip;
                } else {
                    fileNameToShow = currentArchiveName;
                }
                if (currentFile && currentFile.name === currentArchiveName) {
                    try {
                        fileDate = new Date(currentFile.lastModified).toLocaleDateString();
                        fileSize = formatFileSize(currentFile.size);
                    } catch(e) {}
                }
            } else if (currentFilesMode === 'multiple_files') {
                if (pdfNameInZip) {
                    fileNameToShow = currentArchiveName + ' > ' + pdfNameInZip;
                    var originalPdfFile = originalFilesMap.get(pdfNameInZip);
                    if (originalPdfFile) {
                        try {
                            fileDate = new Date(originalPdfFile.lastModified).toLocaleDateString();
                            fileSize = formatFileSize(originalPdfFile.size);
                        } catch (e) {}
                    }
                } else {
                    fileNameToShow = currentArchiveName;
                    if (originalFilesMap.size > 0) {
                        fileSize = originalFilesMap.size + ' PDF(s)';
                    } else {
                        fileSize = '0 PDFs';
                    }
                }
            } else if (fileObj) {
                fileNameToShow = fileObj.name;
                try {
                    fileDate = new Date(fileObj.lastModified).toLocaleDateString();
                    fileSize = formatFileSize(fileObj.size);
                } catch (e) {}
            } else {
                fileNameToShow = currentArchiveName || "No file loaded";
            }

            var infoText = fileNameToShow + ' | ' + fileDate + ' | ' + fileSize;
            fileInfoElement.textContent = infoText;
            fileInfoElement.title = infoText;
        }

        function formatFileSize(bytes) {
            if (bytes === undefined || bytes === null || isNaN(bytes)) return '-';
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showLoading(isLoading) {
            var indicator = document.querySelector('.loading-indicator');
            if (indicator) indicator.style.display = isLoading ? 'block' : 'none';
        }

        function loadPdf(data, pdfName, initialPageNum) {
            initialPageNum = initialPageNum || 1;

            if (observer) observer.disconnect();
            canvasMap.clear();
            mapForEach(renderTaskMap, function(task) {
                if (task && typeof task.cancel === 'function') task.cancel();
            });
            renderTaskMap.clear();

            var pdfContainer = document.getElementById('pdfContainer');
            if (pdfContainer) pdfContainer.innerHTML = '';

            pdfDoc = null;
            pageNum = initialPageNum > 0 ? initialPageNum : 1;
            thumbnailsGenerated = false;

            var thumbnailContainer = document.getElementById('thumbnailContainer');
            if (thumbnailContainer) {
                thumbnailContainer.innerHTML = '';
            }

            tooltipPdfDocCache.clear();
            updatePageCounter();
            showLoading(true);

            var pdfDataUint8 = (data instanceof Uint8Array) ? data : new Uint8Array(data);

            return pdfjsLib.getDocument({data: copyUint8Array(pdfDataUint8)}).promise.then(function(pdf) {
                pdfDoc = pdf;
                tooltipPdfDocCache.set(pdfName, pdfDoc);
                if (pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
                if (pageNum < 1) pageNum = 1;
                updatePageCounter();
                createPagePlaceholders();
                setupObserver();

                if (currentFilesMode === 'single_pdf') {
                    updateFileInfo(currentFile, null);
                } else if (currentFilesMode === 'zip') {
                    updateFileInfo(currentFile, pdfName);
                } else if (currentFilesMode === 'multiple_files') {
                    updateFileInfo(null, pdfName);
                }

                showLoading(false);
                setTimeout(function() {
                    triggerInitialRenders();
                }, 50);
                return pdf;
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                showError('Failed to load PDF \'' + pdfName + '\': ' + (error.message || error));
                showLoading(false);
                throw error;
            });
        }

        function showError(message) {
            var viewer = document.getElementById('viewer');
            if (!viewer) return;
            var errorDiv = document.createElement('div');
            errorDiv.style.color = 'red';
            errorDiv.style.backgroundColor = 'rgba(255, 200, 200, 0.8)';
            errorDiv.style.border = '1px solid darkred';
            errorDiv.style.padding = '20px';
            errorDiv.style.margin = '20px auto';
            errorDiv.style.maxWidth = '80%';
            errorDiv.style.textAlign = 'center';
            errorDiv.textContent = message;
            var pdfContainer = document.getElementById('pdfContainer');
            if (pdfContainer) pdfContainer.innerHTML = '';
            else viewer.innerHTML = '';
            if (pdfContainer) pdfContainer.appendChild(errorDiv);
            else viewer.appendChild(errorDiv);
            var controls = document.getElementById('controls');
            if (controls) controls.style.display = 'none';
            var pdfSelector = document.getElementById('pdfSelector');
            if (pdfSelector) pdfSelector.style.display = 'none';
            pdfDoc = null;
            pageNum = 1;
            updatePageCounter();
            showLoading(false);
        }

        function updatePageCounter() {
            var pageInfo = document.getElementById('pageInfo');
            if (!pageInfo) return;
            var totalPages = pdfDoc ? pdfDoc.numPages : 0;
            var currentPage = pdfDoc ? pageNum : 0;
            pageInfo.textContent = currentPage + '/' + totalPages;
        }

        function adjustAllPages() {
            if (!pdfDoc) return;
            updatePlaceholders();
            mapForEach(canvasMap, function(canvas, pageNumber) {
                if (document.body.contains(canvas)) {
                    renderPage(pageNumber, null);
                } else {
                    canvasMap.delete(pageNumber);
                }
            });
            if (observer) {
                var viewer = document.getElementById('viewer');
                if (!viewer) return;
                var viewerRect = viewer.getBoundingClientRect();
                var placeholders = document.querySelectorAll('.page-placeholder');
                for (var i = 0; i < placeholders.length; i++) {
                    var placeholder = placeholders[i];
                    var placeholderRect = placeholder.getBoundingClientRect();
                    if (placeholderRect.top < viewerRect.bottom && placeholderRect.bottom > viewerRect.top) {
                        var pn = parseInt(placeholder.dataset.pageNumber, 10);
                        if (!canvasMap.has(pn) && !renderTaskMap.has(pn)) {
                            renderPage(pn, placeholder);
                        }
                    }
                }
            }
        }

        function toggleFitMode() {
            fitMode = fitMode === 'width' ? 'height' : 'width';
            updateFitIcon();
            if (pdfDoc) {
                adjustAllPages();
            }
        }

        function updateFitIcon() {
            var fitIcon = document.getElementById('fitIcon');
            if (!fitIcon) return;
            var isHeightFit = fitMode === 'height';
            fitIcon.innerHTML = isHeightFit
                ? '<path d="M10 4H8v4H4v2h6V4zm6 16h2v-4h4v-2h-6v6zm-8-2H4v-4H2v6h6v-2zM18 8V4h-2v6h6V8h-4z"/>'
                : '<path d="M19 12h-2v3h-3v2h5v-5zM7 9h3V7H5v5h2V9zm14-6H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16.01H3V4.99h18v14.02z"/>';
            var toggleButton = document.getElementById('toggleFit');
            if (toggleButton) {
                if (isHeightFit) {
                    toggleButton.classList.add('active');
                } else {
                    toggleButton.classList.remove('active');
                }
            }
        }

        function createPagePlaceholders() {
            var pdfContainer = document.getElementById('pdfContainer');
            if (!pdfContainer || !pdfDoc) return;
            pdfContainer.innerHTML = '';
            for (var i = 1; i <= pdfDoc.numPages; i++) {
                var placeholder = document.createElement('div');
                placeholder.classList.add('page-placeholder');
                placeholder.id = 'placeholder-' + i;
                placeholder.dataset.pageNumber = i;
                pdfContainer.appendChild(placeholder);
            }
            updatePlaceholders();
        }

        function updatePlaceholders() {
            if (!pdfDoc) return;
            var viewer = document.getElementById('viewer');
            var pdfContainer = document.getElementById('pdfContainer');
            if (!viewer || !pdfContainer) return;

            var containerWidth = pdfContainer.clientWidth;
            if (containerWidth <= 0) containerWidth = viewer.clientWidth * 0.98;

            var controlsHeight = 60;
            var controlsEl = document.getElementById('controls');
            if (controlsEl) controlsHeight = controlsEl.offsetHeight || 60;

            var selectorHeight = 0;
            var selectorEl = document.getElementById('pdfSelector');
            if (selectorEl && selectorEl.style.display !== 'none' && selectorEl.offsetParent !== null) {
                selectorHeight = (selectorEl.offsetHeight || 0) + 20;
            }
            var containerHeight = viewer.clientHeight - controlsHeight - selectorHeight - 20;

            var placeholders = document.querySelectorAll('.page-placeholder');

            var updatePromises = [];
            for (var i = 0; i < placeholders.length; i++) {
                (function(placeholder) {
                    var pn = parseInt(placeholder.dataset.pageNumber, 10);
                    if (!canvasMap.has(pn)) {
                        var promise = pdfDoc.getPage(pn).then(function(page) {
                            var viewport = page.getViewport({scale: 1});
                            var scale;
                            if (fitMode === 'width') {
                                scale = containerWidth / viewport.width;
                            } else {
                                scale = containerHeight / viewport.height;
                                if (viewport.width * scale > containerWidth) {
                                    scale = containerWidth / viewport.width;
                                }
                            }
                            scale = Math.max(0.1, scale);

                            var scaledHeight = Math.max(50, viewport.height * scale);
                            var scaledWidth = Math.max(50, viewport.width * scale);

                            placeholder.style.height = Math.floor(scaledHeight) + 'px';
                            placeholder.style.width = Math.floor(scaledWidth) + 'px';
                            placeholder.style.maxWidth = '100%';
                        }).catch(function(error) {
                            console.error('Error getting page ' + pn + ' info for placeholder:', error);
                            placeholder.style.height = '200px';
                            placeholder.style.width = '150px';
                        });
                        updatePromises.push(promise);
                    }
                })(placeholders[i]);
            }
        }

        function renderPage(num, placeholderElement) {
            if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;

            pdfDoc.getPage(num).then(function(page) {
                var viewer = document.getElementById('viewer');
                var pdfContainer = document.getElementById('pdfContainer');
                if (!viewer || !pdfContainer) return;

                var containerWidth = pdfContainer.clientWidth;
                if (containerWidth <= 0) containerWidth = viewer.clientWidth * 0.98;

                var controlsHeight = 60;
                var controlsEl = document.getElementById('controls');
                if (controlsEl) controlsHeight = controlsEl.offsetHeight || 60;

                var selectorHeight = 0;
                var selectorEl = document.getElementById('pdfSelector');
                if (selectorEl && selectorEl.style.display !== 'none' && selectorEl.offsetParent !== null) {
                    selectorHeight = (selectorEl.offsetHeight || 0) + 20;
                }
                var containerHeight = viewer.clientHeight - controlsHeight - selectorHeight - 20;

                var viewport = page.getViewport({scale: 1});
                var scale;
                if (fitMode === 'width') {
                    scale = containerWidth / viewport.width;
                } else {
                    scale = containerHeight / viewport.height;
                    if (viewport.width * scale > containerWidth) {
                        scale = containerWidth / viewport.width;
                    }
                }
                scale = Math.max(0.1, scale);

                var outputScale = (window.devicePixelRatio || 1) * scale;
                var scaledViewport = page.getViewport({scale: outputScale});

                var canvas = canvasMap.get(num);
                var isExistingCanvas = !!canvas;

                if (!canvas) {
                    canvas = document.createElement('canvas');
                    canvas.id = 'page-' + num;
                    canvas.classList.add('page-canvas');
                    canvas.dataset.pageNumber = num;
                    canvasMap.set(num, canvas);
                    canvas.addEventListener('click', function() {
                        if (pdfDoc && num !== pageNum) {
                            pageNum = num;
                            updatePageCounter();
                            highlightCurrentPage();
                            if (document.getElementById('thumbnailOverlay').style.display === 'flex') {
                                highlightCurrentThumbnailInOverlay();
                            }
                        }
                    });
                }

                var existingTask = renderTaskMap.get(num);
                if (existingTask && typeof existingTask.cancel === 'function') existingTask.cancel();

                var canvasWidth = Math.floor(scaledViewport.width);
                var canvasHeight = Math.floor(scaledViewport.height);

                if (canvas.width !== canvasWidth || canvas.height !== canvasHeight) {
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                }
                canvas.style.width = Math.floor(canvasWidth / (window.devicePixelRatio || 1)) + 'px';
                canvas.style.height = Math.floor(canvasHeight / (window.devicePixelRatio || 1)) + 'px';
                canvas.style.maxWidth = '100%';

                var actualPlaceholder = placeholderElement || document.getElementById('placeholder-' + num);

                var ctx = canvas.getContext('2d', {alpha: false});
                var renderContext = {canvasContext: ctx, viewport: scaledViewport};
                var renderTask = page.render(renderContext);
                renderTaskMap.set(num, renderTask);

                renderTask.promise.then(function() {
                    if (actualPlaceholder && actualPlaceholder.parentNode === pdfContainer) {
                        pdfContainer.replaceChild(canvas, actualPlaceholder);
                    } else if (!isExistingCanvas && !document.getElementById(canvas.id)) {
                        var stillExistingPlaceholder = document.getElementById('placeholder-' + num);
                        if (stillExistingPlaceholder && stillExistingPlaceholder.parentNode === pdfContainer) {
                            pdfContainer.replaceChild(canvas, stillExistingPlaceholder);
                        }
                    }
                    highlightCurrentPage();
                    renderTaskMap.delete(num);
                }).catch(function(error) {
                    renderTaskMap.delete(num);
                    if (error.name !== 'RenderingCancelledException') {
                        console.error('Error rendering page ' + num + ':', error);
                        if (actualPlaceholder) {
                            actualPlaceholder.textContent = 'Error: ' + error.message;
                            actualPlaceholder.style.color = 'red';
                        }
                    }
                });
            }).catch(function(error) {
                console.error('Failed to get page ' + num + ':', error);
                var actualPlaceholder = placeholderElement || document.getElementById('placeholder-' + num);
                if (actualPlaceholder) {
                    actualPlaceholder.textContent = 'Error loading page ' + num;
                    actualPlaceholder.style.color = 'red';
                }
            });
        }

        function highlightCurrentPage() {
            mapForEach(canvasMap, function(canvas) {
                if (document.body.contains(canvas)) {
                    canvas.style.border = '1px solid var(--border-color)';
                    canvas.style.boxShadow = '0 0 20px var(--shadow-color)';
                }
            });
            var currentCanvas = canvasMap.get(pageNum);
            if (currentCanvas && document.body.contains(currentCanvas)) {
                currentCanvas.style.border = '2px solid var(--accent-color)';
                currentCanvas.style.boxShadow = '0 0 20px var(--accent-color)';
            }
        }

        function setupObserver() {
            if (observer) observer.disconnect();
            var viewer = document.getElementById('viewer');
            if (!viewer) return;

            if (!window.IntersectionObserver) {
                // Fallback for browsers without IntersectionObserver
                console.warn('IntersectionObserver not supported, using fallback');
                setTimeout(function() {
                    for (var i = 1; i <= (pdfDoc ? pdfDoc.numPages : 0); i++) {
                        var placeholder = document.getElementById('placeholder-' + i);
                        if (placeholder && !canvasMap.has(i)) {
                            renderPage(i, placeholder);
                        }
                    }
                }, 100);
                return;
            }

            var options = {root: viewer, rootMargin: '500px 0px 500px 0px', threshold: 0.01};

            var intersectionCallback = function(entries) {
                entries.forEach(function(entry) {
                    var targetElement = entry.target;
                    var pn = parseInt(targetElement.dataset.pageNumber, 10);
                    if (entry.isIntersecting) {
                        if (targetElement.classList.contains('page-placeholder') && !canvasMap.has(pn) && !renderTaskMap.has(pn)) {
                            renderPage(pn, targetElement);
                        }
                    }
                });
            };
            observer = new IntersectionObserver(intersectionCallback, options);
            var placeholders = document.querySelectorAll('.page-placeholder');
            for (var i = 0; i < placeholders.length; i++) {
                observer.observe(placeholders[i]);
            }
        }

        function triggerInitialRenders() {
            if (!pdfDoc) return;
            var viewer = document.getElementById('viewer');
            if (!viewer) return;
            if (pageNum < 1) pageNum = 1;
            if (pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
            updatePageCounter();

            var currentPlaceholder = document.getElementById('placeholder-' + pageNum);
            if (currentPlaceholder && !canvasMap.has(pageNum) && !renderTaskMap.has(pageNum)) {
                renderPage(pageNum, currentPlaceholder);
            }

            var viewerRect = viewer.getBoundingClientRect();
            var placeholders = document.querySelectorAll('.page-placeholder');
            for (var i = 0; i < placeholders.length; i++) {
                var p = placeholders[i];
                var pRect = p.getBoundingClientRect();
                if (pRect.bottom > viewerRect.top - 500 && pRect.top < viewerRect.bottom + 500) {
                    var pn = parseInt(p.dataset.pageNumber, 10);
                    if (!canvasMap.has(pn) && !renderTaskMap.has(pn)) {
                        renderPage(pn, p);
                    }
                }
            }
            highlightCurrentPage();
        }

        function onPrevPage() {
            if (!pdfDoc || pageNum <= 1) return;
            pageNum--;
            scrollToPage(pageNum);
            updatePageCounter();
            highlightCurrentPage();
            if (document.getElementById('thumbnailOverlay').style.display === 'flex') {
                highlightCurrentThumbnailInOverlay();
            }
        }

        function onNextPage() {
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            scrollToPage(pageNum);
            updatePageCounter();
            highlightCurrentPage();
            if (document.getElementById('thumbnailOverlay').style.display === 'flex') {
                highlightCurrentThumbnailInOverlay();
            }
        }

        function scrollToPage(pageNumber) {
            var targetElement = canvasMap.get(pageNumber) || document.getElementById('placeholder-' + pageNumber);
            if (targetElement && document.body.contains(targetElement)) {
                var viewer = document.getElementById('viewer');
                var selector = document.getElementById('pdfSelector');
                var selectorHeight = (selector && selector.offsetParent !== null && selector.style.display !== 'none') ? selector.offsetHeight + 15 : 0;
                var viewerRect = viewer.getBoundingClientRect();
                var targetRect = targetElement.getBoundingClientRect();
                var scrollTop = viewer.scrollTop + (targetRect.top - viewerRect.top) - selectorHeight - 10;
                viewer.scrollTo({top: scrollTop, behavior: 'smooth'});
            }
        }

        function toggleThumbnailView() {
            var overlay = document.getElementById('thumbnailOverlay');
            if (overlay.style.display === 'flex') {
                hideThumbnailView();
            } else {
                showThumbnailView();
            }
        }

        function showThumbnailView() {
            if (extractedPdfs.size === 0) {
                console.warn("No content loaded to show thumbnails.");
                return;
            }

            var overlay = document.getElementById('thumbnailOverlay');
            overlay.style.display = 'flex';

            var mergeBtn = document.getElementById('mergePdfsBtn');
            if (extractedPdfs.size >= 2) {
                mergeBtn.disabled = false;
            } else {
                mergeBtn.disabled = true;
            }

            if (!thumbnailsGenerated) {
                var container = document.getElementById('thumbnailContainer');
                setTimeout(function() {
                    var currentContainerWidth = container.clientWidth;
                    if (currentContainerWidth === 0) {
                        _calculateGridAndRenderThumbnails(500);
                    } else {
                        _calculateGridAndRenderThumbnails(currentContainerWidth);
                    }
                }, 50);
            } else {
                highlightCurrentThumbnailInOverlay();
                scrollToCurrentThumbnail();
            }
        }

        function scrollToCurrentThumbnail() {
            var currentSelectedPdfNameInDropdown = null;
            var dropdown = document.getElementById('pdfSelectDropdown');
            if ((currentFilesMode === 'zip' || currentFilesMode === 'multiple_files') && dropdown) {
                currentSelectedPdfNameInDropdown = dropdown.value;
            }

            var currentThumb;
            if (currentSelectedPdfNameInDropdown) {
                currentThumb = document.querySelector('.thumbnail-item[data-pdf-name="' + currentSelectedPdfNameInDropdown + '"][data-page-number="' + pageNum + '"]');
            } else {
                currentThumb = document.querySelector('.thumbnail-item[data-page-number="' + pageNum + '"]');
            }
            if (currentThumb) {
                currentThumb.scrollIntoView({behavior: 'auto', block: 'center', inline: 'center'});
            }
        }

        function _calculateGridAndRenderThumbnails(containerWidth) {
            var thumbnailGridContainer = document.getElementById('thumbnailContainer');
            var MAX_COLS = 8;
            var DESIRED_THUMB_CANVAS_WIDTH = 150;
            var GAP = 15;
            var ITEM_LR_PADDING = 8 * 2;

            var fullItemDesiredWidth = DESIRED_THUMB_CANVAS_WIDTH + ITEM_LR_PADDING;
            var numCols = Math.floor((containerWidth + GAP) / (fullItemDesiredWidth + GAP));
            numCols = Math.min(MAX_COLS, Math.max(1, numCols));

            thumbnailGridContainer.style.gridTemplateColumns = 'repeat(' + numCols + ', 1fr)';
            var trackWidth = (containerWidth - (numCols - 1) * GAP) / numCols;
            var actualCanvasMaxWidth = Math.max(50, trackWidth - ITEM_LR_PADDING);

            _executePopulateThumbnails(actualCanvasMaxWidth);
        }

        function _executePopulateThumbnails(renderCanvasMaxWidth) {
            if (extractedPdfs.size === 0) {
                console.warn("No document data available for thumbnails.");
                showLoading(false);
                return;
            }
            showLoading(true);
            var container = document.getElementById('thumbnailContainer');
            container.innerHTML = '';

            var sortedPdfNames = getMapKeys(extractedPdfs).sort(function(a, b) {
                return a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'});
            });

            var totalToProcess = 0;
            var processedCount = 0;

            // Count total pages first
            var pageCountPromises = [];
            sortedPdfNames.forEach(function(pdfName) {
                var pdfData = extractedPdfs.get(pdfName);
                if (pdfData) {
                    var cachedDoc = tooltipPdfDocCache.get(pdfName);
                    if (cachedDoc) {
                        totalToProcess += cachedDoc.numPages;
                    } else {
                        var promise = pdfjsLib.getDocument({data: copyUint8Array(pdfData)}).promise.then(function(doc) {
                            tooltipPdfDocCache.set(pdfName, doc);
                            totalToProcess += doc.numPages;
                        }).catch(function() {});
                        pageCountPromises.push(promise);
                    }
                }
            });

            Promise.all(pageCountPromises).then(function() {
                // Now render thumbnails
                processNextPdf(0);
            });

            function processNextPdf(index) {
                if (index >= sortedPdfNames.length) {
                    thumbnailsGenerated = true;
                    highlightCurrentThumbnailInOverlay();
                    scrollToCurrentThumbnail();
                    showLoading(false);
                    return;
                }

                var pdfName = sortedPdfNames[index];
                var pdfData = extractedPdfs.get(pdfName);
                if (!pdfData) {
                    processNextPdf(index + 1);
                    return;
                }

                if (currentFilesMode === 'zip' || currentFilesMode === 'multiple_files') {
                    var separator = document.createElement('div');
                    separator.className = 'thumbnail-pdf-separator';
                    var separatorText = document.createElement('span');
                    separatorText.className = 'thumbnail-pdf-separator-text';
                    separatorText.textContent = pdfName;
                    separatorText.title = pdfName;
                    separator.appendChild(separatorText);
                    container.appendChild(separator);
                }

                var tempPdfDoc = tooltipPdfDocCache.get(pdfName);
                if (tempPdfDoc) {
                    renderPdfThumbnails(tempPdfDoc, pdfName, function() {
                        processNextPdf(index + 1);
                    });
                } else {
                    pdfjsLib.getDocument({data: copyUint8Array(pdfData)}).promise.then(function(doc) {
                        tooltipPdfDocCache.set(pdfName, doc);
                        renderPdfThumbnails(doc, pdfName, function() {
                            processNextPdf(index + 1);
                        });
                    }).catch(function(error) {
                        console.error('Error loading PDF ' + pdfName + ' for thumbnails:', error);
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'thumbnail-pdf-error';
                        errorDiv.textContent = 'Error loading ' + pdfName + ' for thumbnails.';
                        container.appendChild(errorDiv);
                        processNextPdf(index + 1);
                    });
                }
            }

            function renderPdfThumbnails(doc, pdfName, onComplete) {
                var pageIndex = 0;
                var totalPages = doc.numPages;

                function renderNextPage() {
                    if (pageIndex >= totalPages) {
                        onComplete();
                        return;
                    }

                    pageIndex++;
                    createAndRenderThumbnail(doc, pdfName, pageIndex, container, renderCanvasMaxWidth).then(function() {
                        renderNextPage();
                    }).catch(function() {
                        renderNextPage();
                    });
                }

                renderNextPage();
            }
        }

        function hideThumbnailView() {
            var overlay = document.getElementById('thumbnailOverlay');
            overlay.style.display = 'none';
            if (!pdfDoc) {
                document.getElementById('startScreen').style.display = 'flex';
                document.getElementById('viewer').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
            }
        }

        function createAndRenderThumbnail(pdfDocumentInstance, pdfName, thumbPageNum, parentContainer, renderCanvasMaxWidth) {
            return new Promise(function(resolve, reject) {
                var item = document.createElement('div');
                item.classList.add('thumbnail-item');
                item.dataset.pageNumber = thumbPageNum;
                item.dataset.pdfName = pdfName;

                var canvas = document.createElement('canvas');
                canvas.classList.add('thumbnail-canvas');

                var pageNumDiv = document.createElement('div');
                pageNumDiv.classList.add('thumbnail-pagenum');
                pageNumDiv.textContent = thumbPageNum;

                item.appendChild(canvas);
                item.appendChild(pageNumDiv);
                parentContainer.appendChild(item);

                var clickTimer = null;

                item.addEventListener('click', function(e) {
                    clearTimeout(clickTimer);
                    clickTimer = setTimeout(function() {
                        e.stopPropagation();
                        var pageToPreview = parseInt(item.dataset.pageNumber, 10);
                        var pdfNameToPreview = item.dataset.pdfName;
                        showTooltipPreview(pdfNameToPreview, pageToPreview, e.clientX || e.touches && e.touches[0] && e.touches[0].clientX || window.innerWidth / 2, e.clientY || e.touches && e.touches[0] && e.touches[0].clientY || window.innerHeight / 2);
                    }, 250);
                });

                item.addEventListener('dblclick', function() {
                    clearTimeout(clickTimer);

                    var pageToOpen = parseInt(item.dataset.pageNumber, 10);
                    var pdfNameToOpen = item.dataset.pdfName;

                    if (extractedPdfs.has(pdfNameToOpen)) {
                        showLoading(true);
                        var selector = document.getElementById('pdfSelectDropdown');
                        if (selector) {
                            selector.value = pdfNameToOpen;
                        }

                        var pdfData = extractedPdfs.get(pdfNameToOpen);
                        loadPdf(copyUint8Array(pdfData), pdfNameToOpen, pageToOpen).then(function() {
                            hideTooltipPreview();
                            hideThumbnailView();
                        }).catch(function(error) {
                            console.error("Failed to open document from thumbnail double-click:", error);
                        }).finally(function() {
                            showLoading(false);
                        });
                    }
                });

                pdfDocumentInstance.getPage(thumbPageNum).then(function(page) {
                    var viewport = page.getViewport({scale: 1});
                    var scale = renderCanvasMaxWidth / viewport.width;
                    var outputScale = (window.devicePixelRatio || 1) * scale;
                    var scaledViewport = page.getViewport({scale: outputScale});

                    canvas.width = Math.floor(scaledViewport.width);
                    canvas.height = Math.floor(scaledViewport.height);
                    canvas.style.width = Math.floor(scaledViewport.width / (window.devicePixelRatio || 1)) + 'px';
                    canvas.style.height = Math.floor(scaledViewport.height / (window.devicePixelRatio || 1)) + 'px';

                    var ctx = canvas.getContext('2d', {alpha: false});
                    var renderContext = {canvasContext: ctx, viewport: scaledViewport};
                    page.render(renderContext).promise.then(function() {
                        resolve();
                    }).catch(function(error) {
                        console.error('Error rendering thumbnail for page ' + thumbPageNum + ' of ' + pdfName + ':', error);
                        canvas.style.display = 'none';
                        pageNumDiv.textContent = 'Err P.' + thumbPageNum;
                        pageNumDiv.style.color = 'red';
                        resolve();
                    });
                }).catch(function(error) {
                    console.error('Error getting page ' + thumbPageNum + ' for thumbnail:', error);
                    canvas.style.display = 'none';
                    pageNumDiv.textContent = 'Err P.' + thumbPageNum;
                    pageNumDiv.style.color = 'red';
                    resolve();
                });
            });
        }

        function highlightCurrentThumbnailInOverlay() {
            if (!pdfDoc) return;
            var currentSelectedPdfNameInDropdown = null;
            var dropdown = document.getElementById('pdfSelectDropdown');
            if ((currentFilesMode === 'zip' || currentFilesMode === 'multiple_files') && dropdown) {
                currentSelectedPdfNameInDropdown = dropdown.value;
            }

            var thumbnails = document.querySelectorAll('.thumbnail-item');
            for (var i = 0; i < thumbnails.length; i++) {
                var thumb = thumbnails[i];
                thumb.classList.remove('current-thumbnail');
                var thumbPage = parseInt(thumb.dataset.pageNumber, 10);
                var thumbPdfName = thumb.dataset.pdfName;

                if (currentSelectedPdfNameInDropdown) {
                    if (thumbPdfName === currentSelectedPdfNameInDropdown && thumbPage === pageNum) {
                        thumb.classList.add('current-thumbnail');
                    }
                } else if (currentFilesMode === 'single_pdf') {
                    if (thumbPdfName === currentArchiveName && thumbPage === pageNum) {
                        thumb.classList.add('current-thumbnail');
                    }
                }
            }
        }

        function getPdfDocForTooltip(pdfName) {
            return new Promise(function(resolve, reject) {
                if (tooltipPdfDocCache.has(pdfName)) {
                    resolve(tooltipPdfDocCache.get(pdfName));
                    return;
                }
                if (extractedPdfs.has(pdfName)) {
                    var pdfData = extractedPdfs.get(pdfName);
                    pdfjsLib.getDocument({data: copyUint8Array(pdfData)}).promise.then(function(doc) {
                        tooltipPdfDocCache.set(pdfName, doc);
                        resolve(doc);
                    }).catch(function(e) {
                        console.error("Failed to load PDF for tooltip", e);
                        resolve(null);
                    });
                } else {
                    resolve(null);
                }
            });
        }

        function showTooltipPreview(pdfName, previewPageNum, mouseX, mouseY) {
            tooltipCurrentPdfName = pdfName;
            var tooltip = document.getElementById('tooltipPreview');
            var canvas = document.getElementById('tooltipCanvas');
            var spinner = document.getElementById('tooltipSpinner');

            spinner.style.display = 'block';
            canvas.style.display = 'none';
            tooltip.classList.add('visible');

            tooltip.style.left = mouseX + 20 + 'px';
            tooltip.style.top = mouseY + 20 + 'px';

            getPdfDocForTooltip(pdfName).then(function(doc) {
                if (!doc) throw new Error("Could not get document");

                return doc.getPage(previewPageNum).then(function(page) {
                    var viewport = page.getViewport({scale: 1});

                    var maxPreviewWidth = window.innerWidth * 0.85;
                    var maxPreviewHeight = window.innerHeight * 0.85;

                    var scaleX = maxPreviewWidth / viewport.width;
                    var scaleY = maxPreviewHeight / viewport.height;
                    var scale = Math.min(scaleX, scaleY);

                    var scaledViewport = page.getViewport({scale: scale});

                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;

                    var ctx = canvas.getContext('2d');
                    return page.render({canvasContext: ctx, viewport: scaledViewport}).promise.then(function() {
                        spinner.style.display = 'none';
                        canvas.style.display = 'block';

                        var rect = tooltip.getBoundingClientRect();

                        var newX = mouseX - rect.width / 2;
                        var newY = mouseY - rect.height / 2;

                        if (newX + rect.width > window.innerWidth) {
                            newX = window.innerWidth - rect.width - 10;
                        }
                        if (newY + rect.height > window.innerHeight) {
                            newY = window.innerHeight - rect.height - 10;
                        }
                        if (newX < 10) {
                            newX = 10;
                        }
                        if (newY < 10) {
                            newY = 10;
                        }

                        tooltip.style.left = newX + 'px';
                        tooltip.style.top = newY + 'px';
                    });
                });
            }).catch(function(error) {
                console.error("Error showing tooltip preview:", error);
                hideTooltipPreview();
            });
        }

        function hideTooltipPreview() {
            var tooltip = document.getElementById('tooltipPreview');
            tooltip.classList.remove('visible');
            tooltipCurrentPdfName = null;
        }

        // --- PDF MERGE FUNCTIONS ---

        function showMergeModal() {
            if (extractedPdfs.size < 2) {
                alert("Для объединения необходимо как минимум два PDF файла.");
                return;
            }
            showLoading(true);
            var modalOverlay = document.getElementById('mergeModalOverlay');
            var fileListContainer = document.getElementById('mergeFileList');
            fileListContainer.innerHTML = '';

            var sortedPdfNames = getMapKeys(extractedPdfs).sort(function(a, b) {
                return a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'});
            });

            var processed = 0;
            sortedPdfNames.forEach(function(pdfName) {
                getPdfDocForTooltip(pdfName).then(function(doc) {
                    if (!doc) {
                        processed++;
                        if (processed === sortedPdfNames.length) {
                            showLoading(false);
                            modalOverlay.style.display = 'flex';
                        }
                        return;
                    }
                    var pageCount = doc.numPages;

                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'merge-file-item';
                    itemDiv.draggable = true;
                    itemDiv.dataset.pdfName = pdfName;
                    itemDiv.dataset.maxPages = pageCount;

                    var handle = document.createElement('div');
                    handle.className = 'drag-handle';
                    handle.innerHTML = '<svg class="icon" style="width:20px; height:20px;" viewBox="0 0 24 24"><path d="M3 15h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V9H3v2zm0-6v2h18V5H3z"/></svg>';

                    var nameSpan = document.createElement('span');
                    nameSpan.className = 'merge-file-name';
                    nameSpan.textContent = pdfName.split('/').pop();
                    nameSpan.title = pdfName;

                    var rangeInput = document.createElement('input');
                    rangeInput.type = 'text';
                    rangeInput.className = 'merge-page-range-input';
                    rangeInput.placeholder = '1-' + pageCount;

                    var countSpan = document.createElement('span');
                    countSpan.className = 'merge-page-count';
                    countSpan.textContent = '(Всего: ' + pageCount + ')';

                    itemDiv.appendChild(handle);
                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(rangeInput);
                    itemDiv.appendChild(countSpan);
                    fileListContainer.appendChild(itemDiv);

                    processed++;
                    if (processed === sortedPdfNames.length) {
                        showLoading(false);
                        modalOverlay.style.display = 'flex';
                    }
                }).catch(function() {
                    processed++;
                    if (processed === sortedPdfNames.length) {
                        showLoading(false);
                        modalOverlay.style.display = 'flex';
                    }
                });
            });
        }

        function hideMergeModal() {
            document.getElementById('mergeModalOverlay').style.display = 'none';
        }

        function parsePageRanges(rangeStr, maxPage) {
            var pageSet = {};
            if (!rangeStr.trim()) {
                for (var i = 1; i <= maxPage; i++) pageSet[i] = true;
                return Object.keys(pageSet).map(function(k) { return parseInt(k, 10); });
            }

            var parts = rangeStr.replace(/,/g, ' ').split(/\s+/);

            for (var j = 0; j < parts.length; j++) {
                var part = parts[j];
                var trimmedPart = part.trim();
                if (trimmedPart === '') continue;

                if (trimmedPart.indexOf('-') !== -1) {
                    var rangeParts = trimmedPart.split('-');
                    var start = parseInt(rangeParts[0], 10);
                    var end = parseInt(rangeParts[1], 10);
                    if (!isNaN(start) && !isNaN(end) && start <= end && start > 0 && end <= maxPage) {
                        for (var k = start; k <= end; k++) {
                            pageSet[k] = true;
                        }
                    }
                } else {
                    var pn = parseInt(trimmedPart, 10);
                    if (!isNaN(pn) && pn > 0 && pn <= maxPage) {
                        pageSet[pn] = true;
                    }
                }
            }
            return Object.keys(pageSet).map(function(k) { return parseInt(k, 10); }).sort(function(a, b) { return a - b; });
        }

        function executeMerge() {
            showLoading(true);

            var PDFDocument = PDFLib.PDFDocument;
            PDFDocument.create().then(function(mergedPdf) {
                var fileItems = document.querySelectorAll('.merge-file-item');
                var itemsArray = Array.prototype.slice.call(fileItems);

                function processNextItem(index) {
                    if (index >= itemsArray.length) {
                        // All items processed
                        if (mergedPdf.getPageCount() === 0) {
                            alert("Не выбрано ни одной страницы для объединения.");
                            showLoading(false);
                            return;
                        }

                        mergedPdf.save().then(function(mergedPdfBytes) {
                            var blob = new Blob([mergedPdfBytes], {type: 'application/pdf'});
                            var url = URL.createObjectURL(blob);

                            var a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = 'merged_document.pdf';
                            document.body.appendChild(a);
                            a.click();
                            URL.revokeObjectURL(url);
                            a.remove();

                            hideMergeModal();
                            showLoading(false);
                        }).catch(function(error) {
                            console.error("Failed to save merged PDF:", error);
                            alert('Ошибка при сохранении PDF: ' + error.message);
                            showLoading(false);
                        });
                        return;
                    }

                    var item = itemsArray[index];
                    var pdfName = item.dataset.pdfName;
                    var maxPages = parseInt(item.dataset.maxPages, 10);
                    var rangeInput = item.querySelector('.merge-page-range-input');
                    var rangeString = rangeInput.value;

                    var pagesToInclude = parsePageRanges(rangeString, maxPages);
                    if (pagesToInclude.length === 0) {
                        processNextItem(index + 1);
                        return;
                    }

                    var pageIndices = pagesToInclude.map(function(n) { return n - 1; });
                    var sourcePdfBytes = extractedPdfs.get(pdfName);

                    PDFDocument.load(sourcePdfBytes).then(function(sourcePdf) {
                        return mergedPdf.copyPages(sourcePdf, pageIndices).then(function(copiedPages) {
                            copiedPages.forEach(function(page) {
                                mergedPdf.addPage(page);
                            });
                            processNextItem(index + 1);
                        });
                    }).catch(function(error) {
                        console.error("Error processing " + pdfName + ":", error);
                        processNextItem(index + 1);
                    });
                }

                processNextItem(0);

            }).catch(function(error) {
                console.error("Failed to merge PDFs:", error);
                alert('Произошла ошибка при объединении PDF: ' + error.message);
                showLoading(false);
            });
        }
    </script>
</body>
</html>
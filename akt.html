<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä "–ê–∫—Ç–∞ –≤—ã–Ω–æ—Å–∞ –≥—Ä–∞–Ω–∏—Ü"</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="webfonts/index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    
    <style>
        /* --- –°—Ç–∏–ª–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .app-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 2fr; gap: 30px; height: calc(100vh - 40px); }
        .control-panel { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; overflow-y: auto; }
        .document-preview { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .preview-header { padding: 20px 30px; border-bottom: 2px solid #f0f2f5; display: flex; justify-content: space-between; align-items: center; background: #fafbfc; flex-shrink: 0; }
        .preview-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
        .document-content { flex-grow: 1; overflow-y: auto; padding: 30px; background-color: #f0f2f5; }
        .form-section { margin-bottom: 25px; }
        .section-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #3498db; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: #34495e; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: #fafbfc; }
        .form-group input:focus, .form-group textarea:focus { border-color: #3498db; background: white; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .form-group textarea { min-height: 120px; resize: vertical; font-family: 'Consolas', 'Courier New', monospace; }
        .hint { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 30px; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2); }
        .btn-success { background: linear-gradient(135deg, #27ae60, #219a52); color: white; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.2); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2); }
        .btn-info { background: linear-gradient(135deg, #34b3db, #299fb9); color: white; box-shadow: 0 4px 15px rgba(52, 179, 219, 0.2); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2); grid-column: 1 / -1; }
        #printableDocument { background: white; font-family: 'Times New Roman', Times, serif; font-size: 14pt; line-height: 1.5; color: #333; padding: 2cm; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); width: 21cm; height: 29.7cm; outline: none; overflow: auto;}
        .status-indicator { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #27ae60; color: white; border-radius: 25px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; pointer-events: none; }
        .status-indicator.show { opacity: 1; transform: translateY(0); } .status-indicator.error { background-color: #e74c3c; }
        .ai-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; } .ai-modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 800px; position: relative; } .ai-modal-close-button { position: absolute; top: 10px; right: 15px; font-size: 32px; font-weight: bold; color: #888; cursor: pointer; } #ai-data-input { width: 100%; height: 25vh; } #ai-modal-loading { text-align: center; display: none; }
        .image-previews-wrapper { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; } .ai-modal-image-preview-container { text-align: center; display: none; position: relative; border: 1px solid #ddd; border-radius: 5px; padding: 5px; } .ai-modal-image-preview { max-width: 300px; max-height: 120px; border-radius: 3px; } .ai-modal-clear-image { position: absolute; top: -8px; right: -8px; background: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #e74c3c; box-shadow: 0 0 5px rgba(0,0,0,0.2); font-weight: bold; }
        @media print { @page { size: A4 portrait; margin: 0; } body { background: none; margin: 0; padding: 0; } .control-panel, .preview-header, .status-indicator, .ai-modal-overlay { display: none !important; } .app-container, .document-preview, .document-content { display: block !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; } #printableDocument { box-shadow: none !important; margin: 0 !important; width: 21cm; height: 29.7cm; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="control-panel">
            <div class="form-section">
                <div class="section-title"><i class="fas fa-file-alt"></i> –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
                <div class="form-group"><label for="city">–ì–æ—Ä–æ–¥:</label><input type="text" id="city" placeholder="–≥. –ú–æ—Å–∫–≤–∞"></div>
                <div class="form-group"><label for="cadastralNumber">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä (–ö–ù):</label><input type="text" id="cadastralNumber" placeholder="16:56:010104:147"></div>
                 <div class="form-group"><label for="address">–ê–¥—Ä–µ—Å —É—á–∞—Å—Ç–∫–∞:</label><textarea id="address" placeholder="–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è, ..."></textarea></div>
            </div>
             <div class="form-section">
                <div class="section-title"><i class="fas fa-ruler-horizontal"></i> –î–∞–Ω–Ω—ã–µ –æ —Ä–∞–±–æ—Ç–∞—Ö</div>
                 <div class="form-group"><label for="adjacentCadastralNumbers">–°–º–µ–∂–Ω—ã–µ –ö–ù (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label><input type="text" id="adjacentCadastralNumbers" placeholder="16:56:010104:148, 16:56:010104:105"></div>
                 <div class="form-group"><label for="basisDocument">–î–æ–∫—É–º–µ–Ω—Ç-–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</label><input type="text" id="basisDocument" placeholder="–ö–£–í–ò-001/2023-149786770 –æ—Ç 29.06.2023"></div>
                 <div class="form-group"><label for="signCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ (—Ü–∏—Ñ—Ä–æ–π –∏ –ø—Ä–æ–ø–∏—Å—å—é):</label><input type="text" id="signCount" placeholder="5 (–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å)"></div>
            </div>
             <div class="form-section">
                <div class="section-title"><i class="fas fa-compass"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫</div>
                <div class="form-group"><label for="coordinates">–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ù–∞–∑–≤–∞–Ω–∏–µ X Y):</label><textarea id="coordinates" placeholder="–Ω1 325979.12 2218354.41"></textarea><div class="hint">–ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å - –ø—Ä–æ–±–µ–ª –∏–ª–∏ —Ç–∞–±.</div></div>
            </div>
             <div class="form-section">
                <div class="section-title"><i class="fas fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                <div class="form-group"><label for="performingOrganization">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:</label><input type="text" id="performingOrganization" placeholder=""></div>
                <div class="form-group"><label for="specialistFio">–§.–ò.–û. —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞:</label><input type="text" id="specialistFio" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></div>
                <div class="form-group"><label for="specialistTitle">–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞:</label><input type="text" id="specialistTitle" placeholder="–ì–µ–æ–¥–µ–∑–∏—Å—Ç"></div>
                <div class="form-group"><label for="workDate">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç:</label><input type="text" id="workDate" placeholder="22.09.2025"></div>
                <div class="form-group"><label for="rightHolderFio">–§.–ò.–û. –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—è (–∑–∞–∫–∞–∑—á–∏–∫–∞):</label><input type="text" id="rightHolderFio" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü."></div>
                <div class="form-group"><label for="directorFio">–§.–ò.–û. –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞:</label><input type="text" id="directorFio" placeholder="–°–∏–¥–æ—Ä–æ–≤ –°.–°."></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-info" onclick="openAiModal()"><i class="fas fa-atom"></i> AI-–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                <button class="btn btn-primary" onclick="generateDocx()"><i class="fas fa-file-word"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ DOCX</button>
                <button class="btn btn-success" onclick="printDocument()"><i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å (PDF)</button>
                <button class="btn btn-warning" onclick="exportToJPG()"><i class="fas fa-file-image"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ JPG</button>
                <button class="btn btn-danger" onclick="clearData()"><i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <div class="document-preview">
            <div class="preview-header"><div class="preview-title">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</div></div>
            <div class="document-content"><div id="printableDocument"></div></div>
        </div>
    </div>

    <!-- Modals and Indicators -->
    <div class="status-indicator" id="statusIndicator"></div>
    <div id="aiDataExtractorModal" class="ai-modal-overlay" style="display: none;"><div class="ai-modal-content"><span class="ai-modal-close-button" onclick="closeAiModal()">&times;</span><h2>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</h2><div id="ai-modal-loading"><i class="fas fa-spinner fa-spin"></i><p id="ai-loading-status">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...</p></div><div id="ai-modal-form"><div class="image-previews-wrapper"><div id="ai-modal-image-preview-container-1" class="ai-modal-image-preview-container"><img id="ai-modal-image-preview-1" class="ai-modal-image-preview" src="#" alt="Image 1"/><span class="ai-modal-clear-image" onclick="clearAiImage(0)">&times;</span></div></div><textarea id="ai-data-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –≤—ã–ø–∏—Å–∫—É –ï–ì–†–ù –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..."></textarea><button id="ai-modal-submit" class="btn btn-primary" onclick="submitToAI()"><i class="fas fa-cogs"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å</button></div></div></div>
    <div id="crop-image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:10001; justify-content:center; align-items:center; flex-direction: column;"><div style="background-color:white; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; overflow:auto; text-align:center;"><h3 style="margin-top:0;">–û–±—Ä–µ–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3><p style="font-size:0.9em; color:#555;">–ù–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ–±–ª–∞—Å—Ç—å.</p><div id="crop-image-container" style="position:relative; display:inline-block; border:1px dashed #ccc; user-select:none; touch-action:none; max-width:100%; max-height:calc(85vh - 120px); overflow:hidden; cursor:crosshair;"><img id="crop-image-preview" src="#" alt="Preview" style="display:block; max-width:100%; max-height:100%; user-select:none; -webkit-user-drag:none;" /><div id="crop-selection-rectangle" style="position:absolute; border:2px solid rgba(0,123,255,0.7); background-color:rgba(0,123,255,0.1); display:none; pointer-events:none;"></div></div><div style="margin-top:15px; display: flex; justify-content: center; gap: 15px;"><button id="crop-image-button-confirm" style="padding:10px 20px; background-color:#4CAF50; color:white; border:none; border-radius:8px; cursor:pointer; font-size: 1rem;"><i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button><button id="crop-image-button-cancel" style="padding:10px 20px; background-color:#f44336; color:white; border:none; border-radius:8px; cursor:pointer; font-size: 1rem;"><i class="fas fa-times"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—ë</button></div></div></div>
    
    <script>
        // --- CONSTANTS AND DATA MANAGEMENT ---
        const STORAGE_KEY = 'aktVynosaGranitsData_v2_anon';
        const formInputIds = [
            'city', 'cadastralNumber', 'address', 'adjacentCadastralNumbers', 
            'basisDocument', 'signCount', 'coordinates', 'performingOrganization',
            'specialistFio', 'specialistTitle', 'workDate', 'rightHolderFio', 'directorFio'
        ];
        function saveData() { const data = {}; formInputIds.forEach(id => { const element = document.getElementById(id); if (element) data[id] = element.value.trim(); }); localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
        function loadData() { const savedData = localStorage.getItem(STORAGE_KEY); if (savedData) { const data = JSON.parse(savedData); formInputIds.forEach(id => { const element = document.getElementById(id); if (element && data[id] !== undefined) { element.value = data[id]; } }); showStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'); } }
        function clearData() { if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è?')) { formInputIds.forEach(id => { const element = document.getElementById(id); if (element) element.value = ''; }); saveData(); updatePreview(); showStatus('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', false); } }

        // --- –ü–û–õ–ù–´–ô –ö–û–î –°–ï–ö–¶–ò–ò –õ–û–ì–ò–ö–ò –ò–ò ---
        const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
        const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
        const PROXY_MODE = 1; 
        let aiInputImages = [];
        const MAX_IMAGES = 1;
        
        function openAiModal() { document.getElementById('aiDataExtractorModal').style.display = 'flex'; }
        function closeAiModal() { document.getElementById('aiDataExtractorModal').style.display = 'none'; document.getElementById('ai-modal-form').style.display = 'block'; document.getElementById('ai-modal-loading').style.display = 'none'; clearAiImage(-1); }
        function clearAiImage(index) { if (index === -1) { aiInputImages = []; for(let i=1; i <= MAX_IMAGES; i++) { document.getElementById(`ai-modal-image-preview-container-${i}`).style.display = 'none'; document.getElementById(`ai-modal-image-preview-${i}`).src = '#'; } } else { if (aiInputImages[index]) { aiInputImages.splice(index, 1); redrawImages(); } } }
        function redrawImages() { for(let i=0; i < MAX_IMAGES; i++) { const c = document.getElementById(`ai-modal-image-preview-container-${i+1}`); const img = document.getElementById(`ai-modal-image-preview-${i+1}`); if (aiInputImages[i]) { img.src = aiInputImages[i]; c.style.display = 'block'; } else { c.style.display = 'none'; } } }
        
        async function submitToAI() {
            const textInput = document.getElementById('ai-data-input').value.trim();
            if (aiInputImages.length === 0 && textInput === '') { showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.', true); return; }
            document.getElementById('ai-modal-form').style.display = 'none'; document.getElementById('ai-modal-loading').style.display = 'block'; const loadingStatus = document.getElementById('ai-loading-status');
            try {
                let combinedText = textInput;
                if (aiInputImages.length > 0) { loadingStatus.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...`; const ocrText = await performOcrForImage(aiInputImages[0]); combinedText += "\n\n" + ocrText; }
                loadingStatus.textContent = "–ê–Ω–∞–ª–∏–∑ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...";
                const extractionPrompt = `–ò–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è "–ê–∫—Ç–∞ –≤—ã–Ω–æ—Å–∞ –≥—Ä–∞–Ω–∏—Ü". –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç. –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–Ω–∞—á–µ–Ω–∏–µ - –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ "". - "city": –ì–æ—Ä–æ–¥. - "cadastralNumber": –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä. - "address": –ê–¥—Ä–µ—Å. - "adjacentCadastralNumbers": –°–º–µ–∂–Ω—ã–µ –ö–ù —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. - "basisDocument": –î–æ–∫—É–º–µ–Ω—Ç-–æ—Å–Ω–æ–≤–∞–Ω–∏–µ. - "signCount": –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤. - "coordinates": –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ù–∞–∑–≤–∞–Ω–∏–µ X Y) –Ω–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö. - "performingOrganization": –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å. - "specialistFio": –§–ò–û —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. - "specialistTitle": –î–æ–ª–∂–Ω–æ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. - "workDate": –î–∞—Ç–∞ —Ä–∞–±–æ—Ç. - "rightHolderFio": –§–ò–û –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—è. - "directorFio": –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞. –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n---\n${combinedText.trim()}`;
                const response = await fetch("https://mapruapp.ru/ai/api/v1/chat/completions", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: "gemini-1.5-flash-latest", messages: [{ role: "user", content: extractionPrompt }], response_format: { type: "json_object" } }) });
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.statusText}`);
                const data = await response.json();
                const aiResponseText = data.choices?.[0]?.message?.content;
                const parsedData = JSON.parse(aiResponseText.trim().replace(/^```json\s*|\s*```$/g, ''));
                formInputIds.forEach(id => { const element = document.getElementById(id); if (element && parsedData[id]) element.value = parsedData[id]; });
                saveData(); updatePreview(); closeAiModal(); showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!');
            } catch (error) { console.error('–û—à–∏–±–∫–∞ –ò–ò:', error); showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, true); } finally { document.getElementById('ai-modal-form').style.display = 'block'; document.getElementById('ai-modal-loading').style.display = 'none'; }
        }
        async function handleAiModalPaste(e) { if (aiInputImages.length >= MAX_IMAGES) { showStatus(`–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${MAX_IMAGES} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.`, true); return; } const items = (e.clipboardData || window.clipboardData).items; let imageFile = null; for (let i = 0; i < items.length; i++) { if (items[i].kind === 'file' && items[i].type.startsWith('image/')) { imageFile = items[i].getAsFile(); break; } } if (imageFile) { e.preventDefault(); showStatus('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ. –û–±—Ä–∞–±–æ—Ç–∫–∞...'); try { const imageDataUrl = await showCropModal(imageFile); if (!imageDataUrl) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ."); aiInputImages.push(imageDataUrl); redrawImages(); showStatus(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.`); } catch (error) { console.error("–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏/–æ–±—Ä–µ–∑–∫–∏:", error); showStatus("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " + error.message, true); } } }
        async function performOcrForImage(base64DataUrl) { const ocrPrompt = "Extract all text from the image."; const base64ImageData = base64DataUrl.split(',')[1]; let apiUrl, requestBody; if (PROXY_MODE === 1) { apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`; requestBody = { model: "gemini-1.5-flash-latest", messages: [{ role: "user", content: [{ type: "text", text: ocrPrompt }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64ImageData}` } }] }], max_tokens: 4096 }; } else { apiUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/gemini-1.5-flash-latest:generateContent`; requestBody = { contents: [{ role: "user", parts: [{ text: ocrPrompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] }; } const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); const data = await response.json(); if (!response.ok) { throw new Error(`–û—à–∏–±–∫–∞ OCR API: ${data?.error?.message || response.statusText}`); } return (PROXY_MODE === 1) ? (data.choices?.[0]?.message?.content || "") : (data.candidates?.[0]?.content?.parts?.[0]?.text || ""); }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        function showCropModal(imageFile) { return new Promise((resolve) => { const modal = document.getElementById('crop-image-modal'); const imgPreview = document.getElementById('crop-image-preview'); const cropContainer = document.getElementById('crop-image-container'); const selectionRectDiv = document.getElementById('crop-selection-rectangle'); const confirmButton = document.getElementById('crop-image-button-confirm'); const cancelButton = document.getElementById('crop-image-button-cancel'); let cropSelection = { startX: 0, startY: 0, endX: 0, endY: 0, isDrawing: false }; let imageNaturalSize = { width: 0, height: 0 }; let imageDisplaySize = { width: 0, height: 0 }; selectionRectDiv.style.display = 'none'; cropSelection.isDrawing = false; const reader = new FileReader(); reader.onload = function(e) { imgPreview.src = e.target.result; modal.style.display = 'flex'; imgPreview.onload = () => { imageNaturalSize.width = imgPreview.naturalWidth; imageNaturalSize.height = imgPreview.naturalHeight; imageDisplaySize.width = imgPreview.offsetWidth; imageDisplaySize.height = imgPreview.offsetHeight; }; }; reader.readAsDataURL(imageFile); function updateSelectionRect() { const x = Math.min(cropSelection.startX, cropSelection.endX); const y = Math.min(cropSelection.startY, cropSelection.endY); const width = Math.abs(cropSelection.endX - cropSelection.startX); const height = Math.abs(cropSelection.endY - cropSelection.startY); selectionRectDiv.style.left = `${x}px`; selectionRectDiv.style.top = `${y}px`; selectionRectDiv.style.width = `${width}px`; selectionRectDiv.style.height = `${height}px`; } function getMousePos(event) { const rect = cropContainer.getBoundingClientRect(); let x = event.clientX - rect.left; let y = event.clientY - rect.top; x = Math.max(0, Math.min(x, imageDisplaySize.width)); y = Math.max(0, Math.min(y, imageDisplaySize.height)); return { x, y }; } const onMouseDown = (e) => { e.preventDefault(); cropSelection.isDrawing = true; const pos = getMousePos(e.touches ? e.touches[0] : e); cropSelection.startX = pos.x; cropSelection.startY = pos.y; cropSelection.endX = pos.x; cropSelection.endY = pos.y; selectionRectDiv.style.display = 'block'; updateSelectionRect(); cropContainer.addEventListener('mousemove', onMouseMove); cropContainer.addEventListener('touchmove', onMouseMove, { passive: false }); window.addEventListener('mouseup', onMouseUp); window.addEventListener('touchend', onMouseUp); }; const onMouseMove = (e) => { if (!cropSelection.isDrawing) return; e.preventDefault(); const pos = getMousePos(e.touches ? e.touches[0] : e); cropSelection.endX = pos.x; cropSelection.endY = pos.y; updateSelectionRect(); }; const onMouseUp = () => { if (!cropSelection.isDrawing) return; cropSelection.isDrawing = false; cropContainer.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); cropContainer.removeEventListener('touchmove', onMouseMove); window.removeEventListener('touchend', onMouseUp); }; cropContainer.addEventListener('mousedown', onMouseDown); cropContainer.addEventListener('touchstart', onMouseDown, { passive: false }); const handleConfirm = () => { const selWidth = Math.abs(cropSelection.endX - cropSelection.startX); const selHeight = Math.abs(cropSelection.endY - cropSelection.startY); if (selWidth < 10 || selHeight < 10 || selectionRectDiv.style.display === 'none') { handleCancel(); return; } const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const scaleX = imageNaturalSize.width / imageDisplaySize.width; const scaleY = imageNaturalSize.height / imageDisplaySize.height; const sX = Math.min(cropSelection.startX, cropSelection.endX) * scaleX; const sY = Math.min(cropSelection.startY, cropSelection.endY) * scaleY; const sWidth = selWidth * scaleX; const sHeight = selHeight * scaleY; canvas.width = sWidth; canvas.height = sHeight; ctx.drawImage(imgPreview, sX, sY, sWidth, sHeight, 0, 0, sWidth, sHeight); const croppedImageDataUrl = canvas.toDataURL(imageFile.type || 'image/jpeg'); resolve(croppedImageDataUrl); cleanupModal(); }; const handleCancel = () => { fileToBase64(imageFile).then(base64 => resolve(base64)); cleanupModal(); }; const cleanupModal = () => { modal.style.display = 'none'; imgPreview.src = '#'; imgPreview.onload = null; cropContainer.removeEventListener('mousedown', onMouseDown); cropContainer.removeEventListener('touchstart', onMouseDown); confirmButton.onclick = null; cancelButton.onclick = null; }; confirmButton.onclick = handleConfirm; cancelButton.onclick = handleCancel; }); }

        // --- DYNAMIC DOCUMENT PREVIEW ---
        function updatePreview() {
            const data = {}; formInputIds.forEach(id => data[id] = document.getElementById(id).value.trim());
            let html = `<div style="text-align: center;"><p><strong>–ê–ö–¢</strong></p><p><strong>–≤—ã–Ω–æ—Å–∞ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –≤ –Ω–∞—Ç—É—Ä—É</strong></p></div>`;
            if (data.city) html += `<p style="margin-top: 2em;">${data.city}</p>`;
            if (data.cadastralNumber) html += `<p style="text-indent: 1.5em;">–î–∞–Ω–Ω—ã–π –∞–∫—Ç —Å–æ—Å—Ç–∞–≤–ª–µ–Ω –æ —Ñ–∞–∫—Ç–µ –≤—ã–Ω–æ—Å–∞ (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è) –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ (–ö–ù) ${data.cadastralNumber}.</p>`;
            if (data.address) { html += `<p style="text-indent: 1.5em;">–°–≤–µ–¥–µ–Ω–∏—è –æ –∑–µ–º–µ–ª—å–Ω–æ–º —É—á–∞—Å—Ç–∫–µ:</p><ul style="list-style-position: inside; padding-left: 1.5em;"><li>–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${data.address}</li></ul>`; }
            if (data.adjacentCadastralNumbers) html += `<p style="text-indent: 1.5em;">–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: –≥—Ä–∞–Ω–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –ø–ª–∞–Ω—É —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏. –ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –≥—Ä–∞–Ω–∏—á–∞—Ç —Å —É—á–∞—Å—Ç–∫–∞–º–∏ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ ${data.adjacentCadastralNumbers}.</p>`;
            if (data.basisDocument) html += `<p style="text-indent: 1.5em;">–í—ã–Ω–æ—Å –≥—Ä–∞–Ω–∏—Ü –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö—Å—è –≤ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º –ø–ª–∞–Ω–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ‚Ññ ${data.basisDocument}.</p>`;
            if (data.signCount) html += `<p style="text-indent: 1.5em;">–ú–µ—Ç–æ–¥ –≤—ã–Ω–æ—Å–∞ —Ç–æ—á–µ–∫ - –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏–µ (—Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ) –∏–∑–º–µ—Ä–µ–Ω–∏—è. –¢–æ—á–∫–∏ (–ø–æ–≤–æ—Ä–æ—Ç–Ω—ã–µ) –≥—Ä–∞–Ω–∏—Ü—ã –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–Ω–∞–∫–∞–º–∏ (–¥–µ—Ä–µ–≤—è–Ω–Ω—ã–º–∏ –∫–æ–ª—å—è–º–∏) –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—é. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ ‚Äì ${data.signCount}.</p>`;
            if (data.coordinates) { const coordsTableRows = data.coordinates.split('\n').map(line => { const parts = line.trim().split(/\s+/); return `<tr><td>${parts[0] || ''}</td><td>${parts[1] || ''}</td><td>${parts[2] || ''}</td></tr>`; }).join(''); html += `<p style="text-indent: 1.5em;">–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ:</p><table border="1" style="width: 100%; border-collapse: collapse; margin: 1em 0; text-align: center;"><tbody>${coordsTableRows}</tbody></table>`; }
            html += `<p>–†–∞–±–æ—Ç—ã –ø–æ –≤—ã–Ω–æ—Å—É –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–∏–ª–∏:</p>`;
            if(data.performingOrganization) html += `<p>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: ${data.performingOrganization}</p>`;
            html += `<p>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: ${data.specialistFio || '________________'} (${data.specialistTitle || '________________'})</p>`;
            html += `<p>–î–∞—Ç–∞: ${data.workDate || '________________'}</p><br>`;
            html += `<p>–†–∞–±–æ—Ç—ã –ø–æ –≤—ã–Ω–æ—Å—É –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è–ª:</p>`;
            html += `<p>–ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞: ${data.rightHolderFio || '____________________'}</p><br>`;
            if(data.performingOrganization) html += `<p>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: ${data.performingOrganization}</p>`;
            if(data.directorFio) html += `<p>–î–∏—Ä–µ–∫—Ç–æ—Ä ${data.performingOrganization || ''} <span style="float: right;">${data.directorFio}</span></p>`;
            document.getElementById('printableDocument').innerHTML = html;
        }

        // --- DOCX GENERATION WITH CONDITIONAL LOGIC ---
        async function generateDocx() {
            showStatus('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è DOCX —Ñ–∞–π–ª–∞...');
            const { Document, Packer, Paragraph, TextRun, Table, TableCell, TableRow, AlignmentType, WidthType, BorderStyle, TabStopType, TabStopPosition, VerticalAlign } = window.docx;
            const data = {}; formInputIds.forEach(id => data[id] = document.getElementById(id).value.trim());
            const docChildren = [];
            docChildren.push(new Paragraph({ text: "–ê–ö–¢", bold: true, alignment: AlignmentType.CENTER, spacing: { after: 100 } }));
            docChildren.push(new Paragraph({ text: "–≤—ã–Ω–æ—Å–∞ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –≤ –Ω–∞—Ç—É—Ä—É", alignment: AlignmentType.CENTER, spacing: { after: 400 } }));
            if (data.city) docChildren.push(new Paragraph({ text: data.city, spacing: { after: 200 } }));
            if (data.cadastralNumber) docChildren.push(new Paragraph({ text: `–î–∞–Ω–Ω—ã–π –∞–∫—Ç —Å–æ—Å—Ç–∞–≤–ª–µ–Ω –æ —Ñ–∞–∫—Ç–µ –≤—ã–Ω–æ—Å–∞ (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è) –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ (–ö–ù) ${data.cadastralNumber}.`, indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 100 } }));
            if (data.address) { docChildren.push(new Paragraph({ text: "–°–≤–µ–¥–µ–Ω–∏—è –æ –∑–µ–º–µ–ª—å–Ω–æ–º —É—á–∞—Å—Ç–∫–µ:", indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 100 } })); docChildren.push(new Paragraph({ text: `–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${data.address}`, bullet: { level: 0 }, indent: { left: 1063, hanging: 354 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 200 } })); }
            if (data.adjacentCadastralNumbers) docChildren.push(new Paragraph({ text: `–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: –≥—Ä–∞–Ω–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º—É –ø–ª–∞–Ω—É —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏. –ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –≥—Ä–∞–Ω–∏—á–∞—Ç —Å —É—á–∞—Å—Ç–∫–∞–º–∏ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ ${data.adjacentCadastralNumbers}.`, indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 100 } }));
            if (data.basisDocument) docChildren.push(new Paragraph({ text: `–í—ã–Ω–æ—Å –≥—Ä–∞–Ω–∏—Ü –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö—Å—è –≤ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–º –ø–ª–∞–Ω–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ‚Ññ \t${data.basisDocument}.`, indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 100 } }));
            if (data.signCount) docChildren.push(new Paragraph({ text: `–ú–µ—Ç–æ–¥ –≤—ã–Ω–æ—Å–∞ —Ç–æ—á–µ–∫ - –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏–µ (—Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ) –∏–∑–º–µ—Ä–µ–Ω–∏—è. –¢–æ—á–∫–∏ (–ø–æ–≤–æ—Ä–æ—Ç–Ω—ã–µ) –≥—Ä–∞–Ω–∏—Ü—ã –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–Ω–∞–∫–∞–º–∏ (–¥–µ—Ä–µ–≤—è–Ω–Ω—ã–º–∏ –∫–æ–ª—å—è–º–∏) –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—é. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ ‚Äì ${data.signCount}.`, indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 100 } }));
            if (data.coordinates) { docChildren.push(new Paragraph({ text: "–ö–∞—Ç–∞–ª–æ–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ:", indent: { firstLine: 709 }, alignment: AlignmentType.JUSTIFIED, spacing: { after: 200 } })); const coordRows = data.coordinates.split('\n').map(line => { const parts = line.trim().split(/\s+/); return new TableRow({ children: [ new TableCell({ children: [new Paragraph({ text: parts[0] || '', alignment: AlignmentType.CENTER })]}), new TableCell({ children: [new Paragraph({ text: parts[1] || '', alignment: AlignmentType.CENTER })]}), new TableCell({ children: [new Paragraph({ text: parts[2] || '', alignment: AlignmentType.CENTER })]})] }); }); docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: coordRows, borders: { top: { style: BorderStyle.SINGLE, size: 1 }, bottom: { style: BorderStyle.SINGLE, size: 1 }, left: { style: BorderStyle.SINGLE, size: 1 }, right: { style: BorderStyle.SINGLE, size: 1 }, insideHorizontal: { style: BorderStyle.SINGLE, size: 1 }, insideVertical: { style: BorderStyle.SINGLE, size: 1 } } })); }
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } }));
            const noBorders = { top: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, bottom: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, left: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, right: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, insideHorizontal: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, insideVertical: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" } };
            docChildren.push(new Paragraph({ text: "–†–∞–±–æ—Ç—ã –ø–æ –≤—ã–Ω–æ—Å—É –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–∏–ª–∏:", spacing: { after: 200 } }));
            if (data.performingOrganization) docChildren.push(new Paragraph({ children: [new TextRun("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:\t"), new TextRun(data.performingOrganization)], tabStops: [{ type: TabStopType.LEFT, position: 4000 }], spacing: { after: 200 } }));
            docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, borders: noBorders, rows: [ new TableRow({ children: [ new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph({ text: "–§.–ò.–û" }) ] }), new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph({ text: "–ü–æ–¥–ø–∏—Å—å" }) ] }), new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph({ text: "–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è" }) ] }), new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph({ text: "–î–∞—Ç–∞" }) ] }) ]}), new TableRow({ children: [ new TableCell({ children: [ new Paragraph({ text: "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞" })] }), new TableCell({ children: [] }), new TableCell({ children: [ new Paragraph({ text: "–ö–ò / –∏–Ω–æ–µ" })] }), new TableCell({ children: [] }) ]}), new TableRow({ children: [ new TableCell({ children: [ new Paragraph({text: ""}) ]}) ]}), new TableRow({ children: [ new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph(data.specialistFio)] }), new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph({ text: "" })] }), new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph(data.specialistTitle)] }), new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph(data.workDate)] }) ]}) ] }));
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } }));
            docChildren.push(new Paragraph({ text: "–†–∞–±–æ—Ç—ã –ø–æ –≤—ã–Ω–æ—Å—É –≥—Ä–∞–Ω–∏—Ü –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è–ª:", spacing: { after: 200 } }));
            docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, borders: noBorders, rows: [ new TableRow({ children: [ new TableCell({ width: { size: 50, type: WidthType.PERCENTAGE }, children: [ new Paragraph("–ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å") ] }), new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph("–ü–æ–¥–ø–∏—Å—å") ] }), new TableCell({ width: { size: 25, type: WidthType.PERCENTAGE }, children: [ new Paragraph("–î–∞—Ç–∞") ] }) ]}), new TableRow({ children: [ new TableCell({ children: [ new Paragraph("–∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞")] }), new TableCell({ children: [] }), new TableCell({ children: [] }) ]}), new TableRow({ children: [ new TableCell({ children: [ new Paragraph({text: ""}) ]}) ]}), new TableRow({ children: [ new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph(data.rightHolderFio) ] }), new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph({ text: "_______________________" })] }), new TableCell({ verticalAlign: VerticalAlign.BOTTOM, children: [ new Paragraph({ text: "________________" })] }) ]}) ] }));
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } }));
            if (data.performingOrganization) docChildren.push(new Paragraph({ children: [new TextRun(`–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ :  ${data.performingOrganization}`)], spacing: { after: 200 } }));
            if (data.directorFio) docChildren.push(new Paragraph({ children: [ new TextRun(`–î–∏—Ä–µ–∫—Ç–æ—Ä ${data.performingOrganization || ''}`), new TextRun({ text: `\t${data.directorFio}` }) ], tabStops: [{ type: TabStopType.RIGHT, position: TabStopPosition.MAX }] }));
            const doc = new Document({ styles: { paragraphStyles: [ { id: "Normal", name: "Normal", run: { font: "Times New Roman", size: 28 } } ] }, sections: [{ properties: { page: { margin: { top: 1134, right: 850, bottom: 1134, left: 1701 } } }, children: docChildren }] });
            Packer.toBlob(doc).then(blob => { saveAs(blob, "–ê–∫—Ç_–≤—ã–Ω–æ—Å–∞_–≥—Ä–∞–Ω–∏—Ü.docx"); showStatus('–§–∞–π–ª DOCX —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'); }).catch(err => { console.error(err); showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ DOCX!', true); });
        }

        // --- UTILITY FUNCTIONS ---
        function printDocument() { window.print(); }
        function exportToJPG() { showStatus('–°–æ–∑–¥–∞–Ω–∏–µ JPG...'); html2canvas(document.getElementById('printableDocument'), { scale: 2 }).then(canvas => { saveAs(canvas.toDataURL('image/jpeg', 1.0), 'akt_vynosa_granic.jpg'); showStatus('–§–∞–π–ª JPG —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'); }).catch(err => { console.error('–û—à–∏–±–∫–∞ JPG:', err); showStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞!', true); }); }
        function showStatus(message, isError = false) { const indicator = document.getElementById('statusIndicator'); indicator.textContent = message; indicator.classList.toggle('error', isError); indicator.classList.add('show'); setTimeout(() => { indicator.classList.remove('show'); }, 3000); }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updatePreview();
            formInputIds.forEach(id => { 
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', () => { saveData(); updatePreview(); }); 
            });
            const aiDataInput = document.getElementById('ai-data-input');
            if(aiDataInput) aiDataInput.addEventListener('paste', handleAiModalPaste);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Health Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🥗</text></svg>">
  <style>
    :root {
        --base-font-size: 16px;
        --bg-color: #f0f2f5;
        --container-bg: #ffffff;
        --text-color: #202124;
        --text-secondary-color: #5f6368;
        --input-bg: #ffffff;
        --input-border: #dadce0;
        --button-bg: #1a73e8;
        --button-bg-hover: #1765cc;
        --button-color: white;
        --accent-color: #1a73e8;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --border-color: #dadce0;
        --option-hover: #f1f3f4;
        --option-selected: #e8f0fe;
        --table-header-bg: #f8f9fa;
        --table-border-color: #dee2e6;
        --notification-color: #1a73e8;
        --selection-bg: #accef7;
    }
    body.dark-theme {
        --bg-color: #132036;
        --container-bg: #172a45;
        --text-color: #f3f9fb;
        --text-secondary-color: #a9c2d5;
        --input-bg: #1c2842;
        --input-border: #3d5a8c;
        --button-bg: #259af7;
        --button-bg-hover: #41c6e0;
        --button-color: #07111f;
        --accent-color: #56c8fa;
        --shadow-color: rgba(10, 63, 102, 0.45);
        --border-color: #31517a;
        --option-hover: #223c5c;
        --option-selected: #223e60;
        --table-header-bg: #20334d;
        --table-border-color: #31517a;
        --notification-color: #259af7;
        --selection-bg: #56c8fa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    ::selection { background: var(--selection-bg); color: var(--text-color); }
    html, body { height: 100%; width: 100%; -webkit-font-smoothing: antialiased; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-color); font-size: var(--base-font-size); display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .hidden { display: none !important; }

    .container {
        width: 100%;
        max-width: 700px;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--container-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color);
        overflow: hidden;
    }
    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    .header-title { font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .settings-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary-color); }
    .settings-btn:hover { background-color: var(--option-hover); color: var(--accent-color); }
    .settings-btn svg { width: 22px; height: 22px; fill: currentColor; }

    main {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* --- Input Area --- */
    #input-area { display: flex; flex-direction: column; gap: 20px; height: 100%; }
    .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .tab-btn { flex: 1; padding: 10px; font-size: 1rem; background: transparent; border: 1px solid transparent; border-radius: 8px; cursor: pointer; color: var(--text-secondary-color); font-weight: 500; }
    .tab-btn.active { color: var(--accent-color); background-color: var(--option-selected); border-color: var(--accent-color); }
    
    .tab-content { flex-grow: 1; display: flex; flex-direction: column; }
    #text-input-container { display: flex; flex-direction: column; height: 100%;}
    #product-description { flex-grow: 1; width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); resize: none; font-family: inherit; }
    #product-description:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 20%, transparent); }

    #image-input-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; height: 100%; }
    .image-upload-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; font-size: 1rem; font-weight: 500; border-radius: 8px; cursor: pointer; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
    .image-upload-btn:hover { background-color: var(--option-hover); }
    .image-upload-btn svg { width: 20px; height: 20px; fill: currentColor; }
    #image-preview-container { position: relative; width: 100%; max-width: 300px; }
    #image-preview { width: 100%; border-radius: 8px; border: 1px solid var(--border-color); }
    #clear-image-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background-color: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; font-size: 18px; line-height: 28px; text-align: center; }
    
    .analyze-btn-container { margin-top: auto; padding-top: 15px; }
    #analyze-btn { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: bold; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 8px; cursor: pointer; }
    #analyze-btn:hover { background-color: var(--button-bg-hover); }
    #analyze-btn:disabled { background-color: var(--text-secondary-color); cursor: not-allowed; }

    /* --- Output Area --- */
    #output-area { position: relative; }
    #new-request-btn { position: absolute; top: -10px; right: 0px; width: 44px; height: 44px; border-radius: 50%; background-color: var(--button-bg); color: var(--button-color); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px var(--shadow-color); z-index: 10;}
    #new-request-btn:hover { background-color: var(--button-bg-hover); transform: scale(1.05); }
    #new-request-btn svg { width: 24px; height: 24px; fill: currentColor; }

    #loading-indicator { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 20px; color: var(--text-secondary-color); }
    .typing-dot { width: 10px; height: 10px; background-color: var(--accent-color); border-radius: 50%; display: inline-block; animation: wave 1.5s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }

    #result-content { line-height: 1.6; }
    #result-content h2 { margin-bottom: 15px; font-size: 1.5rem; color: var(--accent-color); }
    #result-content h3 { margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
    #result-content table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
    #result-content th, #result-content td { border: 1px solid var(--table-border-color); padding: 10px; text-align: left; }
    #result-content th { background-color: var(--table-header-bg); font-weight: 600; width: 35%; }
    #result-content p { margin-bottom: 10px; }

    /* --- Modal --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--container-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px var(--shadow-color); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; }
    .modal-title { margin: 0; font-size: 1.2em; text-align: center; }
    .modal-group { display: flex; flex-direction: column; gap: 8px; }
    .modal-group label { font-size: 0.9em; color: var(--text-secondary-color); }
    .modal-select { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 8px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; }
    .modal-button { padding: 12px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
    .modal-button:hover { background-color: var(--button-bg-hover); }

    /* --- Notification --- */
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--notification-color); color: white; padding: 12px 18px; border-radius: 8px; font-size: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1001; opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
    .notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <div class="header-title">🥗 AI Health Scanner</div>
            <button class="settings-btn" id="settings-btn" title="Настройки">
                <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l-2 3.46c.12-.22.07-.49-.12.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </header>

        <main>
            <div id="input-area">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="text">Описание</button>
                    <button class="tab-btn" data-tab="image">Фото</button>
                </div>
                <div id="text-input-container" class="tab-content active">
                     <textarea id="product-description" placeholder="Введите название продукта, состав или просто опишите его..."></textarea>
                </div>
                <div id="image-input-container" class="tab-content hidden">
                    <div id="image-preview-container" class="hidden">
                        <img id="image-preview" src="#" alt="Предпросмотр фото">
                        <button id="clear-image-btn" title="Удалить фото">&times;</button>
                    </div>
                    <button class="image-upload-btn" id="upload-btn">
                        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 4h14v-2H5v2z"/></svg>
                        Выбрать файл
                    </button>
                    <button class="image-upload-btn" id="camera-btn">
                        <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h4.05l1.83-2h4.24l1.83 2H20v12zM12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5 5-2.24-5-5-5zm0 8c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/></svg>
                        Сделать фото
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">
                </div>

                <div class="analyze-btn-container">
                    <button id="analyze-btn">Анализировать</button>
                </div>
            </div>

            <div id="output-area" class="hidden">
                <button id="new-request-btn" title="Новый запрос">
                     <svg viewBox="0 0 24 24"><path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/></svg>
                </button>
                <div id="loading-indicator">
                    <p>Анализирую... </p>
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
                <div id="result-content"></div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-title">Настройки</h2>
            <div class="modal-group">
                <label for="model-select">Модель ИИ</label>
                <select id="model-select" class="modal-select"></select>
            </div>
            <div class="modal-group">
                <label for="api-mode-select">Тип подключения</label>
                <select id="api-mode-select" class="modal-select"></select>
            </div>
            <button id="close-settings-btn" class="modal-button">Закрыть</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";

    // --- CORRECTED MODELS LIST ---
    const MODELS = [
        { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite (быстрая)", apiType: "gemini" },
        { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini" },
    ];

    const API_MODES = {
        'mapruapp': {
            uiName: 'Прокси (mapruapp)',
            url: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`
        },
        'vercel': {
            uiName: 'Прокси (vercel)',
            url: (modelId) => `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`
        }
    };

    const AI_SYSTEM_PROMPT = `
Ты — эксперт-диетолог и медицинский консультант с 20-летним стажем. Твоя задача — провести детальный анализ пищевого продукта на основе предоставленной пользователем информации (фото этикетки или текстовое описание).

Твой ответ ДОЛЖЕН СТРОГО состоять из двух частей:

Часть 1: Таблица в формате Markdown.
Создай таблицу со следующими строками:
- Продукт: [Название продукта, как ты его определил]
- Калорийность (на 100г): [Значение в ккал и оценка: низкая/средняя/высокая]
- Белки (на 100г): [Значение в граммах]
- Жиры (на 100г): [Значение в граммах, с уточнением про насыщенные/трансжиры, если есть информация]
- Углеводы (на 100г): [Значение в граммах, с уточнением про сахар/клетчатку, если есть информация]
- Гликемический индекс (ГИ): [Примерная оценка: низкий/средний/высокий, и краткое пояснение]
- Влияние на холестерин: [Оценка: положительное/нейтральное/негативное, и почему (например, из-за насыщенных жиров или клетчатки)]
- Содержание натрия (соли): [Оценка: низкое/умеренное/высокое, и связь с давлением]
- Потенциальные аллергены: [Перечислить, если найдены (глютен, орехи, лактоза и т.д.)]
- Обработка продукта: [Оценка: минимальная/средняя/глубокая (ультра-обработанный), и что это значит]
- Степень натуральности: [Оценка по шкале от 1 до 10, где 10 - полностью натуральный]

Часть 2: Краткое заключение эксперта.
Напиши 3-4 абзаца текста, где дай общую оценку продукту с точки зрения здоровья.
- **Для кого полезен:** Кому этот продукт может быть рекомендован (например, спортсменам, людям на диете).
- **Кому следует ограничить:** Кому стоит употреблять с осторожностью (например, диабетикам, людям с высоким давлением).
- **Общий вердикт:** Итоговая рекомендация (например, "Отличный выбор для здорового перекуса", "Употреблять редко как лакомство", "Лучше избегать из-за высокого содержания сахара и жиров").
`;

    // --- DOM ELEMENTS ---
    const inputArea = document.getElementById('input-area');
    const outputArea = document.getElementById('output-area');
    const analyzeBtn = document.getElementById('analyze-btn');
    const newRequestBtn = document.getElementById('new-request-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultContent = document.getElementById('result-content');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const productDescription = document.getElementById('product-description');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const clearImageBtn = document.getElementById('clear-image-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const fileInput = document.getElementById('file-input');
    const cameraInput = document.getElementById('camera-input');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const modelSelect = document.getElementById('model-select');
    const apiModeSelect = document.getElementById('api-mode-select');

    // --- STATE ---
    let uploadedFileBase64 = null;
    let currentModelId = localStorage.getItem('scanner_model') || MODELS[0].id;
    let currentApiMode = localStorage.getItem('scanner_api_mode') || 'mapruapp';
    
    // --- INITIALIZATION ---
    function initializeApp() {
        setupEventListeners();
        populateSettings();
        loadSettings();
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-theme');
        }
    }

    function setupEventListeners() {
        tabBtns.forEach(btn => btn.addEventListener('click', handleTabClick));
        analyzeBtn.addEventListener('click', handleAnalyzeClick);
        newRequestBtn.addEventListener('click', handleNewRequestClick);
        uploadBtn.addEventListener('click', () => fileInput.click());
        cameraBtn.addEventListener('click', () => cameraInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        cameraInput.addEventListener('change', handleFileSelect);
        clearImageBtn.addEventListener('click', clearImage);
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) settingsModal.classList.add('hidden'); });
        modelSelect.addEventListener('change', (e) => {
            currentModelId = e.target.value;
            localStorage.setItem('scanner_model', currentModelId);
        });
        apiModeSelect.addEventListener('change', (e) => {
            currentApiMode = e.target.value;
            localStorage.setItem('scanner_api_mode', currentApiMode);
        });
    }

    // --- UI FUNCTIONS ---
    function handleTabClick(e) {
        const targetTab = e.currentTarget.dataset.tab;
        tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
        tabContents.forEach(content => {
            content.classList.toggle('hidden', !content.id.startsWith(targetTab));
            content.classList.toggle('active', content.id.startsWith(targetTab));
        });
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 10 * 1024 * 1024) { // 10 MB limit
            showNotification('Файл слишком большой (макс. 10 МБ)', true);
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            uploadedFileBase64 = e.target.result;
            imagePreview.src = uploadedFileBase64;
            imagePreviewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
    
    function clearImage() {
        uploadedFileBase64 = null;
        imagePreview.src = '#';
        imagePreviewContainer.classList.add('hidden');
        fileInput.value = '';
        cameraInput.value = '';
    }

    function switchView(view) {
        if (view === 'output') {
            inputArea.classList.add('hidden');
            outputArea.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            resultContent.innerHTML = '';
        } else {
            inputArea.classList.remove('hidden');
            outputArea.classList.add('hidden');
        }
    }

    function handleNewRequestClick() {
        clearImage();
        productDescription.value = '';
        switchView('input');
    }

    function populateSettings() {
        MODELS.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.uiName;
            modelSelect.appendChild(option);
        });
        for (const mode in API_MODES) {
            const option = document.createElement('option');
            option.value = mode;
            option.textContent = API_MODES[mode].uiName;
            apiModeSelect.appendChild(option);
        }
    }

    function loadSettings() {
        modelSelect.value = currentModelId;
        apiModeSelect.value = currentApiMode;
    }

    function showNotification(message, isError = false, duration = 3000) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        if (isError) notification.style.backgroundColor = '#d9534f';
        document.body.appendChild(notification);
        requestAnimationFrame(() => notification.classList.add('show'));
        setTimeout(() => {
            notification.classList.remove('show');
            notification.addEventListener('transitionend', () => notification.remove());
        }, duration);
    }
    
    function markdownToHtml(md) {
        let tableHtml = '';
        let summaryHtml = '';

        const tableRegex = /(\|.*\|(?:\r?\n|\r)?)+/g;
        const tableMatch = md.match(tableRegex);

        if (tableMatch) {
            const tableString = tableMatch[0];
            const rows = tableString.trim().split('\n').filter(r => !r.includes('---') && r.trim() !== '');
            tableHtml += '<table><tbody>';
            rows.forEach(rowStr => {
                const cells = rowStr.split('|').slice(1, -1).map(cell => cell.trim());
                if (cells.length === 2) {
                     tableHtml += `<tr><th>${cells[0]}</th><td>${cells[1]}</td></tr>`;
                }
            });
            tableHtml += '</tbody></table>';
        }

        let summaryText = md.replace(tableRegex, '').trim();
        summaryText = summaryText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        summaryText.split('\n').forEach(line => {
            if (line.trim().length > 1) summaryHtml += `<p>${line.trim()}</p>`;
        });
        
        return `<h2>Результат анализа</h2>${tableHtml}<h3>Заключение эксперта</h3>${summaryHtml}`;
    }


    // --- API & LOGIC ---
    async function handleAnalyzeClick() {
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        let userParts = [];

        if (activeTab === 'text') {
            const text = productDescription.value.trim();
            if (!text) {
                showNotification('Пожалуйста, введите описание продукта.', true);
                return;
            }
            userParts.push({ text: text });
        } else { // image tab
            if (!uploadedFileBase64) {
                showNotification('Пожалуйста, выберите или сделайте фото.', true);
                return;
            }
            const mimeType = uploadedFileBase64.match(/data:(.*);base64,/)[1];
            const base64Data = uploadedFileBase64.split(',')[1];
            userParts.push({ inlineData: { mimeType, data: base64Data } });
            userParts.push({ text: "Проанализируй продукт на этой этикетке." });
        }

        switchView('output');
        analyzeBtn.disabled = true;

        try {
            const model = MODELS.find(m => m.id === currentModelId);
            if (!model) throw new Error('Выбранная модель не найдена');

            let apiUrl, requestBody, fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } };

            if (currentApiMode === 'mapruapp') {
                apiUrl = API_MODES.mapruapp.url();
                const messages = [{
                    role: 'system',
                    content: AI_SYSTEM_PROMPT
                }, {
                    role: 'user',
                    content: userParts.map(part => {
                        if (part.text) return { type: 'text', text: part.text };
                        if (part.inlineData) return { type: 'image_url', image_url: { url: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}` } };
                    }).filter(Boolean)
                }];
                requestBody = { model: model.id, messages: messages, max_tokens: 4096 };
            
            } else { // vercel mode
                apiUrl = API_MODES.vercel.url(model.id);
                requestBody = { 
                    contents: [{
                        role: 'user',
                        parts: [{ text: AI_SYSTEM_PROMPT }, ...userParts]
                    }] 
                };
            }

            fetchOptions.body = JSON.stringify(requestBody);
            const response = await fetch(apiUrl, fetchOptions);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Ошибка API: ${response.status} ${errorText}`);
            }

            const data = await response.json();
            let botReplyText = '';

            if (currentApiMode === 'mapruapp') {
                botReplyText = data.choices?.[0]?.message?.content;
            } else { // vercel
                botReplyText = data.candidates?.[0]?.content?.parts.map(p => p.text || '').join('');
            }

            if (!botReplyText) {
                throw new Error('Получен пустой ответ от API');
            }
            
            loadingIndicator.classList.add('hidden');
            resultContent.innerHTML = markdownToHtml(botReplyText);

        } catch (error) {
            console.error(error);
            loadingIndicator.classList.add('hidden');
            resultContent.innerHTML = `<p style="color: #d9534f;"><strong>Произошла ошибка:</strong> ${error.message}</p>`;
        } finally {
            analyzeBtn.disabled = false;
        }
    }
    
    initializeApp();
});
</script>
</body>
</html>
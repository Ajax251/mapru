<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCryptoARM - –ü–æ–¥–ø–∏—Å—å –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ -->
    <script src="https://www.cryptopro.ru/sites/default/files/products/cades/cadesplugin_api.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-container { max-width: 1000px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .plugin-status { font-size: 0.9rem; margin-bottom: 20px; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; }
        .status-ok { background-color: #d1e7dd; color: #0f5132; }
        .status-err { background-color: #f8d7da; color: #842029; }
        .status-warn { background-color: #fff3cd; color: #664d03; }
        
        .drop-zone { border: 2px dashed #dee2e6; border-radius: 8px; padding: 30px; text-align: center; color: #6c757d; cursor: pointer; transition: 0.2s; background: #fafafa; }
        .drop-zone:hover { border-color: #0d6efd; background: #f1f8ff; color: #0d6efd; }
        .drop-zone i { font-size: 2rem; margin-bottom: 10px; }
        
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #0d6efd; font-weight: 600; border-bottom: 3px solid #0d6efd; }
        
        .result-table th { font-size: 0.85rem; text-transform: uppercase; color: #6c757d; }
        .result-table td { vertical-align: middle; font-size: 0.9rem; }
        
        .badge-valid { background-color: #198754; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }
        .badge-invalid { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }
        
        .hidden-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <div style="font-size: 2rem; color: #0d6efd;"><i class="fas fa-file-signature"></i></div>
                <div>
                    <h2 class="m-0 fw-bold">WebCryptoARM</h2>
                    <small class="text-muted">–ü–æ–¥–ø–∏—Å—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ (–ì–û–°–¢)</small>
                </div>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()"><i class="fas fa-sync"></i> –°–±—Ä–æ—Å</button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –ø–ª–∞–≥–∏–Ω–∞ -->
        <div id="pluginStatus" class="plugin-status status-warn">
            <i class="fas fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ...
        </div>

        <!-- –¢–∞–±—ã -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sign-tab" data-bs-toggle="tab" data-bs-target="#sign-pane" type="button"><i class="fas fa-pen-nib"></i> –ü–æ–¥–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="verify-tab" data-bs-toggle="tab" data-bs-target="#verify-pane" type="button"><i class="fas fa-check-double"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <!-- –í–ö–õ–ê–î–ö–ê: –ü–û–î–ü–ò–°–ê–¢–¨ -->
            <div class="tab-pane fade show active" id="sign-pane">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">1. –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</label>
                        <select id="certSelect" class="form-select">
                            <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...</option>
                        </select>
                        <div class="form-text">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã.</div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">2. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã</label>
                        <div class="drop-zone" onclick="document.getElementById('signFilesInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏—Ö —Å—é–¥–∞</div>
                            <input type="file" id="signFilesInput" class="hidden-input" multiple onchange="handleSignFilesSelect(this)">
                        </div>
                        <div id="signFileList" class="mt-2 text-muted small"></div>
                    </div>

                    <div class="col-md-12 mb-4">
                        <label class="form-label fw-bold">3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="zipCheckbox" checked>
                            <label class="form-check-label" for="zipCheckbox">–£–ø–∞–∫–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –∏ –ø–æ–¥–ø–∏—Å–∏ –≤ –æ–¥–∏–Ω ZIP-–∞—Ä—Ö–∏–≤</label>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <button class="btn btn-primary w-100 py-2" id="btnDoSign" onclick="processSigning()" disabled>
                            <i class="fas fa-signature"></i> –ü–æ–¥–ø–∏—Å–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                        </button>
                    </div>
                </div>

                <!-- –õ–æ–≥ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è -->
                <div id="signLog" class="mt-3" style="display:none;">
                    <div class="progress mb-2" style="height: 5px;">
                        <div id="signProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <ul class="list-group list-group-flush small" id="signLogList"></ul>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê: –ü–†–û–í–ï–†–ò–¢–¨ -->
            <div class="tab-pane fade" id="verify-pane">
                <div class="alert alert-info border-0 bg-light">
                    <i class="fas fa-info-circle"></i> –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ <b>–∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª</b> –∏ —Ñ–∞–π–ª –ø–æ–¥–ø–∏—Å–∏ <b>(.sig)</b>. –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –Ω–∞–π–¥–µ—Ç –ø–∞—Ä—ã –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
                </div>
                
                <div class="drop-zone mb-3" onclick="document.getElementById('verifyFilesInput').click()">
                    <i class="fas fa-search-plus"></i>
                    <div>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—ã —Ñ–∞–π–ª–æ–≤ (–¥–æ–∫—É–º–µ–Ω—Ç + .sig)</div>
                    <input type="file" id="verifyFilesInput" class="hidden-input" multiple onchange="processVerification(this)">
                </div>

                <div id="verifyResultsArea" style="display:none;">
                    <h5 class="mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>
                    <table class="table table-hover result-table">
                        <thead class="table-light">
                            <tr>
                                <th>–§–∞–π–ª</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü–æ–¥–ø–∏—Å–∞–Ω—Ç</th>
                                <th>–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∏</th>
                            </tr>
                        </thead>
                        <tbody id="verifyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let globalCertificates = [];
    let filesToSign = [];

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    window.onload = async function() {
        await initCryptoPro();
    };

    async function initCryptoPro() {
        const statusEl = document.getElementById('pluginStatus');
        try {
            if (typeof cadesplugin === 'undefined') {
                throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ cadesplugin_api.js –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞");
            }
            await cadesplugin; // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
            
            statusEl.className = 'plugin-status status-ok';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> –ü–ª–∞–≥–∏–Ω –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
            
            await loadCertificates();
            
        } catch (err) {
            console.error(err);
            statusEl.className = 'plugin-status status-err';
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${err.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –ø–ª–∞–≥–∏–Ω –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞.`;
        }
    }

    async function loadCertificates() {
        const select = document.getElementById('certSelect');
        select.innerHTML = '<option disabled>–ß—Ç–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞...</option>';
        
        try {
            const store = await cadesplugin.CreateObjectAsync("CAPICOM.Store");
            await store.Open(cadesplugin.CAPICOM_CURRENT_USER_STORE, cadesplugin.CAPICOM_MY_STORE, cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED);
            
            const certs = await store.Certificates;
            const count = await certs.Count;
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ –¥–∞—Ç–µ)
            const validCerts = await certs.Find(cadesplugin.CAPICOM_CERTIFICATE_FIND_TIME_VALID);
            const validCount = await validCerts.Count;
            
            select.innerHTML = '';
            globalCertificates = [];

            if (validCount === 0) {
                select.innerHTML = '<option disabled selected>–ù–µ—Ç –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</option>';
                return;
            }

            for (let i = 1; i <= validCount; i++) {
                const cert = await validCerts.Item(i);
                globalCertificates.push(cert);
                
                // –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è
                const subjectName = await cert.SubjectName;
                let name = subjectName;
                // –ü–∞—Ä—Å–∏–º CN=
                const cnMatch = subjectName.match(/CN=([^,]+)/);
                if(cnMatch) name = cnMatch[1];
                
                const validToDate = new Date(await cert.ValidToDate);
                const dateStr = validToDate.toLocaleDateString();

                const opt = document.createElement('option');
                opt.value = i - 1; 
                opt.text = `${name} (–¥–æ ${dateStr})`;
                select.appendChild(opt);
            }

            await store.Close();
            updateSignButtonState();

        } catch (e) {
            select.innerHTML = `<option disabled>–û—à–∏–±–∫–∞: ${e.message}</option>`;
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ü–û–î–ü–ò–°–ê–ù–ò–Ø ---

    function handleSignFilesSelect(input) {
        filesToSign = Array.from(input.files);
        const list = document.getElementById('signFileList');
        if (filesToSign.length > 0) {
            list.innerHTML = filesToSign.map(f => `<div><i class="far fa-file"></i> ${f.name} (${formatSize(f.size)})</div>`).join('');
        } else {
            list.innerHTML = '';
        }
        updateSignButtonState();
    }

    function updateSignButtonState() {
        const btn = document.getElementById('btnDoSign');
        const certSelected = globalCertificates.length > 0;
        const filesSelected = filesToSign.length > 0;
        btn.disabled = !(certSelected && filesSelected);
    }

    // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ Base64
     const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsArrayBuffer(file); // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Å—ã—Ä—ã–µ –±–∞–π—Ç—ã
        reader.onload = () => {
            const buffer = reader.result;
            const bytes = new Uint8Array(buffer);
            let binary = '';
            const len = bytes.byteLength;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è btoa
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª, —Ç–∞–∫ –∫–∞–∫ apply –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–µ–∫–∞ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            
            // –ö–æ–¥–∏—Ä—É–µ–º –≤ Base64
            resolve(window.btoa(binary));
        };
        reader.onerror = error => reject(error);
    });

    async function processSigning() {
        const certIdx = document.getElementById('certSelect').value;
        const cert = globalCertificates[certIdx];
        const useZip = document.getElementById('zipCheckbox').checked;
        const logArea = document.getElementById('signLog');
        const logList = document.getElementById('signLogList');
        const progress = document.getElementById('signProgress');
        
        logArea.style.display = 'block';
        logList.innerHTML = '';
        progress.style.width = '0%';
        
        const zip = new JSZip();
        
        try {
            const oSigner = await cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner");
            await oSigner.propset_Certificate(cert);
            // –û–ø—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏) –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
            // await oSigner.propset_Options(cadesplugin.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN); 

            let processed = 0;

            for (const file of filesToSign) {
                addLog(`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${file.name}...`);
                
                // 1. –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
                const fileBase64 = await fileToBase64(file);
                
                // 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º
                const oSignedData = await cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData");
                await oSignedData.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);
                await oSignedData.propset_Content(fileBase64);
                
                // SignCades(Signer, CadesType, Detached)
                // CAdES-BES = 1, Detached = true
                const signature = await oSignedData.SignCades(oSigner, cadesplugin.CADESCOM_CADES_BES, true);
                
                const sigFileName = file.name + ".sig";
                addLog(`‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω. –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥–ø–∏—Å—å: ${sigFileName}`);

                if (useZip) {
                    zip.file(file.name, file);
                    zip.file(sigFileName, signature); // signature is base64 string usually
                } else {
                    // –°–∫–∞—á–∏–≤–∞–µ–º —Å—Ä–∞–∑—É .sig (–ø–æ –æ–¥–Ω–æ–º—É, –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π)
                    const blob = new Blob([signature], {type: "text/plain"});
                    saveAs(blob, sigFileName);
                }

                processed++;
                progress.style.width = `${(processed / filesToSign.length) * 100}%`;
            }

            if (useZip) {
                addLog("–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤...");
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "Signed_Files.zip");
                addLog("üíæ –ê—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω!");
            } else {
                addLog("–ì–æ—Ç–æ–≤–æ. –§–∞–π–ª—ã –ø–æ–¥–ø–∏—Å–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.");
            }

        } catch (err) {
            console.error(err);
            addLog(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, true);
        }
    }

    function addLog(msg, isError = false) {
        const li = document.createElement('li');
        li.className = "list-group-item " + (isError ? "text-danger" : "");
        li.textContent = msg;
        document.getElementById('signLogList').appendChild(li);
    }

    // --- –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ---

    async function processVerification(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;

        const resultsArea = document.getElementById('verifyResultsArea');
        const tbody = document.getElementById('verifyTableBody');
        resultsArea.style.display = 'block';
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤...</td></tr>';

        // 1. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã (–ò—â–µ–º –ø–∞—Ä—ã)
        // –ö–∞—Ä—Ç–∞: "–∏–º—è_—Ñ–∞–π–ª–∞" -> { original: File, sig: File }
        const pairs = {};
        
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ .sig
        files.forEach(f => {
            if (f.name.toLowerCase().endsWith('.sig') || f.name.toLowerCase().endsWith('.sgn')) {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å –∏–º—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞: —É–¥–∞–ª—è–µ–º .sig
                // contract.pdf.sig -> contract.pdf
                const originalName = f.name.substring(0, f.name.lastIndexOf('.'));
                
                if (!pairs[originalName]) pairs[originalName] = {};
                pairs[originalName].sig = f;
            } else {
                // –≠—Ç–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª
                if (!pairs[f.name]) pairs[f.name] = {};
                pairs[f.name].original = f;
            }
        });

        tbody.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∞–¥–µ—Ä

        // 2. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –ø–∞—Ä–∞–º
        const names = Object.keys(pairs);
        if (names.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</td></tr>';
            return;
        }

        for (const name of names) {
            const pair = pairs[name];
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∏ —Ñ–∞–π–ª –∏ –ø–æ–¥–ø–∏—Å—å
            if (pair.original && pair.sig) {
                await verifyPair(pair.original, pair.sig, tbody);
            } 
            // –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—å (–±–µ–∑ —Ñ–∞–π–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –Ω–µ–ª—å–∑—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç —Ö—ç—à–∞)
            else if (pair.sig && !pair.original) {
                appendResultRow(tbody, pair.sig.name, "ERROR", "–ù–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞", "‚Äî");
            }
            // –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
            else if (pair.original && !pair.sig) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–ª–∏ –ø–∏—à–µ–º –∏–Ω—Ñ–æ
                // appendResultRow(tbody, pair.original.name, "INFO", "–ù–µ—Ç —Ñ–∞–π–ª–∞ –ø–æ–¥–ø–∏—Å–∏", "‚Äî");
            }
        }
    }

    async function verifyPair(fileOrig, fileSig, tbody) {
        try {
            // –ß–∏—Ç–∞–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
            const dataBase64 = await fileToBase64(fileOrig);
            const sigBase64 = await fileToBase64(fileSig);

            const oSignedData = await cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData");
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (–¥–ª—è detached –ø–æ–¥–ø–∏—Å–∏ —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            await oSignedData.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);
            await oSignedData.propset_Content(dataBase64);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º
            try {
                // VerifyCades(Signature, CadesType, Detached)
                await oSignedData.VerifyCades(sigBase64, cadesplugin.CADESCOM_CADES_BES, true);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ –Ω–µ –≤—ã–ª–µ—Ç–µ–ª–æ, –∑–Ω–∞—á–∏—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–æ.
                // –î–æ—Å—Ç–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–µ
                const signers = await oSignedData.Signers;
                const count = await signers.Count;
                let signerNames = [];
                let dates = [];

                for (let i = 1; i <= count; i++) {
                    const signer = await signers.Item(i);
                    const cert = await signer.Certificate;
                    const subject = await cert.SubjectName;
                    
                    // –ü–∞—Ä—Å–∏–º CN
                    let name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
                    const cnMatch = subject.match(/CN=([^,]+)/);
                    if(cnMatch) name = cnMatch[1];
                    signerNames.push(name);
                    
                    const date = await signer.SigningTime; // –î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∏
                    // –î–∞—Ç–∞ –∏–∑ COM-–æ–±—ä–µ–∫—Ç–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –≤ —Ä–∞–∑–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
                    dates.push(new Date(date).toLocaleString());
                }

                appendResultRow(tbody, fileOrig.name, "VALID", signerNames.join('<br>'), dates.join('<br>'));

            } catch (verErr) {
                // –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø–æ–¥–ø–∏—Å—å –Ω–µ –≤–µ—Ä–Ω–∞ –∏–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–µ–Ω)
                console.error(verErr);
                appendResultRow(tbody, fileOrig.name, "INVALID", "–ü–æ–¥–ø–∏—Å—å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–µ–Ω", "‚Äî");
            }

        } catch (err) {
            console.error(err);
            appendResultRow(tbody, fileOrig.name, "ERROR", "–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞: " + err.message, "‚Äî");
        }
    }

    function appendResultRow(tbody, fileName, status, signer, date) {
        const tr = document.createElement('tr');
        
        let badge = '';
        if (status === 'VALID') badge = '<span class="badge-valid"><i class="fas fa-check"></i> –í–µ—Ä–Ω–∞</span>';
        else if (status === 'INVALID') badge = '<span class="badge-invalid"><i class="fas fa-times"></i> –ù–µ–≤–µ—Ä–Ω–∞</span>';
        else badge = '<span class="badge bg-warning text-dark"><i class="fas fa-exclamation"></i> –û—à–∏–±–∫–∞</span>';

        tr.innerHTML = `
            <td><strong>${fileName}</strong></td>
            <td>${badge}</td>
            <td>${signer}</td>
            <td>${date}</td>
        `;
        tbody.appendChild(tr);
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
</script>

</body>
</html>
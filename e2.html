<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ì–æ—Ä–æ–¥–∞ - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
<link rel="stylesheet" href="webfonts/leaflet.css" />
<script src="webfonts/leaflet.js"></script>
<link id="favicon" rel="icon" href="https://img.icons8.com/?size=100&id=108778&format=png&color=000000" type="image/png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --dark-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        --hover-shadow: 0 30px 80px rgba(0, 0, 0, 0.25);
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --border-radius: 20px;
        --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body, html {
        height: 100%;
        font-family: var(--font-family);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--text-primary);
        overflow: hidden;
        position: relative;
    }

    .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
    }

    .particle {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 20s infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    #map {
        position: absolute;
        top: 20px;
        left: 340px;
        right: 20px;
        bottom: 20px;
        z-index: 1;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
        animation: slideInRight 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideInRight {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    #map:hover {
        box-shadow: var(--hover-shadow);
        transform: translateY(-2px);
    }

    .weather-widget {
        position: fixed;
        left: 20px;
        top: 20px;
        bottom: 20px;
        width: 300px;
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        padding: 25px;
        box-shadow: var(--card-shadow);
        border-radius: var(--border-radius);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        border: 2px solid rgba(255, 255, 255, 0.3);
        animation: slideInLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideInLeft {
        from { transform: translateX(-100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .weather-widget::-webkit-scrollbar { width: 8px; }
    .weather-widget::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }
    .weather-widget::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 10px;
    }

    #city-input {
        margin-bottom: 20px;
        padding: 15px 20px;
        border: 2px solid rgba(102, 126, 234, 0.2);
        border-radius: 15px;
        width: 100%;
        font-size: 16px;
        font-family: var(--font-family);
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        transition: var(--transition);
        font-weight: 500;
    }

    #city-input::placeholder {
        color: var(--text-secondary);
        font-weight: 400;
    }

    #city-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }

    #weather-data {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-grow: 1;
        gap: 20px;
    }

    .city-name {
        font-size: 28px;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-decoration: none;
        transition: var(--transition);
        animation: fadeInDown 0.6s ease-out 0.2s both;
    }

    @keyframes fadeInDown {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .city-name:hover {
        transform: scale(1.05);
        filter: brightness(1.2);
    }

    .date-time {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        animation: fadeIn 0.6s ease-out 0.3s both;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .date-time:hover {
        color: #667eea;
        transform: scale(1.05);
    }

    .weather-icon {
        font-size: 80px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: pulse 3s ease-in-out infinite, fadeInScale 0.8s ease-out 0.4s both;
        filter: drop-shadow(0 10px 20px rgba(102, 126, 234, 0.3));
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    @keyframes fadeInScale {
        from { transform: scale(0); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    #temperature {
        font-size: 48px;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 10px 0;
        animation: fadeInUp 0.6s ease-out 0.5s both;
    }

    @keyframes fadeInUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    #description {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: capitalize;
        animation: fadeIn 0.6s ease-out 0.6s both;
    }

    .details {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 15px 0;
    }

    .details > div {
        padding: 15px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-radius: 12px;
        border: 1px solid rgba(102, 126, 234, 0.2);
        font-weight: 500;
        transition: var(--transition);
        animation: fadeInUp 0.6s ease-out both;
        animation-delay: calc(0.7s + var(--item-index) * 0.1s);
    }

    .details > div:nth-child(1) { --item-index: 0; }
    .details > div:nth-child(2) { --item-index: 1; }
    .details > div:nth-child(3) { --item-index: 2; }

    .details > div:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    }

    .forecast-wrapper {
        width: 100%;
        margin-top: 20px;
        animation: fadeInUp 0.6s ease-out 1s both;
    }

    .forecast-wrapper h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .forecast {
        display: grid;
        gap: 12px;
    }

    .forecast > div {
        padding: 15px;
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
        border-radius: 12px;
        border: 1px solid rgba(79, 172, 254, 0.2);
        transition: var(--transition);
        text-align: center;
    }

    .forecast > div:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(79, 172, 254, 0.2);
    }

    .distance-info {
        margin-top: 20px;
        padding: 15px;
        background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
        border-radius: 12px;
        border: 1px solid rgba(240, 147, 251, 0.3);
        opacity: 0;
        transition: var(--transition);
        cursor: pointer;
        font-weight: 500;
    }

    .distance-info.visible {
        opacity: 1;
        animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .distance-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
    }

    .map-mode-switcher {
        margin-top: auto;
        padding-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .map-mode-button {
        padding: 12px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        color: #667eea;
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .map-mode-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: var(--primary-gradient);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
        z-index: 0;
    }

    .map-mode-button i {
        position: relative;
        z-index: 1;
        transition: var(--transition);
    }

    .map-mode-button:hover::before {
        width: 100px;
        height: 100px;
    }

    .map-mode-button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .map-mode-button:hover i {
        color: white;
    }

    .map-mode-button.active {
        background: var(--primary-gradient);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    #city-info-panel {
        position: fixed;
        top: 20px;
        left: 340px;
        right: 20px;
        bottom: 20px;
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 40px 30px 30px;
        z-index: 1005;
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
        transition: var(--transition);
        overflow-y: auto;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    #city-info-panel.visible {
        opacity: 1;
        transform: scale(1);
        pointer-events: all;
        animation: zoomIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    #city-info-panel::-webkit-scrollbar { width: 10px; }
    #city-info-panel::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }
    #city-info-panel::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 10px;
    }

    #close-city-info-panel, #refresh-city-info-button {
        position: absolute;
        top: 20px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        font-size: 24px;
        color: white;
        cursor: pointer;
        padding: 0;
        transition: var(--transition);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    #close-city-info-panel { right: 20px; }
    #refresh-city-info-button {
        right: 75px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
    }

    #close-city-info-panel:hover, #refresh-city-info-button:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
    }

    #refresh-city-info-button:hover {
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
    }

    #close-city-info-panel:active, #refresh-city-info-button:active {
        transform: scale(0.95);
    }

    #city-info-panel h2 {
        text-align: center;
        font-size: 32px;
        font-weight: 700;
        margin: 0 0 30px 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: fadeInDown 0.6s ease-out;
    }

    .loading-message {
        display: none;
        text-align: center;
        padding: 60px 20px;
    }

    .skeleton-loader {
        width: 100%;
        height: 20px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 10px;
        margin: 10px 0;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        animation: fadeInUp 0.8s ease-out;
    }

    .info-item {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
        padding: 20px;
        border-radius: 15px;
        border: 2px solid rgba(102, 126, 234, 0.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        animation: fadeInUp 0.6s ease-out both;
        animation-delay: calc(var(--item-index) * 0.05s);
    }

    .info-item:nth-child(1) { --item-index: 1; }
    .info-item:nth-child(2) { --item-index: 2; }
    .info-item:nth-child(3) { --item-index: 3; }
    .info-item:nth-child(4) { --item-index: 4; }
    .info-item:nth-child(5) { --item-index: 5; }
    .info-item:nth-child(6) { --item-index: 6; }
    .info-item:nth-child(7) { --item-index: 7; }
    .info-item:nth-child(8) { --item-index: 8; }
    .info-item:nth-child(n+9) { --item-index: 9; }

    .info-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
        border-color: rgba(102, 126, 234, 0.3);
    }

    .info-label {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        font-size: 15px;
    }

    .info-label i {
        margin-right: 10px;
        font-size: 18px;
        width: 24px;
        text-align: center;
    }

    .info-item span:not(.info-label), .info-item p, .info-item div:not(.info-label) {
        color: var(--text-primary);
        line-height: 1.8;
        font-weight: 500;
    }

    .info-item ul {
        list-style: none;
        padding: 0;
    }

    .info-item li {
        padding: 8px 0 8px 25px;
        position: relative;
        transition: var(--transition);
    }

    .info-item li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #667eea;
        font-weight: bold;
        font-size: 16px;
    }

    .info-item li:hover {
        padding-left: 30px;
        color: #667eea;
    }

    .info-full-width {
        grid-column: 1 / -1;
    }

    .scale-line-horizontal, .scale-line-vertical {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(102, 126, 234, 0.2);
        transition: var(--transition);
        position: absolute;
        z-index: 900;
    }

    .scale-line-horizontal {
        bottom: 20px;
        left: 20px; 
        right: 20px;
        height: 50px;
        padding: 12px 15px;
        animation: slideInUp 1s ease-out 1.2s both;
        box-sizing: border-box;
    }

    .scale-line-vertical {
        top: 20px;
        right: 20px;
        bottom: 90px;
        width: 70px;
        padding: 15px 10px;
        display: flex;
        animation: slideInRight 1s ease-out 1.4s both;
        box-sizing: border-box;
    }

    .scale-segments-horizontal { display:flex; height:5px; position:relative; background:rgba(110,142,251,0.15); border-radius:3px; overflow:hidden; }
    .scale-segment-horizontal { height:100%; border-left:2px solid rgba(110,142,251,0.8); flex:1; position:relative; }
    .scale-segment-horizontal:last-child { border-right:2px solid rgba(110,142,251,0.8); }
    .scale-labels-horizontal { position:relative; height:20px; margin-top:10px; font-size:12px; color:rgba(50,50,50,0.9); }
    .scale-segments-vertical { display:flex; flex-direction:column; width:5px; height:100%; position:relative; background:rgba(110,142,251,0.35); border-radius:3px; margin-left:auto; margin-right:5px; overflow:hidden; }
    .scale-segment-vertical { width:100%; border-top:2px solid rgba(110,142,251,0.8); flex:1; position:relative; }
    .scale-segment-vertical:last-child { border-bottom:2px solid rgba(110,142,251,0.8); }
    .scale-labels-horizontal span { padding:3px 5px; color:#456cf7; border-radius:4px; text-align:center; font-weight:600; text-shadow:0 1px 1px rgba(255,255,255,0.9); transition:all .2s ease; letter-spacing:.5px; position:absolute; transform:translateX(-50%); }
    .scale-labels-vertical { position:absolute; left:8px; top:0; bottom:0; width:35px; }
    .scale-labels-vertical span { padding:3px 5px; color:#456cf7; border-radius:4px; text-align:right; display:block; line-height:1.2; font-weight:600; text-shadow:0 1px 1px rgba(255,255,255,0.9); transition:all .2s ease; letter-spacing:.5px; position:absolute; transform:translateY(50%); }
    .scale-point-horizontal { width:2px; height:100%; top:0; position:absolute; background-color:rgba(110,142,251,0.8); z-index:1; } 
    .scale-point-vertical { height:2px; width:100%; left:0; position:absolute; background-color:rgba(110,142,251,0.8); z-index:1; }

    .scale-line-horizontal:hover, .scale-line-vertical:hover {
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    #loader-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 10001;
        justify-content: center;
        align-items: center;
    }

    .loader-content {
        padding: 40px;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        text-align: center;
        animation: zoomIn 0.5s ease-out;
    }

    .spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 20px;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .notification {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 20px 30px;
        color: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateX(400px);
        transition: var(--transition);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 15px;
        max-width: 400px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .notification.success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .notification.error { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .notification.warning { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }
    .notification.info { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
        animation: slideInRight 0.5s ease-out;
    }

    .notification i {
        font-size: 24px;
        animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    @media (max-width: 1200px) {
        #map {
            left: 20px;
            top: 420px;
        }
        
        .weather-widget {
            left: 20px;
            top: 20px;
            bottom: auto;
            width: calc(100% - 40px);
            max-height: 380px;
        }
        
        #city-info-panel {
            left: 20px;
            top: 420px;
        }
    }

    @media (max-width: 768px) {
        :root {
            --border-radius: 15px;
        }

        #map {
            top: 400px;
            bottom: 70px;
        }

        .weather-widget {
            max-height: 360px;
            padding: 20px;
        }

        .city-name {
            font-size: 24px;
        }

        #temperature {
            font-size: 40px;
        }

        .weather-icon {
            font-size: 60px;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        #city-info-panel {
            top: 400px;
            padding: 30px 20px 20px;
        }

        #city-info-panel h2 {
            font-size: 24px;
        }
        
        .scale-line-vertical {
            display: none;
        }

        .notification {
            bottom: 20px;
            right: 20px;
            left: 20px;
            max-width: none;
        }
    }

    @keyframes wiggle {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
    }

    .map-mode-button:active {
        animation: wiggle 0.3s ease-in-out;
    }

    #info-website-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        display: inline-block;
    }

    #info-website-link:hover {
        color: #764ba2;
        transform: translateX(5px);
    }

    .temperature-link {
        color: inherit;
        text-decoration: none;
        transition: var(--transition);
    }

    .temperature-link:hover {
        transform: scale(1.05);
        filter: brightness(1.2);
    }

    .custom-nspd-balloon-content { font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.5; color: #2d3748; }
    .custom-nspd-balloon-content strong { font-weight: 600; color: #1a2b3c; display: block; margin-bottom: 3px; }
    .custom-nspd-balloon-content .area-info { font-size: 0.9em; color: #555; }
    .custom-nspd-balloon-content hr { margin: 5px 0; border: none; border-top: 1px solid #ddd; }
</style>
<link rel="stylesheet" href="webfonts/all.min.css" />
</head>
<body>
<div class="particles" id="particles"></div>
<div id="map"></div>

<div class="weather-widget" id="weather-widget">
    <input type="text" id="city-input" placeholder="üîç –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞...">
    <div id="weather-data">
        <a class="city-name" id="city-name-display" target="_blank">–ó–∞–≥—Ä—É–∑–∫–∞...</a>
        <div class="date-time"></div>
        <div class="main-info">
            <div class="current-weather">
                <a href="#" class="temperature-link" target="_blank" id="icon-link">
                    <i class="weather-icon fas fa-cloud-sun"></i>
                </a>
                <a href="#" class="temperature-link" target="_blank" id="temperature-link">
                    <div id="temperature">--¬∞C</div>
                </a>
                <div id="description">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        <div class="details">
            <div>üå°Ô∏è –û—â—É—â–∞–µ—Ç—Å—è: <span id="feels-like">--¬∞C</span></div>
            <div>üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: <span id="humidity">--%</span></div>
            <div>üí® –í–µ—Ç–µ—Ä: <span id="wind-speed">-- –º/—Å</span></div>
        </div>
        <div class="forecast-wrapper">
            <h3>üìÖ –ó–∞–≤—Ç—Ä–∞</h3>
            <div class="forecast"></div>
        </div>
        <div class="distance-info" id="distance-info"></div>
        <div class="map-mode-switcher">
            <button class="map-mode-button" data-mode="map" title="–°—Ö–µ–º–∞">
                <i class="fas fa-map"></i>
            </button>
            <button class="map-mode-button" data-mode="satellite" title="–°–ø—É—Ç–Ω–∏–∫">
                <i class="fas fa-satellite"></i>
            </button>
            <button class="map-mode-button" data-mode="hybrid" title="–ì–∏–±—Ä–∏–¥">
                <i class="fas fa-layer-group"></i>
            </button>
            <button class="map-mode-button" id="municipal-boundaries-button" title="–ì—Ä–∞–Ω–∏—Ü—ã –ú–û">
                <i class="fas fa-landmark"></i>
            </button>
            <button class="map-mode-button" id="show-city-info-button" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ä–æ–¥–µ">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
    </div>
</div>

<div id="city-info-panel">
    <button id="close-city-info-panel" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <button id="refresh-city-info-button" title="–û–±–Ω–æ–≤–∏—Ç—å">
        <i class="fas fa-sync-alt"></i>
    </button>
    <h2 id="info-city-name-header">üèôÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ä–æ–¥–µ</h2>
    <div class="loading-message">
        <div class="skeleton-loader"></div>
        <div class="skeleton-loader" style="width: 80%; margin-left: auto; margin-right: auto;"></div>
        <div class="skeleton-loader" style="width: 60%; margin-left: auto; margin-right: auto;"></div>
        <p id="loading-text-detail">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>
    </div>
    <div class="info-grid">
        <div class="info-item"><span class="info-label"><i class="fas fa-city"></i> –ì–æ—Ä–æ–¥:</span><span id="info-city-name"></span></div>
        <div class="info-item"><span class="info-label"><i class="fas fa-users"></i> –ù–∞—Å–µ–ª–µ–Ω–∏–µ:</span><span id="info-population"></span></div>
        <div class="info-item"><span class="info-label"><i class="fas fa-chart-area"></i> –ü–ª–æ—â–∞–¥—å:</span><span id="info-area"></span></div>
        <div class="info-item"><span class="info-label"><i class="fas fa-mail-bulk"></i> –ò–Ω–¥–µ–∫—Å:</span><span id="info-postal-code"></span></div>
        <div class="info-item"><span class="info-label"><i class="fas fa-calendar-alt"></i> –û—Å–Ω–æ–≤–∞–Ω:</span><span id="info-foundation-date"></span></div>
        <div class="info-item"><span class="info-label"><i class="fas fa-thermometer-half"></i> –°—Ä–µ–¥–Ω–µ–≥–æ–¥–æ–≤–∞—è t¬∞:</span><span id="info-avg-temp"></span></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-sitemap"></i> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ:</span><span id="info-hierarchy"></span></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-book-open"></i> –ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è:</span><p id="info-name-origin"></p></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-cloud-sun-rain"></i> –ö–ª–∏–º–∞—Ç:</span><p id="info-climate-summary"></p></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-landmark"></i> –ò—Å—Ç–æ—Ä–∏—è:</span><ul id="info-key-historical-events"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-church"></i> –†–µ–ª–∏–≥–∏—è:</span><ul id="info-religious-sites"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-university"></i> –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:</span><ul id="info-education-centers"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-bus-alt"></i> –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</span><ul id="info-transport-hubs"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-hiking"></i> –¢—É—Ä–∏–∑–º:</span><p id="info-tourism-summary"></p></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-industry"></i> –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å:</span><ul id="info-main-industries"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-star"></i> –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã:</span><ul id="info-notable-facts"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-user-friends"></i> –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ª—é–¥–∏:</span><ul id="info-famous-people"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-film"></i> –§–∏–ª—å–º—ã:</span><ul id="info-films-in-city"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-book"></i> –ö–Ω–∏–≥–∏:</span><ul id="info-books-about-city"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-music"></i> –ü–µ—Å–Ω–∏:</span><ul id="info-songs-about-city"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-building"></i> –ö–æ–º–ø–∞–Ω–∏–∏:</span><ul id="info-company-headquarters"></ul></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-plane-departure"></i> –ê—ç—Ä–æ–ø–æ—Ä—Ç:</span><div id="info-nearest-airport"></div></div>
        <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-link"></i> –í–µ–±-—Å–∞–π—Ç:</span><a id="info-website-link" href="#" target="_blank"></a></div>
    </div>
</div>

<div id="loader-overlay">
    <div class="loader-content">
        <div class="spinner"></div>
        <div id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script src="webfonts/supabase-js@2.js"></script>
<script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU" type="text/javascript"></script>
<script src="webfonts/proj4.js"></script>
<script>
    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        const particleCount = 30;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 5 + 2;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.bottom = '-10px';
            particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
            particle.style.animationDelay = Math.random() * 5 + 's';
            particlesContainer.appendChild(particle);
        }
    }
    createParticles();

    const weatherWidget = document.getElementById('weather-widget');
    const cityInput = document.getElementById('city-input');
    const temperatureElement = document.getElementById('temperature');
    const cityNameElement = document.getElementById('city-name-display');
    const descriptionElement = document.getElementById('description');
    const feelsLikeElement = document.getElementById('feels-like');
    const humidityElement = document.getElementById('humidity');
    const windSpeedElement = document.getElementById('wind-speed');
    const weatherIcon = document.querySelector('.weather-icon');
    const dateTimeElement = document.querySelector('.date-time');
    const temperatureLink = document.getElementById('temperature-link');
    const iconLink = document.getElementById('icon-link');
    const forecastContainer = document.querySelector('.forecast');
    const mapElement = document.getElementById('map');
    const distanceInfo = document.getElementById('distance-info');
    const cityInfoPanel = document.getElementById('city-info-panel');
    const infoCityNameHeader = document.getElementById('info-city-name-header');
    const infoCityName = document.getElementById('info-city-name');
    const infoPopulation = document.getElementById('info-population');
    const infoArea = document.getElementById('info-area');
    const infoPostalCode = document.getElementById('info-postal-code');
    const infoFoundationDate = document.getElementById('info-foundation-date');
    const infoHierarchy = document.getElementById('info-hierarchy');
    const infoAvgTemp = document.getElementById('info-avg-temp');
    const infoNameOrigin = document.getElementById('info-name-origin');
    const infoWebsite = document.getElementById('info-website-link');
    const infoNotableFacts = document.getElementById('info-notable-facts');
    const infoMainIndustries = document.getElementById('info-main-industries');
    const closeCityInfoPanelButton = document.getElementById('close-city-info-panel');
    const showCityInfoButton = document.getElementById('show-city-info-button');
    const infoFamousPeople = document.getElementById('info-famous-people');
    const infoFilmsInCity = document.getElementById('info-films-in-city');
    const infoBooksAboutCity = document.getElementById('info-books-about-city');
    const infoSongsAboutCity = document.getElementById('info-songs-about-city');
    const infoCompanyHeadquarters = document.getElementById('info-company-headquarters');
    const infoNearestAirport = document.getElementById('info-nearest-airport');
    const infoClimateSummary = document.getElementById('info-climate-summary');
    const infoKeyHistoricalEvents = document.getElementById('info-key-historical-events');
    const infoReligiousSites = document.getElementById('info-religious-sites');
    const infoEducationCenters = document.getElementById('info-education-centers');
    const infoTransportHubs = document.getElementById('info-transport-hubs');
    const infoTourismSummary = document.getElementById('info-tourism-summary');
    const PROXY_BASE_URL = 'https://mapruapi.vercel.app';

    let currentCity = localStorage.getItem('weatherCity') || '–ù—É—Ä–ª–∞—Ç';
   
    let cityCoordinates = null; let timezone = 'UTC'; let map; let previousCityCoords = null; let previousCityName = '';
    let originCoords = null; let originCityName = ''; let municipalBoundaryObjects = [];
    const municipalBoundariesButton = document.getElementById('municipal-boundaries-button');
    const NSP_MUNICIPAL_LAYER_ID = '36278';
    let currentAiCityData = null; let isAiCityDataLoading = false; let currentCityNameForAiQuery = '';

    let supabaseClient = null;
    const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';

    if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_ANON_KEY) {
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error("Error initializing Supabase client:", e);
        }
    }

    let currentSupabaseCityKey = '';
    const refreshCityInfoButton = document.getElementById('refresh-city-info-button');

    function sanitizeAdminRegion(region) {
        if (!region) return null;
        return region
            .replace(/–†–µ—Å–ø—É–±–ª–∏–∫–∞\s/i, '')
            .replace(/–∫—Ä–∞–π/i, '')
            .replace(/–æ–±–ª–∞—Å—Ç—å/i, '')
            .replace(/–ì–æ—Ä–æ–¥ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è\s/i, '')
            .trim();
    }
    
    function constructSupabaseKey(countryCode, adminRegion, cityName) {
        const sanitizedRegion = sanitizeAdminRegion(adminRegion);
        let keyParts = [countryCode, sanitizedRegion, cityName];
        return keyParts
            .filter(part => part && String(part).trim() !== '')
            .join('-')
            .toUpperCase()
            .replace(/ /g, '_')
            .replace(/[^\w\u0400-\u04FF\u0027\u002D_]+/gu, '')
            .replace(/_+/g, '_')
            .replace(/^_|_$/g, '');
    }

    async function geocodeCityWithYandex(cityName) {
        await new Promise(resolve => ymaps.ready(resolve));
        const result = await ymaps.geocode(cityName, { results: 1 });
        const geoObject = result.geoObjects.get(0);

        if (!geoObject) return null;

        let finalCityName = geoObject.properties.get('name');
        const components = geoObject.properties.get('metaDataProperty.GeocoderMetaData.Address.Components', []);
        const findComponent = (kind) => components.find(c => c.kind === kind);

        if (!finalCityName) {
            const localityComponent = findComponent('locality');
            if (localityComponent) {
                finalCityName = localityComponent.name;
            } else {
                finalCityName = cityName;
            }
        }

        const provinceComponent = findComponent('province');
        const areaComponent = findComponent('area');
        const countryComponent = findComponent('country');

        const adminRegion = provinceComponent ? provinceComponent.name : (areaComponent ? areaComponent.name : null);
        const countryName = countryComponent ? countryComponent.name : geoObject.getCountryCode();
        const coords = geoObject.geometry.getCoordinates();

        return {
            cityName: finalCityName,
            countryCode: countryName,
            adminRegion: adminRegion,
            coords: coords
        };
    }

    async function saveCityDataToSupabase(cityKey, jsonData) {
        if (!supabaseClient || !cityKey) return;
        try {
            const { error } = await supabaseClient
                .from('city_data')
                .upsert({ city_key: cityKey, json_data: jsonData, created_at: new Date().toISOString() }, { onConflict: 'city_key' });
            if (error) throw error;
        } catch (error) {
            console.error('Error saving city data to Supabase:', error);
        }
    }

    async function getCityInfo(supabaseKey, aiQueryName) {
        if (!supabaseKey || !aiQueryName) {
            currentAiCityData = null;
            isAiCityDataLoading = false;
            renderCityInfoPanelState();
            return;
        }
        isAiCityDataLoading = true;
        renderCityInfoPanelState();
        if (supabaseClient) {
            try {
                const { data: supabaseData, error: supabaseError } = await supabaseClient
                    .from('city_data')
                    .select('json_data, created_at')
                    .eq('city_key', supabaseKey)
                    .single();
                if (supabaseError && supabaseError.code !== 'PGRST116') throw supabaseError;
                if (supabaseData) {
                    currentAiCityData = supabaseData.json_data;
                    isAiCityDataLoading = false;
                    renderCityInfoPanelState();
                    return;
                }
            } catch (error) {
                console.error('Error fetching city data from Supabase:', error);
            }
        }
        await _fetchCityInfoFromAIInternal(aiQueryName, supabaseKey);
    }

    async function tryFetchWeather(cityNameForAPI) {
        if (!cityNameForAPI || String(cityNameForAPI).trim() === '') return null;
        const apiUrl = `${PROXY_BASE_URL}/api/weather?city=${encodeURIComponent(cityNameForAPI)}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                return null;
            }
            const data = await response.json();
            if (data.cod === "200") {
                return data;
            }
            return null;
        } catch (error) {
            return null;
        }
    }

    async function _fetchCityInfoFromAIInternal(cityName, supabaseKeyToSave) {
        const PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
        const MODEL_NAME = "gemini-2.5-flash-lite";
        const requestUrl = `${PROXY_BASE_URL}/v1beta/models/${MODEL_NAME}:generateContent`;

        const prompt = `–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–º –ø—É–Ω–∫—Ç–µ "${cityName}" –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –û—Ç–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏. –î–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—è, –≥–¥–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–º–Ω–µ–Ω–∏—è, —è–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ 'null'. –û–±—ä–µ–∫—Ç JSON –î–û–õ–ñ–ï–ù —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏: "name" (–Ω–∞ —Ä—É—Å—Å–∫–æ–º), "population", "area_sq_km", "postal_code", "foundation_date", "administrative_hierarchy" (array), "avg_annual_temp_celsius", "name_origin_summary", "official_website", "notable_facts" (array), "main_industries" (array), "famous_people" (array), "films_set_in_city" (array), "books_about_city" (array), "songs_about_city" (array), "company_headquarters" (array), "nearest_airport_info" (object), "climate_summary", "key_historical_events" (array), "religious_sites" (array), "education_centers" (array), "transport_hubs" (array), "tourism_summary", "open_weather_map_name" (–∫–æ—Ä–æ—Ç–∫–æ–µ, —á–∏—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –ê–ù–ì–õ–ò–ô–°–ö–û–ú —è–∑—ã–∫–µ, –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ 'q' –≤ API OpenWeatherMap, –Ω–∞–ø—Ä–∏–º–µ—Ä 'Aksubayevo', 'Moscow', 'Nurlat'). –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç. –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –∫—Ä–æ–º–µ open_weather_map_name, –î–û–õ–ñ–ï–ù –±—ã—Ç—å —Ä—É—Å—Å–∫–∏–º.`;
        
        isAiCityDataLoading = true;
        renderCityInfoPanelState();

        try {
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        "response_mime_type": "application/json",
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ API –ò–ò (${response.status})`);
            }

            const data = await response.json();
            let cityDataJson = data?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!cityDataJson) {
                throw new Error("–û—Ç–≤–µ—Ç –ò–ò –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
            }

            let parsedCityData;
            try {
                const cleanedJson = cityDataJson.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
                parsedCityData = JSON.parse(cleanedJson);
            } catch (e) {
                throw new Error(`–ò–ò –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON`);
            }

            currentAiCityData = parsedCityData;
            if (supabaseKeyToSave && currentAiCityData) {
                await saveCityDataToSupabase(supabaseKeyToSave, currentAiCityData);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Ä–æ–¥–µ –æ—Ç –ò–ò:', error);
            currentAiCityData = null;
        } finally {
            isAiCityDataLoading = false;
        }
    }

    if (typeof proj4 !== 'undefined') { proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs"); proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs"); } 
    else { console.error("Proj4 library is not loaded!"); }

    function showLoader(message = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
        const loader = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        if (loader && loaderText) {
            loaderText.textContent = message;
            loader.style.display = 'flex';
        }
    }

    function hideLoader() {
        const loader = document.getElementById('loader-overlay');
        if (loader) {
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        }
    }

    function showNotification(message, type = 'success', iconName = 'info-circle') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) existingNotification.remove();
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<i class="fas fa-${iconName}"></i> <span>${message}</span>`;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 500);
        }, 4000);
    }

    async function getTimezoneByCoordinates(lat, lon) {
        const url = `${PROXY_BASE_URL}/api/timezone?lat=${lat}&lon=${lon}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                return 'UTC';
            }
            const data = await response.json();
            if (data.timezoneId) return data.timezoneId;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:', error);
        }
        return 'UTC';
    }

    function updateDateTime() { const now = new Date(); const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: timezone }; dateTimeElement.textContent = new Intl.DateTimeFormat('ru-RU', options).format(now); }
    function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }
    function animateDistanceValue(element, finalDistance) { let currentDistance = 0; const numSteps = 50; const increment = finalDistance / numSteps; let stepCount = 0; const interval = setInterval(() => { currentDistance += increment; stepCount++; if (stepCount >= numSteps || currentDistance >= finalDistance) { currentDistance = finalDistance; clearInterval(interval); } element.textContent = currentDistance.toFixed(1); }, 20); }

    function initMap() { 
        map = new ymaps.Map('map', { center: [55.75, 37.62], zoom: 10, controls: [] }); 
        const horizontalScaleElement=document.createElement('div');horizontalScaleElement.className='scale-line-horizontal';const horizontalSegments=document.createElement('div');horizontalSegments.className='scale-segments-horizontal';const horizontalLabels=document.createElement('div');horizontalLabels.className='scale-labels-horizontal';const verticalScaleElement=document.createElement('div');verticalScaleElement.className='scale-line-vertical';const verticalSegments=document.createElement('div');verticalSegments.className='scale-segments-vertical';const verticalLabels=document.createElement('div');verticalLabels.className='scale-labels-vertical';horizontalScaleElement.appendChild(horizontalSegments);horizontalScaleElement.appendChild(horizontalLabels);verticalScaleElement.appendChild(verticalSegments);verticalScaleElement.appendChild(verticalLabels);mapElement.appendChild(horizontalScaleElement);mapElement.appendChild(verticalScaleElement);
        function updateScales(){const zoom=map.getZoom();const projection=map.options.get('projection');horizontalLabels.innerHTML='';verticalLabels.innerHTML='';horizontalSegments.innerHTML='';verticalSegments.innerHTML='';function getNiceScaleValues(totalDistance,count=6){const magnitudes={0:1,1:2,2:5,3:10,4:20,5:50,6:100,7:200,8:500,9:1000,10:2000,11:5000,12:10000,13:20000,14:50000};let step;const approxStep=totalDistance/(count-1);let magnitude=0;while(magnitudes[magnitude]<approxStep&&magnitude<14)magnitude++;step=magnitudes[magnitude];const values=[];let currentValue=0;while(currentValue<=totalDistance&&values.length<count){values.push(currentValue);currentValue+=step;} return values.map(value=>{let unit='–º';let displayValue=value;if(value>=1000){unit='–∫–º';displayValue=value/1000;if(displayValue%1!==0)displayValue=displayValue.toFixed(1);} return{value:value,display:`${displayValue} ${unit}`,displayCompact:value>=1000?`${displayValue}${unit}`:`${displayValue} ${unit}`};});} const bounds=map.getBounds();const southWest=bounds[0];const northEast=bounds[1];const horizontalDistance=ymaps.coordSystem.geo.getDistance([southWest[0],southWest[1]],[southWest[0],northEast[1]]);const verticalDistance=ymaps.coordSystem.geo.getDistance([southWest[0],southWest[1]],[northEast[0],southWest[1]]);const horizontalValues=getNiceScaleValues(horizontalDistance);const verticalValues=getNiceScaleValues(verticalDistance);const horizontalWidth=horizontalScaleElement.offsetWidth-30;const verticalHeight=verticalScaleElement.offsetHeight-30;horizontalValues.forEach(item=>{if(item.value>0){const percent=(item.value/horizontalValues[horizontalValues.length-1].value)*100;const position=(percent/100)*horizontalWidth;const point=document.createElement('div');point.className='scale-point-horizontal';point.style.left=`${position}px`;horizontalSegments.appendChild(point);} const label=document.createElement('span');label.textContent=item.display;const percent=(item.value/horizontalValues[horizontalValues.length-1].value)*100;label.style.left=`${percent}%`;horizontalLabels.appendChild(label);});verticalValues.forEach(item=>{if(item.value>0){const percent=(item.value/verticalValues[verticalValues.length-1].value)*100;const position=(percent/100)*verticalHeight;const point=document.createElement('div');point.className='scale-point-vertical';point.style.bottom=`${position}px`;verticalSegments.appendChild(point);} const label=document.createElement('span');label.textContent=item.displayCompact;const percent=(item.value/verticalValues[verticalValues.length-1].value)*100;label.style.bottom=`${percent}%`;verticalLabels.appendChild(label);});} map.events.add('boundschange',updateScales);map.events.add('sizechange',updateScales);setTimeout(updateScales,100); 
        const savedMode = localStorage.getItem('mapMode') || 'map'; setMapMode(savedMode); document.querySelectorAll('.map-mode-button').forEach(b => { if (b.getAttribute('data-mode') === savedMode && !b.id.includes('boundaries')) b.classList.add('active'); }); 
    }

    function setMapMode(mode) { if(!map) return; switch(mode){case'map':map.setType('yandex#map');break;case'satellite':map.setType('yandex#satellite');break;case'hybrid':map.setType('yandex#hybrid');break;}localStorage.setItem('mapMode',mode); }
    function updateMap(lat, lon, prevCoords = null) { if(!map)initMap();const newCenter=[lat,lon];const zoomLevels={initial:10,flyOut:5,arrival:10,final:13};if(prevCoords){const polyline=new ymaps.Polyline([[prevCoords.lat,prevCoords.lon],[lat,lon]],{},{strokeColor:'white',strokeWidth:3,strokeOpacity:0.7,strokeStyle:'dash'});map.geoObjects.add(polyline);map.setCenter([prevCoords.lat,prevCoords.lon],zoomLevels.flyOut,{duration:1500}).then(()=>map.setCenter(newCenter,zoomLevels.arrival,{duration:2000})).then(()=>{map.geoObjects.remove(polyline);map.setCenter(newCenter,zoomLevels.final,{duration:2000});});}else{map.setCenter(newCenter,zoomLevels.arrival,{duration:2000}).then(()=>map.setCenter(newCenter,zoomLevels.final,{duration:2000}));}}
    function updateWeatherIcon(iconCode) { const iconMapping={'01d':'fa-sun','01n':'fa-moon','02d':'fa-cloud-sun','02n':'fa-cloud-moon','03d':'fa-cloud','03n':'fa-cloud','04d':'fa-cloud-meatball','04n':'fa-cloud-meatball','09d':'fa-cloud-showers-heavy','09n':'fa-cloud-showers-heavy','10d':'fa-cloud-rain','10n':'fa-cloud-rain','11d':'fa-bolt','11n':'fa-bolt','13d':'fa-snowflake','13n':'fa-snowflake','50d':'fa-smog','50n':'fa-smog',};const iconClass=iconMapping[iconCode]||'fa-question';weatherIcon.className='weather-icon fas '+iconClass;return iconClass;}
    
    async function updateWeather(city) {
        showLoader(`–ó–∞–≥—Ä—É–∑–∫–∞ "${city}"...`);

        let yandexGeoData;
        try {
            yandexGeoData = await geocodeCityWithYandex(city);
            if (!yandexGeoData) throw new Error(`–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ —Å–º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏: ${city}`);
        } catch (error) {
            hideLoader();
            showNotification(error.message, 'error', 'map-marker-alt');
            return;
        }

        currentAiCityData = null;
        isAiCityDataLoading = true;

        previousCityCoords = cityCoordinates ? { ...cityCoordinates } : null;

        currentSupabaseCityKey = constructSupabaseKey(yandexGeoData.countryCode, yandexGeoData.adminRegion, yandexGeoData.cityName);
        currentCityNameForAiQuery = yandexGeoData.cityName;
        currentCity = yandexGeoData.cityName;
        cityCoordinates = { lat: yandexGeoData.coords[0], lon: yandexGeoData.coords[1] };
        
        if (cityInfoPanel.classList.contains('visible')) {
            renderCityInfoPanelState();
        }

        const weatherPromise = tryFetchWeather(yandexGeoData.cityName);
        const cityInfoPromise = getCityInfo(currentSupabaseCityKey, currentCityNameForAiQuery);

        let [weatherData] = await Promise.all([weatherPromise, cityInfoPromise]);

        if (!weatherData && currentAiCityData && currentAiCityData.open_weather_map_name) {
            showNotification(`–ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–æ—á–Ω–µ–Ω–Ω–æ–µ –∏–º—è: "${currentAiCityData.open_weather_map_name}"`, 'success', 'check-circle');
            weatherData = await tryFetchWeather(currentAiCityData.open_weather_map_name);
        }
        
        hideLoader();

        if (weatherData) {
            timezone = await getTimezoneByCoordinates(cityCoordinates.lat, cityCoordinates.lon);
            updateDateTime();
            const owmResolvedCityName = weatherData.city.name;
            cityNameElement.textContent = owmResolvedCityName;
            cityNameElement.href = `https://yandex.ru/maps/?pt=${cityCoordinates.lon},${cityCoordinates.lat}&z=12&l=map`;
            localStorage.setItem('weatherCity', yandexGeoData.cityName);
            const weather = weatherData.list[0];
            temperatureElement.textContent = `${Math.round(weather.main.temp)}¬∞C`;
            descriptionElement.textContent = weather.weather[0].description;
            feelsLikeElement.textContent = `${Math.round(weather.main.feels_like)}¬∞C`;
            humidityElement.textContent = `${weather.main.humidity}%`;
            windSpeedElement.textContent = `${weather.wind.speed.toFixed(1)} –º/—Å`;
            updateWeatherIcon(weather.weather[0].icon);
            const weatherDetailsLink = `https://www.gismeteo.ru/search/${encodeURIComponent(owmResolvedCityName)}/`;
            temperatureLink.href = weatherDetailsLink;
            iconLink.href = weatherDetailsLink;
            forecastContainer.innerHTML = '';
            const tomorrowsForecasts = weatherData.list.filter(item => { const itemDate = new Date(item.dt_txt); const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); return itemDate.getDate() === tomorrow.getDate() && itemDate.getHours() === 15; });
            if (tomorrowsForecasts.length > 0) { const tomorrowWeather = tomorrowsForecasts[0]; const forecastDiv = document.createElement('div'); forecastDiv.innerHTML = `<i class="fas ${updateWeatherIcon(tomorrowWeather.weather[0].icon)}" style="font-size:24px;"></i><div>${Math.round(tomorrowWeather.main.temp)}¬∞C, ${tomorrowWeather.weather[0].description}</div>`; forecastContainer.appendChild(forecastDiv); } else { forecastContainer.innerHTML = '<div>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (15:00) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>'; }
            if (previousCityCoords && previousCityName) { const distance = calculateDistance(previousCityCoords.lat, previousCityCoords.lon, cityCoordinates.lat, cityCoordinates.lon); distanceInfo.innerHTML = `<span>${previousCityName} <i class="fas fa-plane"></i> ${owmResolvedCityName}: </span><span class="distance-value"><strong>0.0</strong> –∫–º</span>`; distanceInfo.classList.add('visible'); const distanceValueElement = distanceInfo.querySelector('.distance-value strong'); if (distanceValueElement) animateDistanceValue(distanceValueElement, distance); } else { distanceInfo.classList.remove('visible'); distanceInfo.innerHTML = ''; }
            previousCityName = owmResolvedCityName;
        } else {
            showNotification(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –¥–ª—è "${currentCityNameForAiQuery}"`, 'error', 'exclamation-triangle');
            temperatureElement.textContent = `--¬∞C`;
            descriptionElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            feelsLikeElement.textContent = `--¬∞C`;
            humidityElement.textContent = `--%`;
            windSpeedElement.textContent = `-- –º/—Å`;
            weatherIcon.className = 'weather-icon fas fa-question-circle';
            cityNameElement.textContent = currentCityNameForAiQuery;
        }
        
        updateMap(cityCoordinates.lat, cityCoordinates.lon, previousCityCoords);
        renderCityInfoPanelState();
    }

    function calculateShoelaceArea(coordinatesRing) {let area=0;const n=coordinatesRing.length;if(n<3)return 0;for(let i=0;i<n;i++){const p1=coordinatesRing[i];const p2=coordinatesRing[(i+1)%n];if(p1&&p2&&typeof p1[0]==='number'&&typeof p1[1]==='number'&&typeof p2[0]==='number'&&typeof p2[1]==='number'){area+=(p1[0]*p2[1])-(p2[0]*p1[1]);}else{console.warn("Invalid coordinate pair in Shoelace calculation:",p1,p2);return 0;}} return Math.abs(area/2.0);}
    async function queryMunicipalInfo(latitude, longitude) { const toEPSG3857=(lat,lon)=>{if(typeof proj4==='undefined')throw new Error("proj4 is not defined");return proj4("EPSG:4326","EPSG:3857",[lon,lat]);};const centerPoint=toEPSG3857(latitude,longitude);const centerX=centerPoint[0];const centerY=centerPoint[1];const polygonSizeMeters=0.15;const halfSize=polygonSizeMeters/2;const minX=centerX-halfSize;const minY=centerY-halfSize;const maxX=centerX+halfSize;const maxY=centerY+halfSize;const width=512;const height=512;const i=width/2;const j=height/2;const bbox=`${minX},${minY},${maxX},${maxY}`;const url=`https://nspd.gov.ru/api/aeggis/v4/${NSP_MUNICIPAL_LAYER_ID}/wms?REQUEST=GetFeatureInfo&QUERY_LAYERS=${NSP_MUNICIPAL_LAYER_ID}&SERVICE=WMS&VERSION=1.3.0&FORMAT=image%2Fpng%2F&STYLES=&TRANSPARENT=true&LAYERS=${NSP_MUNICIPAL_LAYER_ID}&RANDOM=${Math.random()}&INFO_FORMAT=application%2Fjson&FEATURE_COUNT=10&I=${i}&J=${j}&WIDTH=${width}&HEIGHT=${height}&CRS=EPSG%3A3857&BBOX=${bbox}`;try{const response=await fetch(url);if(!response.ok)throw new Error(`NSPD API error: ${response.status}`);const data=await response.json();return data;}catch(error){console.error('Error fetching municipal data from NSPD:',error);showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≥—Ä–∞–Ω–∏—Ü: '+error.message,'error','exclamation-triangle');return null;}}
    function clearPreviousMunicipalBoundaries() { if(map&&map.balloon&&map.balloon.isOpen()){map.balloon.close();} municipalBoundaryObjects.forEach(obj=>{if(map&&map.geoObjects.indexOf(obj)!==-1)map.geoObjects.remove(obj);});municipalBoundaryObjects=[];}
    async function handleMunicipalBoundariesClick() { if (!map) { showNotification('–ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'error', 'exclamation-triangle'); return; } if (typeof proj4 === 'undefined') { showNotification('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ proj4 –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error', 'exclamation-triangle'); return; } const mapCenter = map.getCenter(); const lat = mapCenter[0]; const lon = mapCenter[1]; showLoader("–ó–∞–ø—Ä–æ—Å –≥—Ä–∞–Ω–∏—Ü –ú–û..."); const municipalData = await queryMunicipalInfo(lat, lon); hideLoader(); if (!municipalData || !municipalData.features || municipalData.features.length === 0) { showNotification('–ì—Ä–∞–Ω–∏—Ü—ã –ú–û –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning', 'info-circle'); return; } let newPolygonsBounds = null; let featuresDrawnThisCall = 0; const randomColorChoices = ['#FF0000', '#0000FF', '#008000', '#FFFF00', '#FFFFFF', '#FF00FF', '#00FFFF']; const currentRandomBaseColor = randomColorChoices[Math.floor(Math.random() * randomColorChoices.length)]; const fillOpacity = 0.03; const featuresWithData = municipalData.features.map(feature => { let area = 0; let yandexPolygonsCoords = []; let originalNspdCoordsRings = []; if (feature.geometry && feature.geometry.coordinates) { const geometryType = feature.geometry.type; const nspdCoordinates = feature.geometry.coordinates; const processRingEPSG3857 = (ringEPSG3857) => ringEPSG3857.map(coordEPSG3857 => { try { const wgs84 = proj4("EPSG:3857", "EPSG:4326", coordEPSG3857); return [wgs84[1], wgs84[0]]; } catch (e) { return null; } }).filter(c => c !== null); if (geometryType === 'Polygon') { originalNspdCoordsRings.push(nspdCoordinates[0]); const outerRingWGS84 = processRingEPSG3857(nspdCoordinates[0]); if (outerRingWGS84.length >= 3) { const innerRingsWGS84 = nspdCoordinates.slice(1).map(processRingEPSG3857).filter(ring => ring.length >=3); yandexPolygonsCoords.push([outerRingWGS84, ...innerRingsWGS84]); } } else if (geometryType === 'MultiPolygon') { nspdCoordinates.forEach((polygonRingsEPSG3857) => { if (polygonRingsEPSG3857 && polygonRingsEPSG3857[0]) { originalNspdCoordsRings.push(polygonRingsEPSG3857[0]); const outerRingWGS84 = processRingEPSG3857(polygonRingsEPSG3857[0]); if (outerRingWGS84.length >= 3) { const innerRingsWGS84 = polygonRingsEPSG3857.slice(1).map(processRingEPSG3857).filter(ring => ring.length >=3); yandexPolygonsCoords.push([outerRingWGS84, ...innerRingsWGS84]); } } }); } } originalNspdCoordsRings.forEach(ring => area += calculateShoelaceArea(ring)); return { featureData: feature, calculatedArea: area, yandexCoordsList: yandexPolygonsCoords, hintText: feature.properties.descr || (feature.properties.options && feature.properties.options.name) || `–ú–û ID: ${feature.id}` }; }).filter(f => f.calculatedArea > 0 && f.yandexCoordsList.length > 0); featuresWithData.sort((a, b) => b.calculatedArea - a.calculatedArea); let tempNewPolygons = []; featuresWithData.forEach((processedFeature, featureListIndex) => { processedFeature.yandexCoordsList.forEach((singlePolygonYandexCoords, yandexPolyIdx) => { if (singlePolygonYandexCoords[0] && singlePolygonYandexCoords[0].length >= 3) { try { const currentZIndex = 600 + featureListIndex; const areaKm2 = (processedFeature.calculatedArea / 1000000).toFixed(2); const polygon = new ymaps.Polygon(singlePolygonYandexCoords, { moName: processedFeature.hintText, moArea: processedFeature.calculatedArea, moAreaKm2: areaKm2, moPartId: `${processedFeature.featureData.id}_${yandexPolyIdx}` }, { strokeColor: currentRandomBaseColor, strokeWidth: 3, strokeOpacity: 0.8, fillColor: currentRandomBaseColor, fillOpacity: fillOpacity, zIndex: currentZIndex, openHintOnHover: false }); tempNewPolygons.push(polygon); map.geoObjects.add(polygon); featuresDrawnThisCall++; const bounds = polygon.geometry.getBounds(); if (bounds) { if (!newPolygonsBounds) { newPolygonsBounds = bounds; } else { newPolygonsBounds = [ [Math.min(newPolygonsBounds[0][0], bounds[0][0]), Math.min(newPolygonsBounds[0][1], bounds[0][1])], [Math.max(newPolygonsBounds[1][0], bounds[1][0]), Math.max(newPolygonsBounds[1][1], bounds[1][1])] ]; } } } catch (e) { console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞ Yandex Maps –¥–ª—è feature ${processedFeature.featureData.id}, polygon ${yandexPolyIdx + 1}:`, e); } } }); }); municipalBoundaryObjects.push(...tempNewPolygons); if (municipalBoundaryObjects.length > 0) { municipalBoundaryObjects.forEach(poly => { poly.options.set({ strokeColor: currentRandomBaseColor, fillColor: currentRandomBaseColor, fillOpacity: fillOpacity }); poly.events.remove(['mouseenter', 'mouseleave']); poly.events.add('mouseenter', function (e) { const mouseCoords = e.get('coords'); let overlappingMoItemsMap = new Map(); municipalBoundaryObjects.forEach(moPoly => { if (moPoly.geometry.contains(mouseCoords)) { const name = moPoly.properties.get('moName'); const area = moPoly.properties.get('moArea'); const areaKm2 = moPoly.properties.get('moAreaKm2'); if (!overlappingMoItemsMap.has(name) || area < overlappingMoItemsMap.get(name).area) { overlappingMoItemsMap.set(name, { name, area, areaKm2 }); } } }); let overlappingMoItems = Array.from(overlappingMoItemsMap.values()); overlappingMoItems.sort((a,b) => a.area - b.area); let balloonHtmlContent = '<div class="custom-nspd-balloon-content">'; overlappingMoItems.forEach((item, index) => { balloonHtmlContent += `<div><strong>${item.name}</strong></div><div class="area-info">${item.areaKm2} –∫–º¬≤</div>`; if (index < overlappingMoItems.length - 1) balloonHtmlContent += '<hr>'; }); balloonHtmlContent += '</div>'; if (overlappingMoItems.length > 0) map.balloon.open(mouseCoords, balloonHtmlContent, { closeButton: false, autoPan: false, offset: [0, -25]}); }); poly.events.add('mouseleave', function () { map.balloon.close(); }); }); } if (featuresDrawnThisCall > 0 && newPolygonsBounds) { map.setBounds(newPolygonsBounds, { checkZoomRange: true, duration: 500 }); showNotification(`–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–æ–≤—ã—Ö –≥—Ä–∞–Ω–∏—Ü –ú–û: ${featuresDrawnThisCall}`, 'success', 'check-circle'); } else if (featuresDrawnThisCall === 0 && municipalData.features.length > 0) { showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –ú–û', 'warning', 'exclamation-triangle'); } else if (featuresDrawnThisCall === 0) { showNotification('–ù–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –ú–û –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.', 'info', 'info-circle'); } }
    
    function clearCityInfoPanelData() { document.querySelectorAll('#city-info-panel .info-item span:not(.info-label), #city-info-panel .info-item p, #city-info-panel .info-item ul, #city-info-panel .info-item div:not(.info-label)').forEach(el => { if (el.tagName === 'UL') el.innerHTML = ''; else if (el.tagName === 'A') { el.href = '#'; el.textContent = ''; } else el.textContent = ''; }); document.querySelectorAll('#city-info-panel .info-item').forEach(item => { item.style.display = ''; }); }
    const setInfoText = (element, value, suffix = '') => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { if (value !== null && value !== undefined && String(value).trim() !== '' && String(value).toLowerCase() !== 'null') { element.textContent = `${value}${suffix}`; parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.textContent = ''; } } };
    const setInfoList = (element, dataArray) => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { const filteredData = Array.isArray(dataArray) ? dataArray.filter(item => item !== null && item !== undefined && String(item).trim() !== '' && String(item).toLowerCase() !== 'null') : []; if (filteredData.length > 0) { element.innerHTML = filteredData.map(item => `<li>${item}</li>`).join(''); parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.innerHTML = ''; } } };
    const setInfoHtml = (element, data, htmlGenerator) => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { let htmlContent = ''; if (data !== null && data !== undefined && String(data).toLowerCase() !== 'null' && !(Array.isArray(data) && data.length === 0) && !(typeof data === 'object' && data !== null && Object.keys(data).length === 0)) { htmlContent = htmlGenerator(data); } if (htmlContent.trim() !== '' && htmlContent.toLowerCase() !== 'null') { element.innerHTML = htmlContent; parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.innerHTML = ''; } } };
    function populateCityInfoPanelWithData(data) {
        setInfoText(infoCityName, data.name); setInfoText(infoPopulation, data.population); setInfoText(infoArea, data.area_sq_km, ' –∫–º¬≤');
        setInfoText(infoPostalCode, data.postal_code); setInfoText(infoFoundationDate, data.foundation_date);
        setInfoText(infoAvgTemp, data.avg_annual_temp_celsius, ' ¬∞C');
        setInfoHtml(infoHierarchy, data.administrative_hierarchy, (arr) => Array.isArray(arr) ? arr.join('<br>') : '');
        setInfoText(infoNameOrigin, data.name_origin_summary);
        setInfoText(infoClimateSummary, data.climate_summary);
        setInfoList(infoKeyHistoricalEvents, data.key_historical_events);
        setInfoList(infoReligiousSites, data.religious_sites);
        setInfoList(infoEducationCenters, data.education_centers);
        setInfoList(infoTransportHubs, data.transport_hubs);
        setInfoText(infoTourismSummary, data.tourism_summary);
        setInfoList(infoMainIndustries, data.main_industries); setInfoList(infoNotableFacts, data.notable_facts);
        setInfoList(infoFamousPeople, data.famous_people); setInfoList(infoFilmsInCity, data.films_set_in_city);
        setInfoList(infoBooksAboutCity, data.books_about_city); setInfoList(infoSongsAboutCity, data.songs_about_city);
        setInfoList(infoCompanyHeadquarters, data.company_headquarters);
        const websiteParent = infoWebsite ? infoWebsite.closest('.info-item') : null;
        if (infoWebsite && websiteParent) { if (data.official_website && String(data.official_website).startsWith('http') && String(data.official_website).toLowerCase() !== 'null') { infoWebsite.href = data.official_website; infoWebsite.textContent = data.official_website; websiteParent.style.display = ''; } else { infoWebsite.textContent = ''; infoWebsite.href = '#'; websiteParent.style.display = 'none'; } }
        setInfoHtml(infoNearestAirport, data.nearest_airport_info, (airport) => {
            let airportHtml = '';
            if (airport && typeof airport === 'object' && (airport.name || airport.code || airport.distance_km || airport.passenger_traffic || airport.passenger_traffic_per_year)) {
                airportHtml = `${airport.name || '–Ω/–¥'}${airport.code && String(airport.code).toLowerCase() !== 'null' ? ` (${airport.code})` : ''}`;
                if (airport.distance_km && String(airport.distance_km).toLowerCase() !== 'null') airportHtml += `<br>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${airport.distance_km} –∫–º`;
                const traffic = airport.passenger_traffic || airport.passenger_traffic_per_year;
                if (traffic && String(traffic).toLowerCase() !== 'null') airportHtml += `<br>–ü–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫: ${traffic}`;
            } else if (typeof airport === 'string' && airport.toLowerCase() !== 'null' && airport.trim() !== '') {
                airportHtml = airport;
            }
            return airportHtml;
        });
    }
    function renderCityInfoPanelState() { const header = infoCityNameHeader; const grid = cityInfoPanel.querySelector('.info-grid'); const loadingMessageDiv = cityInfoPanel.querySelector('.loading-message'); const loadingTextDetail = document.getElementById('loading-text-detail'); if (!cityInfoPanel.classList.contains('visible')) return; if (isAiCityDataLoading) { header.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${currentCityNameForAiQuery || '–ì–æ—Ä–æ–¥'}...`; grid.style.display = 'none'; loadingMessageDiv.style.display = 'block'; loadingTextDetail.textContent = `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ "${currentCityNameForAiQuery || '–≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ'}" –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...`; } else if (currentAiCityData) { header.textContent = `${currentAiCityData.name || currentCityNameForAiQuery || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Ä–æ–¥–µ'}`; grid.style.display = 'grid'; loadingMessageDiv.style.display = 'none'; populateCityInfoPanelWithData(currentAiCityData); } else { header.textContent = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: ${currentCityNameForAiQuery || '–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω'}`; grid.style.display = 'none'; loadingMessageDiv.style.display = 'block'; if (currentCityNameForAiQuery) { loadingTextDetail.textContent = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ "${currentCityNameForAiQuery}" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.`; } else { loadingTextDetail.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ –ø–æ–≥–æ–¥–Ω–æ–º –≤–∏–¥–∂–µ—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.'; } clearCityInfoPanelData(); } }

    document.querySelectorAll('.map-mode-button').forEach(button => { button.addEventListener('click',()=>{if(button.id==='municipal-boundaries-button' || button.id === 'show-city-info-button')return;const mode=button.getAttribute('data-mode');setMapMode(mode);document.querySelectorAll('.map-mode-button').forEach(btn=>{if(btn.id!=='municipal-boundaries-button' && btn.id !== 'show-city-info-button')btn.classList.remove('active');});if(!button.id.includes('boundaries'))button.classList.add('active');});});
    if (municipalBoundariesButton) municipalBoundariesButton.addEventListener('click', handleMunicipalBoundariesClick);
    cityInput.addEventListener('keydown', function(event) { if (event.key === 'Enter') { const newCity = cityInput.value.trim(); if (newCity) { updateWeather(newCity); } cityInput.value = ''; } });
    distanceInfo.addEventListener('click', function() { if (previousCityCoords && cityCoordinates) { const yandexRtext = `${previousCityCoords.lat},${previousCityCoords.lon}~${cityCoordinates.lat},${cityCoordinates.lon}`; window.open(`https://yandex.ru/maps/?rtext=${yandexRtext}&rtt=auto`, '_blank'); } });
    cityNameElement.addEventListener('click', function(event) { if (!cityCoordinates) event.preventDefault(); });
    dateTimeElement.addEventListener('click', function(event) { if (cityCoordinates && currentCity) window.open(`https://yandex.ru/images/search?text=${encodeURIComponent(currentCity)}`, '_blank'); else event.preventDefault(); });
    
    if (showCityInfoButton) { 
        showCityInfoButton.addEventListener('click', () => { 
            cityInfoPanel.classList.toggle('visible'); 
            if (cityInfoPanel.classList.contains('visible')) {
                if (!currentAiCityData && !isAiCityDataLoading && currentSupabaseCityKey && currentCityNameForAiQuery) {
                    getCityInfo(currentSupabaseCityKey, currentCityNameForAiQuery);
                } else {
                     renderCityInfoPanelState(); 
                }
            }
        }); 
    }
    if (closeCityInfoPanelButton) { closeCityInfoPanelButton.addEventListener('click', () => { cityInfoPanel.classList.remove('visible'); }); }
    
    if (refreshCityInfoButton) {
        refreshCityInfoButton.addEventListener('click', () => {
            if (currentCityNameForAiQuery && currentSupabaseCityKey) {
                _fetchCityInfoFromAIInternal(currentCityNameForAiQuery, currentSupabaseCityKey)
                    .finally(() => hideLoader());
            } else {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.', 'warning', 'info-circle');
            }
        });
    }
    
    window.addEventListener('resize', () => { if (cityInfoPanel && cityInfoPanel.classList.contains('visible')) { renderCityInfoPanelState(); } });
    document.querySelectorAll('.weather-widget, #city-info-panel').forEach(el => { el.style.scrollBehavior = 'smooth'; });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.info-item').forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        observer.observe(item);
    });

    ymaps.ready(initMap);
    updateWeather(currentCity);
    setInterval(updateDateTime, 10000);
</script>
</body>
</html>

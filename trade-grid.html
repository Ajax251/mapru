<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid-график с торговым симулятором</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="icon" href="img/stocks.png" type="image/png">
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --primary-color: #26a69a;
            --secondary-color: #ef5350;
            --border-color: #e0e0e0;
            --buy-color: #26a69a;
            --sell-color: #ef5350;
            --close-color: #ffca28;
            --active-filter-color: #1e88e5;
            --sell-bg-light: rgba(239, 83, 80, 0.08);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0;
            display: flex; height: 100vh; width: 100vw; overflow: hidden;
        }
        .container {
            display: flex; gap: 10px; width: 100%; height: 100%; padding: 10px;
        }
        .panel {
            background-color: var(--panel-bg); border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column;
        }
        .settings-panel {
            flex: 0 0 280px; padding: 20px;
        }
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; gap: 10px;
        }
        .chart-panel {
            flex-grow: 1; padding: 15px;
        }
        .trading-panel {
            flex: 0 0 350px; padding: 15px; display: none;
        }
        .trading-panel.active { display: flex; }

        h2 { color: #424242; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.1em; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #616161; font-size: 0.9em; }
        textarea, input { width: calc(100% - 20px); padding: 9px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; background-color: #fafafa; }
        textarea { height: 100px; resize: vertical; font-family: "Courier New", Courier, monospace; }
        button { background-color: #42a5f5; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #1e88e5; }
        button:active { transform: scale(0.98); }

        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .price-info { font-size: 1em; font-weight: 500; padding: 5px 10px; background-color: #e3f2fd; border-radius: 4px; color: #1e88e5; text-align: center; flex-grow: 1; margin: 0 10px; }
        .icon-btn { background: none; border: 1px solid #ccc; color: #555; width: 36px; height: 36px; padding: 0; margin: 0 2px; display: inline-flex; justify-content: center; align-items: center; border-radius: 4px; cursor: pointer; }
        .icon-btn:hover { background-color: #eee; border-color: #999; }
        .icon-btn svg { width: 20px; height: 20px; }
        #stepForward { background-color: var(--primary-color); color: white; border: none; width: auto; padding: 0 15px; }
        #stepForward:hover { background-color: #00897b; }

        .chart-container { width: 100%; height: calc(100% - 50px); position: relative; }
        #chart-placeholder { color: #999; text-align: center; padding-top: 20%; }
        
        .account-info { display: flex; gap: 20px; background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .account-info div { font-size: 1em; }
        .account-info span { font-weight: 600; }
        #accountEquity.profit { color: var(--buy-color); }
        #accountEquity.loss { color: var(--sell-color); }

        .order-form { display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr auto auto auto; gap: 8px; margin-bottom: 10px; align-items: center; }
        .order-form input { width: 100%; box-sizing: border-box; padding: 8px; margin: 0; }
        .comment-group { display: flex; align-items: center; gap: 5px; }
        #filterBtn { width: auto; padding: 6px 10px; font-size: 12px; background-color: #78909c; }
        #filterBtn.active { background-color: var(--active-filter-color); }
        .order-form button { width: auto; padding: 8px 15px; margin: 0; font-weight: 600; }
        .buy-button { background-color: var(--buy-color); }
        .sell-button { background-color: var(--sell-color); }
        .close-all-button { background-color: var(--close-color); color: #333; }
        
        .orders-container { flex-grow: 1; overflow-y: auto; max-height: 33vh; }
        .order-list-header, .order-item { display: grid; grid-template-columns: 40px 60px 50px 1fr 1fr 1fr 1.5fr 1fr 50px; gap: 10px; padding: 8px; align-items: center; font-size: 0.9em; }
        .order-list-header { font-weight: 600; color: #757575; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; background-color: var(--panel-bg); }
        .sortable-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; gap: 4px; }
        .sort-icon { color: #bdbdbd; transition: transform 0.2s, color 0.2s; }
        .sortable-header:hover .sort-icon { color: #757575; }
        .sort-icon.asc { transform: rotate(180deg); color: var(--active-filter-color); }
        .sort-icon.desc { transform: rotate(0deg); color: var(--active-filter-color); }

        .order-item { border-bottom: 1px solid var(--border-color); }
        .order-item.sell-order-highlight { background-color: var(--sell-bg-light); }
        .order-type-buy { color: var(--buy-color); font-weight: 600; }
        .order-type-sell { color: var(--sell-color); font-weight: 600; }
        .order-profit.positive { color: var(--buy-color); font-weight: 500; }
        .order-profit.negative { color: var(--sell-color); font-weight: 500; }
        .close-order-btn { background: none; border: none; padding: 0; cursor: pointer; }

        .history-container { margin-top: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        #closedOrdersList { flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); }
        .history-item { display: grid; grid-template-columns: 40px 1fr 1.5fr; gap: 10px; padding: 5px; font-size: 0.85em; border-bottom: 1px solid #f5f5f5; }
        .history-header { font-weight: 600; color: #757575; padding: 5px; border-bottom: 2px solid var(--border-color); }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel settings-panel">
            <h2>Настройки</h2>
            <div class="control-group">
                <label for="gridStepPips">Шаг сетки (пункты):</label>
                <input type="number" id="gridStepPips" value="50">
            </div>
            <div class="control-group">
                <label for="csvFile">MT4 CSV:</label>
                <input type="file" id="csvFile" accept=".csv,.txt">
            </div>
            <div class="control-group">
                <label for="priceData">Или вставьте данные:</label>
                <textarea id="priceData" placeholder="<DATE>,<TIME>,<OPEN>,<HIGH>,<LOW>,<CLOSE>,<VOL>"></textarea>
            </div>
            <button id="buildChartBtn">Построить график</button>
            <button id="startTradingBtn" style="background-color: var(--primary-color);">Начать симуляцию</button>

            <div class="history-container">
                <h2>История сделок</h2>
                <div class="history-item history-header">
                    <div>Шаг</div><div>Комментарий</div><div>Цена Откр./Закр.</div>
                </div>
                <div id="closedOrdersList">
                    <div style="text-align:center; color:#999; padding:15px;">Нет закрытых сделок</div>
                </div>
            </div>
        </div>

        <div class="panel main-content">
            <div class="chart-panel">
                <div class="chart-controls">
                     <div>
                        <button class="icon-btn" id="scrollLeft" title="Прокрутка влево"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" /></svg></button>
                        <button class="icon-btn" id="scrollRight" title="Прокрутка вправо"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg></button>
                        <button class="icon-btn" id="zoomIn" title="Приблизить"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg></button>
                        <button class="icon-btn" id="zoomOut" title="Отдалить"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H5V11H19V13Z" /></svg></button>
                        <button class="icon-btn" id="resetZoomBtn" title="Сбросить зум"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5,5H9V3H3V9H5V5M19,5V9H21V3H15V5H19M5,15V19H9V21H3V15H5M19,15H15V21H21V15H19Z" /></svg></button>
                    </div>
                    <div id="priceInfo" class="price-info">Наведите курсор на график</div>
                    <button id="stepForward" style="display: none;">Шаг вперед <svg style="width:16px; height:16px; vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M4,5V19L11,12M11,5V19L18,12" /></svg></button>
                </div>
                <div class="chart-container">
                    <canvas id="gridChart" style="display: none;"></canvas>
                    <div id="chart-placeholder">Здесь появится ваш график.</div>
                </div>
            </div>

            <div class="trading-panel" id="tradingPanel">
                <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
                    <div class="account-info">
                        <div>Баланс: $<span id="accountBalance">10000.00</span></div>
                        <div>Средства: $<span id="accountEquity">10000.00</span></div>
                        <div>Шаг: <span id="currentStepInfo">0 / 0</span></div>
                    </div>

                    <div class="order-form">
                        <input type="number" id="lotSize" value="0.1" step="0.01" min="0.01" placeholder="Лот" title="Лот">
                        <input type="number" id="stopLoss" placeholder="S/L (пункты)" title="Стоп-лосс в пунктах">
                        <input type="number" id="takeProfit" placeholder="T/P (пункты)" title="Тейк-профит в пунктах">
                        <div class="comment-group">
                            <input type="text" id="orderComment" placeholder="Комментарий">
                            <button id="filterBtn" title="Фильтр по комментарию">Фильтр</button>
                        </div>
                        <button class="buy-button" id="buyBtn">BUY</button>
                        <button class="sell-button" id="sellBtn">SELL</button>
                        <button class="close-all-button" id="closeAllBtn">Закрыть все</button>
                    </div>

                    <div class="orders-container">
                         <div class="order-list-header">
                            <div>Шаг</div>
                            <div>Тип</div>
                            <div>Лот</div>
                            <div>Цена откр.</div>
                            <div>S/L</div>
                            <div>T/P</div>
                            <div class="sortable-header" onclick="toggleCommentSort()" title="Сортировать по комментарию">
                                Комментарий
                                <svg id="sortCommentIcon" class="sort-icon" style="width:16px; height:16px;" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M7,10L12,15L17,10H7Z" />
                                </svg>
                            </div>
                            <div>Прибыль</div>
                            <div></div>
                        </div>
                        <div id="ordersList">
                            <div style="text-align: center; color: #999; padding: 20px;">Нет открытых позиций</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    let myChart = null, g_parsedData = null, g_gridData = null, isTradingMode = false,
        currentStepIndex = 0, orders = [], orderIdCounter = 1, accountBalance = 10000.00,
        startingBalance = 10000.00,
        closedOrders = [], 
        isFilterActive = false,
        commentSortState = 'none';

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
    document.getElementById('csvFile').addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { document.getElementById('priceData').value = e.target.result; g_parsedData = null; };
        reader.readAsText(file);
    });
    
    document.getElementById('buildChartBtn').addEventListener('click', () => {
        const rawData = document.getElementById('priceData').value.trim();
        if (rawData) g_parsedData = parseData(rawData);
        if (!g_parsedData) return alert('Нет данных для обработки.');
        const gridStepPips = parseInt(document.getElementById('gridStepPips').value);
        if (!gridStepPips || gridStepPips <= 0) return alert('Введите корректный шаг сетки.');
        g_gridData = generateGridData(g_parsedData, gridStepPips);
        isTradingMode ? initTradingMode() : drawChart(g_gridData);
    });

    document.getElementById('startTradingBtn').addEventListener('click', () => {
        if (!g_gridData) return alert('Сначала постройте график!');
        isTradingMode = !isTradingMode;
        const btn = document.getElementById('startTradingBtn');
        btn.textContent = isTradingMode ? 'Остановить симуляцию' : 'Начать симуляцию';
        btn.style.backgroundColor = isTradingMode ? 'var(--secondary-color)' : 'var(--primary-color)';
        document.getElementById('tradingPanel').classList.toggle('active', isTradingMode);
        document.getElementById('stepForward').style.display = isTradingMode ? 'flex' : 'none';
        isTradingMode ? initTradingMode() : drawChart(g_gridData);
    });
    
    document.getElementById('stepForward').addEventListener('click', () => {
        if (currentStepIndex >= g_gridData.dataPoints.length - 1) return alert('Достигнут конец данных!');
        
        const priceBefore = getCurrentPrice();
        currentStepIndex++;
        const priceAfter = getCurrentPrice();
        
        console.log(`\n--- [Шаг ${currentStepIndex}] ---`);
        console.log(`[Step Forward] Движение цены: ${priceBefore.toFixed(5)} -> ${priceAfter.toFixed(5)}`);

        let ordersWereClosed = checkStopsAndLimits(priceBefore, priceAfter);
        
        if (ordersWereClosed) {
            updateClosedOrdersList();
        }
        
        updateOrders(); 
        updateTradingDisplay(); 
        drawTradingChart();
    });

    document.getElementById('buyBtn').addEventListener('click', () => openOrder('buy'));
    document.getElementById('sellBtn').addEventListener('click', () => openOrder('sell'));
    document.getElementById('closeAllBtn').addEventListener('click', closeAllOrders);
    
    document.getElementById('filterBtn').addEventListener('click', () => {
        isFilterActive = !isFilterActive;
        document.getElementById('filterBtn').classList.toggle('active', isFilterActive);
        updateOrdersList();
    });

    document.getElementById('orderComment').addEventListener('input', (e) => {
        const text = e.target.value.trim();
        if (!text) { e.target.style.color = ''; return; }
        const isDuplicate = orders.some(o => o.comment === text);
        e.target.style.color = isDuplicate ? 'var(--secondary-color)' : '';
    });
    
    window.addEventListener('keydown', (e) => {
        if (e.key === 'F9' && isTradingMode) {
            e.preventDefault();
            document.getElementById('stepForward').click();
        }
    });

    // --- ФУНКЦИИ УПРАВЛЕНИЯ СИМУЛЯЦИЕЙ ---
    function initTradingMode() {
        currentStepIndex = 1; orders = []; orderIdCounter = 1; accountBalance = startingBalance;
        closedOrders = [];
        isFilterActive = false;
        commentSortState = 'none';
        document.getElementById('filterBtn').classList.remove('active');
        updateClosedOrdersList();
        updateOrders(); updateTradingDisplay(); drawTradingChart();
    }
    
    function openOrder(type) {
        const lotSize = parseFloat(document.getElementById('lotSize').value);
        if (isNaN(lotSize) || lotSize <= 0) return alert('Некорректный размер лота.');
        const takeProfitPips = parseInt(document.getElementById('takeProfit').value) || 0;
        const stopLossPips = parseInt(document.getElementById('stopLoss').value) || 0;
        const comment = document.getElementById('orderComment').value.trim() || '';
        const currentPrice = getCurrentPrice();
        const pointValue = getPointValue();
        let takeProfitPrice = 0, stopLossPrice = 0;

        if (takeProfitPips > 0) takeProfitPrice = type === 'buy' ? currentPrice + (takeProfitPips * pointValue) : currentPrice - (takeProfitPips * pointValue);
        if (stopLossPips > 0) stopLossPrice = type === 'buy' ? currentPrice - (stopLossPips * pointValue) : currentPrice + (stopLossPips * pointValue);

        const order = {
            id: orderIdCounter++, type, lotSize, openPrice: currentPrice,
            stopLoss: stopLossPrice, takeProfit: takeProfitPrice, comment, profit: 0,
            openStepIndex: currentStepIndex
        };
        orders.push(order);
        updateTradingDisplay();

        if (commentSortState === 'none') {
            const container = document.querySelector('.orders-container');
            container.scrollTop = container.scrollHeight;
        }
    }
    
    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ С ЛОГИРОВАНИЕМ И УЧЕТОМ ПОГРЕШНОСТИ ---
    function checkStopsAndLimits(startPrice, endPrice) {
        const EPSILON = 1e-9; // Малая погрешность для сравнения чисел
        let wasAnyOrderClosed = false;
        const remainingOrders = [];
        
        const minPrice = Math.min(startPrice, endPrice);
        const maxPrice = Math.max(startPrice, endPrice);
        console.log(`[Check Orders] Проверка диапазона: ${minPrice.toFixed(5)} ... ${maxPrice.toFixed(5)}`);

        orders.forEach(order => {
            let isClosed = false;
            let closePrice = 0;
            
            console.log(`[Order #${order.id}] Проверка:`, { type: order.type, sl: order.stopLoss, tp: order.takeProfit });

            if (order.type === 'buy') {
                if (order.takeProfit > 0 && (order.takeProfit - EPSILON) <= maxPrice && (order.takeProfit + EPSILON) >= minPrice) {
                    isClosed = true;
                    closePrice = order.takeProfit;
                    console.log(` -> [Order #${order.id} BUY] Сработал Take Profit.`);
                }
                if (!isClosed && order.stopLoss > 0 && (order.stopLoss + EPSILON) >= minPrice && (order.stopLoss - EPSILON) <= maxPrice) {
                    isClosed = true;
                    closePrice = order.stopLoss;
                    console.log(` -> [Order #${order.id} BUY] Сработал Stop Loss.`);
                }
            } else { // SELL
                if (order.takeProfit > 0 && (order.takeProfit + EPSILON) >= minPrice && (order.takeProfit - EPSILON) <= maxPrice) {
                    isClosed = true;
                    closePrice = order.takeProfit;
                     console.log(` -> [Order #${order.id} SELL] Сработал Take Profit.`);
                }
                if (!isClosed && order.stopLoss > 0 && (order.stopLoss - EPSILON) <= maxPrice && (order.stopLoss + EPSILON) >= minPrice) {
                    isClosed = true;
                    closePrice = order.stopLoss;
                    console.log(` -> [Order #${order.id} SELL] Сработал Stop Loss.`);
                }
            }

            if (isClosed) {
                const profit = (closePrice - order.openPrice) * (order.type === 'buy' ? 1 : -1) * order.lotSize * 100000;
                accountBalance += profit;
                closedOrders.push({ openPrice: order.openPrice, closeStepIndex: currentStepIndex, comment: order.comment, closePrice });
                wasAnyOrderClosed = true;
                console.log(`%c[Order #${order.id}] ЗАКРЫТ по цене ${closePrice.toFixed(5)} с профитом ${profit.toFixed(2)}`, 'color: green; font-weight: bold;');
            } else {
                remainingOrders.push(order);
                console.log(` -> [Order #${order.id}] Остался открыт.`);
            }
        });
        orders = remainingOrders;
        return wasAnyOrderClosed;
    }

    function closeOrder(orderId) {
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex > -1) {
            const order = orders[orderIndex];
            accountBalance += order.profit;
            closedOrders.push({ openPrice: order.openPrice, closeStepIndex: currentStepIndex, comment: order.comment, closePrice: getCurrentPrice() });
            orders.splice(orderIndex, 1);
            updateClosedOrdersList();
            updateTradingDisplay();
        }
    }

    function closeAllOrders() {
        orders.forEach(order => {
            accountBalance += order.profit;
            closedOrders.push({ openPrice: order.openPrice, closeStepIndex: currentStepIndex, comment: order.comment, closePrice: getCurrentPrice() });
        });
        orders = [];
        updateClosedOrdersList();
        updateTradingDisplay();
    }
    
    function toggleCommentSort() {
        if (commentSortState === 'none') commentSortState = 'asc';
        else if (commentSortState === 'asc') commentSortState = 'desc';
        else commentSortState = 'none';
        updateOrdersList();
    }

    function updateTradingDisplay() {
        const totalFloatingProfit = orders.reduce((sum, order) => sum + order.profit, 0);
        const equity = accountBalance + totalFloatingProfit;
        document.getElementById('accountBalance').textContent = accountBalance.toFixed(2);
        const equityEl = document.getElementById('accountEquity');
        equityEl.textContent = equity.toFixed(2);
        equityEl.className = equity >= startingBalance ? 'profit' : 'loss';
        document.getElementById('currentStepInfo').textContent = `${currentStepIndex} / ${g_gridData ? g_gridData.dataPoints.length - 1 : 0}`;
        document.getElementById('priceInfo').textContent = `Текущая цена: ${getCurrentPrice().toFixed(5)}`;
        updateOrdersList();
    }

    function updateOrdersList() {
        const listEl = document.getElementById('ordersList');
        let ordersToDisplay = [...orders];

        if (isFilterActive) {
            const filterText = document.getElementById('orderComment').value.trim();
            if (filterText) {
                ordersToDisplay = ordersToDisplay.filter(o => o.comment && o.comment.includes(filterText));
            }
        }
        
        if (commentSortState !== 'none') {
            ordersToDisplay.sort((a, b) => {
                const commentA = a.comment || '';
                const commentB = b.comment || '';
                return commentSortState === 'asc' ? commentA.localeCompare(commentB) : commentB.localeCompare(commentA);
            });
        } else {
            ordersToDisplay.sort((a, b) => a.openStepIndex - b.openStepIndex);
        }

        const sortIcon = document.getElementById('sortCommentIcon');
        sortIcon.classList.remove('asc', 'desc');
        if (commentSortState === 'asc') sortIcon.classList.add('asc');
        else if (commentSortState === 'desc') sortIcon.classList.add('desc');

        if (ordersToDisplay.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">' + (isFilterActive ? 'Нет ордеров по фильтру' : 'Нет открытых позиций') + '</div>';
            return;
        }
        listEl.innerHTML = ordersToDisplay.map(o => `
            <div class="order-item ${o.type === 'sell' ? 'sell-order-highlight' : ''}">
                <div title="Шаг открытия">${o.openStepIndex}</div>
                <div class="order-type-${o.type}">${o.type.toUpperCase()}</div>
                <div>${o.lotSize.toFixed(2)}</div>
                <div>${o.openPrice.toFixed(5)}</div>
                <div>${o.stopLoss > 0 ? o.stopLoss.toFixed(5) : '—'}</div>
                <div>${o.takeProfit > 0 ? o.takeProfit.toFixed(5) : '—'}</div>
                <div>${o.comment || '—'}</div>
                <div class="order-profit ${o.profit >= 0 ? 'positive' : 'negative'}">${o.profit.toFixed(2)}</div>
                <button class="close-order-btn" onclick="closeOrder(${o.id})" title="Закрыть ордер">
                    <svg style="width:18px; height:18px; color: #757575;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
                </button>
            </div>
        `).join('');
    }

    function updateClosedOrdersList() {
        const listEl = document.getElementById('closedOrdersList');
        if (closedOrders.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; color:#999; padding:15px;">Нет закрытых сделок</div>';
            return;
        }
        listEl.innerHTML = closedOrders.slice().reverse().map(o => `
            <div class="history-item">
                <div>${o.closeStepIndex}</div>
                <div>${o.comment || '—'}</div>
                <div>${o.openPrice.toFixed(5)} / ${o.closePrice.toFixed(5)}</div>
            </div>
        `).join('');
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ И ГРАФИК ---
    function updateOrders() {
        const currentPrice = getCurrentPrice();
        orders.forEach(order => { order.profit = (currentPrice - order.openPrice) * (order.type === 'buy' ? 1 : -1) * order.lotSize * 100000; });
    }

    function getPointValue() {
        if (!g_parsedData || g_parsedData.length === 0) return 0.00001;
        const firstPrice = g_parsedData[0].close;
        const decimals = (firstPrice.toString().split('.')[1] || '').length;
        return (1 / Math.pow(10, decimals));
    }

    function getGridStepPrice() {
        const gridStepPips = parseInt(document.getElementById('gridStepPips').value);
        return gridStepPips * getPointValue();
    }
    
    function getCurrentPrice() { return g_gridData ? g_gridData.dataPoints[currentStepIndex] : 0; }
    
    function drawTradingChart() {
        if (!g_gridData) return;
        const visibleData = g_gridData.dataPoints.slice(0, currentStepIndex + 1);
        const visibleLabels = g_gridData.labels.slice(0, currentStepIndex + 1);
        drawChart({ dataPoints: visibleData, labels: visibleLabels });
    }
    
    document.getElementById('resetZoomBtn').addEventListener('click', () => myChart?.resetZoom());
    document.getElementById('scrollLeft').addEventListener('click', () => myChart?.pan({ x: 100 }, undefined, 'default'));
    document.getElementById('scrollRight').addEventListener('click', () => myChart?.pan({ x: -100 }, undefined, 'default'));
    document.getElementById('zoomIn').addEventListener('click', () => myChart?.zoom(1.2));
    document.getElementById('zoomOut').addEventListener('click', () => myChart?.zoom(0.8));

    function parseData(rawData) {
        return rawData.trim().split('\n').map(line => {
            const parts = line.trim().split(/[,;]\s*|\s+/);
            if (parts.length >= 6) {
                const p = (v) => parseFloat(v);
                return { date: parts[0], time: parts[1], open: p(parts[2]), high: p(parts[3]), low: p(parts[4]), close: p(parts[5]) };
            }
            return null;
        }).filter(Boolean);
    }
    
    function generateGridData(priceData, gridStepPips) {
        const firstPrice = priceData[0].close;
        const decimals = Math.max(...priceData.map(p => (p.close.toString().split('.')[1] || '').length));
        const pointMultiplier = (decimals === 5 || decimals === 3) ? 10 : 1;
        const gridStepPrice = gridStepPips * pointMultiplier * (1 / Math.pow(10, decimals));
        const labels = [], dataPoints = [];
        let currentLevel = Math.round(firstPrice / gridStepPrice) * gridStepPrice;
        labels.push(`${priceData[0].date} ${priceData[0].time}`); dataPoints.push(currentLevel);
        
        for (const candle of priceData) {
            const process = (p1, p2) => {
                while(p1(candle, currentLevel, gridStepPrice)) {
                    currentLevel += (p1 === checkUp ? 1 : -1) * gridStepPrice;
                    labels.push(`${candle.date} ${candle.time}`); dataPoints.push(currentLevel);
                }
                while(p2(candle, currentLevel, gridStepPrice)) {
                    currentLevel += (p2 === checkUp ? 1 : -1) * gridStepPrice;
                    labels.push(`${candle.date} ${candle.time}`); dataPoints.push(currentLevel);
                }
            };
            const checkUp = (c, level, step) => c.high >= level + step;
            const checkDown = (c, level, step) => c.low <= level - step;
            candle.close >= candle.open ? process(checkUp, checkDown) : process(checkDown, checkUp);
        }
        return { labels, dataPoints };
    }

    function drawChart(result) {
        document.getElementById('chart-placeholder').style.display = 'none';
        const canvas = document.getElementById('gridChart');
        canvas.style.display = 'block';
        if (myChart) myChart.destroy();
        myChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { labels: result.labels, datasets: [{
                label: `Grid-график (Шаг ${document.getElementById('gridStepPips').value} п.)`,
                data: result.dataPoints,
                borderColor: '#1e88e5', borderWidth: 2, pointRadius: 2.5,
                pointBackgroundColor: '#ffab00', fill: false, tension: 0
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                scales: { x: { grid: { color: '#f5f5f5' } }, y: { grid: { color: '#eeeeee' } } },
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    zoom: {
                        pan: { enabled: true, mode: 'x' },
                        zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: 'x' }
                    }
                },
                onHover: (event, activeElements) => {
                    if (!isTradingMode) {
                        const info = document.getElementById('priceInfo');
                        if (activeElements?.length > 0) {
                            const idx = activeElements[0].index;
                            const price = result.dataPoints[idx];
                            info.textContent = `Шаг #${idx} | Цена: ${price.toFixed(5)}`;
                        } else {
                            info.textContent = 'Наведите курсор на график';
                        }
                    }
                }
            }
        });
    }
    window.closeOrder = closeOrder;
    window.toggleCommentSort = toggleCommentSort;
</script>
</body>
</html>
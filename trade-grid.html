<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Торговый симулятор</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- JSZip library for handling zip files -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <link rel="icon" href="img/stocks.png" type="image/png">
    
    <style>
                :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --primary-color: #26a69a;
            --secondary-color: #ef5350;
            --border-color: #e0e0e0;
            --buy-color: #26a69a;
            --sell-color: #ef5350;
            --close-color: #ffca28;
            --active-filter-color: #1e88e5;
            --sell-bg-light: rgba(239, 83, 80, 0.08);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0;
            display: flex; height: 100vh; width: 100vw; overflow: hidden;
        }
        .container {
            display: flex; gap: 10px; width: 100%; height: 100%; padding: 10px;
        }
        .panel {
            background-color: var(--panel-bg); border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column;
        }
        .settings-panel {
            flex: 0 0 280px; padding: 20px;
        }
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; gap: 10px;
        }
        .chart-panel {
            flex-grow: 1; padding: 15px;
        }
        .trading-panel {
            flex: 0 0 350px; padding: 15px; display: none;
        }
        .trading-panel.active { display: flex; }

        h2 { color: #424242; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.1em; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #616161; font-size: 0.9em; }
        textarea, input { width: calc(100% - 20px); padding: 9px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; background-color: #fafafa; }
        textarea { height: 100px; resize: vertical; font-family: "Courier New", Courier, monospace; }
        button { background-color: #42a5f5; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #1e88e5; }
        button:active { transform: scale(0.98); }

        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .price-info { font-size: 1em; font-weight: 500; padding: 5px 10px; background-color: #e3f2fd; border-radius: 4px; color: #1e88e5; text-align: center; flex-grow: 1; margin: 0 10px; }
        .icon-btn { background: none; border: 1px solid #ccc; color: #555; width: 36px; height: 36px; padding: 0; margin: 0 2px; display: inline-flex; justify-content: center; align-items: center; border-radius: 4px; cursor: pointer; }
        .icon-btn:hover { background-color: #eee; border-color: #999; }
        .icon-btn svg { width: 20px; height: 20px; }
        #stepForward { background-color: var(--primary-color); color: white; border: none; width: auto; padding: 0 15px; }
        #stepForward:hover { background-color: #00897b; }

        .chart-container { width: 100%; height: calc(100% - 50px); position: relative; }
        #chart-placeholder { color: #999; text-align: center; padding-top: 20%; }
        
        .account-info { display: flex; gap: 20px; background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .account-info div { font-size: 1em; }
        .account-info span { font-weight: 600; }
        #accountEquity.profit { color: var(--buy-color); }
        #accountEquity.loss { color: var(--sell-color); }

        .order-form { display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr auto auto auto; gap: 8px; margin-bottom: 10px; align-items: center; }
        .order-form input { width: 100%; box-sizing: border-box; padding: 8px; margin: 0; }
        .comment-group { display: flex; align-items: center; gap: 5px; }
        #filterBtn { width: auto; padding: 6px 10px; font-size: 12px; background-color: #78909c; }
        #filterBtn.active { background-color: var(--active-filter-color); }
        .order-form button { width: auto; padding: 8px 15px; margin: 0; font-weight: 600; }
        .buy-button { background-color: var(--buy-color); }
        .sell-button { background-color: var(--sell-color); }
        .close-all-button { background-color: var(--close-color); color: #333; }
        
        .orders-container { flex-grow: 1; overflow-y: auto; max-height: 33vh; }
        .order-list-header, .order-item { display: grid; grid-template-columns: 40px 60px 50px 1fr 1fr 1fr 1.5fr 1fr 50px; gap: 10px; padding: 8px; align-items: center; font-size: 0.9em; }
        .order-list-header { font-weight: 600; color: #757575; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; background-color: var(--panel-bg); }
        .sortable-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; gap: 4px; }
        .sort-icon { color: #bdbdbd; transition: transform 0.2s, color 0.2s; }
        .sortable-header:hover .sort-icon { color: #757575; }
        .sort-icon.asc { transform: rotate(180deg); color: var(--active-filter-color); }
        .sort-icon.desc { transform: rotate(0deg); color: var(--active-filter-color); }

        .order-item { border-bottom: 1px solid var(--border-color); }
        .order-item.sell-order-highlight { background-color: var(--sell-bg-light); }
        .order-type-buy { color: var(--buy-color); font-weight: 600; }
        .order-type-sell { color: var(--sell-color); font-weight: 600; }
        .order-profit.positive { color: var(--buy-color); font-weight: 500; }
        .order-profit.negative { color: var(--sell-color); font-weight: 500; }
        .close-order-btn { background: none; border: none; padding: 0; cursor: pointer; }

        .history-container { margin-top: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        #closedOrdersList { flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); }
        .history-item { display: grid; grid-template-columns: 40px 1fr 1.5fr 80px; gap: 10px; padding: 5px; font-size: 0.85em; border-bottom: 1px solid #f5f5f5; }
        .history-header { font-weight: 600; color: #757575; padding: 5px; border-bottom: 2px solid var(--border-color); }
        
        .editable-value { cursor: pointer; text-decoration: underline dashed 1px #999; transition: background-color 0.2s; }
        .editable-value:hover { background-color: #f0f8ff; }
        .editable-value input { width: 90% !important; padding: 2px 4px !important; border: 1px solid var(--active-filter-color); font-size: 0.9em; }
        
        /* --- STYLES FOR MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 80vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .modal-header h2 { margin: 0; border: none; }
        .modal-close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-close:hover { color: #333; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        #serverFileList { list-style-type: none; padding: 0; margin: 10px 0; border: 1px solid var(--border-color); border-radius: 4px; max-height: 200px; overflow-y: auto; }
        #serverFileList li { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; text-align: center; }
        #serverFileList li:last-child { border-bottom: none; }
        #serverFileList li:hover { background-color: #e3f2fd; }
        #serverFileList li.selected { background-color: #e3f2fd; color: #1e88e5; font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 25px; height: 25px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #dateRangeSelector { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .date-inputs { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .date-inputs label { margin-bottom: 0; }
        .date-inputs input[type="date"] { width: auto; }
        #fileProcessStatus { margin-top: 10px; color: #666; font-style: italic; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px; text-align: right; }
        .modal-footer button { width: auto; margin-left: 10px; }
        .modal-btn-cancel { background-color: var(--secondary-color); }
        .modal-btn-cancel:hover { background-color: #d32f2f; }
        .modal-btn-load { background-color: #4CAF50; }
        .modal-btn-load:hover:not(:disabled) { background-color: #45a049; }
        .modal-btn-load:disabled { background-color: #cccccc; cursor: not-allowed; }

        /* --- STYLES FOR CUSTOM FILE INPUT BUTTONS --- */
        .file-input-buttons {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        .custom-file-btn, #loadFromServerBtn {
            flex: 1; display: inline-flex !important; align-items: center; justify-content: center;
            gap: 8px; padding: 10px 15px !important; border-radius: 4px; cursor: pointer;
            font-size: 14px !important; font-weight: 500; transition: background-color 0.2s ease;
            border: none; color: white !important; width: auto !important; margin-top: 0 !important;
        }
        .custom-file-btn svg, #loadFromServerBtn svg { width: 20px; height: 20px; }
        .custom-file-btn { background-color: #66bb6a; }
        .custom-file-btn:hover { background-color: #4caf50; }
        #loadFromServerBtn { background-color: #5c6bc0 !important; }
        #loadFromServerBtn:hover { background-color: #3f51b5 !important; }
        
        /* --- STYLES FOR ICON-ONLY ACTION BUTTONS --- */
        .action-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .main-action-btn {
            width: 100%; height: 40px;
            padding: 0 !important; margin-top: 0 !important;
            display: flex; align-items: center; justify-content: center;
        }
        .main-action-btn svg {
            width: 24px;
            height: 24px;
        }
        #gridStepPips {
    text-align: center;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="panel settings-panel">
            <h2>Настройки</h2>
            <div class="control-group">
                <label for="gridStepPips">Шаг сетки (пункты):</label>
                <input type="number" id="gridStepPips" value="50">
            </div>
            
            <div class="control-group">
                <label>Загрузка данных MT4:</label>
                <div class="file-input-buttons">
                    <label for="csvFile" class="custom-file-btn">
                         <svg viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg>
                         <span></span>
                    </label>
                    <input type="file" id="csvFile" accept=".csv,.txt" hidden>
                    <button id="loadFromServerBtn">
                         <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 22.35,10.36 20,10.04M19,18H6A4,4 0 0,1 2,14C2,11.95 3.53,10.24 5.56,10.03L6.63,9.92L7.13,8.87C8.07,6.94 9.94,5.75 12,5.75C14.5,5.75 16.5,7.44 16.95,9.88L17.34,11.94L19.5,12.1C20.94,12.25 22,13.45 22,15A3,3 0 0,1 19,18M8,13H10.55V16H13.45V13H16L12,9L8,13Z" /></svg>
                         <span></span>
                    </button>
                </div>
            </div>
            
            <div class="control-group">
                <label for="priceData"></label>
                <textarea id="priceData" placeholder="<DATE>,<TIME>,<OPEN>,<HIGH>,<LOW>,<CLOSE>,<VOL>"></textarea>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="action-buttons-container">
                 <button id="buildChartBtn" class="main-action-btn" title="Построить / Обновить график">
                     <svg viewBox="0 0 24 24"><path fill="currentColor" d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z" /></svg>
                 </button>
                 <button id="startTradingBtn" class="main-action-btn" style="background-color: var(--primary-color);" title="Начать симуляцию">
                     <svg viewBox="0 0 24 24"><path fill="currentColor" d="M8,5V19L19,12L8,5Z" /></svg>
                 </button>
            </div>

            <div class="history-container">
                <h2>История</h2>
                <div class="history-item history-header">
                    <div>#</div><div>Комментарий</div><div>Откр/Закр</div><div>P/L</div>
                </div>
                <div id="closedOrdersList">
                    <div style="text-align:center; color:#999; padding:15px;"></div>
                </div>
            </div>
        </div>

        <div class="panel main-content">
            <div class="chart-panel">
                <div class="chart-controls">
                     <div>
                        <button class="icon-btn" id="scrollLeft" title="Прокрутка влево"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" /></svg></button>
                        <button class="icon-btn" id="scrollRight" title="Прокрутка вправо"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg></button>
                        <button class="icon-btn" id="zoomIn" title="Приблизить"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg></button>
                        <button class="icon-btn" id="zoomOut" title="Отдалить"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H5V11H19V13Z" /></svg></button>
                        <button class="icon-btn" id="resetZoomBtn" title="Сбросить зум"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5,5H9V3H3V9H5V5M19,5V9H21V3H15V5H19M5,15V19H9V21H3V15H5M19,15H15V21H21V15H19Z" /></svg></button>
                    </div>
                    <div id="priceInfo" class="price-info"></div>
                    <button id="stepForward" style="display: none;">Шаг вперед (F9) <svg style="width:16px; height:16px; vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M4,5V19L11,12M11,5V19L18,12" /></svg></button>
                </div>
                <div class="chart-container">
                    <canvas id="gridChart" style="display: none;"></canvas>
                    <div id="chart-placeholder">Здесь появится график</div>
                </div>
            </div>

            <div class="trading-panel" id="tradingPanel">
                <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
            <div class="account-info">
            <div>Баланс: $<span id="accountBalance">10000.00</span></div>
            <div>Средства: $<span id="accountEquity">10000.00</span></div>
            <div>Шаг: <span id="currentStepInfo">0 / 0</span></div>
            <div>Buy: <span id="totalBuyLots">0.000</span></div>
            <div>Sell: <span id="totalSellLots">0.000</span></div>
        </div>

        <div class="order-form">
            <input type="number" id="lotSize" value="0.1" step="0.001" min="0.001" placeholder="Лот" title="Лот">
                        <input type="number" id="stopLoss" placeholder="S/L (пункты)" title="Стоп-лосс в пунктах">
                        <input type="number" id="takeProfit" placeholder="T/P (пункты)" title="Тейк-профит в пунктах">
                        <div class="comment-group">
                            <input type="text" id="orderComment" placeholder="Комментарий">
                            <button id="filterBtn" title="Фильтр по комментарию">Фильтр</button>
                        </div>
                        <button class="buy-button" id="buyBtn">BUY</button>
                        <button class="sell-button" id="sellBtn">SELL</button>
                        <button class="close-all-button" id="closeAllBtn">Закрыть все</button>
                    </div>

                    <div class="orders-container">
                         <div class="order-list-header">
                            <div>#</div><div>Тип</div><div>Лот</div>
                            <div>Open</div><div>S/L</div><div>T/P</div>
                            <div class="sortable-header" onclick="toggleCommentSort()" title="Сортировать по комментарию">
                                Комментарий
                                <svg id="sortCommentIcon" class="sort-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path fill="currentColor" d="M7,10L12,15L17,10H7Z" /></svg>
                            </div>
                            <div>Прибыль</div><div></div>
                        </div>
                        <div id="ordersList">
                            <div style="text-align: center; color: #999; padding: 20px;">Нет открытых позиций</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL FOR LOADING FILES FROM SERVER -->
    <div id="fileLoaderModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                
            </div>
            <div class="modal-body">
                <div id="fileListContainer">
                    
                    <div id="fileListLoader" class="loader" style="display: none;"></div>
                    <ul id="serverFileList"></ul>
                </div>
                <div id="dateRangeSelector" style="display: none;">
                    <p><strong>Выберите диапазон дат:</strong></p>
                    <div class="date-inputs">
                        <label for="startDate">С:</label>
                        <input type="date" id="startDate" disabled>
                        <label for="endDate">По:</label>
                        <input type="date" id="endDate" disabled>
                    </div>
                    <div id="fileProcessStatus"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modalCancelBtn" class="modal-btn-cancel">Отмена</button>
                <button id="modalLoadBtn" class="modal-btn-load" disabled>Загрузить</button>
            </div>
        </div>
    </div>

<script>
    let myChart = null, g_parsedData = null, g_gridData = null, isTradingMode = false,
        currentStepIndex = 0, orders = [], orderIdCounter = 1, accountBalance = 10000.00,
        startingBalance = 10000.00,
        closedOrders = [], 
        isFilterActive = false,
        commentSortState = 'none';
        
    const ICONS = {
        play: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M8,5V19L19,12L8,5Z" /></svg>`,
        stop: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M18,18H6V6H18V18Z" /></svg>`
    };

    // --- CHART BUILDING LOGIC ---
    function buildChartFromData() {
        const rawData = document.getElementById('priceData').value.trim();
        if (rawData) g_parsedData = parseData(rawData);
        if (!g_parsedData || g_parsedData.length === 0) return alert('Нет данных для обработки или они некорректны.');
        
        const gridStepPips = parseInt(document.getElementById('gridStepPips').value);
        if (!gridStepPips || gridStepPips <= 0) return alert('Введите корректный шаг сетки.');
        
        g_gridData = generateGridData(g_parsedData, gridStepPips);
        
        if (isTradingMode) {
             initTradingMode();
        } else {
             drawChart(g_gridData);
        }
    }

    // --- EVENT LISTENERS ---
    document.getElementById('csvFile').addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { 
            document.getElementById('priceData').value = e.target.result; 
            g_parsedData = null; 
            buildChartFromData(); // Auto-build chart
        };
        reader.readAsText(file);
    });
    
    document.getElementById('buildChartBtn').addEventListener('click', buildChartFromData);

    document.getElementById('startTradingBtn').addEventListener('click', () => {
        if (!g_gridData) return alert('Сначала постройте график!');
        isTradingMode = !isTradingMode;
        
        const btn = document.getElementById('startTradingBtn');
        if (isTradingMode) {
            btn.innerHTML = ICONS.stop;
            btn.title = 'Остановить симуляцию';
            btn.style.backgroundColor = 'var(--secondary-color)';
            initTradingMode();
        } else {
            btn.innerHTML = ICONS.play;
            btn.title = 'Начать симуляцию';
            btn.style.backgroundColor = 'var(--primary-color)';
            drawChart(g_gridData); // Revert to full chart view
        }
        
        document.getElementById('tradingPanel').classList.toggle('active', isTradingMode);
        document.getElementById('stepForward').style.display = isTradingMode ? 'flex' : 'none';
    });
    
    // --- (Rest of the event listeners remain the same) ---
    document.getElementById('stepForward').addEventListener('click', () => {
        if (currentStepIndex >= g_gridData.dataPoints.length - 1) return alert('Достигнут конец данных!');
        const priceBefore = getCurrentPrice();
        currentStepIndex++;
        const priceAfter = getCurrentPrice();
        let ordersWereClosed = checkStopsAndLimits(priceBefore, priceAfter);
        if (ordersWereClosed) { updateClosedOrdersList(); }
        updateOrders(); updateTradingDisplay(); drawTradingChart();
    });
    document.getElementById('buyBtn').addEventListener('click', () => openOrder('buy'));
    document.getElementById('sellBtn').addEventListener('click', () => openOrder('sell'));
    document.getElementById('closeAllBtn').addEventListener('click', closeAllOrders);
    document.getElementById('filterBtn').addEventListener('click', () => {
        isFilterActive = !isFilterActive;
        document.getElementById('filterBtn').classList.toggle('active', isFilterActive);
        updateOrdersList();
    });
    document.getElementById('orderComment').addEventListener('input', (e) => {
        const text = e.target.value.trim();
        if (!text) { e.target.style.color = ''; return; }
        const isDuplicate = orders.some(o => o.comment === text);
        e.target.style.color = isDuplicate ? 'var(--secondary-color)' : '';
    });
    window.addEventListener('keydown', (e) => {
        if (e.key === 'F9' && isTradingMode) {
            e.preventDefault();
            document.getElementById('stepForward').click();
        }
    });

    // --- SIMULATION FUNCTIONS (Mostly unchanged) ---
    function initTradingMode() {
        currentStepIndex = 1; orders = []; orderIdCounter = 1; accountBalance = startingBalance;
        closedOrders = [];
        isFilterActive = false;
        commentSortState = 'none';
        document.getElementById('filterBtn').classList.remove('active');
        updateClosedOrdersList();
        updateOrders(); updateTradingDisplay(); drawTradingChart();
    }
    
    function openOrder(type) {
        const lotSize = parseFloat(document.getElementById('lotSize').value);
        if (isNaN(lotSize) || lotSize <= 0) return alert('Некорректный размер лота.');
        const takeProfitPips = parseInt(document.getElementById('takeProfit').value) || 0;
        const stopLossPips = parseInt(document.getElementById('stopLoss').value) || 0;
        const comment = document.getElementById('orderComment').value.trim() || '';
        const currentPrice = getCurrentPrice();
        const pointValue = getPointValue();
        let takeProfitPrice = 0, stopLossPrice = 0;

        if (takeProfitPips > 0) takeProfitPrice = type === 'buy' ? currentPrice + (takeProfitPips * pointValue) : currentPrice - (takeProfitPips * pointValue);
        if (stopLossPips > 0) stopLossPrice = type === 'buy' ? currentPrice - (stopLossPips * pointValue) : currentPrice + (stopLossPips * pointValue);

        const order = {
            id: orderIdCounter++, type, lotSize, openPrice: currentPrice,
            stopLoss: stopLossPrice, takeProfit: takeProfitPrice, comment, profit: 0,
            openStepIndex: currentStepIndex
        };
        orders.push(order);
        updateTradingDisplay();

        if (commentSortState === 'none') {
            const container = document.querySelector('.orders-container');
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function checkStopsAndLimits(startPrice, endPrice) {
        const EPSILON = 1e-9; 
        let wasAnyOrderClosed = false;
        const remainingOrders = [];
        const minPrice = Math.min(startPrice, endPrice);
        const maxPrice = Math.max(startPrice, endPrice);

        orders.forEach(order => {
            let isClosed = false;
            let closePrice = 0;
            
            if (order.type === 'buy') {
                if (order.takeProfit > 0 && (order.takeProfit - EPSILON) <= maxPrice && (order.takeProfit + EPSILON) >= minPrice) {
                    isClosed = true; closePrice = order.takeProfit;
                }
                if (!isClosed && order.stopLoss > 0 && (order.stopLoss + EPSILON) >= minPrice && (order.stopLoss - EPSILON) <= maxPrice) {
                    isClosed = true; closePrice = order.stopLoss;
                }
            } else { // SELL
                if (order.takeProfit > 0 && (order.takeProfit + EPSILON) >= minPrice && (order.takeProfit - EPSILON) <= maxPrice) {
                    isClosed = true; closePrice = order.takeProfit;
                }
                if (!isClosed && order.stopLoss > 0 && (order.stopLoss - EPSILON) <= maxPrice && (order.stopLoss + EPSILON) >= minPrice) {
                    isClosed = true; closePrice = order.stopLoss;
                }
            }

            if (isClosed) {
                const profit = (closePrice - order.openPrice) * (order.type === 'buy' ? 1 : -1) * order.lotSize * 100000;
                accountBalance += profit;
                closedOrders.push({ ticket: order.id, openPrice: order.openPrice, comment: order.comment, closePrice, profit: profit });
                wasAnyOrderClosed = true;
            } else {
                remainingOrders.push(order);
            }
        });
        orders = remainingOrders;
        return wasAnyOrderClosed;
    }

    function closeOrder(orderId) {
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex > -1) {
            const order = orders[orderIndex];
            accountBalance += order.profit;
            closedOrders.push({ ticket: order.id, openPrice: order.openPrice, comment: order.comment, closePrice: getCurrentPrice(), profit: order.profit });
            orders.splice(orderIndex, 1);
            updateClosedOrdersList();
            updateTradingDisplay();
        }
    }

    function closeAllOrders() {
        orders.forEach(order => {
            accountBalance += order.profit;
            closedOrders.push({ ticket: order.id, openPrice: order.openPrice, comment: order.comment, closePrice: getCurrentPrice(), profit: order.profit });
        });
        orders = [];
        updateClosedOrdersList();
        updateTradingDisplay();
    }
    
    function toggleCommentSort() {
        if (commentSortState === 'none') commentSortState = 'asc';
        else if (commentSortState === 'asc') commentSortState = 'desc';
        else commentSortState = 'none';
        updateOrdersList();
    }

    function updateTradingDisplay() {
        const totalFloatingProfit = orders.reduce((sum, order) => sum + order.profit, 0);
        const totalBuyLots = orders.reduce((sum, order) => sum + (order.type === 'buy' ? order.lotSize : 0), 0);
        const totalSellLots = orders.reduce((sum, order) => sum + (order.type === 'sell' ? order.lotSize : 0), 0);
        const equity = accountBalance + totalFloatingProfit;
        document.getElementById('accountBalance').textContent = accountBalance.toFixed(2);
        const equityEl = document.getElementById('accountEquity');
        equityEl.textContent = equity.toFixed(2);
        equityEl.className = equity >= startingBalance ? 'profit' : 'loss';
        document.getElementById('currentStepInfo').textContent = `${currentStepIndex} / ${g_gridData ? g_gridData.dataPoints.length - 1 : 0}`;
        document.getElementById('priceInfo').textContent = `Текущая цена: ${getCurrentPrice().toFixed(5)}`;
        document.getElementById('totalBuyLots').textContent = totalBuyLots.toFixed(3);
        document.getElementById('totalSellLots').textContent = totalSellLots.toFixed(3);
        updateOrdersList();
    }

   function updateOrdersList() {
        const listEl = document.getElementById('ordersList');
        let ordersToDisplay = [...orders];
        if (isFilterActive) {
            const filterText = document.getElementById('orderComment').value.trim();
            if (filterText) {
                ordersToDisplay = ordersToDisplay.filter(o => o.comment && o.comment.includes(filterText));
            }
        }
        if (commentSortState !== 'none') {
            ordersToDisplay.sort((a, b) => {
                const commentA = a.comment || '';
                const commentB = b.comment || '';
                return commentSortState === 'asc' ? commentA.localeCompare(commentB) : commentB.localeCompare(commentA);
            });
        } else {
            ordersToDisplay.sort((a, b) => a.openStepIndex - b.openStepIndex);
        }
        const sortIcon = document.getElementById('sortCommentIcon');
        sortIcon.classList.remove('asc', 'desc');
        if (commentSortState === 'asc') sortIcon.classList.add('asc');
        else if (commentSortState === 'desc') sortIcon.classList.add('desc');

        if (ordersToDisplay.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">' + (isFilterActive ? 'Нет ордеров по фильтру' : 'Нет открытых позиций') + '</div>';
            return;
        }
        listEl.innerHTML = ordersToDisplay.map(o => `
            <div class="order-item ${o.type === 'sell' ? 'sell-order-highlight' : ''}">
                <div>${o.openStepIndex}</div>
                <div class="order-type-${o.type}">${o.type.toUpperCase()}</div>
                <div>${o.lotSize.toFixed(3)}</div>
                <div>${o.openPrice.toFixed(5)}</div>
                <div class="editable-value" onclick="editOrderValue(${o.id}, 'stopLoss', this)">${o.stopLoss > 0 ? o.stopLoss.toFixed(5) : '—'}</div>
                <div class="editable-value" onclick="editOrderValue(${o.id}, 'takeProfit', this)">${o.takeProfit > 0 ? o.takeProfit.toFixed(5) : '—'}</div>
                <div class="editable-value" onclick="editOrderValue(${o.id}, 'comment', this)">${o.comment || '—'}</div>
                <div class="order-profit ${o.profit >= 0 ? 'positive' : 'negative'}">${o.profit.toFixed(2)}</div>
                <button class="close-order-btn" onclick="closeOrder(${o.id})" title="Закрыть ордер">
                    <svg style="width:18px; height:18px; color: #757575;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
                </button>
            </div>`).join('');
    }

    function editOrderValue(orderId, field, element) {
        if (document.querySelector('.editable-value input')) { updateOrdersList(); }
        const order = orders.find(o => o.id === orderId);
        if (!order) return;
        const input = document.createElement('input');
        if (field === 'comment') {
            input.type = 'text'; input.value = order.comment || '';
        } else {
            input.type = 'number'; input.step = getPointValue(); input.value = order[field] > 0 ? order[field].toFixed(5) : '';
        }
        const saveChanges = () => {
            if (field === 'comment') {
                order.comment = input.value.trim();
            } else {
                order[field] = parseFloat(input.value) || 0;
            }
            updateOrdersList();
        };
        input.addEventListener('blur', saveChanges);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); else if (e.key === 'Escape') updateOrdersList(); });
        element.innerHTML = ''; element.appendChild(input);
        input.focus(); input.select();
    }

    function updateClosedOrdersList() {
        const listEl = document.getElementById('closedOrdersList');
        if (closedOrders.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; color:#999; padding:15px;">Нет закрытых сделок</div>';
            return;
        }
        listEl.innerHTML = closedOrders.slice().reverse().map(o => `
            <div class="history-item">
                <div>${o.ticket}</div><div>${o.comment || '—'}</div>
                <div>${o.openPrice.toFixed(5)} / ${o.closePrice.toFixed(5)}</div>
                <div class="order-profit ${o.profit >= 0 ? 'positive' : 'negative'}">${o.profit > 0 ? '+' : ''}${o.profit.toFixed(2)}</div>
            </div>`).join('');
    }

    function updateOrders() {
        const currentPrice = getCurrentPrice();
        orders.forEach(order => { order.profit = (currentPrice - order.openPrice) * (order.type === 'buy' ? 1 : -1) * order.lotSize * 100000; });
    }
    
    // --- HELPER & CHARTING FUNCTIONS (Unchanged) ---
    function getPointValue() {
        if (!g_parsedData || g_parsedData.length === 0) return 0.00001;
        const firstPrice = g_parsedData[0].close;
        const decimals = (firstPrice.toString().split('.')[1] || '').length;
        return (1 / Math.pow(10, decimals));
    }
    function getCurrentPrice() { return g_gridData ? g_gridData.dataPoints[currentStepIndex] : 0; }
    function drawTradingChart() {
        if (!g_gridData) return;
        const visibleData = g_gridData.dataPoints.slice(0, currentStepIndex + 1);
        const visibleLabels = g_gridData.labels.slice(0, currentStepIndex + 1);
        drawChart({ dataPoints: visibleData, labels: visibleLabels });
    }
    document.getElementById('resetZoomBtn').addEventListener('click', () => myChart?.resetZoom());
    document.getElementById('scrollLeft').addEventListener('click', () => myChart?.pan({ x: 100 }, undefined, 'default'));
    document.getElementById('scrollRight').addEventListener('click', () => myChart?.pan({ x: -100 }, undefined, 'default'));
    document.getElementById('zoomIn').addEventListener('click', () => myChart?.zoom(1.2));
    document.getElementById('zoomOut').addEventListener('click', () => myChart?.zoom(0.8));
    function parseData(rawData) {
        try {
            return rawData.trim().split('\n').map(line => {
                const parts = line.trim().split(/[,;]\s*|\s+/);
                if (parts.length >= 6) {
                    const p = (v) => parseFloat(v);
                    return { date: parts[0], time: parts[1], open: p(parts[2]), high: p(parts[3]), low: p(parts[4]), close: p(parts[5]) };
                }
                return null;
            }).filter(p => p && !isNaN(p.close));
        } catch (e) { console.error("Parsing error:", e); return null; }
    }
    function generateGridData(priceData, gridStepPips) {
        const firstPrice = priceData[0].close;
        const decimals = Math.max(...priceData.map(p => (p.close.toString().split('.')[1] || '').length));
        const pointMultiplier = (decimals === 5 || decimals === 3) ? 10 : 1;
        const gridStepPrice = gridStepPips * pointMultiplier * (1 / Math.pow(10, decimals));
        const labels = [], dataPoints = [];
        let currentLevel = Math.round(firstPrice / gridStepPrice) * gridStepPrice;
        labels.push(`${priceData[0].date} ${priceData[0].time}`); dataPoints.push(currentLevel);
        
        for (const candle of priceData) {
            const process = (p1, p2) => {
                while(p1(candle, currentLevel, gridStepPrice)) {
                    currentLevel += (p1 === checkUp ? 1 : -1) * gridStepPrice;
                    labels.push(`${candle.date} ${candle.time}`); dataPoints.push(currentLevel);
                }
                while(p2(candle, currentLevel, gridStepPrice)) {
                    currentLevel += (p2 === checkUp ? 1 : -1) * gridStepPrice;
                    labels.push(`${candle.date} ${candle.time}`); dataPoints.push(currentLevel);
                }
            };
            const checkUp = (c, level, step) => c.high >= level + step;
            const checkDown = (c, level, step) => c.low <= level - step;
            candle.close >= candle.open ? process(checkUp, checkDown) : process(checkDown, checkUp);
        }
        return { labels, dataPoints };
    }
    function drawChart(result) {
        document.getElementById('chart-placeholder').style.display = 'none';
        const canvas = document.getElementById('gridChart');
        canvas.style.display = 'block';
        if (myChart) myChart.destroy();
        myChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { labels: result.labels, datasets: [{
                label: `Grid-график (Шаг ${document.getElementById('gridStepPips').value} п.)`,
                data: result.dataPoints,
                borderColor: '#1e88e5', borderWidth: 2, pointRadius: 2.5,
                pointBackgroundColor: '#ffab00', fill: false, tension: 0
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                scales: { x: { grid: { color: '#f5f5f5' } }, y: { grid: { color: '#eeeeee' } } },
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: 'x' }}
                },
                onHover: (event, activeElements) => {
                    if (!isTradingMode) {
                        const info = document.getElementById('priceInfo');
                        if (activeElements?.length > 0) {
                            const idx = activeElements[0].index;
                            const price = result.dataPoints[idx];
                            info.textContent = `Шаг #${idx} | Цена: ${price.toFixed(5)}`;
                        } else { info.textContent = 'Наведите курсор на график'; }
                    }
                }
            }
        });
    }
    window.closeOrder = closeOrder; window.toggleCommentSort = toggleCommentSort; window.editOrderValue = editOrderValue; 
    
    // --- MODAL FUNCTIONALITY ---
    const modal = document.getElementById('fileLoaderModal');
    const loadFromServerBtn = document.getElementById('loadFromServerBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalLoadBtn = document.getElementById('modalLoadBtn');
    const fileListEl = document.getElementById('serverFileList');
    const loaderEl = document.getElementById('fileListLoader');
    const dateRangeSelector = document.getElementById('dateRangeSelector');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const fileProcessStatus = document.getElementById('fileProcessStatus');
    let modalState = { fullCsvData: null, selectedFileUrl: null };
    const DATA_URL = 'https://mapruapp.ru/files/mt4/';
    
    function openModal() { modal.style.display = 'flex'; resetModal(); fetchFileList(); }
    function closeModal() { modal.style.display = 'none'; }
    function resetModal() {
        fileListEl.innerHTML = ''; loaderEl.style.display = 'block';
        dateRangeSelector.style.display = 'none'; modalLoadBtn.disabled = true;
        startDateInput.disabled = true; endDateInput.disabled = true;
        fileProcessStatus.textContent = '';
        modalState.fullCsvData = null; modalState.selectedFileUrl = null;
    }
    async function fetchFileList() {
        try {
            // УБРАН ПРОКСИ
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const html = await response.text();
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = html;
            const files = Array.from(tempDiv.querySelectorAll('a'))
                .map(a => a.getAttribute('href'))
                .filter(href => href && href.toLowerCase().endsWith('.csv.zip'))
                .map(href => ({ fullName: href, displayName: decodeURIComponent(href).replace(/\.csv\.zip$/i, '') }))
                .sort((a, b) => a.displayName.localeCompare(b.displayName));
            displayFileList(files);
        } catch (error) { fileListEl.innerHTML = `<li>Ошибка загрузки списка файлов: ${error.message}.</li>`;
        } finally { loaderEl.style.display = 'none'; }
    }
    function displayFileList(files) {
        fileListEl.innerHTML = '';
        files.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file.displayName;
            li.dataset.url = DATA_URL + file.fullName;
            li.addEventListener('click', () => handleFileSelect(li));
            fileListEl.appendChild(li);
        });
    }
    function handleFileSelect(selectedLi) {
        fileListEl.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
        selectedLi.classList.add('selected');
        modalState.selectedFileUrl = selectedLi.dataset.url;
        modalLoadBtn.disabled = true; startDateInput.disabled = true; endDateInput.disabled = true;
        dateRangeSelector.style.display = 'block';
        fileProcessStatus.textContent = 'Загрузка и обработка файла...';
        loadAndProcessZip(modalState.selectedFileUrl);
    }
    async function loadAndProcessZip(url) {
        try {
            // УБРАН ПРОКСИ
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const zipBlob = await response.blob();
            const jszip = new JSZip();
            const zip = await jszip.loadAsync(zipBlob);
            const csvFileName = Object.keys(zip.files).find(name => name.toLowerCase().endsWith('.csv') || name.toLowerCase().endsWith('.txt'));
            if (!csvFileName) throw new Error('CSV файл не найден в архиве.');
            modalState.fullCsvData = await zip.file(csvFileName).async('string');
            fileProcessStatus.textContent = 'Анализ дат...';
            const lines = modalState.fullCsvData.trim().split('\n');
            if (lines.length < 2) throw new Error('Файл пуст или содержит мало данных.');
            const firstDateStr = lines[0].split(/[,;]/)[0];
            const lastDateStr = lines[lines.length - 1].split(/[,;]/)[0];
            const minDate = parseDateSmart(firstDateStr);
            const maxDate = parseDateSmart(lastDateStr);
            if (!minDate || !maxDate) throw new Error('Не удалось определить формат даты в файле.');
            startDateInput.value = minDate.toISOString().split('T')[0];
            endDateInput.value = maxDate.toISOString().split('T')[0];
            startDateInput.min = startDateInput.value; startDateInput.max = endDateInput.value;
            endDateInput.min = startDateInput.value; endDateInput.max = endDateInput.value;
            startDateInput.disabled = false; endDateInput.disabled = false; modalLoadBtn.disabled = false;
            fileProcessStatus.textContent = `Данные за период с ${minDate.toLocaleDateString()} по ${maxDate.toLocaleDateString()} готовы к загрузке.`;
        } catch (error) { fileProcessStatus.textContent = `Ошибка: ${error.message}`; }
    }
    function parseDateSmart(dateStr) {
        dateStr = dateStr.trim();
        let parts = dateStr.split(/[.-/]/);
        if (parts.length !== 3) return null;
        if (parts[0].length === 4) return new Date(parts[0], parts[1] - 1, parts[2]); // YYYY.MM.DD
        if (parts[2].length === 4) return new Date(parts[2], parts[1] - 1, parts[0]); // DD.MM.YYYY
        return null;
    }
    function handleLoadData() {
        if (!modalState.fullCsvData) return;
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        endDate.setHours(23, 59, 59, 999);
        const lines = modalState.fullCsvData.trim().split('\n');
        const filteredLines = lines.filter(line => {
            const dateStr = line.split(/[,;]/)[0];
            const currentDate = parseDateSmart(dateStr);
            return currentDate && currentDate >= startDate && currentDate <= endDate;
        });
        document.getElementById('priceData').value = filteredLines.join('\n');
        closeModal();
        buildChartFromData(); // Auto-build chart
    }
    loadFromServerBtn.addEventListener('click', openModal);
    modalCancelBtn.addEventListener('click', closeModal);
    modalLoadBtn.addEventListener('click', handleLoadData);

</script>
</body>
</html>
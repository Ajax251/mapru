<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4e7df9">
    <meta name="apple-mobile-web-app-title" content="Видеоплеер">
    <title>Видеоплеер</title>
    <link rel="stylesheet" href="webfonts/all.min.css">
    <link rel="icon" href="https://i.ibb.co/8Dr2qM6Y/play.png" type="image/png">

    <style>
        :root {
            --primary-color: #4e7df9;
            --primary-light: rgba(78, 125, 249, 0.1);
            --primary-medium: rgba(78, 125, 249, 0.3);
            --primary-dark: #3d63c9;
            --text-color: #333;
            --text-secondary: #888;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --progress-bg: #e7e7e7;
            --control-hover: rgba(78, 125, 249, 0.1);
            --playlist-hover: rgba(78, 125, 249, 0.05);
            --playlist-active: rgba(78, 125, 249, 0.1);
            --playlist-border: #eee;
            --scrollbar-track: #f1f3f4;
            --scrollbar-thumb: #c1c9d2;
            --scrollbar-thumb-hover: #a8b2bf;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-color-hover: rgba(0, 0, 0, 0.15);
            --tooltip-bg: rgba(0, 0, 0, 0.7);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --button-text: #fff;
            --input-border: #ddd;
            --input-focus: #4e7df9;
            --video-controls-bg: rgba(0, 0, 0, 0.6);
            --video-controls-color: white;
        }

        [data-theme="dark"] {
            --primary-color: #5d8aff;
            --primary-light: rgba(93, 138, 255, 0.15);
            --primary-medium: rgba(93, 138, 255, 0.3);
            --primary-dark: #4d74d9;
            --text-color: #e4e6eb;
            --text-secondary: #b0b3b8;
            --background-color: #18191a;
            --card-background: #242526;
            --progress-bg: #3a3b3c;
            --control-hover: rgba(93, 138, 255, 0.15);
            --playlist-hover: rgba(93, 138, 255, 0.1);
            --playlist-active: rgba(93, 138, 255, 0.2);
            --playlist-border: #3a3b3c;
            --scrollbar-track: #3a3b3c;
            --scrollbar-thumb: #5a5b5c;
            --scrollbar-thumb-hover: #6a6b6c;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-color-hover: rgba(0, 0, 0, 0.4);
            --tooltip-bg: rgba(0, 0, 0, 0.85);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --button-text: #fff;
            --input-border: #444;
            --input-focus: #5d8aff;
            --video-controls-bg: rgba(0, 0, 0, 0.8);
            --video-controls-color: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overscroll-behavior: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            padding: 15px;
        }

        .player-container {
            width: 100%;
            max-width: 800px;
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px var(--shadow-color-hover);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 5;
        }

        .theme-toggle:hover {
            background: var(--control-hover);
            color: var(--primary-color);
        }

        .video-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .video-title {
            font-size: 22px;
            color: var(--text-color);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .video-author {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .video-container {
            width: 100%;
            position: relative;
            margin: 0 auto 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-color);
            background-color: #000;
            aspect-ratio: 16/9;
            transition: all 0.3s ease;
            user-select: none;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-size: 80px;
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--video-controls-bg);
            padding: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            color: var(--video-controls-color);
        }

        .video-container:hover .video-controls,
        .video-controls.active {
            opacity: 1;
        }

        .video-controls button {
            background: none;
            border: none;
            color: var(--video-controls-color);
            font-size: 16px;
            margin: 0 5px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .video-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .video-progress {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 10px;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .video-progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            width: 0;
        }

        .video-time {
            font-size: 12px;
            margin: 0 5px;
            white-space: nowrap;
        }

        .progress-container {
            height: 6px;
            background: var(--progress-bg);
            border-radius: 3px;
            margin: 20px 0;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-container:hover::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            bottom: -2px;
            background: var(--primary-light);
            border-radius: 5px;
        }

        .progress {
            height: 100%;
            background: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--card-background);
            box-shadow: 0 0 5px var(--shadow-color);
            transition: all 0.2s ease;
            opacity: 0;
        }

        .progress-container:hover .progress::after {
            width: 12px;
            height: 12px;
            opacity: 1;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls button {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            color: var(--text-color);
            transition: all 0.3s;
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            margin: 5px;
            z-index: 10;
            touch-action: manipulation;
        }

        .controls button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--control-hover);
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.3s;
        }

        .controls button:hover::before {
            transform: scale(1);
        }

        .controls button:active {
            transform: scale(0.95);
        }

        .controls button:hover {
            color: var(--primary-color);
        }

        .play-pause {
            background: var(--primary-color) !important;
            color: #fff !important;
            width: 60px !important;
            height: 60px !important;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px var(--primary-medium);
            font-size: 24px !important;
            transition: all 0.3s !important;
            position: relative;
            overflow: hidden;
        }

        .play-pause::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, transparent 25%, rgba(255, 255, 255, 0.2) 26%, transparent 27%);
            background-size: 5px 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .play-pause:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 8px 20px var(--primary-medium) !important;
        }

        .play-pause:hover::after {
            opacity: 0.5;
        }

        .play-pause:active {
            transform: scale(0.98) !important;
        }

        .play-pause i {
            position: relative;
            left: 2px;
            z-index: 2;
        }

        .prev-btn, .next-btn {
            font-size: 22px;
        }

        .playlist-btn, .shuffle-btn {
            font-size: 18px;
        }

        .shuffle-btn.active {
            color: var(--primary-color);
        }

        .volume-control {
            position: relative;
            display: flex;
            align-items: center;
        }

        .volume-slider-container {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
            margin-left: 5px;
        }

        .volume-control:hover .volume-slider-container,
        .volume-slider-container.active {
            width: 80px;
        }

        .volume-slider {
            width: 80px;
            -webkit-appearance: none;
            background: var(--progress-bg);
            height: 4px;
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover,
        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform 0.3s ease;
            z-index: 100;
            text-align: center;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tooltip-bg);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            white-space: nowrap;
            pointer-events: none;
        }

        .controls button:hover .tooltip {
            opacity: 1;
            visibility: visible;
            bottom: -30px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 5px 15px var(--primary-medium);
            }

            50% {
                transform: scale(1.03);
                box-shadow: 0 8px 20px var(--primary-medium);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 5px 15px var(--primary-medium);
            }
        }

        .playing {
            animation: pulse 2s infinite;
        }

        .playlist::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track,
        .modal-body::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb,
        .modal-body::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .playlist::-webkit-scrollbar-thumb:hover,
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .touch-active {
            transform: scale(0.95);
            opacity: 0.8;
            transition: transform 0.1s, opacity 0.1s;
        }

        /* Модальное окно */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 20px;
            width: 100%;
            max-width: 600px;
            position: relative;
            animation: modalFadeIn 0.3s forwards;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--playlist-border);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .modal-body {
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--card-background);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid var(--playlist-border);
            padding-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--button-text);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--progress-bg);
            color: var(--text-color);
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background: var(--scrollbar-thumb);
        }

        /* Плейлист в модальном окне */
        .playlist-modal {
            max-width: 700px;
            max-height: 80vh;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .playlist-modal .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        .playlist-controls {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            padding: 15px;
            background: var(--primary-light);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .playlist-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--card-background);
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .playlist-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        /* Стили для элементов плейлиста */
        .playlist-item {
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            background: var(--card-background);
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        .playlist-item:hover {
            color: var(--primary-color);
            background: var(--playlist-hover);
        }

        .playlist-item.active {
            color: var(--primary-color);
            font-weight: 500;
            background: var(--playlist-active);
            padding-left: 20px;
        }

        .playlist-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary-color);
            border-radius: 0 2px 2px 0;
        }

        .track-number {
            min-width: 24px;
            height: 24px;
            background: var(--track-number-bg);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
            margin-right: 12px;
            transition: all 0.2s;
        }

        .playlist-item:hover .track-number,
        .playlist-item.active .track-number {
            background: var(--primary-color);
            color: white;
        }

        .track-info {
            flex: 1;
            overflow: hidden;
        }

        .track-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color);
        }

        .track-author {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item.active .track-title {
            color: var(--primary-color);
        }

        .track-delete {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #78b6ff;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        .playlist-item:hover .track-delete {
            opacity: 0.8;
            transform: scale(1);
        }

        .track-delete:hover {
            background: #ff5252;
            opacity: 1;
        }

        .playlist-type-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
            background: var(--primary-light);
            color: var(--primary-color);
            vertical-align: middle;
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .loading-indicator.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 16px;
        }

        .welcome-tips {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            max-width: 90%;
            text-align: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .welcome-tips.show {
            opacity: 1;
            visibility: visible;
        }

        .welcome-tips .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: white;
            padding: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .empty-playlist {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Полноэкранный режим */
        .fullscreen-btn {
            font-size: 18px;
        }

        /* Адаптивный дизайн */
        @media (max-width: 768px) {
            .player-container {
                padding: 15px;
                border-radius: 12px;
            }

            .video-title {
                font-size: 18px;
            }

            .video-author {
                font-size: 14px;
            }

            .play-pause {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }

            .controls button {
                width: 35px;
                height: 35px;
                margin: 3px;
                font-size: 16px;
            }

            .tooltip {
                display: none;
            }

            .playlist-controls {
                padding: 10px;
                gap: 5px;
            }

            .playlist-control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .player-container {
                padding: 12px;
            }

            .video-title {
                font-size: 16px;
            }

            .controls button {
                width: 30px;
                height: 30px;
                font-size: 14px;
                margin: 2px;
            }

            .play-pause {
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
            }

            .track-title {
                font-size: 14px;
            }

            .track-author {
                font-size: 11px;
            }

            .track-number {
                min-width: 20px;
                height: 20px;
                margin-right: 6px;
                font-size: 11px;
            }

            .time-info {
                font-size: 12px;
                margin-bottom: 10px;
            }
        }

        .theme-toggle {
            transition: opacity 0.3s ease;
        }

        .theme-toggle.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .theme-toggle-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            z-index: 4;
        }

        .theme-toggle-area:hover .theme-toggle {
            opacity: 1;
            pointer-events: auto;
        }

        .theme-toggle .fa-sun {
            color: #4e7df9;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <div class="loading-text">Загрузка...</div>
    </div>

    <div class="player-container">
        <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
        
        <div class="video-info">
            <h2 class="video-title">Добавьте видеофайлы</h2>
            <p class="video-author">Плейлист пуст</p>
        </div>
        
        <div class="video-container" id="video-container">
            <div class="video-placeholder" id="video-placeholder">
                <i class="fas fa-film"></i>
            </div>
            <video id="video-player" class="video-player" style="display: none;"></video>
            
            <div class="video-controls" id="video-controls">
                <button id="video-play-pause"><i class="fas fa-play"></i></button>
                <div class="video-time" id="video-current-time">0:00</div>
                <div class="video-progress" id="video-progress">
                    <div class="video-progress-bar" id="video-progress-bar"></div>
                </div>
                <div class="video-time" id="video-duration">0:00</div>
                <button id="video-pip"><i class="fas fa-external-link-alt"></i></button>
                <button id="video-fullscreen"><i class="fas fa-expand"></i></button>
            </div>
        </div>
        
        <div class="progress-container" id="progress-container">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="time-info">
            <span id="current-time">0:00</span>
            <span id="duration">0:00</span>
        </div>
        
        <div class="controls">
            <div class="volume-control">
                <button class="volume-btn">
                    <i class="fas fa-volume-up"></i>
                    <span class="tooltip">Громкость</span>
                </button>
                <div class="volume-slider-container">
                    <input type="range" class="volume-slider" min="0" max="1" step="0.01" value="1">
                </div>
            </div>
            <button class="shuffle-btn" id="shuffle-btn">
                <i class="fas fa-random"></i>
                <span class="tooltip">Случайный порядок</span>
            </button>
            <button class="prev-btn">
                <i class="fas fa-step-backward"></i>
                <span class="tooltip">Предыдущий</span>
            </button>
            <button class="play-pause" id="play-pause">
                <i class="fas fa-play"></i>
            </button>
            <button class="next-btn">
                <i class="fas fa-step-forward"></i>
                <span class="tooltip">Следующий</span>
            </button>
            <button class="fullscreen-btn">
                <i class="fas fa-expand"></i>
                <span class="tooltip">Полный экран</span>
            </button>
            
            <button class="pip-btn" id="pip-btn">
    <i class="fas fa-external-link-alt"></i>
    <span class="tooltip">Картинка в картинке</span>
</button>

            <button class="playlist-btn" id="playlist-btn">
                <i class="fas fa-list"></i>
                <span class="tooltip">Плейлист</span>
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        Файлы добавлены в плейлист
    </div>
    
    <div class="welcome-tips" id="welcomeTips">
        Нажмите на <i class="fas fa-list"></i>, чтобы открыть плейлист и добавить видеофайлы.
        <button class="close-btn" id="closeTips"><i class="fas fa-times"></i></button>
    </div>
    
    <!-- Модальное окно для плейлиста -->
    <div class="modal-overlay" id="playlistModal">
        <div class="modal playlist-modal">
            <div class="modal-header">
                <h3 class="modal-title">Плейлист</h3>
                <button class="modal-close" id="closePlaylistModal">&times;</button>
            </div>
          
            <div class="playlist-controls">
                <label for="fileInput" class="playlist-control-btn" title="Загрузить файлы">
                    <i class="fas fa-upload"></i>
                    <input type="file" id="fileInput" accept="video/*" multiple style="display:none">
                </label>
                <button class="playlist-control-btn" id="urlBtnInPlaylist" title="Добавить URL">
                    <i class="fas fa-link"></i>
                </button>
                <button class="playlist-control-btn" id="savePlaylistBtn" title="Сохранить">
                    <i class="fas fa-save"></i>
                </button>
                <button class="playlist-control-btn" id="loadPlaylistBtn" title="Загрузить">
                    <i class="fas fa-file-import"></i>
                </button>
            </div>
          
            <div class="modal-body">
                <div class="playlist" id="playlist">
                    <!-- Плейлист пуст -->
                    <div class="empty-playlist">Плейлист пуст</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для добавления URL -->
    <div class="modal-overlay" id="urlModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Добавить видео по URL</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="bulkUrls" class="form-control" rows="8" placeholder="https://example.com/video1.mp4&#10;https://example.com/video2.mp4"></textarea>
                    <p class="form-text">Введите URL видеофайлов (MP4, WebM и т.д.), каждый с новой строки</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelUrl">Отмена</button>
                <button class="btn btn-primary" id="addUrl">Добавить</button>
            </div>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const playPauseBtn = document.getElementById('play-pause');
    const playPauseIcon = playPauseBtn.querySelector('i');
    const progressContainer = document.getElementById('progress-container');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');
    const playlistBtn = document.getElementById('playlist-btn');
    const playlist = document.getElementById('playlist');
    const fileInput = document.querySelector('label[for="fileInput"] input[type="file"]');
    const videoTitle = document.querySelector('.video-title');
    const videoAuthor = document.querySelector('.video-author');
    const notification = document.getElementById('notification');
    const videoContainer = document.getElementById('video-container');
    const videoPlayer = document.getElementById('video-player');
    const videoPlaceholder = document.getElementById('video-placeholder');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('i');
    
    const playerContainer = document.querySelector('.player-container');
    
    const welcomeTips = document.getElementById('welcomeTips');
    const closeTips = document.getElementById('closeTips');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const volumeBtn = document.querySelector('.volume-btn');
    const volumeSliderContainer = document.querySelector('.volume-slider-container');
    const volumeSlider = document.querySelector('.volume-slider');
    
    // Видео контролы
    const videoControls = document.getElementById('video-controls');
    const videoPlayPauseBtn = document.getElementById('video-play-pause');
    const videoPlayPauseIcon = videoPlayPauseBtn.querySelector('i');
    const videoProgressContainer = document.getElementById('video-progress');
    const videoProgressBar = document.getElementById('video-progress-bar');
    const videoCurrentTimeEl = document.getElementById('video-current-time');
    const videoDurationEl = document.getElementById('video-duration');
    const videoFullscreenBtn = document.getElementById('video-fullscreen');
    
    // Модальные окна
    const playlistModal = document.getElementById('playlistModal');
    const closePlaylistModal = document.getElementById('closePlaylistModal');
    const urlBtnInPlaylist = document.getElementById('urlBtnInPlaylist');
    const savePlaylistBtn = document.getElementById('savePlaylistBtn');
    const loadPlaylistBtn = document.getElementById('loadPlaylistBtn');
    
    // URL модальное окно
    const urlModal = document.getElementById('urlModal');
    const closeModal = document.getElementById('closeModal');
    const cancelUrl = document.getElementById('cancelUrl');
    const addUrl = document.getElementById('addUrl');
    const bulkUrls = document.getElementById('bulkUrls');
    

    
    let isPlaying = false;
    let videos = [];
    let currentVideoIndex = 0;
    let isShuffleMode = false;
    let playHistory = [];
    let shuffleQueue = [];
    let touchstartX = 0;
    let touchendX = 0;
    let touchstartY = 0;
    let touchendY = 0;
    let isMuted = false;
    let previousVolume = 1;
    let isFullscreen = false;
    let hideControlsTimeout;
    
    const pipBtn = document.getElementById('pip-btn');
const videoPipBtn = document.getElementById('video-pip');
let isPipMode = false;
    
    // Инициализация
    initTheme();
    showWelcomeTipsIfFirstVisit();
    initVolume();
    setupBackgroundPlayback();
    setupVideoControls();
    loadSettings();
    loadSavedPlaylist();
    
    const themeToggleArea = document.createElement('div');
    themeToggleArea.className = 'theme-toggle-area';
    playerContainer.appendChild(themeToggleArea);
    
    // Перемещаем кнопку внутрь области
    themeToggleArea.appendChild(themeToggle);
    
    // Скрываем кнопку через 5 секунд
    setTimeout(() => {
        themeToggle.classList.add('hidden');
    }, 3000);
    
    // Настройка фонового воспроизведения
    function setupBackgroundPlayback() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => playPause());
            navigator.mediaSession.setActionHandler('pause', () => playPause());
            navigator.mediaSession.setActionHandler('previoustrack', () => prevVideo());
            navigator.mediaSession.setActionHandler('nexttrack', () => nextVideo());
        }

        document.addEventListener('visibilitychange', handleVisibilityChange);
    }

    function handleVisibilityChange() {
        if (document.visibilityState === 'visible' && isPlaying) {
            requestWakeLock();
        }
    }

    // WakeLock для предотвращения засыпания экрана
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                });
            } catch (err) {
                console.log(`Wake Lock error: ${err.name}, ${err.message}`);
            }
        }
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        } else {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            if (prefersDarkScheme.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon('dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeIcon('light');
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                const newTheme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                updateThemeIcon(newTheme);
            }
        });
    }

    function updateThemeIcon(theme) {
        if (theme === 'dark') {
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        } else {
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        }
    }
    
    function showWelcomeTipsIfFirstVisit() {
        const hasVisitedBefore = localStorage.getItem('hasVisitedBefore');
        if (!hasVisitedBefore) {
            setTimeout(() => {
                welcomeTips.classList.add('show');
            }, 2000);
            localStorage.setItem('hasVisitedBefore', 'true');
        }

        closeTips.addEventListener('click', () => {
            welcomeTips.classList.remove('show');
        });
    }
    
    async function togglePictureInPicture() {
    if (!document.pictureInPictureEnabled || videos.length === 0) {
        showNotification('Режим картинка в картинке не поддерживается');
        return;
    }

    try {
        if (document.pictureInPictureElement) {
            await document.exitPictureInPicture();
        } else {
            if (videoPlayer.readyState === 0) {
                showNotification('Сначала загрузите видео');
                return;
            }
            await videoPlayer.requestPictureInPicture();
        }
    } catch (error) {
        console.error('PiP error:', error);
        showNotification('Ошибка при переключении режима картинка в картинке');
    }
}


    function setupVideoControls() {
        // Показывать/скрывать контролы при наведении
        videoContainer.addEventListener('mouseenter', () => {
            showVideoControls();
            clearTimeout(hideControlsTimeout);
        });
        
        videoContainer.addEventListener('mouseleave', () => {
            if (isPlaying) {
                hideControlsTimeout = setTimeout(() => {
                    hideVideoControls();
                }, 2000);
            }
        });
        
        videoContainer.addEventListener('mousemove', () => {
            showVideoControls();
            clearTimeout(hideControlsTimeout);
            
            if (isPlaying) {
                hideControlsTimeout = setTimeout(() => {
                    hideVideoControls();
                }, 2000);
            }
        });
        
        // Управление воспроизведением
        videoContainer.addEventListener('click', (e) => {
            // Предотвращаем клик, если клик был на элементах управления
            if (!e.target.closest('.video-controls')) {
                playPause();
            }
        });
        
        videoPlayPauseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            playPause();
        });
        
        // Прогресс видео
        videoProgressContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            const rect = videoProgressContainer.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            videoPlayer.currentTime = pos * videoPlayer.duration;
        });
        
        videoPlayer.addEventListener('canplay', () => {
            loadingIndicator.classList.remove('show');
        });

        videoPlayer.addEventListener('loadeddata', () => {
            loadingIndicator.classList.remove('show');
        });

        videoPlayer.addEventListener('loadedmetadata', () => {
            loadingIndicator.classList.remove('show');
        });

        videoPlayer.addEventListener('error', (e) => {
            console.error('Video error:', e);
            loadingIndicator.classList.remove('show');
            showNotification('Ошибка воспроизведения видео');
        });
        
        // Управление полноэкранным режимом
        videoFullscreenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFullscreen();
        });
        
        // Обновление прогресса для видео
        videoPlayer.addEventListener('timeupdate', updateVideoProgress);
        
        // Обработка окончания видео
        videoPlayer.addEventListener('ended', () => {
            nextVideo();
        });
    }
    
    function showVideoControls() {
        videoControls.classList.add('active');
    }
    
    function hideVideoControls() {
        videoControls.classList.remove('active');
    }
    
    function updateVideoProgress() {
        const { duration, currentTime } = videoPlayer;
        
        if (duration) {
            const progressPercent = (currentTime / duration) * 100;
            videoProgressBar.style.width = `${progressPercent}%`;
            
            // Обновляем время
            videoCurrentTimeEl.textContent = formatTime(currentTime);
            videoDurationEl.textContent = formatTime(duration);
            
            // Также обновляем основной прогресс
            updateMainProgress(currentTime, duration);
        }
    }
    
    function updateMainProgress(currentTime, duration) {
        if (duration) {
            const progressPercent = (currentTime / duration) * 100;
            progress.style.width = `${progressPercent}%`;
            
            // Обновляем время под видео
            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(duration);
        }
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        let secs = Math.floor(seconds % 60);
        if (secs < 10) {
            secs = `0${secs}`;
        }
        return `${mins}:${secs}`;
    }
    
    function toggleFullscreen() {
        if (!isFullscreen) {
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) {
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.msRequestFullscreen) {
                videoContainer.msRequestFullscreen();
            }
            isFullscreen = true;
            videoFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            isFullscreen = false;
            videoFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
    }
    
    // Обработчик изменения полноэкранного режима
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    
    function handleFullscreenChange() {
        isFullscreen = !!document.fullscreenElement || 
                       !!document.webkitFullscreenElement || 
                       !!document.mozFullScreenElement ||
                       !!document.msFullscreenElement;
                      
        if (isFullscreen) {
            videoFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            videoFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
    }

    function loadSettings() {
        const savedShuffleMode = localStorage.getItem('shuffleMode');
        if (savedShuffleMode === 'true') {
            isShuffleMode = true;
            shuffleBtn.classList.add('active');
        }
    }

    function saveSettings() {
        localStorage.setItem('shuffleMode', isShuffleMode);
    }
    
    function loadSavedPlaylist() {
        try {
            const savedPlaylist = localStorage.getItem('videoPlaylist');
            if (savedPlaylist) {
                const parsedPlaylist = JSON.parse(savedPlaylist);
                
                if (parsedPlaylist.videos && parsedPlaylist.videos.length > 0) {
                    // Сохраняем только URL видео из localStorage
                    videos = parsedPlaylist.videos.filter(video => 
                        video.type === 'video' && video.url && !video.file
                    );
                    
                    // Проверяем, есть ли видео
                    if (videos.length > 0) {
                        renderPlaylist();
                        
                        currentVideoIndex = 0;
                        loadVideo(videos[0]);
                        
                        showNotification('Плейлист загружен');
                    }
                }
            }
        } catch (e) {
            console.error('Error loading playlist:', e);
        }
    }
    
    function savePlaylist() {
        try {
            // Фильтруем только URL-видео
            const urlVideos = videos.filter(video => 
                video.type === 'video' && video.url && !video.file
            );
            
            if (urlVideos.length > 0) {
                const playlistToSave = {
                    videos: urlVideos
                };
                
                localStorage.setItem('videoPlaylist', JSON.stringify(playlistToSave));
            } else {
                // Если нет URL-видео, очищаем сохраненный плейлист
                localStorage.removeItem('videoPlaylist');
            }
        } catch (e) {
            console.error('Error saving playlist:', e);
        }
    }

    function initVolume() {
        const savedVolume = localStorage.getItem('volume');
        if (savedVolume !== null) {
            const volume = parseFloat(savedVolume);
            videoPlayer.volume = volume;
            volumeSlider.value = volume;
            updateVolumeIcon(volume);
        }

        setupVolumeControls();
    }

    function updateVolumeIcon(volume) {
        const volumeIcon = volumeBtn.querySelector('i');
        
        if (volume <= 0 || isMuted) {
            volumeIcon.className = 'fas fa-volume-mute';
        } else if (volume < 0.5) {
            volumeIcon.className = 'fas fa-volume-down';
        } else {
            volumeIcon.className = 'fas fa-volume-up';
        }
    }

    function setupVolumeControls() {
        volumeBtn.addEventListener('click', () => {
            if (isMuted) {
                setVolume(previousVolume);
                isMuted = false;
            } else {
                previousVolume = videoPlayer.volume;
                setVolume(0);
                isMuted = true;
            }
            
            volumeSlider.value = videoPlayer.volume;
            updateVolumeIcon(videoPlayer.volume);
            localStorage.setItem('volume', videoPlayer.volume);
            
            if (window.innerWidth <= 768) {
                volumeSliderContainer.classList.toggle('active');
            }
        });

        volumeSlider.addEventListener('input', () => {
            const volume = parseFloat(volumeSlider.value);
            setVolume(volume);
            isMuted = (volume === 0);
            updateVolumeIcon(volume);
            localStorage.setItem('volume', volume);
        });
        
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && 
                !volumeBtn.contains(e.target) && 
                !volumeSliderContainer.contains(e.target) &&
                volumeSliderContainer.classList.contains('active')) {
                volumeSliderContainer.classList.remove('active');
            }
        });
    }
    
    function setVolume(volume) {
        videoPlayer.volume = volume;
    }

  function loadVideo(video) {
    if (!video) return;
    
    loadingIndicator.classList.add('show');
    
    // Очищаем предыдущее видео
    stopVideo();
    
    const videoName = video.title || 'Неизвестное видео';
    videoTitle.textContent = videoName;
    videoAuthor.textContent = video.author || '';
    
    // Обновляем title страницы
    document.title = videoName + ' - Видеоплеер';
    
    // Скрываем плейсхолдер
    videoPlaceholder.style.display = 'none';
    
    // Показываем HTML5 плеер
    videoPlayer.style.display = 'block';
    
    // Загружаем видео
    videoPlayer.src = video.url;
    videoPlayer.load();
    
    videoPlayer.addEventListener('canplay', function onCanPlay() {
        loadingIndicator.classList.remove('show');
        videoPlayer.removeEventListener('canplay', onCanPlay);
    });

    videoPlayer.addEventListener('error', function onError() {
        loadingIndicator.classList.remove('show');
        showNotification('Ошибка загрузки видео');
        videoPlayer.removeEventListener('error', onError);
    });

    // Также добавляем таймаут, чтобы предотвратить зависание лоадера
    setTimeout(() => {
        loadingIndicator.classList.remove('show');
    }, 5000);
    
    // Восстанавливаем позицию воспроизведения
    const savedPosition = loadVideoPosition(video.url);
    
    // Добавить проверку после загрузки метаданных видео
    videoPlayer.addEventListener('loadedmetadata', function onMetadataLoaded() {
        // Проверяем, не слишком ли близко к концу сохраненная позиция
        if (savedPosition && videoPlayer.duration && videoPlayer.duration - savedPosition <= 5) {
            // Если слишком близко к концу, начинаем с начала
            videoPlayer.currentTime = 0;
        } else if (savedPosition) {
            videoPlayer.currentTime = savedPosition;
        }
        
        videoPlayer.removeEventListener('loadedmetadata', onMetadataLoaded);
    });
    
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: videoName,
            artist: video.author || '',
            artwork: video.thumbnail ? [{ src: video.thumbnail, sizes: '512x512', type: 'image/jpeg' }] : []
        });
    }
    
    updateActivePlaylistItem();
}
    
 function saveVideoPosition(videoUrl, position) {
    if (!videoUrl) return;
    
    try {
        // Не сохраняем позицию, если видео почти закончилось (осталось менее 5 секунд)
        if (videoPlayer.duration && videoPlayer.duration - position <= 5) {
            // Вместо этого сбрасываем сохраненную позицию до 0
            const videoPositions = JSON.parse(localStorage.getItem('videoPositions')) || {};
            const videoKey = btoa(encodeURIComponent(videoUrl));
            videoPositions[videoKey] = 0;
            localStorage.setItem('videoPositions', JSON.stringify(videoPositions));
            return;
        }
        
        const videoPositions = JSON.parse(localStorage.getItem('videoPositions')) || {};
        const videoKey = btoa(encodeURIComponent(videoUrl));
        videoPositions[videoKey] = position;
        localStorage.setItem('videoPositions', JSON.stringify(videoPositions));
    } catch (e) {
        console.error('Error saving video position:', e);
    }
}


    function loadVideoPosition(videoUrl) {
        if (!videoUrl) return 0;
        
        try {
            const videoPositions = JSON.parse(localStorage.getItem('videoPositions')) || {};
            const videoKey = btoa(encodeURIComponent(videoUrl));
            return videoPositions[videoKey] || 0;
        } catch (e) {
            console.error('Error loading video position:', e);
            return 0;
        }
    }

    function playVideo() {
        if (videos.length === 0) {
            showNotification('Добавьте видео в плейлист');
            return;
        }
        
        updatePlayPauseUI(true);
        
        try {
            const playPromise = videoPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    requestWakeLock();
                }).catch(error => {
                    console.error("Playback error:", error);
                    pauseVideo();
                    
                    if (error.name === 'NotAllowedError') {
                        showNotification('Необходимо взаимодействие: нажмите на кнопку воспроизведения');
                    } else {
                        showNotification('Ошибка воспроизведения: попробуйте еще раз');
                    }
                });
            }
        } catch (error) {
            console.error("Play error:", error);
            pauseVideo();
            showNotification('Ошибка воспроизведения');
        }
    }

    function pauseVideo() {
        updatePlayPauseUI(false);
        videoPlayer.pause();
        isPlaying = false;
        
        if (videos[currentVideoIndex]) {
            saveVideoPosition(videos[currentVideoIndex].url, videoPlayer.currentTime);
        }
        
        if (wakeLock) {
            wakeLock.release().then(() => {
                wakeLock = null;
            });
        }
    }
    
    function stopVideo() {
        // Останавливаем текущее видео
        videoPlayer.pause();
        videoPlayer.src = '';
        videoPlayer.load();
        
        // Сбрасываем UI
        videoProgressBar.style.width = '0%';
        videoCurrentTimeEl.textContent = '0:00';
        videoDurationEl.textContent = '0:00';
        progress.style.width = '0%';
        currentTimeEl.textContent = '0:00';
        durationEl.textContent = '0:00';
    }
    
    function updatePlayPauseUI(isPlaying) {
        if (isPlaying) {
            playPauseIcon.classList.remove('fa-play');
            playPauseIcon.classList.add('fa-pause');
            
            videoPlayPauseIcon.classList.remove('fa-play');
            videoPlayPauseIcon.classList.add('fa-pause');
        } else {
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            
            videoPlayPauseIcon.classList.remove('fa-pause');
            videoPlayPauseIcon.classList.add('fa-play');
        }
    }

    function playPause() {
        if (videos.length === 0) {
            showNotification('Добавьте видео в плейлист');
            return;
        }
        
        if (isPlaying) {
            pauseVideo();
        } else {
            playVideo();
        }
    }

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const targetTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', targetTheme);
        localStorage.setItem('theme', targetTheme);
        
        updateThemeIcon(targetTheme);
        
        document.body.classList.add('theme-transition');
        setTimeout(() => {
            document.body.classList.remove('theme-transition');
        }, 300);
    });

    function shuffleButtonHandler() {
        isShuffleMode = !isShuffleMode;
        
        if (isShuffleMode) {
            shuffleBtn.classList.add('active');
            createShuffleQueue();
            showNotification('Случайный порядок включен');
        } else {
            shuffleBtn.classList.remove('active');
            shuffleQueue = [];
            showNotification('Обычный порядок воспроизведения');
        }
        
        saveSettings();
    }

    function createShuffleQueue() {
        shuffleQueue = [];
        for (let i = 0; i < videos.length; i++) {
            if (i !== currentVideoIndex) {
                shuffleQueue.push(i);
            }
        }
        
        for (let i = shuffleQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffleQueue[i], shuffleQueue[j]] = [shuffleQueue[j], shuffleQueue[i]];
        }
    }

    function getNextVideoIndex() {
        if (videos.length === 0) return 0;
        
        if (isShuffleMode) {
            if (shuffleQueue.length === 0) {
                createShuffleQueue();
            }
            
            if (shuffleQueue.length > 0) {
                return shuffleQueue.pop();
            }
        }
        
        let nextIndex = currentVideoIndex + 1;
        
        if (nextIndex >= videos.length) {
            nextIndex = 0;
        }
        
        return nextIndex;
    }

    function getPrevVideoIndex() {
        if (videos.length === 0) return 0;
        
        if (videoPlayer.currentTime > 3) {
            return currentVideoIndex;
        }
        
        if (isShuffleMode && playHistory.length > 1) {
            playHistory.pop();
            return playHistory.pop();
        }
        
        let prevIndex = currentVideoIndex - 1;
        
        if (prevIndex < 0) {
            prevIndex = videos.length - 1;
        }
        
        return prevIndex;
    }

    function nextVideo() {
        if (videos[currentVideoIndex]) {
            saveVideoPosition(videos[currentVideoIndex].url, videoPlayer.currentTime);
        }
        
        playHistory.push(currentVideoIndex);
        
        const newIndex = getNextVideoIndex();
        currentVideoIndex = newIndex;
        
        loadVideo(videos[currentVideoIndex]);
        if (isPlaying) playVideo();
    }

    function prevVideo() {
        if (videos[currentVideoIndex]) {
            saveVideoPosition(videos[currentVideoIndex].url, videoPlayer.currentTime);
        }
        
        const newIndex = getPrevVideoIndex();
        
        if (newIndex !== currentVideoIndex) {
            currentVideoIndex = newIndex;
            loadVideo(videos[currentVideoIndex]);
            if (isPlaying) playVideo();
        } else {
            // Просто перематываем на начало
            videoPlayer.currentTime = 0;
        }
    }

    function showNotification(message) {
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 2000);
    }

    // Функция обновления активного элемента плейлиста
    function updateActivePlaylistItem() {
        document.querySelectorAll('.playlist-item').forEach(item => {
            item.classList.remove('active');
        });
        
        if (videos.length === 0) return;
        
        const playlistItems = document.querySelectorAll('.playlist-item');
        if (playlistItems[currentVideoIndex]) {
            playlistItems[currentVideoIndex].classList.add('active');
        }
    }

    // Функция для рендеринга плейлиста с кнопками удаления
    function renderPlaylist() {
        playlist.innerHTML = '';
        
        if (videos.length === 0) {
            playlist.innerHTML = '<div class="empty-playlist">Плейлист пуст</div>';
            return;
        }
        
        videos.forEach((video, index) => {
            const playlistItem = document.createElement('div');
            playlistItem.classList.add('playlist-item');
            if (index === currentVideoIndex) playlistItem.classList.add('active');
            
            const typeIndicator = `<span class="playlist-type-indicator">MP4</span>`;
            
            playlistItem.innerHTML = `
                <div class="track-number">${index + 1}</div>
                <div class="track-info">
                    <div class="track-title">${video.title} ${typeIndicator}</div>
                    <div class="track-author">${video.author || ''}</div>
                </div>
                <button class="track-delete" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            playlistItem.addEventListener('click', (e) => {
                // Проверяем, что клик не был по кнопке удаления
                if (!e.target.closest('.track-delete')) {
                    if (currentVideoIndex !== index) {
                        if (videos[currentVideoIndex]) {
                            saveVideoPosition(videos[currentVideoIndex].url, videoPlayer.currentTime);
                        }
                        
                        if (isShuffleMode) {
                            playHistory.push(currentVideoIndex);
                        }
                        
                        currentVideoIndex = index;
                        loadVideo(videos[currentVideoIndex]);
                        playVideo();
                    } else {
                        playPause();
                    }
                }
            });
            
            playlist.appendChild(playlistItem);
        });
        
        // Добавляем обработчики для кнопок удаления
        document.querySelectorAll('.track-delete').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(button.dataset.index);
                removeFromPlaylist(index);
            });
        });
    }

    // Функция удаления видео из плейлиста
    function removeFromPlaylist(index) {
        if (index < 0 || index >= videos.length) return;
        
        // Если удаляем текущее видео
        if (index === currentVideoIndex) {
            // Останавливаем воспроизведение
            pauseVideo();
            
            // Удаляем видео
            videos.splice(index, 1);
            
            // Если в плейлисте остались видео
            if (videos.length > 0) {
                // Если удалили последнее видео, переходим к предпоследнему
                if (index >= videos.length) {
                    currentVideoIndex = videos.length - 1;
                }
                // Загружаем новое видео
                loadVideo(videos[currentVideoIndex]);
            } else {
                // Если плейлист пуст, сбрасываем
                resetPlayer();
            }
        } else {
            // Если удаляем другое видео
            videos.splice(index, 1);
            
            // Если удаленный трек был перед текущим, корректируем индекс
            if (index < currentVideoIndex) {
                currentVideoIndex--;
            }
        }
        
        // Если включен режим случайного воспроизведения, обновляем очередь
        if (isShuffleMode) {
            createShuffleQueue();
        }
        
        // Перерисовываем плейлист
        renderPlaylist();
        
        // Сохраняем плейлист
        savePlaylist();
        
        showNotification('Видео удалено из плейлиста');
    }

    // Функция сброса плеера
    function resetPlayer() {
        // Останавливаем любое воспроизведение
        stopVideo();
        
        // Сбрасываем интерфейс
        videoTitle.textContent = 'Добавьте видеофайлы';
        videoAuthor.textContent = 'Плейлист пуст';
        
        // Показываем плейсхолдер
        videoPlaceholder.style.display = 'flex';
        videoPlayer.style.display = 'none';
        
        isPlaying = false;
        updatePlayPauseUI(false);
        currentVideoIndex = 0;
        document.title = 'Видеоплеер';
    }

    // Обработчики для работы с URL
    function addBulkUrls(text) {
        if (!text) return 0;
        
        // Разбиваем текст на строки
        const lines = text.split(/\r?\n/).filter(line => line.trim());
        
        if (lines.length === 0) return 0;
        
        // Добавляем каждый URL
        let addedCount = 0;
        lines.forEach(line => {
            const url = line.trim();
            if (url) {
                // Получаем имя файла из URL для использования в качестве названия
                const fileName = url.split('/').pop().split('?')[0];
                const videoTitle = fileName || 'Видео ' + (videos.length + 1);
                
                // Создаем объект видео
                const video = {
                    title: videoTitle,
                    author: '',
                    url: url,
                    type: 'video',
                    thumbnail: null
                };
                
                // Добавляем видео в плейлист
                videos.push(video);
                addedCount++;
            }
        });
        
        // Обновляем отображение плейлиста
        renderPlaylist();
        
        // Если это первые видео, загружаем первое
        if (videos.length === addedCount) {
            currentVideoIndex = 0;
            loadVideo(videos[0]);
        }
        
        // Если включен режим случайного воспроизведения, обновляем очередь
        if (isShuffleMode) {
            createShuffleQueue();
        }
        
        // Сохраняем плейлист
        savePlaylist();
        
        return addedCount;
    }

    fileInput.addEventListener('change', function(e) {
        const files = this.files;
        if (files.length === 0) return;
        
        loadingIndicator.classList.add('show');
        showNotification(`Добавление ${files.length} файлов...`);
        
        // Загружаем и обрабатываем каждый видеофайл
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // Проверяем, что это видеофайл
            if (!file.type.startsWith('video/')) {
                continue;
            }
            
            // Создаем ссылку на файл
            const videoUrl = URL.createObjectURL(file);
            
            // Создаем объект видео с пометкой file: true для локальных файлов
            const video = {
                title: file.name.replace(/\.[^.]+$/, ''), // Удаляем расширение из имени файла
                author: '',
                url: videoUrl,
                type: 'video',
                file: true,  // Явно помечаем как локальный файл
                thumbnail: null
            };
            
            // Добавляем видео в плейлист
            videos.push(video);
        }
        
        // Обновляем отображение плейлиста
        renderPlaylist();
        
        // Если это первые видео, загружаем первое
        if (videos.length === files.length) {
            currentVideoIndex = 0;
            loadVideo(videos[0]);
        }
        
        // Если включен режим случайного воспроизведения, обновляем очередь
        if (isShuffleMode) {
            createShuffleQueue();
        }
        
        // Сохраняем плейлист
        savePlaylist();
        
        loadingIndicator.classList.remove('show');
        showNotification(`${files.length} видео добавлено в плейлист`);
        
        // Очищаем значение input для повторной загрузки тех же файлов
        this.value = '';
    });
    
    // Открытие модального окна плейлиста
    playlistBtn.addEventListener('click', () => {
        playlistModal.classList.add('show');
        renderPlaylist(); // Перерисовываем плейлист при открытии
    });
    
    // Закрытие модального окна плейлиста
    closePlaylistModal.addEventListener('click', () => {
        playlistModal.classList.remove('show');
    });
    
    // Открытие модального окна URL из плейлиста
    urlBtnInPlaylist.addEventListener('click', () => {
        urlModal.classList.add('show');
        bulkUrls.value = ''; // Очищаем поле ввода
    });
    
    // Закрытие модальных окон
    closeModal.addEventListener('click', () => {
        urlModal.classList.remove('show');
    });
    
    cancelUrl.addEventListener('click', () => {
        urlModal.classList.remove('show');
    });
    
    // Добавление URL
    addUrl.addEventListener('click', () => {
        const bulkUrlsText = bulkUrls.value.trim();
        
        if (bulkUrlsText) {
            const addedCount = addBulkUrls(bulkUrlsText);
            if (addedCount > 0) {
                urlModal.classList.remove('show');
                showNotification(`Добавлено ${addedCount} видео в плейлист`);
            } else {
                showNotification('Укажите хотя бы один корректный URL');
            }
        } else {
            showNotification('Укажите хотя бы один URL');
        }
    });
    
    // Сохранение плейлиста в файл
    savePlaylistBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // Фильтруем только URL-видео для сохранения в файл
        const urlVideos = videos.filter(video => 
            video.type === 'video' && video.url && !video.file
        );
        
        if (urlVideos.length === 0) {
            showNotification('Нет URL видео для сохранения');
            return;
        }
        
        try {
            // Создаем объект для сохранения
            const playlistData = {
                name: "Мой видеоплейлист",
                videos: urlVideos
            };
            
            // Конвертируем в JSON
            const playlistJson = JSON.stringify(playlistData);
            
            // Создаем блоб
            const blob = new Blob([playlistJson], { type: 'application/json' });
            
            // Создаем ссылку для скачивания
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'videoplaylist.json';
            document.body.appendChild(a);
            a.click();
            
            // Очищаем ссылку
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
            
            showNotification('Плейлист сохранен');
        } catch (e) {
            console.error('Error saving playlist:', e);
            showNotification('Ошибка при сохранении плейлиста');
        }
    });
    
    // Загрузка плейлиста из файла
    loadPlaylistBtn.addEventListener('click', function(e) {
        e.stopPropagation(); // Предотвращаем всплытие события
        
        // Создаем скрытый input для выбора файла
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        fileInput.addEventListener('change', function() {
            if (this.files.length === 0) return;
            
            const file = this.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const playlistData = JSON.parse(e.target.result);
                    
                    if (playlistData.videos && Array.isArray(playlistData.videos)) {
                        // Отфильтровываем только те записи, которые можно воспроизвести
                        const validVideos = playlistData.videos.filter(video => {
                            return video.type === 'video' && video.url;
                        });
                        
                        if (validVideos.length > 0) {
                            // Заменяем текущий плейлист
                            videos = validVideos;
                            
                            // Перерисовываем плейлист
                            renderPlaylist();
                            
                            // Загружаем первое видео
                            currentVideoIndex = 0;
                            loadVideo(videos[0]);
                            
                            // Сохраняем плейлист
                            savePlaylist();
                            
                            showNotification('Плейлист загружен');
                        } else {
                            showNotification('В плейлисте нет воспроизводимых видео');
                        }
                    } else {
                        showNotification('Некорректный формат плейлиста');
                    }
                } catch (error) {
                    console.error('Error loading playlist file:', error);
                    showNotification('Ошибка чтения файла плейлиста');
                }
            };
            
            reader.onerror = function() {
                showNotification('Ошибка чтения файла');
            };
            
            reader.readAsText(file);
            
            // Удаляем input
            document.body.removeChild(fileInput);
        });
        
        fileInput.click();
    });
    
    // Обработка клавиатуры
    document.addEventListener('keydown', function(e) {
        // Предотвращаем стандартное поведение только для клавиш управления медиа
        if ([' ', 'ArrowLeft', 'ArrowRight', 'MediaPlayPause', 'MediaNextTrack', 'MediaPreviousTrack'].includes(e.key)) {
            e.preventDefault();
        }
        
        switch (e.key) {
            case ' ': // Пробел - play/pause
            case 'MediaPlayPause':
                playPause();
                break;
            case 'ArrowLeft': // Стрелка влево - перемотка назад
                if (e.ctrlKey) {
                    prevVideo(); // Ctrl+ArrowLeft - предыдущее видео
                } else {
                    // Перемотка на 5 секунд назад
                    videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
                }
                break;
            case 'ArrowRight': // Стрелка вправо - перемотка вперед
                if (e.ctrlKey) {
                    nextVideo(); // Ctrl+ArrowRight - следующее видео
                } else {
                    // Перемотка на 5 секунд вперед
                    videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 5);
                }
                break;
                
                case 'p': // Picture-in-Picture
    togglePictureInPicture();
    break;
    
            case 'MediaPreviousTrack':
                prevVideo();
                break;
            case 'MediaNextTrack':
                nextVideo();
                break;
            case 'f': // Полноэкранный режим
                toggleFullscreen();
                break;
            case 'Escape': // Escape - закрыть модальные окна
                playlistModal.classList.remove('show');
                urlModal.classList.remove('show');
                break;
        }
    });

    // Добавляем обработчики событий для кнопок
    playPauseBtn.addEventListener('click', () => {
        playPause();
    });

    const prevBtn = document.querySelector('.prev-btn');
    prevBtn.addEventListener('click', () => {
        prevVideo();
    });

    const nextBtn = document.querySelector('.next-btn');
    nextBtn.addEventListener('click', () => {
        nextVideo();
    });

    shuffleBtn.addEventListener('click', () => {
        shuffleButtonHandler();
    });

    progressContainer.addEventListener('click', (e) => {
        const rect = progressContainer.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        videoPlayer.currentTime = pos * videoPlayer.duration;
    });

    document.querySelector('.fullscreen-btn').addEventListener('click', () => {
        toggleFullscreen();
    });

    // Предотвращаем обновление страницы при двойном клике
    window.addEventListener('dblclick', function(e) {
        e.preventDefault();
    });

    // Обработка нажатий на мобильных устройствах
    document.querySelectorAll('.controls button, .playlist-control-btn').forEach(button => {
        button.addEventListener('touchstart', function() {
            this.classList.add('touch-active');
        });
        
        button.addEventListener('touchend', function() {
            this.classList.remove('touch-active');
        });
        
        button.addEventListener('touchcancel', function() {
            this.classList.remove('touch-active');
        });
    });
    
    // Предотвращаем стандартное поведение перетаскивания
    document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') {
            e.preventDefault();
        }
    });
    
    // Предотвращаем контекстное меню для видео
    videoContainer.addEventListener('contextmenu', e => {
        e.preventDefault();
    });
    
    // Закрытие модальных окон при клике вне них
    document.addEventListener('click', function(e) {
        // Закрываем только модальные окна при клике снаружи
        if (urlModal.classList.contains('show') && 
            !e.target.closest('.modal') && 
            !e.target.closest('#urlBtnInPlaylist')) {
            urlModal.classList.remove('show');
        }
    });
    
    // Обработчики событий PiP
pipBtn.addEventListener('click', togglePictureInPicture);
videoPipBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    togglePictureInPicture();
});

// Обработка событий входа/выхода из режима PiP
videoPlayer.addEventListener('enterpictureinpicture', () => {
    isPipMode = true;
    pipBtn.innerHTML = '<i class="fas fa-compress-alt"></i><span class="tooltip">Выход из режима</span>';
    videoPipBtn.innerHTML = '<i class="fas fa-compress-alt"></i>';
});

videoPlayer.addEventListener('leavepictureinpicture', () => {
    isPipMode = false;
    pipBtn.innerHTML = '<i class="fas fa-external-link-alt"></i><span class="tooltip">Картинка в картинке</span>';
    videoPipBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
});
    
    // Перенаправление любых исключений в удобное уведомление
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.message);
        showNotification('Произошла ошибка: попробуйте перезагрузить страницу');
        return false; // не показывать браузерное сообщение об ошибке
    });

    // Обработка потери соединения
    window.addEventListener('offline', function() {
        showNotification('Интернет-соединение потеряно');
    });

    window.addEventListener('online', function() {
        showNotification('Интернет-соединение восстановлено');
    });
    
    // Для предотвращения закрытия при взаимодействии с fileInput
    document.querySelector('label[for="fileInput"]').addEventListener('click', function(e) {
        e.stopPropagation(); // Предотвращаем всплытие события
    });
});
</script>
    
    
    </body>
</html>
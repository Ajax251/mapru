
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini PS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="webfonts/atom-one-dark.min.css" id="hljs-theme">
    <script src="webfonts/highlight.min.js"></script>
    <script src="webfonts/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
             pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        } else {
            console.warn("PDF.js library loaded but pdfjsLib is not defined yet.");
        }
    </script>
    <link rel="icon" href="img/ps.png" type="image/png" />
 <style>
      :root {
          --bg-color: #012456;
          --text-color: #cccccc;
          --prompt-color: #eeeeee;
          --user-input-color: #ffffff;
          --link-color: #33bbff;
          --error-color: #ffcc66;
          --bot-response-color: #ffcc66;
          --code-bg: #0e0e1e;
          --scrollbar-thumb: #555588;
          --scrollbar-track: #1a1a3a;
          --border-color: rgba(120, 120, 150, 0.3);
          --font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
          --transition-duration: 0.2s;
          --button-bg: rgba(255, 255, 255, 0.1);
          --button-border: var(--border-color);
          --button-color: var(--text-color);
          --button-hover-bg: rgba(255, 255, 255, 0.2);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
      }

      body.matrix-theme {
          --bg-color: #000000;
          --text-color: #00ff41;
          --prompt-color: #ffffff;
          --user-input-color: #f0fff0;
          --link-color: #33ff77;
          --error-color: #ffdd33;
          --bot-response-color: #00ff41;
          --code-bg: #051a05;
          --scrollbar-thumb: #008020;
          --scrollbar-track: #031a03;
          --border-color: rgba(0, 255, 65, 0.3);
          --button-bg: rgba(0, 255, 65, 0.1);
          --button-border: var(--border-color);
          --button-color: var(--text-color);
          --button-hover-bg: rgba(0, 255, 65, 0.25);
          --button-hover-border: var(--link-color);
          --canvas-filter: brightness(0.8) contrast(1.1);
          --terminal-bg-color: rgba(0, 5, 0, 0.8);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css';
      }

      body.cobalt2-theme {
          --bg-color: #002240;
          --text-color: #ffffff;
          --prompt-color: #ffc600;
          --user-input-color: #ffffff;
          --link-color: #ff9d00;
          --error-color: #f92672;
          --bot-response-color: #e0e0e0;
          --code-bg: #001a30;
          --scrollbar-thumb: #ffc600;
          --scrollbar-track: #003359;
          --border-color: rgba(255, 198, 0, 0.3);
          --button-bg: rgba(255, 198, 0, 0.15);
          --button-border: var(--border-color);
          --button-color: #ffc600;
          --button-hover-bg: rgba(255, 198, 0, 0.3);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
      }

      body.solarized-dark-theme {
          --bg-color: #002b36;
          --text-color: #839496;
          --prompt-color: #93a1a1;
          --user-input-color: #eee8d5;
          --link-color: #268bd2;
          --error-color: #dc322f;
          --bot-response-color: #839496;
          --code-bg: #073642;
          --scrollbar-thumb: #586e75;
          --scrollbar-track: #001f27;
          --border-color: rgba(88, 110, 117, 0.3);
          --button-bg: rgba(88, 110, 117, 0.1);
          --button-border: var(--border-color);
          --button-color: var(--text-color);
          --button-hover-bg: rgba(88, 110, 117, 0.25);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/solarized-dark.min.css';
      }

      body.solarized-light-theme {
          --bg-color: #fdf6e3;
          --text-color: #657b83;
          --prompt-color: #586e75;
          --user-input-color: #073642;
          --link-color: #268bd2;
          --error-color: #dc322f;
          --bot-response-color: #657b83;
          --code-bg: #eee8d5;
          --scrollbar-thumb: #93a1a1;
          --scrollbar-track: #eee8d5;
          --border-color: rgba(147, 161, 161, 0.3);
          --button-bg: rgba(147, 161, 161, 0.1);
          --button-border: var(--border-color);
          --button-color: var(--text-color);
          --button-hover-bg: rgba(147, 161, 161, 0.25);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/solarized-light.min.css';
      }

      body.light-blue-theme {
          --bg-color: #e0f7ff;
          --text-color: #003c4d;
          --prompt-color: #005f7a;
          --user-input-color: #00212b;
          --link-color: #0077a3;
          --error-color: #d32f2f;
          --bot-response-color: #004c63;
          --code-bg: #cceeff;
          --scrollbar-thumb: #a0d2e8;
          --scrollbar-track: #d0eaf8;
          --border-color: rgba(0, 95, 122, 0.3);
          --button-bg: rgba(0, 95, 122, 0.1);
          --button-border: var(--border-color);
          --button-color: #005f7a;
          --button-hover-bg: rgba(0, 95, 122, 0.2);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
      }

      body.shades-of-purple-theme {
          --bg-color: #2d2b55;
          --text-color: #e0dffe;
          --prompt-color: #fad000;
          --user-input-color: #ffffff;
          --link-color: #a5ff90;
          --error-color: #ff657a;
          --bot-response-color: #d6cce2;
          --code-bg: #1e1e3f;
          --scrollbar-thumb: #b362ff;
          --scrollbar-track: #3c377f;
          --border-color: rgba(250, 208, 0, 0.3);
          --button-bg: rgba(250, 208, 0, 0.15);
          --button-border: var(--border-color);
          --button-color: #fad000;
          --button-hover-bg: rgba(250, 208, 0, 0.3);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/shades-of-purple.min.css';
      }

      body.emerald-white-theme {
          --bg-color: #ffffff;
          --text-color: #006442;
          --prompt-color: #004d33;
          --user-input-color: #003321;
          --link-color: #008055;
          --error-color: #c0392b;
          --bot-response-color: #006442;
          --code-bg: #f5fdf9;
          --scrollbar-thumb: #a3e4c7;
          --scrollbar-track: #e8f8f1;
          --border-color: rgba(0, 100, 66, 0.3);
          --button-bg: rgba(0, 100, 66, 0.1);
          --button-border: var(--border-color);
          --button-color: #006442;
          --button-hover-bg: rgba(0, 100, 66, 0.2);
          --button-hover-border: var(--link-color);
          --canvas-filter: none;
          --terminal-bg-color: var(--bg-color);
          --hljs-style-href: 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
      }


      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { height: 100%; width: 100%; overflow: hidden; }
      body {
          font-family: var(--font-family);
          background-color: var(--bg-color);
          color: var(--text-color);
          display: flex;
          justify-content: center;
          align-items: center;
          transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease;
      }

      #matrix-canvas {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          display: none;
          filter: var(--canvas-filter);
          background-color: #000;
      }
      body.matrix-theme #matrix-canvas {
          display: block;
      }

      .terminal-container {
          width: 100%;
          height: 100%;
          padding: 10px;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          position: relative;
          background-color: var(--terminal-bg-color);
          transition: background-color var(--transition-duration) ease;
          z-index: 1;
      }

      #terminal-output {
          flex: 1;
          padding-bottom: 10px;
          overflow-y: auto;
          overflow-x: hidden;
          scroll-behavior: smooth;
          line-height: 1.5;
          font-size: 0.95rem;
      }
      #terminal-output::-webkit-scrollbar { width: 8px; }
      #terminal-output::-webkit-scrollbar-track { background: var(--scrollbar-track); }
      #terminal-output::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; }
      #terminal-output::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scrollbar-thumb) 70%, white 30%); }

      .message-line {
          margin-bottom: 5px;
          word-wrap: break-word;
          white-space: pre-wrap;
          transition: color var(--transition-duration) ease;
      }
      .user-command {
          text-align: right;
          padding-left: 40px;
          margin-left: auto;
      }
       .user-command .command-text {
          color: var(--user-input-color);
          background-color: color-mix(in srgb, var(--terminal-bg-color, var(--bg-color)) 70%, var(--user-input-color) 10%);
          padding: 6px 12px;
          border-radius: 10px 10px 0 10px;
          display: inline-block;
          max-width: 90%;
          text-align: left;
          transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease;
       }
      .user-command .file-info-text {
          display: block;
          text-align: right;
          margin-top: 4px;
          opacity: 0.8;
          font-size: 0.9em;
          color: color-mix(in srgb, var(--link-color) 70%, var(--text-color) 30%);
          transition: color var(--transition-duration) ease;
      }
      .user-command .message-image {
          max-width: 90%;
          max-height: 250px;
          border: 1px solid var(--border-color);
          margin-top: 8px;
          display: block;
          cursor: pointer;
          object-fit: contain;
          margin-left: auto;
          margin-right: 0;
          transition: border-color var(--transition-duration) ease;
       }
      .bot-response {
          color: var(--bot-response-color);
          padding-right: 40px;
          transition: color var(--transition-duration) ease;
      }
      .bot-response strong { color: var(--prompt-color); transition: color var(--transition-duration) ease; }
      .bot-response a { color: var(--link-color); transition: color var(--transition-duration) ease; }
      .bot-response a:hover { color: color-mix(in srgb, var(--link-color) 70%, white 30%); }
      .bot-response code:not(pre > code) { color: var(--link-color); background-color: color-mix(in srgb, var(--terminal-bg-color, var(--bg-color)) 80%, var(--link-color) 10%); transition: color var(--transition-duration) ease, background-color var(--transition-duration) ease;}
      .bot-response .code-block code { color: var(--text-color); transition: color var(--transition-duration) ease;}
      .bot-response .code-language { color: color-mix(in srgb, var(--link-color) 60%, var(--text-color) 40%); transition: color var(--transition-duration) ease; }

      .error-message {
          color: var(--error-color);
          font-weight: bold;
          padding-right: 40px;
          transition: color var(--transition-duration) ease;
      }
      .user-command .error-message {
          text-align: right;
          padding-right: 0;
          padding-left: 40px;
      }
      .warning-message {
          color: var(--error-color);
          padding-right: 40px;
          transition: color var(--transition-duration) ease;
      }
       .user-command .warning-message {
          text-align: right;
          padding-right: 0;
          padding-left: 40px;
      }
      .info-message {
          color: color-mix(in srgb, var(--link-color) 70%, var(--text-color) 30%);
          font-style: italic;
          text-align: center;
          opacity: 0.9;
          font-size: 0.9em;
          padding: 0 10px;
          transition: color var(--transition-duration) ease;
      }
      .info-message:not(:first-child) {
          margin-top: 8px;
      }

      .input-line {
          display: flex;
          align-items: center;
          padding-top: 5px;
          border-top: 1px solid var(--border-color);
          margin-top: auto;
          flex-shrink: 0;
          transition: border-color var(--transition-duration) ease;
      }
      .input-line .prompt {
          color: var(--prompt-color);
          margin-right: 8px;
          user-select: none;
          white-space: nowrap;
          transition: color var(--transition-duration) ease;
          cursor: pointer;
          padding: 8px 0;
          min-width: 4ch;
          text-align: center;
          font-family: sans-serif;
      }
      #terminal-input {
          flex-grow: 1;
          background: transparent;
          border: none;
          outline: none;
          color: var(--user-input-color);
          font-family: inherit;
          font-size: inherit;
          line-height: inherit;
          caret-color: var(--prompt-color);
          min-height: 1.5em;
          padding: 8px 0;
          white-space: pre-wrap;
          word-wrap: break-word;
          transition: color var(--transition-duration) ease, caret-color var(--transition-duration) ease;
      }
       #terminal-input:empty::before {
          content: attr(data-placeholder);
          color: color-mix(in srgb, var(--text-color) 50%, transparent 50%);
          cursor: text;
          pointer-events: none;
        }
      #terminal-input.processing {
          cursor: wait;
          color: var(--text-color);
          opacity: 0.8;
          user-select: none;
          -webkit-user-select: none;
          -ms-user-select: none;
           caret-color: transparent;
      }
      #terminal-input.processing::before {
          content: "";
      }

      #file-input { display: none; }

      .message-line strong { color: var(--prompt-color); font-weight: 600; transition: color var(--transition-duration) ease; }
      .message-line em { font-style: italic; }
      .message-line a { color: var(--link-color); text-decoration: underline; transition: color var(--transition-duration) ease;}
      .message-line a:hover { color: color-mix(in srgb, var(--link-color) 70%, white 30%); }
      .message-line code:not(pre > code) { background-color: color-mix(in srgb, var(--terminal-bg-color, var(--bg-color)) 80%, var(--link-color) 10%); padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; color: var(--link-color); margin: 0 1px; vertical-align: middle; transition: color var(--transition-duration) ease, background-color var(--transition-duration) ease;}
      .file-info-text { opacity: 0.8; display: block; font-size: 0.9em; color: color-mix(in srgb, var(--link-color) 70%, var(--text-color) 30%); transition: color var(--transition-duration) ease; }
      .file-info-text i { font-style: normal; }

      .code-block {
          position: relative;
          background: var(--code-bg);
          border: 1px solid var(--border-color);
          margin: 10px 0;
          overflow: hidden;
          max-width: 100%;
          transition: background-color var(--transition-duration) ease, border-color var(--transition-duration) ease;
      }
      .code-header {
          background: color-mix(in srgb, var(--code-bg) 50%, var(--border-color) 20%);
          padding: 4px 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 0.85em;
          color: var(--text-color);
          border-bottom: 1px solid var(--border-color);
          min-height: 28px;
          transition: background-color var(--transition-duration) ease, border-color var(--transition-duration) ease, color var(--transition-duration) ease;
      }
      .code-language {
          font-style: italic;
          color: color-mix(in srgb, var(--link-color) 60%, var(--text-color) 40%);
          transition: color var(--transition-duration) ease;
      }
      .code-copy-button {
          background: var(--button-bg);
          border: 1px solid var(--button-border);
          border-radius: 4px;
          padding: 3px 8px;
          color: var(--button-color);
          font-size: 11px;
          cursor: pointer;
          transition: all var(--transition-duration) ease;
          font-family: inherit;
          display: flex; align-items: center; gap: 4px;
      }
      .code-copy-button svg { width: 12px; height: 12px; fill: currentColor; }
      .code-copy-button:hover {
          background: var(--button-hover-bg);
          color: var(--button-color);
          border-color: var(--button-hover-border);
      }
      .code-copy-button.copied { background-color: var(--link-color); color: var(--bg-color); }
      .code-copy-button.error { background-color: #ff5555; color: white; }
      .code-block pre {
          margin: 0; padding: 10px 15px 15px 15px;
          overflow-x: auto;
          border: none !important;
          scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
          max-width: 100%;
      }
      .code-block pre::-webkit-scrollbar { height: 6px; }
      .code-block pre::-webkit-scrollbar-track { background: var(--scrollbar-track); }
      .code-block pre::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 3px; }
      .code-block code {
          font-family: inherit;
          font-size: 0.9rem; color: var(--text-color);
          display: block; min-width: min-content; line-height: 1.5;
          white-space: pre;
          word-wrap: normal;
          word-break: normal;
          transition: color var(--transition-duration) ease;
      }
      .message-image {
          max-width: 90%;
          max-height: 250px;
          border: 1px solid var(--border-color);
          margin-top: 8px;
          display: block;
          cursor: pointer;
          object-fit: contain;
          transition: border-color var(--transition-duration) ease;
      }
       .message-image:hover { border-color: var(--link-color); }

       #send-button {
          background: var(--button-bg);
          border: 1px solid var(--button-border);
          color: var(--button-color);
          padding: 8px 10px;
          margin-left: 8px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.9em;
          font-family: inherit;
          transition: all var(--transition-duration) ease;
          flex-shrink: 0;
          user-select: none;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
       }
       #send-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
       }
       #send-button:hover {
           background: var(--button-hover-bg);
           border-color: var(--button-hover-border);
       }
       #send-button:disabled {
            cursor: wait;
            opacity: 0.6;
       }
       
       @keyframes prompt-pulse {
  0%, 100% { color: var(--prompt-color); opacity: 1; }
  50% { color: var(--link-color); opacity: 0.1; }
}

.prompt.processing {
  animation: prompt-pulse 1.5s infinite ease-in-out;
  cursor: default;
}


      @media (max-width: 768px) {
          .terminal-container { padding: 5px; }
          #terminal-output { font-size: 0.9rem; }
          #terminal-input { font-size: 0.9rem; min-height: 1.4em; padding: 6px 0;}
          .input-line .prompt { padding: 6px 0;}
          .code-block code { font-size: 0.85rem; }
          .user-command { padding-left: 20px; }
          .bot-response, .error-message, .warning-message { padding-right: 20px; }
          .user-command .error-message, .user-command .warning-message { padding-left: 20px; }
          #send-button { font-size: 0.85em; padding: 6px 8px; gap: 4px; }
          #send-button svg { width: 14px; height: 14px; }
          #send-button span { display: none; }
      }
       ::selection { background: var(--scrollbar-thumb); color: var(--bg-color); }

   </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <div class="terminal-container" id="terminal-container">
        <div id="terminal-output">
        </div>
        <div class="input-line">
            <span class="prompt" id="prompt" title="Нажмите для смены темы"></span>
            <div id="terminal-input" contenteditable="true" spellcheck="false" data-placeholder=""></div>
            <button id="send-button" title="">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685z"/></svg>
                <span></span>
            </button>
        </div>
        <input type="file" id="file-input" accept="image/jpeg, image/png, image/gif, image/webp, application/pdf">
    </div>

     <script>
        const terminalOutput = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        const promptElement = document.getElementById('prompt');
        const fileInput = document.getElementById('file-input');
        const terminalContainer = document.getElementById('terminal-container');
        const sendButton = document.getElementById('send-button');
        const matrixCanvas = document.getElementById('matrix-canvas');
        const hljsThemeLink = document.getElementById('hljs-theme');


const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
const API_MODEL = "gemini-2.5-flash-lite";
        const MAX_FILE_SIZE_MB = 10;
        const MAX_PDF_PAGES_EXTRACT = 10;
        const PROMPT_TEXT = '✨';

        const themes = [
            { name: 'powershell', className: '', displayName: 'PowerShell' },
            { name: 'matrix', className: 'matrix-theme', displayName: 'Matrix' },
            { name: 'cobalt2', className: 'cobalt2-theme', displayName: 'Cobalt2' },
            { name: 'solarized-dark', className: 'solarized-dark-theme', displayName: 'Solarized Dark' },
            { name: 'solarized-light', className: 'solarized-light-theme', displayName: 'Solarized Light' },
            { name: 'light-blue', className: 'light-blue-theme', displayName: 'Light Blue' },
            { name: 'shades-of-purple', className: 'shades-of-purple-theme', displayName: 'Shades of Purple' },
            { name: 'emerald-white', className: 'emerald-white-theme', displayName: 'Emerald White' },
        ];
        let currentThemeIndex = 0;

        let chatHistory = [];
        let uploadedFile = null;
        let isProcessing = false;
        // Removed processingStartTime, not used

        let matrixIntervalId = null;


        function copyUsingExecCommand(text) {
            const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = 'fixed'; textArea.style.top = "-9999px"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); let success = false; try { success = document.execCommand('copy'); } catch (err) { success = false; } document.body.removeChild(textArea); if (!success && navigator.clipboard && window.isSecureContext) { return navigator.clipboard.writeText(text).then(() => true).catch(() => false); } return Promise.resolve(success);
        }

        function escapeHtml(text) { if (typeof text !== 'string') return text; const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text.replace(/[&<>"']/g, m => map[m]); }

        function linkify(text) { const urlRegex = /(?<!(?:\]\(|href=|src=|`|='|"))(https?:\/\/[^\s<`'">\])}]+[^\s<`'">.,;!?\])}])/g; return text.replace(urlRegex, (url) => { let displayUrl = url; if (displayUrl.length > 60) { try { const u = new URL(url); displayUrl = `${u.hostname}${u.pathname.length > 15 ? u.pathname.substring(0,12)+'...' : u.pathname}${u.search ? '?...' : ''}${u.hash ? '#...' : ''}`; } catch (e) {} } return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(displayUrl)}</a>`; }); }

        function createCodeBlock(code, language = 'plaintext') {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block';
            const header = document.createElement('div');
            header.className = 'code-header';
            const langSpan = document.createElement('span');
            langSpan.className = 'code-language';
            let detectedLang = language;
            if (typeof hljs !== 'undefined') {
                 if (!language || language === 'plaintext' || language === 'text') {
                    try { const result = hljs.highlightAuto(code); detectedLang = result.language || 'plaintext'; } catch (e) { detectedLang = 'plaintext'; }
                }
                langSpan.textContent = hljs.getLanguage(detectedLang) ? detectedLang : 'plaintext';
            } else {
                langSpan.textContent = 'plaintext';
                detectedLang = 'plaintext';
            }
            const copyButton = document.createElement('button');
            copyButton.className = 'code-copy-button';
            copyButton.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> <span>Копировать</span>`;
            copyButton.title = 'Скопировать код';
            copyButton.addEventListener('click', async () => {
                const btnSpan = copyButton.querySelector('span');
                const success = await copyUsingExecCommand(code);
                 if (success) { btnSpan.textContent = 'Скопировано!'; copyButton.classList.add('copied'); setTimeout(() => { btnSpan.textContent = 'Копировать'; copyButton.classList.remove('copied'); }, 1500); }
                 else { btnSpan.textContent = 'Ошибка'; copyButton.classList.add('error'); setTimeout(() => { btnSpan.textContent = 'Копировать'; copyButton.classList.remove('error'); }, 2000); }
            });
            header.appendChild(langSpan);
            header.appendChild(copyButton);
            const pre = document.createElement('pre');
            const codeElement = document.createElement('code');
            if (typeof hljs !== 'undefined') {
                const validLang = hljs.getLanguage(detectedLang) ? detectedLang : 'plaintext';
                codeElement.className = `language-${validLang}`;
                codeElement.textContent = code;
                try {
                    hljs.highlightElement(codeElement);
                }
                catch (e) {
                    console.warn("Highlighting failed:", e);
                    codeElement.className = 'language-plaintext'; codeElement.textContent = code;
                }
            } else {
                codeElement.className = 'language-plaintext';
                codeElement.textContent = code;
            }
            pre.appendChild(codeElement);
            wrapper.appendChild(header);
            wrapper.appendChild(pre);
            return wrapper;
        }

        function formatMessageContent(rawText) {
             const codeBlockRegex = /```(\w+)?\n?([\s\S]*?)```/gs; // Adjusted regex slightly for flexibility
             let parts = []; let lastIndex = 0; let match;

             // First, handle potential ```code block``` syntax
             while ((match = codeBlockRegex.exec(rawText)) !== null) {
                 // Add text before the code block
                 if (match.index > lastIndex) {
                     parts.push({ type: 'text', content: rawText.substring(lastIndex, match.index) });
                 }
                 // Add the code block itself
                 // Use optional chaining and trim content, provide default language
                 parts.push({ type: 'code', content: match[2]?.trim() || '', language: match[1] || 'plaintext' });
                 lastIndex = match.index + match[0].length;
             }
             // Add any remaining text after the last code block
             if (lastIndex < rawText.length) {
                 parts.push({ type: 'text', content: rawText.substring(lastIndex) });
             }

             // If no code blocks were found but there's text, treat the whole thing as text
             if (parts.length === 0 && rawText.trim().length > 0) {
                 parts.push({ type: 'text', content: rawText });
             } else if (parts.length === 0 && rawText.length === 0) {
                 // Handle empty input gracefully
                 return document.createDocumentFragment();
             }

             const fragment = document.createDocumentFragment();
             parts.forEach(part => {
                 if (part.type === 'text') {
                     // Process text parts for other Markdown-like syntax
                     let html = escapeHtml(part.content)
                         .replace(/`([^`]+?)`/g, '<code>$1</code>') // Inline code ``
                         .replace(/\*\*(?=\S)(.+?[*\s]?)(?<=\S)\*\*/g, '<strong>$1</strong>') // Bold **
                         .replace(/__(?=\S)(.+?[_\s]?)(?<=\S)__/g, '<strong>$1</strong>') // Bold __ (Keep this one for compatibility if needed)
                         .replace(/(?<!\*)\*(?=\S)(.+?[*\s]?)(?<=\S)\*(?!\*)/g, '<em>$1</em>'); // Italics *
                         // .replace(/(?<!_)_(?=\S)(.+?[_\s]?)(?<=\S)_(?!_)/g, '<em>$1</em>'); // <--- REMOVED THIS LINE

                     // Linkify and handle newlines
                     html = linkify(html).replace(/\n/g, '<br>');

                     // Append the processed HTML
                     // Create a temporary div to parse the HTML string safely
                     const tempDiv = document.createElement('div');
                     tempDiv.innerHTML = html;
                     // Append child nodes from the temp div to the fragment
                     while (tempDiv.firstChild) {
                         fragment.appendChild(tempDiv.firstChild);
                     }
                 } else if (part.type === 'code') {
                     // Append code blocks directly using the existing function
                     fragment.appendChild(createCodeBlock(part.content, part.language));
                 }
             });
             return fragment;
         }


        function displayLine(content, type = 'bot-response', fileUrl = null, fileName = null) {
            if (!terminalOutput) return;
            const lineDiv = document.createElement('div');
            lineDiv.className = `message-line ${type}`;
            if (type === 'user-command') {
                const commandSpan = document.createElement('span');
                commandSpan.className = 'command-text';
                 if (typeof content === 'string') {
                    commandSpan.textContent = content;
                 } else {
                     commandSpan.textContent = content?.toString() || '';
                 }
                lineDiv.appendChild(commandSpan);
            } else {
                if (typeof content === 'string') {
                    const formattedFragment = formatMessageContent(content);
                    lineDiv.appendChild(formattedFragment);
                } else if (content instanceof Node) {
                    lineDiv.appendChild(content);
                } else {
                     lineDiv.textContent = String(content);
                 }
            }
             const isKnownImage = fileUrl && (fileUrl.startsWith('data:image') || (fileUrl.startsWith('http') && (!fileName || !fileName.toLowerCase().endsWith('.pdf'))));
             const isKnownPdf = fileName && fileName.toLowerCase().endsWith('.pdf');

             if (fileName) {
                 const fileInfo = document.createElement('small');
                 fileInfo.className = 'file-info-text';
                 let icon = isKnownPdf ? '📄' : (isKnownImage ? '🖼️' : '📎');
                 fileInfo.innerHTML = `<i>${icon} ${escapeHtml(fileName)}</i>`;
                 if (lineDiv.querySelector('.command-text') || lineDiv.childNodes.length > 0) {
                     lineDiv.appendChild(document.createElement('br'));
                 }
                 lineDiv.appendChild(fileInfo);
             }

             if (isKnownImage) {
                 const img = document.createElement('img');
                 img.src = fileUrl;
                 img.alt = `Изображение: ${escapeHtml(fileName||'прикреплено')}`;
                 img.className = 'message-image';
                 img.title = 'Нажмите для просмотра';
                 img.onload = scrollToBottom;
                 img.onerror = () => {
                     const errSpan = document.createElement('span');
                     errSpan.className = 'error-message';
                     errSpan.style.display = 'block';
                     errSpan.style.marginTop = '5px';
                     errSpan.textContent = `[Ошибка загрузки изображения: ${escapeHtml(fileName||'файл')}]`;
                     if (type === 'user-command') errSpan.style.textAlign = 'right';

                     const fileInfoSpan = lineDiv.querySelector('.file-info-text');
                     if(fileInfoSpan) {
                         lineDiv.insertBefore(errSpan, fileInfoSpan);
                     } else {
                         lineDiv.appendChild(errSpan);
                     }
                     if(img.parentNode === lineDiv) lineDiv.removeChild(img);
                     scrollToBottom();
                 };
                 img.onclick = () => window.open(fileUrl, '_blank');

                 const fileInfoSpan = lineDiv.querySelector('.file-info-text');
                  if (fileInfoSpan) {
                      lineDiv.insertBefore(img, fileInfoSpan);
                       if(lineDiv.querySelector('.command-text') || lineDiv.childNodes.length > 2) {
                           lineDiv.insertBefore(document.createElement('br'), img);
                       }
                  } else {
                      if (lineDiv.querySelector('.command-text') || lineDiv.childNodes.length > 0) {
                          lineDiv.appendChild(document.createElement('br'));
                      }
                     lineDiv.appendChild(img);
                  }
             }
            terminalOutput.appendChild(lineDiv);
            scrollToBottom();
        }

        function readFileAsDataURL(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

        async function extractTextFromPdf(file) { return new Promise(async (resolve, reject) => { if (typeof pdfjsLib === 'undefined') return reject('PDF.js не загружен.'); if (!pdfjsLib.GlobalWorkerOptions.workerSrc) pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`; const reader = new FileReader(); reader.onload = async function (event) { try { const pdf = await pdfjsLib.getDocument(new Uint8Array(event.target.result)).promise; let text = ''; const maxP = Math.min(pdf.numPages, MAX_PDF_PAGES_EXTRACT); for (let i = 1; i <= maxP; i++) { try { const page = await pdf.getPage(i); const content = await page.getTextContent({ normalizeWhitespace: true }); text += content.items.map(item => item.str||'').join(' ') + '\n\n'; page.cleanup(); } catch (pageErr) { text += `\n[Ошибка извлечения текста со стр. ${i}]\n`; } } if (pdf.numPages > maxP) text += `\n... [Извлечено ${maxP} из ${pdf.numPages} страниц] ...\n`; resolve(text.replace(/\n{3,}/g, '\n\n').trim()); } catch (err) { if (err.name === 'PasswordException') reject('PDF защищен паролем.'); else reject(`Ошибка обработки PDF: ${err.message||err.name}`); } }; reader.onerror = () => reject('Ошибка чтения файла PDF.'); reader.readAsArrayBuffer(file); }); }


 function setProcessing(processing) {
             isProcessing = processing;
             const promptEl = document.getElementById('prompt');
             const inputEl = document.getElementById('terminal-input');
             const sendBtn = document.getElementById('send-button');

             // --- Matrix Animation Control ---
             const isMatrixTheme = themes[currentThemeIndex]?.name === 'matrix';
             if (processing && isMatrixTheme) {
                 // Запускаем только если processing=true И тема=matrix
                 startMatrixBackground();
             } else {
                 // Останавливаем если processing=false ИЛИ тема НЕ matrix
                 stopMatrixBackground();
             }
             // --- End Matrix Animation Control ---

             if (inputEl && promptEl && sendBtn) {
                 inputEl.contentEditable = !processing;
                 sendBtn.disabled = processing;

                 if (processing) {
                     inputEl.classList.add('processing');
                     inputEl.removeAttribute('data-placeholder');
                     inputEl.textContent = '';
                     promptEl.classList.add('processing');
                 } else {
                     inputEl.classList.remove('processing');
                     inputEl.textContent = '';
                     inputEl.dataset.placeholder = uploadedFile
                         ? `Файл прикреплен: ${uploadedFile.name}`
                         : '';
                     promptEl.textContent = PROMPT_TEXT;
                     promptEl.classList.remove('processing');
                     setTimeout(() => inputEl.focus(), 0);
                 }
             }

             if (terminalContainer) {
                  terminalContainer.style.cursor = processing ? 'wait' : 'default';
             }
         }

        function resetFileInputState() {
            uploadedFile = null;
            if (fileInput) fileInput.value = null;
            if (terminalInput && !isProcessing) {
                 terminalInput.dataset.placeholder = '';
                 // Don't focus here, let processInput handle it after sending
                 // terminalInput.focus();
            }
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                if (terminalOutput) {
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                }
            });
        }

async function processInput() {
    if (isProcessing) return;

    let userCommandText = terminalInput.textContent.trim();
    let currentFile = uploadedFile;
    let fileDataUrl = null;
    let fileName = currentFile?.name;
    let isImg = currentFile?.type.startsWith('image/');
    let isPDF = currentFile?.type === 'application/pdf';
    let apiText = userCommandText;

    // --- Start file processing early ---
    if (currentFile) {
        setProcessing(true); // Start visual indication early
        displayLine(`[Обработка файла: ${escapeHtml(fileName)}]`, 'info-message');

        if (isImg) {
            try { fileDataUrl = await readFileAsDataURL(currentFile); }
            catch (e) { displayLine(`❌ Ошибка чтения файла изображения: ${escapeHtml(e.message)}`, 'user-command error-message'); resetFileInputState(); setProcessing(false); return; }
        } else if (isPDF) {
            try {
                const pdfTxt = await extractTextFromPdf(currentFile);
                apiText = `(Извлеченный текст из PDF: "${escapeHtml(fileName)}")\n\n--- НАЧАЛО ТЕКСТА PDF ---\n${pdfTxt}\n--- КОНЕЦ ТЕКСТА PDF ---\n\n${apiText}`.trim();
                displayLine(`[Текст из PDF (${escapeHtml(fileName)}) извлечен]`, 'info-message');
            } catch (e) {
                displayLine(`⚠️ Ошибка извлечения текста из PDF: ${escapeHtml(e)}`, 'user-command warning-message');
                apiText = `(Не удалось извлечь текст из PDF: "${escapeHtml(fileName)}")\n\n${apiText}`.trim();
                displayLine(`[Запрос будет отправлен без текста из PDF]`, 'info-message');
            }
        } else {
            apiText = `(Прикреплен неподдерживаемый файл: "${escapeHtml(fileName)}" Тип: ${escapeHtml(currentFile.type)})\n\n${apiText}`.trim();
            displayLine(`⚠️ Неподдерживаемый тип файла (${escapeHtml(currentFile.type)})`, 'user-command warning-message');
        }
    }

    // --- Validation ---
    if (!apiText.trim() && !(currentFile && isImg)) {
        if (currentFile) { displayLine("[Отменено: Введите текст или прикрепите изображение]", 'info-message'); }
        resetFileInputState();
        if (isProcessing) setProcessing(false);
        return;
    }

    // --- Display User Message ---
    let displayCommand = userCommandText || (fileName ? '' : '[Пустое сообщение]');
    displayLine(displayCommand, 'user-command', isImg ? fileDataUrl : null, fileName);

    // --- Update History ---
    chatHistory.push({ role: 'user', content: apiText.trim() });
    if (isImg && fileDataUrl) {
        chatHistory[chatHistory.length - 1].imageDataUrl = fileDataUrl;
        chatHistory[chatHistory.length - 1].imageFileName = fileName;
    }

    // --- Reset UI (Input cleared, file reset) ---
    if (terminalInput) terminalInput.textContent = '';
    resetFileInputState();
    if (!isProcessing) setProcessing(true);

    // --- API Call Logic ---
    // Формируем URL и тело запроса для Vercel прокси
    const apiUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${API_MODEL}:generateContent`;
    let requestBody;
    try {
        const messagesForGemini = chatHistory.map((msg) => {
            const parts = [];
            if (msg.content?.trim()) { parts.push({ text: msg.content.trim() }); }
            if (msg.role === 'user' && msg.imageDataUrl && msg.imageFileName) {
                const mimeMatch = msg.imageDataUrl.match(/^data:(image\/[a-z]+);base64,/);
                const base64Data = msg.imageDataUrl.split(',')[1];
                if (mimeMatch && base64Data) { parts.push({ inline_data: { mime_type: mimeMatch[1], data: base64Data } }); }
                else { parts.push({ text: `[Ошибка: Не удалось добавить изображение ${escapeHtml(msg.imageFileName)}]` }); }
            }
            if (parts.length > 0) { return { role: msg.role === 'assistant' ? 'model' : 'user', parts: parts }; }
            return null;
        }).filter(Boolean);
        
        // Удаляем ключ 'model_name', так как модель теперь указывается в URL
        requestBody = { contents: messagesForGemini };

    } catch (buildError) {
        displayLine(`❌ Ошибка подготовки запроса: ${escapeHtml(buildError.message)}`, 'error-message');
        setProcessing(false); chatHistory.pop(); return;
    }

    // --- Fetch and Handle Response ---
    let botReply = null;
    let errorMsg = null;
    try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            errorMsg = `❌ Ошибка ${response.status}${errorData?.error?.message ? ': ' + escapeHtml(errorData.error.message) : ''}`;
        } else {
            const data = await response.json();
            if (data.error) { errorMsg = `❌ Ошибка API: ${escapeHtml(data.error.message || 'Неизвестно')}`; }
            else if (data.candidates?.[0]?.content?.parts?.[0]?.text) { botReply = data.candidates[0].content.parts.map(part => part.text || '').join(''); }
            else if (data.candidates?.[0]?.finishReason === 'SAFETY') { botReply = `[Ответ заблокирован. Причина: SAFETY]`; }
            else if (data.candidates?.[0]?.finishReason === 'MAX_TOKENS') { botReply = (data.candidates[0].content.parts.map(part => part.text || '').join('') || '') + "\n\n[Ответ усечен]"; }
            else { errorMsg = '⚠️ Неожиданный ответ от API.'; console.error("Unexpected API response:", data); }
        }
    } catch (netErr) { errorMsg = `❌ Сетевая ошибка: ${escapeHtml(netErr.message)}`; }

    // --- Update History with Bot Reply ---
    if (botReply !== null) { chatHistory.push({ role: 'assistant', content: botReply }); }
    else if (errorMsg) { chatHistory.pop(); }

    // --- Display Result ---
    if (botReply !== null) { displayLine(botReply, 'bot-response'); }
    if (errorMsg) { displayLine(errorMsg, errorMsg.startsWith('⚠️') ? 'warning-message' : 'error-message'); }

    // --- Final State ---
    setProcessing(false);
    scrollToBottom();
    setTimeout(() => terminalInput?.focus(), 50);
}

  function setupEventListeners() {
            if (terminalInput) {
                terminalInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        processInput();
                    }
                });
                terminalInput.addEventListener('paste', handlePaste);
            }

            if (fileInput) {
                 fileInput.addEventListener('change', handleFileSelection);
            }

            if (sendButton) {
                // Single click to send message
                sendButton.addEventListener('click', processInput);

                // Double click to simulate Insert key (open file dialog)
                sendButton.addEventListener('dblclick', () => {
                    // Check if not processing and file input exists
                    if (!isProcessing && fileInput) {
                        // Programmatically click the hidden file input
                        fileInput.click();
                    }
                });
            }

            if (promptElement) {
                // Single click for theme toggle (no double click here anymore)
                promptElement.addEventListener('click', () => {
                    if (!isProcessing) {
                        toggleTheme();
                    }
                });
            }

            document.addEventListener('keydown', handleGlobalHotkey);
        }

        function handleFileSelection(event) {
             if(event.target.files?.[0]){
                 const file=event.target.files[0];
                 const types=['image/jpeg','image/png','image/gif','image/webp','application/pdf'];
                 const maxSize=MAX_FILE_SIZE_MB*1024*1024;
                 if(!types.includes(file.type)){
                     displayLine(`⚠️ Неподдерживаемый тип файла: ${escapeHtml(file.type)}. Доступны: JPG, PNG, GIF, WebP, PDF.`, 'warning-message');
                     resetFileInputState(); return;
                 }
                 if(file.size > maxSize){
                     displayLine(`⚠️ Файл ${escapeHtml(file.name)} (${(file.size/1024/1024).toFixed(1)} MB) > ${MAX_FILE_SIZE_MB}МБ`, 'warning-message');
                     resetFileInputState(); return;
                 }
                 uploadedFile = file;
                 displayLine(`[Прикреплен: ${escapeHtml(uploadedFile.name)} (${(uploadedFile.size/1024/1024).toFixed(1)} MB)]`, 'info-message'); // Shortened
                 if(terminalInput && !isProcessing) {
                     terminalInput.dataset.placeholder = `Файл: ${uploadedFile.name}`;
                     terminalInput.focus(); // Focus when file selected
                 }
             } else {
                 resetFileInputState();
             }
        }

        async function handlePaste(event) {
            if (isProcessing) return;
            const items = (event.clipboardData || window.clipboardData)?.items;
            if (!items) return;
            let imgFile = null;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                     const blob = item.getAsFile();
                     if (blob) {
                        let ext = blob.type.split('/')[1] || 'png';
                        if (ext === 'jpeg') ext = 'jpg';
                        const namePart = `pasted-${Date.now()}`;
                         const maxSize = MAX_FILE_SIZE_MB * 1024 * 1024;
                         if (blob.size > maxSize) {
                             displayLine(`⚠️ Вставленное изображение > ${MAX_FILE_SIZE_MB}МБ`, 'warning-message');
                             event.preventDefault(); return;
                         }
                         imgFile = new File([blob], `${namePart}.${ext}`, { type: blob.type });
                         break;
                     }
                 }
            }
             if (imgFile) {
                 event.preventDefault();
                 uploadedFile = imgFile;
                 displayLine(`[Прикреплено из буфера: ${escapeHtml(uploadedFile.name)}]`, 'info-message'); // Shortened
                 if (terminalInput && !isProcessing) {
                     terminalInput.dataset.placeholder = `Файл: ${uploadedFile.name}`;
                     terminalInput.focus(); // Focus when image pasted
                 }
             }
        }

        function handleGlobalHotkey(event) {
            if (event.key === 'Escape' && document.activeElement === terminalInput) {
                 event.preventDefault(); terminalInput.blur();
            }
            else if (event.key === 'Insert' && !isProcessing) {
                event.preventDefault(); if (fileInput) { fileInput.click(); }
            }
            else if (event.ctrlKey && (event.key === 'l' || event.key === 'L')) {
                 event.preventDefault(); if (terminalOutput) terminalOutput.innerHTML = '';
                 displayLine('[Экран очищен]', 'info-message'); if (terminalInput) terminalInput.focus();
            }
        }

     function applyTheme(themeIndex) {
             const theme = themes[themeIndex];
             // Убираем все классы тем перед добавлением нового
             themes.forEach(t => { if (t.className) { document.body.classList.remove(t.className); } });
             if (theme.className) { document.body.classList.add(theme.className); }

             // Если новая тема НЕ matrix, гарантированно останавливаем анимацию
             if (theme.name !== 'matrix') {
                 stopMatrixBackground();
             } else {
                 // Если новая тема = matrix, проверяем текущее состояние обработки
                 // Если сейчас идет обработка, запускаем анимацию.
                 // Иначе, ничего не делаем (setProcessing(true) запустит ее позже, если нужно)
                 if (isProcessing) {
                     startMatrixBackground();
                 } else {
                    // Можно добавить stopMatrixBackground() здесь для надежности,
                    // на случай если переключились на matrix когда не было processing
                    stopMatrixBackground();
                 }
             }

             // Обновляем стиль подсветки кода
             const hljsHref = getComputedStyle(document.body).getPropertyValue('--hljs-style-href').trim().replace(/['"]/g, '');
             if (hljsThemeLink && hljsHref && hljsThemeLink.href !== hljsHref) {
                 hljsThemeLink.href = hljsHref;
                 document.querySelectorAll('.code-block pre code').forEach(block => {
                    try {
                         // ... (код пере-подсветки) ...
                         hljs.highlightElement(block);
                    } catch (e) { console.warn("Re-highlighting failed:", e, block); }
                 });
             }

             // Обновляем title и сохраняем тему
             if (promptElement) { promptElement.title = `Тема: ${theme.displayName}. Нажмите для смены.`; }
             localStorage.setItem('terminalThemeIndex', themeIndex.toString());
             currentThemeIndex = themeIndex; // Обновляем индекс текущей темы
        }

        function toggleTheme() {
             const nextThemeIndex = (currentThemeIndex + 1) % themes.length;
             applyTheme(nextThemeIndex);
        }

        function setupMatrixBackground() {
            if (!matrixCanvas) return null;
            const ctx = matrixCanvas.getContext('2d');
            if (!ctx) return null;
            let width, height, columns, drops = [], chars = "アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

            function drawMatrix() {
                if (!document.body.classList.contains('matrix-theme')) return;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-color') || '#0F0'; ctx.font = '15pt monospace';
                for (let i = 0; i < drops.length; i++) {
                    const text = chars[Math.floor(Math.random() * chars.length)]; ctx.fillText(text, i * 20, drops[i] * 20);
                    if (drops[i] * 20 > height && Math.random() > 0.975) { drops[i] = 0; } drops[i]++;
                }
            }

            const start = () => {
                 if (matrixIntervalId) clearInterval(matrixIntervalId);
                 width = matrixCanvas.width = window.innerWidth; height = matrixCanvas.height = window.innerHeight; columns = Math.floor(width / 20);
                 drops.length = 0; for (let x = 0; x < columns; x++) drops[x] = 1 + Math.floor(Math.random() * (height / 20));
                 matrixIntervalId = setInterval(drawMatrix, 40); matrixCanvas.style.display = 'block'; console.log("Matrix Started");
            };
            const stop = () => { if (matrixIntervalId) { clearInterval(matrixIntervalId); matrixIntervalId = null; matrixCanvas.style.display = 'none'; console.log("Matrix Stopped"); } };

             let resizeTimeout;
             window.addEventListener('resize', () => { if (document.body.classList.contains('matrix-theme')) { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(start, 250); } });
            return { start, stop };
        }

        let matrixController = null;
        function startMatrixBackground() { if (matrixController) matrixController.start(); }
        function stopMatrixBackground() { if (matrixController) matrixController.stop(); }

         window.onload = () => {
            if (typeof hljs === 'undefined') console.warn("Highlight.js not loaded."); else hljs.configure({ ignoreUnescapedHTML: true });
            if (typeof pdfjsLib === 'undefined') console.warn("PDF.js library not loaded.");
            if(promptElement) promptElement.textContent = PROMPT_TEXT;
            matrixController = setupMatrixBackground();
            const savedThemeIndex = parseInt(localStorage.getItem('terminalThemeIndex') || '0', 10);
            currentThemeIndex = (savedThemeIndex >= 0 && savedThemeIndex < themes.length) ? savedThemeIndex : 0;
            applyTheme(currentThemeIndex);
            setProcessing(false); resetFileInputState(); setupEventListeners(); scrollToBottom();
            if (terminalInput && document.activeElement !== terminalInput) { setTimeout(() => terminalInput.focus(), 50); }
         };
   </script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>" type="image/svg+xml" id="favicon">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --base-font-size: 15px;
    --bg-color: #f0f2f5;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --message-user-solid: #667eea;
    --message-bot-bg: #ffffff;
    --message-bot-border: #e4e6eb;
    --message-user-color: #ffffff;
    --message-bot-color: #1c1e21;
    --input-bg: #ffffff;
    --input-border: #dddfe2;
    --input-text: #1c1e21;
    --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --button-solid: #667eea;
    --button-hover: #5a6fd6;
    --button-color: white;
    --accent: #667eea;
    --accent-secondary: #764ba2;
    --shadow: rgba(0, 0, 0, 0.08);
    --shadow-md: rgba(0, 0, 0, 0.12);
    --border: #e4e6eb;
    --header-color: #1c1e21;
    --time-color: #65676b;
    --typing-bg: #e4e6eb;
    --typing-dot: #65676b;
    --code-bg: #f6f8fa;
    --code-header: #f0f2f5;
    --code-border: #e4e6eb;
    --scrollbar-thumb: #bcc0c4;
    --modal-bg: #ffffff;
    --modal-border: #e4e6eb;
    --chip-bg: #e4e6eb;
    --chip-color: #1c1e21;
    --selection-bg: #667eea;
    --selection-color: #ffffff;
    --hover-bg: #f0f2f5;
    --selected-bg: #e7e9ff;
    --selected-border: #667eea;
    --notify-bg: #667eea;
     --gemini-color: #4285f4;
    --gemini-secondary: #00bcd4;
    --mistral-color: #ff7000;
    --table-header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --table-row-alt: #f8f9fa;
    --table-hover: #e7e9ff;
}

body.dark-theme {
    --bg-color: #0a0a0f;
    --container-bg: #12121a;
    --message-user-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --message-user-solid: #6366f1;
    --message-bot-bg: #1e1e2e;
    --message-bot-border: #2a2a3e;
    --message-user-color: #ffffff;
    --message-bot-color: #e4e4e7;
    --input-bg: #1e1e2e;
    --input-border: #2a2a3e;
    --input-text: #e4e4e7;
    --button-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --button-solid: #6366f1;
    --button-hover: #5558e3;
    --button-color: white;
    --accent: #818cf8;
    --accent-secondary: #a78bfa;
    --shadow: rgba(0, 0, 0, 0.3);
    --shadow-md: rgba(0, 0, 0, 0.4);
    --border: #2a2a3e;
    --header-color: #e4e4e7;
    --time-color: #71717a;
    --typing-bg: #2a2a3e;
    --typing-dot: #818cf8;
    --code-bg: #1e1e2e;
    --code-header: #2a2a3e;
    --code-border: #3a3a4e;
    --scrollbar-thumb: #3a3a4e;
    --modal-bg: #1e1e2e;
    --modal-border: #2a2a3e;
    --chip-bg: #2a2a3e;
    --chip-color: #e4e4e7;
    --selection-bg: #818cf8;
    --selection-color: #0a0a0f;
    --hover-bg: #2a2a3e;
    --selected-bg: #3a3a5e;
    --selected-border: #818cf8;
    --notify-bg: #6366f1;
  -gemini-color: #60a5fa;
    --gemini-secondary: #22d3ee;
    --mistral-color: #fb923c;
    --table-header-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --table-row-alt: #1a1a2a;
    --table-hover: #2a2a4e;
}

body.powershell-theme {
    --bg-color: #012456;
    --container-bg: #012456;
    --message-user-bg: linear-gradient(135deg, #1e3a5f 0%, #2a4a7a 100%);
    --message-user-solid: #1e3a5f;
    --message-bot-bg: #01326e;
    --message-bot-border: #3a6ea5;
    --message-user-color: #eeedf0;
    --message-bot-color: #cccccc;
    --input-bg: #01326e;
    --input-border: #3a6ea5;
    --input-text: #eeedf0;
    --button-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --button-solid: #4169e1;
    --button-hover: #5a7be8;
    --button-color: #ffffff;
    --accent: #ffff00;
    --accent-secondary: #00ffff;
    --shadow: rgba(0, 0, 0, 0.4);
    --shadow-md: rgba(0, 0, 0, 0.5);
    --border: #3a6ea5;
    --header-color: #eeedf0;
    --time-color: #ffff00;
    --typing-bg: #01326e;
    --typing-dot: #ffff00;
    --code-bg: #01326e;
    --code-header: #1e3a5f;
    --code-border: #3a6ea5;
    --scrollbar-thumb: #3a6ea5;
    --modal-bg: #012456;
    --modal-border: #3a6ea5;
    --chip-bg: #1e3a5f;
    --chip-color: #eeedf0;
    --selection-bg: #ffff00;
    --selection-color: #012456;
    --hover-bg: #1e3a5f;
    --selected-bg: #2a4a7a;
    --selected-border: #ffff00;
    --notify-bg: #4169e1;
    --gemini-color: #87ceeb;
    --gemini-secondary: #dda0dd;
    --mistral-color: #ffd700;
    --table-header-bg: linear-gradient(135deg, #4169e1 0%, #5a7be8 100%);
    --table-row-alt: #01326e;
    --table-hover: #1e3a5f;
}

body.imessage-theme {
    --bg-color: #ffffff;
    --container-bg: #ffffff;
    --message-user-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --message-user-solid: #007aff;
    --message-bot-bg: #e9e9eb;
    --message-bot-border: transparent;
    --message-user-color: #ffffff;
    --message-bot-color: #000000;
    --input-bg: #f2f2f7;
    --input-border: #c7c7cc;
    --input-text: #000000;
    --button-bg: linear-gradient(135deg, #007aff 0%, #0063cc 100%);
    --button-solid: #007aff;
    --button-hover: #0056b3;
    --button-color: #ffffff;
    --accent: #007aff;
    --accent-secondary: #5856d6;
    --shadow: rgba(0, 0, 0, 0.04);
    --shadow-md: rgba(0, 0, 0, 0.08);
    --border: #c7c7cc;
    --header-color: #000000;
    --time-color: #8e8e93;
    --typing-bg: #e9e9eb;
    --typing-dot: #8e8e93;
    --code-bg: #f2f2f7;
    --code-header: #e5e5ea;
    --code-border: #c7c7cc;
    --scrollbar-thumb: #c7c7cc;
    --modal-bg: #ffffff;
    --modal-border: #c7c7cc;
    --chip-bg: #e5e5ea;
    --chip-color: #000000;
    --selection-bg: #007aff;
    --selection-color: #ffffff;
    --hover-bg: #f2f2f7;
    --selected-bg: #e5f3ff;
    --selected-border: #007aff;
    --notify-bg: #007aff;
    --gemini-color: #007aff;
    --gemini-secondary: #5856d6;
    --mistral-color: #ff9500;
    --table-header-bg: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
    --table-row-alt: #f2f2f7;
    --table-hover: #e5f3ff;
}

body.nord-theme {
    --bg-color: #2e3440;
    --container-bg: #3b4252;
    --message-user-bg: linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%);
    --message-user-solid: #5e81ac;
    --message-bot-bg: #434c5e;
    --message-bot-border: #4c566a;
    --message-user-color: #eceff4;
    --message-bot-color: #eceff4;
    --input-bg: #434c5e;
    --input-border: #4c566a;
    --input-text: #eceff4;
    --button-bg: linear-gradient(135deg, #88c0d0 0%, #8fbcbb 100%);
    --button-solid: #88c0d0;
    --button-hover: #81a1c1;
    --button-color: #2e3440;
    --accent: #88c0d0;
    --accent-secondary: #81a1c1;
    --shadow: rgba(0, 0, 0, 0.2);
    --shadow-md: rgba(0, 0, 0, 0.3);
    --border: #4c566a;
    --header-color: #eceff4;
    --time-color: #d8dee9;
    --typing-bg: #434c5e;
    --typing-dot: #88c0d0;
    --code-bg: #3b4252;
    --code-header: #434c5e;
    --code-border: #4c566a;
    --scrollbar-thumb: #4c566a;
    --modal-bg: #3b4252;
    --modal-border: #4c566a;
    --chip-bg: #434c5e;
    --chip-color: #eceff4;
    --selection-bg: #88c0d0;
    --selection-color: #2e3440;
    --hover-bg: #434c5e;
    --selected-bg: #4c566a;
    --selected-border: #88c0d0;
    --notify-bg: #5e81ac;
    --gemini-color: #88c0d0;
    --gemini-secondary: #b48ead;
    --mistral-color: #ebcb8b;
    --table-header-bg: linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%);
    --table-row-alt: #3b4252;
    --table-hover: #4c566a;
}

html, body {
    height: 100%;
    width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-color);
    color: var(--message-bot-color);
    transition: all 0.3s ease;
}

::selection { background: var(--selection-bg); color: var(--selection-color); }

.container {
    height: 100%;
    display: flex;
    flex-direction: column;
    max-width: 100%;
    margin: 0 auto;
    background: var(--container-bg);
    transition: all 0.3s ease;
}

/* HEADER */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    background: var(--container-bg);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    gap: 12px;
    flex-shrink: 0;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

/* Header Logo */
.header-logo {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
    position: relative;
    overflow: visible;
}

.header-logo.gemini {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.15) 0%, rgba(66, 133, 244, 0.15) 50%, rgba(63, 81, 181, 0.15) 100%);
    border: 1px solid rgba(66, 133, 244, 0.3);
    box-shadow: 0 0 12px rgba(66, 133, 244, 0.2);
}
.header-logo.mistral {
    background: linear-gradient(135deg, rgba(255, 112, 0, 0.12) 0%, rgba(255, 152, 0, 0.12) 100%);
    border: 1px solid rgba(255, 112, 0, 0.25);
}

.header-logo.other {
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.12) 0%, rgba(156, 163, 175, 0.12) 100%);
    border: 1px solid rgba(107, 114, 128, 0.25);
}

.header-logo:hover { transform: scale(1.05); }


/* Gemini Star */
.gemini-star {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.gemini-star svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 0 4px rgba(66, 133, 244, 0.5));
}

.msg-avatar .gemini-star {
    width: 20px;
    height: 20px;
}

body.dark-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.18) 0%, rgba(66, 133, 244, 0.18) 50%, rgba(63, 81, 181, 0.18) 100%);
    border: 1px solid rgba(96, 165, 250, 0.35);
    box-shadow: 0 0 12px rgba(96, 165, 250, 0.25);
}

body.powershell-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.2) 0%, rgba(66, 133, 244, 0.2) 100%);
    border: 1px solid rgba(66, 133, 244, 0.4);
}

body.imessage-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(66, 133, 244, 0.1) 100%);
    border: 1px solid rgba(66, 133, 244, 0.2);
}

body.nord-theme .msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(136, 192, 208, 0.15) 0%, rgba(94, 129, 172, 0.15) 100%);
    border: 1px solid rgba(136, 192, 208, 0.3);
}


.header-logo .gemini-star {
    width: 22px;
    height: 22px;
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.header-logo.loading .gemini-star svg {
    animation: starRotateGlow 2s ease-in-out infinite;
}

@keyframes starRotateGlow {
    0% { 
        transform: rotate(0deg) scale(1);
        filter: drop-shadow(0 0 4px rgba(0, 188, 212, 0.6));
    }
    25% {
        transform: rotate(90deg) scale(1.15);
        filter: drop-shadow(0 0 12px rgba(66, 133, 244, 0.8));
    }
    50% { 
        transform: rotate(180deg) scale(1);
        filter: drop-shadow(0 0 8px rgba(63, 81, 181, 0.7));
    }
    75% {
        transform: rotate(270deg) scale(1.15);
        filter: drop-shadow(0 0 12px rgba(0, 188, 212, 0.8));
    }
    100% { 
        transform: rotate(360deg) scale(1);
        filter: drop-shadow(0 0 4px rgba(0, 188, 212, 0.6));
    }
}

/* Mistral Icon */
.mistral-icon {
    width: 20px;
    height: 20px;
}

.mistral-icon svg {
    width: 100%;
    height: 100%;
    fill: white;
    filter: drop-shadow(0 1px 2px rgba(255, 112, 0, 0.4));
}

/* Other Icon */
.other-icon {
    width: 20px;
    height: 20px;
}

.other-icon svg {
    width: 100%;
    height: 100%;
    fill: white;
}

.header-info { display: flex; flex-direction: column; min-width: 0; }
.header-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--header-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.header-subtitle {
    font-size: 11px;
    color: var(--time-color);
    white-space: nowrap;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.h-btn {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    background: transparent;
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: var(--accent);
}

.h-btn:hover { background: var(--hover-bg); }
.h-btn.active { background: var(--selected-bg); border-color: var(--accent); }
.h-btn svg { width: 18px; height: 18px; fill: currentColor; }

/* Selector */
.selector { position: relative; }

.sel-btn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--container-bg);
    cursor: pointer;
    font-size: 12px;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    max-width: 160px;
    white-space: nowrap;
    overflow: hidden;
}

.sel-btn:hover { background: var(--hover-bg); border-color: var(--accent); }
.sel-btn::after {
    content: '';
    width: 5px;
    height: 5px;
    border-right: 1.5px solid currentColor;
    border-bottom: 1.5px solid currentColor;
    transform: rotate(45deg);
    margin-left: auto;
    flex-shrink: 0;
    opacity: 0.6;
}

.sel-opts {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: var(--container-bg);
    border-radius: 10px;
    box-shadow: 0 4px 20px var(--shadow-md);
    padding: 6px 0;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
    border: 1px solid var(--border);
    min-width: 200px;
    max-height: 350px;
    overflow-y: auto;
}

.sel-opts.show { opacity: 1; visibility: visible; transform: translateY(0); }

.sel-opt {
    padding: 8px 14px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.sel-opt:hover { background: var(--hover-bg); }
.sel-opt.selected { background: var(--selected-bg); color: var(--accent); font-weight: 500; }

/* CHAT */
#chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-color);
    scroll-behavior: smooth;
}

#chat-container::-webkit-scrollbar { width: 6px; }
#chat-container::-webkit-scrollbar-track { background: transparent; }
#chat-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

/* Messages */
.message {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    animation: msgSlide 0.3s ease;
    max-width: 88%;
}

@keyframes msgSlide {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user { margin-left: auto; flex-direction: row-reverse; }
.message.bot { margin-right: auto; }

/* Message Avatar */
.msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    position: relative;
}

.msg-avatar.user-avatar { 
    background: var(--message-user-solid); 
}

.msg-avatar.gemini {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.12) 0%, rgba(66, 133, 244, 0.12) 50%, rgba(63, 81, 181, 0.12) 100%);
    border: 1px solid rgba(66, 133, 244, 0.25);
    box-shadow: 0 0 10px rgba(66, 133, 244, 0.15);
}
.msg-avatar.mistral {
    background: linear-gradient(135deg, var(--mistral-color) 0%, #ff9800 100%);
}

.msg-avatar.other {
    background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
}

.msg-avatar .gemini-star {
    width: 16px;
    height: 16px;
}

.msg-avatar svg { width: 14px; height: 14px; fill: white; }

/* Avatar loading animation */
.msg-avatar.thinking {
    animation: avatarPulse 1.5s ease-in-out infinite;
}

.msg-avatar.thinking .gemini-star {
    animation: miniStarSpin 2s linear infinite;
}

@keyframes avatarPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(66, 133, 244, 0); }
}

@keyframes miniStarSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.msg-bubble { display: flex; flex-direction: column; max-width: 100%; min-width: 0; }

.msg-content {
    padding: 10px 14px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: var(--base-font-size);
    word-wrap: break-word;
    position: relative;
}

.user .msg-content {
    background: var(--message-user-bg);
    color: var(--message-user-color);
    border-bottom-right-radius: 4px;
}

.bot .msg-content {
    background: var(--message-bot-bg);
    color: var(--message-bot-color);
    border: 1px solid var(--message-bot-border);
    border-bottom-left-radius: 4px;
}

.msg-time {
    font-size: 10px;
    color: var(--time-color);
    margin-top: 4px;
    padding: 0 4px;
}

.user .msg-time { text-align: right; }

.msg-image {
    max-width: 280px;
    border-radius: 10px;
    margin-bottom: 6px;
    cursor: pointer;
}

/* Typing */
.typing {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    animation: msgSlide 0.3s ease;
}

.typing-bubble {
    background: var(--typing-bg);
    padding: 14px 18px;
    border-radius: 16px;
    border-bottom-left-radius: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.typing-dot {
    width: 7px;
    height: 7px;
    background: var(--typing-dot);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1.2); opacity: 1; }
}

/* File Preview */
#file-preview {
    display: none;
    padding: 10px 16px;
    background: var(--container-bg);
    border-top: 1px solid var(--border);
}

#file-preview.visible { display: block; }

.file-chip {
    display: inline-flex;
    align-items: center;
    background: var(--chip-bg);
    color: var(--chip-color);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    gap: 8px;
}

.file-chip svg { width: 16px; height: 16px; fill: var(--accent); }
.file-chip img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; }

.file-chip-remove {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--hover-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.file-chip-remove:hover { background: var(--border); }
.file-chip-remove svg { width: 10px; height: 10px; fill: var(--message-bot-color); }

/* Input */
#input-container {
    display: flex;
    padding: 8px 12px 12px;
    background: var(--container-bg);
    align-items: flex-end;
    gap: 8px;
    border-top: 1px solid var(--border);
}

#message-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--input-border);
    border-radius: 20px;
    font-size: var(--base-font-size);
    background: var(--input-bg);
    color: var(--input-text);
    resize: none;
    min-height: 42px;
    max-height: 120px;
    font-family: inherit;
    line-height: 1.4;
    transition: border-color 0.2s ease;
}

#message-input:focus {
    outline: none;
    border-color: var(--accent);
}

#message-input::placeholder { color: var(--time-color); }

.in-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

#upload-btn {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--border);
}

#upload-btn:hover { background: var(--hover-bg); }
#upload-btn.has-file { background: var(--selected-bg); border-color: var(--accent); }
#upload-btn svg { width: 20px; height: 20px; fill: currentColor; }

#send-btn {
    background: var(--button-bg);
    color: var(--button-color);
}

#send-btn:hover:not(:disabled) { transform: scale(1.05); }
#send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
#send-btn svg { width: 20px; height: 20px; fill: currentColor; }

/* Tables in messages */
.msg-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 12px 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px var(--shadow);
}

.msg-content thead { background: var(--table-header-bg); }

.msg-content th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: white;
    font-size: 12px;
}

.msg-content td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
}

.msg-content tbody tr:last-child td { border-bottom: none; }
.msg-content tbody tr:nth-child(even) { background: var(--table-row-alt); }
.msg-content tbody tr:hover { background: var(--table-hover); }

/* Code */
.msg-content pre {
    background: var(--code-bg);
    border: 1px solid var(--code-border);
    border-radius: 10px;
    margin: 10px 0;
    overflow: hidden;
}

.code-header {
    background: var(--code-header);
    padding: 6px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--time-color);
    border-bottom: 1px solid var(--code-border);
}

.code-lang { font-weight: 500; color: var(--accent); }

.code-copy {
    background: var(--container-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 10px;
    cursor: pointer;
    color: var(--message-bot-color);
    transition: all 0.2s ease;
}

.code-copy:hover { border-color: var(--accent); color: var(--accent); }

.msg-content pre code {
    display: block;
    padding: 12px;
    overflow-x: auto;
    font-family: 'SF Mono', Consolas, monospace;
    font-size: calc(var(--base-font-size) * 0.85);
    line-height: 1.5;
}

.msg-content code:not(pre code) {
    background: var(--hover-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', Consolas, monospace;
    font-size: 0.9em;
}

/* Notification */
.notify {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--notify-bg);
    color: white;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 13px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s ease;
}

.notify.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.notify.error { background: #ef4444; }

/* Modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
    padding: 16px;
}

.modal-box {
    background: var(--modal-bg);
    border-radius: 14px;
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--modal-border);
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
}

.modal-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--header-color);
}

.modal-close {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    background: var(--hover-bg);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--message-bot-color);
}

.modal-close:hover { background: var(--border); }
.modal-close svg { width: 14px; height: 14px; fill: currentColor; }

.modal-body {
    padding: 18px;
    overflow-y: auto;
    flex: 1;
}

/* Settings Modal */
.set-group { margin-bottom: 18px; }
.set-group:last-child { margin-bottom: 0; }

.set-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--time-color);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.set-select, .set-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    color: var(--input-text);
    font-size: 13px;
    font-family: inherit;
}

.set-select:focus, .set-input:focus {
    outline: none;
    border-color: var(--accent);
}

.api-modes { display: flex; flex-direction: column; gap: 8px; }

.api-mode {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.api-mode:hover { border-color: var(--accent); background: var(--hover-bg); }
.api-mode.selected { border-color: var(--accent); background: var(--selected-bg); }
.api-mode svg { width: 16px; height: 16px; fill: var(--accent); flex-shrink: 0; }
.api-mode span { font-size: 13px; color: var(--message-bot-color); }

.set-row { display: flex; gap: 8px; }

.set-row .h-btn {
    flex: 1;
    width: auto;
    height: 38px;
    font-size: 12px;
    gap: 6px;
}

.set-row .h-btn span { display: block; }

.set-btn {
    width: 100%;
    padding: 12px;
    background: var(--button-bg);
    color: var(--button-color);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 18px;
}

.set-btn:hover { opacity: 0.9; }

.set-link {
    display: block;
    margin-top: 8px;
    font-size: 11px;
    color: var(--accent);
    text-decoration: none;
}

.set-link:hover { text-decoration: underline; }

/* Table Modal */
.table-modal .modal-box {
    max-width: 95vw;
    width: 95vw;
    height: 90vh;
    max-height: 90vh;
}

.table-modal .modal-head { flex-shrink: 0; }
.table-modal .modal-body { padding: 0; overflow: auto; }

.table-actions {
    display: flex;
    gap: 8px;
}

.table-actions button {
    padding: 6px 12px;
    background: var(--hover-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    color: var(--message-bot-color);
    display: flex;
    align-items: center;
    gap: 4px;
}

.table-actions button:hover { border-color: var(--accent); color: var(--accent); }
.table-actions button svg { width: 14px; height: 14px; fill: currentColor; }

#table-content { padding: 20px; min-height: 100%; }

#table-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px var(--shadow);
}

#table-content thead { background: var(--table-header-bg); }

#table-content th {
    padding: 14px 18px;
    text-align: left;
    font-weight: 600;
    color: white;
    font-size: 13px;
    white-space: nowrap;
}

#table-content td {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--message-bot-color);
}

#table-content tbody tr:last-child td { border-bottom: none; }
#table-content tbody tr:nth-child(even) { background: var(--table-row-alt); }
#table-content tbody tr:hover { background: var(--table-hover); }

/* Empty State */
.empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--time-color);
    text-align: center;
    padding: 40px;
}

.empty-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: var(--hover-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
}

.empty-icon svg { width: 32px; height: 32px; fill: var(--accent); }
.empty-title { font-size: 18px; font-weight: 600; color: var(--header-color); margin-bottom: 6px; }
.empty-text { font-size: 13px; max-width: 280px; }

/* Theme Icons */
.theme-icon { display: none; }
.theme-icon.active { display: block; }

/* Responsive */
@media (max-width: 600px) {
    .header { padding: 8px 12px; }
    .header-controls .selector { display: none; }
    #chat-container { padding: 12px; }
    #input-container { padding: 6px 10px 10px; }
    .message { max-width: 94%; }
    .in-btn { width: 38px; height: 38px; }
    #message-input { min-height: 38px; padding: 8px 12px; }
}
</style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-left" id="header-left">
           <div class="header-logo gemini" id="header-logo">
    <div class="gemini-star">
        <svg viewBox="0 0 28 28">
            <defs>
                <linearGradient id="gemini-grad-header" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#00bcd4"/>
                    <stop offset="50%" stop-color="#4285f4"/>
                    <stop offset="100%" stop-color="#3f51b5"/>
                </linearGradient>
                <filter id="glow-header" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="1" result="blur"/>
                    <feFlood flood-color="#4285f4" flood-opacity="0.5"/>
                    <feComposite in2="blur" operator="in"/>
                    <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <path filter="url(#glow-header)" fill="url(#gemini-grad-header)" stroke="rgba(255,255,255,0.4)" stroke-width="0.5" d="M14 0C14 7.732 7.732 14 0 14C7.732 14 14 20.268 14 28C14 20.268 20.268 14 28 14C20.268 14 14 7.732 14 0Z"/>
        </svg>
    </div>
</div>
            <div class="header-info">
                <div class="header-title" id="header-title">Gemini 3 Flash</div>
                <div class="header-subtitle" id="header-subtitle">–ù–æ–≤—ã–π —á–∞—Ç</div>
            </div>
        </div>
        <div class="header-controls">
            <div class="selector" id="model-selector">
                <button class="sel-btn" id="model-btn"><span id="model-name">Gemini 3 Flash</span></button>
                <ul class="sel-opts" id="model-opts"></ul>
            </div>
            
            <button class="h-btn" id="table-btn" title="–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v2H7V7zm0 4h2v2H7v-2zm0 4h2v2H7v-2zm4-8h6v2h-6V7zm0 4h6v2h-6v-2zm0 4h6v2h-6v-2z"/></svg>
            </button>
            
            <button class="h-btn" id="font-btn" title="–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞">
                <svg viewBox="0 0 24 24"><path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/></svg>
            </button>
            
            <button class="h-btn" id="theme-btn" title="–¢–µ–º–∞">
                <svg class="theme-icon active" id="t-light" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z"/></svg>
                <svg class="theme-icon" id="t-dark" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                <svg class="theme-icon" id="t-ps" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm-2-1h-6v-2h6v2zM7.5 17l-1.41-1.41L8.67 13l-2.58-2.59L7.5 9l4 4-4 4z"/></svg>
                <svg class="theme-icon" id="t-imsg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <svg class="theme-icon" id="t-nord" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
            </button>
            
            <button class="h-btn" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.44.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>
    </header>

    <div id="chat-container">
        <div class="empty" id="empty">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            </div>
            <div class="empty-title">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
            <div class="empty-text">–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª</div>
        </div>
    </div>

    <div id="file-preview"></div>

    <div id="input-container">
        <input type="file" id="file-input" accept="image/*,application/pdf" hidden>
        <button class="in-btn" id="upload-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">
            <svg viewBox="0 -960 960 960"><path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160Zm40 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
        </button>
        <textarea id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
        <button class="in-btn" id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <svg viewBox="0 -960 960 960"><path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"/></svg>
        </button>
    </div>
</div>

<div class="notify" id="notify"></div>

<!-- Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <button class="modal-close" id="close-settings">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="set-group">
                <label class="set-label">–ú–æ–¥–µ–ª—å</label>
                <select class="set-select" id="set-model"></select>
            </div>
            
            <div class="set-group">
                <label class="set-label">–†–µ–∂–∏–º API</label>
                <div class="api-modes" id="api-modes"></div>
            </div>
            
            <div class="set-group" id="api-key-group" style="display:none;">
                <label class="set-label">API –∫–ª—é—á</label>
                <input type="password" class="set-input" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á...">
                <a class="set-link" id="api-link" href="#" target="_blank">–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á ‚Üí</a>
            </div>
            
            <div class="set-group">
                <label class="set-label">–î–µ–π—Å—Ç–≤–∏—è</label>
                <div class="set-row">
                    <button class="h-btn" id="set-font">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/></svg>
                        <span>–®—Ä–∏—Ñ—Ç</span>
                    </button>
                    <button class="h-btn" id="set-theme">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                        <span>–¢–µ–º–∞</span>
                    </button>
                    <button class="h-btn" id="set-clear">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                    </button>
                </div>
            </div>
            
            <button class="set-btn" id="save-settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Table Modal -->
<div class="modal table-modal" id="table-modal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ</div>
            <div class="table-actions">
                <button id="table-copy">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button id="table-html">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    –°–∫–∞—á–∞—Ç—å HTML
                </button>
                <button id="table-newtab">
                    <svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                    –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞
                </button>
            </div>
            <button class="modal-close" id="close-table">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="table-content"></div>
        </div>
    </div>
</div>

<script>
// ===== CONFIG =====
const MODELS = [
    { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite", api: "gemini" },
    { id: "gemini-2.5-flash-lite-preview-09-25", name: "Gemini 2.5 Flash Lite Preview", api: "gemini" },
    { id: "gemini-3-flash-preview", name: "Gemini 3 Flash", api: "gemini" },
    { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", api: "gemini" },
    { id: "gemini-3-pro-preview", name: "Gemini 3 Pro Preview", api: "gemini" },
    { id: "nvidia/nemotron-3-nano-30b-a3b:free", name: "NVIDIA Nemotron 3 Nano", api: "openrouter" },
    { id: "gpt-oss-20b-free", name: "OpenAI GPT-OSS 20B", api: "openrouter" },
    { id: "mistral-large-2512", name: "Mistral Large", api: "mistral" },
    { id: "mistral-medium-2508", name: "Mistral Medium", api: "mistral" },
];

const API_MODES = {
    mapruapp: { name: '–ü—Ä–æ–∫—Å–∏ (MapRuApp)', icon: 'server' },
    vercel: { name: '–ü—Ä–æ–∫—Å–∏ (Vercel)', icon: 'cloud' },
    direct: { name: '–ü—Ä—è–º–æ–π (Gemini)', icon: 'key' },
    direct_mistral: { name: '–ü—Ä—è–º–æ–π (Mistral)', icon: 'bolt' }
};

const THEMES = ['light', 'dark', 'powershell', 'imessage', 'nord'];
const THEME_NAMES = { light: '–°–≤–µ—Ç–ª–∞—è', dark: '–¢—ë–º–Ω–∞—è', powershell: 'PowerShell', imessage: 'iMessage', nord: 'Nord' };
const FONTS = [14, 15, 16, 17, 18];

const PROXY_MAP = "https://mapruapp.ru/ai/api/v1/chat/completions";
const PROXY_VER = "https://ver-olive-delta.vercel.app";

const TABLE_PROMPT = `–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown —Ç–∞–±–ª–∏—Ü. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—ã. –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫. –ù–ï –ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≤–Ω–µ —Ç–∞–±–ª–∏—Ü. –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π.`;

// ===== STATE =====
let history = [];
let pendingFile = null;
let model = localStorage.getItem('model') || 'gemini-3-flash-preview';
let apiMode = localStorage.getItem('apiMode') || 'mapruapp';
let apiKey = localStorage.getItem('apiKey') || '';
let theme = localStorage.getItem('theme') || 'light';
let fontIdx = parseInt(localStorage.getItem('fontIdx')) || 1;
let tableMode = localStorage.getItem('tableMode') === 'true';
let isLoading = false;
let lastTableHtml = '';

// ===== ELEMENTS =====
const $ = id => document.getElementById(id);
const chat = $('chat-container');
const input = $('message-input');
const sendBtn = $('send-btn');
const uploadBtn = $('upload-btn');
const fileInput = $('file-input');
const filePreview = $('file-preview');
const notify = $('notify');
const empty = $('empty');
const headerTitle = $('header-title');
const headerSub = $('header-subtitle');
const headerLogo = $('header-logo');
const modelBtn = $('model-btn');
const modelOpts = $('model-opts');
const tableBtn = $('table-btn');
const settingsModal = $('settings-modal');
const tableModal = $('table-modal');

// ===== SVG TEMPLATES =====
const GEMINI_STAR = `
<div class="gemini-star">
    <svg viewBox="0 0 32 32" fill="none">
        <defs>
            <linearGradient id="gemini-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#00bcd4"/>
                <stop offset="50%" stop-color="#4285f4"/>
                <stop offset="100%" stop-color="#3f51b5"/>
            </linearGradient>
            <filter id="gemini-glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                <feFlood flood-color="#4285f4" flood-opacity="0.6"/>
                <feComposite in2="blur" operator="in"/>
                <feMerge>
                    <feMergeNode/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        <path filter="url(#gemini-glow)" fill="url(#gemini-grad)" stroke="rgba(255,255,255,0.5)" stroke-width="0.5" d="M16 0C16 8.837 8.837 16 0 16C8.837 16 16 23.163 16 32C16 23.163 23.163 16 32 16C23.163 16 16 8.837 16 0Z"/>
    </svg>
</div>`;

const MISTRAL_ICON = `
<div class="mistral-icon">
    <svg viewBox="0 0 24 24">
        <path d="M13 3L4 14h7l-2 7 9-11h-7l2-7z"/>
    </svg>
</div>`;

const OTHER_ICON = `
<div class="other-icon">
    <svg viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>
</div>`;

const ICONS = {
    server: `<svg viewBox="0 0 24 24"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>`,
    cloud: `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`,
    key: `<svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>`,
    bolt: `<svg viewBox="0 0 24 24"><path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/></svg>`
};

// ===== INIT =====
function init() {
    marked.setOptions({ gfm: true, breaks: true });
    applyTheme(theme);
    applyFont(FONTS[fontIdx]);
    renderModels();
    renderApiModes();
    updateUI();
    setupEvents();
}

function setupEvents() {
    sendBtn.onclick = send;
    input.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } };
    input.oninput = autoResize;
    
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = handleFile;
    input.onpaste = handlePaste;
    
    $('header-left').onclick = resetChat;
    $('font-btn').onclick = cycleFont;
    $('theme-btn').onclick = cycleTheme;
    $('settings-btn').onclick = () => openModal(settingsModal);
    tableBtn.onclick = toggleTableMode;
    
    modelBtn.onclick = e => { e.stopPropagation(); modelOpts.classList.toggle('show'); };
    document.onclick = () => modelOpts.classList.remove('show');
    
    $('close-settings').onclick = () => closeModal(settingsModal);
    $('save-settings').onclick = saveSettings;
    $('set-model').onchange = e => { model = e.target.value; updateUI(); };
    $('set-font').onclick = cycleFont;
    $('set-theme').onclick = cycleTheme;
    $('set-clear').onclick = () => { resetChat(); closeModal(settingsModal); };
    
    settingsModal.onclick = e => { if (e.target === settingsModal) closeModal(settingsModal); };
    
    $('close-table').onclick = () => closeModal(tableModal);
    $('table-copy').onclick = copyTable;
    $('table-html').onclick = downloadTableHtml;
    $('table-newtab').onclick = openTableNewTab;
    tableModal.onclick = e => { if (e.target === tableModal) closeModal(tableModal); };
}

// ===== THEME =====
function applyTheme(t) {
    document.body.className = t === 'light' ? '' : `${t}-theme`;
    theme = t;
    localStorage.setItem('theme', t);
    
    document.querySelectorAll('.theme-icon').forEach(i => i.classList.remove('active'));
    const map = { light: 't-light', dark: 't-dark', powershell: 't-ps', imessage: 't-imsg', nord: 't-nord' };
    $(map[t])?.classList.add('active');
    
    const isDark = ['dark', 'powershell', 'nord'].includes(t);
    $('hljs-theme').href = isDark 
        ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css'
        : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
}

function cycleTheme() {
    const idx = (THEMES.indexOf(theme) + 1) % THEMES.length;
    applyTheme(THEMES[idx]);
    showNotify(`–¢–µ–º–∞: ${THEME_NAMES[THEMES[idx]]}`);
}

// ===== FONT =====
function applyFont(size) {
    document.documentElement.style.setProperty('--base-font-size', size + 'px');
}

function cycleFont() {
    fontIdx = (fontIdx + 1) % FONTS.length;
    applyFont(FONTS[fontIdx]);
    localStorage.setItem('fontIdx', fontIdx);
    showNotify(`–®—Ä–∏—Ñ—Ç: ${FONTS[fontIdx]}px`);
}

// ===== TABLE MODE =====
function toggleTableMode() {
    tableMode = !tableMode;
    localStorage.setItem('tableMode', tableMode);
    tableBtn.classList.toggle('active', tableMode);
    showNotify(tableMode ? '–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã –í–ö–õ' : '–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã –í–´–ö–õ');
}

// ===== UI =====
function updateUI() {
    const m = MODELS.find(x => x.id === model) || MODELS[2];
    headerTitle.textContent = m.name;
    $('model-name').textContent = m.name;
    
    // Update header logo
    headerLogo.className = 'header-logo ' + (m.api === 'gemini' ? 'gemini' : m.api === 'mistral' ? 'mistral' : 'other');
    
    if (m.api === 'gemini') {
        headerLogo.innerHTML = GEMINI_STAR;
    } else if (m.api === 'mistral') {
        headerLogo.innerHTML = MISTRAL_ICON;
    } else {
        headerLogo.innerHTML = OTHER_ICON;
    }
    
    // Models dropdown
    modelOpts.querySelectorAll('.sel-opt').forEach(o => {
        o.classList.toggle('selected', o.dataset.id === model);
    });
    
    // Settings select
    $('set-model').value = model;
    
    // API modes visibility
    updateApiModesVisibility(m.api);
    
    // Table mode
    tableBtn.classList.toggle('active', tableMode);
    
    // Context size
    updateContextSize();
}

function updateContextSize() {
    if (history.length === 0) {
        headerSub.textContent = '–ù–æ–≤—ã–π —á–∞—Ç';
        return;
    }
    
    let chars = 0, bytes = 0;
    history.forEach(m => {
        if (m.text) {
            chars += m.text.length;
            bytes += new TextEncoder().encode(m.text).length;
        }
        if (m.file?.data) bytes += m.file.data.length;
    });
    
    const tokens = Math.round(chars / 4);
    const kb = (bytes / 1024).toFixed(1);
    headerSub.textContent = `~${tokens.toLocaleString()} —Ç–æ–∫–µ–Ω–æ–≤ ¬∑ ${kb} –ö–ë`;
}

function updateApiModesVisibility(apiType) {
    const modes = $('api-modes');
    modes.querySelectorAll('.api-mode').forEach(m => {
        const mode = m.dataset.mode;
        if (apiType === 'gemini') {
            m.style.display = mode === 'direct_mistral' ? 'none' : 'flex';
        } else if (apiType === 'mistral') {
            m.style.display = (mode === 'direct' || mode === 'vercel') ? 'none' : 'flex';
        } else {
            m.style.display = mode === 'mapruapp' ? 'flex' : 'none';
        }
    });
    
    const currentEl = modes.querySelector(`[data-mode="${apiMode}"]`);
    if (currentEl && currentEl.style.display === 'none') {
        apiMode = 'mapruapp';
        modes.querySelectorAll('.api-mode').forEach(m => m.classList.toggle('selected', m.dataset.mode === apiMode));
    }
    
    const needsKey = (apiMode === 'direct' || apiMode === 'direct_mistral');
    $('api-key-group').style.display = needsKey ? 'block' : 'none';
    
    if (apiMode === 'direct') {
        $('api-link').href = 'https://aistudio.google.com/app/apikey';
        $('api-link').textContent = 'Google AI Studio ‚Üí';
    } else if (apiMode === 'direct_mistral') {
        $('api-link').href = 'https://console.mistral.ai/api-keys/';
        $('api-link').textContent = 'Mistral Console ‚Üí';
    }
}

function renderModels() {
    modelOpts.innerHTML = MODELS.map(m => `
        <li class="sel-opt ${m.id === model ? 'selected' : ''}" data-id="${m.id}">
            ${m.name}
        </li>
    `).join('');
    
    modelOpts.querySelectorAll('.sel-opt').forEach(o => {
        o.onclick = e => {
            e.stopPropagation();
            model = o.dataset.id;
            localStorage.setItem('model', model);
            modelOpts.classList.remove('show');
            updateUI();
        };
    });
    
    $('set-model').innerHTML = MODELS.map(m => 
        `<option value="${m.id}">${m.name}</option>`
    ).join('');
    $('set-model').value = model;
}

function renderApiModes() {
    const modes = $('api-modes');
    modes.innerHTML = Object.entries(API_MODES).map(([key, val]) => `
        <div class="api-mode ${key === apiMode ? 'selected' : ''}" data-mode="${key}">
            ${ICONS[val.icon]}
            <span>${val.name}</span>
        </div>
    `).join('');
    
    modes.querySelectorAll('.api-mode').forEach(m => {
        m.onclick = () => {
            apiMode = m.dataset.mode;
            modes.querySelectorAll('.api-mode').forEach(x => x.classList.toggle('selected', x.dataset.mode === apiMode));
            updateApiModesVisibility(MODELS.find(x => x.id === model)?.api || 'gemini');
        };
    });
    
    $('api-key-input').value = apiKey;
}

function saveSettings() {
    model = $('set-model').value;
    apiKey = $('api-key-input').value.trim();
    
    localStorage.setItem('model', model);
    localStorage.setItem('apiMode', apiMode);
    localStorage.setItem('apiKey', apiKey);
    
    closeModal(settingsModal);
    updateUI();
    showNotify('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

// ===== FILE =====
function handleFile() {
    const file = fileInput.files?.[0];
    if (!file) return;
    
    const allowed = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
    if (!allowed.includes(file.type)) {
        showNotify('–§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', true);
        return;
    }
    
    if (file.size > 20 * 1024 * 1024) {
        showNotify('–§–∞–π–ª > 20 –ú–ë', true);
        return;
    }
    
    pendingFile = file;
    updateFilePreview();
    fileInput.value = '';
}

function handlePaste(e) {
    const items = e.clipboardData?.items;
    if (!items) return;
    
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            e.preventDefault();
            const blob = item.getAsFile();
            pendingFile = new File([blob], `image-${Date.now()}.png`, { type: blob.type });
            updateFilePreview();
            showNotify('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ');
            break;
        }
    }
}

function updateFilePreview() {
    if (!pendingFile) {
        filePreview.innerHTML = '';
        filePreview.classList.remove('visible');
        uploadBtn.classList.remove('has-file');
        return;
    }
    
    uploadBtn.classList.add('has-file');
    filePreview.classList.add('visible');
    
    const isPdf = pendingFile.type === 'application/pdf';
    const isImg = pendingFile.type.startsWith('image/');
    
    let preview = '';
    if (isImg) {
        const url = URL.createObjectURL(pendingFile);
        preview = `<img src="${url}" alt="">`;
    } else {
        preview = `<svg viewBox="0 -960 960 960"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Z"/></svg>`;
    }
    
    filePreview.innerHTML = `
        <div class="file-chip">
            ${preview}
            <span style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${pendingFile.name}</span>
            <span class="file-chip-remove" onclick="clearFile()">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </span>
        </div>
    `;
}

window.clearFile = function() {
    pendingFile = null;
    updateFilePreview();
};

// ===== MESSAGES =====
function getAvatarHtml(role, apiType) {
    if (role === 'user') {
        return '<div class="msg-avatar user-avatar">–Ø</div>';
    }
    
    const avatarClass = apiType === 'gemini' ? 'gemini' : apiType === 'mistral' ? 'mistral' : 'other';
    
    if (apiType === 'gemini') {
        return `<div class="msg-avatar ${avatarClass}">${GEMINI_STAR}</div>`;
    } else if (apiType === 'mistral') {
        return `<div class="msg-avatar ${avatarClass}">${MISTRAL_ICON}</div>`;
    } else {
        return `<div class="msg-avatar ${avatarClass}">${OTHER_ICON}</div>`;
    }
}

function addMessage(role, text, imgUrl = null) {
    empty.style.display = 'none';
    
    const m = MODELS.find(x => x.id === model);
    const avatarHtml = getAvatarHtml(role, m?.api);
    
    const div = document.createElement('div');
    div.className = `message ${role}`;
    
    let content = '';
    if (imgUrl) content += `<img src="${imgUrl}" class="msg-image" onclick="window.open(this.src)">`;
    content += formatText(text);
    
    div.innerHTML = `
        ${avatarHtml}
        <div class="msg-bubble">
            <div class="msg-content">${content}</div>
            <div class="msg-time">${new Date().toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'})}</div>
        </div>
    `;
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    
    div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
    
    updateContextSize();
}

function formatText(text) {
    if (!text) return '';
    
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
        const l = lang || 'plaintext';
        return `<pre><div class="code-header"><span class="code-lang">${l}</span><button class="code-copy" onclick="copyCode(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div><code class="language-${l}">${escapeHtml(code.trim())}</code></pre>`;
    });
    
    return marked.parse(text);
}

function escapeHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

window.copyCode = function(btn) {
    const code = btn.closest('pre').querySelector('code').textContent;
    navigator.clipboard.writeText(code);
    btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
    setTimeout(() => btn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 1500);
};

// ===== TYPING =====
function showTyping() {
    headerLogo.classList.add('loading');
    
    const m = MODELS.find(x => x.id === model);
    const avatarClass = m?.api === 'gemini' ? 'gemini thinking' : m?.api === 'mistral' ? 'mistral' : 'other';
    
    let avatarContent;
    if (m?.api === 'gemini') {
        avatarContent = GEMINI_STAR;
    } else if (m?.api === 'mistral') {
        avatarContent = MISTRAL_ICON;
    } else {
        avatarContent = OTHER_ICON;
    }
    
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.innerHTML = `
        <div class="msg-avatar ${avatarClass}">${avatarContent}</div>
        <div class="typing-bubble">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function hideTyping() {
    $('typing')?.remove();
    headerLogo.classList.remove('loading');
}

// ===== SEND =====
async function send() {
    const text = input.value.trim();
    const file = pendingFile;
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç - –≤—ã—Ö–æ–¥–∏–º
    if (!text && !file) return;
    if (isLoading) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –¥–ª—è –ø—Ä—è–º—ã—Ö —Ä–µ–∂–∏–º–æ–≤
    const needsKey = (apiMode === 'direct' || apiMode === 'direct_mistral');
    if (needsKey && !apiKey) {
        openModal(settingsModal);
        showNotify('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', true);
        return;
    }
    
    isLoading = true;
    sendBtn.disabled = true;
    
    // –û—á–∏—Å—Ç–∫–∞ UI
    input.value = '';
    autoResize.call(input);
    clearFile();
    
    let fileData = null;
    let displayUrl = null;
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞
    if (file) {
        try {
            const result = await toBase64(file);
            fileData = {
                dataUrl: result.dataUrl,
                base64: result.base64,
                mimeType: result.mimeType
            };
            if (file.type.startsWith('image/')) {
                displayUrl = result.dataUrl;
            }
        } catch (e) {
            showNotify('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', true);
            isLoading = false;
            sendBtn.disabled = false;
            return;
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
    const displayText = text || (file ? `üìé ${file.name}` : '');
    addMessage('user', displayText, displayUrl);
    
    // --- –í–ê–ñ–ù–û: –õ–û–ì–ò–ö–ê –ü–£–°–¢–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø ---
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò
    const apiText = text || '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ñ–∞–π–ª. –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –Ω–∞–ø–∏—à–∏: "–§–∞–π–ª –ø–æ–ª—É—á–µ–Ω. –ñ–¥—É –≤–∞—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤." (–∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏, —á—Ç–æ —ç—Ç–æ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç).';
    
    history.push({
        role: 'user',
        text: apiText,
        file: fileData
    });
    
    showTyping();
    
    try {
        const response = await callAPI();
        hideTyping();
        
        if (response) {
            addMessage('bot', response);
            history.push({ role: 'bot', text: response });
            
            // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ—Ö–æ–∂ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã
            if (tableMode && response.includes('|')) {
                lastTableHtml = marked.parse(response);
                $('table-content').innerHTML = lastTableHtml;
                openModal(tableModal);
            }
        }
    } catch (e) {
        hideTyping();
        addMessage('bot', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
    }
    
    isLoading = false;
    sendBtn.disabled = false;
}

async function callAPI() {
    const m = MODELS.find(x => x.id === model);
    const sysPrompt = tableMode ? TABLE_PROMPT : '–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.';
    
    const lastMsg = history[history.length - 1];
    const hasFile = lastMsg?.role === 'user' && lastMsg?.file;
    
    let url, body, headers = { 'Content-Type': 'application/json' };
    
    // –†–µ–∂–∏–º MapRuApp (Proxy)
    if (apiMode === 'mapruapp') {
        url = PROXY_MAP;
        
        const messages = [];
        // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–æ–±–∞–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∫—Å–∏ –ª–æ–º–∞—é—Ç—Å—è –ø—Ä–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–∏)
        if (!hasFile) {
            messages.push({ role: 'system', content: sysPrompt });
        }
        
        history.forEach(h => {
            if (h.role === 'user') {
                const content = [];
                let msgText = h.text;
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (h.file && !hasFile) {
                    msgText = sysPrompt + '\n\n' + h.text;
                }
                
                content.push({ type: 'text', text: msgText });
                
                if (h.file) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –∏–ª–∏ –ö–∞—Ä—Ç–∏–Ω–∫—É —á–µ—Ä–µ–∑ image_url
                    // (MapRuApp –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–ª—è Gemini)
                    content.push({ 
                        type: 'image_url', 
                        image_url: { 
                            url: `data:${h.file.mimeType};base64,${h.file.base64}` 
                        } 
                    });
                }
                messages.push({ role: 'user', content });
            } else {
                messages.push({ role: 'assistant', content: h.text });
            }
        });
        
        body = { model, messages, max_tokens: 8192 };
        
    // –†–µ–∂–∏–º Vercel –∏–ª–∏ Direct (–ù–∞—Ç–∏–≤–Ω—ã–π Google —Ñ–æ—Ä–º–∞—Ç)
    } else if (apiMode === 'vercel' || apiMode === 'direct') {
        
        if (apiMode === 'direct') {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        } else {
            url = `${PROXY_VER}/v1beta/models/${model}:generateContent`;
        }
        
        const contents = history.map(h => {
            const parts = [];
            if (h.text) parts.push({ text: h.text });
            if (h.role === 'user' && h.file) {
                // –ù–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Gemini (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PDF –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
                parts.push({ 
                    inlineData: { 
                        mimeType: h.file.mimeType, 
                        data: h.file.base64 
                    } 
                });
            }
            return { role: h.role === 'user' ? 'user' : 'model', parts };
        });
        
        body = { 
            contents,
            systemInstruction: { parts: [{ text: sysPrompt }] }
        };
        
    // –†–µ–∂–∏–º Direct Mistral
    } else if (apiMode === 'direct_mistral') {
        url = 'https://api.mistral.ai/v1/chat/completions';
        headers['Authorization'] = `Bearer ${apiKey}`;
        
        const messages = [{ role: 'system', content: sysPrompt }];
        
        history.forEach(h => {
            if (h.role === 'user') {
                const content = [];
                content.push({ type: 'text', text: h.text });
                if (h.file) {
                    content.push({ 
                        type: 'image_url', 
                        image_url: { 
                            url: `data:${h.file.mimeType};base64,${h.file.base64}` 
                        } 
                    });
                }
                messages.push({ role: 'user', content });
            } else {
                messages.push({ role: 'assistant', content: h.text });
            }
        });
        
        body = { model, messages, max_tokens: 8192 };
    }
    
    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
    
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || JSON.stringify(err) || `HTTP ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.choices) return data.choices[0]?.message?.content || '';
    if (data.candidates) return data.candidates[0]?.content?.parts?.[0]?.text || '';
    return '';
}


// ===== TABLE EXPORT =====
function copyTable() {
    const text = $('table-content').innerText;
    navigator.clipboard.writeText(text);
    showNotify('–¢–∞–±–ª–∏—Ü–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
}

function downloadTableHtml() {
    const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–∞–±–ª–∏—Ü–∞</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 16px; text-align: left; }
        td { padding: 12px 16px; border-bottom: 1px solid #eee; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #f0f0ff; }
    </style>
</head>
<body>${lastTableHtml}</body>
</html>`;
    
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `table_${Date.now()}.html`;
    a.click();
    URL.revokeObjectURL(url);
    showNotify('HTML —Å–∫–∞—á–∞–Ω');
}

function openTableNewTab() {
    const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–∞–±–ª–∏—Ü–∞</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 16px; text-align: left; }
        td { padding: 12px 16px; border-bottom: 1px solid #eee; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #f0f0ff; }
    </style>
</head>
<body>${lastTableHtml}</body>
</html>`;
    
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
}

// ===== UTILS =====
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
            const result = r.result;
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –ø–æ–ª–Ω—É—é data URL –∏ —á–∏—Å—Ç—ã–π base64
            resolve({
                dataUrl: result,
                base64: result.split(',')[1],
                mimeType: file.type
            });
        };
        r.onerror = reject;
        r.readAsDataURL(file);
    });
}

function autoResize() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
}

function showNotify(msg, isErr = false) {
    notify.textContent = msg;
    notify.className = `notify show ${isErr ? 'error' : ''}`;
    setTimeout(() => notify.classList.remove('show'), 2500);
}

function openModal(m) { m.style.display = 'flex'; }
function closeModal(m) { m.style.display = 'none'; }

function resetChat() {
    history = [];
    chat.innerHTML = '';
    empty.style.display = 'flex';
    chat.appendChild(empty);
    clearFile();
    updateContextSize();
    showNotify('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
}

// ===== START =====
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ü–¢ XML 11 -> 10</title>
  <link rel="icon" href="img/kpt11.png" type="image/png">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #0078d4;
            --primary-hover: #106ebe;
            --primary-light: #deecf9;
            --primary-bg: #f3f9fd;
            --success-color: #107c10;
            --success-bg: #dff6dd;
            --danger-color: #d13438;
            --danger-bg: #fde7e9;
            --light-bg: #faf9f8;
            --text-color: #323130;
            --text-light: #605e5c;
            --border-color: #edebe9;
            --border-light: #e1dfdd;
            --border-radius: 8px;
            --box-shadow: 0 1.6px 3.6px 0 rgba(0,0,0,.132), 0 0.3px 0.9px 0 rgba(0,0,0,.108);
            --box-shadow-hover: 0 6.4px 14.4px 0 rgba(0,0,0,.132), 0 1.2px 3.6px 0 rgba(0,0,0,.108);
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            text-align: center;
            margin: 20px;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 600;
        }

        .subtitle {
            color: var(--text-light);
            margin-bottom: 40px;
            font-size: 16px;
        }

        .stage {
            display: none;
            margin-top: 25px;
        }

        .stage.active {
            display: block;
        }

        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è drop area –≤ Microsoft —Å—Ç–∏–ª–µ */
        .upload-area {
            position: relative;
            border: 2px dashed var(--border-light);
            border-radius: var(--border-radius);
            padding: 60px 40px;
            background: var(--light-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--primary-bg);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--primary-light);
            transform: scale(1.02);
            box-shadow: var(--box-shadow-hover);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 24px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon,
        .upload-area.dragover .upload-icon {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .upload-icon svg {
            width: 32px;
            height: 32px;
            fill: var(--primary-color);
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon svg,
        .upload-area.dragover .upload-icon svg {
            fill: #ffffff;
        }

        .upload-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .upload-text .highlight {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .upload-hint {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .file-types {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }

        .file-type {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-type::before {
            content: "üìÑ";
            font-size: 14px;
        }

        .encoding-selector {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: var(--light-bg);
            border-radius: var(--border-radius);
        }

        .encoding-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .encoding-selector select {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            min-width: 200px;
            transition: border-color 0.2s ease;
        }

        .encoding-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        input[type="file"] {
            display: none;
        }

        /* –û–ø—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ */
        #options-stage h2 {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: left;
            color: var(--text-color);
            font-weight: 600;
        }

        .file-info {
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .file-info .file-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .file-info .file-details {
            font-size: 14px;
            color: var(--text-light);
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        .options-list li {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .options-list li:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }

        .custom-checkbox input {
            display: none;
        }

        .custom-checkbox .checkmark {
            min-width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 16px;
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .custom-checkbox .checkmark::after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .custom-checkbox input:checked ~ .checkmark::after {
            display: block;
        }

        .custom-checkbox .label-text {
            font-weight: 500;
            flex: 1;
        }

        .custom-checkbox .count {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.4);
        }

        .btn-secondary {
            background-color: #ffffff;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--light-bg);
            border-color: var(--primary-color);
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        #result-content {
            padding: 24px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
        }

        #result-content.success {
            background-color: var(--success-bg);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        #result-content.error {
            background-color: var(--danger-bg);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        #result-content p {
            margin: 0 0 16px;
            font-weight: 600;
            font-size: 16px;
        }

        #result-content .success-icon,
        #result-content .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        #loader {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border-light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 16px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤—ã–ø–∏—Å–∫–∏ –ö–ü–¢</h1>
        <p class="subtitle">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ö–ü–¢ XML11 –≤ XML10</p>
        
        <!-- –≠—Ç–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div id="upload-stage" class="stage active">
            <input type="file" id="fileInput" accept=".xml,.zip">
            <label for="fileInput" class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                </div>
                <div class="upload-text">
                    <span class="highlight">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span> –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞
                </div>
                <div class="upload-hint">
                    
                </div>
                <div class="file-types">
                    <div class="file-type">XML —Ñ–∞–π–ª—ã</div>
                    <div class="file-type">ZIP –∞—Ä—Ö–∏–≤—ã</div>
                </div>
            </label>
            
            <div class="encoding-selector">
                <label for="encodingSelector">–ö–æ–¥–∏—Ä–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:</label>
                <select id="encodingSelector">
                    <option value="UTF-8">UTF-8</option>
                    <option value="windows-1251">Windows-1251</option>
                </select>
            </div>
        </div>

        <!-- –≠—Ç–∞–ø –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–π -->
        <div id="options-stage" class="stage">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h2>
            <div class="file-info">
                <div class="file-name" id="fileName"></div>
                <div class="file-details" id="fileDetails"></div>
            </div>
            <ul id="optionsList" class="options-list"></ul>
            <div class="actions">
                <button id="resetButton" class="btn btn-secondary">
                    üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                </button>
                <button id="convertButton" class="btn btn-primary">
                    üöÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>

        <!-- –≠—Ç–∞–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div id="result-stage" class="stage">
            <div id="loader">
                <div class="spinner"></div>
                <div class="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
            </div>
            <div id="result-content"></div>
            <div class="actions" style="justify-content: center; margin-top: 30px;">
                <button id="startOverButton" class="btn btn-primary">
                    üìÅ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª
                </button>
            </div>
        </div>
    </div>

<script>
let currentXmlDoc = null;
let currentFileName = '';
const stages = {
    upload: document.getElementById('upload-stage'),
    options: document.getElementById('options-stage'),
    result: document.getElementById('result-stage')
};

const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');
const optionsList = document.getElementById('optionsList');
const fileName = document.getElementById('fileName');
const fileDetails = document.getElementById('fileDetails');
const convertButton = document.getElementById('convertButton');
const resetButton = document.getElementById('resetButton');
const startOverButton = document.getElementById('startOverButton');
const loader = document.getElementById('loader');
const resultContent = document.getElementById('result-content');
const encodingSelector = document.getElementById('encodingSelector');

const OBJECT_TYPES = {
    parcels: { label: '–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏', selector: 'land_record', prefix: 'zu' },
    buildings: { label: '–ó–¥–∞–Ω–∏—è', selector: 'build_record', prefix: 'oks' },
    constructions: { label: '–°–æ–æ—Ä—É–∂–µ–Ω–∏—è', selector: 'construction_record', prefix: 'cons' },
    bounds: { label: '–ì—Ä–∞–Ω–∏—Ü—ã (–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–µ, –Ω.–ø.)', selector: 'municipal_boundary_record, inhabited_locality_boundary_record', prefix: 'bounds' },
    zones: { label: '–ó–æ–Ω—ã –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', selector: 'zones_and_territories_record', prefix: 'zones' }
};

function updateUIState(activeStage) {
    Object.values(stages).forEach(stage => stage.classList.remove('active'));
    if (stages[activeStage]) stages[activeStage].classList.add('active');
}

function resetApp() {
    currentXmlDoc = null;
    currentFileName = '';
    fileInput.value = '';
    resultContent.innerHTML = '';
    resultContent.className = '';
    updateUIState('upload');
}

// –°–æ–±—ã—Ç–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
uploadArea.addEventListener('drop', handleFileDrop, false);



['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
});

['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
});

convertButton.addEventListener('click', handleConversion);
resetButton.addEventListener('click', resetApp);
startOverButton.addEventListener('click', resetApp);

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleFileDrop(e) {
    fileInput.files = e.dataTransfer.files;
    handleFileSelect(e.dataTransfer.files);
}

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
    if (currentFileName === files[0].name && currentXmlDoc) return;
    
    const file = files[0];
    currentFileName = file.name;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
    showLoaderWithMessage(`–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: ${file.name}`);
    
    if (file.name.toLowerCase().endsWith('.zip')) {
        handleZipFile(file);
    } else {
        handleXmlFile(file);
    }
}

function handleZipFile(file) {
    const encoding = encodingSelector.value;
    
    JSZip.loadAsync(file).then(zip => {
        const xmlFile = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith('.xml'));
        if (xmlFile) {
            return xmlFile.async("blob");
        }
        throw new Error("XML-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ZIP-–∞—Ä—Ö–∏–≤–µ.");
    }).then(blob => {
        const reader = new FileReader();
        reader.onload = e => processXmlString(e.target.result);
        reader.onerror = () => showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å XML –∏–∑ ZIP.');
        reader.readAsText(blob, encoding);
    }).catch(error => {
        showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ZIP: ${error.message}`);
    });
}

function handleXmlFile(file) {
    const encoding = encodingSelector.value;
    const reader = new FileReader();
    
    reader.onload = (event) => processXmlString(event.target.result);
    reader.onerror = () => showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å XML-—Ñ–∞–π–ª.');
    reader.readAsText(file, encoding);
}

function processXmlString(xmlString) {
    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
        const parserError = xmlDoc.querySelector("parsererror");
        
        if (parserError) {
            throw new Error(`–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ XML: ${parserError.textContent}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É.`);
        }
        
        currentXmlDoc = xmlDoc;
        analyzeAndDisplayOptions(xmlDoc);
    } catch (error) {
        showError(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

function analyzeAndDisplayOptions(xmlDoc) {
    optionsList.innerHTML = '';
    let hasObjects = false;
    let totalObjects = 0;
    
    Object.entries(OBJECT_TYPES).forEach(([key, config]) => {
        const count = xmlDoc.querySelectorAll(config.selector).length;
        totalObjects += count;
        
        if (count > 0) {
            hasObjects = true;
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <label class="custom-checkbox">
                    <input type="checkbox" data-type="${key}" checked>
                    <span class="checkmark"></span>
                    <span class="label-text">${config.label}</span>
                    <span class="count">${count}</span>
                </label>
            `;
            optionsList.appendChild(listItem);
        }
    });
    
    if (!hasObjects) {
        showError('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.');
        return;
    }
    
    fileName.textContent = currentFileName;
    fileDetails.textContent = `–ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${totalObjects}`;
    updateUIState('options');
}

function handleConversion() {
    if (!currentXmlDoc) {
        showError('XML –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
        return;
    }
    
    updateUIState('result');
    loader.style.display = 'block';
    resultContent.style.display = 'none';
    
    setTimeout(() => {
        try {
            const selection = {};
            optionsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                selection[checkbox.dataset.type] = checkbox.checked;
            });
            
            const newXmlString = convertXml(currentXmlDoc, selection);
            const blob = new Blob([newXmlString], { type: 'application/xml;charset=utf-8' });
            
            const cadNum = currentXmlDoc.querySelector('cadastral_block > cadastral_number')?.textContent || 'unknown';
            const fileName = generateFileName(cadNum, selection);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(fileName);
        } catch (error) {
            console.error(error);
            showError(`–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }, 100);
}

function generateFileName(cadNum, selection) {
    const baseName = `KPT_${cadNum.replace(/:/g, '_')}`;
    const selectedTypes = Object.entries(selection)
        .filter(([key, isSelected]) => isSelected)
        .map(([key, isSelected]) => OBJECT_TYPES[key].prefix);
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –Ω–µ –≤—Å–µ —Ç–∏–ø—ã, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã
    const allTypes = Object.keys(OBJECT_TYPES);
    const allSelected = allTypes.every(type => selection[type]);
    
    if (!allSelected && selectedTypes.length > 0) {
        return `${baseName}_${selectedTypes.join('_')}_v10.xml`;
    }
    
    return `${baseName}_v10.xml`;
}

function showLoaderWithMessage(message) {
    updateUIState('result');
    loader.style.display = 'block';
    loader.querySelector('.loading-text').textContent = message;
    resultContent.style.display = 'none';
}

function showSuccess(fileName) {
    resultContent.className = 'success';
    resultContent.innerHTML = `
        <span class="success-icon">‚úÖ</span>
        <p>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</p>
        <p>–§–∞–π–ª <strong>${fileName}</strong> –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–Ω</p>
    `;
    resultContent.style.display = 'block';
}

function showError(message) {
    updateUIState('result');
    loader.style.display = 'none';
    resultContent.className = 'error';
    resultContent.innerHTML = `
        <span class="error-icon">‚ùå</span>
        <p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!</p>
        <p>${message}</p>
    `;
    resultContent.style.display = 'block';
}

// –ó–¥–µ—Å—å —Å–ª–µ–¥—É–µ—Ç –≤–µ—Å—å –∫–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ XML (—Ñ—É–Ω–∫—Ü–∏–∏ convertXml –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–π)
// –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—Ç –∂–µ –∫–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, —á—Ç–æ –±—ã–ª –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ...

const NS = {
    KPT: "urn://x-artefacts-rosreestr-ru/outgoing/kpt/10.0.1",
    ADR: "urn://x-artefacts-rosreestr-ru/commons/complex-types/address-output/4.0.1",
    SPATIAL: "urn://x-artefacts-rosreestr-ru/commons/complex-types/entity-spatial/5.0.1",
    OKS: "urn://x-artefacts-rosreestr-ru/commons/complex-types/parameters-oks/2.0.1",
    CERT: "urn://x-artefacts-rosreestr-ru/commons/complex-types/certification-doc/1.0",
    DOC: "urn://x-artefacts-rosreestr-ru/commons/complex-types/document-output/4.0.1",
    SMEV: "urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1"
};

const getNodeValue = (parent, selector) => parent.querySelector(selector)?.textContent.trim() || '';

function convertXml(oldDoc, selection) {
    const newDoc = document.implementation.createDocument(NS.KPT, 'KPT', null);
    const root = newDoc.documentElement;
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns', NS.KPT);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:adrOut4', NS.ADR);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns3', NS.SPATIAL);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns4', NS.OKS);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns5', NS.DOC);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns6', NS.CERT);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns7', NS.SMEV);
    
    const coordSystems = new Map();
    const csCounter = { value: 1 };
    
    const cadastralBlocks = createElement(newDoc, NS.KPT, 'CadastralBlocks');
    oldDoc.querySelectorAll('cadastral_block').forEach(oldBlock => {
        const newBlock = createElement(newDoc, NS.KPT, 'CadastralBlock');
        newBlock.setAttribute('CadastralNumber', getNodeValue(oldBlock, 'cadastral_number'));
        const area = createElement(newDoc, NS.KPT, 'Area');
        area.appendChild(createElementWithText(newDoc, NS.KPT, 'Total', getNodeValue(oldBlock, 'area_quarter area')));
        area.appendChild(createElementWithText(newDoc, NS.KPT, 'Unit', getNodeValue(oldBlock, 'area_quarter unit')));
        newBlock.appendChild(area);
        
        if (selection.parcels) appendChildIfNotEmpty(newBlock, convertParcels(oldBlock, newDoc, coordSystems, csCounter));
        if (selection.buildings || selection.constructions) appendChildIfNotEmpty(newBlock, convertObjectsRealty(oldBlock, newDoc, coordSystems, csCounter, selection));
        if (selection.bounds) appendChildIfNotEmpty(newBlock, convertBounds(oldBlock, newDoc, coordSystems, csCounter));
        if (selection.zones) appendChildIfNotEmpty(newBlock, convertZones(oldBlock, newDoc, coordSystems, csCounter));
        appendChildIfNotEmpty(newBlock, convertSpatialData(oldBlock, newDoc, coordSystems, csCounter));
        
        cadastralBlocks.appendChild(newBlock);
    });
    root.appendChild(cadastralBlocks);

   
   root.appendChild(createCoordSystemsNode(newDoc, coordSystems));
    root.appendChild(createCertificationDocNode(oldDoc, newDoc));
    
    const serializer = new XMLSerializer();
    let xmlString = serializer.serializeToString(newDoc);
    const styleSheet = '<?xml-stylesheet type="text/xsl" href="https://portal.rosreestr.ru/xsl/GKN/KPT_b/10/common.xsl"?>';
    return `<?xml version="1.0" encoding="UTF-8"?>\n${styleSheet}\n` + xmlString;
}

function appendChildIfNotEmpty(parent, child) { 
    if (child && child.hasChildNodes()) parent.appendChild(child); 
}

function createElement(doc, ns, qualifiedName) { 
    return doc.createElementNS(ns, qualifiedName); 
}

function createElementWithText(doc, ns, qualifiedName, text) { 
    const el = createElement(doc, ns, qualifiedName); 
    if (text) el.textContent = text; 
    return el; 
}

function createCertificationDocNode(oldDoc, newDoc) {
    const certDoc = createElement(newDoc, NS.KPT, 'CertificationDoc');
    const statement = oldDoc.querySelector('details_statement');
    if (!statement) return certDoc;
    certDoc.appendChild(createElementWithText(newDoc, NS.CERT, 'ns6:Organization', getNodeValue(statement, 'organ_registr_rights')));
    certDoc.appendChild(createElementWithText(newDoc, NS.CERT, 'ns6:Date', getNodeValue(statement, 'date_formation')));
    certDoc.appendChild(createElementWithText(newDoc, NS.CERT, 'ns6:Number', getNodeValue(statement, 'registration_number')));
    return certDoc;
}

function createAddressNode(oldAddress, newDoc) {
    const locationNode = createElement(newDoc, NS.KPT, 'Location');
    if (!oldAddress) return locationNode;
    const address = createElement(newDoc, NS.KPT, 'Address');
    locationNode.appendChild(address);
    const addressTypeCode = getNodeValue(oldAddress, 'address_type code');
    if (addressTypeCode === '02') { 
        address.setAttribute('adrOut4:AddressOrLocation', '0'); 
    }
    const addrSource = oldAddress.querySelector('address, location');
    if (!addrSource) return locationNode;
    
    const createAdrEl = (name, val) => { 
        if (!val) return null; 
        return createElementWithText(newDoc, NS.ADR, `adrOut4:${name}`, val); 
    };
    const createAdrElWithAttr = (name, attrs) => {
        const hasValues = Object.values(attrs).some(v => v);
        if (!hasValues) return null;
        const el = createElement(newDoc, NS.ADR, `adrOut4:${name}`);
        Object.entries(attrs).forEach(([key, value]) => value && el.setAttribute(key, value));
        return el;
    };
    
    const elements = [
        createAdrEl('OKATO', getNodeValue(addrSource, 'okato')), 
        createAdrEl('KLADR', getNodeValue(addrSource, 'kladr')),
        createAdrEl('PostalCode', getNodeValue(addrSource, 'postal_code')),
        createAdrEl('Region', getNodeValue(addrSource, 'region code')),
        createAdrElWithAttr('District', { 
            Type: getNodeValue(addrSource, 'district type_district'), 
            Name: getNodeValue(addrSource, 'district name_district') 
        }),
        createAdrElWithAttr('City', { 
            Type: getNodeValue(addrSource, 'city type_city'), 
            Name: getNodeValue(addrSource, 'city name_city') 
        }),
        createAdrElWithAttr('Street', { 
            Type: getNodeValue(addrSource, 'street type_street'), 
            Name: getNodeValue(addrSource, 'street name_street') 
        }),
        createAdrElWithAttr('Level1', { 
            Type: getNodeValue(addrSource, 'level1 type_level1'), 
            Value: getNodeValue(addrSource, 'level1 name_level1') 
        }),
        createAdrEl('Note', getNodeValue(oldAddress, 'readable_address'))
    ];
    elements.forEach(el => el && address.appendChild(el));
    return locationNode;
}

function createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter) {
    const entSpatial = createElement(newDoc, NS.KPT, 'EntitySpatial');
    if (!oldSpatial) return entSpatial;
    const csId = getNodeValue(oldSpatial, 'sk_id') || 'UNKNOWN_CS';
    let sysId = coordSystems.get(csId);
    if (!sysId) { 
        sysId = `ID${csCounter.value++}`; 
        coordSystems.set(csId, sysId); 
    }
    entSpatial.setAttribute('EntSys', sysId);
    const spatialElements = oldSpatial.querySelectorAll('contour > entity_spatial > spatials_elements > spatial_element, spatials_elements > spatial_element');
    spatialElements.forEach(oldElement => {
        const spatialElementNode = createElement(newDoc, NS.SPATIAL, 'ns3:SpatialElement');
        oldElement.querySelectorAll(':scope > ordinates > ordinate').forEach(ord => {
            const suNmb = getNodeValue(ord, 'ord_nmb') || getNodeValue(ord, 'number_pp');
            const spelementUnit = createElement(newDoc, NS.SPATIAL, 'ns3:SpelementUnit');
            spelementUnit.setAttribute('TypeUnit', '–¢–æ—á–∫–∞');
            if (suNmb) spelementUnit.setAttribute('SuNmb', suNmb);
            const ordinate = createElement(newDoc, NS.SPATIAL, 'ns3:Ordinate');
            ordinate.setAttribute('X', getNodeValue(ord, 'x'));
            ordinate.setAttribute('Y', getNodeValue(ord, 'y'));
            ordinate.setAttribute('OrdNmb', '1');
            const numGeopoint = getNodeValue(ord, 'num_geopoint');
            if (numGeopoint) ordinate.setAttribute('NumGeopoint', numGeopoint);
            const delta = getNodeValue(ord, 'delta_geopoint');
            if (delta) ordinate.setAttribute('DeltaGeopoint', delta);
            const zacrep = getNodeValue(ord, 'geopoint_zacrep');
            if (zacrep && zacrep !== "-") { 
                ordinate.setAttribute('GeopointZacrep', zacrep); 
            } else if (!numGeopoint) { 
                ordinate.setAttribute('GeopointZacrep', '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); 
            }
            spelementUnit.appendChild(ordinate);
            spatialElementNode.appendChild(spelementUnit);
        });
        if (spatialElementNode.hasChildNodes()) { 
            entSpatial.appendChild(spatialElementNode); 
        }
    });
    return entSpatial;
}

function createCoordSystemsNode(newDoc, coordSystems) {
    const csNode = createElement(newDoc, NS.KPT, 'CoordSystems');
    for (const [name, id] of coordSystems.entries()) {
        const system = createElement(newDoc, NS.SPATIAL, 'ns3:CoordSystem');
        system.setAttribute('Name', name);
        system.setAttribute('CsId', id);
        csNode.appendChild(system);
    }
    return csNode;
}

function convertParcels(oldBlock, newDoc, coordSystems, csCounter) {
    const parcelsNode = createElement(newDoc, NS.KPT, 'Parcels');
    oldBlock.querySelectorAll('land_record').forEach(oldParcel => {
        const newParcel = createElement(newDoc, NS.KPT, 'Parcel');
        newParcel.setAttribute('CadastralNumber', getNodeValue(oldParcel, 'object common_data cad_number'));
        newParcel.setAttribute('State', '01');
        const areaNode = createElement(newDoc, NS.KPT, 'Area');
        areaNode.appendChild(createElementWithText(newDoc, NS.KPT, 'Area', getNodeValue(oldParcel, 'params area value')));
        areaNode.appendChild(createElementWithText(newDoc, NS.KPT, 'Unit', '055'));
        const inaccuracy = getNodeValue(oldParcel, 'params area inaccuracy');
        if (inaccuracy) areaNode.appendChild(createElementWithText(newDoc, NS.KPT, 'Inaccuracy', inaccuracy));
        newParcel.appendChild(areaNode);
        if (getNodeValue(oldParcel, 'object subtype value').toLowerCase().includes('–∑–µ–º–ª–µ–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ')) {
            newParcel.appendChild(createElementWithText(newDoc, NS.KPT, 'Name', '01'));
        }
        newParcel.appendChild(createAddressNode(oldParcel.querySelector('address_location'), newDoc));
        newParcel.appendChild(createElementWithText(newDoc, NS.KPT, 'Category', getNodeValue(oldParcel, 'params category type code')));
        const utilNode = createElement(newDoc, NS.KPT, 'Utilization');
        utilNode.setAttribute('ByDoc', getNodeValue(oldParcel, 'params permitted_use by_document, params permitted_use permitted_use_established by_document'));
        newParcel.appendChild(utilNode);
        const costVal = getNodeValue(oldParcel, 'cost value');
        if (costVal) {
            const costNode = createElement(newDoc, NS.KPT, 'CadastralCost');
            costNode.setAttribute('Value', costVal);
            costNode.setAttribute('Unit', '383');
            newParcel.appendChild(costNode);
        }
        const oldSpatial = oldParcel.querySelector('contours_location, entity_spatial');
        if (oldSpatial) newParcel.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
        parcelsNode.appendChild(newParcel);
    });
    return parcelsNode;
}

function convertObjectsRealty(oldBlock, newDoc, coordSystems, csCounter, selection) {
    const objectsNode = createElement(newDoc, NS.KPT, 'ObjectsRealty');
    if (selection.buildings) {
        oldBlock.querySelectorAll('build_record').forEach(oldBuild => {
            const objectRealty = createElement(newDoc, NS.KPT, 'ObjectRealty');
            const building = createElement(newDoc, NS.KPT, 'Building');
            building.setAttribute('CadastralNumber', getNodeValue(oldBuild, 'object common_data cad_number'));
            building.appendChild(createElementWithText(newDoc, NS.KPT, 'ObjectType', getNodeValue(oldBuild, 'object common_data type code')));
            building.appendChild(createElementWithText(newDoc, NS.KPT, 'AssignationBuilding', getNodeValue(oldBuild, 'params purpose code')));
            building.appendChild(createElementWithText(newDoc, NS.KPT, 'Area', getNodeValue(oldBuild, 'params area')));
            building.appendChild(createAddressNode(oldBuild.querySelector('address_location'), newDoc));
            const cost = getNodeValue(oldBuild, 'cost value');
            if(cost) {
                const costNode = createElement(newDoc, NS.KPT, 'CadastralCost');
                costNode.setAttribute('Value', cost); 
                costNode.setAttribute('Unit', '383');
                building.appendChild(costNode);
            }
            const oldSpatial = oldBuild.querySelector('contours, entity_spatial');
            if (oldSpatial) building.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
            objectRealty.appendChild(building);
            objectsNode.appendChild(objectRealty);
        });
    }
    if (selection.constructions) {
        oldBlock.querySelectorAll('construction_record').forEach(oldConstr => {
            const objectRealty = createElement(newDoc, NS.KPT, 'ObjectRealty');
            const constr = createElement(newDoc, NS.KPT, 'Construction');
            constr.setAttribute('CadastralNumber', getNodeValue(oldConstr, 'object common_data cad_number'));
            constr.appendChild(createElementWithText(newDoc, NS.KPT, 'ObjectType', getNodeValue(oldConstr, 'object common_data type code')));
            constr.appendChild(createElementWithText(newDoc, NS.KPT, 'AssignationName', getNodeValue(oldConstr, 'params purpose')));
            const extension = getNodeValue(oldConstr, 'base_parameters extension');
            if (extension) {
                const keyParams = createElement(newDoc, NS.KPT, 'KeyParameters');
                const keyParam = createElement(newDoc, NS.OKS, 'ns4:KeyParameter');
                keyParam.setAttribute('Type', '01');
                keyParam.setAttribute('Value', extension);
                keyParams.appendChild(keyParam);
                constr.appendChild(keyParams);
            }
            constr.appendChild(createAddressNode(oldConstr.querySelector('address_location'), newDoc));
            const cost = getNodeValue(oldConstr, 'cost value');
            if(cost) {
                const costNode = createElement(newDoc, NS.KPT, 'CadastralCost');
                costNode.setAttribute('Value', cost); 
                costNode.setAttribute('Unit', '383');
                constr.appendChild(costNode);
            }
            const oldSpatial = oldConstr.querySelector('contours, entity_spatial');
            if (oldSpatial) constr.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
            objectRealty.appendChild(constr);
            objectsNode.appendChild(objectRealty);
        });
    }
    return objectsNode;
}

function convertSpatialData(oldBlock, newDoc, coordSystems, csCounter) {
    const spatialNode = createElement(newDoc, NS.KPT, 'SpatialData');
    const oldSpatial = oldBlock.querySelector(':scope > spatial_data > entity_spatial');
    if (oldSpatial) {
        spatialNode.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
    }
    return spatialNode;
}

function convertBounds(oldBlock, newDoc, coordSystems, csCounter) {
    const boundsNode = createElement(newDoc, NS.KPT, 'Bounds');
    oldBlock.querySelectorAll('municipal_boundary_record, inhabited_locality_boundary_record').forEach(oldBoundRec => {
        const boundNode = createElement(newDoc, NS.KPT, 'Bound');
        const bObject = oldBoundRec.querySelector('b_object');
        boundNode.appendChild(createElementWithText(newDoc, NS.KPT, 'Description', getNodeValue(bObject, 'type_boundary value')));
        boundNode.appendChild(createElementWithText(newDoc, NS.KPT, 'AccountNumber', getNodeValue(bObject, 'reg_numb_border')));
        const boundaries = createElement(newDoc, NS.KPT, 'Boundaries');
        const oldSpatial = oldBoundRec.querySelector('b_contours_location');
        if (oldSpatial) {
            const boundary = createElement(newDoc, NS.KPT, 'Boundary');
            boundary.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
            boundaries.appendChild(boundary);
        }
        appendChildIfNotEmpty(boundNode, boundaries);
        boundsNode.appendChild(boundNode);
    });
    return boundsNode;
}

function convertZones(oldBlock, newDoc, coordSystems, csCounter) {
    const zonesNode = createElement(newDoc, NS.KPT, 'Zones');
    oldBlock.querySelectorAll('zones_and_territories_record').forEach(oldZoneRec => {
        const zoneNode = createElement(newDoc, NS.KPT, 'Zone');
        const bObject = oldZoneRec.querySelector('b_object_zones_and_territories');
        zoneNode.appendChild(createElementWithText(newDoc, NS.KPT, 'Description', getNodeValue(bObject, 'type_boundary value')));
        zoneNode.appendChild(createElementWithText(newDoc, NS.KPT, 'AccountNumber', getNodeValue(bObject, 'b_object reg_numb_border')));
        const oldSpatial = oldZoneRec.querySelector('b_contours_location');
        if(oldSpatial) zoneNode.appendChild(createEntitySpatialNode(oldSpatial, newDoc, coordSystems, csCounter));
        const specialZone = createElement(newDoc, NS.KPT, 'SpecialZone');
        const content = `${getNodeValue(bObject, 'type_zone code')} ${getNodeValue(bObject, 'type_zone value')}`;
        specialZone.appendChild(createElementWithText(newDoc, NS.KPT, 'ContentRestrictions', content.trim()));
        zoneNode.appendChild(specialZone);
        zonesNode.appendChild(zoneNode);
    });
    return zonesNode;
}
</script>
</body>
</html> 
    
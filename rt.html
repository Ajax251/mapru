<!DOCTYPE html>
<html>
<head>
    <title>Районы и поселения РТ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="img/rt.png" type="image/png">
    <script src="webfonts/jszip.min.js"></script>
<link rel="stylesheet" href="webfonts/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #canvasContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #mapCanvas {
            width: 100%;
            height: 100%;
        }

        #tooltip {
            display: none;
            position: fixed;
            background: rgba(255, 255, 255, 0.8);
            color: royalblue;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s, visibility 0.3s;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #tooltip.active {
            display: block;
            opacity: 1;
        }

        #districtInfo {
            position: fixed;
            top: -100%;
            left: 20px;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15),
                        inset 0 1px 2px rgba(255,255,255,0.3);
            padding: 15px;
            width: 240px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #districtInfo.active {
            top: 20px;
            opacity: 1;
            transform: translateY(0);
        }

        #districtInfo h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 700;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: normal;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #districtInfo h3:hover {
            transform: scale(1.05);
        }

        .info-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.6);
            transition: all 0.3s ease;
        }

        .info-row:hover {
            background: rgba(33,150,243,0.1);
            transform: translateX(5px);
        }

        .info-icon {
            margin-right: 8px;
            color: #2196F3;
            font-size: 16px;
        }

        .info-row .label {
            font-weight: 500;
            color: #424242;
            flex: 1;
            font-size: 0.9em;
        }

        .info-row .value {
            color: #2196F3;
            font-weight: 600;
            font-size: 0.9em;
        }

        .center-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(33,150,243,0.1);
        }

        .center-title {
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            color: #1976D2;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .center-title:hover {
            color: #2196F3;
            transform: scale(1.05);
        }

        .settlements-button {
            margin-top: 15px;
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            color: white;
            font-weight: 500;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settlements-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33,150,243,0.3);
        }

        .settlements-button:active {
            transform: translateY(0);
        }

        /* Side Panel Styles */
        .side-panel-container {
            position: fixed;
            top: 0;
            right: -400px; /* Increased width */
            width: 350px;  /* Increased width */
            height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(10px);
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
            transition: right 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            border-left: 2px solid rgba(33,150,243,0.1);
            border-radius: 15px 0 0 15px;
        }

        .side-panel-container.active {
            right: 0;
        }

        .side-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            border-radius: 15px 0 0 0;
        }

        .close-panel {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-panel:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .search-container {
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid rgba(33, 150, 243, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-container input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 20px;
            background: white;
            transition: all 0.3s ease;
            margin-right: 10px;
            text-align: center;
        }

        .search-container input:focus {
            border-color: #2196F3;
            box-shadow: 0 0 10px rgba(33,150,243,0.2);
        }

        .search-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .search-icon:hover {
            transform: scale(1.1);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255,255,255,0.5);
        }

        .settlement-group {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .settlement-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(to right, #f8f9fa, #ffffff);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settlement-group-header:hover {
            background: linear-gradient(to right, #e9ecef, #f8f9fa);
        }

        .settlement-group-content {
            display: none;
            background: rgba(255,255,255,0.7);
        }

        .settlement-group-content.active {
            display: block;
        }

        .settlement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(33,150,243,0.1);
            transition: background 0.3s ease;
        }

        .settlement-item:last-child {
            border-bottom: none;
        }

        .settlement-group-header.selected {
            background: linear-gradient(45deg, rgba(33,150,243,0.2), rgba(0,188,212,0.2));
        }

        .header-content {
            padding: 12px 15px;
            display: flex; /* Changed from flex */
            align-items: center; /* Added */
            flex-grow: 1; /* Added to take up space */
            transition: all 0.3s ease;
            overflow: hidden; /* Prevent text overflow */
            white-space: nowrap; /* Keep text on one line */
            text-overflow: ellipsis; /* Add ellipsis if text overflows */
        }

        .header-content span {
            transition: color 0.3s ease;
            text-align: left; /* Ensure text aligns left */
        }


        .settlement-group-header.selected .header-content span {
            color: #2196F3;
        }

        .toggle-icon {
            transform: rotate(90deg);
            transition: transform 0.3s ease;
            font-size: 20px;
            color: #666;
            margin-left: auto; /* Push toggle icon to the right */
            padding-left: 5px; /* Space before toggle */
        }


        .settlement-group-header.active .toggle-icon {
            transform: rotate(270deg);
        }

        .settlement-group-header.selected .toggle-icon {
            color: #2196F3;
        }

        .settlement-item:hover {
            background: rgba(33,150,243,0.05);
        }

        .rules-icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            cursor: pointer;
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        .rules-icon:hover {
            opacity: 1;
        }

        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(33,150,243,0.1);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #2196F3;
            border-radius: 4px;
        }

        #coordinates {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: nowrap;
        }

        .search-rules-icon, .open-rules-icon { /* Apply to both icons */
            transition: all 0.3s ease;
            opacity: 0.7;
            cursor: pointer; /* Ensure cursor indicates interactivity */
            flex-shrink: 0; /* Prevent icons shrinking */
            display: none; /* Hide initially */
            margin-left: 5px; /* Space between icons */
            vertical-align: middle; /* Align icons vertically */
            height: 20px; /* Explicit height */
            width: 20px; /* Explicit width */
        }

        .search-rules-icon:hover, .open-rules-icon:hover { /* Apply to both icons */
            opacity: 1;
        }

        .photo-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 98%;
            height: 98%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            z-index: 900;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease-in-out;
            overflow: hidden;
            touch-action: none;
        }

        .photo-container.active {
            display: block;
        }

        .district-photo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            cursor: grab;
        }

        .district-photo.grabbing {
            cursor: grabbing;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .search-result-item {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f0f7ff;
        }

        .search-result-item:active {
            background-color: #e6f0ff;
        }

        .settlement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
        }

        .settlement-item-content {
            flex: 1;
            text-align: center; /* Keep centered */
            padding: 5px 0;
            overflow: hidden; /* Prevent overflow */
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 5px; /* Add space before icon */
        }

        .rules-icon-small {
            width: 18px;
            height: 18px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-content {
            flex: 1;
        }

        .search-result-district {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }
         /* --- NEW ICON STYLE --- */
.open-rules-icon {
    /* Use existing size or adjust if needed */
    /* content: url("..."); REMOVE THIS LINE */
    filter: contrast(0.8); /* Slightly dim */
    /* Keep other styles like width, height, vertical-align, margin, etc. */
    width: 20px; /* Explicit width */
    height: 20px; /* Explicit height */
    vertical-align: middle; /* Align icons vertically */
    margin-left: 5px; /* Space between icons */
    flex-shrink: 0; /* Prevent shrinking */
    cursor: pointer; /* Ensure cursor indicates interactivity */
    display: none; /* Controlled by JS */
 }
 .open-rules-icon:hover {
    filter: contrast(1); /* Full brightness on hover */
}
        /* --- END NEW ICON STYLE --- */

        /* Adjust header layout */
        .settlement-group-header {
            display: flex;
            align-items: center; /* Vertically center items */
        }

        .header-content {
            flex-grow: 1; /* Allow content to take available space */
            margin-right: 5px; /* Space before icons */
            padding: 0; /* Remove default padding */
            text-align: left; /* Align text left */
        }

         /* Container for the right-side icons in the header */
        .header-icons-container {
            display: flex;
            align-items: center;
            margin-left: auto; /* Push icons to the far right */
            flex-shrink: 0; /* Prevent shrinking */
        }
    </style>
</head>
<body>
    <div id="coordinates" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; display: none; z-index: 1000;"></div>
    <div id="canvasContainer">
        <canvas id="mapCanvas"></canvas>
        <div id="tooltip"></div>
        <div id="districtInfo"></div>
    </div>

    <div id="sidePanelContainer" class="side-panel-container">
        <div class="side-panel">
            <div class="panel-header">
                <button class="close-panel">×</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchSettlements" placeholder="Поиск населенного пункта...">
                <div class="search-icon">🔍</div>
            </div>
            <div class="panel-content">
                <div id="searchResults" class="search-results"></div>
                <div id="settlementsList"></div>
            </div>
        </div>
    </div>

    <script>
              const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const districtInfo = document.getElementById('districtInfo');

        const districts = [
            { xMin: 48, xMax: 53, yMin: 26, yMax: 40, name: 'Аксубаевский район' },
            { xMin: 41, xMax: 46, yMin: 38, yMax: 49, name: 'Алексеевский район' },
            { xMin: 35, xMax: 43, yMin: 22, yMax: 39, name: 'Алькеевский район' },
            { xMin: 65, xMax: 77, yMin: 17, yMax: 30, name: 'Лениногорский район' },
            { xMin: 52, xMax: 61, yMin: 35, yMax: 47, name: 'Новошешминский район' },
            { xMin: 44, xMax: 53, yMin: 16, yMax: 25, name: 'Нурлатский район' },
            { xMin: 25, xMax: 35, yMin: 32, yMax: 43, name: 'Спасский район' },
            { xMin: 55, xMax: 65, yMin: 24, yMax: 35, name: 'Черемшанский район' },
            { xMin: 46, xMax: 53, yMin: 42, yMax: 52, name: 'Чистопольский район' }
        ];

        const districtPhotos = {
            'Аксубаевский район': 'img/rt/1603.jpg',
            'Алексеевский район': 'img/rt/1605.jpg',
            'Алькеевский район': 'img/rt/1606.jpg',
            'Нурлатский район': 'img/rt/1632.png',
            'Лениногорский район': 'img/rt/1625.jpg',
            'Спасский район': 'img/rt/1637.jpg',
            'Черемшанский район': 'img/rt/1641.jpg',
            'Чистопольский район': 'img/rt/1642.jpg'
        };

        const districtData = {
            'Агрызский район': { area: '1860 км²', population: '34,692', center: 'Агрыз', centerArea: '43 км²', centerPopulation: '19,860', distanceToKazan: '320 км' },
            'Азнакаевский район': { area: '2140 км²', population: '58,966', center: 'Азнакаево', centerArea: '20 км²', centerPopulation: '34,750', distanceToKazan: '350 км' },
            'Аксубаевский район': { area: '1450 км²', population: '27,102', center: 'пгт Аксубаево', centerArea: '7 км²', centerPopulation: '9,242', distanceToKazan: '180 км' },
            'Актанышский район': { area: '2060 км²', population: '28,534', center: 'Актаныш', centerArea: '12 км²', centerPopulation: '8,022', distanceToKazan: '300 км' },
            'Алексеевский район': { area: '2080 км²', population: '24,924', center: 'пгт Алексеевское', centerArea: '15 км²', centerPopulation: '11,613', distanceToKazan: '90 км' },
            'Алькеевский район': { area: '1860 км²', population: '18,481', center: 'с Базарные Матаки', centerArea: '10 км²', centerPopulation: '6,800', distanceToKazan: '140 км' },
            'Альметьевский район': { area: '2510 км²', population: '213,235', center: 'Альметьевск', centerArea: '23 км²', centerPopulation: '173,321', distanceToKazan: '270 км' },
            'Апастовский район': { area: '1070 км²', population: '19,093', center: 'Апастово', centerArea: '5 км²', centerPopulation: '5,119', distanceToKazan: '120 км' },
            'Арский район': { area: '1870 км²', population: '51,031', center: 'Арск', centerArea: '19 км²', centerPopulation: '20,421', distanceToKazan: '140 км' },
            'Атнинский район': { area: '730 км²', population: '12,553', center: 'Большая Атня', centerArea: '5 км²', centerPopulation: '4,200', distanceToKazan: '180 км' },
            'Бавлинский район': { area: '1220 км²', population: '33,581', center: 'Бавлы', centerArea: '11 км²', centerPopulation: '21,628', distanceToKazan: '300 км' },
            'Балтасинский район': { area: '1670 км²', population: '33,229', center: 'Балтаси', centerArea: '8 км²', centerPopulation: '8,180', distanceToKazan: '160 км' },
            'Бугульминский район': { area: '1400 км²', population: '101,975', center: 'Бугульма', centerArea: '38 км²', centerPopulation: '81,677', distanceToKazan: '290 км' },
            'Буинский район': { area: '1590 км²', population: '40,172', center: 'Буинск', centerArea: '15 км²', centerPopulation: '19,968', distanceToKazan: '170 км' },
            'Верхнеуслонский район': { area: '1270 км²', population: '17,495', center: 'Верхний Услон', centerArea: '10 км²', centerPopulation: '5,100', distanceToKazan: '30 км' },
            'Высокогорский район': { area: '1710 км²', population: '56,047', center: 'Высокая Гора', centerArea: '12 км²', centerPopulation: '17,736', distanceToKazan: '25 км' },
            'Дрожжановский район': { area: '1350 км²', population: '20,994', center: 'Старое Дрожжаное', centerArea: '7 км²', centerPopulation: '5,400', distanceToKazan: '270 км' },
            'Елабужский район': { area: '1360 км²', population: '85,475', center: 'Елабуга', centerArea: '43 км²', centerPopulation: '73,630', distanceToKazan: '200 км' },
            'Заинский район': { area: '2140 км²', population: '53,731', center: 'Заинск', centerArea: '76 км²', centerPopulation: '39,739', distanceToKazan: '160 км' },
            'Зеленодольский район': { area: '1380 км²', population: '169,469', center: 'Зеленодольск', centerArea: '38 км²', centerPopulation: '99,137', distanceToKazan: '35 км' },
            'Кайбицкий район': { area: '1720 км²', population: '12,907', center: 'Большие Кайбицы', centerArea: '6 км²', centerPopulation: '1,400', distanceToKazan: '110 км' },
            'Камско-Устьинский район': { area: '1220 км²', population: '14,460', center: 'Камское Устье', centerArea: '14 км²', centerPopulation: '4,391', distanceToKazan: '130 км' },
            'Кукморский район': { area: '1490 км²', population: '51,693', center: 'Кукмор', centerArea: '22 км²', centerPopulation: '17,886', distanceToKazan: '150 км' },
            'Лаишевский район': { area: '2220 км²', population: '61,794', center: 'Лаишево', centerArea: '7 км²', centerPopulation: '9,076', distanceToKazan: '50 км' },
            'Лениногорский район': { area: '1690 км²', population: '79,506', center: 'г Лениногорск', centerArea: '25 км²', centerPopulation: '60,993', distanceToKazan: '290 км' },
            'Мамадышский район': { area: '2610 км²', population: '40,625', center: 'Мамадыш', centerArea: '14 км²', centerPopulation: '15,726', distanceToKazan: '180 км' },
            'Менделеевский район': { area: '1420 км²', population: '30,839', center: 'Менделеевск', centerArea: '24 км²', centerPopulation: '22,875', distanceToKazan: '240 км' },
            'Мензелинский район': { area: '1980 км²', population: '27,131', center: 'Мензелинск', centerArea: '8 км²', centerPopulation: '16,008', distanceToKazan: '290 км' },
            'Муслюмовский район': { area: '1470 км²', population: '19,109', center: 'Муслюмово', centerArea: '10 км²', centerPopulation: '3,400', distanceToKazan: '230 км' },
            'Нижнекамский район': { area: '1720 км²', population: '277,544', center: 'Нижнекамск', centerArea: '61 км²', centerPopulation: '241,479', distanceToKazan: '230 км' },
            'Новошешминский район': { area: '1330 км²', population: '13,282', center: 'с Новошешминск', centerArea: '7 км²', centerPopulation: '4,800', distanceToKazan: '200 км' },
            'Нурлатский район': { area: '2320 км²', population: '53,200', center: 'г Нурлат', centerArea: '22 км²', centerPopulation: '33,990', distanceToKazan: '220 км' },
            'Пестречинский район': { area: '1370 км²', population: '62,094', center: 'Пестрецы', centerArea: '10 км²', centerPopulation: '11,601', distanceToKazan: '40 км' },
            'Рыбно-Слободский район': { area: '1870 км²', population: '24,340', center: 'Рыбная Слобода', centerArea: '13 км²', centerPopulation: '7,590', distanceToKazan: '100 км' },
            'Сабинский район': { area: '1140 км²', population: '30,586', center: 'Богатые Сабы', centerArea: '7 км²', centerPopulation: '8,828', distanceToKazan: '100 км' },
            'Сармановский район': { area: '1510 км²', population: '34,655', center: 'Сарманово', centerArea: '6 км²', centerPopulation: '7,300', distanceToKazan: '220 км' },
            'Спасский район': { area: '1980 км²', population: '18,405', center: 'г Болгар', centerArea: '11 км²', centerPopulation: '8,285', distanceToKazan: '200 км' },
            'Тетюшский район': { area: '1610 км²', population: '20,648', center: 'Тетюши', centerArea: '14 км²', centerPopulation: '10,535', distanceToKazan: '180 км' },
            'Тукаевский район': { area: '1750 км²', population: '46,760', center: 'Набережные Челны', centerArea: '177 км²', centerPopulation: '545,750', distanceToKazan: '220 км' },
            'Тюлячинский район': { area: '1210 км²', population: '13,736', center: 'Тюлячи', centerArea: '6 км²', centerPopulation: '3,800', distanceToKazan: '150 км' },
            'Черемшанский район': { area: '1490 км²', population: '18,371', center: 'с Черемшан', centerArea: '8 км²', centerPopulation: '7,100', distanceToKazan: '230 км' },
            'Чистопольский район': { area: '1830 км²', population: '74,685', center: 'г Чистополь', centerArea: '20 км²', centerPopulation: '58,815', distanceToKazan: '130 км' },
            'Ютазинский район': { area: '1920 км²', population: '20,116', center: 'Уруссу', centerArea: '7 км²', centerPopulation: '10,520', distanceToKazan: '280 км' }
        };

        const districtUrls = {
            'Нурлатский район': 'https://nurlat.tatarstan.ru/nurlat_poselenia.htm',
            'Аксубаевский район': 'https://aksubayevo.tatarstan.ru/aksubayevo/poselenia.htm',
            'Чистопольский район': 'https://chistopol.tatarstan.ru/poselenia.htm',
            'Алексеевский район': 'https://alekseevskiy.tatarstan.ru/about/municipal_formations.htm',
            'Новошешминский район': 'https://novosheshminsk.tatarstan.ru/about/municipal_formations2.htm',
            'Черемшанский район': 'https://cheremshan.tatarstan.ru/mobr.htm',
            'Лениногорский район': 'https://leninogorsk.tatarstan.ru/rural_settlements.htm',
            'Алькеевский район': 'https://alkeevskiy.tatarstan.ru/spmun.htm',
            'Спасский район': 'https://spasskiy.tatarstan.ru/munobr.htm'
        };

        const centerUrls = {
            'пгт Аксубаево': 'https://aksubayevo.tatarstan.ru/pravila-zemlepolzovaniya-i-zastroyki-1359837.htm',
            'пгт Алексеевское': 'https://alekseevskiy.tatarstan.ru/gradoctroutel.htm',
            'с Базарные Матаки': 'https://alkeevskiy.tatarstan.ru/ppz.htm',
            'г Болгар': 'https://spasskiy.tatarstan.ru/karta-planiruemogo-razmeshcheniya-obektov.htm',
            'г Лениногорск': 'https://leninogorsk.tatarstan.ru/pravila.htm',
            'г Нурлат': 'https://nurlat.tatarstan.ru/pravila-zemlepolzovaniya-i-zastroyki-munitsipalnog.htm',
            'с Новошешминск': 'https://novosheshminsk.tatarstan.ru/gradostroitelstvo.htm',
            'с Черемшан': 'https://cheremshan.tatarstan.ru/kontseptsiya-pravil-zemlepolzovaniya-i-zastroyki.htm',
            'г Чистополь': 'https://chistopol.tatarstan.ru/pravila-zemlepolzovaniya-i-zastroyki.htm'
        };

        let settlementData = {};
        let settlementUrls = {};

        async function loadSettlementData() {
            try {
                const response = await fetch('sprt.zip');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const zipData = await response.arrayBuffer();
                const zip = new JSZip();
                const contents = await zip.loadAsync(zipData);

                const firstFileName = Object.keys(contents.files)[0];
                if (!firstFileName || contents.files[firstFileName].dir) {
                    console.error('No valid file found in the zip archive.');
                    return;
                }
                const textContent = await contents.files[firstFileName].async('string');

                const lines = textContent.split('\n');
                let isUrlsSection = false;

                lines.forEach(line => {
                    line = line.trim();
                    if (line === '#') {
                        isUrlsSection = true;
                        return;
                    }
                    if (!line) return;

                    const parts = line.split('\t').map(item => item.trim());

                    if (isUrlsSection) {
                        if (parts.length >= 3) {
                            const [district, settlement, url1, url2] = parts;
                             if (district && settlement) {
                                const key = `${district}|${settlement}`;
                                settlementUrls[key] = {
                                     urls: [url1, url2].filter(url => url && url.length > 0 && url.startsWith('http'))
                                };
                            }
                        } else {
                             // console.warn("Skipping invalid URL line:", line); // Removed log
                        }
                    } else {
                        if (parts.length === 3) {
                            const [district, settlement, village] = parts;
                            if (!settlementData[district]) {
                                settlementData[district] = {};
                            }
                            if (!settlementData[district][settlement]) {
                                settlementData[district][settlement] = [];
                            }
                            if (!settlementData[district][settlement].includes(village)) {
                                settlementData[district][settlement].push(village);
                            }
                        } else {
                             // console.warn("Skipping invalid settlement line:", line); // Removed log
                        }
                    }
                });

                Object.values(settlementData).forEach(districtSettlements => {
                    Object.values(districtSettlements).forEach(villages => {
                        villages.sort((a, b) => a.localeCompare(b, 'ru'));
                    });
                });

                console.log('Данные о поселениях и URL загружены успешно.');

            } catch (error) {
                console.error('Ошибка при загрузке данных о поселениях:', error);
            }
        }

        const photoContainer = document.createElement('div');
        photoContainer.className = 'photo-container';
        photoContainer.innerHTML = `
            <img class="district-photo" src="" alt="District Photo">
        `;
        document.body.appendChild(photoContainer);


        let currentScale = 1;
        let isDragging = false;
        let startX, startY;
        let translateX = 0, translateY = 0;
        let lastTranslateX = 0, lastTranslateY = 0;
        const photo = photoContainer.querySelector('.district-photo');
        const MIN_SCALE = 1;
        const MAX_SCALE = 5;
        const SCALE_STEP = 0.2;

        function updateTransform() {
            constrainTranslation();
            photo.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        }

        function constrainTranslation() {
            if (currentScale <= MIN_SCALE) {
                translateX = 0;
                translateY = 0;
                return;
            }
            const rect = photo.getBoundingClientRect();
            const containerRect = photoContainer.getBoundingClientRect();
            const scaledWidth = photo.naturalWidth * currentScale;
            const scaledHeight = photo.naturalHeight * currentScale;
            const maxOverhangX = Math.max(0, (scaledWidth - containerRect.width) / 2);
            const maxOverhangY = Math.max(0, (scaledHeight - containerRect.height) / 2);
            translateX = Math.max(-maxOverhangX, Math.min(maxOverhangX, translateX));
            translateY = Math.max(-maxOverhangY, Math.min(maxOverhangY, translateY));
        }

        photoContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = photoContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const mouseXRel = mouseX - (rect.width / 2);
            const mouseYRel = mouseY - (rect.height / 2);
            const delta = e.deltaY > 0 ? -1 : 1;
            const zoomIntensity = 0.15;
            const scaleFactor = 1 + delta * zoomIntensity;
            const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale * scaleFactor));

            if (newScale === currentScale) return;

            const scaleChange = newScale / currentScale;
            translateX = (1 - scaleChange) * (mouseX - rect.width / 2 - translateX) + translateX;
            translateY = (1 - scaleChange) * (mouseY - rect.height / 2 - translateY) + translateY;
            currentScale = newScale;
             if (currentScale <= MIN_SCALE) {
                translateX = 0;
                translateY = 0;
            }
            updateTransform();
        }, { passive: false });

        photo.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            isDragging = true;
            photo.classList.add('grabbing');
            photo.style.transition = 'none';
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        document.addEventListener('mouseup', (e) => {
            if (isDragging && e.button === 0) {
                isDragging = false;
                photo.classList.remove('grabbing');
                photo.style.transition = 'transform 0.1s ease-out';
                lastTranslateX = translateX;
                lastTranslateY = translateY;
            }
        });

        document.addEventListener('mouseleave', (e) => {
            if (isDragging) {
                isDragging = false;
                photo.classList.remove('grabbing');
                photo.style.transition = 'transform 0.1s ease-out';
                lastTranslateX = translateX;
                lastTranslateY = translateY;
            }
        });

        let lastTouchDistance = 0;
        let initialScale = 1;
        let pinchCenter = { x: 0, y: 0 };

        photoContainer.addEventListener('touchstart', (e) => {
             photo.style.transition = 'none';
            if (e.touches.length === 2) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                initialScale = currentScale;
                const rect = photoContainer.getBoundingClientRect();
                pinchCenter.x = ((touch1.clientX + touch2.clientX) / 2) - rect.left;
                pinchCenter.y = ((touch1.clientY + touch2.clientY) / 2) - rect.top;
            } else if (e.touches.length === 1) {
                isDragging = true;
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
            }
        }, { passive: false });

        photoContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                const scaleFactor = currentDistance / lastTouchDistance;
                let newScale = initialScale * scaleFactor;
                newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));

                if (newScale !== currentScale) {
                    const scaleChangeRatio = newScale / currentScale;
                    const rect = photoContainer.getBoundingClientRect();
                    translateX = (1 - scaleChangeRatio) * (pinchCenter.x - rect.width / 2 - translateX) + translateX;
                    translateY = (1 - scaleChangeRatio) * (pinchCenter.y - rect.height / 2 - translateY) + translateY;
                    currentScale = newScale;
                    updateTransform();
                }
            } else if (isDragging && e.touches.length === 1) {
                e.preventDefault();
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                updateTransform();
            }
        }, { passive: false });

        photoContainer.addEventListener('touchend', (e) => {
             photo.style.transition = 'transform 0.1s ease-out';
            if (e.touches.length < 2) {
                lastTouchDistance = 0;
            }
            if (e.touches.length < 1) {
                isDragging = false;
            }
            lastTranslateX = translateX;
            lastTranslateY = translateY;

            if (currentScale < MIN_SCALE) {
                closePhotoViewer();
            } else {
                updateTransform();
            }
        });

        function closePhotoViewer() {
             photoContainer.classList.remove('active');
             currentScale = 1;
             translateX = 0;
             translateY = 0;
             photo.style.transition = 'transform 0.3s ease-out';
             updateTransform();
             setTimeout(() => {
                 if (!isDragging) photo.style.transition = 'transform 0.1s ease-out';
             }, 300);
        }

        photoContainer.addEventListener('dblclick', closePhotoViewer);

        function resetPhotoView() {
             currentScale = 1;
             translateX = 0;
             translateY = 0;
             photo.style.transition = 'none';
             updateTransform();
             setTimeout(() => {
                photo.style.transition = 'transform 0.1s ease-out';
             }, 10);
        }

        function showDistrictPhoto(url) {
            const photo = photoContainer.querySelector('.district-photo');
            photo.src = url;

            const displayAndReset = () => {
                photoContainer.classList.add('active');
                resetPhotoView();
            };

            photo.onload = displayAndReset;
            photo.onerror = () => {
                console.error("Failed to load district photo:", url);
                photoContainer.classList.remove('active');
            }
            if (photo.complete && photo.naturalWidth > 0) {
                displayAndReset();
            } else if (photo.complete && photo.naturalWidth === 0) {
                 photo.onerror();
            }
        }

        const img = new Image();
        img.src = 'img/rt/maprt.jpg';
        img.onload = function() {
            resizeCanvas();
            drawMap();
        };

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawMap();
        }

        function drawMap() {
            if (!img.complete || img.naturalWidth === 0) return { x: 0, y: 0, width: 0, height: 0, scale: 1 };

            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const imgWidth = img.naturalWidth;
            const imgHeight = img.naturalHeight;

            const hRatio = canvasWidth / imgWidth;
            const vRatio = canvasHeight / imgHeight;
            const ratio = Math.min(hRatio, vRatio);

            const drawWidth = imgWidth * ratio;
            const drawHeight = imgHeight * ratio;

            const x = (canvasWidth - drawWidth) / 2;
            const y = (canvasHeight - drawHeight) / 2;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            ctx.drawImage(img, 0, 0, imgWidth, imgHeight, x, y, drawWidth, drawHeight);

            return { x, y, width: drawWidth, height: drawHeight, scale: ratio };
        }

        let clickTimer = null;
        let preventSingleClick = false;

        canvas.addEventListener('click', function(e) {
             if (preventSingleClick) {
                 preventSingleClick = false;
                 return;
             }

             clearTimeout(clickTimer);
             clickTimer = setTimeout(() => {
                 if (!preventSingleClick) {
                     const rect = canvas.getBoundingClientRect();
                     const mapDimensions = drawMap();
                     if (mapDimensions.width === 0) return;

                     const clickX = e.clientX - rect.left;
                     const clickY = e.clientY - rect.top;
                     const normalizedX = (clickX - mapDimensions.x) / mapDimensions.width * 100;
                     const normalizedY = 100 - ((clickY - mapDimensions.y) / mapDimensions.height * 100);

                     let clickedDistrict = districts.find(district =>
                         normalizedX >= district.xMin &&
                         normalizedX <= district.xMax &&
                         normalizedY >= district.yMin &&
                         normalizedY <= district.yMax
                     );

                     if (clickedDistrict) {
                         updateDistrictInfo(clickedDistrict);
                         if (districtPhotos[clickedDistrict.name]) {
                             showDistrictPhoto(districtPhotos[clickedDistrict.name]);
                         }
                     } else {
                         districtInfo.classList.remove('active');
                     }
                 }
             }, 250);
        });

        canvas.addEventListener('dblclick', function(e) {
             clearTimeout(clickTimer);
             preventSingleClick = true;

             const rect = canvas.getBoundingClientRect();
             const mapDimensions = drawMap();
             if (mapDimensions.width === 0) return;

             const clickX = e.clientX - rect.left;
             const clickY = e.clientY - rect.top;

             const normalizedX = (clickX - mapDimensions.x) / mapDimensions.width * 100;
             const normalizedY = 100 - ((clickY - mapDimensions.y) / mapDimensions.height * 100);

             let clickedDistrict = districts.find(district =>
                 normalizedX >= district.xMin &&
                 normalizedX <= district.xMax &&
                 normalizedY >= district.yMin &&
                 normalizedY <= district.yMax
             );

             if (clickedDistrict && districtUrls[clickedDistrict.name]) {
                 window.open(districtUrls[clickedDistrict.name], '_blank');
             }
         });

        function initializeSearch() {
             const searchInput = document.getElementById('searchSettlements');
             const searchResultsContainer = document.getElementById('searchResults');
             const settlementsListContainer = document.getElementById('settlementsList');
             const searchIcon = document.querySelector('.search-icon');

            function replaceEnglishWithRussian(text) {
                 const map = { 'q': 'й', 'w': 'ц', 'e': 'у', 'r': 'к', 't': 'е', 'y': 'н', 'u': 'г', 'i': 'ш', 'o': 'щ', 'p': 'з', '[': 'х', ']': 'ъ', 'a': 'ф', 's': 'ы', 'd': 'в', 'f': 'а', 'g': 'п', 'h': 'р', 'j': 'о', 'k': 'л', 'l': 'д', ';': 'ж', '\'': 'э', 'z': 'я', 'x': 'ч', 'c': 'с', 'v': 'м', 'b': 'и', 'n': 'т', 'm': 'ь', ',': 'б', '.': 'ю', '/': '.', '`': 'ё', 'Q': 'Й', 'W': 'Ц', 'E': 'У', 'R': 'К', 'T': 'Е', 'Y': 'Н', 'U': 'Г', 'I': 'Ш', 'O': 'Щ', 'P': 'З', '{': 'Х', '}': 'Ъ', 'A': 'Ф', 'S': 'Ы', 'D': 'В', 'F': 'А', 'G': 'П', 'H': 'Р', 'J': 'О', 'K': 'Л', 'L': 'Д', ':': 'Ж', '"': 'Э', 'Z': 'Я', 'X': 'Ч', 'C': 'С', 'V': 'М', 'B': 'И', 'N': 'Т', 'M': 'Ь', '<': 'Б', '>': 'Ю', '?': ',', '~': 'Ё' };
                 return text.split('').map(char => map[char] || char).join('');
             }

             function performSearch() {
                 const searchTerm = searchInput.value.toLowerCase().trim();

                 if (searchTerm.length < 2) {
                     searchResultsContainer.innerHTML = '';
                     searchResultsContainer.classList.remove('active');
                     settlementsListContainer.style.display = 'block';
                     return;
                 }

                 const results = [];
                 Object.entries(settlementData).forEach(([district, settlements]) => {
                     Object.entries(settlements).forEach(([settlement, villages]) => {
                         villages.forEach(village => {
                             if (village.toLowerCase().includes(searchTerm)) {
                                let score = 0;
                                if (village.toLowerCase() === searchTerm) score = 10;
                                else if (village.toLowerCase().startsWith(searchTerm)) score = 5;
                                else score = 1;

                                results.push({
                                    type: 'village',
                                    village: village,
                                    settlement: settlement,
                                    district: district,
                                    score: score
                                 });
                             }
                         });
                        if (settlement.toLowerCase().includes(searchTerm)) {
                           let score = 0;
                           if (settlement.toLowerCase() === searchTerm) score = 8;
                           else if (settlement.toLowerCase().startsWith(searchTerm)) score = 4;
                           else score = 0.5;
                           results.push({
                               type: 'settlement',
                               settlement: settlement,
                               district: district,
                               score: score
                           });
                         }
                     });
                 });

                 results.sort((a, b) => {
                     if (b.score !== a.score) {
                         return b.score - a.score;
                     }
                     const nameA = a.type === 'village' ? a.village : a.settlement;
                     const nameB = b.type === 'village' ? b.village : b.settlement;
                     return nameA.localeCompare(nameB, 'ru');
                 });

                 if (results.length > 0) {
                    searchResultsContainer.innerHTML = results.map(result => {
                        const urlKey = `${result.district}|${result.settlement}`;
                        const hasUrls = settlementUrls[urlKey] && settlementUrls[urlKey].urls.length > 0;

                        let mainText = '';
                        let subText = '';

                        if (result.type === 'village') {
                            mainText = result.village;
                            subText = `${result.settlement}, ${result.district}`;
                        } else {
                            mainText = result.settlement;
                            subText = `${result.district}`;
                        }

                         return `
                             <div class="search-result-item" data-district="${result.district}" data-settlement="${result.settlement}" data-village="${result.village || ''}">
                                 <div class="search-result-content">
                                     <div>${mainText}</div>
                                     <div class="search-result-district">${subText}</div>
                                 </div>
                                 ${hasUrls ? `<img src="https://img.icons8.com/material-outlined/24/000000/document.png"
                                     class="rules-icon rules-icon-small search-item-rules-icon"
                                     title="Открыть ПЗЗ поселения"
                                     data-settlement="${result.settlement}"
                                     data-district="${result.district}">` : ''}
                             </div>
                         `;
                    }).join('');

                    searchResultsContainer.classList.add('active');
                    settlementsListContainer.style.display = 'none';

                    searchResultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (e.target.classList.contains('search-item-rules-icon')) {
                                return;
                            }

                            const districtName = this.dataset.district;
                            const settlementName = this.dataset.settlement;

                            const clickedDistrict = districts.find(d => d.name === districtName);
                            if (clickedDistrict) {
                                updateDistrictInfo(clickedDistrict);
                                if (districtPhotos[districtName]) {
                                     showDistrictPhoto(districtPhotos[districtName]);
                                }
                            }
                        });
                    });

                    searchResultsContainer.querySelectorAll('.search-item-rules-icon').forEach(icon => {
                        icon.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const district = icon.dataset.district;
                            const settlement = icon.dataset.settlement;
                            const urlKey = `${district}|${settlement}`;
                             if (settlementUrls[urlKey] && settlementUrls[urlKey].urls) {
                                 settlementUrls[urlKey].urls.forEach(url => window.open(url, '_blank'));
                             } else {
                                 console.warn(`No URLs found for key: ${urlKey}`);
                             }
                        });
                    });


                 } else {
                     searchResultsContainer.innerHTML = '<div class="search-result-item no-results">Ничего не найдено</div>';
                     searchResultsContainer.classList.add('active');
                     settlementsListContainer.style.display = 'none';
                 }
             }


             searchInput.addEventListener('input', function() {
                 const cursorPosition = this.selectionStart;
                 const originalValue = this.value;
                 const convertedText = replaceEnglishWithRussian(originalValue);
                 if (convertedText !== originalValue) {
                     this.value = convertedText;
                    this.setSelectionRange(cursorPosition, cursorPosition);
                 }
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(performSearch, 250);
             });

             searchIcon.addEventListener('click', performSearch);

             searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(this.searchTimeout);
                    performSearch();
                }
            });
         }

         document.addEventListener('DOMContentLoaded', () => {
             loadSettlementData().then(() => {
                 initializeSearch();
             });
         });

        function updateDistrictInfo(clickedDistrict) {
            const data = districtData[clickedDistrict.name];
            if (!data) {
                 districtInfo.innerHTML = `<h3>${clickedDistrict.name}</h3><p>Подробная информация отсутствует.</p>`;
                 districtInfo.classList.add('active');
                const oldButton = districtInfo.querySelector('.settlements-button');
                if (oldButton) oldButton.replaceWith(oldButton.cloneNode(true));
                return;
            }

            districtInfo.innerHTML = `
                <h3 title="Закрыть панель">
                    <i class="fas fa-map-marked-alt" style="margin-right: 10px; color: #2196F3;"></i>
                    ${clickedDistrict.name}
                </h3>

                <div class="info-row">
                    <i class="info-icon fas fa-vector-square"></i>
                    <span class="label">Площадь</span>
                    <span class="value">${data.area || 'н/д'}</span>
                </div>

                <div class="info-row">
                    <i class="info-icon fas fa-users"></i>
                    <span class="label">Население</span>
                    <span class="value">${data.population || 'н/д'}</span>
                </div>

                <div class="center-section">
                    <div class="center-title" title="Найти ${data.center} на Яндекс Картах">
                        <i class="fas fa-city" style="margin-right: 5px;"></i> ${data.center || 'н/д'}
                        ${centerUrls[data.center] ? `<img src="https://img.icons8.com/?size=20&id=jFUfeIWcZ6hK&format=png&color=2196F3" alt="ПЗЗ" title="Открыть ПЗЗ" style="margin-left: 8px; vertical-align: middle; cursor:pointer;" class="center-pzz-icon">` : ''}
                    </div>

                    <div class="info-row">
                        <i class="info-icon fas fa-chart-area"></i>
                        <span class="label">Площадь</span>
                        <span class="value">${data.centerArea || 'н/д'}</span>
                    </div>

                    <div class="info-row">
                        <i class="info-icon fas fa-user-friends"></i>
                        <span class="label">Население</span>
                        <span class="value">${data.centerPopulation || 'н/д'}</span>
                    </div>
                </div>

                <button class="settlements-button">
                    <i class="fas fa-list-ul"></i>
                    Поселения района
                </button>
            `;

            districtInfo.classList.add('active');

            const districtTitle = districtInfo.querySelector('h3');
            districtTitle.addEventListener('click', () => {
                districtInfo.classList.remove('active');
            });

            const centerTitleText = districtInfo.querySelector('.center-title');
             centerTitleText.addEventListener('click', (e) => {
                 if (!e.target.classList.contains('center-pzz-icon')) {
                    const mapSearchQuery = encodeURIComponent(`${data.center} ${clickedDistrict.name}`);
                     window.open(`https://yandex.ru/maps/?text=${mapSearchQuery}`, '_blank');
                 }
             });

             const centerPzzIcon = districtInfo.querySelector('.center-pzz-icon');
             if (centerPzzIcon) {
                 centerPzzIcon.addEventListener('click', (e) => {
                     e.stopPropagation();
                     if (centerUrls[data.center]) {
                         window.open(centerUrls[data.center], '_blank');
                     }
                 });
             }

            const settlementButton = districtInfo.querySelector('.settlements-button');
            settlementButton.addEventListener('click', () => {
                const searchInput = document.getElementById('searchSettlements');
                const searchResults = document.getElementById('searchResults');
                searchInput.value = '';
                searchResults.innerHTML = '';
                searchResults.classList.remove('active');

                showSettlements(clickedDistrict.name);
            });
        }

        function showSettlements(districtName) {
            const sidePanel = document.getElementById('sidePanelContainer');
            const settlementsList = document.getElementById('settlementsList');
            const searchInput = document.getElementById('searchSettlements');
            const searchResults = document.getElementById('searchResults');

            searchInput.value = '';
            searchResults.innerHTML = '';
            searchResults.classList.remove('active');

            settlementsList.innerHTML = '';
            settlementsList.style.display = 'block';

            const districtSettlements = settlementData[districtName];

            if (!districtSettlements || Object.keys(districtSettlements).length === 0) {
                settlementsList.innerHTML = `<div class="no-data" style="padding: 15px; text-align: center; color: #777;">Нет данных о поселениях для ${districtName}.</div>`;
                sidePanel.classList.add('active');
                return;
            }

            const sortedSettlements = Object.entries(districtSettlements).sort((a, b) => a[0].localeCompare(b[0], 'ru'));

             sortedSettlements.forEach(([settlement, villages]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'settlement-group';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'settlement-group-header';

                const headerContent = document.createElement('div');
                headerContent.className = 'header-content';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = settlement;
                titleSpan.title = settlement;
                headerContent.appendChild(titleSpan);

                const iconsContainer = document.createElement('div');
                iconsContainer.className = 'header-icons-container';

                const searchRulesIcon = document.createElement('div');
                searchRulesIcon.className = 'search-rules-icon';
                searchRulesIcon.innerHTML = '🌐';
                searchRulesIcon.title = `Искать "${settlement}" на tatarstan.ru`;
                searchRulesIcon.style.display = 'none';

                searchRulesIcon.addEventListener('mousedown', (e) => {
                     if (e.button === 1) {
                        e.preventDefault();
                        const searchText = `Правила землепользования и застройки ${settlement}`;
                        const siteUrl = 'tatarstan.ru';
                        const yandexQuery = `site:${siteUrl} ${searchText}`;
                        const googleQuery = `site:${siteUrl} ${searchText}`;
                        window.open(`https://yandex.ru/search/?text=${encodeURIComponent(yandexQuery)}`, '_blank');
                        window.open(`https://www.google.com/search?q=${encodeURIComponent(googleQuery)}`, '_blank');
                    }
                });
                 searchRulesIcon.addEventListener('click', (e) => {
                     if (e.button === 0) {
                        e.stopPropagation();
                        const searchText = `${settlement}`;
                        const siteUrl = 'tatarstan.ru';
                        const googleQuery = `site:${siteUrl} ${searchText}`;
                        window.open(`https://www.google.com/search?q=${encodeURIComponent(googleQuery)}`, '_blank');
                     }
                 });

          const openRulesIcon = document.createElement('img');
          openRulesIcon.className = 'open-rules-icon';
          openRulesIcon.src = "https://img.icons8.com/?size=20&id=jFUfeIWcZ6hK&format=png&color=2196F3";
          openRulesIcon.alt = "ПЗЗ";
          openRulesIcon.title = "Открыть ПЗЗ поселения";
          openRulesIcon.style.display = 'none';

          const urlKey = `${districtName}|${settlement}`;
          const hasSpecificUrls = settlementUrls[urlKey] && settlementUrls[urlKey].urls.length > 0;

          if (hasSpecificUrls) {
              openRulesIcon.addEventListener('click', (e) => {
                  e.stopPropagation();
                  if (settlementUrls[urlKey] && settlementUrls[urlKey].urls) {
                      settlementUrls[urlKey].urls.forEach(url => window.open(url, '_blank'));
                  }
              });
          } else {
               openRulesIcon.style.opacity = '0.4';
               openRulesIcon.style.cursor = 'default';
               openRulesIcon.title = "ПЗЗ поселения не найдено в базе";
          }

                 const toggleIcon = document.createElement('span');
                 toggleIcon.className = 'toggle-icon';
                 toggleIcon.textContent = '›';

                 headerDiv.appendChild(headerContent);
                 iconsContainer.appendChild(searchRulesIcon);
                 iconsContainer.appendChild(openRulesIcon);
                 iconsContainer.appendChild(toggleIcon);
                 headerDiv.appendChild(iconsContainer);

                 const contentDiv = document.createElement('div');
                 contentDiv.className = 'settlement-group-content';

                 villages.forEach(village => {
                    const villageDiv = document.createElement('div');
                    villageDiv.className = 'settlement-item';

                    const villageContent = document.createElement('div');
                    villageContent.className = 'settlement-item-content';
                    villageContent.textContent = village;
                    villageContent.title = `Найти "${village}" на Яндекс Картах`;
                    villageContent.style.cursor = 'pointer';

                    villageContent.addEventListener('click', () => {
                        const mapSearchQuery = encodeURIComponent(`${village} ${settlement} ${districtName}`);
                        window.open(`https://yandex.ru/maps/?text=${mapSearchQuery}`, '_blank');
                    });

                    villageDiv.appendChild(villageContent);

                    if (hasSpecificUrls) {
                        const villageRulesIcon = createRulesIcon(settlementUrls[urlKey].urls, village, settlement);
                        villageRulesIcon.classList.add('rules-icon-small');
                        villageDiv.appendChild(villageRulesIcon);
                    }

                    contentDiv.appendChild(villageDiv);
                 });

                headerDiv.addEventListener('click', (e) => {
                    if (e.target.classList.contains('search-rules-icon') || e.target.classList.contains('open-rules-icon')) {
                        return;
                    }

                    const isCurrentlyActive = headerDiv.classList.contains('active');

                    document.querySelectorAll('.settlement-group-header.active').forEach(activeHeader => {
                        if (activeHeader !== headerDiv) {
                             activeHeader.classList.remove('selected', 'active');
                             activeHeader.querySelector('.settlement-group-content').classList.remove('active');
                            const otherSearchIcon = activeHeader.querySelector('.search-rules-icon');
                            const otherOpenIcon = activeHeader.querySelector('.open-rules-icon');
                            if(otherSearchIcon) otherSearchIcon.style.display = 'none';
                            if(otherOpenIcon) otherOpenIcon.style.display = 'none';
                        }
                    });

                    headerDiv.classList.toggle('selected', !isCurrentlyActive);
                    headerDiv.classList.toggle('active', !isCurrentlyActive);
                    contentDiv.classList.toggle('active', !isCurrentlyActive);

                    searchRulesIcon.style.display = !isCurrentlyActive ? 'inline-block' : 'none';
                     openRulesIcon.style.display = !isCurrentlyActive ? 'inline-block' : 'none';

                 });

                groupDiv.appendChild(headerDiv);
                groupDiv.appendChild(contentDiv);
                settlementsList.appendChild(groupDiv);
             });

            sidePanel.classList.add('active');
        }

         function createRulesIcon(urls, villageName = '', settlementName = '') {
             const rulesIcon = document.createElement('img');
             rulesIcon.src = 'https://img.icons8.com/material-outlined/24/000000/document.png';
             rulesIcon.className = 'rules-icon';
             rulesIcon.alt = "ПЗЗ";
             rulesIcon.title = "";

             rulesIcon.addEventListener('mousedown', (e) => {
                 if (e.button === 1) {
                     e.preventDefault();
                     e.stopPropagation();
                     urls.forEach(url => {
                         window.open(url, '_blank');
                     });
                 }
             });
             rulesIcon.addEventListener('click', (e) => {
                 if (e.button === 0) {
                     e.stopPropagation();
                    const searchText = `${villageName ? villageName + ' ' : ''}${settlementName}`;
                    const googleQuery = `Правила землепользования и застройки ${searchText}`;
                     window.open(`https://www.google.com/search?q=${encodeURIComponent(googleQuery)}`, '_blank');
                 }
             });

             return rulesIcon;
         }

        document.querySelector('.close-panel').addEventListener('click', () => {
            document.getElementById('sidePanelContainer').classList.remove('active');
             document.querySelectorAll('.settlement-group-header').forEach(header => {
                 header.classList.remove('selected', 'active');
                 const content = header.nextElementSibling;
                 if (content && content.classList.contains('settlement-group-content')) {
                     content.classList.remove('active');
                 }
                 const searchIcon = header.querySelector('.search-rules-icon');
                 const openIcon = header.querySelector('.open-rules-icon');
                 if(searchIcon) searchIcon.style.display = 'none';
                 if(openIcon) openIcon.style.display = 'none';
             });
        });

        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const mapDimensions = drawMap();
             if (mapDimensions.width === 0) return;

            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

             if (x >= mapDimensions.x && x <= mapDimensions.x + mapDimensions.width &&
                 y >= mapDimensions.y && y <= mapDimensions.y + mapDimensions.height)
             {
                 const normalizedX = (x - mapDimensions.x) / mapDimensions.width * 100;
                 const normalizedY = 100 - ((y - mapDimensions.y) / mapDimensions.height * 100);

                 let currentDistrict = districts.find(district =>
                     normalizedX >= district.xMin && normalizedX <= district.xMax &&
                     normalizedY >= district.yMin && normalizedY <= district.yMax
                 );

                 if (currentDistrict) {
                     tooltip.innerHTML = currentDistrict.name;
                     const tooltipWidth = tooltip.offsetWidth;
                     const tooltipHeight = tooltip.offsetHeight;
                     let tooltipX = e.clientX + 15;
                     let tooltipY = e.clientY + 15;
                     if (tooltipX + tooltipWidth > window.innerWidth) {
                         tooltipX = e.clientX - tooltipWidth - 15;
                     }
                    if (tooltipY + tooltipHeight > window.innerHeight) {
                        tooltipY = e.clientY - tooltipHeight - 15;
                    }
                     tooltip.style.left = `${tooltipX}px`;
                     tooltip.style.top = `${tooltipY}px`;
                     tooltip.classList.add('active');
                 } else {
                     tooltip.classList.remove('active');
                 }

                 if (showCoordinates) {
                     coordinatesDiv.innerHTML = `
                         Курсор (px): X: ${Math.round(x)}, Y: ${Math.round(y)}<br>
                         Карта (px): X: ${Math.round(x - mapDimensions.x)}, Y: ${Math.round(y - mapDimensions.y)}<br>
                         Норм (%): X: ${normalizedX.toFixed(2)}%, Y: ${normalizedY.toFixed(2)}%<br>
                         Район: ${currentDistrict ? currentDistrict.name : 'Не определен'}
                     `;
                 }
             } else {
                  tooltip.classList.remove('active');
                 if (showCoordinates) {
                     coordinatesDiv.innerHTML = `Курсор вне карты`;
                 }
             }
        });

        canvas.addEventListener('mouseleave', function() {
            tooltip.classList.remove('active');
             if (showCoordinates) {
                 coordinatesDiv.innerHTML = `Курсор вне холста`;
             }
        });

        let showCoordinates = false;
        const coordinatesDiv = document.getElementById('coordinates');

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F9') {
                 e.preventDefault();
                showCoordinates = !showCoordinates;
                coordinatesDiv.style.display = showCoordinates ? 'block' : 'none';
             }
        });

        window.addEventListener('resize', function() {
             resizeCanvas();
         });

    </script>
</body>
</html>
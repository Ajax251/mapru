<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Интерактивная диаграмма с ИИ</title>
    <script src="webfonts/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="webfonts/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <link rel="icon" href="img/diag.png" type="image/png">
<style>
   
    :root { --text-color: #2b2d42; --light-text: #8d99ae; --bg-color: #f8f9fa; --card-bg: #ffffff; --border-radius: 12px; --shadow: 0 10px 20px rgba(0, 0, 0, 0.08); --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); --control-panel-height: 70px; --btn-color-type: #4361ee; --btn-color-display: #f77f00; --btn-color-appearance: #00b4d8; --btn-color-send: #305CDE; } body, html { height: 100%; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; } .app-container { display: flex; flex-direction: column; height: 100dvh; width: 100vw; } #chartContainer { flex: 1; background-color: var(--card-bg); padding: 15px; display: flex; flex-direction: column; overflow: hidden; position: relative; } .chart-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; margin-bottom: 10px; flex-shrink: 0; } .chart-title { font-size: 18px; font-weight: 500; color: var(--text-color); margin: 0; } .chart-actions { display: flex; gap: 5px; align-items: center; } .chart-action-btn { border: none; background: none; color: var(--light-text); cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: var(--transition); } .chart-action-btn:hover { background-color: rgba(67, 97, 238, 0.1); color: var(--btn-color-type); } .chart-wrapper { flex: 1; position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; } #chart-placeholder { text-align: center; color: var(--light-text); display: none; animation: fadeIn 0.5s ease; } @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } #chart-placeholder i { font-size: 48px; margin-bottom: 15px; } #chart-placeholder p { font-size: 16px; margin: 0; } .control-panel { height: var(--control-panel-height); flex-shrink: 0; background-color: var(--card-bg); border-top: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 15px; gap: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); } .control-panel .btn { padding: 0; width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; color: white; font-size: 16px; transition: var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); } .control-panel .btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.2); } .control-panel .btn:active { transform: translateY(0) scale(1); } .btn.btn-type { background: var(--btn-color-type); } .btn.btn-display { background: var(--btn-color-display); } .btn.btn-appearance { background: var(--btn-color-appearance); } #sendAiRequestBtn { background: var(--btn-color-send); } #aiQueryInput { flex-grow: 1; height: 42px; padding: 0 15px; border: 1px solid #e0e0e0; border-radius: 21px; font-family: 'Roboto', sans-serif; font-size: 15px; resize: none; background-color: #f8f9fa; transition: var(--transition); line-height: 42px; } #aiQueryInput:focus { outline: none; border-color: var(--btn-color-type); background-color: white; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); } #aiQueryInput:disabled { cursor: not-allowed; background-color: #e9ecef; opacity: 0.7; } #sendAiRequestBtn:disabled { cursor: not-allowed; background-color: var(--light-text); opacity: 0.7; } .lds-ring { display: inline-block; position: relative; width: 80px; height: 80px; margin-bottom: 15px; } .lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 8px solid var(--btn-color-type); border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: var(--btn-color-type) transparent transparent transparent; } .dark-theme .lds-ring div { border-color: var(--btn-color-appearance) transparent transparent transparent; } .lds-ring div:nth-child(1) { animation-delay: -0.45s; } .lds-ring div:nth-child(2) { animation-delay: -0.3s; } .lds-ring div:nth-child(3) { animation-delay: -0.15s; } @keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .popup-menu { position: absolute; bottom: calc(var(--control-panel-height) + 10px); background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1000; padding: 15px; width: 280px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s; display: none; } .popup-menu.show { display: block; opacity: 1; visibility: visible; transform: translateY(0); } .popup-menu h4 { margin: 0 0 15px 0; font-weight: 500; font-size: 16px; color: var(--text-color); } #chartTypePopup { left: 15px; } #displayOptionsPopup { left: 75px; } #appearancePopup { left: 135px; } #dataTablePopup { top: 70px; right: 15px; width: auto; max-width: 90vw; max-height: 70dvh; overflow: auto; } .select-wrapper { position: relative; margin-bottom: 10px; } .select-wrapper:after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--btn-color-type); position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; } select { width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 8px; appearance: none; background-color: white; color: var(--text-color); font-size: 14px; cursor: pointer; } .option-group, .appearance-settings, .slider-control { margin-bottom: 10px; } .option-title { font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--light-text); } .switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 4px 0; } .switch { position: relative; display: inline-block; width: 45px; height: 22px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); } input:checked + .slider { background-color: var(--btn-color-type); } input:checked + .slider:before { transform: translateX(23px); } .range-slider { width: 100%; -webkit-appearance: none; height: 5px; background: #e0e0e0; border-radius: 3px; outline: none; } .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--btn-color-type); cursor: pointer; } .color-picker { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; } .color-option { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; } .color-option.active, .color-option:hover { transform: scale(1.2); border-color: white; box-shadow: 0 0 0 2px var(--btn-color-type); } .btn-outline { background-color: transparent; border: 1px solid var(--btn-color-type); color: var(--btn-color-type); padding: 8px 12px; font-size: 13px; border-radius: 8px; cursor: pointer; transition: var(--transition); } .btn-outline:hover { background-color: var(--btn-color-type); color: white; } .data-table { width: 100%; border-collapse: collapse; font-size: 13px; } .data-table th, .data-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; } .data-table th { font-weight: 500; background-color: #f8f9fa; } .dark-theme { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --light-text: #888; } .dark-theme #chartContainer, .dark-theme .control-panel, .dark-theme .popup-menu { border-color: #333; } .dark-theme #aiQueryInput { background-color: #333; border-color: #444; color: var(--text-color); } .dark-theme #aiQueryInput:disabled { background-color: #2a2a2a; } .dark-theme .chart-action-btn:hover { background-color: rgba(67, 97, 238, 0.2); } .dark-theme #aiCommentOverlay { background: linear-gradient(135deg, rgba(40, 40, 40, 0.9), rgba(30, 30, 30, 0.95)); border-color: #444; } .dark-theme select, .dark-theme .data-table th { background-color: #333; border-color: #444; color: #e0e0e0; } .dark-theme .slider { background-color: #444; } .dark-theme #aiCommentToggleBtn { background-color: #2a2a2a; border-color: #444; } .dark-theme .range-slider { background: #444; } #aiCommentOverlay { position: absolute; bottom: 15px; left: 15px; right: 15px; max-width: 500px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.95)); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(0,0,0,0.1); padding: 0; border-radius: var(--border-radius); z-index: 5; max-height: 40%; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transform: translateY(20px); cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); } .ai-comment-header { display: flex; align-items: center; padding: 10px 15px; font-weight: 500; } .ai-comment-header i { margin-right: 10px; color: var(--btn-color-type); } .ai-comment-body { padding: 0px 15px 15px 15px; font-size: 14px; line-height: 1.6; max-height: 25dvh; overflow-y: auto; } #aiCommentOverlay.show { opacity: 1; visibility: visible; transform: translateY(0); } #aiCommentToggleBtn { position: absolute; bottom: 15px; left: 15px; z-index: 6; padding: 8px 15px; background-color: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); cursor: pointer; font-size: 14px; font-weight: 500; border: 1px solid rgba(0,0,0,0.1); display: none; transition: var(--transition); } #aiCommentToggleBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); } #aiCommentToggleBtn i { margin-right: 8px; color: var(--btn-color-type); } .notification-bar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white; font-size: 14px; z-index: 10000; transition: bottom 0.5s ease-in-out; display: flex; align-items: center; } .notification-bar.show { bottom: 20px; } @media (max-width: 768px) { .control-panel { padding: 0 10px; gap: 8px; height: 60px; } .control-panel .btn { width: 40px; height: 40px; font-size: 14px; } #aiQueryInput { height: 40px; font-size: 14px; } .popup-menu { width: calc(100vw - 30px); left: 15px !important; } :root { --control-panel-height: 60px; } }
</style>
</head>
<body>
    <div class="app-container">
        <!-- ... (весь ваш HTML для чарта и контролов остается без изменений) ... -->
        <div id="chartContainer"> <div class="chart-header"> <h2 class="chart-title" id="chartTitle">Визуализация данных</h2> <div class="chart-actions"> <button class="chart-action-btn" id="table-view-btn" title="Таблица данных"><i class="fas fa-table"></i></button> <button class="chart-action-btn" onclick="toggleFullscreen()" title="Полный экран"><i class="fas fa-expand"></i></button> <button class="chart-action-btn" onclick="saveAsPNG()" title="Сохранить как PNG"><i class="fas fa-file-image"></i></button> <label class="switch chart-action-btn" style="width: 45px; height:22px; margin-left:5px;" title="Темная тема"> <input type="checkbox" id="themeToggle"> <span class="slider"></span> </label> </div> </div> <div class="chart-wrapper"> <canvas id="myChart"></canvas> <div id="chart-placeholder"> <i class="fas fa-chart-line"></i> <p>Нет данных для отображения.<br>Отправьте запрос ИИ</p> </div> <div id="aiCommentOverlay"> <div class="ai-comment-header"><i class="fas fa-comment-dots"></i><span>Комментарий</span></div> <div class="ai-comment-body"><p id="aiCommentText"></p></div> </div> <button id="aiCommentToggleBtn"><i class="fas fa-comment-alt"></i> </button> </div> </div> <div class="control-panel"> <button class="btn btn-type" id="chart-type-btn" title="Тип диаграммы"><i class="fas fa-chart-pie"></i></button> <button class="btn btn-display" id="display-options-btn" title="Отображение"><i class="fas fa-sliders-h"></i></button> <button class="btn btn-appearance" id="appearance-btn" title="Внешний вид"><i class="fas fa-palette"></i></button> <textarea id="aiQueryInput" placeholder="" rows="1"></textarea> <button class="btn" id="sendAiRequestBtn" title="Отправить ИИ"><i class="fas fa-paper-plane"></i></button> </div>
    </div>
    <div id="chartTypePopup" class="popup-menu"> <h4>Тип диаграммы</h4> <div class="select-wrapper"> <select id="chartType"> <optgroup label="Основные типы"><option value="pie">Круговая</option><option value="bar">Столбчатая</option><option value="line">Линейный</option><option value="doughnut">Кольцевая</option></optgroup> <optgroup label="Дополнительные"><option value="polarArea">Полярная</option><option value="radar">Радар</option><option value="horizontalBar">Горизонтальная</option></optgroup> </select> </div> </div> <div id="displayOptionsPopup" class="popup-menu"> <h4>Отображение данных</h4> <div class="option-group"> <div class="switch-container"><span>Подписи категорий</span><label class="switch"><input type="checkbox" id="showDataSwitch"><span class="slider"></span></label></div> <div class="switch-container"><span>Проценты</span><label class="switch"><input type="checkbox" id="showPercentSwitch"><span class="slider"></span></label></div> <div class="switch-container"><span>Значения</span><label class="switch"><input type="checkbox" id="showValuesSwitch"><span class="slider"></span></label></div> <div class="switch-container"><span>Легенда</span><label class="switch"><input type="checkbox" id="showLegendSwitch"><span class="slider"></span></label></div> </div> </div> <div id="appearancePopup" class="popup-menu"> <h4>Внешний вид</h4> <div class="appearance-settings"> <div class="slider-control"><label for="borderWidth">Толщина границ: <span id="borderWidthValue">1</span>px</label><input type="range" id="borderWidth" class="range-slider" min="0" max="5" step="0.5" value="1"></div> <div class="slider-control"><label for="fontSize">Размер шрифта: <span id="fontSizeValue">12</span>px</label><input type="range" id="fontSize" class="range-slider" min="8" max="20" step="1" value="12"></div> <div class="option-title">Цветовая схема:</div> <div class="color-picker"> <div class="color-option active" style="background-color: #4e79a7" data-scheme="default"></div><div class="color-option" style="background-color: #ff6b6b" data-scheme="warm"></div> <div class="color-option" style="background-color: #48bfe3" data-scheme="cool"></div><div class="color-option" style="background-color: #06d6a0" data-scheme="pastel"></div> <div class="color-option" style="background-color: #118ab2" data-scheme="monochrome"></div> </div> </div> </div> <div id="dataTablePopup" class="popup-menu"> <h4>Таблица данных</h4> <div id="dataTableContainer" style="max-height: 40dvh; overflow-y: auto;"><div id="dataTable"></div></div> <button class="btn-outline" style="margin-top: 15px; width:100%;" onclick="addTableRow()"><i class="fas fa-plus"></i> Добавить строку</button> </div>
    <div id="notification-placeholder"></div>
    <textarea id="dataInput" style="display:none;"></textarea>

    <script>
        // ===========
        const USE_VERCEL_PROXY = true; 
        
        const VERCEL_CONFIG = {
          
            API_URL: "https://ver-olive-delta.vercel.app/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent",
            CERT_URL: null 
        };

        const LOCAL_IP_CONFIG = {
            API_URL: "https://193.124.64.31:8005/api/v1/chat/completions",
            CERT_URL: "https://193.124.64.31:8005/"
        };
        
            const activeConfig = USE_VERCEL_PROXY ? VERCEL_CONFIG : LOCAL_IP_CONFIG;
        // ===========

        Chart.register(ChartDataLabels);
        const colorSchemes = { /* ... (без изменений) ... */ default: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'], warm: ['#ff6b6b', '#f9844a', '#fee440', '#f9c74f', '#90be6d', '#43aa8b', '#577590', '#277da1', '#f94144', '#f3722c'], cool: ['#48bfe3', '#56cfe1', '#64dfdf', '#72efdd', '#80ffdb', '#a5a58d', '#b7b7a4', '#6b705c', '#023e8a', '#0077b6'], pastel: ['#ffd6ff', '#e7c6ff', '#c8b6ff', '#b8c0ff', '#bbd0ff', '#06d6a0', '#1b9aaa', '#ef476f', '#ffc43d', '#f15bb5'], monochrome: ['#118ab2', '#0096c7', '#00b4d8', '#48cae4', '#90e0ef', '#ade8f4', '#caf0f8', '#03045e', '#023e8a', '#0077b6'] };
        let currentColorScheme = 'default';
        let chartData = { labels: [], values: [] };
        let currentAiRequestController = null;
        const displayOptionIDs = ['showDataSwitch', 'showPercentSwitch', 'showValuesSwitch', 'showLegendSwitch'];

        window.onload = function() {
            setupEventListeners(); setupThemeToggle(); loadSettings(); processData();
        };

        function setupEventListeners() { /* ... (без изменений) ... */ document.getElementById('sendAiRequestBtn').addEventListener('click', handleAiRequest); document.getElementById('aiQueryInput').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAiRequest(); } }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && currentAiRequestController) { currentAiRequestController.abort(); } }); const popupButtons = { 'chart-type-btn': 'chartTypePopup', 'display-options-btn': 'displayOptionsPopup', 'appearance-btn': 'appearancePopup', 'table-view-btn': 'dataTablePopup' }; Object.keys(popupButtons).forEach(btnId => { document.getElementById(btnId).addEventListener('click', (e) => { e.stopPropagation(); const popupId = popupButtons[btnId]; if (popupId === 'dataTablePopup') renderDataTable(); togglePopup(popupId); }); }); document.addEventListener('click', (e) => { if (document.querySelector('.popup-menu.show') && !document.querySelector('.popup-menu.show').contains(e.target)) closeAllPopups(); }); document.getElementById('chartType').addEventListener('change', () => saveAndRedraw('chartType', document.getElementById('chartType').value)); displayOptionIDs.forEach(id => document.getElementById(id).addEventListener('change', (e) => saveAndRedraw(id, e.target.checked))); document.getElementById('borderWidth').addEventListener('input', (e) => { document.getElementById('borderWidthValue').textContent = e.target.value; drawChart(); }); document.getElementById('fontSize').addEventListener('input', (e) => { document.getElementById('fontSizeValue').textContent = e.target.value; drawChart(); }); document.querySelectorAll('.color-option').forEach(el => el.addEventListener('click', () => setColorScheme(el, el.dataset.scheme))); document.getElementById('aiCommentOverlay').addEventListener('click', toggleAiComment); document.getElementById('aiCommentToggleBtn').addEventListener('click', toggleAiComment); }
        function setupThemeToggle() { /* ... (без изменений) ... */ const themeToggle = document.getElementById('themeToggle'); const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)"); function setTheme(isDark) { document.body.classList.toggle('dark-theme', isDark); themeToggle.checked = isDark; processData(); } const storedTheme = localStorage.getItem('theme'); setTheme(storedTheme ? storedTheme === 'dark' : prefersDarkScheme.matches); themeToggle.addEventListener('change', (e) => { const isDark = e.target.checked; setTheme(isDark); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }); }
        function saveAndRedraw(key, value) { localStorage.setItem(key, value); drawChart(); }
        function loadSettings() { /* ... (без изменений) ... */ const savedType = localStorage.getItem('chartType'); if (savedType) document.getElementById('chartType').value = savedType; displayOptionIDs.forEach(id => { const savedState = localStorage.getItem(id); const defaultChecked = ['showDataSwitch', 'showPercentSwitch', 'showLegendSwitch'].includes(id); document.getElementById(id).checked = (savedState === null) ? defaultChecked : (savedState === 'true'); }); }
        function togglePopup(popupId) { const targetPopup = document.getElementById(popupId); const isShowing = targetPopup.classList.contains('show'); closeAllPopups(); if (!isShowing) targetPopup.classList.add('show'); }
        function closeAllPopups() { document.querySelectorAll('.popup-menu.show').forEach(p => p.classList.remove('show')); }
        function processData() { /* ... (без изменений) ... */ const dataInput = document.getElementById('dataInput').value; chartData.labels = []; chartData.values = []; dataInput.split('\n').filter(line => line.trim() !== '').forEach(line => { const parts = line.trim().split(/[\t\s]+/); const label = parts.slice(0, -1).join(' '); const value = parseFloat(parts[parts.length - 1].replace(',', '.')); if (label && !isNaN(value)) { chartData.labels.push(label); chartData.values.push(value); } }); drawChart(); }
        function updateChartTitle() { const sel = document.getElementById('chartType'); document.getElementById('chartTitle').textContent = sel.options[sel.selectedIndex].text + " диаграмма"; }
        function drawChart() { /* ... (без изменений) ... */ const chartCanvas = document.getElementById('myChart'); const placeholder = document.getElementById('chart-placeholder'); if (!chartCanvas) return; if (window.myChart instanceof Chart) { window.myChart.destroy(); window.myChart = null; } if (chartData.values.length === 0) { placeholder.innerHTML = `<i class="fas fa-chart-line"></i><p>Нет данных для отображения<br>Отправьте запрос к ИИ</p>`; placeholder.style.display = 'block'; chartCanvas.style.display = 'none'; return; } placeholder.style.display = 'none'; chartCanvas.style.display = 'block'; const chartType = document.getElementById('chartType').value; window.myChart = new Chart(chartCanvas.getContext('2d'), { type: chartType === 'horizontalBar' ? 'bar' : chartType, data: { labels: chartData.labels, datasets: [{ label: 'Значения', data: chartData.values, backgroundColor: colorSchemes[currentColorScheme].map(c => chartType === 'line' ? c + '20' : c), borderColor: chartType === 'line' ? colorSchemes[currentColorScheme][0] : (document.body.classList.contains('dark-theme') ? '#1e1e1e' : 'white'), borderWidth: parseFloat(document.getElementById('borderWidth').value), tension: 0.4, fill: chartType === 'line', }] }, options: getChartOptions() }); }
        function getChartOptions() { /* ... (без изменений) ... */ const chartType = document.getElementById('chartType').value; const isDarkTheme = document.body.classList.contains('dark-theme'); const fontSize = parseFloat(document.getElementById('fontSize').value); const total = chartData.values.reduce((a, b) => a + b, 0); return { indexAxis: chartType === 'horizontalBar' ? 'y' : 'x', responsive: true, maintainAspectRatio: false, animation: false, layout: { padding: { left: 20 } }, scales: (['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType)) ? {} : { y: { beginAtZero: true, ticks: { font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' }, grid: { color: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } }, x: { ticks: { font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' }, grid: { color: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } } }, plugins: { legend: { display: document.getElementById('showLegendSwitch').checked, position: 'bottom', labels: { usePointStyle: true, font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' } }, datalabels: { display: document.getElementById('showDataSwitch').checked || document.getElementById('showPercentSwitch').checked || document.getElementById('showValuesSwitch').checked, color: isDarkTheme ? '#fff' : '#000', font: { weight: 'bold', size: fontSize }, formatter: (value, ctx) => { let res = []; if(document.getElementById('showDataSwitch').checked) res.push(ctx.chart.data.labels[ctx.dataIndex]); if(document.getElementById('showPercentSwitch').checked) res.push(total > 0 ? ((value / total) * 100).toFixed(1) + '%' : "0%"); if(document.getElementById('showValuesSwitch').checked) res.push(value.toLocaleString()); return res.join('\n'); }, anchor: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'end', align: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'start', offset: 6, textStrokeColor: isDarkTheme ? '#1e1e1e' : '#fff', textStrokeWidth: 4 } } }; }

        // ===== ГЛАВНОЕ ИЗМЕНЕНИЕ: Адаптация запроса под "простой" прокси =====
        async function handleAiRequest() {
            closeAllPopups();
            removeAiCertificateErrorPopup();
            const query = document.getElementById('aiQueryInput').value.trim();
            if (!query) { showNotification("Введите запрос для ИИ", "warning"); return; }

            const aiInput = document.getElementById('aiQueryInput');
            const sendBtn = document.getElementById('sendAiRequestBtn');
            aiInput.disabled = true;
            sendBtn.disabled = true;

            showLoading("ИИ обрабатывает ваш запрос...");
            displayAiComment("");
            const system_prompt = `Ты — API-сервис для генерации данных. На запрос верни JSON-объект с четырьмя ключами: "title" (короткая строка на русском - заголовок для диаграммы), "data" (массив объектов с ключами "label" (string) и "value" (number)), "comment" (строка на русском с контекстом/источником данных), и "chartType" (один из: 'bar', 'line', 'pie', 'doughnut', 'polarArea', 'radar', 'horizontalBar'). Выбери наиболее подходящий тип для сгенерированных данных. Если данных нет, "data" - пустой массив. Всегда возвращай JSON. Запрос: `;

            currentAiRequestController = new AbortController();
            const signal = currentAiRequestController.signal;

            try {
                // Формируем тело запроса в формате, который понимает Gemini
                const requestBody = {
                    contents: [{
                        parts: [{ "text": system_prompt + query }]
                    }]
                };

                // Отправляем запрос на выбранный URL
                const response = await fetch(activeConfig.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });

                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({ error: { message: `HTTP ошибка ${response.status}` }}));
                    throw new Error(errorJson.error.message);
                }
                
                const geminiData = await response.json();
                
                // Безопасно извлекаем ответ
                if (!geminiData.candidates || !geminiData.candidates[0]) {
                    const reason = geminiData.promptFeedback?.blockReason || 'Неизвестная причина';
                    throw new Error(`Запрос заблокирован Google. Причина: ${reason}`);
                }
                const textResponse = geminiData.candidates[0].content.parts[0].text;
                const aiResponseObject = JSON.parse(textResponse.replace(/^```json\s*|\s*```$/g, ''));


                aiInput.placeholder = "";

                const chartTypeSelect = document.getElementById('chartType');
                const validChartTypes = Array.from(chartTypeSelect.options).map(opt => opt.value);
                if (aiResponseObject.chartType && validChartTypes.includes(aiResponseObject.chartType)) {
                    chartTypeSelect.value = aiResponseObject.chartType;
                    localStorage.setItem('chartType', aiResponseObject.chartType);
                }

                if (aiResponseObject.data && Array.isArray(aiResponseObject.data) && aiResponseObject.data.length > 0) {
                    chartData.labels = aiResponseObject.data.map(item => String(item.label || ''));
                    chartData.values = aiResponseObject.data.map(item => Number(item.value || 0));
                } else {
                    chartData.labels = [];
                    chartData.values = [];
                }
                updateTextareaFromData();
                processData();

                displayAiComment(aiResponseObject.comment);
                if (aiResponseObject.title && typeof aiResponseObject.title === 'string' && aiResponseObject.title.trim() !== '') {
                    document.getElementById('chartTitle').textContent = aiResponseObject.title;
                } else {
                   updateChartTitle();
                }

                if (!aiResponseObject.data || aiResponseObject.data.length === 0) {
                    if (aiResponseObject.comment) {
                        showNotification("ИИ предоставил комментарий, но не смог сгенерировать данные.", "info");
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showNotification('Запрос к ИИ отменен', 'info');
                    processData();
                    return;
                }
                console.error('Ошибка при запросе к ИИ:', error);
                // Показываем ошибку сертификата только если используется старый IP и это ошибка сети
                if (!USE_VERCEL_PROXY && error instanceof TypeError) {
                    showAiCertificateErrorPopup();
                }
                processData();
                showNotification(`Ошибка ИИ: ${error.message || 'Неизвестная ошибка'}`, "error");
                displayAiComment(`Произошла ошибка при обработке запроса ИИ: ${error.message}`);
            } finally {
                aiInput.disabled = false;
                sendBtn.disabled = false;
                currentAiRequestController = null;
            }
        }
        // =========================================================================

        function displayAiComment(comment) { /* ... (без изменений) ... */ const overlay = document.getElementById('aiCommentOverlay'); const button = document.getElementById('aiCommentToggleBtn'); const textElement = document.getElementById('aiCommentText'); if (comment && comment.trim() !== "") { const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; textElement.innerHTML = comment.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`); overlay.classList.add('show'); button.style.display = 'none'; gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.4 }); } else { overlay.classList.remove('show'); button.style.display = 'none'; } }
        function toggleAiComment() { /* ... (без изменений) ... */ const overlay = document.getElementById('aiCommentOverlay'); const button = document.getElementById('aiCommentToggleBtn'); const isVisible = overlay.classList.contains('show'); if (isVisible) { gsap.to(overlay, { opacity: 0, y: 20, duration: 0.3, onComplete: () => { overlay.classList.remove('show'); button.style.display = 'flex'; gsap.fromTo(button, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3 }); }}); } else { gsap.to(button, { opacity: 0, y: 10, duration: 0.3, onComplete: () => { button.style.display = 'none'; overlay.classList.add('show'); gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 }); }}); } }
        function showAiCertificateErrorPopup() { removeAiCertificateErrorPopup(); const popupDiv = document.createElement('div'); popupDiv.id = 'cert-error-popup-ai'; popupDiv.className = 'cert-error-guidance-popup'; popupDiv.innerHTML = `<p><strong>Не удалось подключиться к серверу ИИ.</strong></p><p>Это может быть связано с ошибкой SSL-сертификата. Чтобы это исправить, нужно один раз вручную принять сертификат в новой вкладке.</p><button id="accept-cert-btn-popup-ai">Принять сертификат</button><button onclick="this.parentElement.remove()">Закрыть</button>`; document.body.appendChild(popupDiv); document.getElementById('accept-cert-btn-popup-ai').addEventListener('click', () => { window.open(activeConfig.CERT_URL, '_blank'); popupDiv.remove(); }); }
        function removeAiCertificateErrorPopup() { const el = document.getElementById('cert-error-popup-ai'); if (el) el.remove(); }
        function updateTextareaFromData() { /* ... (без изменений) ... */ let textData = ''; chartData.labels.forEach((label, index) => { textData += `${label}\t${chartData.values[index]}\n`; }); document.getElementById('dataInput').value = textData.trim(); }
        function setColorScheme(element, scheme) { currentColorScheme = scheme; document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active')); element.classList.add('active'); drawChart(); }
        function saveAsPNG() { /* ... (без изменений) ... */ const canvas = document.getElementById('myChart'); const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.offsetWidth; tempCanvas.height = canvas.offsetHeight; const tempCtx = tempCanvas.getContext('2d'); tempCtx.fillStyle = document.body.classList.contains('dark-theme') ? '#1e1e1e' : '#ffffff'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); if (chartData.values.length > 0) tempCtx.drawImage(canvas, 0, 0); const dataURL = tempCanvas.toDataURL('image/png', 1.0); const link = document.createElement('a'); link.download = `chart_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`; link.href = dataURL; link.click(); showNotification('Диаграмма сохранена как PNG', "success"); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.getElementById('chartContainer').requestFullscreen().catch(err => console.error(err)); } else { document.exitFullscreen(); } }
        function showLoading(text) { /* ... (без изменений) ... */ const placeholder = document.getElementById('chart-placeholder'); const canvas = document.getElementById('myChart'); if (window.myChart instanceof Chart) { window.myChart.destroy(); window.myChart = null; } placeholder.innerHTML = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>${text}</p>`; placeholder.style.display = 'block'; canvas.style.display = 'none'; }
        function showNotification(message, type = 'info', duration = 3000) { /* ... (без изменений) ... */ const p = document.getElementById('notification-placeholder') || document.body; const n = document.createElement('div'); n.className = `notification-bar ${type === 'success' ? 'btn-type' : type === 'error' ? 'btn-color-send' : 'btn-color-display'}`; n.style.backgroundColor = `var(--${n.classList.contains('btn-type') ? 'btn-color-type' : n.classList.contains('btn-color-send') ? 'btn-color-send' : 'btn-color-display'})`; n.innerHTML = `<i class="fas fa-${type==='error'?'times-circle':type==='warning'?'exclamation-triangle':type==='info'?'info-circle':'check-circle'}"></i> ${message}`; p.appendChild(n); setTimeout(() => n.classList.add('show'), 10); setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 500); }, duration); }
        function renderDataTable() { /* ... (без изменений) ... */ const tableDiv = document.getElementById('dataTable'); if (chartData.labels.length === 0) { tableDiv.innerHTML = '<p style="padding:10px; text-align:center; color: var(--light-text);">Нет данных.</p>'; return; } let tableHTML = `<table class="data-table"><thead><tr><th>#</th><th>Категория</th><th>Значение</th><th><i class="fas fa-trash"></i></th></tr></thead><tbody>`; chartData.labels.forEach((label, index) => { tableHTML += `<tr><td>${index + 1}</td><td contenteditable="true" onblur="updateTableData(${index}, 'label', this.innerText)">${label}</td><td contenteditable="true" onblur="updateTableData(${index}, 'value', this.innerText)">${chartData.values[index]}</td><td><button class="chart-action-btn" style="color:#f72585;" onclick="removeTableRow(${index})"><i class="fas fa-times"></i></button></td></tr>`; }); tableHTML += `</tbody></table>`; tableDiv.innerHTML = tableHTML; }
        function addTableRow() { /* ... (без изменений) ... */ chartData.labels.push(`Новая категория`); chartData.values.push(0); updateTextareaFromData(); renderDataTable(); drawChart(); document.getElementById('dataTableContainer').scrollTop = document.getElementById('dataTableContainer').scrollHeight; }
        function removeTableRow(index) { /* ... (без изменений) ... */ chartData.labels.splice(index, 1); chartData.values.splice(index, 1); updateTextareaFromData(); renderDataTable(); drawChart(); }
        function updateTableData(index, type, value) { /* ... (без изменений) ... */ if (type === 'label') { chartData.labels[index] = value; } else if (type === 'value') { const numValue = parseFloat(value.replace(',', '.')); if (!isNaN(numValue)) chartData.values[index] = numValue; } updateTextareaFromData(); drawChart(); }
        window.addEventListener('resize', () => { if (window.myChart instanceof Chart) window.myChart.resize(); });
    </script>
</body>
</html>
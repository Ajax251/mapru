<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Города</title>
    <link rel="stylesheet" href="webfonts/leaflet.css" />
    <script src="webfonts/leaflet.js"></script>
    <link id="favicon" rel="icon" href="https://img.icons8.com/?size=100&id=108778&format=png&color=000000" type="image/png">
    <style>
        :root { --primary-color: #007bff; --primary-hover: #0056b3; --secondary-color: #6c757d; --secondary-hover: #545b62; --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8; --light-bg: #f8f9fa; --dark-bg: #343a40; --text-color: #212529; --border-color: #dee2e6; --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: var(--font-family); background-color: var(--light-bg); color: var(--text-color); font-size: 16px; line-height: 1.5; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: opacity 0.5s ease; border: 3px solid rgba(110, 142, 251, 0.8); border-radius: 12px; overflow: hidden; box-sizing: border-box; box-shadow: 0 0 10px rgba(110, 142, 251, 0.5); }
        .weather-widget { position: fixed; left: 0; top: 0; bottom: 0; width: 300px; background: linear-gradient(135deg, #6e8efb, #4a6cf7); padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); color: white; z-index: 1000; display: flex; flex-direction: column; overflow-y: auto; border-radius: 0 15px 15px 0; }
        .weather-widget #city-input { margin-top: 10px; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; width: 90%; text-align: center; color: #333; background-color: rgba(255, 255, 255, 0.8); font-size: 1rem; outline: none; transition: border-color 0.3s ease; }
        .weather-widget #city-input::placeholder { color: #666; }
        .weather-widget #city-input:focus { border-color: rgba(255, 255, 255, 0.6); }
        #weather-data { display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        #weather-data .main-info { display: flex; align-items: center; margin: 20px 0; }
        #weather-data .current-weather { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        #weather-data .current-weather .weather-icon { font-size: 60px; }
        #weather-data .current-weather .temperature-link { color: white; text-decoration: none; }
        .date-time { margin: 15px 0; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .weather-widget .city-name { font-size: 1.4rem; color: white; font-weight: bold; cursor: pointer; text-decoration: none; }
        #weather-data .details { width: 100%; margin: 15px 0; }
        #weather-data .details > div { padding: 5px 0; text-align: center; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; margin: 5px 0; }
        #weather-data .forecast-wrapper { width: 100%; margin-top: 20px; }
        #weather-data .forecast { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        #weather-data .forecast > div { text-align: center; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        .distance-info { margin-top: 20px; padding: 10px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; opacity: 0; transition: opacity 0.5s ease-in-out; cursor: pointer; text-align: center; }
        .distance-info.visible { opacity: 1; }
        .distance-info span { vertical-align: middle; }
        .distance-info .fa-plane { margin: 0 5px; }
        .distance-info .distance-value { font-weight: normal; margin-left: 5px;}
        .distance-info .distance-value strong { font-weight: bold; }
        .map-mode-switcher { margin-top: auto; padding-top: 20px; display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap; }
        .map-mode-button { padding: 10px; border: none; border-radius: 50%; background-color: rgba(255, 255, 255, 0.2); color: white; font-size: 1.2rem; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .map-mode-button:hover { background-color: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .map-mode-button.active { background-color: rgba(255, 255, 255, 0.4); font-weight: bold; }
        #city-info-panel { position: fixed; top: 20px; left: 320px; right: 20px; bottom: 70px; background: linear-gradient(145deg, #ffffff, #f9fcff); border-radius: 15px; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.2); padding: 25px; padding-top: 60px; z-index: 1005; opacity: 0; transform: scale(0.95) translateY(100vh); transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); overflow-y: auto; font-family: 'Segoe UI', Roboto, sans-serif; color: #2c3e50; box-sizing: border-box; }
        #city-info-panel.visible { opacity: 1; transform: scale(1) translateY(0); }
        #city-info-panel .loading-message { display: block; text-align: center; font-size: 1.3em; color: #555; margin: 40px auto; padding: 20px; background-color: rgba(230, 235, 240, 0.5); border-radius: 8px; }
        #city-info-panel .info-grid { display: none; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        #close-city-info-panel { position: absolute; top: 15px; right: 18px; background: linear-gradient(135deg, #FF7F7F 0%, #FF6347 100%); border: none; font-size: 28px; font-weight: bold; color: white; cursor: pointer; padding: 0; line-height: 1; transition: all 0.3s ease; width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #close-city-info-panel:hover { background: linear-gradient(135deg, #FF6F6F 0%, #FF5030 100%); transform: scale(1.1) rotate(90deg); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #close-city-info-panel:active { transform: scale(1.0); }
        #refresh-city-info-button { position: absolute; top: 15px; right: 65px; background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%); border: none; font-size: 18px; color: white; cursor: pointer; padding: 0; line-height: 1; transition: all 0.3s ease; width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #refresh-city-info-button i { transition: transform 0.4s ease-in-out; }
        #refresh-city-info-button:hover { background: linear-gradient(135deg, #7AC5E4 0%, #3F72A4 100%); transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #refresh-city-info-button:hover i { transform: rotate(360deg); }
        #refresh-city-info-button:active { transform: scale(1.0); }
        #city-info-panel h2 { text-align: center; color: #34495e; font-size: 1.8em; margin-top: 0; margin-bottom: 25px; border-bottom: 2px solid #e0e7ef; padding-bottom: 15px; }
        .info-item { background-color: #fdfdff; padding: 12px 15px; border-radius: 10px; border: 1px solid #dde4eb; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .info-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .info-label { font-weight: 600; color: #4a6cf7; margin-right: 8px; display: block; margin-bottom: 6px; font-size: 0.95em; }
        .info-label i { margin-right: 8px; width: 18px; text-align: center; color: #5a7cf8;}
        .info-item span:not(.info-label), .info-item p, .info-item ul, .info-item div:not(.info-label) { font-size: 1em; color: #333; line-height: 1.6; }
        .info-item.info-full-width { grid-column: 1 / -1; }
        #info-name-origin p, #info-climate-summary p, #info-tourism-summary p { margin-top: 0; margin-bottom: 0; }
        #info-website-link { color: #3B82F6; text-decoration: none; word-break: break-all; font-weight: 500; }
        #info-website-link:hover { text-decoration: underline; color: #2563EB; }
        #info-main-industries ul, #info-notable-facts ul, #info-famous-people ul, #info-films-in-city ul, #info-books-about-city ul, #info-songs-about-city ul, #info-key-historical-events ul, #info-religious-sites ul, #info-education-centers ul, #info-transport-hubs ul, #info-company-headquarters ul { list-style-type: none; padding-left: 5px; margin-top: 4px; margin-bottom: 0; }
        #info-main-industries li, #info-notable-facts li, #info-famous-people li, #info-films-in-city li, #info-books-about-city li, #info-songs-about-city li, #info-key-historical-events li, #info-religious-sites li, #info-education-centers li, #info-transport-hubs li, #info-company-headquarters li { margin-bottom: 5px; padding-left: 15px; position: relative; }
        #info-main-industries li::before, #info-notable-facts li::before, #info-famous-people li::before, #info-films-in-city li::before, #info-books-about-city li::before, #info-songs-about-city li::before, #info-key-historical-events li::before, #info-religious-sites li::before, #info-education-centers li::before, #info-transport-hubs li::before, #info-company-headquarters li::before { content: "✓"; color: #4a6cf7; font-weight: bold; display: inline-block; width: 1em; margin-left: -1.2em; position: absolute; left: 0px; top: 1px; }
        @media (max-width: 900px) { #city-info-panel { left: 15px; top: 15px; right: 15px; bottom: 15px; padding-top: 55px; } .info-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .weather-widget { width: 100%; height: auto; max-height: 40vh; position:relative; border-radius: 0; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); padding: 15px; z-index: 1001;} #map { border-radius: 0; } #city-info-panel { top: 10px; left: 10px; right: 10px; bottom: 10px; width: auto; height: auto; padding: 20px; padding-top: 50px; z-index: 1005; } .weather-widget #city-input { width: 85%; margin-top: 0; margin-bottom: 10px; } #weather-data { gap: 10px; } .map-mode-switcher { padding-top: 10px; padding-bottom: 10px; gap: 8px; } .map-mode-button { width: 35px; height: 35px; font-size: 1rem; } .current-weather .weather-icon { font-size: 40px; } .current-weather #temperature { font-size: 1.5rem; } .details > div { padding: 4px 0; } .forecast-wrapper { margin-top: 10px; } .forecast > div { padding: 8px; } .scale-line-horizontal { left: 10px; bottom: 10px; height: 38px; padding:8px; } .scale-line-vertical { display: none; } }
        .scale-line-horizontal { position: absolute; bottom: 20px; left: 320px; right: 20px; height: 45px; background: rgba(255, 255, 255, 0.22); border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); z-index: 900; padding:10px 15px; box-sizing:border-box; border:1px solid rgba(110,142,251,0.35); font-family:'Segoe UI',Arial,sans-serif; backdrop-filter:blur(8px); transition:all .3s ease; overflow:hidden; }
        .scale-segments-horizontal { display:flex; height:5px; position:relative; background:rgba(110,142,251,0.15); border-radius:3px; overflow:hidden; }
        .scale-segment-horizontal { height:100%; border-left:2px solid rgba(110,142,251,0.8); flex:1; position:relative; }
        .scale-segment-horizontal:last-child { border-right:2px solid rgba(110,142,251,0.8); }
        .scale-labels-horizontal { position:relative; height:20px; margin-top:10px; font-size:12px; color:rgba(50,50,50,0.9); }
        .scale-line-vertical { position:absolute; top:20px; right:20px; bottom:80px; width:65px; background:rgba(255,255,255,0.22); border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.15); z-index:900; padding:15px 10px; box-sizing:border-box; border:1px solid rgba(110,142,251,0.35); font-family:'Segoe UI',Arial,sans-serif; backdrop-filter:blur(8px); transition:all .3s ease; display:flex; overflow:hidden; }
        .scale-segments-vertical { display:flex; flex-direction:column; width:5px; height:100%; position:relative; background:rgba(110,142,251,0.35); border-radius:3px; margin-left:auto; margin-right:5px; overflow:hidden; }
        .scale-segment-vertical { width:100%; border-top:2px solid rgba(110,142,251,0.8); flex:1; position:relative; }
        .scale-segment-vertical:last-child { border-bottom:2px solid rgba(110,142,251,0.8); }
        .scale-labels-horizontal span { padding:3px 5px; color:#456cf7; border-radius:4px; text-align:center; font-weight:600; text-shadow:0 1px 1px rgba(255,255,255,0.9); transition:all .2s ease; letter-spacing:.5px; position:absolute; transform:translateX(-50%); }
        .scale-labels-vertical { position:absolute; left:8px; top:0; bottom:0; width:35px; }
        .scale-labels-vertical span { padding:3px 5px; color:#456cf7; border-radius:4px; text-align:right; display:block; line-height:1.2; font-weight:600; text-shadow:0 1px 1px rgba(255,255,255,0.9); transition:all .2s ease; letter-spacing:.5px; position:absolute; transform:translateY(50%); }
        .scale-line-horizontal:hover,.scale-line-vertical:hover { background:rgba(255,255,255,0.3); box-shadow:0 4px 12px rgba(110,142,251,0.25); border-color:rgba(110,142,251,0.6); transform:translateY(-1px); }
        .scale-labels-horizontal span:hover,.scale-labels-vertical span:hover { color:#3a5af0; transform:translateX(-50%) scale(1.05); text-shadow:0 1px 2px rgba(255,255,255,1); }
        .scale-labels-vertical span:hover { transform:translateY(50%) scale(1.05); }
        @media (prefers-color-scheme:dark) { .scale-line-horizontal,.scale-line-vertical { background:rgba(40,40,40,0.7); } .scale-labels-horizontal span,.scale-labels-vertical span { color:#83a0ff; text-shadow:0 1px 1px rgba(0,0,0,0.7); } .scale-segments-horizontal,.scale-segments-vertical { background:rgba(110,142,251,0.3); } .scale-segment-horizontal,.scale-segment-vertical,.scale-segment-horizontal:last-child,.scale-segment-vertical:last-child { border-color:rgba(110,142,251,0.8); } }
        @media (max-width:768px) { .scale-line-horizontal { left:10px; right:10px; width:auto; height:38px; padding:8px; } .scale-line-vertical { display:none; width:55px; padding:8px; } .scale-labels-horizontal,.scale-labels-vertical { font-size:10px; } }
        .scale-point-horizontal,.scale-point-vertical { position:absolute; background-color:rgba(110,142,251,0.8); z-index:1; }
        .scale-point-horizontal { width:2px; height:100%; top:0; } .scale-point-vertical { height:2px; width:100%; left:0; }
        .scale-tick { position:absolute; background-color:rgba(110,142,251,0.5); }
        .scale-tick-horizontal { width:1px; height:5px; top:0; } .scale-tick-vertical { height:1px; width:5px; right:0; }
        #loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center; color: white; font-size: 1.5em; }
        #loader-overlay > div { padding: 20px; background: rgba(0,0,0,0.7); border-radius: 8px; }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; z-index: 9999; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .notification.success { background: linear-gradient(135deg, #43cea2, #185a9d); }
        .notification.error { background: linear-gradient(135deg, #ff6b6b, #ff3d3d); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #ff9800); }
        .notification.info { background: linear-gradient(135deg, #17a2b8, #007bff); }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification i { font-size: 16px; }
        .custom-nspd-balloon-content { font-family: 'Segoe UI', 'Roboto', sans-serif; font-size: 13px; line-height: 1.5; color: #2c3e50; }
        .custom-nspd-balloon-content strong { font-weight: 600; color: #1a2b3c; display: block; margin-bottom: 3px; }
        .custom-nspd-balloon-content .area-info { font-size: 0.9em; color: #555; }
        .custom-nspd-balloon-content hr { margin: 5px 0; border: none; border-top: 1px solid #ddd; }
        .cert-error-guidance-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 10010; max-width: 90%; text-align: left; }
        .cert-error-guidance-popup p { margin: 0 0 10px 0; }
        .cert-error-guidance-popup button { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .cert-error-guidance-popup button:hover { background-color: #0056b3; }
        .cert-error-guidance-popup .close-cert-popup { background-color: #6c757d; }
        .cert-error-guidance-popup .close-cert-popup:hover { background-color: #5a6268; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
    <div id="map"></div>
    <div id="city-info-panel">
        <button id="close-city-info-panel" title="Закрыть панель">&times;</button>
        <button id="refresh-city-info-button" title="Обновить информацию о городе"><i class="fas fa-sync-alt"></i></button>
        <h2 id="info-city-name-header">Информация о городе</h2>
        <div class="loading-message">Выберите город в погодном виджете, чтобы загрузить информацию.</div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label"><i class="fas fa-city"></i> Город:</span><span id="info-city-name"></span></div>
            <div class="info-item"><span class="info-label"><i class="fas fa-users"></i> Население:</span><span id="info-population"></span></div>
            <div class="info-item"><span class="info-label"><i class="fas fa-chart-area"></i> Площадь:</span><span id="info-area"></span></div>
            <div class="info-item"><span class="info-label"><i class="fas fa-mail-bulk"></i> Индекс:</span><span id="info-postal-code"></span></div>
            <div class="info-item"><span class="info-label"><i class="fas fa-calendar-alt"></i> Основан:</span><span id="info-foundation-date"></span></div>
            <div class="info-item"><span class="info-label"><i class="fas fa-thermometer-half"></i> Среднегодовая t°:</span><span id="info-avg-temp"></span></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-sitemap"></i> Административное подчинение:</span><span id="info-hierarchy"></span></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-book-open"></i> Происхождение названия:</span><p id="info-name-origin"></p></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-cloud-sun-rain"></i> Климат:</span><p id="info-climate-summary"></p></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-landmark"></i> Ключевые исторические события:</span><ul id="info-key-historical-events"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-church"></i> Религиозные объекты:</span><ul id="info-religious-sites"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-university"></i> Образование:</span><ul id="info-education-centers"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-bus-alt"></i> Транспорт:</span><ul id="info-transport-hubs"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-hiking"></i> Туристическая привлекательность:</span><p id="info-tourism-summary"></p></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-industry"></i> Основные отрасли:</span><ul id="info-main-industries"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-star"></i> Примечательные факты:</span><ul id="info-notable-facts"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-user-friends"></i> Известные люди:</span><ul id="info-famous-people"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-film"></i> Фильмы:</span><ul id="info-films-in-city"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-book"></i> Книги:</span><ul id="info-books-about-city"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-music"></i> Песни:</span><ul id="info-songs-about-city"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-building"></i> Компании:</span><ul id="info-company-headquarters"></ul></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-plane-departure"></i> Ближайший аэропорт:</span><div id="info-nearest-airport"></div></div>
            <div class="info-item info-full-width"><span class="info-label"><i class="fas fa-link"></i> Веб-сайт:</span><a id="info-website-link" href="#" target="_blank" rel="noopener noreferrer"></a></div>
        </div>
    </div>
    <div class="weather-widget" id="weather-widget">
        <div id="weather-data">
            <a class="city-name" id="city-name-display" target="_blank">Загрузка...</a>
            <div class="date-time"></div>
            <div class="main-info"><div class="current-weather"><a href="#" class="temperature-link" target="_blank" id="icon-link"><i class="weather-icon fas"></i></a><a href="#" class="temperature-link" target="_blank" id="temperature-link"><div id="temperature">--°C</div></a><div id="description"></div></div></div>
            <div class="details"><div>Ощущается: <span id="feels-like">--°C</span></div><div>Влажность: <span id="humidity">--%</span></div><div>Ветер: <span id="wind-speed">-- м/с</span></div></div>
            <div class="forecast-wrapper"><h3>Завтра</h3><div class="forecast"></div></div>
            <div class="distance-info" id="distance-info"></div>
            <div class="map-mode-switcher">
                <button class="map-mode-button" data-mode="map" title="Схема"><i class="fas fa-map"></i></button>
                <button class="map-mode-button" data-mode="satellite" title="Спутник"><i class="fas fa-satellite"></i></button>
                <button class="map-mode-button" data-mode="hybrid" title="Схема+Спутник"><i class="fas fa-layer-group"></i></button>
                <button class="map-mode-button" id="municipal-boundaries-button" title="Границы муниципальных образований"><i class="fas fa-landmark"></i></button>
                <button class="map-mode-button" id="show-city-info-button" title="Информация о городе"><i class="fas fa-info-circle"></i></button>
            </div>
        </div>
        <input type="text" id="city-input" placeholder="Введите город">
    </div>
    <div id="loader-overlay"><div>Загрузка...</div></div>

    <script src="webfonts/supabase-js@2.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU" type="text/javascript"></script>
    <script src="webfonts/proj4.js"></script>
    <script>
        const weatherWidget = document.getElementById('weather-widget');
        const cityInput = document.getElementById('city-input');
        const temperatureElement = document.getElementById('temperature');
        const cityNameElement = document.getElementById('city-name-display');
        const descriptionElement = document.getElementById('description');
        const feelsLikeElement = document.getElementById('feels-like');
        const humidityElement = document.getElementById('humidity');
        const windSpeedElement = document.getElementById('wind-speed');
        const weatherIcon = document.querySelector('.weather-icon');
        const dateTimeElement = document.querySelector('.date-time');
        const temperatureLink = document.getElementById('temperature-link');
        const iconLink = document.getElementById('icon-link');
        const forecastContainer = document.querySelector('.forecast');
        const mapElement = document.getElementById('map');
        const distanceInfo = document.getElementById('distance-info');
        const cityInfoPanel = document.getElementById('city-info-panel');
        const infoCityNameHeader = document.getElementById('info-city-name-header');
        const infoCityName = document.getElementById('info-city-name');
        const infoPopulation = document.getElementById('info-population');
        const infoArea = document.getElementById('info-area');
        const infoPostalCode = document.getElementById('info-postal-code');
        const infoFoundationDate = document.getElementById('info-foundation-date');
        const infoHierarchy = document.getElementById('info-hierarchy');
        const infoAvgTemp = document.getElementById('info-avg-temp');
        const infoNameOrigin = document.getElementById('info-name-origin');
        const infoWebsite = document.getElementById('info-website-link');
        const infoNotableFacts = document.getElementById('info-notable-facts');
        const infoMainIndustries = document.getElementById('info-main-industries');
        const closeCityInfoPanelButton = document.getElementById('close-city-info-panel');
        const showCityInfoButton = document.getElementById('show-city-info-button');
        const infoFamousPeople = document.getElementById('info-famous-people');
        const infoFilmsInCity = document.getElementById('info-films-in-city');
        const infoBooksAboutCity = document.getElementById('info-books-about-city');
        const infoSongsAboutCity = document.getElementById('info-songs-about-city');
        const infoCompanyHeadquarters = document.getElementById('info-company-headquarters');
        const infoNearestAirport = document.getElementById('info-nearest-airport');
        const infoClimateSummary = document.getElementById('info-climate-summary');
        const infoKeyHistoricalEvents = document.getElementById('info-key-historical-events');
        const infoReligiousSites = document.getElementById('info-religious-sites');
        const infoEducationCenters = document.getElementById('info-education-centers');
        const infoTransportHubs = document.getElementById('info-transport-hubs');
        const infoTourismSummary = document.getElementById('info-tourism-summary');
 const PROXY_BASE_URL = 'https://mapruapi.vercel.app/';

        let currentCity = localStorage.getItem('weatherCity') || 'Нурлат';
       

        let cityCoordinates = null; let timezone = 'UTC'; let map; let previousCityCoords = null; let previousCityName = '';
        let originCoords = null; let originCityName = ''; let municipalBoundaryObjects = [];
        const municipalBoundariesButton = document.getElementById('municipal-boundaries-button');
        const NSP_MUNICIPAL_LAYER_ID = '36278';
        let currentAiCityData = null; let isAiCityDataLoading = false; let currentCityNameForAiQuery = '';

        let supabaseClient = null;
        const SUPABASE_URL = 'https://yabhafljpgxexeehnufk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhYmhhZmxqcGd4ZXhlZWhudWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MTg1MjEsImV4cCI6MjA2MTA5NDUyMX0.f5ESSDiU28ErCNGpkN9Sx3svV-Ll08UZOhb5kF-_BTo';

        if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_ANON_KEY) {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                console.error("Error initializing Supabase client:", e);
            }
        }

        let currentSupabaseCityKey = '';
        const refreshCityInfoButton = document.getElementById('refresh-city-info-button');

        function sanitizeAdminRegion(region) {
            if (!region) return null;
            return region
                .replace(/Республика\s/i, '')
                .replace(/край/i, '')
                .replace(/область/i, '')
                .replace(/Город федерального значения\s/i, '')
                .trim();
        }
        
        function constructSupabaseKey(countryCode, adminRegion, cityName) {
            const sanitizedRegion = sanitizeAdminRegion(adminRegion);
            let keyParts = [countryCode, sanitizedRegion, cityName];
            return keyParts
                .filter(part => part && String(part).trim() !== '')
                .join('-')
                .toUpperCase()
                .replace(/ /g, '_')
                .replace(/[^\w\u0400-\u04FF\u0027\u002D_]+/gu, '')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        }

async function geocodeCityWithYandex(cityName) {
    await new Promise(resolve => ymaps.ready(resolve));
    const result = await ymaps.geocode(cityName, { results: 1 });
    const geoObject = result.geoObjects.get(0);

    if (!geoObject) return null;

    // Правильный способ получить "чистое" имя объекта.
    let finalCityName = geoObject.properties.get('name');

    const components = geoObject.properties.get('metaDataProperty.GeocoderMetaData.Address.Components', []);
    const findComponent = (kind) => components.find(c => c.kind === kind);

    // Добавляем запасной вариант, если свойство 'name' по какой-то причине оказалось пустым
    if (!finalCityName) {
         const localityComponent = findComponent('locality');
         if (localityComponent) {
             finalCityName = localityComponent.name;
         } else {
            // Самый крайний случай - используем исходный ввод
            finalCityName = cityName;
         }
    }

    const provinceComponent = findComponent('province');
    const areaComponent = findComponent('area');
    const countryComponent = findComponent('country');

    const adminRegion = provinceComponent ? provinceComponent.name : (areaComponent ? areaComponent.name : null);
    const countryName = countryComponent ? countryComponent.name : geoObject.getCountryCode();
    const coords = geoObject.geometry.getCoordinates();

    return {
        cityName: finalCityName,
        countryCode: countryName,
        adminRegion: adminRegion,
        coords: coords
    };
}

        async function saveCityDataToSupabase(cityKey, jsonData) {
            if (!supabaseClient || !cityKey) return;
            try {
                const { error } = await supabaseClient
                    .from('city_data')
                    .upsert({ city_key: cityKey, json_data: jsonData, created_at: new Date().toISOString() }, { onConflict: 'city_key' });
                if (error) throw error;
            } catch (error) {
                console.error('Error saving city data to Supabase:', error);
            }
        }

        async function getCityInfo(supabaseKey, aiQueryName) {
            if (!supabaseKey || !aiQueryName) {
                currentAiCityData = null;
                isAiCityDataLoading = false;
                renderCityInfoPanelState();
                return;
            }
            isAiCityDataLoading = true;
            renderCityInfoPanelState();
            if (supabaseClient) {
                try {
                    const { data: supabaseData, error: supabaseError } = await supabaseClient
                        .from('city_data')
                        .select('json_data, created_at')
                        .eq('city_key', supabaseKey)
                        .single();
                    if (supabaseError && supabaseError.code !== 'PGRST116') throw supabaseError;
                    if (supabaseData) {
                        currentAiCityData = supabaseData.json_data;
                        isAiCityDataLoading = false;
                        renderCityInfoPanelState();
                        return;
                    }
                } catch (error) {
                    console.error('Error fetching city data from Supabase:', error);
                }
            }
            await _fetchCityInfoFromAIInternal(aiQueryName, supabaseKey);
        }


  async function tryFetchWeather(cityNameForAPI) {
            if (!cityNameForAPI || String(cityNameForAPI).trim() === '') return null;
            // Новый URL, который указывает на вашу функцию на Vercel
            const apiUrl = `${PROXY_BASE_URL}/api/weather?city=${encodeURIComponent(cityNameForAPI)}`;
            try {
                const response = await fetch(apiUrl);
                // Проверяем статус ответа от нашего прокси
                if (!response.ok) {
                    console.error(`Proxy server returned an error: ${response.status}`);
                    return null;
                }
                const data = await response.json();
                if (data.cod === "200") {
                    return data;
                }
                console.warn(`Proxy function for "${cityNameForAPI}" returned an OWM error:`, data.message);
                return null;
            } catch (error) {
                console.error(`Network error when calling proxy for "${cityNameForAPI}":`, error);
                return null;
            }
        }


async function _fetchCityInfoFromAIInternal(cityName, supabaseKeyToSave) {
    // Определяем URL прокси и имя модели
    const PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
    // Составляем URL для НЕ-потокового запроса (generateContent)
    const requestUrl = `${PROXY_BASE_URL}/v1beta/models/${MODEL_NAME}:generateContent`;

    // --- ИЗМЕНЕНИЕ ПРОМПТА ---
    // Добавили "open_weather_map_name" с четким указанием формата (английский, для API)
    const prompt = `Предоставьте достоверную и проверенную информацию о населенном пункте "${cityName}" в формате JSON. Отдавайте приоритет фактической точности. Для любого поля, где проверенная информация недоступна или вызывает сомнения, явно используйте значение 'null'. Объект JSON ДОЛЖЕН содержать следующие ключи: "name" (на русском), "population", "area_sq_km", "postal_code", "foundation_date", "administrative_hierarchy" (array), "avg_annual_temp_celsius", "name_origin_summary", "official_website", "notable_facts" (array), "main_industries" (array), "famous_people" (array), "films_set_in_city" (array), "books_about_city" (array), "songs_about_city" (array), "company_headquarters" (array), "nearest_airport_info" (object), "climate_summary", "key_historical_events" (array), "religious_sites" (array), "education_centers" (array), "transport_hubs" (array), "tourism_summary", "open_weather_map_name" (короткое, чистое название на АНГЛИЙСКОМ языке, подходящее для параметра 'q' в API OpenWeatherMap, например 'Aksubayevo', 'Moscow', 'Nurlat'). Возвращайте ТОЛЬКО JSON-объект. Язык ответа для всех строковых значений, кроме open_weather_map_name, ДОЛЖЕН быть русским.`;
    
    isAiCityDataLoading = true;
    renderCityInfoPanelState();

    try {
        const response = await fetch(requestUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // Тело запроса в формате Google Gemini API
            body: JSON.stringify({
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    // Включаем JSON-режим
                    "response_mime_type": "application/json",
                }
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            let errorDetail = `Ошибка API ИИ (${response.status})`;
            try { const errorData = JSON.parse(errorText); errorDetail = errorData.error?.message || errorDetail; } catch (e) {}
            throw new Error(errorDetail);
        }

        const data = await response.json();
        // Извлекаем текстовый ответ из структуры ответа Gemini
        let cityDataJson = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!cityDataJson) {
            console.error("Unexpected AI response structure:", data);
            throw new Error("Ответ ИИ не содержит информации или имеет неверный формат.");
        }

        let parsedCityData;
        try {
            // Gemini в JSON-режиме возвращает чистую строку, но очистка на всякий случай
            const cleanedJson = cityDataJson.replace(/^```json\s*([\s\S]*?)\s*```$/, '$1').trim();
            parsedCityData = JSON.parse(cleanedJson);
        } catch (e) {
            throw new Error(`ИИ вернул некорректный JSON (ошибка парсинга: ${e.message})`);
        }

        currentAiCityData = parsedCityData;
        if (supabaseKeyToSave && currentAiCityData) {
            await saveCityDataToSupabase(supabaseKeyToSave, currentAiCityData);
        }
    } catch (error) {
        console.error('Ошибка при получении информации о городе от ИИ:', error);
        // Ошибка с сертификатом больше не актуальна для Vercel прокси
        currentAiCityData = null;
    } finally {
        isAiCityDataLoading = false;
        // Не вызываем renderCityInfoPanelState() здесь, это будет делать основная функция
    }
}

        if (typeof proj4 !== 'undefined') { proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs"); proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs"); } 
        else { console.error("Proj4 library is not loaded!"); }

        function showLoader(message = "Загрузка...") { const loader = document.getElementById('loader-overlay'); if (loader) { loader.querySelector('div').textContent = message; loader.style.display = 'flex'; } }
        function hideLoader() { const loader = document.getElementById('loader-overlay'); if (loader) { loader.style.display = 'none'; } }
        function showNotification(message, type = 'success', iconName = 'info-circle') { const existingNotification = document.querySelector('.notification'); if (existingNotification) existingNotification.remove(); const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.innerHTML = `<i class="fas fa-${iconName}"></i> ${message}`; document.body.appendChild(notification); setTimeout(() => notification.classList.add('show'), 10); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, 4000); }
           async function getTimezoneByCoordinates(lat, lon) {
            // Новый URL, который указывает на вашу функцию на Vercel
            const url = `${PROXY_BASE_URL}/api/timezone?lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error(`Proxy server for timezone returned an error: ${response.status}`);
                    return 'UTC';
                }
                const data = await response.json();
                if (data.timezoneId) return data.timezoneId;
            } catch (error) {
                console.error('Ошибка при получении временной зоны через прокси:', error);
            }
            return 'UTC';
        }
        function updateDateTime() { const now = new Date(); const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: timezone }; dateTimeElement.textContent = new Intl.DateTimeFormat('ru-RU', options).format(now); }
        function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }
        function animateDistanceValue(element, finalDistance) { let currentDistance = 0; const numSteps = 50; const increment = finalDistance / numSteps; let stepCount = 0; const interval = setInterval(() => { currentDistance += increment; stepCount++; if (stepCount >= numSteps || currentDistance >= finalDistance) { currentDistance = finalDistance; clearInterval(interval); } element.textContent = currentDistance.toFixed(1); }, 20); }


        function initMap() { map = new ymaps.Map('map', { center: [55.75, 37.62], zoom: 10, controls: [] }); const horizontalScaleElement=document.createElement('div');horizontalScaleElement.className='scale-line-horizontal';const horizontalSegments=document.createElement('div');horizontalSegments.className='scale-segments-horizontal';const horizontalLabels=document.createElement('div');horizontalLabels.className='scale-labels-horizontal';const verticalScaleElement=document.createElement('div');verticalScaleElement.className='scale-line-vertical';const verticalSegments=document.createElement('div');verticalSegments.className='scale-segments-vertical';const verticalLabels=document.createElement('div');verticalLabels.className='scale-labels-vertical';horizontalScaleElement.appendChild(horizontalSegments);horizontalScaleElement.appendChild(horizontalLabels);verticalScaleElement.appendChild(verticalSegments);verticalScaleElement.appendChild(verticalLabels);mapElement.appendChild(horizontalScaleElement);mapElement.appendChild(verticalScaleElement);function updateScales(){const zoom=map.getZoom();const projection=map.options.get('projection');horizontalLabels.innerHTML='';verticalLabels.innerHTML='';horizontalSegments.innerHTML='';verticalSegments.innerHTML='';function getNiceScaleValues(totalDistance,count=6){const magnitudes={0:1,1:2,2:5,3:10,4:20,5:50,6:100,7:200,8:500,9:1000,10:2000,11:5000,12:10000,13:20000,14:50000};let step;const approxStep=totalDistance/(count-1);let magnitude=0;while(magnitudes[magnitude]<approxStep&&magnitude<14)magnitude++;step=magnitudes[magnitude];const values=[];let currentValue=0;while(currentValue<=totalDistance&&values.length<count){values.push(currentValue);currentValue+=step;} return values.map(value=>{let unit='м';let displayValue=value;if(value>=1000){unit='км';displayValue=value/1000;if(displayValue%1!==0)displayValue=displayValue.toFixed(1);} return{value:value,display:`${displayValue} ${unit}`,displayCompact:value>=1000?`${displayValue}${unit}`:`${displayValue} ${unit}`};});} const bounds=map.getBounds();const southWest=bounds[0];const northEast=bounds[1];const horizontalDistance=ymaps.coordSystem.geo.getDistance([southWest[0],southWest[1]],[southWest[0],northEast[1]]);const verticalDistance=ymaps.coordSystem.geo.getDistance([southWest[0],southWest[1]],[northEast[0],southWest[1]]);const horizontalValues=getNiceScaleValues(horizontalDistance);const verticalValues=getNiceScaleValues(verticalDistance);const horizontalWidth=horizontalScaleElement.offsetWidth-30;const verticalHeight=verticalScaleElement.offsetHeight-30;horizontalValues.forEach(item=>{if(item.value>0){const percent=(item.value/horizontalValues[horizontalValues.length-1].value)*100;const position=(percent/100)*horizontalWidth;const point=document.createElement('div');point.className='scale-point-horizontal';point.style.left=`${position}px`;horizontalSegments.appendChild(point);} const label=document.createElement('span');label.textContent=item.display;const percent=(item.value/horizontalValues[horizontalValues.length-1].value)*100;label.style.left=`${percent}%`;horizontalLabels.appendChild(label);});verticalValues.forEach(item=>{if(item.value>0){const percent=(item.value/verticalValues[verticalValues.length-1].value)*100;const position=(percent/100)*verticalHeight;const point=document.createElement('div');point.className='scale-point-vertical';point.style.bottom=`${position}px`;verticalSegments.appendChild(point);} const label=document.createElement('span');label.textContent=item.displayCompact;const percent=(item.value/verticalValues[verticalValues.length-1].value)*100;label.style.bottom=`${percent}%`;verticalLabels.appendChild(label);});} map.events.add('boundschange',updateScales);map.events.add('sizechange',updateScales);setTimeout(updateScales,100); const savedMode = localStorage.getItem('mapMode') || 'map'; setMapMode(savedMode); document.querySelectorAll('.map-mode-button').forEach(b => { if (b.getAttribute('data-mode') === savedMode && !b.id.includes('boundaries')) b.classList.add('active'); }); }
        function setMapMode(mode) { if(!map) return; switch(mode){case'map':map.setType('yandex#map');break;case'satellite':map.setType('yandex#satellite');break;case'hybrid':map.setType('yandex#hybrid');break;}localStorage.setItem('mapMode',mode); }
        function updateMap(lat, lon, prevCoords = null) { if(!map)initMap();const newCenter=[lat,lon];const zoomLevels={initial:10,flyOut:5,arrival:10,final:13};if(prevCoords){const polyline=new ymaps.Polyline([[prevCoords.lat,prevCoords.lon],[lat,lon]],{},{strokeColor:'white',strokeWidth:3,strokeOpacity:0.7,strokeStyle:'dash'});map.geoObjects.add(polyline);map.setCenter([prevCoords.lat,prevCoords.lon],zoomLevels.flyOut,{duration:1500}).then(()=>map.setCenter(newCenter,zoomLevels.arrival,{duration:2000})).then(()=>{map.geoObjects.remove(polyline);map.setCenter(newCenter,zoomLevels.final,{duration:2000});});}else{map.setCenter(newCenter,zoomLevels.arrival,{duration:2000}).then(()=>map.setCenter(newCenter,zoomLevels.final,{duration:2000}));}}
        function updateWeatherIcon(iconCode) { const iconMapping={'01d':'fa-sun','01n':'fa-moon','02d':'fa-cloud-sun','02n':'fa-cloud-moon','03d':'fa-cloud','03n':'fa-cloud','04d':'fa-cloud-meatball','04n':'fa-cloud-meatball','09d':'fa-cloud-showers-heavy','09n':'fa-cloud-showers-heavy','10d':'fa-cloud-rain','10n':'fa-cloud-rain','11d':'fa-bolt','11n':'fa-bolt','13d':'fa-snowflake','13n':'fa-snowflake','50d':'fa-smog','50n':'fa-smog',};const iconClass=iconMapping[iconCode]||'fa-question';weatherIcon.className='weather-icon fas '+iconClass;return iconClass;}
        
async function updateWeather(city) {
    showLoader(`Загрузка "${city}"...`);

    // 1. Геокодирование через Яндекс
    let yandexGeoData;
    try {
        yandexGeoData = await geocodeCityWithYandex(city);
        if (!yandexGeoData) throw new Error(`Яндекс.Карты не смогли найти: ${city}`);
    } catch (error) {
        hideLoader();
        showNotification(error.message, 'error', 'map-marker-alt');
        return;
    }

    // 2. === ГЛАВНОЕ ИЗМЕНЕНИЕ: СБРОС СТАРОГО СОСТОЯНИЯ ===
    // При запросе нового города мы немедленно аннулируем старые данные AI.
    currentAiCityData = null;
    isAiCityDataLoading = true; // Устанавливаем флаг загрузки
    
    // Обновляем ключевые идентификаторы для нового города
    currentSupabaseCityKey = constructSupabaseKey(yandexGeoData.countryCode, yandexGeoData.adminRegion, yandexGeoData.cityName);
    currentCityNameForAiQuery = yandexGeoData.cityName;
    currentCity = yandexGeoData.cityName;
    cityCoordinates = { lat: yandexGeoData.coords[0], lon: yandexGeoData.coords[1] };
    
    // Если панель уже открыта, немедленно обновляем ее до состояния "Загрузка..."
    // Это предотвращает отображение данных старого города.
    if (cityInfoPanel.classList.contains('visible')) {
        renderCityInfoPanelState();
    }

    // 3. === ЗАПУСК ВСЕХ ЗАГРУЗОК ПАРАЛЛЕЛЬНО ===
    // Запускаем запрос погоды и информации о городе одновременно, не дожидаясь друг друга.
    const weatherPromise = tryFetchWeather(yandexGeoData.cityName);
    const cityInfoPromise = getCityInfo(currentSupabaseCityKey, currentCityNameForAiQuery);

    // Дожидаемся выполнения обоих запросов.
    // Нам важен результат только от погоды, т.к. getCityInfo обновляет глобальную переменную.
    let [weatherData] = await Promise.all([weatherPromise, cityInfoPromise]);

    // 4. Вторая попытка для погоды, если первая не удалась, а AI дал подсказку.
    // К этому моменту cityInfoPromise уже выполнился и currentAiCityData обновлен.
    if (!weatherData && currentAiCityData && currentAiCityData.open_weather_map_name) {
        showNotification(`Используем уточненное имя: "${currentAiCityData.open_weather_map_name}"`, 'success', 'check-circle');
        weatherData = await tryFetchWeather(currentAiCityData.open_weather_map_name);
    }
    
    // 5. Финальная обработка и отображение
    hideLoader();

    if (weatherData) {
        // ... (весь блок отображения погоды остается без изменений) ...
        timezone = await getTimezoneByCoordinates(cityCoordinates.lat, cityCoordinates.lon);
        updateDateTime();
        const owmResolvedCityName = weatherData.city.name;
        cityNameElement.textContent = owmResolvedCityName;
        cityNameElement.href = `https://yandex.ru/maps/?pt=${cityCoordinates.lon},${cityCoordinates.lat}&z=12&l=map`;
        localStorage.setItem('weatherCity', yandexGeoData.cityName);
        const weather = weatherData.list[0];
        temperatureElement.textContent = `${Math.round(weather.main.temp)}°C`;
        descriptionElement.textContent = weather.weather[0].description;
        feelsLikeElement.textContent = `${Math.round(weather.main.feels_like)}°C`;
        humidityElement.textContent = `${weather.main.humidity}%`;
        windSpeedElement.textContent = `${weather.wind.speed.toFixed(1)} м/с`;
        updateWeatherIcon(weather.weather[0].icon);
        const weatherDetailsLink = `https://www.gismeteo.ru/search/${encodeURIComponent(owmResolvedCityName)}/`;
        temperatureLink.href = weatherDetailsLink;
        iconLink.href = weatherDetailsLink;
        forecastContainer.innerHTML = '';
        const tomorrowsForecasts = weatherData.list.filter(item => { const itemDate = new Date(item.dt_txt); const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); return itemDate.getDate() === tomorrow.getDate() && itemDate.getHours() === 15; });
        if (tomorrowsForecasts.length > 0) { const tomorrowWeather = tomorrowsForecasts[0]; const forecastDiv = document.createElement('div'); forecastDiv.innerHTML = `<i class="fas ${updateWeatherIcon(tomorrowWeather.weather[0].icon)}" style="font-size:24px;"></i><div>${Math.round(tomorrowWeather.main.temp)}°C, ${tomorrowWeather.weather[0].description}</div>`; forecastContainer.appendChild(forecastDiv); } else { forecastContainer.innerHTML = '<div>Прогноз на завтра (15:00) недоступен</div>'; }
        if (previousCityCoords && previousCityName) { const distance = calculateDistance(previousCityCoords.lat, previousCityCoords.lon, cityCoordinates.lat, cityCoordinates.lon); distanceInfo.innerHTML = `<span>${previousCityName} <i class="fas fa-plane"></i> ${owmResolvedCityName}: </span><span class="distance-value"><strong>0.0</strong> км</span>`; distanceInfo.classList.add('visible'); const distanceValueElement = distanceInfo.querySelector('.distance-value strong'); if (distanceValueElement) animateDistanceValue(distanceValueElement, distance); } else { distanceInfo.classList.remove('visible'); distanceInfo.innerHTML = ''; }
        previousCityName = owmResolvedCityName;
    } else {
        showNotification(`Не удалось получить данные о погоде для "${currentCityNameForAiQuery}"`, 'error', 'exclamation-triangle');
        temperatureElement.textContent = `--°C`;
        descriptionElement.textContent = 'Ошибка загрузки';
        feelsLikeElement.textContent = `--°C`;
        humidityElement.textContent = `--%`;
        windSpeedElement.textContent = `-- м/с`;
        weatherIcon.className = 'weather-icon fas fa-question-circle';
        cityNameElement.textContent = currentCityNameForAiQuery;
    }
    
    updateMap(cityCoordinates.lat, cityCoordinates.lon, previousCityCoords);
    previousCityCoords = { ...cityCoordinates };

    // Финальный рендер панели с уже загруженными (или не загруженными) данными.
    renderCityInfoPanelState();
}

        function calculateShoelaceArea(coordinatesRing) {let area=0;const n=coordinatesRing.length;if(n<3)return 0;for(let i=0;i<n;i++){const p1=coordinatesRing[i];const p2=coordinatesRing[(i+1)%n];if(p1&&p2&&typeof p1[0]==='number'&&typeof p1[1]==='number'&&typeof p2[0]==='number'&&typeof p2[1]==='number'){area+=(p1[0]*p2[1])-(p2[0]*p1[1]);}else{console.warn("Invalid coordinate pair in Shoelace calculation:",p1,p2);return 0;}} return Math.abs(area/2.0);}
        async function queryMunicipalInfo(latitude, longitude) { const toEPSG3857=(lat,lon)=>{if(typeof proj4==='undefined')throw new Error("proj4 is not defined");return proj4("EPSG:4326","EPSG:3857",[lon,lat]);};const centerPoint=toEPSG3857(latitude,longitude);const centerX=centerPoint[0];const centerY=centerPoint[1];const polygonSizeMeters=0.15;const halfSize=polygonSizeMeters/2;const minX=centerX-halfSize;const minY=centerY-halfSize;const maxX=centerX+halfSize;const maxY=centerY+halfSize;const width=512;const height=512;const i=width/2;const j=height/2;const bbox=`${minX},${minY},${maxX},${maxY}`;const url=`https://nspd.gov.ru/api/aeggis/v4/${NSP_MUNICIPAL_LAYER_ID}/wms?REQUEST=GetFeatureInfo&QUERY_LAYERS=${NSP_MUNICIPAL_LAYER_ID}&SERVICE=WMS&VERSION=1.3.0&FORMAT=image%2Fpng%2F&STYLES=&TRANSPARENT=true&LAYERS=${NSP_MUNICIPAL_LAYER_ID}&RANDOM=${Math.random()}&INFO_FORMAT=application%2Fjson&FEATURE_COUNT=10&I=${i}&J=${j}&WIDTH=${width}&HEIGHT=${height}&CRS=EPSG%3A3857&BBOX=${bbox}`;try{const response=await fetch(url);if(!response.ok)throw new Error(`NSPD API error: ${response.status}`);const data=await response.json();return data;}catch(error){console.error('Error fetching municipal data from NSPD:',error);showNotification('Ошибка запроса границ: '+error.message,'error','exclamation-triangle');return null;}}
        function clearPreviousMunicipalBoundaries() { if(map&&map.balloon&&map.balloon.isOpen()){map.balloon.close();} municipalBoundaryObjects.forEach(obj=>{if(map&&map.geoObjects.indexOf(obj)!==-1)map.geoObjects.remove(obj);});municipalBoundaryObjects=[];}
        async function handleMunicipalBoundariesClick() { if (!map) { showNotification('Карта не инициализирована', 'error', 'exclamation-triangle'); return; } if (typeof proj4 === 'undefined') { showNotification('Библиотека proj4 не загружена', 'error', 'exclamation-triangle'); return; } const mapCenter = map.getCenter(); const lat = mapCenter[0]; const lon = mapCenter[1]; showLoader("Запрос границ МО..."); const municipalData = await queryMunicipalInfo(lat, lon); hideLoader(); if (!municipalData || !municipalData.features || municipalData.features.length === 0) { showNotification('Границы МО не найдены', 'warning', 'info-circle'); return; } let newPolygonsBounds = null; let featuresDrawnThisCall = 0; const randomColorChoices = ['#FF0000', '#0000FF', '#008000', '#FFFF00', '#FFFFFF', '#FF00FF', '#00FFFF']; const currentRandomBaseColor = randomColorChoices[Math.floor(Math.random() * randomColorChoices.length)]; const fillOpacity = 0.03; const featuresWithData = municipalData.features.map(feature => { let area = 0; let yandexPolygonsCoords = []; let originalNspdCoordsRings = []; if (feature.geometry && feature.geometry.coordinates) { const geometryType = feature.geometry.type; const nspdCoordinates = feature.geometry.coordinates; const processRingEPSG3857 = (ringEPSG3857) => ringEPSG3857.map(coordEPSG3857 => { try { const wgs84 = proj4("EPSG:3857", "EPSG:4326", coordEPSG3857); return [wgs84[1], wgs84[0]]; } catch (e) { return null; } }).filter(c => c !== null); if (geometryType === 'Polygon') { originalNspdCoordsRings.push(nspdCoordinates[0]); const outerRingWGS84 = processRingEPSG3857(nspdCoordinates[0]); if (outerRingWGS84.length >= 3) { const innerRingsWGS84 = nspdCoordinates.slice(1).map(processRingEPSG3857).filter(ring => ring.length >=3); yandexPolygonsCoords.push([outerRingWGS84, ...innerRingsWGS84]); } } else if (geometryType === 'MultiPolygon') { nspdCoordinates.forEach((polygonRingsEPSG3857) => { if (polygonRingsEPSG3857 && polygonRingsEPSG3857[0]) { originalNspdCoordsRings.push(polygonRingsEPSG3857[0]); const outerRingWGS84 = processRingEPSG3857(polygonRingsEPSG3857[0]); if (outerRingWGS84.length >= 3) { const innerRingsWGS84 = polygonRingsEPSG3857.slice(1).map(processRingEPSG3857).filter(ring => ring.length >=3); yandexPolygonsCoords.push([outerRingWGS84, ...innerRingsWGS84]); } } }); } } originalNspdCoordsRings.forEach(ring => area += calculateShoelaceArea(ring)); return { featureData: feature, calculatedArea: area, yandexCoordsList: yandexPolygonsCoords, hintText: feature.properties.descr || (feature.properties.options && feature.properties.options.name) || `МО ID: ${feature.id}` }; }).filter(f => f.calculatedArea > 0 && f.yandexCoordsList.length > 0); featuresWithData.sort((a, b) => b.calculatedArea - a.calculatedArea); let tempNewPolygons = []; featuresWithData.forEach((processedFeature, featureListIndex) => { processedFeature.yandexCoordsList.forEach((singlePolygonYandexCoords, yandexPolyIdx) => { if (singlePolygonYandexCoords[0] && singlePolygonYandexCoords[0].length >= 3) { try { const currentZIndex = 600 + featureListIndex; const areaKm2 = (processedFeature.calculatedArea / 1000000).toFixed(2); const polygon = new ymaps.Polygon(singlePolygonYandexCoords, { moName: processedFeature.hintText, moArea: processedFeature.calculatedArea, moAreaKm2: areaKm2, moPartId: `${processedFeature.featureData.id}_${yandexPolyIdx}` }, { strokeColor: currentRandomBaseColor, strokeWidth: 3, strokeOpacity: 0.8, fillColor: currentRandomBaseColor, fillOpacity: fillOpacity, zIndex: currentZIndex, openHintOnHover: false }); tempNewPolygons.push(polygon); map.geoObjects.add(polygon); featuresDrawnThisCall++; const bounds = polygon.geometry.getBounds(); if (bounds) { if (!newPolygonsBounds) { newPolygonsBounds = bounds; } else { newPolygonsBounds = [ [Math.min(newPolygonsBounds[0][0], bounds[0][0]), Math.min(newPolygonsBounds[0][1], bounds[0][1])], [Math.max(newPolygonsBounds[1][0], bounds[1][0]), Math.max(newPolygonsBounds[1][1], bounds[1][1])] ]; } } } catch (e) { console.error(`Ошибка создания полигона Yandex Maps для feature ${processedFeature.featureData.id}, polygon ${yandexPolyIdx + 1}:`, e); } } }); }); municipalBoundaryObjects.push(...tempNewPolygons); if (municipalBoundaryObjects.length > 0) { municipalBoundaryObjects.forEach(poly => { poly.options.set({ strokeColor: currentRandomBaseColor, fillColor: currentRandomBaseColor, fillOpacity: fillOpacity }); poly.events.remove(['mouseenter', 'mouseleave']); poly.events.add('mouseenter', function (e) { const mouseCoords = e.get('coords'); let overlappingMoItemsMap = new Map(); municipalBoundaryObjects.forEach(moPoly => { if (moPoly.geometry.contains(mouseCoords)) { const name = moPoly.properties.get('moName'); const area = moPoly.properties.get('moArea'); const areaKm2 = moPoly.properties.get('moAreaKm2'); if (!overlappingMoItemsMap.has(name) || area < overlappingMoItemsMap.get(name).area) { overlappingMoItemsMap.set(name, { name, area, areaKm2 }); } } }); let overlappingMoItems = Array.from(overlappingMoItemsMap.values()); overlappingMoItems.sort((a,b) => a.area - b.area); let balloonHtmlContent = '<div class="custom-nspd-balloon-content">'; overlappingMoItems.forEach((item, index) => { balloonHtmlContent += `<div><strong>${item.name}</strong></div><div class="area-info">${item.areaKm2} км²</div>`; if (index < overlappingMoItems.length - 1) balloonHtmlContent += '<hr>'; }); balloonHtmlContent += '</div>'; if (overlappingMoItems.length > 0) map.balloon.open(mouseCoords, balloonHtmlContent, { closeButton: false, autoPan: false, offset: [0, -25]}); }); poly.events.add('mouseleave', function () { map.balloon.close(); }); }); } if (featuresDrawnThisCall > 0 && newPolygonsBounds) { map.setBounds(newPolygonsBounds, { checkZoomRange: true, duration: 500 }); showNotification(`Отображено новых границ МО: ${featuresDrawnThisCall}`, 'success', 'check-circle'); } else if (featuresDrawnThisCall === 0 && municipalData.features.length > 0) { showNotification('Не удалось отобразить новые границы МО', 'warning', 'exclamation-triangle'); } else if (featuresDrawnThisCall === 0) { showNotification('Новые границы МО не найдены.', 'info', 'info-circle'); } }
        
        function clearCityInfoPanelData() { document.querySelectorAll('#city-info-panel .info-item span:not(.info-label), #city-info-panel .info-item p, #city-info-panel .info-item ul, #city-info-panel .info-item div:not(.info-label)').forEach(el => { if (el.tagName === 'UL') el.innerHTML = ''; else if (el.tagName === 'A') { el.href = '#'; el.textContent = ''; } else el.textContent = ''; }); document.querySelectorAll('#city-info-panel .info-item').forEach(item => { item.style.display = ''; }); }
        const setInfoText = (element, value, suffix = '') => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { if (value !== null && value !== undefined && String(value).trim() !== '' && String(value).toLowerCase() !== 'null') { element.textContent = `${value}${suffix}`; parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.textContent = ''; } } };
        const setInfoList = (element, dataArray) => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { const filteredData = Array.isArray(dataArray) ? dataArray.filter(item => item !== null && item !== undefined && String(item).trim() !== '' && String(item).toLowerCase() !== 'null') : []; if (filteredData.length > 0) { element.innerHTML = filteredData.map(item => `<li>${item}</li>`).join(''); parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.innerHTML = ''; } } };
        const setInfoHtml = (element, data, htmlGenerator) => { const parentItem = element ? element.closest('.info-item') : null; if (parentItem) { let htmlContent = ''; if (data !== null && data !== undefined && String(data).toLowerCase() !== 'null' && !(Array.isArray(data) && data.length === 0) && !(typeof data === 'object' && data !== null && Object.keys(data).length === 0)) { htmlContent = htmlGenerator(data); } if (htmlContent.trim() !== '' && htmlContent.toLowerCase() !== 'null') { element.innerHTML = htmlContent; parentItem.style.display = ''; } else { parentItem.style.display = 'none'; element.innerHTML = ''; } } };
        function populateCityInfoPanelWithData(data) {
            setInfoText(infoCityName, data.name); setInfoText(infoPopulation, data.population); setInfoText(infoArea, data.area_sq_km, ' км²');
            setInfoText(infoPostalCode, data.postal_code); setInfoText(infoFoundationDate, data.foundation_date);
            setInfoText(infoAvgTemp, data.avg_annual_temp_celsius, ' °C');
            setInfoHtml(infoHierarchy, data.administrative_hierarchy, (arr) => Array.isArray(arr) ? arr.join('<br>') : '');
            setInfoText(infoNameOrigin, data.name_origin_summary);
            setInfoText(infoClimateSummary, data.climate_summary);
            setInfoList(infoKeyHistoricalEvents, data.key_historical_events);
            setInfoList(infoReligiousSites, data.religious_sites);
            setInfoList(infoEducationCenters, data.education_centers);
            setInfoList(infoTransportHubs, data.transport_hubs);
            setInfoText(infoTourismSummary, data.tourism_summary);
            setInfoList(infoMainIndustries, data.main_industries); setInfoList(infoNotableFacts, data.notable_facts);
            setInfoList(infoFamousPeople, data.famous_people); setInfoList(infoFilmsInCity, data.films_set_in_city);
            setInfoList(infoBooksAboutCity, data.books_about_city); setInfoList(infoSongsAboutCity, data.songs_about_city);
            setInfoList(infoCompanyHeadquarters, data.company_headquarters);
            const websiteParent = infoWebsite ? infoWebsite.closest('.info-item') : null;
            if (infoWebsite && websiteParent) { if (data.official_website && String(data.official_website).startsWith('http') && String(data.official_website).toLowerCase() !== 'null') { infoWebsite.href = data.official_website; infoWebsite.textContent = data.official_website; websiteParent.style.display = ''; } else { infoWebsite.textContent = ''; infoWebsite.href = '#'; websiteParent.style.display = 'none'; } }
            setInfoHtml(infoNearestAirport, data.nearest_airport_info, (airport) => {
                let airportHtml = '';
                if (airport && typeof airport === 'object' && (airport.name || airport.code || airport.distance_km || airport.passenger_traffic || airport.passenger_traffic_per_year)) {
                    airportHtml = `${airport.name || 'н/д'}${airport.code && String(airport.code).toLowerCase() !== 'null' ? ` (${airport.code})` : ''}`;
                    if (airport.distance_km && String(airport.distance_km).toLowerCase() !== 'null') airportHtml += `<br>Расстояние: ${airport.distance_km} км`;
                    const traffic = airport.passenger_traffic || airport.passenger_traffic_per_year;
                    if (traffic && String(traffic).toLowerCase() !== 'null') airportHtml += `<br>Пассажиропоток: ${traffic}`;
                } else if (typeof airport === 'string' && airport.toLowerCase() !== 'null' && airport.trim() !== '') {
                    airportHtml = airport;
                }
                return airportHtml;
            });
        }
        function renderCityInfoPanelState() { const header = infoCityNameHeader; const grid = cityInfoPanel.querySelector('.info-grid'); const loadingMessageDiv = cityInfoPanel.querySelector('.loading-message'); if (!cityInfoPanel.classList.contains('visible')) return; if (isAiCityDataLoading) { header.textContent = `Загрузка: ${currentCityNameForAiQuery || 'Город'}...`; grid.style.display = 'none'; loadingMessageDiv.style.display = 'block'; loadingMessageDiv.textContent = `Пожалуйста, подождите, информация о "${currentCityNameForAiQuery || 'выбранном городе'}" загружается...`; } else if (currentAiCityData) { header.textContent = `${currentAiCityData.name || currentCityNameForAiQuery || 'Информация о городе'}`; grid.style.display = 'grid'; loadingMessageDiv.style.display = 'none'; populateCityInfoPanelWithData(currentAiCityData); } else { header.textContent = `Информация: ${currentCityNameForAiQuery || 'Город не выбран'}`; grid.style.display = 'none'; loadingMessageDiv.style.display = 'block'; if (currentCityNameForAiQuery) { loadingMessageDiv.textContent = `Информация о "${currentCityNameForAiQuery}" недоступна. Возможно, произошла ошибка при загрузке или данные отсутствуют.`; } else { loadingMessageDiv.textContent = 'Выберите город в погодном виджете, чтобы загрузить информацию.'; } clearCityInfoPanelData(); } }

        document.querySelectorAll('.map-mode-button').forEach(button => { button.addEventListener('click',()=>{if(button.id==='municipal-boundaries-button' || button.id === 'show-city-info-button')return;const mode=button.getAttribute('data-mode');setMapMode(mode);document.querySelectorAll('.map-mode-button').forEach(btn=>{if(btn.id!=='municipal-boundaries-button' && btn.id !== 'show-city-info-button')btn.classList.remove('active');});if(!button.id.includes('boundaries'))button.classList.add('active');});});
        if (municipalBoundariesButton) municipalBoundariesButton.addEventListener('click', handleMunicipalBoundariesClick);
        cityInput.addEventListener('keydown', function(event) { if (event.key === 'Enter') { const newCity = cityInput.value.trim(); if (newCity) { updateWeather(newCity); } cityInput.value = ''; } });
        distanceInfo.addEventListener('click', function() { if (previousCityCoords && cityCoordinates) { const yandexRtext = `${previousCityCoords.lat},${previousCityCoords.lon}~${cityCoordinates.lat},${cityCoordinates.lon}`; window.open(`https://yandex.ru/maps/?rtext=${yandexRtext}&rtt=auto`, '_blank'); } });
        cityNameElement.addEventListener('click', function(event) { if (!cityCoordinates) event.preventDefault(); });
        dateTimeElement.addEventListener('click', function(event) { if (cityCoordinates && currentCity) window.open(`https://yandex.ru/images/search?text=${encodeURIComponent(currentCity)}`, '_blank'); else event.preventDefault(); });
        
        if (showCityInfoButton) { 
            showCityInfoButton.addEventListener('click', () => { 
                cityInfoPanel.classList.toggle('visible'); 
                if (cityInfoPanel.classList.contains('visible')) {
                    if (!currentAiCityData && !isAiCityDataLoading && currentSupabaseCityKey && currentCityNameForAiQuery) {
                        getCityInfo(currentSupabaseCityKey, currentCityNameForAiQuery);
                    } else {
                         renderCityInfoPanelState(); 
                    }
                }
            }); 
        }
        if (closeCityInfoPanelButton) { closeCityInfoPanelButton.addEventListener('click', () => { cityInfoPanel.classList.remove('visible'); }); }
        
        if (refreshCityInfoButton) {
            refreshCityInfoButton.addEventListener('click', () => {
                if (currentCityNameForAiQuery && currentSupabaseCityKey) {
                 //   showLoader(`Обновление информации для "${currentCityNameForAiQuery}"...`);
                    _fetchCityInfoFromAIInternal(currentCityNameForAiQuery, currentSupabaseCityKey)
                        .finally(() => hideLoader());
                } else {
                    showNotification('Сначала выберите город для обновления информации.', 'warning', 'info-circle');
                }
            });
        }
        
        window.addEventListener('resize', () => { if (cityInfoPanel && cityInfoPanel.classList.contains('visible')) { renderCityInfoPanelState(); } });

        ymaps.ready(initMap);
        updateWeather(currentCity);
        setInterval(updateDateTime, 10000);
    </script>
</body>
</html>
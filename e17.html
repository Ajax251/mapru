<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –°–ª–æ–≤ + Cloud</title>
    <link rel="icon" href="img/wordsm.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --success-dark: #059669;
            --error: #ef4444;
            --error-dark: #dc2626;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #a855f7;
            --pink: #ec4899;
            --teal: #14b8a6;
            --orange: #f97316;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100dvh; 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg);
            color: var(--text); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Animated Background --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.2), transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.2), transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.1), transparent 70%);
            animation: globalPulse 10s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes globalPulse {
            0%, 100% { opacity: 0.6; transform: scale(1) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.05) rotate(5deg); }
        }

        /* Floating particles */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(3px 3px at 50% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 80% 10%, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200px 200px, 300px 300px, 250px 250px, 180px 180px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: particleFloat 20s linear infinite;
            pointer-events: none;
        }

        @keyframes particleFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-200px); }
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            border-radius: 20px;
            padding: 18px 28px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 12px 24px -6px rgba(0, 0, 0, 0.3);
        }

        .btn:active { 
            transform: translateY(0px); 
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-secondary { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .btn-teal { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); }
        .btn-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-cloud { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        
        /* --- Auth Header --- */
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--warning);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .auth-btn {
            background: white;
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-btn.logout {
            background: #fee2e2;
            color: #dc2626;
        }

        /* --- Cloud Stats Dashboard --- */
        .cloud-stats {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }

        .stat-val {
            font-size: 28px;
            font-weight: 900;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* --- Cloud Actions --- */
        .cloud-actions {
            margin-bottom: 16px;
        }

        /* --- Screens --- */
        .screen { 
            display: none;
            flex-direction: column; 
            height: 100%; 
            padding: 24px; 
            position: absolute; 
            width: 100%; 
            top: 0; 
            left: 0; 
            z-index: 0;
        }

        .screen.active { 
            display: flex;
            z-index: 1;
        }

        /* --- Input Screen --- */
        .input-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: rgba(255, 255, 255, 0.98);
            border-radius: 28px; 
            box-shadow: var(--shadow-lg), 0 0 60px rgba(99, 102, 241, 0.2);
            overflow: hidden; 
            margin-bottom: 24px; 
            position: relative;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        textarea { 
            flex: 1; 
            width: 100%; 
            border: none; 
            padding: 28px; 
            font-size: 16px; 
            resize: none; 
            outline: none; 
            font-family: inherit;
            background: transparent;
            line-height: 1.8;
            color: var(--text);
        }

        textarea::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .controls-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
        }
        .full-width-btn { width: 100%; margin-top: 16px; }

        /* --- Game Screen --- */
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255, 255, 255, 0.98); 
            padding: 20px 24px; 
            border-radius: 24px; 
            box-shadow: var(--shadow), 0 0 40px rgba(99, 102, 241, 0.15);
            backdrop-filter: blur(20px);
            margin-bottom: 24px;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .progress-bar { 
            flex: 1; 
            height: 12px; 
            background: rgba(0, 0, 0, 0.08); 
            border-radius: 12px; 
            margin: 0 24px; 
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            width: 0%; 
            transition: width 0.3s linear;
            border-radius: 12px;
            box-shadow: 0 0 20px var(--primary-light);
            position: relative;
        }

        .icon-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            color: #666; 
            cursor: pointer; 
            padding: 10px;
            border-radius: 14px;
            transition: all 0.2s;
        }
        .icon-btn:hover { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--error); 
        }

        .word-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 20vh;
            margin: 24px 0;
        }

        .game-mode-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        #target-word { 
            font-size: 48px; 
            font-weight: 900; 
            text-align: center; 
            margin-bottom: 16px;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 255, 255, 0.4);
            letter-spacing: 1px;
        }

        .word-counter { 
            font-size: 16px; 
            color: rgba(255, 255, 255, 0.95); 
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.25);
            padding: 10px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            font-weight: 700;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .options-area { 
            flex: 1.5; 
            padding: 12px; 
            overflow-y: auto;
        }

        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            height: 100%; 
            align-content: center;
        }

        .option-btn { 
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-radius: 24px; 
            padding: 24px; 
            font-size: 18px; 
            color: var(--text); 
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            min-height: 100px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            word-break: break-word;
            position: relative;
            overflow: hidden;
            animation: cardPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards;
            transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
        }
        
        @keyframes cardPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .option-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 16px 36px rgba(99, 102, 241, 0.25);
            border-color: var(--primary);
        }

        .correct-anim { 
            animation: flashGreen 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashGreen {
            0% { 
                background: #ffffff;
                color: var(--success);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--success);
                border-color: var(--success);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05);
            }
            100% { 
                background: var(--success); 
                color: white;
                border-color: var(--success-dark); 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); 
                transform: scale(1);
            }
        }

        .wrong-anim { 
            animation: flashRed 0.4s ease-out forwards !important;
            z-index: 10;
        }
        
        @keyframes flashRed {
             0% { 
                background: #ffffff;
                color: var(--error);
                border-color: #ffffff;
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 1);
                transform: scale(1);
            }
            20% {
                background: #ffffff;
                color: var(--error);
                border-color: var(--error);
                box-shadow: 0 0 60px 20px rgba(255, 255, 255, 0.8);
                transform: scale(1.05);
            }
            100% { 
                background: var(--error); 
                color: white;
                border-color: var(--error-dark); 
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); 
                transform: scale(1);
            }
        }

        /* --- Result Screen --- */
        .result-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            text-align: center;
            color: white;
            overflow-y: auto;
            padding-bottom: 24px;
        }

        .score-circle { 
            width: 200px; 
            height: 200px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 50%, var(--pink) 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            margin: 40px 0; 
            position: relative;
            border: 5px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.6), 0 20px 40px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .score-val { 
            font-size: 64px; 
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .result-stats-row {
            display: flex; 
            gap: 18px; 
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat-bubble {
            font-size: 18px;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 24px;
            border-radius: 24px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 700;
        }

        /* --- Cloud Summary --- */
        .cloud-summary {
            display: none;
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.4);
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 400px;
        }

        .cloud-summary.show {
            display: block;
        }

        .cloud-summary-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .cloud-summary-stats {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- Mistakes Section --- */
        #mistakes-section {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 20px;
            color: var(--text);
            text-align: left;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .mistake-card {
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--error);
        }
        
        .mistake-card:last-child { margin-bottom: 0; }
        
        .m-word { 
            font-weight: 800; 
            font-size: 18px; 
            color: var(--text); 
            margin-bottom: 8px;
        }
        
        .m-wrong { 
            color: var(--error); 
            font-size: 15px; 
            text-decoration: line-through; 
            margin-right: 12px; 
            font-weight: 600;
        }
        
        .m-right { 
            color: var(--success-dark); 
            font-size: 15px; 
            font-weight: 800; 
        }

        /* --- Custom Modal --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .custom-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 28px;
            padding: 32px 28px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-icon {
            font-size: 56px;
            margin-bottom: 16px;
            animation: iconBounce 0.6s ease-out;
        }

        @keyframes iconBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .modal-content h3 {
            margin: 0 0 12px 0;
            font-size: 24px;
            font-weight: 900;
            color: var(--text);
        }

        .modal-content p {
            margin: 0 0 24px 0;
            font-size: 16px;
            color: var(--text-light);
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            border: none;
            border-radius: 16px;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 100px;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .modal-btn-secondary {
            background: #f3f4f6;
            color: var(--text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .modal-btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, var(--error-dark) 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .modal-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        .prompt-input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--primary-light);
            border-radius: 14px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
            transition: all 0.2s;
        }

        .prompt-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* --- Loader --- */
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }

        .spinner { 
            width: 70px; 
            height: 70px;
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary), var(--purple), var(--pink));
            animation: spinnerPulse 1.5s infinite, spinnerRotate 2s linear infinite;
            margin-bottom: 24px; 
            box-shadow: 0 0 40px var(--primary);
            position: relative;
        }

        .spinner::after {
            content: '';
            position: absolute;
            inset: 8px;
            background: white;
            border-radius: 50%;
        }

        @keyframes spinnerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--primary); }
            50% { transform: scale(1.1); box-shadow: 0 0 60px var(--primary-light); }
        }

        @keyframes spinnerRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loader-text {
            color: var(--primary);
            font-weight: 800;
            font-size: 24px;
            margin-bottom: 12px;
        }

        #loader-sub {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            padding: 0 24px;
            max-width: 400px;
        }

        .hidden { display: none !important; }
        .hidden-file { display: none; }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 12px 32px -4px rgba(59, 130, 246, 0.6);
            }
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--primary), var(--purple)); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, var(--primary-dark), var(--purple)); 
        }

        @media (max-width: 480px) {
            body, html { padding: 0; }
            .screen { padding: 16px; }
            #target-word { font-size: 38px; }
            .option-btn { font-size: 16px; min-height: 90px; padding: 18px; }
            .score-circle { width: 170px; height: 170px; }
            .score-val { font-size: 54px; }
            .btn { padding: 16px 22px; font-size: 15px; }
            .cloud-stats { grid-template-columns: 1fr 1fr 1fr; }
            .stat-card { padding: 12px; }
            .stat-val { font-size: 22px; }
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: INPUT -->
    <div id="screen-input" class="screen active">
        <!-- Auth Header -->
        <div class="auth-header">
            <div class="user-info hidden" id="user-display">
                <div class="user-avatar" id="u-avatar">U</div>
                <span id="u-email">User</span>
            </div>
            <div class="user-info" id="guest-display">
                <i class="fas fa-user-secret"></i> –ì–æ—Å—Ç—å
            </div>
            <button class="auth-btn" id="auth-btn">
                <i class="fab fa-google"></i> –í–æ–π—Ç–∏
            </button>
        </div>

        <!-- Cloud Stats Dashboard -->
        <div class="cloud-stats" id="cloud-stats">
            <div class="stat-card" title="–°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã—É—á–∏–ª–∏">
                <span class="stat-val" style="color: var(--success)" id="stat-learned">0</span>
                <span class="stat-label"><i class="fas fa-check-circle"></i> –í—ã—É—á–µ–Ω–æ</span>
            </div>
            <div class="stat-card" title="–°–ª–æ–≤–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è">
                <span class="stat-val" style="color: var(--primary)" id="stat-new">0</span>
                <span class="stat-label"><i class="fas fa-plus-circle"></i> –î–æ—Å—Ç—É–ø–Ω–æ</span>
            </div>
            <div class="stat-card" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏">
                <span class="stat-val" style="color: var(--info)" id="due-count">0</span>
                <span class="stat-label"><i class="fas fa-dumbbell"></i> –ö –∏–∑—É—á–µ–Ω–∏—é</span>
            </div>
        </div>

        <!-- Cloud Actions -->
        <div class="cloud-actions hidden" id="cloud-actions">
            <button class="btn btn-warning" style="width: 100%; font-size: 14px; padding: 12px;" onclick="resetAllProgress()">
                <i class="fas fa-rotate-left"></i>
                <span>–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
            </button>
        </div>

        <div class="input-wrapper">
            <textarea id="sourceText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è...&#10;&#10;–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ –∏–∑ –æ–±—â–µ–π –±–∞–∑—ã."></textarea>
        </div>
        
        <button class="btn btn-primary full-width-btn" onclick="startProcessing()">
            <i class="fas fa-magic"></i>
            <span>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç</span>
        </button>

        <button class="btn btn-cloud full-width-btn hidden" id="btn-train-cloud" onclick="startCloudTraining()">
            <i class="fas fa-dumbbell"></i>
            <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞</span>
        </button>

        <div class="controls-row">
            <button class="btn btn-teal" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-upload"></i>
                <span>–ò–º–ø–æ—Ä—Ç</span>
            </button>
            <button class="btn btn-orange" onclick="smartReset()">
                <i class="fas fa-arrows-rotate"></i>
                <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
            </button>
        </div>
        <input type="file" id="fileInput" class="hidden-file" accept=".words,.json" onchange="importWords(this)">
    </div>

    <!-- SCREEN 2: GAME -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span style="font-weight: 800; color: var(--primary); font-size: 18px;">
                <i class="fas fa-star" style="color: var(--warning);"></i> 
                <span id="score">0</span>
            </span>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <button class="icon-btn" onclick="exitGame()" style="margin-left: 10px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="word-area">
            <div class="game-mode-label" id="game-mode-label"></div>
            <div id="target-word">Word</div>
        </div>
        <div class="options-area">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="screen">
        <div class="result-content">
            <div class="score-circle">
                <span class="score-val" id="final-percent">0%</span>
                <span style="font-size: 17px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">–¢–æ—á–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="result-stats-row">
                <div class="stat-bubble">
                    <i class="fas fa-list-check"></i> –í—Å–µ–≥–æ: <strong id="res-total">0</strong>
                </div>
                <div class="stat-bubble">
                    <i class="fas fa-times-circle"></i> –û—à–∏–±–æ–∫: <strong id="res-errors" style="color: #ffcccc">0</strong>
                </div>
            </div>

            <!-- Cloud Summary -->
            <div class="cloud-summary" id="cloud-summary">
                <div class="cloud-summary-text">
                    <i class="fas fa-cloud-upload-alt"></i> <span id="cloud-summary-msg"></span>
                </div>
                <div class="cloud-summary-stats" id="cloud-summary-stats"></div>
            </div>

            <button class="btn btn-success full-width-btn" onclick="restartGame(false)" id="btn-restart">
                <i class="fas fa-redo"></i>
                <span>–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</span>
            </button>

            <button class="btn btn-pink full-width-btn hidden" onclick="restartGame(true)" style="margin-top: 12px;" id="btn-reverse">
                <i class="fas fa-exchange-alt"></i>
                <span>–ò–≥—Ä–∞—Ç—å –Ω–∞–æ–±–æ—Ä–æ—Ç</span>
            </button>

            <button id="btn-show-mistakes" class="btn btn-secondary full-width-btn" onclick="toggleMistakes()" style="margin-top: 12px; display: none;">
                <i class="fas fa-clipboard-list"></i>
                <span>–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏</span>
            </button>

            <button class="btn btn-cloud full-width-btn hidden" id="btn-save-cloud" onclick="saveCurrentWordsToCloud()" style="margin-top: 12px;">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>–î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—â—É—é –±–∞–∑—É</span>
            </button>

            <button class="btn btn-info full-width-btn" onclick="goToInput()" style="margin-top: 12px;">
                <i class="fas fa-home"></i>
                <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
            </button>
            
            <button class="btn btn-warning full-width-btn" onclick="exportWords()" style="margin-top: 12px;">
                <i class="fas fa-download"></i>
                <span>–≠–∫—Å–ø–æ—Ä—Ç —Å–ª–æ–≤–∞—Ä—è</span>
            </button>

            <!-- Mistakes List -->
            <div id="mistakes-section">
                <h4 style="margin: 0 0 16px 0; color: var(--primary); font-size: 20px;">
                    <i class="fas fa-exclamation-triangle"></i> –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
                </h4>
                <div id="mistakes-container"></div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">‚ÑπÔ∏è</div>
            <h3 id="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
            <p id="modal-message">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
            <div class="modal-buttons" id="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div id="prompt-modal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-icon">üî¢</div>
            <h3 id="prompt-title">–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</h3>
            <p id="prompt-message">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
            <input type="number" id="prompt-input" class="prompt-input" min="1" max="100">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="prompt-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" id="prompt-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <h3 id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
        <p id="loader-sub"></p>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
        
        const MAPRUAPP_PROXY = "https://mapruapp.ru/ai/api/v1/chat/completions";
        const VERCEL_PROXY = "https://ver-olive-delta.vercel.app/v1beta/models";
        const MODEL = "gemini-2.0-flash-exp";
        
        let currentProxyIndex = 0;

        // ==========================================
        // SUPABASE INIT
        // ==========================================
        let sb = null;
        try {
            if (window.supabase) {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // ==========================================
        // APP STATE
        // ==========================================
        let state = {
            user: null,
            words: [],
            gameOrder: [],
            idx: 0,
            score: 0,
            mistakes: 0,
            mistakesLog: [],
            isReversed: false,
            mode: 'instant',
            locked: false,
            statsCache: null,
            statsCacheTime: 0,
            currentRound: 1,
            roundOneMistakes: 0
        };

        // ==========================================
        // SAFE DOM HELPERS
        // ==========================================
        const $ = (id) => document.getElementById(id);
        const setTxt = (id, txt) => {
            const el = $(id);
            if (el) el.textContent = txt;
        };
        const setHTML = (id, html) => {
            const el = $(id);
            if (el) el.innerHTML = html;
        };
        const show = (id) => {
            const el = $(id);
            if (el) el.classList.remove('hidden');
        };
        const hide = (id) => {
            const el = $(id);
            if (el) el.classList.add('hidden');
        };

        // ==========================================
        // CUSTOM MODALS
        // ==========================================
        function showAlert(message, title = '–í–Ω–∏–º–∞–Ω–∏–µ', icon = '‚ÑπÔ∏è') {
            return new Promise((resolve) => {
                const modal = $('custom-modal');
                const modalIcon = $('modal-icon');
                const modalTitle = $('modal-title');
                const modalMessage = $('modal-message');
                const modalButtons = $('modal-buttons');

                if (modalIcon) modalIcon.textContent = icon;
                if (modalTitle) modalTitle.textContent = title;
                if (modalMessage) modalMessage.innerHTML = message.replace(/\n/g, '<br>');
                
                if (modalButtons) {
                    modalButtons.innerHTML = '';
                    const btn = document.createElement('button');
                    btn.className = 'modal-btn modal-btn-primary';
                    btn.textContent = 'OK';
                    btn.onclick = () => {
                        modal.classList.remove('show');
                        resolve(true);
                    };
                    modalButtons.appendChild(btn);
                }

                modal.classList.add('show');
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        resolve(true);
                    }
                };
            });
        }

        function showConfirm(message, title = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', confirmText = '–î–∞', cancelText = '–ù–µ—Ç') {
            return new Promise((resolve) => {
                const modal = $('custom-modal');
                const modalIcon = $('modal-icon');
                const modalTitle = $('modal-title');
                const modalMessage = $('modal-message');
                const modalButtons = $('modal-buttons');

                if (modalIcon) modalIcon.textContent = '‚ö†Ô∏è';
                if (modalTitle) modalTitle.textContent = title;
                if (modalMessage) modalMessage.innerHTML = message.replace(/\n/g, '<br>');
                
                if (modalButtons) {
                    modalButtons.innerHTML = '';
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'modal-btn modal-btn-secondary';
                    cancelBtn.textContent = cancelText;
                    cancelBtn.onclick = () => {
                        modal.classList.remove('show');
                        resolve(false);
                    };
                    
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'modal-btn modal-btn-danger';
                    confirmBtn.textContent = confirmText;
                    confirmBtn.onclick = () => {
                        modal.classList.remove('show');
                        resolve(true);
                    };
                    
                    modalButtons.appendChild(cancelBtn);
                    modalButtons.appendChild(confirmBtn);
                }

                modal.classList.add('show');
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        resolve(false);
                    }
                };
            });
        }

        function showPrompt(message, title = '–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ', defaultValue = '10', min = 1, max = 100) {
            return new Promise((resolve) => {
                const modal = $('prompt-modal');
                const modalTitle = $('prompt-title');
                const modalMessage = $('prompt-message');
                const input = $('prompt-input');
                const okBtn = $('prompt-ok');
                const cancelBtn = $('prompt-cancel');

                if (modalTitle) modalTitle.textContent = title;
                if (modalMessage) modalMessage.innerHTML = message.replace(/\n/g, '<br>');
                if (input) {
                    input.value = defaultValue;
                    input.min = min;
                    input.max = max;
                }

                const closeModal = (value) => {
                    modal.classList.remove('show');
                    resolve(value);
                };

                if (okBtn) {
                    okBtn.onclick = () => {
                        const val = input ? input.value : null;
                        closeModal(val);
                    };
                }

                if (cancelBtn) {
                    cancelBtn.onclick = () => closeModal(null);
                }

                if (input) {
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            closeModal(input.value);
                        } else if (e.key === 'Escape') {
                            closeModal(null);
                        }
                    };
                }

                modal.classList.add('show');
                
                setTimeout(() => {
                    if (input) input.focus();
                }, 100);
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal(null);
                    }
                };
            });
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        async function initAuth() {
            if (!sb) return;
            
            const { data: { session } } = await sb.auth.getSession();
            if (session) handleUser(session.user);

            sb.auth.onAuthStateChange((_event, session) => {
                if (session) handleUser(session.user);
                else handleLogout();
            });
        }

        function handleUser(user) {
            state.user = user;
            
            hide('guest-display');
            show('user-display');
            show('cloud-actions');
            
            const email = user.email.split('@')[0];
            setTxt('u-email', email);
            setTxt('u-avatar', email[0].toUpperCase());
            
            const authBtn = $('auth-btn');
            if (authBtn) {
                authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏';
                authBtn.onclick = signOut;
                authBtn.classList.add('logout');
            }

            const stats = $('cloud-stats');
            if (stats) stats.style.display = 'grid';
            
            show('btn-train-cloud');
            
            fetchStats();
        }

        function handleLogout() {
            state.user = null;
            
            show('guest-display');
            hide('user-display');
            hide('cloud-actions');
            
            const authBtn = $('auth-btn');
            if (authBtn) {
                authBtn.innerHTML = '<i class="fab fa-google"></i> –í–æ–π—Ç–∏';
                authBtn.onclick = handleAuth;
                authBtn.classList.remove('logout');
            }

            const stats = $('cloud-stats');
            if (stats) stats.style.display = 'none';

            hide('btn-train-cloud');
            setTxt('due-count', '0');
        }

        async function handleAuth() {
            if (!sb) {
                await showAlert("Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!", "–û—à–∏–±–∫–∞", "‚ùå");
                return;
            }
            
            try {
                await sb.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
            } catch (error) {
                console.error('Auth error:', error);
                await showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message, "–û—à–∏–±–∫–∞", "‚ùå");
            }
        }

        async function signOut() {
            if (!sb) return;
            await sb.auth.signOut();
            window.location.reload();
        }

        // ==========================================
        // CLOUD STATISTICS
        // ==========================================
        async function fetchStats(forceRefresh = false) {
            if (!state.user) return;
            
            if (!forceRefresh && state.statsCache && Date.now() - state.statsCacheTime < 30000) {
                updateStatsUI(state.statsCache);
                return;
            }
            
            try {
                const { count: totalWords, error: countError } = await sb
                    .from('words')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;

                const { count: learnedCount, error: learnedError } = await sb
                    .from('user_words')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', state.user.id)
                    .eq('status', 'learned');
                
                if (learnedError) throw learnedError;

                const learned = learnedCount || 0;
                const newCount = (totalWords || 0) - learned;
                const due = newCount;

                const stats = { learned, newCount, due };
                state.statsCache = stats;
                state.statsCacheTime = Date.now();
                
                updateStatsUI(stats);
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        function updateStatsUI(stats) {
            setTxt('stat-learned', stats.learned);
            setTxt('stat-new', stats.newCount);
            setTxt('due-count', stats.due);

            const btn = $('btn-train-cloud');
            if (btn) {
                if (stats.due > 0) {
                    btn.style.opacity = '1';
                    btn.disabled = false;
                    setHTML('btn-train-cloud', `
                        <i class="fas fa-dumbbell"></i>
                        <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞</span>
                    `);
                } else {
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                    setHTML('btn-train-cloud', `
                        <i class="fas fa-check-circle"></i>
                        <span>–í—Å—ë –≤—ã—É—á–µ–Ω–æ!</span>
                    `);
                }
            }
        }

        // ==========================================
        // CLOUD WORD MANAGEMENT
        // ==========================================
        async function saveCurrentWordsToCloud() {
            if (!state.user || state.words.length === 0) return;
            
            setLoading(true, "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±—â—É—é –±–∞–∑—É...");

            try {
                const wordsToAdd = state.words.map(w => ({
                    original: w.original.toLowerCase(),
                    translation: w.translation.toLowerCase(),
                    language: detectLanguage(w.original)
                }));

                for (const word of wordsToAdd) {
                    const { error } = await sb
                        .from('words')
                        .upsert(word, { onConflict: 'original,language', ignoreDuplicates: true });
                    
                    if (error && error.code !== '23505') {
                        console.error('Error inserting word:', error);
                    }
                }
                
                await showAlert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${wordsToAdd.length} —Å–ª–æ–≤ –≤ –æ–±—â—É—é –±–∞–∑—É!\n\n–¢–µ–ø–µ—Ä—å –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.`, "–£—Å–ø–µ—Ö", "üéâ");
                hide('btn-save-cloud');
                await fetchStats(true);
            } catch (error) {
                console.error('Error saving words:', error);
                await showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message, "–û—à–∏–±–∫–∞", "‚ùå");
            } finally {
                setLoading(false);
            }
        }

        async function startCloudTraining() {
            if (!state.user) return;
            
            const count = await showPrompt(
                '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 5-20 —Å–ª–æ–≤ –∑–∞ —Ä–∞–∑',
                '–°–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å?',
                '10',
                1,
                100
            );
            
            if (!count || isNaN(count) || count < 1) return;
            
            const limit = Math.min(parseInt(count), 100);
            
            setLoading(true, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤...");
            
            try {
                const { data: learnedWords, error: learnedError } = await sb
                    .from('user_words')
                    .select('word_id')
                    .eq('user_id', state.user.id)
                    .eq('status', 'learned');
                
                if (learnedError) throw learnedError;

                const learnedIds = learnedWords ? learnedWords.map(w => w.word_id) : [];

                let query = sb
                    .from('words')
                    .select('*')
                    .limit(limit * 3);
                
                if (learnedIds.length > 0) {
                    query = query.not('id', 'in', `(${learnedIds.join(',')})`);
                }

                const { data: allWords, error: wordsError } = await query;
                
                if (wordsError) throw wordsError;

                if (!allWords || allWords.length === 0) {
                    setLoading(false);
                    await showAlert("–í—Å–µ —Å–ª–æ–≤–∞ —É–∂–µ –≤—ã—É—á–µ–Ω—ã!", "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º", "üéâ");
                    return;
                }

                const shuffled = allWords.sort(() => Math.random() - 0.5);
                const selectedWords = shuffled.slice(0, limit);

                if (selectedWords.length < 4) {
                    setLoading(false);
                    await showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤. –ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ ${selectedWords.length}.\n\n–ú–∏–Ω–∏–º—É–º –Ω—É–∂–Ω–æ 4 —Å–ª–æ–≤–∞.`, "–í–Ω–∏–º–∞–Ω–∏–µ", "‚ö†Ô∏è");
                    return;
                }

                state.words = selectedWords;
                state.gameOrder = [...selectedWords].sort(() => Math.random() - 0.5);
                state.mode = 'cloud';
                state.idx = 0;
                state.score = 0;
                state.mistakes = 0;
                state.mistakesLog = [];
                state.isReversed = false;
                state.currentRound = 1;
                state.roundOneMistakes = 0;
                
                setLoading(false);
                showScreen('screen-game');
                nextWord();
            } catch (error) {
                console.error('Error loading cloud words:', error);
                setLoading(false);
                await showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message, "–û—à–∏–±–∫–∞", "‚ùå");
            }
        }

        async function saveProgressToCloud() {
            if (!state.user || state.mode !== 'cloud') return;
            
            try {
                const wordsToSave = state.gameOrder.map(w => ({
                    user_id: state.user.id,
                    word_id: w.id,
                    status: 'learned'
                }));

                const { error } = await sb
                    .from('user_words')
                    .upsert(wordsToSave, { onConflict: 'user_id,word_id' });
                
                if (error) throw error;

                await fetchStats(true);
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        async function resetAllProgress() {
            if (!state.user) return;
            
            const confirm1 = await showConfirm(
                '–í—Å–µ –≤—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.',
                '–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?',
                '–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å',
                '–û—Ç–º–µ–Ω–∞'
            );
            if (!confirm1) return;
            
            const confirm2 = await showConfirm(
                '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
                '–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å?',
                '–î–∞, —Ç–æ—á–Ω–æ',
                '–ù–µ—Ç'
            );
            if (!confirm2) return;
            
            setLoading(true, "–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...");
            
            try {
                const { error } = await sb
                    .from('user_words')
                    .delete()
                    .eq('user_id', state.user.id);
                
                if (error) throw error;
                
                await showAlert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω! –í—Å–µ —Å–ª–æ–≤–∞ –≥–æ—Ç–æ–≤—ã –∫ –∏–∑—É—á–µ–Ω–∏—é.', '–ì–æ—Ç–æ–≤–æ', '‚úÖ');
                await fetchStats(true);
                
            } catch (error) {
                console.error('Error resetting progress:', error);
                await showAlert('–û—à–∏–±–∫–∞: ' + error.message, '–û—à–∏–±–∫–∞', '‚ùå');
            } finally {
                setLoading(false);
            }
        }

        // ==========================================
        // AI TEXT PROCESSING
        // ==========================================
        async function startProcessing() {
            const text = $('sourceText').value;
            if (text.trim().length < 5) {
                await showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.", "–í–Ω–∏–º–∞–Ω–∏–µ", "‚ö†Ô∏è");
                return;
            }
            
            setLoading(true, "–†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–≤–∞...");
            
            const rawWords = text.match(/[a-zA-Z\u00C0-\u00FF]+|[–∞-—è–ê-–Ø—ë–Å]+/g) || [];
            
            const uniqueSet = new Set();
            rawWords.forEach(w => {
                if (w.length > 2) uniqueSet.add(w.toLowerCase());
            });
            
            let wordsList = Array.from(uniqueSet);
            
            if (wordsList.length < 4) {
                setLoading(false);
                await showAlert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤–∞.", "–í–Ω–∏–º–∞–Ω–∏–µ", "‚ö†Ô∏è");
                return;
            }
            
            if (wordsList.length > 200) {
                const confirmed = await showConfirm(
                    `–ù–∞–π–¥–µ–Ω–æ ${wordsList.length} —Å–ª–æ–≤. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–µ 200?`,
                    '–ú–Ω–æ–≥–æ —Å–ª–æ–≤',
                    '–î–∞',
                    '–û—Ç–º–µ–Ω–∞'
                );
                if (!confirmed) {
                    setLoading(false);
                    return;
                }
                wordsList = wordsList.slice(0, 200);
            }
            
            setLoading(true, `–ò–ò –ø–µ—Ä–µ–≤–æ–¥–∏—Ç ${wordsList.length} —Å–ª–æ–≤...`);
            
            const prompt = `
I have a list of words. 
1. Detect the source language.
2. Translate each word from the source language to Russian.
3. If the source language IS Russian, translate them to English.

Return strictly a JSON array of objects with keys: "original" (source word) and "translation" (translated word).
Return ONLY the JSON array. No markdown, no extra text.

List of words:
${JSON.stringify(wordsList)}
            `;
            
            try {
                let jsonStr = await callAI(prompt);
                
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                
                let translatedData;
                try {
                    translatedData = JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error("Failed to parse JSON:", jsonStr);
                    throw new Error("Invalid JSON format from AI");
                }
                
                if (!Array.isArray(translatedData)) {
                    throw new Error("Invalid AI response format");
                }
                
                state.words = translatedData.filter(item => 
                    item.original && item.translation && !item.original.includes(' ')
                );
                
                if (state.words.length < 4) {
                    throw new Error("–ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤");
                }
                
                state.mode = 'instant';
                startGame(false);
            } catch (e) {
                console.error(e);
                await showAlert("–û—à–∏–±–∫–∞ –ò–ò: " + e.message, "–û—à–∏–±–∫–∞", "‚ùå");
            } finally {
                setLoading(false);
            }
        }

        async function callAI(prompt) {
            const proxies = [
                {
                    name: "MAPRUAPP",
                    url: MAPRUAPP_PROXY,
                    buildBody: () => ({
                        model: MODEL,
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 8000,
                        response_format: { type: "json_object" }
                    }),
                    extractContent: (data) => data.choices[0].message.content
                },
                {
                    name: "VERCEL",
                    url: `${VERCEL_PROXY}/${MODEL}:generateContent`,
                    buildBody: () => ({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    }),
                    extractContent: (data) => data.candidates[0].content.parts[0].text
                }
            ];

            let attempts = 0;
            const maxAttempts = proxies.length;

            while (attempts < maxAttempts) {
                const proxy = proxies[currentProxyIndex];
                
                try {
                    console.log(`–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ ${proxy.name}...`);
                    
                    const res = await fetch(proxy.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxy.buildBody())
                    });
                    
                    if (!res.ok) {
                        throw new Error(`${proxy.name} returned status ${res.status}`);
                    }
                    
                    const data = await res.json();
                    const content = proxy.extractContent(data);
                    
                    console.log(`‚úì –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç ${proxy.name}`);
                    return content;
                    
                } catch (error) {
                    console.error(`‚úó –û—à–∏–±–∫–∞ ${proxy.name}:`, error.message);
                    
                    currentProxyIndex = (currentProxyIndex + 1) % proxies.length;
                    attempts++;
                    
                    if (attempts < maxAttempts) {
                        console.log(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ ${proxies[currentProxyIndex].name}...`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            throw new Error("–í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        }

        // ==========================================
        // GAME LOGIC
        // ==========================================
        function startGame(reversed = false) {
            if (state.words.length < 4) {
                showAlert("–°–ª–∏—à–∫–æ–º –º–∞–ª–æ —Å–ª–æ–≤.", "–í–Ω–∏–º–∞–Ω–∏–µ", "‚ö†Ô∏è");
                return;
            }
            
            state.isReversed = reversed;
            state.gameOrder = [...state.words].sort(() => Math.random() - 0.5);
            state.idx = 0;
            state.score = 0;
            state.mistakes = 0;
            state.mistakesLog = [];
            state.currentRound = 1;
            state.roundOneMistakes = 0;
            
            showScreen('screen-game');
            nextWord();
        }

        function restartGame(reversed) {
            if (state.mode === 'cloud') {
                startCloudTraining();
            } else {
                startGame(reversed);
            }
        }

        function nextWord() {
            if (state.idx >= state.gameOrder.length) {
                endGame();
                return;
            }
            
            state.locked = false;
            const current = state.gameOrder[state.idx];
            
            const modeLabel = $('game-mode-label');
            if (modeLabel) {
                if (state.mode === 'cloud') {
                    const roundText = state.currentRound === 1 ? '–†–∞—É–Ω–¥ 1: –ü—Ä—è–º–æ–π' : '–†–∞—É–Ω–¥ 2: –û–±—Ä–∞—Ç–Ω—ã–π';
                    modeLabel.innerHTML = `<i class="fas fa-cloud"></i> ${roundText}`;
                } else {
                    modeLabel.innerHTML = '<i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞';
                }
            }
            
            const targetEl = $('target-word');
            if (targetEl) {
                targetEl.style.animation = 'none';
                targetEl.offsetHeight;
                targetEl.style.animation = 'flashAppear 0.3s ease-out';
                
                const questionText = state.isReversed ? current.translation : current.original;
                targetEl.textContent = questionText;
            }

            setTxt('score', state.score);
            
            const progressEl = $('progress');
            if (progressEl) {
                const pct = (state.idx / state.gameOrder.length) * 100;
                progressEl.style.width = `${pct}%`;
            }
            
            renderOptions(current);
        }

        function renderOptions(correct) {
            const container = $('options-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            let pool = state.words.filter(w => 
                (w.id ? w.id !== correct.id : w.original !== correct.original)
            );
            
            if (pool.length < 3) {
                pool = [...pool, ...pool, ...pool];
            }
            
            let distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3);
            let options = [correct, ...distractors].sort(() => Math.random() - 0.5);
            
            const answerKey = state.isReversed ? 'original' : 'translation';

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt[answerKey];
                btn.style.animationDelay = (index * 0.05) + 's';
                btn.onclick = () => handleAnswer(opt, correct, btn);
                container.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btn) {
            if (state.locked) return;
            state.locked = true;
            
            const isCorrect = (selected.id && correct.id) 
                ? selected.id === correct.id 
                : selected.original === correct.original;
            
            if (isCorrect) {
                btn.classList.add('correct-anim');
                state.score++;
            } else {
                btn.classList.add('wrong-anim');
                state.mistakes++;
                
                if (state.currentRound === 1) {
                    state.roundOneMistakes++;
                }
                
                const qKey = state.isReversed ? 'translation' : 'original';
                const aKey = state.isReversed ? 'original' : 'translation';
                
                state.mistakesLog.push({
                    word: correct[qKey],
                    chosen: selected[aKey],
                    correct: correct[aKey]
                });

                const correctText = correct[aKey];
                Array.from(document.querySelectorAll('.option-btn')).forEach(b => {
                    if (b.textContent === correctText) {
                        b.style.transition = "all 0.3s";
                        b.style.border = "4px solid var(--success)";
                        b.style.boxShadow = "0 0 30px var(--success)";
                        b.style.transform = "scale(1.05)";
                    }
                });
            }
            
            setTimeout(() => {
                state.idx++;
                nextWord();
            }, 600);
        }

        function endGame() {
            const total = state.gameOrder.length;
            const accuracy = Math.round((state.score / total) * 100);
            
            if (state.mode === 'cloud' && state.currentRound === 1) {
                if (state.roundOneMistakes === 0) {
                    state.currentRound = 2;
                    state.isReversed = true;
                    state.idx = 0;
                    state.score = 0;
                    state.mistakes = 0;
                    state.gameOrder = [...state.words].sort(() => Math.random() - 0.5);
                    nextWord();
                    return;
                } else {
                    showResultScreen(accuracy, total, false);
                }
            } else if (state.mode === 'cloud' && state.currentRound === 2) {
                if (state.mistakes === 0 && state.roundOneMistakes === 0) {
                    saveProgressToCloud();
                    showResultScreen(accuracy, total, true);
                } else {
                    showResultScreen(accuracy, total, false);
                }
            } else {
                showResultScreen(accuracy, total, false);
            }
        }

        function showResultScreen(accuracy, total, learned) {
            showScreen('screen-result');
            
            setTxt('final-percent', `${accuracy}%`);
            setTxt('res-total', total);
            setTxt('res-errors', state.mistakes);

            const mistakesBtn = $('btn-show-mistakes');
            const mistakesSec = $('mistakes-section');
            
            if (mistakesSec) mistakesSec.style.display = 'none';
            
            if (state.mistakesLog.length > 0) {
                if (mistakesBtn) mistakesBtn.style.display = 'flex';
                renderMistakesList();
            } else {
                if (mistakesBtn) mistakesBtn.style.display = 'none';
            }

            const cloudSummary = $('cloud-summary');
            const saveBtn = $('btn-save-cloud');
            const restartBtn = $('btn-restart');
            const reverseBtn = $('btn-reverse');
            
            if (state.mode === 'cloud') {
                if (cloudSummary) {
                    cloudSummary.classList.add('show');
                    
                    if (learned) {
                        setTxt('cloud-summary-msg', 'üéâ –°–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã! –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
                        setHTML('cloud-summary-stats', `
                            <span><i class="fas fa-check-circle"></i> –û–±–∞ —Ä–∞—É–Ω–¥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã –∏–¥–µ–∞–ª—å–Ω–æ!</span>
                        `);
                    } else {
                        setTxt('cloud-summary-msg', '‚ö†Ô∏è –ï—Å—Ç—å –æ—à–∏–±–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        setHTML('cloud-summary-stats', `
                            <span><i class="fas fa-redo"></i> –ù—É–∂–Ω–æ 100% –≤ –æ–±–æ–∏—Ö —Ä–∞—É–Ω–¥–∞—Ö</span>
                        `);
                    }
                }
                hide('btn-save-cloud');
                hide('btn-reverse');
                
                if (restartBtn) {
                    restartBtn.innerHTML = '<i class="fas fa-redo"></i><span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>';
                }
            } else {
                if (cloudSummary) cloudSummary.classList.remove('show');
                
                if (state.user) {
                    show('btn-save-cloud');
                } else {
                    hide('btn-save-cloud');
                }
                
                show('btn-reverse');
                
                if (restartBtn) {
                    restartBtn.innerHTML = '<i class="fas fa-redo"></i><span>–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</span>';
                }
            }
        }

        function renderMistakesList() {
            const container = $('mistakes-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            state.mistakesLog.forEach(log => {
                const div = document.createElement('div');
                div.className = 'mistake-card';
                div.innerHTML = `
                    <div class="m-word"><i class="fas fa-circle-exclamation" style="color: var(--error); margin-right: 6px;"></i>${log.word}</div>
                    <div>
                        <span class="m-wrong"><i class="fas fa-xmark"></i> ${log.chosen}</span>
                        <span class="m-right"><i class="fas fa-check"></i> ${log.correct}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleMistakes() {
            const sec = $('mistakes-section');
            const btn = $('btn-show-mistakes');
            
            if (!sec || !btn) return;
            
            if (sec.style.display === 'none') {
                sec.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i><span>–°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫–∏</span>';
                
                setTimeout(() => {
                    const resContent = document.querySelector('.result-content');
                    if (resContent) resContent.scrollTop = resContent.scrollHeight;
                }, 100);
            } else {
                sec.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-clipboard-list"></i><span>–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏</span>';
            }
        }

        // ==========================================
        // IMPORT / EXPORT
        // ==========================================
        function exportWords() {
            if (!state.words || state.words.length === 0) return;
            
            const dataStr = JSON.stringify(state.words, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dictionary_${new Date().getTime()}.words`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importWords(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    if (Array.isArray(json) && json.length > 0 && json[0].original) {
                        state.words = json;
                        state.mode = 'instant';
                        await showAlert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${json.length} —Å–ª–æ–≤.`, "–£—Å–ø–µ—Ö", "‚úì");
                        startGame(false);
                    } else {
                        throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
                    }
                } catch (err) {
                    await showAlert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err.message, "–û—à–∏–±–∫–∞", "‚ùå");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = $(id);
            if (screen) screen.classList.add('active');
        }

        function goToInput() {
            showScreen('screen-input');
            if (state.mode === 'cloud') {
                fetchStats(true);
            }
        }

        function exitGame() {
            if (state.mode === 'cloud') {
                fetchStats(true);
            }
            goToInput();
        }

        function setLoading(active, text = "") {
            const loader = $('loader');
            if (loader) loader.style.display = active ? 'flex' : 'none';
            
            if (text) setTxt('loader-sub', text);
        }

        async function smartReset() {
            const txtArea = $('sourceText');
            if (!txtArea) return;
            
            txtArea.value = '';
            
            try {
                const text = await navigator.clipboard.readText();
                const wordCount = text.trim().split(/\s+/).length;
                
                if (wordCount > 10) {
                    txtArea.value = text;
                    txtArea.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
                    setTimeout(() => txtArea.style.background = 'transparent', 600);
                }
            } catch (err) {
                console.log('Clipboard access denied or empty');
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function detectLanguage(word) {
            if (/^[–∞-—è–ê-–Ø—ë–Å]+$/.test(word)) return 'russian';
            if (/^[a-zA-Z]+$/.test(word)) return 'english';
            return 'other';
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.onload = function() {
            initAuth();
            
            const authBtn = $('auth-btn');
            if (authBtn) {
                authBtn.onclick = handleAuth;
            }
        };
    </script>
</body>
</html>
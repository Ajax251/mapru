<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка текста</title>
    <link rel="icon" href="img/check.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Frost Theme (Default) */
            --bg-gradient: linear-gradient(135deg, #e8f4fc 0%, #f0f8ff 50%, #e6f2ff 100%);
            --bg-primary: #f5faff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8f4fc;
            --bg-hover: #d6ebfa;
            --bg-frost: rgba(255, 255, 255, 0.85);
            --text-primary: #1e3a5f;
            --text-secondary: #4a6d8c;
            --text-muted: #8ba4bc;
            --accent-color: #4facfe;
            --accent-hover: #00c6fb;
            --accent-light: #e0f4ff;
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --accent-glow: rgba(79, 172, 254, 0.25);
            --border-color: #c8e3f5;
            --success-color: #22c997;
            --success-gradient: linear-gradient(135deg, #22c997 0%, #00d4aa 100%);
            --warning-color: #ffb347;
            --danger-color: #ff6b6b;
            --purple-color: #a78bfa;
            --purple-gradient: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
            --orange-color: #fb923c;
            --orange-gradient: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            --shadow-soft: 0 4px 20px rgba(79, 172, 254, 0.1);
            --shadow-card: 0 8px 32px rgba(79, 172, 254, 0.12);
            --shadow-hover: 0 12px 40px rgba(79, 172, 254, 0.18);
            --shadow-glow: 0 0 30px rgba(79, 172, 254, 0.2);
            --header-bg: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(232,244,252,0.95) 100%);
            --status-bar-bg: linear-gradient(135deg, rgba(79, 172, 254, 0.95) 0%, rgba(0, 242, 254, 0.95) 100%);
        }

        [data-theme="soft-green"] {
            --bg-gradient: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 50%, #e8f5e9 100%);
            --bg-primary: #f5faf5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8f5e9;
            --bg-hover: #c8e6c9;
            --bg-frost: rgba(255, 255, 255, 0.85);
            --text-primary: #1b5e20;
            --text-secondary: #388e3c;
            --text-muted: #81c784;
            --accent-color: #4caf50;
            --accent-hover: #66bb6a;
            --accent-light: #e8f5e9;
            --accent-gradient: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            --accent-glow: rgba(76, 175, 80, 0.25);
            --border-color: #c8e6c9;
            --success-color: #2e7d32;
            --success-gradient: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --purple-color: #9c27b0;
            --purple-gradient: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            --orange-color: #ff9800;
            --orange-gradient: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
            --shadow-soft: 0 4px 20px rgba(76, 175, 80, 0.1);
            --shadow-card: 0 8px 32px rgba(76, 175, 80, 0.12);
            --shadow-hover: 0 12px 40px rgba(76, 175, 80, 0.18);
            --shadow-glow: 0 0 30px rgba(76, 175, 80, 0.2);
            --header-bg: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(232,245,233,0.95) 100%);
            --status-bar-bg: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(139, 195, 74, 0.95) 100%);
        }

        [data-theme="corporate"] {
            --bg-gradient: linear-gradient(180deg, #f8fafc 0%, #ffffff 50%, #f1f5f9 100%);
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;
            --bg-frost: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent-color: #2563eb;
            --accent-hover: #3b82f6;
            --accent-light: #eff6ff;
            --accent-gradient: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --accent-glow: rgba(37, 99, 235, 0.2);
            --border-color: #e2e8f0;
            --success-color: #16a34a;
            --success-gradient: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --purple-color: #7c3aed;
            --purple-gradient: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
            --orange-color: #ea580c;
            --orange-gradient: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            --shadow-soft: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            --header-bg: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            --status-bar-bg: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.8) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.6) 1px, transparent 1px),
                radial-gradient(circle at 40% 70%, rgba(255,255,255,0.7) 1px, transparent 1px);
            background-size: 100px 100px, 150px 150px, 200px 200px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }

        [data-theme="corporate"] body::before {
            opacity: 0;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 24px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            gap: 16px;
            position: relative;
            z-index: 1;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title i {
            font-size: 22px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            padding: 0 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            gap: 8px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: var(--shadow-hover);
            transform: translateY(-1px);
        }

        .header-btn i { font-size: 15px; }

        .header-btn.icon-only {
            width: 40px;
            padding: 0;
        }

        #container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            flex: 1; 
            padding: 20px; 
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        #textInput { 
            width: 100%; 
            height: 60vh; 
            padding: 16px 20px; 
            font-size: 15px; 
            border: 2px solid var(--border-color); 
            border-radius: 16px; 
            box-sizing: border-box; 
            resize: none; 
            margin-bottom: 15px; 
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            box-shadow: var(--shadow-soft);
        }

        #textInput:focus { 
            border-color: var(--accent-color); 
            outline: none;
            box-shadow: var(--shadow-glow);
        }

        #textInput:disabled { 
            background-color: var(--bg-tertiary); 
            cursor: wait; 
        }

        #textInput::placeholder {
            color: var(--text-muted);
        }

  #buttonContainer { 
            display: flex; 
            justify-content: space-evenly; /* Равномерные отступы между кнопками и по краям */
            flex-wrap: wrap; 
            width: 100%; 
            margin-bottom: 20px; 
            gap: 20px; 
        }

        button { 
            padding: 12px 20px; 
            font-size: 14px; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 600;
            font-family: inherit;
            box-shadow: var(--shadow-card);
        }

        button i { margin-right: 8px; font-size: 14px; }

        button:hover { 
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        #checkButton {
            background: var(--success-gradient);
        }

        #checkButton:hover {
            filter: brightness(1.1);
        }

        #checkWithAIButton { 
            background: var(--accent-gradient);
        }

        #checkWithAIButton:hover {
            filter: brightness(1.1);
        }

        #copyButton { 
            background: var(--orange-gradient);
        }

        #copyButton:hover {
            filter: brightness(1.1);
        }

        #resultsContainer { 
            display: flex; 
            width: 100%; 
            justify-content: space-around; 
            flex-wrap: wrap; 
            gap: 15px; 
        }

        #cadastralResult, #linksResult, #foreignLettersResult, #fileNamesResult, #datesResult { 
            flex-basis: calc(33.333% - 20px); 
            flex-grow: 1; 
            min-width: 280px; 
            border: 1px solid var(--border-color); 
            border-radius: 16px; 
            padding: 15px; 
            box-sizing: border-box; 
            background: var(--bg-frost);
            box-shadow: var(--shadow-card); 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        #foreignLettersResult { display: none; }

        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 10px; 
        }

        .result-icon { 
            font-size: 24px; 
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .save-icon { 
            font-size: 20px; 
            color: var(--accent-color); 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        .save-icon:hover { 
            color: var(--accent-hover);
            transform: scale(1.1);
        }

        #cadastralResult ul, #linksResult ul, #foreignLettersResult ul, #fileNamesResult ul, #datesResult ul { 
            list-style-type: none; 
            padding: 0; 
            margin: 0; 
            max-height: 220px; 
            overflow-y: auto; 
        }

        #cadastralResult li, #linksResult li, #foreignLettersResult li, #fileNamesResult li, #datesResult li { 
            background-color: var(--bg-primary); 
            margin-bottom: 8px; 
            padding: 12px; 
            border-radius: 10px; 
            transition: all 0.3s ease; 
            text-align: left;  
            word-break: break-all; 
            display: flex;  
            justify-content: space-between;  
            align-items: center;
            border: 1px solid var(--border-color);
        }

        #cadastralResult li .cadastral-number-text { cursor: pointer; flex-grow: 1; margin-right: 5px; }
        #cadastralResult li .cadastral-icons img { cursor: pointer; vertical-align: middle; width: 16px; height: 16px; }
        #cadastralResult li .cadastral-icons img:first-child { margin-left: 8px; }
        #cadastralResult li .cadastral-icons img + img { margin-left: 5px; }

        .error-category { 
            background: var(--bg-tertiary) !important; 
            font-weight: bold; 
            cursor: default !important; 
            padding: 10px 12px !important; 
            margin-top: 10px !important; 
            margin-bottom: 10px !important; 
        }

        .error-category:first-child { margin-top: 0 !important; }

        #cadastralResult li:hover, #linksResult li:hover, #foreignLettersResult li:not(.error-category):hover, #fileNamesResult li:hover, #datesResult li:hover { 
            background-color: var(--accent-light);
            border-color: var(--accent-color);
            transform: translateX(4px);
        }

        #linksResult a { 
            color: var(--accent-color); 
            text-decoration: none; 
            transition: color 0.3s ease; 
            display: block;
            font-weight: 500;
        }

        #linksResult a:hover { 
            color: var(--text-primary); 
            text-decoration: underline; 
        }

        .error { background-color: #ffdddd; color: #f44336; padding: 2px 4px; border-radius: 3px; }
        .foreign-letter span { background-color: #ffe6e6; color: #ff0000; font-weight: bold; padding: 0 1px; }
        .inner-cadastral .cadastral-number-text { color: var(--success-color); }
        .not-found .cadastral-number-text { color: var(--danger-color); }
        .not-found { color: var(--danger-color); }

        @keyframes flash { 
            0% { background-color: var(--bg-primary); } 
            50% { background-color: var(--accent-color); color: white; } 
            100% { background-color: var(--bg-primary); } 
        }
        .flash { animation: flash 0.5s; }

        #cadastralResult ul::-webkit-scrollbar, #linksResult ul::-webkit-scrollbar, #foreignLettersResult ul::-webkit-scrollbar, #fileNamesResult ul::-webkit-scrollbar, #datesResult ul::-webkit-scrollbar { width: 8px; }
        #cadastralResult ul::-webkit-scrollbar-track, #linksResult ul::-webkit-scrollbar-track, #foreignLettersResult ul::-webkit-scrollbar-track, #fileNamesResult ul::-webkit-scrollbar-track, #datesResult ul::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 4px; }
        #cadastralResult ul::-webkit-scrollbar-thumb, #linksResult ul::-webkit-scrollbar-thumb, #foreignLettersResult ul::-webkit-scrollbar-thumb, #fileNamesResult ul::-webkit-scrollbar-thumb, #datesResult ul::-webkit-scrollbar-thumb { 
            background: var(--accent-gradient);
            border-radius: 4px; 
        }

        .flash-animation { animation: flashTextarea 0.3s; }
        @keyframes flashTextarea { 
            0% { border-color: var(--border-color); } 
            50% { border-color: var(--accent-color); box-shadow: var(--shadow-glow); } 
            100% { border-color: var(--border-color); } 
        }

        #statusBar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--status-bar-bg);
            color: white; 
            padding: 10px 16px; 
            font-size: 13px; 
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15); 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
            justify-content: space-around; 
            transition: opacity 0.3s ease, transform 0.3s ease; 
            transform: translateY(100%); 
            opacity: 0; 
            z-index: 900;
            backdrop-filter: blur(10px);
        }

        #statusBar.visible { transform: translateY(0); opacity: 1; }
        #statusBar i { margin-right: 5px; font-size: 14px; }
        #statusBar span { margin: 2px 8px; white-space: nowrap; font-weight: 500; }

        .flash-button { animation: flashButtonAnim 0.3s; }
        @keyframes flashButtonAnim { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); filter: brightness(1.2); } 
            100% { transform: scale(1); } 
        }

        #currentLine { 
            margin-left: auto; 
            padding: 4px 12px; 
            background-color: rgba(255, 255, 255, 0.2); 
            border-radius: 8px; 
        }

        #datesResult li.invalid-date { 
            background-color: #ffdddd; 
            color: #d8000c; 
            font-weight: bold; 
        }

        /* Modal Styles */
        .modal-overlay { 
            position: fixed; 
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            display: none; 
            align-items: center;
            justify-content: center; 
            z-index: 1000; 
            padding: 20px; 
        }

        .modal-content { 
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px; 
            width: 100%;
            max-width: 580px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .modal-header h2 i { color: var(--accent-color); }

        .modal-close {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-close:hover { 
            background: var(--danger-color); 
            color: white; 
            border-color: var(--danger-color);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        /* AI Modal */
        .ai-modal-content { 
            max-width: 1200px;
            width: 80%;
            height: 80%;
        }

        .ai-modal-content h2 { 
            margin-top: 0; 
            margin-bottom: 15px; 
            text-align: center; 
            color: var(--text-primary); 
            font-size: 1.3em; 
        }

        .ai-result-display-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            padding: 15px; 
            font-size: 16px; 
            line-height: 1.6; 
            background-color: var(--bg-primary); 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            color: var(--text-primary);
            border-radius: 12px;
        }

        .ai-correction-item { padding: 3px 0; font-size: 0.9em; }
        .ai-correction-original { text-decoration: line-through; color: var(--danger-color); margin-right: 5px; }
        .ai-correction-corrected { color: var(--success-color); font-weight: bold; }

        #aiCheckModal button.modal-action-button { 
            margin-top: 15px; 
            align-self: center; 
            background: var(--accent-gradient);
            font-size: 15px; 
            padding: 12px 20px;
            border-radius: 12px;
        }

        #aiCheckLoading { 
            text-align: center; 
            padding: 20px; 
            font-size: 1.2em; 
            color: var(--text-secondary); 
        }

        #aiCheckLoading i { 
            font-size: 2.5em; 
            color: var(--accent-color); 
            margin-bottom: 10px; 
        }

        /* Settings Modal */
        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group:last-child { margin-bottom: 0; }

        .settings-group label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .settings-group select,
        .settings-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            box-shadow: var(--shadow-soft);
        }

        .settings-group select:focus,
        .settings-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-glow);
        }

        .settings-group select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .settings-group small {
            display: block;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .settings-group small a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
        }

        .settings-group small a:hover { text-decoration: underline; }

        .api-mode-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .api-mode-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .api-mode-option:hover {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }

        .api-mode-option.selected {
            border-color: var(--accent-color);
            background: var(--accent-light);
            box-shadow: var(--shadow-glow);
        }

        .api-mode-option i {
            font-size: 18px;
            color: var(--accent-color);
            width: 24px;
            text-align: center;
        }

        .api-mode-option span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #save-settings-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 28px;
            box-shadow: var(--shadow-card);
        }

        #save-settings-btn:hover { 
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        /* Theme Modal */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .theme-option.selected {
            border-color: var(--accent-color);
            background: var(--accent-light);
            box-shadow: var(--shadow-glow);
        }

        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-soft);
        }

        .theme-option[data-theme="frost"] .theme-preview {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .theme-option[data-theme="soft-green"] .theme-preview {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }

        .theme-option[data-theme="corporate"] .theme-preview {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
        }

        .theme-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-desc {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        /* Crop Modal */
        #crop-image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .crop-modal-content-wrapper {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            max-width: 95vw;
            max-height: 95vh;
            overflow: auto;
            text-align: center;
        }

        .crop-modal-content-wrapper h3 {
            margin-top: 0;
            color: var(--text-primary);
            font-weight: 700;
        }

        #crop-image-container {
            position: relative;
            display: inline-block;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            user-select: none;
            touch-action: none;
            max-width: 100%;
            max-height: calc(85vh - 120px);
            overflow: hidden;
            cursor: crosshair;
        }

        .crop-modal-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .crop-modal-buttons button {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
        }

        #crop-image-button-confirm {
            background: var(--success-gradient);
        }

        #crop-image-button-cancel {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        }

        @media (max-width: 600px) {
            body::before { display: none; }
            .app-header { padding: 12px 16px; }
            .header-title span { display: none; }
            #container { padding: 15px; }
            #buttonContainer { gap: 8px; }
            button { padding: 10px 14px; font-size: 13px; }
            .modal-body { padding: 20px; }
            .theme-options { grid-template-columns: 1fr; }
            .header-btn span { display: none; }
            .header-btn { padding: 0; width: 40px; }
        }
    </style>
</head>
<body data-theme="corporate">
    <header class="app-header">
        <div class="header-title">
            <i class="fa-solid fa-spell-check"></i>
            <span>Проверка текста</span>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="theme-btn" title="Выбор темы">
                <i class="fa-solid fa-palette"></i>
                <span id="current-theme-name">Corporate</span>
            </button>
            <button class="header-btn" id="settings-btn" title="Настройки ИИ">
                <i class="fa-solid fa-sliders"></i>
                <span id="current-model-name">Gemini 2.5 Flash Lite Preview</span>
            </button>
        </div>
    </header>

    <div id="container">
        <textarea id="textInput" placeholder="Текст или изображение..."></textarea>
        <div id="buttonContainer">
            <button id="checkButton" onclick="analyzeText()"><i class="fas fa-check-double"></i> Проверить</button>
            <button id="checkWithAIButton" onclick="checkGrammarWithAI()"><i class="fas fa-wand-magic-sparkles"></i> Проверить с ИИ</button>
            <button id="copyButton" onclick="copyText()"><i class="fas fa-clipboard"></i> Копировать</button>
        </div>
        <div id="resultsContainer">
            <div id="cadastralResult"></div>
            <div id="linksResult"></div>
            <div id="foreignLettersResult"></div>
            <div id="datesResult"></div>
            <div id="fileNamesResult"></div>
        </div>
    </div>

    <div id="statusBar">
        <i class="fas fa-info-circle"></i>
        <span id="charCount">Символов: 0</span>
        <span id="wordCount">Слов: 0</span>
        <span id="lineCount">Строк: 0</span>
        <span id="removedSpaces">Удалено пробелов: 0</span>
        <span id="removedLines">Удалено строк: 0</span>
        <span id="addedSpaces">Добавлено пробелов: 0</span>
        <span id="addedPeriods">Добавлено точек: 0</span>
        <span id="currentLine">Строка: -</span>
    </div>

    <!-- Theme Modal -->
    <div id="theme-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-palette"></i> Выбор темы</h2>
                <button class="modal-close" id="close-theme-modal"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="theme-options" id="theme-options">
                    <div class="theme-option" data-theme="frost">
                        <div class="theme-preview"><i class="fa-solid fa-snowflake"></i></div>
                        <div class="theme-name"></div>
                    
                    </div>
                    <div class="theme-option" data-theme="soft-green">
                        <div class="theme-preview"><i class="fa-solid fa-leaf"></i></div>
                        <div class="theme-name"></div>
                
                    </div>
                    <div class="theme-option selected" data-theme="corporate">
                        <div class="theme-preview"><i class="fa-solid fa-building"></i></div>
                        <div class="theme-name"></div>
                       
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-sliders"></i> Настройки ИИ</h2>
                <button class="modal-close" id="close-settings-modal"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label>Модель ИИ</label>
                    <select id="model-selector"></select>
                </div>
                <div class="settings-group">
                    <label>Режим подключения</label>
                    <div class="api-mode-options" id="api-mode-options"></div>
                </div>
                <div class="settings-group" id="api-key-group" style="display:none;">
                    <label>API ключ</label>
                    <input type="password" id="api-key-input" placeholder="Введите ключ...">
                    <small>Получить: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> | <a href="https://console.mistral.ai/api-keys/" target="_blank">Mistral</a></small>
                </div>
                <button id="save-settings-btn">Сохранить настройки</button>
            </div>
        </div>
    </div>

    <!-- AI Check Modal -->
    <div id="aiCheckModal" class="modal-overlay">
        <div class="modal-content ai-modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Результат проверки ИИ</h2>
                <button class="modal-close" onclick="closeAiModal()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; flex: 1;">
                <div id="aiCheckLoading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Пожалуйста, подождите...</p>
                </div>
                <div id="aiResultDisplay" class="ai-result-display-area"></div>
                <div id="aiCorrectionsListWrapper" style="margin-top: 15px; min-height: 20vh; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 10px; display: none;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">Список исправлений:</h4>
                    <ul id="aiCorrectionsList" style="list-style: none; padding: 0;"></ul>
                </div>
                <button class="modal-action-button" onclick="copyAiCorrectedTextToClipboard(this)" title="Копировать исправленный текст">
                    <i class="fas fa-clipboard"></i> Копировать исправленный текст
                </button>
            </div>
        </div>
    </div>

    <!-- Crop Image Modal -->
    <div id="crop-image-modal">
        <div class="crop-modal-content-wrapper">
            <h3><i class="fas fa-crop-alt"></i> Обрезать изображение</h3>
            <p style="font-size:0.9em; color: var(--text-secondary);">Нажмите и перетащите на изображении, чтобы выбрать область.</p>
            <div id="crop-image-container">
                <img id="crop-image-preview" src="#" alt="Preview" style="display:block; max-width:100%; max-height:100%; user-select:none; -webkit-user-drag:none;" />
                <div id="crop-selection-rectangle" style="position:absolute; border:2px solid rgba(79, 172, 254, 0.8); background-color:rgba(79, 172, 254, 0.15); display:none; pointer-events:none; border-radius: 4px;"></div>
            </div>
            <div class="crop-modal-buttons">
                <button id="crop-image-button-confirm">
                    <i class="fas fa-check"></i> Применить
                </button>
                <button id="crop-image-button-cancel">
                    <i class="fas fa-expand"></i> Использовать всё
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
        const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
        const OCR_PROMPT_FOR_AI = "Extract all text from the following image. Return ONLY the extracted text, without any preambles, comments, explanations, or any surrounding text. If no text is found, return an empty string.";

        const MODELS = [
            { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
            { id: "gemini-2.5-flash-lite-preview-09-25", uiName: "Gemini 2.5 Flash Lite Preview", apiType: "gemini", tier: 'lite' },
            { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini", tier: 'standard' },
            { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini", tier: 'standard' },
            { id: "gemini-3-pro-preview", uiName: "Gemini 3 Pro Preview", apiType: "gemini", tier: 'standard' },
            { id: "nvidia/nemotron-3-nano-30b-a3b:free", uiName: "NVIDIA Nemotron 3 Nano 30B", apiType: "openrouter", tier: 'standard' },
            { id: "gpt-oss-20b-free", uiName: "OpenAI GPT-OSS 20B", apiType: "openrouter", tier: 'standard' },
            { id: "mistral-large-2512", uiName: "Mistral Large", apiType: "mistral", tier: 'standard' },
            { id: "mistral-medium-2508", uiName: "Mistral Medium", apiType: "mistral", tier: 'standard' },
        ];

        const API_MODES = {
            'mapruapp': { uiName: 'Прокси (MapRuApp)', icon: 'fa-solid fa-server' },
            'vercel': { uiName: 'Прокси (Vercel)', icon: 'fa-solid fa-cloud' },
            'direct': { uiName: 'Прямой (Gemini)', icon: 'fa-solid fa-key' },
            'direct_mistral': { uiName: 'Прямой (Mistral)', icon: 'fa-solid fa-bolt' }
        };

        const THEMES = {
            'frost': { uiName: '', icon: 'fa-snowflake' },
            'soft-green': { uiName: '', icon: 'fa-leaf' },
            'corporate': { uiName: '', icon: 'fa-building' }
        };

        const DEFAULT_MODEL = "gemini-3-flash-preview";

        // --- State ---
        let currentModelId = DEFAULT_MODEL;
        let currentApiMode = 'mapruapp';
        let currentApiType = 'gemini';
        let apiKey = '';
        let currentTheme = 'corporate';

        // --- DOM Elements ---
        const $ = id => document.getElementById(id);
        const settingsBtn = $('settings-btn');
        const settingsModal = $('settings-modal');
        const modelSelector = $('model-selector');
        const apiModeOptionsEl = $('api-mode-options');
        const apiKeyGroup = $('api-key-group');
        const apiKeyInput = $('api-key-input');
        const currentModelNameSpan = $('current-model-name');
        const themeBtn = $('theme-btn');
        const themeModal = $('theme-modal');
        const themeOptionsEl = $('theme-options');
        const currentThemeNameSpan = $('current-theme-name');

        // --- Theme Functions ---
        function loadTheme() {
            currentTheme = localStorage.getItem('textcheck_theme') || 'corporate';
            applyTheme(currentTheme);
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            currentTheme = theme;
            updateThemeDisplay();
            updateThemeOptionsUI();
        }

        function updateThemeDisplay() {
            const theme = THEMES[currentTheme];
            if (theme) {
                currentThemeNameSpan.textContent = theme.uiName;
            }
        }

        function updateThemeOptionsUI() {
            themeOptionsEl.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.theme === currentTheme);
            });
        }

        function initTheme() {
            loadTheme();

            themeBtn.onclick = () => { 
                themeModal.style.display = 'flex'; 
            };
            $('close-theme-modal').onclick = () => { themeModal.style.display = 'none'; };
            themeModal.onclick = e => { if (e.target === themeModal) themeModal.style.display = 'none'; };

            themeOptionsEl.querySelectorAll('.theme-option').forEach(opt => {
                opt.onclick = () => {
                    const theme = opt.dataset.theme;
                    applyTheme(theme);
                    localStorage.setItem('textcheck_theme', theme);
                    themeModal.style.display = 'none';
                };
            });
        }

        // --- Settings Functions ---
        function loadSettings() {
            currentModelId = localStorage.getItem('textcheck_modelId') || DEFAULT_MODEL;
            currentApiMode = localStorage.getItem('textcheck_apiMode') || 'mapruapp';
            apiKey = localStorage.getItem('textcheck_apiKey') || '';
            
            const model = MODELS.find(m => m.id === currentModelId);
            if (model) {
                currentApiType = model.apiType;
            } else {
                currentModelId = DEFAULT_MODEL;
                currentApiType = 'gemini';
            }
            apiKeyInput.value = apiKey;
            updateCurrentModelDisplay();
        }

        function saveSettings() {
            currentModelId = modelSelector.value;
            const model = MODELS.find(m => m.id === currentModelId);
            if (model) currentApiType = model.apiType;
            
            apiKey = apiKeyInput.value.trim();

            const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                             (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
            if (needsKey && !apiKey) {
                alert('Введите API ключ для прямого режима');
                return;
            }

            localStorage.setItem('textcheck_modelId', currentModelId);
            localStorage.setItem('textcheck_apiMode', currentApiMode);
            localStorage.setItem('textcheck_apiKey', apiKey);

            updateCurrentModelDisplay();
            settingsModal.style.display = 'none';
        }

        function updateCurrentModelDisplay() {
            const model = MODELS.find(m => m.id === currentModelId);
            if (model) {
                currentModelNameSpan.textContent = model.uiName;
            }
        }

        function renderModels() {
            modelSelector.innerHTML = MODELS.map(m => 
                `<option value="${m.id}" data-api="${m.apiType}">${m.uiName}</option>`
            ).join('');
            modelSelector.value = currentModelId;
        }

        function renderApiModes() {
            apiModeOptionsEl.innerHTML = Object.entries(API_MODES).map(([key, mode]) => `
                <div class="api-mode-option ${key === currentApiMode ? 'selected' : ''}" data-mode="${key}">
                    <i class="${mode.icon}"></i>
                    <span>${mode.uiName}</span>
                </div>
            `).join('');

            apiModeOptionsEl.querySelectorAll('.api-mode-option').forEach(el => {
                el.onclick = () => {
                    currentApiMode = el.dataset.mode;
                    apiModeOptionsEl.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
                    el.classList.add('selected');
                    updateApiKeyVisibility();
                };
            });
            updateApiModeVisibility();
        }

        function updateApiModeVisibility() {
            const options = apiModeOptionsEl.querySelectorAll('.api-mode-option');
            options.forEach(opt => {
                const mode = opt.dataset.mode;
                if (currentApiType === 'gemini') {
                    opt.style.display = (mode === 'direct_mistral') ? 'none' : 'flex';
                } else if (currentApiType === 'mistral') {
                    opt.style.display = (mode === 'direct' || mode === 'vercel') ? 'none' : 'flex';
                } else if (currentApiType === 'openrouter') {
                    opt.style.display = (mode === 'mapruapp') ? 'flex' : 'none';
                } else {
                    opt.style.display = 'flex';
                }
            });
            
            const currentModeEl = apiModeOptionsEl.querySelector(`[data-mode="${currentApiMode}"]`);
            if (currentModeEl && currentModeEl.style.display === 'none') {
                currentApiMode = 'mapruapp';
                apiModeOptionsEl.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
                apiModeOptionsEl.querySelector('[data-mode="mapruapp"]').classList.add('selected');
            }
            updateApiKeyVisibility();
        }

        function updateApiKeyVisibility() {
            const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                             (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
            apiKeyGroup.style.display = needsKey ? 'block' : 'none';
        }

        // --- Initialize Settings ---
        function initSettings() {
            loadSettings();
            renderModels();
            renderApiModes();

            settingsBtn.onclick = () => { 
                modelSelector.value = currentModelId;
                renderApiModes();
                settingsModal.style.display = 'flex'; 
            };
            $('close-settings-modal').onclick = () => { settingsModal.style.display = 'none'; };
            settingsModal.onclick = e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; };
            $('save-settings-btn').onclick = saveSettings;

            modelSelector.onchange = () => {
                const model = MODELS.find(m => m.id === modelSelector.value);
                if (model) {
                    currentModelId = model.id;
                    currentApiType = model.apiType;
                    updateApiModeVisibility();
                }
            };
        }

        // --- Get API URL and Body based on settings ---
        function getAIRequestConfig(prompt, isOCR = false) {
            let requestUrl;
            let requestBody;

            if (currentApiMode === 'mapruapp') {
                requestUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                requestBody = {
                    model: currentModelId,
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 8192
                };
                if (!isOCR) {
                    requestBody.response_format = { type: "json_object" };
                }
            } else if (currentApiMode === 'direct_mistral') {
                requestUrl = 'https://api.mistral.ai/v1/chat/completions';
                requestBody = {
                    model: currentModelId,
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 8192
                };
                if (!isOCR) {
                    requestBody.response_format = { type: "json_object" };
                }
            } else if (currentApiMode === 'direct') {
                requestUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`;
                requestBody = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                if (!isOCR) {
                    requestBody.generationConfig = { responseMimeType: "application/json" };
                }
            } else {
                // vercel proxy
                requestUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                requestBody = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                if (!isOCR) {
                    requestBody.generationConfig = { responseMimeType: "application/json" };
                }
            }

            return { requestUrl, requestBody };
        }

        function getAIRequestConfigWithImage(prompt, base64ImageData) {
            let requestUrl;
            let requestBody;

            if (currentApiMode === 'mapruapp') {
                requestUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                requestBody = {
                    model: currentModelId,
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: prompt },
                            { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64ImageData}` } }
                        ]
                    }],
                    max_tokens: 8192
                };
            } else if (currentApiMode === 'direct_mistral') {
                requestUrl = 'https://api.mistral.ai/v1/chat/completions';
                requestBody = {
                    model: currentModelId,
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: prompt },
                            { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64ImageData}` } }
                        ]
                    }],
                    max_tokens: 8192
                };
            } else if (currentApiMode === 'direct') {
                requestUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`;
                requestBody = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                        ]
                    }]
                };
            } else {
                requestUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                requestBody = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                        ]
                    }]
                };
            }

            return { requestUrl, requestBody };
        }

        function getHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (currentApiMode === 'direct_mistral') {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
            return headers;
        }

        function parseAIResponse(data) {
            if (currentApiMode === 'mapruapp' || currentApiMode === 'direct_mistral') {
                return data.choices?.[0]?.message?.content;
            }
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        // --- Crop Modal ---
        function showCropModal(imageFile) {
            return new Promise((resolve) => {
                const modal = document.getElementById('crop-image-modal');
                const imgPreview = document.getElementById('crop-image-preview');
                const cropContainer = document.getElementById('crop-image-container');
                const selectionRectDiv = document.getElementById('crop-selection-rectangle');
                const confirmButton = document.getElementById('crop-image-button-confirm');
                const cancelButton = document.getElementById('crop-image-button-cancel');
                let cropSelection = { startX: 0, startY: 0, endX: 0, endY: 0, isDrawing: false };
                let imageNaturalSize = { width: 0, height: 0 };
                let imageDisplaySize = { width: 0, height: 0 };
                selectionRectDiv.style.display = 'none';
                cropSelection.isDrawing = false;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgPreview.src = e.target.result;
                    modal.style.display = 'flex';
                    imgPreview.onload = () => {
                        imageNaturalSize.width = imgPreview.naturalWidth;
                        imageNaturalSize.height = imgPreview.naturalHeight;
                        imageDisplaySize.width = imgPreview.offsetWidth;
                        imageDisplaySize.height = imgPreview.offsetHeight;
                    };
                };
                reader.readAsDataURL(imageFile);
                function updateSelectionRect() {
                    const x = Math.min(cropSelection.startX, cropSelection.endX);
                    const y = Math.min(cropSelection.startY, cropSelection.endY);
                    const width = Math.abs(cropSelection.endX - cropSelection.startX);
                    const height = Math.abs(cropSelection.endY - cropSelection.startY);
                    selectionRectDiv.style.left = `${x}px`;
                    selectionRectDiv.style.top = `${y}px`;
                    selectionRectDiv.style.width = `${width}px`;
                    selectionRectDiv.style.height = `${height}px`;
                }
                function getMousePos(event) {
                    const rect = cropContainer.getBoundingClientRect();
                    let x = event.clientX - rect.left;
                    let y = event.clientY - rect.top;
                    x = Math.max(0, Math.min(x, imageDisplaySize.width));
                    y = Math.max(0, Math.min(y, imageDisplaySize.height));
                    return { x, y };
                }
                const onMouseDown = (e) => {
                    e.preventDefault();
                    cropSelection.isDrawing = true;
                    const pos = getMousePos(e.touches ? e.touches[0] : e);
                    cropSelection.startX = pos.x;
                    cropSelection.startY = pos.y;
                    cropSelection.endX = pos.x;
                    cropSelection.endY = pos.y;
                    selectionRectDiv.style.display = 'block';
                    updateSelectionRect();
                    cropContainer.addEventListener('mousemove', onMouseMove);
                    cropContainer.addEventListener('touchmove', onMouseMove, { passive: false });
                    window.addEventListener('mouseup', onMouseUp);
                    window.addEventListener('touchend', onMouseUp);
                };
                const onMouseMove = (e) => {
                    if (!cropSelection.isDrawing) return;
                    e.preventDefault();
                    const pos = getMousePos(e.touches ? e.touches[0] : e);
                    cropSelection.endX = pos.x;
                    cropSelection.endY = pos.y;
                    updateSelectionRect();
                };
                const onMouseUp = () => {
                    if (!cropSelection.isDrawing) return;
                    cropSelection.isDrawing = false;
                    cropContainer.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', onMouseUp);
                    cropContainer.removeEventListener('touchmove', onMouseMove);
                    window.removeEventListener('touchend', onMouseUp);
                };
                cropContainer.addEventListener('mousedown', onMouseDown);
                cropContainer.addEventListener('touchstart', onMouseDown, { passive: false });
                const handleConfirm = () => {
                    const selWidth = Math.abs(cropSelection.endX - cropSelection.startX);
                    const selHeight = Math.abs(cropSelection.endY - cropSelection.startY);
                    if (selWidth < 10 || selHeight < 10 || selectionRectDiv.style.display === 'none') {
                        handleCancel();
                        return;
                    }
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scaleX = imageNaturalSize.width / imageDisplaySize.width;
                    const scaleY = imageNaturalSize.height / imageDisplaySize.height;
                    const sX = Math.min(cropSelection.startX, cropSelection.endX) * scaleX;
                    const sY = Math.min(cropSelection.startY, cropSelection.endY) * scaleY;
                    const sWidth = selWidth * scaleX;
                    const sHeight = selHeight * scaleY;
                    canvas.width = sWidth;
                    canvas.height = sHeight;
                    ctx.drawImage(imgPreview, sX, sY, sWidth, sHeight, 0, 0, sWidth, sHeight);
                    const croppedImageDataUrl = canvas.toDataURL(imageFile.type || 'image/jpeg');
                    resolve(croppedImageDataUrl);
                    cleanupModal();
                };
                const handleCancel = () => {
                    fileToBase64(imageFile).then(base64 => resolve(base64));
                    cleanupModal();
                };
                const cleanupModal = () => {
                    modal.style.display = 'none';
                    imgPreview.src = '#';
                    imgPreview.onload = null;
                    cropContainer.removeEventListener('mousedown', onMouseDown);
                    cropContainer.removeEventListener('touchstart', onMouseDown);
                    confirmButton.onclick = null;
                    cancelButton.onclick = null;
                };
                confirmButton.onclick = handleConfirm;
                cancelButton.onclick = handleCancel;
            });
        }
      
        document.getElementById('textInput').addEventListener('paste', async function(e) {
            const items = (e.clipboardData || window.clipboardData).items;
            let imageFile = null;
            if (items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
                        imageFile = items[i].getAsFile();
                        break;
                    }
                }
            }
            if (imageFile) {
                e.preventDefault();
                const textInput = document.getElementById('textInput');
                const originalPlaceholder = textInput.placeholder;
                textInput.placeholder = "Обработка изображения...";
                textInput.disabled = true;
                try {
                    const tempImg = new Image();
                    const objectURL = URL.createObjectURL(imageFile);
                    let imageDataUrlForAI;
                    await new Promise((resolve, reject) => {
                        tempImg.onload = resolve;
                        tempImg.onerror = reject;
                        tempImg.src = objectURL;
                    });
                    URL.revokeObjectURL(objectURL);

                    if (tempImg.naturalWidth > 600 || tempImg.naturalHeight > 600) {
                        imageDataUrlForAI = await showCropModal(imageFile);
                    } else {
                        imageDataUrlForAI = await fileToBase64(imageFile);
                    }
                    if (!imageDataUrlForAI) throw new Error("Не удалось получить данные изображения после обработки.");
                    
                    textInput.placeholder = "Распознавание текста из изображения...";
                    let recognizedText = await performOcrWithAI(imageDataUrlForAI);
                    
                    const commonPreambles = [ /^\s*Here is the text extracted from the image:\s*/i, /^\s*The text in the image is:\s*/i, /^\s*Extracted text:\s*/i, /^\s*Recognized text:\s*/i, /^\s*Text from image:\s*/i, /^\s*Вот текст, извлеченный из изображения:\s*/i ];
                    for (const preambleRegex of commonPreambles) { if (preambleRegex.test(recognizedText)) { recognizedText = recognizedText.replace(preambleRegex, ""); break; } }
                    
                    textInput.value = recognizedText.trim();
                    analyzeText();
                } catch (error) {
                    console.error("Image Paste/OCR Error:", error);
                    alert("Не удалось распознать текст из изображения: " + error.message);
                    textInput.value = "";
                    analyzeText();
                } finally {
                    textInput.placeholder = originalPlaceholder;
                    textInput.disabled = false;
                }
            } else {
                setTimeout(function() { analyzeText(); }, 0);
            }
        });

        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result);  reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }

        async function performOcrWithAI(base64DataUrl) {
            const base64ImageData = base64DataUrl.split(',')[1];
            const { requestUrl, requestBody } = getAIRequestConfigWithImage(OCR_PROMPT_FOR_AI, base64ImageData);

            try {
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorDetail = data?.error?.message || `Статус ${response.status}`;
                    throw new Error(`Ошибка OCR API: ${errorDetail}`);
                }

                let recognizedText = parseAIResponse(data);
                
                if (typeof recognizedText === 'string') {
                    return recognizedText;
                } else if (data.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error("Ответ заблокирован моделью по соображениям безопасности.");
                } else {
                    console.warn("AI OCR response structure not as expected:", data);
                    throw new Error('ИИ не вернул текстовый ответ для изображения.');
                }
            } catch (error) {
                console.error("Ошибка при вызове OCR API:", error);
                throw error;
            }
        }

        function extractDates(text) {
            const regex = /(\b\d{2}\.\d{2}\.\d{4}\b)|(\b\d{2}\.\d{2}\.\d{2}\b)|(\b\d{4}-\d{2}-\d{2}\b)/g;
            const matches = text.match(regex) || []; const resultDiv = document.getElementById('datesResult');
            if (matches.length > 0) {
                const uniqueMatches = [...new Set(matches)]; const currentDate = new Date(); const minDate = new Date('1990-01-01');
                resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-calendar-alt result-icon" title="Даты"></i><i class="fas fa-save save-icon" onclick="downloadDates()" title="Сохранить даты"></i></div><ul>' +
                    uniqueMatches.map(dateStr => {
                        let dateObj, isValidDateStruct = true;
                        try {
                            if (dateStr.includes('-')) { const [year, month, day] = dateStr.split('-').map(Number); dateObj = new Date(Date.UTC(year, month - 1, day)); if (dateObj.getUTCFullYear() !== year || dateObj.getUTCMonth() !== month - 1 || dateObj.getUTCDate() !== day) isValidDateStruct = false;
                            } else { const parts = dateStr.split('.').map(Number); let year = parts[2]; if (String(parts[2]).length === 2) year += (year < 70 ? 2000 : 1900); dateObj = new Date(Date.UTC(year, parts[1] - 1, parts[0])); if (dateObj.getUTCFullYear() !== year || dateObj.getUTCMonth() !== parts[1] - 1 || dateObj.getUTCDate() !== parts[0]) isValidDateStruct = false; }
                        } catch (e) { isValidDateStruct = false; }
                        const isOutOfRange = !isValidDateStruct || dateObj < minDate || dateObj > currentDate; const className = isOutOfRange ? 'class="invalid-date"' : '';
                        return `<li ${className} onclick="copyToClipboard('${dateStr}', this)">${dateStr}</li>`;
                    }).join('') + '</ul>';
            } else { resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-calendar-alt result-icon" title="Даты"></i></div><p>Даты не найдены.</p>'; }
        }
        function extractFileNames(text) {
            const regex = /"([^"]+\.[a-zA-Z0-9]{3,5})"/g; const matches = text.matchAll(regex); const fileNames = new Set();
            for (const match of matches) { const fullPath = match[1]; const fileName = fullPath.split(/[\\/]/).pop(); fileNames.add(fileName); }
            const resultDiv = document.getElementById('fileNamesResult');
            if (fileNames.size > 0) { const uniqueFileNames = Array.from(fileNames); resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-file result-icon" title="Имена файлов"></i><i class="fas fa-save save-icon" onclick="downloadFileNames()" title="Сохранить имена файлов"></i></div><ul>' + uniqueFileNames.map(fileName => `<li onclick="copyToClipboard('${fileName}', this)">${fileName}</li>`).join('') + '</ul>';
            } else { resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-file result-icon" title="Имена файлов"></i></div><p>Имена файлов не найдены.</p>'; }
        }
        function addMissingPeriods(text) {
            let lines = text.split('\n'); let addedPeriods = 0;
            for (let i = 0; i < lines.length; i++) {
                let currentLine = lines[i].trim(); if (currentLine === '') continue; let nextNonEmptyLine = '';
                if (i < lines.length - 1) { let j = i + 1; while (j < lines.length) { if (lines[j].trim() !== '') { nextNonEmptyLine = lines[j].trim(); break; } j++; } }
                let lastChar = currentLine[currentLine.length - 1];
                if ( (nextNonEmptyLine && /[А-ЯЁA-Z]/.test(nextNonEmptyLine[0])) || !nextNonEmptyLine ) { if (/[а-яА-ЯёЁa-zA-Z0-9)\]}"]/.test(lastChar) && !/[.!?:;,]$/.test(currentLine)) { lines[i] = currentLine + '.'; addedPeriods++; } }
            } return { text: lines.join('\n'), addedPeriods: addedPeriods };
        }
        function downloadFileNames() { const fileNames = Array.from(document.querySelectorAll('#fileNamesResult li')).map(li => li.textContent); downloadFile('file_names.txt', fileNames.join('\n')); }
        function handleCadastralIconClickEgrn(number, iconElement) { navigator.clipboard.writeText(number).then(() => { const liElement = iconElement.closest('li'); if (liElement) { liElement.classList.add('flash'); setTimeout(() => { liElement.classList.remove('flash'); }, 500); } window.open(`egrn.html#${encodeURIComponent(number)}`, '_blank'); }).catch(err => { console.error('Не удалось скопировать кадастровый номер (EGRN): ', err); alert('Не удалось скопировать кадастровый номер (EGRN).'); }); }
        function handleCadastralIconClickMapHtml(number, iconElement) { navigator.clipboard.writeText(number).then(() => { const liElement = iconElement.closest('li'); if (liElement) { liElement.classList.add('flash'); setTimeout(() => { liElement.classList.remove('flash'); }, 500); } window.open(`map.html#${encodeURIComponent(number)}`, '_blank'); }).catch(err => { console.error('Не удалось скопировать кадастровый номер (Map.html): ', err); alert('Не удалось скопировать кадастровый номер (Map.html).'); }); }
        function extractCadastralNumbers(text) {
            const regex = /\b\d+:\d+:\d{6,7}:\d+(?::\d+)?(?:[:ЗУ]\d*)?\b|\b\d{2}:\d{2}:\d{6,7}:\d+\b/g;
            const matches = text.match(regex) || []; const mpVersionRegex = /MP Version=/; const hasMpVersion = mpVersionRegex.test(text);
            const innerCadastralRegex = /<InnerCadastralNumbers>\s*<CadastralNumber>(\d+:\d+:\d{6,7}:\d+(?::\d+)?(?:[:ЗУ]\d*)?)<\/CadastralNumber>\s*<\/InnerCadastralNumbers>|<InnerCadastralNumbers>\s*<CadastralNumber>(\d{2}:\d{2}:\d{6,7}:\d+)\b<\/CadastralNumber>\s*<\/InnerCadastralNumbers>/g;
            let innerCadastralMatches = []; let match; while ((match = innerCadastralRegex.exec(text)) !== null) { innerCadastralMatches.push(match[1] || match[2]); }
            innerCadastralMatches = [...new Set(innerCadastralMatches)]; const resultDiv = document.getElementById('cadastralResult');
            let resultHTML = '<div class="result-header"><i class="fas fa-map-marker-alt result-icon" title="Кадастровые номера"></i><i class="fas fa-save save-icon" onclick="downloadNumbers()" title="Сохранить кадастровые номера"></i></div><ul>';
            let foundCadastral = false; const iconEgrnTemplate = (number) => `<img src="img/savannah.png" alt="" title="ЕГРН" onclick="handleCadastralIconClickEgrn('${number}', this)">`;
            const iconMapHtmlTemplate = (number) => `<img src="img/map.png" alt="" title="Карта" onclick="handleCadastralIconClickMapHtml('${number}', this)">`;
            if (matches.length > 0) { foundCadastral = true; const uniqueMatches = [...new Set(matches)]; uniqueMatches.forEach(number => { let isInner = innerCadastralMatches.includes(number); let liClass = isInner ? 'class="inner-cadastral"' : ''; let numberSpan = `<span class="cadastral-number-text" onclick="copyToClipboard('${number}', this.closest('li'))">${number}</span>`; let iconsSpan = `<span class="cadastral-icons">${iconEgrnTemplate(number)}${iconMapHtmlTemplate(number)}</span>`; resultHTML += `<li ${liClass}>${numberSpan}${iconsSpan}</li>`; }); }
            if (hasMpVersion) { if (innerCadastralMatches.length > 0) { foundCadastral = true; innerCadastralMatches.forEach(innerNumber => { if (!matches.includes(innerNumber)) { let textSpan = `<span class="cadastral-number-text">ОКС не найден в тексте: <span onclick="copyToClipboard('${innerNumber}', this.closest('li'))">${innerNumber}</span></span>`; let iconsSpan = `<span class="cadastral-icons">${iconEgrnTemplate(innerNumber)}${iconMapHtmlTemplate(innerNumber)}</span>`; resultHTML += `<li class="not-found">${textSpan}${iconsSpan}</li>`; } }); } else if (!foundCadastral) { resultHTML += `<li class="not-found">ОКС не найден (внутренние номера отсутствуют)</li>`; } }
            resultHTML += '</ul>'; if (!foundCadastral && (!hasMpVersion || (hasMpVersion && innerCadastralMatches.length === 0)) ) { resultHTML = '<div class="result-header"><i class="fas fa-map-marker-alt result-icon" title="Кадастровые номера"></i></div><p>Кадастровые номера не найдены.</p>'; }
            resultDiv.innerHTML = resultHTML;
        }
        function extractLinks(text) {
            const regex = /https?:\/\/[^\s«»"'()<>]+/g; const matches = text.match(regex); const resultDiv = document.getElementById('linksResult');
            if (matches) { const uniqueMatches = [...new Set(matches)]; resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-link result-icon" title="HTTP-ссылки"></i><i class="fas fa-save save-icon" onclick="downloadLinks()" title="Сохранить HTTP-ссылки"></i></div><ul>' + uniqueMatches.map(link => `<li onclick="copyToClipboard('${link}', this)"><a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a></li>`).join('') + '</ul>';
            } else { resultDiv.innerHTML = '<div class="result-header"><i class="fas fa-link result-icon" title="HTTP-ссылки"></i></div><p>HTTP-ссылки не найдены.</p>'; }
        }
        const punctuationMarksForClean = [',', '.', ';', ':'];
        function removeExtraSpaces(text) {
            let lines = text.split('\n'); let originalLength = text.length; let addedSpacesCount = 0;
            for (let i = 0; i < lines.length - 1; i++) {
                const currentLine = lines[i].trimEnd(); const nextLine = lines[i + 1].trimStart();
                if (currentLine && nextLine) { const lastCharCurrent = currentLine[currentLine.length - 1]; const firstCharNext = nextLine[0]; if (/[а-яёa-z0-9)\]}"]/i.test(lastCharCurrent) && /[а-яёa-z0-9(\[{"]/i.test(firstCharNext)) { if(!/[\s.,;:!?]$/.test(currentLine) && !/^[\s.,;:!?]/.test(nextLine)) { lines[i] = currentLine + ' ' + nextLine; lines.splice(i + 1, 1); i--; addedSpacesCount++; } } }
            } text = lines.join('\n'); lines = text.split('\n').map(line => line.trim()); let cleanedLines = []; let emptyLineCount = 0;
            for (let i = 0; i < lines.length; i++) { if (lines[i] !== '') { if (emptyLineCount > 0 && cleanedLines.length > 0) { cleanedLines.push(''); } cleanedLines.push(lines[i]); emptyLineCount = 0; } else { emptyLineCount++; } }
            if (cleanedLines.length > 0 && cleanedLines[cleanedLines.length -1] === '') { cleanedLines.pop(); }
            let cleanedText = cleanedLines.join('\n'); punctuationMarksForClean.forEach(mark => { const regex = new RegExp(`\\s+\\${mark}`, 'g'); cleanedText = cleanedText.replace(regex, mark); });
            cleanedText = cleanedText.replace(/ +/g, ' '); cleanedText = cleanedText.replace(/([,:])([а-яА-ЯёЁa-zA-Z0-9(\[{"])/g, (match, p1, p2, offset, string) => { if (p1 === ':' && (/\d:\d/.test(string.slice(Math.max(0, offset - 1), offset + 2)) || /\d:ЗУ/.test(string.slice(Math.max(0, offset - 1), offset + 3)))) return match; if (p1 === ':' && /https?:/.test(string.slice(Math.max(0, offset - 5), offset + 1))) return match; addedSpacesCount++; return p1 + ' ' + p2; });
            cleanedText = cleanedText.replace(/([.!?])([А-ЯA-ZА-ЯЁ(\[{"])/g, (match, p1, p2) => { addedSpacesCount++; return p1 + ' ' + p2; });
            cleanedText = cleanedText.replace(/№(\S)/g, (match, p1) => { addedSpacesCount++; return '№ ' + p1; });
            const digitLetterRegex = /(\d)([а-яА-ЯёЁa-zA-Z])/g; const letterDigitRegex = /([а-яА-ЯёЁa-zA-Z])(\d)/g;
            cleanedText = cleanedText.replace(digitLetterRegex, (match, p1, p2, offset, string) => { const prevChar = string[offset - 1]; if (p1.length === 1 && p2.length === 1 && prevChar === '.' && string[offset-2] === 'д') return match; if (prevChar === ' ' && string[offset-2] && string[offset-2].toUpperCase() === 'Р' && p2.length > 1) return match; if (prevChar === ' ' && string.substring(Math.max(0, offset - 4), offset) === "ГОСТ") return match; addedSpacesCount++; return p1 + ' ' + p2; });
            cleanedText = cleanedText.replace(letterDigitRegex, (match, p1, p2, offset, string) => { if ( (p1.toUpperCase() === 'У' && string.substring(Math.max(0, offset - 1), offset).toUpperCase() === 'З') || (p1.toUpperCase() === 'У' && string.substring(Math.max(0, offset - 1), offset).toUpperCase() === 'Т') ) { return match; } if (string.substring(Math.max(0, offset - 3), offset + p2.length) === `ГОСТ${p2}`) return match; addedSpacesCount++; return p1 + ' ' + p2; });
            let removedSpaces = originalLength - cleanedText.length + addedSpacesCount; let removedLines = text.split('\n').length - cleanedText.split('\n').length;
            return { cleanedText, removedSpaces, removedLines, addedSpaces: addedSpacesCount };
        }
        function analyzeText(event) {
            const textInput = document.getElementById('textInput'); let text = textInput.value;
            if (text.trim() === '') { document.getElementById('cadastralResult').innerHTML = ''; document.getElementById('linksResult').innerHTML = ''; document.getElementById('foreignLettersResult').style.display = 'none'; document.getElementById('foreignLettersResult').innerHTML = ''; document.getElementById('fileNamesResult').innerHTML = ''; document.getElementById('datesResult').innerHTML = ''; updateStatusBar(0,0,0,0); return; }
            let { text: textWithPeriods, addedPeriods } = addMissingPeriods(text); let { cleanedText, removedSpaces, removedLines, addedSpaces } = removeExtraSpaces(textWithPeriods);
            if (textInput.value !== cleanedText) { textInput.value = cleanedText; }
            extractCadastralNumbers(cleanedText); extractLinks(cleanedText); findForeignLettersAndRepeatedWords(cleanedText); extractFileNames(cleanedText); extractDates(cleanedText); updateStatusBar(removedSpaces, removedLines, addedSpaces, addedPeriods);
        }
        function downloadDates() { const dates = Array.from(document.querySelectorAll('#datesResult li')).map(li => li.textContent); downloadFile('dates.txt', dates.join('\n')); }
        function updateStatusBar(removedSpaces, removedLines, addedSpaces, addedPeriods) {
            const text = document.getElementById('textInput').value;
            const charCount = text.length; const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length; const lineCount = text.trim() === '' ? 0 : text.split(/\r\n|\r|\n/).length;
            document.getElementById('charCount').textContent = `Символов: ${charCount}`; document.getElementById('wordCount').textContent = `Слов: ${wordCount}`; document.getElementById('lineCount').textContent = `Строк: ${lineCount}`;
            removedSpaces = (typeof removedSpaces === 'number' && !isNaN(removedSpaces)) ? removedSpaces : 0; removedLines = (typeof removedLines === 'number' && !isNaN(removedLines)) ? removedLines : 0;
            addedSpaces = (typeof addedSpaces === 'number' && !isNaN(addedSpaces)) ? addedSpaces : 0; addedPeriods = (typeof addedPeriods === 'number' && !isNaN(addedPeriods)) ? addedPeriods : 0;
            document.getElementById('removedSpaces').textContent = `Удалено пробелов: ${removedSpaces}`; document.getElementById('removedLines').textContent = `Удалено строк: ${removedLines}`;
            document.getElementById('addedSpaces').textContent = `Добавлено пробелов: ${addedSpaces}`; document.getElementById('addedPeriods').textContent = `Добавлено точек: ${addedPeriods}`;
            const statusBar = document.getElementById('statusBar'); if (text.trim() !== '') { statusBar.classList.add('visible'); } else { statusBar.classList.remove('visible'); document.getElementById('charCount').textContent = `Символов: 0`; document.getElementById('wordCount').textContent = `Слов: 0`; document.getElementById('lineCount').textContent = `Строк: 0`; document.getElementById('removedSpaces').textContent = `Удалено пробелов: 0`; document.getElementById('removedLines').textContent = `Удалено строк: 0`; document.getElementById('addedSpaces').textContent = `Добавлено пробелов: 0`; document.getElementById('addedPeriods').textContent = `Добавлено точек: 0`; document.getElementById('currentLine').textContent = `Строка: -`; }
            updateCurrentLineInfo();
        }
        function checkBracketsAndQuotes(text) {
            const lines = text.split(/\r?\n/); const errors = []; const pairs = { '"': '"', '«': '»', '(': ')', '{': '}' , '[': ']'};
            lines.forEach((line, lineIndex) => { if (line.trim() === '') return; const stack = []; for (let i = 0; i < line.length; i++) { const char = line[i]; if (pairs[char]) { stack.push({ char: char, expected: pairs[char] }); } else if (Object.values(pairs).includes(char)) { if (stack.length === 0 || stack[stack.length - 1].expected !== char) { if (!(char === ')' && /^\s*\d+\s*\)\s*/.test(line.substring(0, i + 1)))) { errors.push({ sentence: line.trim(), line: lineIndex + 1, char: stack.length > 0 ? stack[stack.length - 1].expected : Object.keys(pairs).find(key => pairs[key] === char) || char, type: 'mismatch_or_missing_open' }); } if (stack.length > 0 && stack[stack.length - 1].expected !== char) stack.pop(); } else { stack.pop(); } } } stack.forEach(unclosed => errors.push({ sentence: line.trim(), line: lineIndex + 1, char: unclosed.expected, type: 'unclosed' })); });
            return errors.filter((error, index, self) => index === self.findIndex((t) => t.sentence === error.sentence && t.line === error.line && t.char === error.char && t.type === error.type));
        }
        function findForeignLettersAndRepeatedWords(text) {
            const lines = text.split(/\r?\n/); const repeatedWords = []; const wordsWithForeignLetters = []; const repeatedPunctuation = []; const punctuationMarksForRepeat = [',', ';', ':', '№', '"', "'", '«', '»', '.', '!', '?'];
            for (let lineNumber = 0; lineNumber < lines.length; lineNumber++) { const line = lines[lineNumber]; const words = line.split(/\s+/); for (let i = 0; i < words.length - 1; i++) { const currentWord = words[i].toLowerCase().replace(/[.,;:!?]$/, ''); const nextWord = words[i+1].toLowerCase().replace(/[.,;:!?]$/, ''); if (currentWord && currentWord === nextWord && /[а-яёa-z0-9]/i.test(currentWord) && currentWord.length > 2) { if (!repeatedWords.some(item => item.word === words[i] && item.line === lineNumber + 1)) { repeatedWords.push({ word: words[i], line: lineNumber + 1 }); } } } for (let mark of punctuationMarksForRepeat) { const escapedMark = mark.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(${escapedMark})(\\s*\\1)+`, 'g'); let match; while ((match = regex.exec(line)) !== null) { if (!repeatedPunctuation.some(item => item.sequence === match[0].trim() && item.line === lineNumber + 1)) { repeatedPunctuation.push({ sequence: match[0].trim(), line: lineNumber + 1 }); } } } words.forEach(wordOriginal => { const word = wordOriginal.replace(/^[«"'(]+|[»"')]+$/g, ''); if (word.length < 3) return; let hasLatin = false; let hasRussian = false; let markedWordContent = ''; let inForeignSpan = false; let currentSegment = ''; for (let i = 0; i < word.length; i++) { const char = word[i]; if (/[a-zA-Z]/.test(char)) { hasLatin = true; if (!inForeignSpan) { if (currentSegment) markedWordContent += currentSegment; currentSegment = ''; markedWordContent += '<span>'; inForeignSpan = true; } } else { if (inForeignSpan) { markedWordContent += currentSegment + '</span>'; currentSegment = ''; inForeignSpan = false; } } currentSegment += char; if (/[а-яА-ЯёЁ]/.test(char)) { hasRussian = true; } } if (currentSegment) { markedWordContent += currentSegment; if (inForeignSpan) markedWordContent += '</span>'; } if (hasLatin && hasRussian) { let finalDisplayWord = markedWordContent; const prefix = wordOriginal.match(/^[«"'(]+/); const suffix = wordOriginal.match(/[»"')]+$/); if(prefix) finalDisplayWord = prefix[0] + finalDisplayWord; if(suffix) finalDisplayWord = finalDisplayWord + suffix[0]; wordsWithForeignLetters.push({ word: finalDisplayWord, line: lineNumber + 1, hasMixed: true }); } }); }
            const bracketErrors = checkBracketsAndQuotes(text); const resultDiv = document.getElementById('foreignLettersResult'); resultDiv.style.display = 'block'; let resultHTML = '<div class="result-header"><i class="fas fa-language result-icon" title="Смешанные буквы, повторы, парные знаки"></i></div><ul>'; let foundAny = false;
            if (repeatedPunctuation.length > 0) { foundAny = true; resultHTML += '<li class="error-category"><strong>Повторяющиеся знаки препинания:</strong></li>'; repeatedPunctuation.forEach(item => resultHTML += `<li>Найден повтор: "${item.sequence}" (строка ${item.line})</li>`); }
            if (repeatedWords.length > 0) { foundAny = true; resultHTML += '<li class="error-category"><strong>Повторяющиеся слова:</strong></li>'; repeatedWords.forEach(item => resultHTML += `<li>Повтор слова: "${item.word}" (строка ${item.line})</li>`); }
            if (wordsWithForeignLetters.length > 0) { foundAny = true; resultHTML += '<li class="error-category"><strong>Слова со смешанными рус./лат. буквами:</strong></li>'; wordsWithForeignLetters.forEach(item => { resultHTML += `<li class="foreign-letter">${item.word} (строка ${item.line})</li>` }); }
            if (bracketErrors.length > 0) { foundAny = true; resultHTML += '<li class="error-category"><strong>Ошибки в парных знаках:</strong></li>'; bracketErrors.forEach(item => resultHTML += `<li>"${item.sentence}" (строка ${item.line}), не хватает/неверный знак "${item.char}"</li>`); }
            resultHTML += '</ul>'; if (!foundAny) { resultHTML = '<div class="result-header"><i class="fas fa-language result-icon"></i></div><p>Смешанных букв, повторов и ошибок в парных знаках не найдено.</p>'; }
            resultDiv.innerHTML = resultHTML;
        }
        function copyToClipboard(text, element) { navigator.clipboard.writeText(text).then(() => { element.classList.add('flash'); setTimeout(() => { element.classList.remove('flash'); }, 500); }).catch(err => { console.error('Не удалось скопировать текст: ', err); }); }
        function downloadNumbers() { const numbers = Array.from(document.querySelectorAll('#cadastralResult li')).map(li => { const textSpan = li.querySelector('.cadastral-number-text'); if (textSpan) { const copySpan = textSpan.querySelector('span[onclick^="copyToClipboard"]'); if (copySpan) { const match = copySpan.getAttribute('onclick').match(/copyToClipboard\('([^']*)'/); if (match && match[1]) return match[1]; } else { const match = textSpan.getAttribute('onclick').match(/copyToClipboard\('([^']*)'/); if (match && match[1]) return match[1]; } } return null; }).filter(num => num !== null && num.trim() !== "" && !num.startsWith("ОКС не найден")); downloadFile('cadastral_numbers.txt', numbers.join('\n')); }
        function downloadLinks() { const links = Array.from(document.querySelectorAll('#linksResult li a')).map(a => a.href); downloadFile('links.txt', links.join('\n')); }
        function downloadFile(filename, text) { const element = document.createElement('a'); element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text)); element.setAttribute('download', filename); element.style.display = 'none'; document.body.appendChild(element); element.click(); document.body.removeChild(element); }
        function copyText() { const textInput = document.getElementById('textInput'); textInput.select(); textInput.setSelectionRange(0, 99999); navigator.clipboard.writeText(textInput.value).then(() => { const copyButton = document.getElementById('copyButton'); copyButton.classList.add('flash-button'); setTimeout(() => { copyButton.classList.remove('flash-button'); }, 300); }).catch(err => { console.error('Не удалось скопировать текст: ', err); }); }
        function getLineNumberFromPosition(textarea, position) { const textUpToPosition = textarea.value.substring(0, position); return textUpToPosition.split('\n').length; }
        function updateCurrentLineInfo() { const textarea = document.getElementById('textInput'); const lineNumber = getLineNumberFromPosition(textarea, textarea.selectionStart); const currentLineSpan = document.getElementById('currentLine'); currentLineSpan.textContent = `Строка: ${lineNumber}`; }
        function openAiModal() { document.getElementById('aiCheckModal').style.display = 'flex'; }
        function closeAiModal() { document.getElementById('aiCheckModal').style.display = 'none'; document.getElementById('aiResultDisplay').innerHTML = ''; document.getElementById('aiCorrectionsListWrapper').style.display = 'none'; document.getElementById('aiCorrectionsList').innerHTML = ''; document.getElementById('aiCheckLoading').style.display = 'none'; }
        
        async function checkGrammarWithAI() {
            const textInput = document.getElementById('textInput');
            const originalText = textInput.value;
            if (originalText.trim() === '') {
                alert('Пожалуйста, введите текст для проверки.');
                return;
            }

            const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') || 
                             (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
            if (needsKey && !apiKey) {
                settingsModal.style.display = 'flex';
                return;
            }

            openAiModal();
            document.getElementById('aiResultDisplay').innerHTML = '';
            document.getElementById('aiCorrectionsListWrapper').style.display = 'none';
            document.getElementById('aiCorrectionsList').innerHTML = '';
            document.getElementById('aiCheckLoading').style.display = 'block';

            const systemPrompt = `Ты — высокоточный редактор и корректор русского языка. Твоя задача — исправить все грамматические и орфографические ошибки в предоставленном пользователем тексте. Верни JSON-объект со следующими двумя полями: 1. "correctedText": строка, содержащая ПОЛНОСТЬЮ ИСПРАВЛЕННЫЙ текст. Сохрани исходное форматирование (абзацы, переносы строк), насколько это возможно. 2. "correctionsMade": массив объектов, где каждый объект описывает одно сделанное исправление и имеет поля: - "original": "слово_или_фраза_с_ошибкой_как_в_оригинале" (точно как в исходном тексте, с учетом регистра) - "corrected": "исправленное_слово_или_фраза". Если ошибок нет, поле "correctionsMade" должно быть пустым массивом [], а "correctedText" должен быть идентичен исходному тексту. Не добавляй никаких объяснений или комментариев, только JSON.`;
            const userPrompt = `${systemPrompt}\n\nТекст для проверки:\n---\n${originalText}`;
            
            const { requestUrl, requestBody } = getAIRequestConfig(userPrompt, false);
            
            try {
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(requestBody)
                });

                document.getElementById('aiCheckLoading').style.display = 'none';
                const data = await response.json();

                if (!response.ok) {
                    const errorDetail = data?.error?.message || `Статус ${response.status}`;
                    throw new Error(`Ошибка API (${response.status}): ${errorDetail}`);
                }
                
                let aiResponseText = parseAIResponse(data);

                if (!aiResponseText) {
                     throw new Error('Не удалось получить ответ от ИИ (пустое поле content).');
                }

                let parsedResponse;
                try {
                    const cleanedText = aiResponseText.trim().replace(/^```json\s*|\s*```$/g, '');
                    parsedResponse = JSON.parse(cleanedText);
                    if (typeof parsedResponse.correctedText !== 'string' || !Array.isArray(parsedResponse.correctionsMade)) {
                        throw new Error("Ответ ИИ имеет неверную структуру JSON.");
                    }
                } catch (e) {
                    console.error("AI Response (raw):", aiResponseText);
                    document.getElementById('aiResultDisplay').innerHTML = `<p style="color: var(--danger-color);">Ошибка при обработке ответа ИИ. Ответ не является корректным JSON.<br>Получено: ${escapeHtmlForDisplay(aiResponseText)}</p>`;
                    return;
                }

                document.getElementById('aiResultDisplay').innerHTML = escapeHtmlForDisplay(parsedResponse.correctedText).replace(/\n/g, '<br>');
                const correctionsListUl = document.getElementById('aiCorrectionsList');

                if (parsedResponse.correctionsMade.length > 0) {
                    parsedResponse.correctionsMade.forEach(correction => {
                        if (correction.original && correction.corrected) {
                            const li = document.createElement('li');
                            li.className = 'ai-correction-item';
                            li.innerHTML = `<span class="ai-correction-original">${escapeHtmlForDisplay(correction.original)}</span> → <span class="ai-correction-corrected">${escapeHtmlForDisplay(correction.corrected)}</span>`;
                            correctionsListUl.appendChild(li);
                        }
                    });
                    document.getElementById('aiCorrectionsListWrapper').style.display = 'block';
                } else {
                    const li = document.createElement('li');
                    li.textContent = "Исправлений не внесено.";
                    li.style.color = 'var(--text-secondary)';
                    correctionsListUl.appendChild(li);
                    document.getElementById('aiCorrectionsListWrapper').style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при проверке текста с ИИ:', error);
                document.getElementById('aiCheckLoading').style.display = 'none';
                document.getElementById('aiResultDisplay').innerHTML = `<p style="color: var(--danger-color);">Произошла ошибка: ${error.message}</p>`;
            }
        }
        
        function escapeHtmlForDisplay(unsafe) { if (typeof unsafe !== 'string') return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function copyAiCorrectedTextToClipboard(buttonElement) {
            const contentHolder = document.getElementById('aiResultDisplay'); const originalHtml = contentHolder.innerHTML;
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = originalHtml.replace(/<br\s*\/?>/gi, '\n');
            const textToCopy = tempDiv.innerText || tempDiv.textContent || "";
            navigator.clipboard.writeText(textToCopy).then(() => { if (buttonElement) { buttonElement.classList.add('flash-button'); setTimeout(() => { buttonElement.classList.remove('flash-button'); }, 300); } }).catch(err => { alert('Не удалось скопировать текст.'); console.error('Copy error:', err); });
        }
        document.getElementById('textInput').addEventListener('click', updateCurrentLineInfo);
        document.getElementById('textInput').addEventListener('keyup', updateCurrentLineInfo);
        document.getElementById('textInput').addEventListener('select', updateCurrentLineInfo);
        document.getElementById('textInput').addEventListener('input', () => updateStatusBar(0,0,0,0));
        
        // Initialize on load
        window.addEventListener('load', () => {
            initTheme();
            initSettings();
            updateStatusBar(0,0,0,0);
        });
    </script>
</body>
</html>
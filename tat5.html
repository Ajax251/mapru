<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–∞—Ä—Ç—ã –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplify-js/1.2.4/simplify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
        }
        
        #map { width: 100%; height: 100%; }
        
        .control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            max-width: 95%;
        }
        
        .counter {
            background: linear-gradient(135deg, #28a745 0%, #20883a 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .settings-group label {
            font-size: 13px;
            color: #495057;
            white-space: nowrap;
        }
        
        .settings-group input[type="number"] {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }
        
        .settings-group small {
            font-size: 11px;
            color: #6c757d;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        
        #context-menu {
            position: absolute;
            display: none;
            z-index: 2000;
            background: white;
            min-width: 280px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            padding: 8px 0;
            overflow: visible;
        }
        
        #context-menu ul { list-style: none; }
        
        #context-menu li {
            padding: 12px 18px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
            color: #333;
            position: relative;
        }
        
        #context-menu li:hover { background: #f0f4f8; }
        #context-menu li.disabled { color: #adb5bd; cursor: not-allowed; }
        #context-menu li.disabled:hover { background: transparent; }
        
        #context-menu .separator {
            height: 1px;
            background: #e9ecef;
            margin: 6px 0;
            padding: 0;
            cursor: default;
        }
        
        #context-menu .separator:hover { background: #e9ecef; }
        
        #context-menu i { width: 20px; text-align: center; font-size: 15px; }
        
        .icon-add { color: #28a745; }
        .icon-delete { color: #dc3545; }
        .icon-export { color: #6f42c1; }
        
        .has-submenu::after {
            content: '\f054';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 10px;
            margin-left: auto;
            color: #adb5bd;
        }
        
        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            min-width: 260px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px 0;
            margin-left: 5px;
        }
        
        .has-submenu:hover > .submenu { display: block; }
        
        #notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .notification.error { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .notification.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .notification.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        
        .loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loader-content { text-align: center; color: white; }
        
        .loader-spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        input[type="file"] { display: none; }
        
        .stats {
            font-size: 11px;
            color: #6c757d;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="control-panel">
    <div class="counter">
        <i class="fas fa-map-marked-alt"></i>
        <span id="counter-text">0 —Ä–∞–π–æ–Ω–æ–≤</span>
    </div>
    
    <div class="settings-group">
        <label for="tolerance">–£–ø—Ä–æ—â–µ–Ω–∏–µ (–º–µ—Ç—Ä—ã):</label>
        <input type="number" id="tolerance" value="100" min="10" max="5000" step="10">
    </div>
    
    <button class="btn btn-info" id="btn-view">
        <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
    </button>
    
    <button class="btn btn-success" id="btn-load">
        <i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
    </button>
    <input type="file" id="file-input" accept=".json">
    
    <button class="btn btn-danger" id="btn-clear">
        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å
    </button>
    
    <div class="stats" id="stats"></div>
</div>

<div id="context-menu">
    <ul>
        <li id="ctx-add">
            <i class="fas fa-plus-circle icon-add"></i>
            –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞
        </li>
        <li id="ctx-delete" class="disabled">
            <i class="fas fa-trash-alt icon-delete"></i>
            <span id="ctx-delete-text">–£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω</span>
        </li>
        <li class="separator"></li>
        <li class="has-submenu">
            <i class="fas fa-download icon-export"></i>
            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            <ul class="submenu">
                <li id="ctx-export-db">
                    <i class="fas fa-database" style="color:#6c757d"></i>
                    –≠–∫—Å–ø–æ—Ä—Ç –ë–î (–ø—Ä–æ–µ–∫—Ç)
                </li>
                <li class="separator"></li>
                <li id="ctx-export-full">
                    <i class="fas fa-file-code" style="color:#007bff"></i>
                    JSON –ø–æ–ª–Ω—ã–π
                </li>
                <li id="ctx-export-simple">
                    <i class="fas fa-file-contract" style="color:#28a745"></i>
                    JSON —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π
                </li>
                <li class="separator"></li>
                <li id="ctx-export-html">
                    <i class="fas fa-globe" style="color:#fd7e14"></i>
                    HTML –∫–∞—Ä—Ç–∞
                </li>
            </ul>
        </li>
    </ul>
</div>

<div id="notifications"></div>

<div class="loader-overlay" id="loader">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script>
// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const CONFIG = {
    map: { center: [55.35, 50.75], zoom: 7 },
    db: { name: 'TatarstanMapDB', version: 1, storeName: 'districts' },
    api: { nspdLayer: 36278, baseUrl: 'https://nspd.gov.ru/api/aeggis/v3' },
    styles: {
        default: { fillColor: 'rgba(0, 123, 255, 0.3)', strokeColor: '#0056b3', strokeWidth: 2 },
        hover: { fillColor: 'rgba(40, 167, 69, 0.5)', strokeColor: '#28a745', strokeWidth: 3 }
    }
};

proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs');
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

// ============================================================
// –ë–ê–ó–ê –î–ê–ù–ù–´–•
// ============================================================
const DB = {
    db: null,
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.db.name, CONFIG.db.version);
            request.onerror = () => reject(request.error);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(CONFIG.db.storeName)) {
                    db.createObjectStore(CONFIG.db.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
        });
    },
    
    async save(district) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).put(district);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async remove(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async getAll() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readonly');
            const request = tx.objectStore(CONFIG.db.storeName).getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
    },
    
    async clear() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).clear();
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async importBulk(districts) {
        await this.clear();
        const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
        const store = tx.objectStore(CONFIG.db.storeName);
        districts.forEach(d => store.put(d));
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }
};

// ============================================================
// –£–¢–ò–õ–ò–¢–´
// ============================================================
const GeoUtils = {
    toLatLon(coords) {
        const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', coords);
        return [lat, lon];
    },
    
    toMercator(latLon) {
        return proj4('EPSG:4326', 'EPSG:3857', [latLon[1], latLon[0]]);
    },
    
    convertGeometry(geometry) {
        const convertRing = ring => ring.map(coord => this.toLatLon(coord));
        
        if (geometry.type === 'Polygon') {
            return { type: 'Polygon', coordinates: geometry.coordinates.map(convertRing) };
        } else if (geometry.type === 'MultiPolygon') {
            return { type: 'MultiPolygon', coordinates: geometry.coordinates.map(poly => poly.map(convertRing)) };
        }
        return geometry;
    },
    
    // –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–∞
    // toleranceMeters - –¥–æ–ø—É—Å–∫ –≤ –º–µ—Ç—Ä–∞—Ö. –¢–æ—á–∫–∏ –±–ª–∏–∂–µ —ç—Ç–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∫ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã
    simplifyRing(ring, toleranceMeters) {
        if (!ring || ring.length < 4) return ring;
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º lat/lon –≤ –º–µ—Ç—Ä—ã (EPSG:3857) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —É–ø—Ä–æ—â–µ–Ω–∏—è
        const points = ring.map(([lat, lon]) => {
            const [x, y] = proj4('EPSG:4326', 'EPSG:3857', [lon, lat]);
            return { x, y };
        });
        
        // –£–ø—Ä–æ—â–∞–µ–º –≤ –º–µ—Ç—Ä–∞—Ö
        const simplified = simplify(points, toleranceMeters, true);
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ lat/lon
        return simplified.map(p => {
            const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', [p.x, p.y]);
            return [lat, lon];
        });
    },
    
    simplifyGeometry(geometry, toleranceMeters) {
        try {
            if (geometry.type === 'Polygon') {
                return {
                    type: 'Polygon',
                    coordinates: geometry.coordinates.map(ring => this.simplifyRing(ring, toleranceMeters))
                };
            } else if (geometry.type === 'MultiPolygon') {
                return {
                    type: 'MultiPolygon',
                    coordinates: geometry.coordinates.map(poly =>
                        poly.map(ring => this.simplifyRing(ring, toleranceMeters))
                    )
                };
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è:', e);
        }
        return geometry;
    },
    
    // –ü–æ–¥—Å—á—ë—Ç —Ç–æ—á–µ–∫ –≤ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    countPoints(geometry) {
        let count = 0;
        const countRing = ring => { count += ring ? ring.length : 0; };
        
        if (geometry.type === 'Polygon') {
            geometry.coordinates.forEach(countRing);
        } else if (geometry.type === 'MultiPolygon') {
            geometry.coordinates.forEach(poly => poly.forEach(countRing));
        }
        return count;
    },
    
    generateId(name) {
        return name.toLowerCase()
            .replace(/[^a-z–∞-—è—ë0-9]/gi, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '') + '-' + Date.now();
    },
    
    // –ü–ª–æ—â–∞–¥—å –ø–æ–ª–∏–≥–æ–Ω–∞ (–¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - –º–µ–Ω—å—à–∏–π —Å–≤–µ—Ä—Ö—É)
    calcArea(geometry) {
        const getArea = (ring) => {
            if (!ring || ring.length < 3) return 0;
            let area = 0;
            for (let i = 0; i < ring.length - 1; i++) {
                area += ring[i][1] * ring[i + 1][0]; // lon1 * lat2
                area -= ring[i + 1][1] * ring[i][0]; // lon2 * lat1
            }
            return Math.abs(area / 2);
        };
        
        if (geometry.type === 'Polygon') {
            return getArea(geometry.coordinates[0]);
        } else if (geometry.type === 'MultiPolygon') {
            return geometry.coordinates.reduce((sum, poly) => sum + getArea(poly[0]), 0);
        }
        return 0;
    },
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–∏–≥–æ–Ω–∞
    pointInPolygon(point, ring) {
        if (!ring || ring.length < 3) return false;
        
        const [lat, lon] = point;
        let inside = false;
        
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
            const [lat_i, lon_i] = ring[i];
            const [lat_j, lon_j] = ring[j];
            
            if (((lon_i > lon) !== (lon_j > lon)) &&
                (lat < (lat_j - lat_i) * (lon - lon_i) / (lon_j - lon_i) + lat_i)) {
                inside = !inside;
            }
        }
        
        return inside;
    },
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    pointInGeometry(point, geometry) {
        if (geometry.type === 'Polygon') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ç—É—Ä
            if (!this.pointInPolygon(point, geometry.coordinates[0])) return false;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—ã—Ä–∫–∏ (–µ—Å–ª–∏ —Ç–æ—á–∫–∞ –≤ –¥—ã—Ä–∫–µ - –æ–Ω–∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏)
            for (let i = 1; i < geometry.coordinates.length; i++) {
                if (this.pointInPolygon(point, geometry.coordinates[i])) return false;
            }
            return true;
        } else if (geometry.type === 'MultiPolygon') {
            return geometry.coordinates.some(poly => {
                if (!this.pointInPolygon(point, poly[0])) return false;
                for (let i = 1; i < poly.length; i++) {
                    if (this.pointInPolygon(point, poly[i])) return false;
                }
                return true;
            });
        }
        return false;
    }
};

// ============================================================
// API –ù–°–ü–î
// ============================================================
const NSPD = {
    async fetchBoundaries(latLon) {
        const [x, y] = GeoUtils.toMercator(latLon);
        const delta = 0.075;
        const bbox = `${x - delta},${y - delta},${x + delta},${y + delta}`;
        
        const params = new URLSearchParams({
            REQUEST: 'GetFeatureInfo',
            SERVICE: 'WMS',
            VERSION: '1.3.0',
            QUERY_LAYERS: CONFIG.api.nspdLayer,
            LAYERS: CONFIG.api.nspdLayer,
            FORMAT: 'image/png',
            STYLES: '',
            TRANSPARENT: 'true',
            INFO_FORMAT: 'application/json',
            FEATURE_COUNT: '10',
            I: '256', J: '256',
            WIDTH: '512', HEIGHT: '512',
            CRS: 'EPSG:3857',
            BBOX: bbox,
            RANDOM: Math.random()
        });
        
        const url = `${CONFIG.api.baseUrl}/${CONFIG.api.nspdLayer}/wms?${params.toString()}`;
        console.log('–ó–∞–ø—Ä–æ—Å –ù–°–ü–î:', url);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
        
        const data = await response.json();
        console.log('–û—Ç–≤–µ—Ç –ù–°–ü–î:', data.features?.length, '–æ–±—ä–µ–∫—Ç–æ–≤');
        
        if (!data.features || data.features.length === 0) {
            throw new Error('–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }
        
        return data.features;
    },
    
    parseFeature(feature) {
        const name = feature.properties?.options?.name || feature.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const geometry = GeoUtils.convertGeometry(feature.geometry);
        
        return {
            id: GeoUtils.generateId(name),
            name: name,
            geometry: geometry,
            addedAt: new Date().toISOString()
        };
    }
};

// ============================================================
// –ö–ê–†–¢–ê
// ============================================================
const MapModule = {
    map: null,
    objects: new Map(),
    
    async init() {
        return new Promise((resolve) => {
            this.map = new ymaps.Map('map', {
                center: CONFIG.map.center,
                zoom: CONFIG.map.zoom,
                controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
            });
            resolve();
        });
    },
    
    addDistrict(district) {
        const polygon = new ymaps.GeoObject({
            geometry: district.geometry,
            properties: { hintContent: district.name, districtId: district.id, districtName: district.name }
        }, CONFIG.styles.default);
        
        polygon.events.add('mouseenter', () => polygon.options.set(CONFIG.styles.hover));
        polygon.events.add('mouseleave', () => polygon.options.set(CONFIG.styles.default));
        
        this.map.geoObjects.add(polygon);
        this.objects.set(district.id, polygon);
    },
    
    removeDistrict(id) {
        const polygon = this.objects.get(id);
        if (polygon) {
            this.map.geoObjects.remove(polygon);
            this.objects.delete(id);
        }
    },
    
    clear() {
        this.map.geoObjects.removeAll();
        this.objects.clear();
    },
    
    fitBounds() {
        if (this.objects.size > 0) {
            const bounds = this.map.geoObjects.getBounds();
            if (bounds) this.map.setBounds(bounds, { checkZoomRange: true, duration: 300 });
        }
    },
    
    // –ù–∞–π—Ç–∏ —Ä–∞–π–æ–Ω –ø–æ–¥ —Ç–æ—á–∫–æ–π - –≤—ã–±–∏—Ä–∞–µ–º –°–ê–ú–´–ô –ú–ê–õ–ï–ù–¨–ö–ò–ô
    findDistrictAtPoint(coords, districtsCache) {
        let found = null;
        let minArea = Infinity;
        
        for (const [id, district] of districtsCache) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, –Ω–µ –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ –Ø–Ω–¥–µ–∫—Å
            if (GeoUtils.pointInGeometry(coords, district.geometry)) {
                const area = GeoUtils.calcArea(district.geometry);
                console.log(`–¢–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏: ${district.name}, –ø–ª–æ—â–∞–¥—å: ${area}`);
                if (area < minArea) {
                    minArea = area;
                    found = { id, name: district.name };
                }
            }
        }
        
        return found;
    }
};

// ============================================================
// –≠–ö–°–ü–û–†–¢
// ============================================================
const Exporter = {
    async exportDB() {
        try {
            // –í–°–ï–ì–î–ê –±–µ—Ä—ë–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            const districts = await DB.getAll();
            console.log('–≠–∫—Å–ø–æ—Ä—Ç –ë–î, —Ä–∞–π–æ–Ω–æ–≤:', districts.length);
            
            if (districts.length === 0) {
                UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            const data = {
                type: 'TatarstanMapProject',
                version: '2.0',
                createdAt: new Date().toISOString(),
                districts: districts
            };
            
            this.download(JSON.stringify(data, null, 2), 'tatarstan_project.json');
            UI.notify('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
        } catch (e) {
            console.error(e);
            UI.notify('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, 'error');
        }
    },
    
    async exportJSON(simplified = false) {
        try {
            // –í–°–ï–ì–î–ê –±–µ—Ä—ë–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            const districts = await DB.getAll();
            console.log('–≠–∫—Å–ø–æ—Ä—Ç JSON, —Ä–∞–π–æ–Ω–æ–≤:', districts.length, '—É–ø—Ä–æ—â–µ–Ω–∏–µ:', simplified);
            
            if (districts.length === 0) {
                UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            const toleranceMeters = parseInt(document.getElementById('tolerance').value) || 100;
            
            let totalPointsBefore = 0;
            let totalPointsAfter = 0;
            
            const features = districts.map(d => {
                totalPointsBefore += GeoUtils.countPoints(d.geometry);
                
                const geometry = simplified 
                    ? GeoUtils.simplifyGeometry(d.geometry, toleranceMeters)
                    : d.geometry;
                
                totalPointsAfter += GeoUtils.countPoints(geometry);
                
                return {
                    type: 'Feature',
                    properties: { name: d.name },
                    geometry: geometry
                };
            });
            
            console.log(`–¢–æ—á–µ–∫: ${totalPointsBefore} ‚Üí ${totalPointsAfter} (${((1 - totalPointsAfter/totalPointsBefore) * 100).toFixed(1)}% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ)`);
            
            const data = {
                type: 'FeatureCollection',
                meta: { 
                    created: new Date().toISOString(), 
                    simplified, 
                    toleranceMeters: simplified ? toleranceMeters : null,
                    pointsBefore: totalPointsBefore,
                    pointsAfter: totalPointsAfter
                },
                features: features
            };
            
            const filename = simplified ? 'tatarstan_simplified.json' : 'tatarstan_full.json';
            this.download(JSON.stringify(data), filename);
            
            if (simplified) {
                UI.notify(`JSON —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π: ${totalPointsBefore} ‚Üí ${totalPointsAfter} —Ç–æ—á–µ–∫`, 'success');
            } else {
                UI.notify(`JSON –ø–æ–ª–Ω—ã–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω (${totalPointsBefore} —Ç–æ—á–µ–∫)`, 'success');
            }
        } catch (e) {
            console.error(e);
            UI.notify('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, 'error');
        }
    },
    
    async exportHTML() {
        try {
            // –í–°–ï–ì–î–ê –±–µ—Ä—ë–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            const districts = await DB.getAll();
            console.log('–≠–∫—Å–ø–æ—Ä—Ç HTML, —Ä–∞–π–æ–Ω–æ–≤:', districts.length);
            
            if (districts.length === 0) {
                UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            UI.showLoader('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML...');
            
            // –î–∞—ë–º –±—Ä–∞—É–∑–µ—Ä—É –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ª–æ–∞–¥–µ—Ä
            await new Promise(r => setTimeout(r, 50));
            
            const toleranceMeters = parseInt(document.getElementById('tolerance').value) || 100;
            
            const simplified = districts.map(d => ({
                name: d.name,
                geometry: GeoUtils.simplifyGeometry(d.geometry, toleranceMeters)
            }));
            
            const html = this.generateHTML(simplified);
            this.download(html, 'tatarstan_map.html');
            
            UI.hideLoader();
            UI.notify('HTML –∫–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
        } catch (e) {
            console.error(e);
            UI.hideLoader();
            UI.notify('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message, 'error');
        }
    },
    
generateHTML(districts) {
    const data = JSON.stringify(districts);
    
    const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h1 { color: white; margin-bottom: 20px; font-size: 28px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            padding: 25px;
            max-width: 1400px;
            width: 100%;
        }
        #map { width: 100%; display: block; border-radius: 10px; background: #f8f9fa; }
        .district {
            fill: rgba(102, 126, 234, 0.3);
            stroke: #667eea;
            stroke-width: 1.5;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .district:hover { fill: rgba(102, 126, 234, 0.6); stroke-width: 2.5; }
        .district.selected { fill: rgba(118, 75, 162, 0.5); stroke: #764ba2; stroke-width: 3; }
        .info-panel {
            background: white;
            color: #333;
            padding: 20px 35px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            min-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .info-panel h2 { font-size: 20px; color: #667eea; }
        .info-panel p { color: #888; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h1>
    <div class="map-container">
        <svg id="map"></svg>
    </div>
    <div class="info-panel">
        <h2 id="district-name">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω</h2>
        <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ä–∞–π–æ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–∑–≤–∞–Ω–∏—è</p>
    </div>
    <script>var DISTRICTS = ${data};<\/script>
    <script>
(function() {
    var svg = document.getElementById('map');
    var nameEl = document.getElementById('district-name');
    
    var minLat = Infinity, maxLat = -Infinity;
    var minLon = Infinity, maxLon = -Infinity;
    
    DISTRICTS.forEach(function(d) {
        var processRing = function(ring) {
            if (!ring) return;
            ring.forEach(function(coord) {
                if (!coord || coord.length < 2) return;
                var lat = coord[0], lon = coord[1];
                if (isFinite(lat) && isFinite(lon)) {
                    minLat = Math.min(minLat, lat);
                    maxLat = Math.max(maxLat, lat);
                    minLon = Math.min(minLon, lon);
                    maxLon = Math.max(maxLon, lon);
                }
            });
        };
        
        if (d.geometry.type === 'Polygon') {
            d.geometry.coordinates.forEach(processRing);
        } else if (d.geometry.type === 'MultiPolygon') {
            d.geometry.coordinates.forEach(function(poly) { poly.forEach(processRing); });
        }
    });
    
    var latRange = maxLat - minLat;
    var lonRange = maxLon - minLon;
    var padding = 0.05;
    minLat -= latRange * padding;
    maxLat += latRange * padding;
    minLon -= lonRange * padding;
    maxLon += lonRange * padding;
    
    var avgLat = (minLat + maxLat) / 2;
    var lonScale = Math.cos(avgLat * Math.PI / 180);
    
    var width = 1000;
    var height = width * (latRange / (lonRange * lonScale));
    
    svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    
    function toSVG(lat, lon) {
        var x = ((lon - minLon) / (maxLon - minLon)) * width;
        var y = (1 - (lat - minLat) / (maxLat - minLat)) * height;
        return [x, y];
    }
    
    function ringToPath(ring) {
        if (!ring || ring.length === 0) return '';
        var parts = [];
        for (var i = 0; i < ring.length; i++) {
            var coord = ring[i];
            if (!coord || coord.length < 2) continue;
            var pt = toSVG(coord[0], coord[1]);
            parts.push((i === 0 ? 'M' : 'L') + pt[0].toFixed(1) + ',' + pt[1].toFixed(1));
        }
        return parts.join(' ') + ' Z';
    }
    
    function calcArea(geometry) {
        function getArea(ring) {
            if (!ring || ring.length < 3) return 0;
            var area = 0;
            for (var i = 0; i < ring.length - 1; i++) {
                area += ring[i][1] * ring[i + 1][0];
                area -= ring[i + 1][1] * ring[i][0];
            }
            return Math.abs(area / 2);
        }
        if (geometry.type === 'Polygon') return getArea(geometry.coordinates[0]);
        if (geometry.type === 'MultiPolygon') {
            var sum = 0;
            geometry.coordinates.forEach(function(poly) { sum += getArea(poly[0]); });
            return sum;
        }
        return 0;
    }
    
    var sorted = DISTRICTS.slice().sort(function(a, b) {
        return calcArea(b.geometry) - calcArea(a.geometry);
    });
    
    var selected = null;
    
    sorted.forEach(function(d) {
        var pathData = '';
        
        if (d.geometry.type === 'Polygon') {
            pathData = d.geometry.coordinates.map(ringToPath).join(' ');
        } else if (d.geometry.type === 'MultiPolygon') {
            var parts = [];
            d.geometry.coordinates.forEach(function(poly) {
                parts.push(poly.map(ringToPath).join(' '));
            });
            pathData = parts.join(' ');
        }
        
        if (!pathData.trim()) return;
        
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('class', 'district');
        
        path.addEventListener('click', function(e) {
            e.stopPropagation();
            if (selected) selected.classList.remove('selected');
            path.classList.add('selected');
            selected = path;
            nameEl.textContent = d.name;
        });
        
        svg.appendChild(path);
    });
})();
<\/script>
</body>
</html>`;
    
    return html;
}

// ============================================================
// –ü–†–û–°–ú–û–¢–†
// ============================================================
const Viewer = {
    async open() {
        try {
            // –í–°–ï–ì–î–ê –±–µ—Ä—ë–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
            const districts = await DB.getAll();
            console.log('–ü—Ä–æ—Å–º–æ—Ç—Ä, —Ä–∞–π–æ–Ω–æ–≤ –≤ –ë–î:', districts.length);
            
            if (districts.length === 0) {
                UI.notify('–ù–µ—Ç —Ä–∞–π–æ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'warning');
                return;
            }
            
            const toleranceMeters = parseInt(document.getElementById('tolerance').value) || 100;
            console.log('Tolerance:', toleranceMeters, '–º');
            
            const simplified = districts.map(d => ({
                name: d.name,
                geometry: GeoUtils.simplifyGeometry(d.geometry, toleranceMeters)
            }));
            
            const html = Exporter.generateHTML(simplified);
            
            // –°–æ–∑–¥–∞—ë–º Blob –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const newWindow = window.open(url, '_blank');
            if (!newWindow) {
                UI.notify('–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–∫–Ω–æ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞.', 'error');
            }
            
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            
        } catch (e) {
            console.error(e);
            UI.notify('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }
};

// ============================================================
// UI
// ============================================================
const UI = {
    notify(message, type = 'info') {
        const container = document.getElementById('notifications');
        const div = document.createElement('div');
        div.className = `notification ${type}`;
        const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
        div.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i> ${message}`;
        container.appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 300); }, 4000);
    },
    
    showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        document.getElementById('loader-text').textContent = text;
        document.getElementById('loader').style.display = 'flex';
    },
    
    hideLoader() {
        document.getElementById('loader').style.display = 'none';
    },
    
    updateCounter(count) {
        const text = count === 0 ? '0 —Ä–∞–π–æ–Ω–æ–≤' : count === 1 ? '1 —Ä–∞–π–æ–Ω' : count < 5 ? `${count} —Ä–∞–π–æ–Ω–∞` : `${count} —Ä–∞–π–æ–Ω–æ–≤`;
        document.getElementById('counter-text').textContent = text;
    },
    
    updateStats(districts) {
        let totalPoints = 0;
        districts.forEach(d => { totalPoints += GeoUtils.countPoints(d.geometry); });
        document.getElementById('stats').textContent = `–¢–æ—á–µ–∫: ${totalPoints.toLocaleString()}`;
    }
};

// ============================================================
// –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
// ============================================================
const App = {
    clickedCoords: null,
    clickedDistrict: null,
    districtsCache: new Map(),
    
    async init() {
        UI.showLoader('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        try {
            await DB.init();
            await MapModule.init();
            await this.loadFromDB();
            this.setupEvents();
            UI.hideLoader();
            UI.notify('–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –ü–ö–ú –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –º–µ–Ω—é.', 'success');
        } catch (e) {
            UI.hideLoader();
            UI.notify('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            console.error(e);
        }
    },
    
    async loadFromDB() {
        const districts = await DB.getAll();
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –ë–î:', districts.length, '—Ä–∞–π–æ–Ω–æ–≤');
        
        MapModule.clear();
        this.districtsCache.clear();
        
        districts.forEach(d => {
            this.districtsCache.set(d.id, d);
            MapModule.addDistrict(d);
        });
        
        UI.updateCounter(districts.length);
        UI.updateStats(districts);
        if (districts.length > 0) MapModule.fitBounds();
    },
    
    setupEvents() {
        MapModule.map.events.add('contextmenu', (e) => this.showContextMenu(e));
        MapModule.map.events.add('click', () => this.hideContextMenu());
        
        document.getElementById('btn-view').addEventListener('click', () => Viewer.open());
        document.getElementById('btn-load').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e) => this.handleImport(e));
        document.getElementById('btn-clear').addEventListener('click', async () => {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞–π–æ–Ω—ã?')) return;
            await DB.clear();
            await this.loadFromDB();
            UI.notify('–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
        });
        
        document.getElementById('ctx-add').addEventListener('click', () => this.addDistricts());
        document.getElementById('ctx-delete').addEventListener('click', () => this.deleteDistrict());
        
        document.getElementById('ctx-export-db').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportDB(); });
        document.getElementById('ctx-export-full').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportJSON(false); });
        document.getElementById('ctx-export-simple').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportJSON(true); });
        document.getElementById('ctx-export-html').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportHTML(); });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) this.hideContextMenu();
        });
    },
    
    showContextMenu(e) {
        e.preventDefault();
        this.clickedCoords = e.get('coords');
        
        // –ò—â–µ–º —Ä–∞–π–æ–Ω –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é (–Ω–µ –Ø–Ω–¥–µ–∫—Å API)
        this.clickedDistrict = MapModule.findDistrictAtPoint(this.clickedCoords, this.districtsCache);
        
        const deleteItem = document.getElementById('ctx-delete');
        const deleteText = document.getElementById('ctx-delete-text');
        
        if (this.clickedDistrict) {
            deleteItem.classList.remove('disabled');
            deleteText.textContent = `–£–¥–∞–ª–∏—Ç—å: ${this.clickedDistrict.name}`;
            console.log('–í—ã–±—Ä–∞–Ω —Ä–∞–π–æ–Ω:', this.clickedDistrict.name);
        } else {
            deleteItem.classList.add('disabled');
            deleteText.textContent = '–£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω';
        }
        
        const menu = document.getElementById('context-menu');
        const pos = e.get('position');
        menu.style.left = pos[0] + 'px';
        menu.style.top = pos[1] + 'px';
        menu.style.display = 'block';
    },
    
    hideContextMenu() {
        document.getElementById('context-menu').style.display = 'none';
    },
    
    async addDistricts() {
        this.hideContextMenu();
        if (!this.clickedCoords) return;
        
        UI.showLoader('–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü...');
        
        try {
            const features = await NSPD.fetchBoundaries(this.clickedCoords);
            
            const newDistricts = features
                .map(f => NSPD.parseFeature(f))
                .filter(d => {
                    for (const [, existing] of this.districtsCache) {
                        if (existing.name === d.name) return false;
                    }
                    return true;
                });
            
            if (newDistricts.length === 0) {
                throw new Error('–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
            }
            
            for (const district of newDistricts) {
                await DB.save(district);
                this.districtsCache.set(district.id, district);
                MapModule.addDistrict(district);
            }
            
            UI.updateCounter(this.districtsCache.size);
            UI.updateStats(Array.from(this.districtsCache.values()));
            MapModule.fitBounds();
            UI.notify(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${newDistricts.length} —à—Ç.`, 'success');
            
        } catch (e) {
            UI.notify(e.message, 'error');
        }
        
        UI.hideLoader();
    },
    
    async deleteDistrict() {
        this.hideContextMenu();
        
        if (!this.clickedDistrict) {
            UI.notify('–†–∞–π–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω', 'warning');
            return;
        }
        
        const { id, name } = this.clickedDistrict;
        console.log('–£–¥–∞–ª–µ–Ω–∏–µ:', name, id);
        
        await DB.remove(id);
        this.districtsCache.delete(id);
        MapModule.removeDistrict(id);
        
        UI.updateCounter(this.districtsCache.size);
        UI.updateStats(Array.from(this.districtsCache.values()));
        UI.notify(`–£–¥–∞–ª—ë–Ω: ${name}`, 'info');
        
        this.clickedDistrict = null;
    },
    
    async handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        UI.showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                let districts = [];
                
                if (data.type === 'TatarstanMapProject' && data.districts) {
                    districts = data.districts;
                } else if (data.type === 'FeatureCollection' && data.features) {
                    districts = data.features.map(f => ({
                        id: GeoUtils.generateId(f.properties?.name || 'unknown'),
                        name: f.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        geometry: f.geometry,
                        addedAt: new Date().toISOString()
                    }));
                } else {
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                }
                
                await DB.importBulk(districts);
                await this.loadFromDB();
                UI.notify(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${districts.length} —Ä–∞–π–æ–Ω–æ–≤`, 'success');
                
            } catch (e) {
                UI.notify('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
            UI.hideLoader();
        };
        
        reader.readAsText(file);
        e.target.value = '';
    }
};

// –ó–∞–ø—É—Å–∫
ymaps.ready(() => App.init());
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск ФГИС ТП</title>
    <link rel="icon" id="favicon" href="https://img.icons8.com/?size=100&id=13778&format=png&color=000000" type="image/png">

    <style>
     * { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 16px; line-height: 1.6; color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
        display: flex; flex-direction: column; min-height: 100vh;
        padding: 30px; gap: 20px;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #6c8eaf; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #4a6d8c; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74, 109, 140, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(74, 109, 140, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 109, 140, 0); } }

    .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); overflow: hidden; transition: all 0.3s ease; }
    .card:hover { box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15); }

    .search-container { padding: 25px; position: relative; z-index: 10; flex-shrink: 0; }
    .controls-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        padding: 0 25px 10px 25px;
        flex-shrink: 0;
        display: none; /* Initially hidden */
    }
    .results-container { flex-grow: 1; overflow-y: auto; padding: 0; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; position: relative; z-index: 5; display: flex; flex-direction: column; }
    .visible { opacity: 1 !important; visibility: visible !important; }

    #searchInput { width: 100%; padding: 15px 20px; font-size: 1.1rem; border: 2px solid #e0e7ff; border-radius: 50px; transition: all 0.3s ease; text-align: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); background-color: #f8faff; }
    #searchInput:focus { border-color: #4a6d8c; outline: none; box-shadow: 0 0 15px rgba(74, 109, 140, 0.2); background-color: #fff; animation: pulse 2s infinite; }
    #searchInput::placeholder { color: #a0aec0; transition: opacity 0.3s; }
    #searchInput:focus::placeholder { opacity: 0.5; }

    .result-item {
        padding: 18px 25px; border-bottom: 1px solid #edf2f7; cursor: pointer; transition: all 0.3s ease; animation: fadeIn 0.4s ease forwards; opacity: 0; display: flex; align-items: flex-start; flex-shrink: 0; background-color: #ffffff; color: #000000;
    }
    .result-item:last-child { border-bottom: none; }
    .result-item:hover { background-color: #e6f0ff; transform: translateY(-2px); }
    .result-item::before { content: "•"; color: #4a6d8c; font-size: 1.5em; line-height: 1.4; flex-shrink: 0; transition: color 0.3s ease; margin-right: 15px; margin-top: -2px; }
    .result-item:hover::before { color: red; }
    .result-item .text-content { display: flex; flex-direction: column; flex-grow: 1; }
    .result-item .admin-unit { font-size: 0.95em; color: #000000; white-space: normal; word-wrap: break-word; line-height: 1.5; }
    .result-item .admin-unit strong { background-color: #fff3cd; font-weight: 600; color: #5b5035; padding: 0.5px 2px; border-radius: 3px; }
    .result-item .secondary-info { font-size: 0.8em; color: #000000; margin-top: 6px; white-space: normal; word-wrap: break-word; line-height: 1.4; }
    .result-item .doc-info { font-size: 0.8em; color: #000000; margin-top: 4px; white-space: normal; word-wrap: break-word; line-height: 1.4; }
    .result-item.inactive { display: none; background-color: #ffe0e0; }
    .results-container.show-inactive .result-item.inactive { display: flex; animation: fadeIn 0.4s ease forwards; opacity: 0; }
    .doc-info .internal-status.inactive-status { color: #c53030; font-weight: 600; }
    .result-item.highlight-green { background-color: #e0ffe0; }

    .outdated-warning {
        font-size: 0.85em; font-weight: 600; color: #9c4221; background-color: #fff4e6; border: 1px solid #f9caa7; padding: 5px 8px; margin-top: 8px; border-radius: 6px;
    }
    .placeholder-message, .searching-message, .no-results-message { padding: 30px; text-align: center; border-radius: 12px; margin: 0; font-size: 1.1em; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05); }
    .placeholder-message { color: #718096; font-style: italic; background-color: #f8faff; border: 1px dashed #cbd5e0; }
    .searching-message { color: #4a6d8c; background-color: #e6f0ff; border: 1px solid #bee3f8; }
    .no-results-message { color: #718096; background-color: #f8faff; border: 1px dashed #cbd5e0; }
    .control-button { padding: 8px 18px; font-size: 0.9em; color: #fff; border: none; border-radius: 20px; cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    .control-button:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
    .control-button:active { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
    .show-inactive-button { background-color: #e53e3e; }
    .show-inactive-button:hover { background-color: #c53030; }
    .show-all-active-button { background-color: #3182ce; }
    .show-all-active-button:hover { background-color: #2b6cb0; }
    #filterInput {
        padding: 8px 15px; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 20px; width: 250px; transition: all 0.3s ease;
    }
    #filterInput:focus {
        outline: none; border-color: #4a6d8c; box-shadow: 0 0 0 3px rgba(74, 109, 140, 0.2);
    }

    @media (max-width: 768px) {
        body { padding: 15px; gap: 15px; }
        .search-container { padding: 15px; }
        #searchInput { padding: 12px 15px; font-size: 1rem; }
        .controls-container { padding: 0 15px 10px 15px; flex-direction: column; align-items: stretch; gap: 15px;}
        .result-item { padding: 15px 20px; }
        .result-item::before { margin-right: 10px; }
        #filterInput { width: 100%; }
        .placeholder-message, .searching-message, .no-results-message { padding: 20px; }
    }
    </style>
</head>
<body>
    <div class="search-container card">
        <input type="text" id="searchInput" placeholder="Найти документ ФГИС ТП по адресу, номеру, наименованию или дате">
    </div>

    <div class="controls-container" id="controlsContainer"></div>

    <div class="results-container card" id="resultsContainer">
        <div class="placeholder-message">Введите текст в поле поиска (минимум 2 символа) и нажмите Enter</div>
    </div>

    <script>
        const INACTIVE_STATUSES = ["Неактуальная редакция", "Удален"];
        const PZZ_KEYWORD = "правила землепользования";
        const PZZ_ABBR_KEYWORD = "пзз";

        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const controlsContainer = document.getElementById('controlsContainer');
        
        let allSearchResults = [];
        let isPZZFilterActive = true;
        
        function replaceEnglishWithRussian(text) {
            const map = { 'q':'й','w':'ц','e':'у','r':'к','t':'е','y':'н','u':'г','i':'ш','o':'щ','p':'з','[':'х',']':'ъ','a':'ф','s':'ы','d':'в','f':'а','g':'п','h':'р','j':'о','k':'л','l':'д',';':'ж','\'':'э','z':'я','x':'ч','c':'с','v':'м','b':'и','n':'т','m':'ь','Q':'Й','W':'Ц','E':'У','R':'К','T':'Е','Y':'Н','U':'Г','I':'Ш','O':'Щ','P':'З','{':'Х','}':'Ъ','A':'Ф','S':'Ы','D':'В','F':'А','G':'П','H':'Р','J':'О','K':'Л','L':'Д',':':'Ж','"':'Э','Z':'Я','X':'Ч','C':'С','V':'М','B':'И','N':'Т','M':'Ь' };
            return text.split('').map(char => map[char] || char).join('');
        }

        searchInput.addEventListener('input', function() {
            const start = this.selectionStart, end = this.selectionEnd;
            this.value = replaceEnglishWithRussian(this.value);
            this.setSelectionRange(start, end);
        });

        function showResultsContainer() { resultsContainer.classList.add('visible'); }

        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') { event.preventDefault(); handleSearch(); } });

        function createFullText(result) {
            return [ result.administrative_unit, result.document_title_h1, result.document_name, result.document_type, result.document_number, result.document_approval_date_text, result.internal_status ].filter(Boolean).join(' ').toLowerCase();
        }

        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return 0;
            const parts = dateString.split('.');
            if (parts.length !== 3) return 0;
            return parseInt(`${parts[2]}${parts[1]}${parts[0]}`, 10);
        }

        async function handleSearch() {
            const searchTerm = searchInput.value.trim();
            resultsContainer.classList.remove('visible', 'show-inactive');
            resultsContainer.innerHTML = '';
            controlsContainer.innerHTML = '';
            controlsContainer.style.display = 'none';

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<div class="placeholder-message">Введите минимум 2 символа для поиска.</div>';
                showResultsContainer();
                allSearchResults = [];
                return;
            }

            resultsContainer.innerHTML = '<div class="searching-message">Поиск...</div>';
            showResultsContainer();
            allSearchResults = [];
            isPZZFilterActive = true; 

            const apiUrl = `https://mapruapp.ru/api/search?db=fgis_tp&q=${encodeURIComponent(searchTerm)}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error((await response.json()).error || `Ошибка сети: ${response.statusText}`);
                const result = await response.json();
                allSearchResults = result.data || [];
                console.log(`Бэкенд выполнил поиск типа: ${result.search_type}`);
                updateResultsDisplay();
            } catch (error) {
                console.error('Ошибка при поиске:', error);
                resultsContainer.innerHTML = `<div class="placeholder-message" style="color: red;">Ошибка: ${error.message}</div>`;
                allSearchResults = [];
            }
        }
        
             function updateResultsDisplay() {
            // Получаем текст из поля фильтра (если оно существует)
            const filterInputEl = document.getElementById('filterInput');
            const filterText = filterInputEl ? filterInputEl.value.toLowerCase().trim() : '';

            // Очищаем только контейнер с результатами, оставляя контролы в покое
            resultsContainer.innerHTML = '';
            
            // --- Подготовка и анализ данных (без изменений) ---
            const allActiveResults = allSearchResults.filter(r => !INACTIVE_STATUSES.includes(r.internal_status));
            const allInactiveResults = allSearchResults.filter(r => INACTIVE_STATUSES.includes(r.internal_status));
            const groupedByAddressAndType = {};
            allActiveResults.forEach(result => {
                const key = `${result.administrative_unit}|${result.document_type}`;
                if (!groupedByAddressAndType[key]) groupedByAddressAndType[key] = [];
                groupedByAddressAndType[key].push(result);
            });
            Object.values(groupedByAddressAndType).forEach(group => {
                if (group.length > 1) {
                    const latestDoc = group.reduce((latest, current) => parseDate(current.document_approval_date_text) > parseDate(latest.document_approval_date_text) ? current : latest);
                    group.forEach(doc => { doc.isPossiblyOutdated = (doc.document_id !== latestDoc.document_id); });
                }
            });
            
            // --- Логика фильтрации (исправлена и упрощена) ---
            let activeResultsToDisplay = allActiveResults;
            let applyPZZGreenHighlight = true;
            if (isPZZFilterActive) {
                const pzzResults = allActiveResults.filter(r => createFullText(r).includes(PZZ_KEYWORD));
                if (pzzResults.length > 0) {
                    activeResultsToDisplay = pzzResults;
                    applyPZZGreenHighlight = false;
                }
            }
            
            let finalActiveToRender = activeResultsToDisplay;
            let finalInactiveToRender = allInactiveResults;
            if (filterText) {
                finalActiveToRender = activeResultsToDisplay.filter(r => createFullText(r).includes(filterText));
                finalInactiveToRender = allInactiveResults.filter(r => createFullText(r).includes(filterText));
            }

            // --- Отрисовка результатов (без изменений) ---
            renderItemsList(finalActiveToRender, applyPZZGreenHighlight);
            renderItemsList(finalInactiveToRender, false);

            if (allSearchResults.length === 0) {
                 resultsContainer.innerHTML = '<div class="no-results-message">Записи не найдены.</div>';
            } else if (resultsContainer.children.length === 0) {
                 resultsContainer.innerHTML = '<div class="no-results-message">Записи, соответствующие фильтру, не найдены.</div>';
            }

            // --- Управление панелью контролов (полностью переработано) ---
            // Очищаем только кнопки, оставляя поле фильтра нетронутым
            controlsContainer.querySelectorAll('.control-button').forEach(btn => btn.remove());
            
            // Создаем поле фильтра только один раз, если его еще нет
            if (!filterInputEl && allSearchResults.length > 0) {
                const filterInput = document.createElement('input');
                filterInput.type = 'text';
                filterInput.id = 'filterInput';
                filterInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        updateResultsDisplay();
                    }
                });
                controlsContainer.prepend(filterInput); // Вставляем в начало
            }

            // Создаем и добавляем кнопки как и раньше
            if (isPZZFilterActive && allActiveResults.length > activeResultsToDisplay.length) {
                const btnShowAll = document.createElement('button');
                btnShowAll.className = 'control-button show-all-active-button';
                btnShowAll.textContent = `Показать все (${allActiveResults.length})`;
                btnShowAll.onclick = () => { isPZZFilterActive = false; updateResultsDisplay(); };
                controlsContainer.appendChild(btnShowAll);
            }
            if (allInactiveResults.length > 0 && !resultsContainer.classList.contains('show-inactive')) {
                const btnShowInactive = document.createElement('button');
                btnShowInactive.className = 'control-button show-inactive-button';
                btnShowInactive.textContent = `Показать неактуальные (${allInactiveResults.length})`;
                btnShowInactive.onclick = () => { resultsContainer.classList.add('show-inactive'); updateResultsDisplay(); };
                controlsContainer.appendChild(btnShowInactive);
            }

            // Показываем или скрываем всю панель
            if (allSearchResults.length > 0) {
                controlsContainer.style.display = 'flex';
            } else {
                 controlsContainer.style.display = 'none';
            }
        }

        function renderItemsList(itemsToRender, applyPZZHighlight) {
            const searchTerm = searchInput.value.trim();
            const searchWords = searchTerm.split(/\s+/).filter(word => word.length > 0);
            itemsToRender.forEach((result, index) => {
                const isInactive = INACTIVE_STATUSES.includes(result.internal_status);
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                if (isInactive) resultItem.classList.add('inactive');
                const textContainer = document.createElement('div');
                textContainer.className = 'text-content';
                let adminUnitText = result.administrative_unit || '[АЕ не указана]';
                const adminUnitDiv = document.createElement('div');
                adminUnitDiv.className = 'admin-unit';
                searchWords.forEach(word => {
                    if (word.length > 1) {
                        const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        adminUnitText = adminUnitText.replace(new RegExp(escapedWord, 'gi'), '<strong>$&</strong>');
                    }
                });
                adminUnitDiv.innerHTML = adminUnitText;
                textContainer.appendChild(adminUnitDiv);
                const titleH1 = result.document_title_h1 || '';
                const docName = result.document_name || '';
                let secondaryText = titleH1 && docName ? `${titleH1} (${docName})` : titleH1 || `(${docName})`;
                if (secondaryText) {
                    const secondaryInfoDiv = document.createElement('div');
                    secondaryInfoDiv.className = 'secondary-info';
                    secondaryInfoDiv.textContent = secondaryText;
                    textContainer.appendChild(secondaryInfoDiv);
                }
                const docType = result.document_type || '';
                const docNumber = result.document_number || '';
                const approvalDate = result.document_approval_date_text || '';
                const internalStatus = result.internal_status || '';
                let docInfoText = '';
                if (docType) docInfoText += `Тип: ${docType}`;
                if (docNumber) docInfoText += (docInfoText ? ' | ' : '') + `№ ${docNumber}`;
                if (approvalDate) docInfoText += (docInfoText ? '' : '') + ` от ${approvalDate}`;
                let internalStatusSpan = '';
                if (internalStatus) {
                    const statusClass = isInactive ? 'internal-status inactive-status' : 'internal-status';
                    internalStatusSpan = `<span class="${statusClass}">${internalStatus}</span>`;
                }
                if (docInfoText || internalStatusSpan) {
                    const docInfoDiv = document.createElement('div');
                    docInfoDiv.className = 'doc-info';
                    docInfoDiv.innerHTML = docInfoText + (internalStatusSpan ? (docInfoText ? ' | ' : '') + internalStatusSpan : '');
                    textContainer.appendChild(docInfoDiv);
                }
                if (result.isPossiblyOutdated) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'outdated-warning';
                    warningDiv.textContent = 'Внимание: Возможно, существует более новая версия этого документа.';
                    textContainer.appendChild(warningDiv);
                }
                resultItem.appendChild(textContainer);
                if (!isInactive && applyPZZHighlight) {
                    const fullTextContent = createFullText(result);
                    if (fullTextContent.includes(PZZ_KEYWORD) || fullTextContent.includes(PZZ_ABBR_KEYWORD)) {
                        resultItem.classList.add('highlight-green');
                    }
                }
                resultItem.addEventListener('click', () => {
                    if (result?.url?.startsWith('http')) { window.open(result.url, '_blank'); } 
                    else { console.warn('Нет действительной ссылки для клика:', result); }
                });
                resultsContainer.appendChild(resultItem);
                setTimeout(() => { resultItem.style.opacity = 1; }, 50 + index * 10);
            });
             if (resultsContainer.children.length > 0) {
                resultsContainer.scrollTop = 0;
            }
        }
    </script>
</body>
</html>
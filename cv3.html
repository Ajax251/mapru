<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер Координат</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 20px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: auto; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #343a40; }
        label { display: block; margin-top: 20px; font-weight: bold; }
        textarea, input[type="text"], select { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; }
        textarea { height: 220px; resize: vertical; font-family: monospace; }
        button { display: block; width: 100%; padding: 12px; margin-top: 25px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        .swap-btn {
            width: auto; padding: 4px 12px; font-size: 12px; margin-top: 8px;
            margin-bottom: 5px; background-color: #6c757d; float: right;
        }
        .swap-btn:hover { background-color: #5a6268; }
        .clearfix::after { content: ""; clear: both; display: table; }
        #result-area { margin-top: 10px; background-color: #e9ecef; color: #495057; height: 220px; font-family: monospace; }
        .error { color: #dc3545; border-color: #dc3545; }
        .custom-input { display: none; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Конвертер координат</h1>

        <div class="clearfix">
            <label for="sourceText">Исходные координаты:</label>
            <button id="swapSourceBtn" class="swap-btn">↔ Поменять колонки</button>
        </div>
        <textarea id="sourceText" placeholder="Вставьте сюда координаты..."></textarea>

        <label for="sourceScSelect">Исходная система координат (СК):</label>
        <select id="sourceScSelect">
            <option value="EPSG:6331601" selected>Татарстан МСК-16 зона 1</option>
            <option value="EPSG:6331602">Татарстан МСК-16 зона 2</option>
            <option value="EPSG:6336302">МСК-63 зона 2 (Самарская обл.)</option>
            <option value="EPSG:4326">WGS 84 (широта/долгота)</option>
            <option value="EPSG:3857">Web Mercator (EPSG:3857)</option>
            <option value="custom">Другая (ввести вручную)</option>
        </select>
        <input type="text" id="sourceScInput" class="custom-input" placeholder="Введите код EPSG">
        
        <label for="destScSelect">Целевая система координат (СК):</label>
        <select id="destScSelect">
            <option value="EPSG:4326" selected>WGS 84 (широта/долгота)</option>
            <option value="EPSG:3857">Web Mercator (EPSG:3857)</option>
            <option value="EPSG:6331601">Татарстан МСК-16 зона 1</option>
            <option value="EPSG:6331602">Татарстан МСК-16 зона 2</option>
            <option value="EPSG:6336302">МСК-63 зона 2 (Самарская обл.)</option>
            <option value="custom">Другая (ввести вручную)</option>
        </select>
        <input type="text" id="destScInput" class="custom-input" placeholder="Введите код EPSG">

        <button id="convertBtn">Конвертировать</button>

        <div class="clearfix">
            <h2>Результат:</h2>
            <button id="swapResultBtn" class="swap-btn">↔ Поменять колонки</button>
        </div>
        <textarea id="result-area" readonly>Здесь будет результат...</textarea>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const convertBtn = document.getElementById('convertBtn');
            const sourceTextArea = document.getElementById('sourceText');
            const resultArea = document.getElementById('result-area');
            const sourceScSelect = document.getElementById('sourceScSelect');
            const sourceScInput = document.getElementById('sourceScInput');
            const destScSelect = document.getElementById('destScSelect');
            const destScInput = document.getElementById('destScInput');
            const swapSourceBtn = document.getElementById('swapSourceBtn');
            const swapResultBtn = document.getElementById('swapResultBtn');

            function toggleCustomInput(selectElement, inputElement) {
                inputElement.style.display = (selectElement.value === 'custom') ? 'block' : 'none';
            }

            sourceScSelect.addEventListener('change', () => toggleCustomInput(sourceScSelect, sourceScInput));
            destScSelect.addEventListener('change', () => toggleCustomInput(destScSelect, destScInput));
            
            function swapTextareaColumns(textarea) {
                const text = textarea.value;
                const lines = text.split('\n');
                const swappedLines = lines.map(line => {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length === 2) { return `${parts[1]}\t${parts[0]}`; }
                    return line;
                });
                textarea.value = swappedLines.join('\n');
            }

            swapSourceBtn.addEventListener('click', () => swapTextareaColumns(sourceTextArea));
            swapResultBtn.addEventListener('click', () => swapTextareaColumns(resultArea));

            // *** НАЧАЛО ИЗМЕНЕНИЙ: Обработка вставки текста ***
            sourceTextArea.addEventListener('paste', function(event) {
                // Предотвращаем стандартную вставку, чтобы обработать текст вручную
                event.preventDefault();

                // Получаем текст из буфера обмена
                let pastedText = (event.clipboardData || window.clipboardData).getData('text');
                
                let lines = pastedText.trim().split('\n');

                // ПРАВИЛО №1: Замена разделителя (запятая/точка с запятой на таб)
                if (lines.length > 0) {
                    const firstLine = lines[0].trim();
                    const hasTab = firstLine.includes('\t');
                    const hasSingleComma = (firstLine.match(/,/g) || []).length === 1;
                    const hasSingleSemicolon = (firstLine.match(/;/g) || []).length === 1;

                    if (!hasTab && (hasSingleComma || hasSingleSemicolon)) {
                        const separator = hasSingleComma ? ',' : ';';
                        lines = lines.map(line => {
                            // Меняем только если в строке нет таба и есть наш разделитель
                            if (!line.includes('\t') && line.includes(separator)) {
                                return line.replace(separator, '\t');
                            }
                            return line;
                        });
                        pastedText = lines.join('\n');
                    }
                }

                // ПРАВИЛО №2: Замена всех оставшихся запятых (десятичных) на точки
                pastedText = pastedText.replace(/,/g, '.');

                // ПРАВИЛО №3: Автоопределение EPSG:3857 по точности координат
                const firstLineProcessed = pastedText.split('\n')[0].trim();
                const parts = firstLineProcessed.split(/\s+/);
                
                if (parts.length === 2) {
                    const hasLongDecimal = (coord) => {
                        if (coord.includes('.')) {
                            const decimalPart = coord.split('.')[1];
                            return decimalPart.length > 3;
                        }
                        return false;
                    };

                    if (hasLongDecimal(parts[0]) || hasLongDecimal(parts[1])) {
                        sourceScSelect.value = 'EPSG:3857';
                    }
                }

                // Вставляем обработанный текст в поле
                sourceTextArea.value = pastedText;
            });
            // *** КОНЕЦ ИЗМЕНЕНИЙ ***

            convertBtn.addEventListener('click', async () => {
                function getScValue(selectElement, inputElement) {
                    return selectElement.value === 'custom' 
                        ? inputElement.value.trim() 
                        : selectElement.value;
                }

                const sourceText = sourceTextArea.value.trim();
                const sourceSc = getScValue(sourceScSelect, sourceScInput);
                const destSc = getScValue(destScSelect, destScInput);

                if (!sourceText || !sourceSc || !destSc) {
                    resultArea.value = 'Ошибка: Все поля должны быть заполнены.';
                    resultArea.classList.add('error');
                    return;
                }

                resultArea.value = 'Обработка запроса...';
                resultArea.classList.remove('error');

                try {
                    const response = await fetch('https://cc-psi-livid.vercel.app/api/convert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sourceText, sourceSc, destSc })
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || `Сервер вернул ошибку ${response.status}`);
                    }
                    
                    if (result.error && result.error.length > 0) {
                        resultArea.value = `Ошибка от polygon.top: ${result.error}`;
                        resultArea.classList.add('error');
                    } else if (result.destText) {
                        resultArea.value = result.destText.replace(/\r/g, '');
                    } else {
                        resultArea.value = "Не удалось найти отформатированный текст. Полный ответ:\n\n" + JSON.stringify(result, null, 2);
                    }
                } catch (error) {
                    resultArea.value = `Произошла ошибка: ${error.message}`;
                    resultArea.classList.add('error');
                }
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Интерактивная диаграмма</title>
    <script src="webfonts/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="webfonts/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <link rel="icon" href="img/diag.png" type="image/png">
<style>
:root {
    --bg-color: #f8f9fa;
    --card-bg: #ffffff;
    --text-color: #2b2d42;
    --light-text: #8d99ae;
    --border-color: #e0e0e0;
    --accent-color: #4361ee;
    --button-color: white;
    --input-bg: #f8f9fa;
    --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    --border-radius: 12px;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --control-panel-height: 70px;
    --btn-color-type: #4361ee;
    --btn-color-display: #f77f00;
    --btn-color-appearance: #00b4d8;
    --btn-color-send: #305CDE;
    --option-hover: #f1f3f4;
    --option-selected: #e8f0fe;
    --option-selected-border: #1a73e8;
    --modal-bg: #ffffff;
    --modal-border: #dadce0;
    --modal-shadow: rgba(0, 0, 0, 0.2);
    --modal-textarea-bg: #f8f9fa;
    --modal-textarea-border: #dadce0;
    --modal-textarea-color: #202124;
    --button-bg: #1a73e8;
    --button-bg-hover: #1765cc;
    --header-color: #202124;
    --message-bot-color: #202124;
    --settings-color-proxy-lite: #64B5F6;   
    --settings-color-proxy-standard: #1976D2;  
    --settings-color-direct-lite: #FFA726;    
    --settings-color-direct-standard: #D32F2F; 
    --settings-color-claude: #66BB6A; 
}
body.dark-theme {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --light-text: #888;
    --border-color: #333;
    --accent-color: #5a7fee;
    --button-color: #e0e0e0;
    --input-bg: #333;
    --btn-color-type: #5a7fee;
    --btn-color-display: #ffa94d;
    --btn-color-appearance: #48cae4;
    --btn-color-send: #587de0;
    --option-hover: #2a2a2a;
    --option-selected: #3a3a3a;
    --option-selected-border: #5a7fee;
    --modal-bg: #1e1e1e;
    --modal-border: #333;
    --modal-shadow: rgba(0, 0, 0, 0.5);
    --modal-textarea-bg: #333;
    --modal-textarea-border: #444;
    --modal-textarea-color: #e0e0e0;
    --button-bg: #5a7fee;
    --button-bg-hover: #7b9aff;
    --header-color: #e0e0e0;
    --message-bot-color: #e0e0e0;
    --settings-color-proxy-lite: #81D4FA;  
    --settings-color-proxy-standard: #42A5F5;  
    --settings-color-direct-lite: #FFB74D;   
    --settings-color-direct-standard: #E53935;
    --settings-color-claude: #81C784;    
}
body, html { height: 100%; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
.app-container { display: flex; flex-direction: column; height: 100dvh; width: 100vw; }
#chartContainer { flex: 1; background-color: var(--card-bg); padding: 15px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.chart-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; flex-shrink: 0; }
.chart-title { font-size: 18px; font-weight: 500; color: var(--text-color); margin: 0; }
.chart-actions { display: flex; gap: 5px; align-items: center; }
.chart-action-btn { border: none; background: none; color: var(--light-text); cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
.chart-action-btn:hover { background-color: var(--option-hover); color: var(--accent-color); }
.chart-wrapper { flex: 1; position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
#chart-placeholder { text-align: center; color: var(--light-text); display: none; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
#chart-placeholder i { font-size: 48px; margin-bottom: 15px; }
#chart-placeholder p { font-size: 16px; margin: 0; }
.control-panel { height: var(--control-panel-height); flex-shrink: 0; background-color: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; gap: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
.control-panel .btn { padding: 0; width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; color: white; font-size: 16px; transition: var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.control-panel .btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
.control-panel .btn:active { transform: translateY(0) scale(1); }
.btn.btn-type { background: var(--btn-color-type); }
.btn.btn-display { background: var(--btn-color-display); }
.btn.btn-appearance { background: var(--btn-color-appearance); }
#sendAiRequestBtn { background: var(--btn-color-send); }
#aiQueryInput { flex-grow: 1; height: 42px; padding: 0 15px; border: 1px solid var(--border-color); border-radius: 21px; font-family: 'Roboto', sans-serif; font-size: 15px; resize: none; background-color: var(--input-bg); transition: var(--transition); line-height: 42px; color: var(--text-color); }
#aiQueryInput:focus { outline: none; border-color: var(--accent-color); background-color: var(--card-bg); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 10%, transparent); }
#aiQueryInput:disabled { cursor: not-allowed; background-color: color-mix(in srgb, var(--bg-color) 80%, var(--light-text) 20%); opacity: 0.7; }
#sendAiRequestBtn:disabled { cursor: not-allowed; background-color: var(--light-text); opacity: 0.7; }
.lds-ring { display: inline-block; position: relative; width: 80px; height: 80px; margin-bottom: 15px; }
.lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 8px solid var(--accent-color); border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: var(--accent-color) transparent transparent transparent; }
.lds-ring div:nth-child(1) { animation-delay: -0.45s; }
.lds-ring div:nth-child(2) { animation-delay: -0.3s; }
.lds-ring div:nth-child(3) { animation-delay: -0.15s; }
@keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.popup-menu { position: absolute; bottom: calc(var(--control-panel-height) + 10px); background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1000; padding: 15px; width: 280px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s; display: none; }
.popup-menu.show { display: block; opacity: 1; visibility: visible; transform: translateY(0); }
.popup-menu h4 { margin: 0 0 15px 0; font-weight: 500; font-size: 16px; color: var(--text-color); }
#chartTypePopup { left: 15px; }
#displayOptionsPopup { left: 75px; }
#appearancePopup { left: 135px; }
#dataTablePopup { top: 70px; right: 15px; width: auto; max-width: 90vw; max-height: 70dvh; overflow: auto; }
.select-wrapper { position: relative; margin-bottom: 10px; }
.select-wrapper:after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--accent-color); position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; }
select { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; appearance: none; background-color: var(--card-bg); color: var(--text-color); font-size: 14px; cursor: pointer; }
.option-group, .appearance-settings, .slider-control { margin-bottom: 10px; }
.option-title { font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--light-text); }
.switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 4px 0; }
.switch { position: relative; display: inline-block; width: 45px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
.dark-theme .slider { background-color: #444; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(23px); }
.range-slider { width: 100%; -webkit-appearance: none; height: 5px; background: var(--border-color); border-radius: 3px; outline: none; }
.range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; }
.color-picker { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.color-option { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
.color-option.active, .color-option:hover { transform: scale(1.2); border-color: white; box-shadow: 0 0 0 2px var(--accent-color); }
.btn-outline { background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 12px; font-size: 13px; border-radius: 8px; cursor: pointer; transition: var(--transition); }
.btn-outline:hover { background-color: var(--accent-color); color: white; }
.data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.data-table th, .data-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
.data-table th { font-weight: 500; background-color: var(--bg-color); }
.dark-theme #aiCommentOverlay { background: linear-gradient(135deg, rgba(40, 40, 40, 0.9), rgba(30, 30, 30, 0.95)); border-color: #444; }
.dark-theme #aiCommentToggleBtn { background-color: #2a2a2a; border-color: #444; }
#aiCommentOverlay { position: absolute; bottom: 15px; left: 15px; right: 15px; max-width: 500px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.95)); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(0,0,0,0.1); padding: 0; border-radius: var(--border-radius); z-index: 5; max-height: 40%; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transform: translateY(20px); cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
.ai-comment-header { display: flex; align-items: center; padding: 10px 15px; font-weight: 500; }
.ai-comment-header i { margin-right: 10px; color: var(--accent-color); }
.ai-comment-body { padding: 0px 15px 15px 15px; font-size: 14px; line-height: 1.6; max-height: 25dvh; overflow-y: auto; }
#aiCommentOverlay.show { opacity: 1; visibility: visible; transform: translateY(0); }
#aiCommentToggleBtn { position: absolute; bottom: 15px; left: 15px; z-index: 6; padding: 8px 15px; background-color: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); cursor: pointer; font-size: 14px; font-weight: 500; border: 1px solid rgba(0,0,0,0.1); display: none; transition: var(--transition); }
#aiCommentToggleBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
#aiCommentToggleBtn i { margin-right: 8px; color: var(--accent-color); }
.notification-bar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white; font-size: 14px; z-index: 10000; transition: bottom 0.5s ease-in-out; display: flex; align-items: center; }
.notification-bar.show { bottom: 20px; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1001; }
.modal-content { background-color: var(--modal-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px var(--modal-shadow); width: 90%; max-width: 450px; height: auto; display: flex; flex-direction: column; border: 1px solid var(--modal-border); }
#api-key-modal-overlay .modal-content { text-align: center; max-width: 450px; }
#api-key-modal-title { margin-top: 0; margin-bottom: 10px; color: var(--header-color); font-size: 1.2em; }
#api-key-modal-text, #api-key-modal-overlay .modal-content p { margin-bottom: 15px; font-size: 0.9em; line-height: 1.5; color: var(--message-bot-color); }
#api-key-modal-overlay .modal-content a { color: var(--accent-color); font-weight: 500; }
#api-key-input { width: 100%; padding: 10px; margin-top: 10px; margin-bottom: 15px; border: 1px solid var(--modal-textarea-border); border-radius: 6px; background-color: var(--modal-textarea-bg); color: var(--modal-textarea-color); font-family: 'Consolas', 'Monaco', 'Courier New', monospace; box-sizing: border-box; }
#api-key-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
#save-api-key-btn { padding: 10px 20px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; font-size: 14px; align-self: center; width: 50%; }
#save-api-key-btn:hover { background-color: var(--button-bg-hover); }

.theme-toggle { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: background-color 0.2s ease; }
.theme-toggle:hover { background-color: var(--option-hover); }
.theme-toggle svg { width: 20px; height: 20px; fill: var(--accent-color); transition: transform 0.3s ease; }
:root .theme-toggle svg.sun-icon { display: block; } :root .theme-toggle svg.moon-icon { display: none; } body.dark-theme .theme-toggle svg.sun-icon { display: none; } body.dark-theme .theme-toggle svg.moon-icon { display: block; }

#model-selector-container, #api-mode-selector-container { position: relative; width: 100%; }
#model-selector-button, #api-mode-selector-button { width: 100%; padding: 8px 12px 8px 16px; border: 1px solid var(--border-color); border-radius: 24px; background: var(--card-bg); cursor: pointer; transition: all 0.2s ease; font-size: 13px; color: var(--text-color); display: flex; align-items: center; gap: 8px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; justify-content: space-between; box-sizing: border-box; }
#model-selector-button:hover, #api-mode-selector-button:hover { background: var(--option-hover); }
#model-selector-button::after, #api-mode-selector-button::after { content: ''; width: 6px; height: 6px; border-right: 1.5px solid var(--text-color); border-bottom: 1.5px solid var(--text-color); transform: rotate(45deg); flex-shrink: 0; margin-left: 5px; }
#api-mode-selector-button .icon { width: 16px; height: 16px; fill: var(--accent-color); flex-shrink: 0; }
#api-mode-selector-button .text { flex-grow: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; }

#model-options, #api-mode-options { position: absolute; bottom: 100%; margin-bottom: 5px; right: 0; background: var(--modal-bg); border-radius: 8px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); padding: 8px 0; list-style: none; opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s; z-index: 1002; border: 1px solid var(--border-color); width: 100%; max-height: 400px; overflow-y: auto; }
#model-options.show, #api-mode-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
.model-option, .api-mode-option { padding: 10px 16px; cursor: pointer; font-size: 13px; transition: background-color 0.2s ease; color: var(--text-color); white-space: normal; word-break: break-word; display: flex; align-items: center; gap: 10px;}
.model-option:hover, .api-mode-option:hover { background-color: var(--option-hover); }
.model-option.selected, .api-mode-option.selected { background-color: var(--option-selected); border-left: 3px solid var(--option-selected-border); font-weight: 500; padding-left: 13px; }
.api-mode-option .icon { width: 16px; height: 16px; fill: var(--accent-color); flex-shrink: 0; }

#change-key-btn { padding: 8px 12px; border-radius: 24px; border: 1px solid var(--border-color); background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; color: var(--text-color); width: 100%; gap: 8px; font-size: 13px; }
#change-key-btn:hover { background-color: var(--option-hover); }
#change-key-btn.hidden { display: none; }
#settings-btn-mobile { display: flex; width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; align-items: center; justify-content: center; transition: background-color 0.2s ease, color 0.3s ease; color: var(--accent-color); }
#settings-btn-mobile:hover { background-color: var(--option-hover); }
#settings-modal-overlay .modal-content { max-width: 320px; max-height: 80vh; gap: 20px; padding: 20px; }
#settings-modal-title { margin: 0; color: var(--header-color); font-size: 1.2em; text-align: center; }
#settings-modal-controls-container { display: flex; flex-direction: column; gap: 16px; align-items: center; width: 100%; }
#close-settings-modal-btn { padding: 10px 20px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; align-self: center; width: 60%; font-size: 14px; }
#close-settings-modal-btn:hover { background-color: var(--button-bg-hover); }
.header-controls { display: none !important; }

@media (max-width: 768px) { .control-panel { padding: 0 10px; gap: 8px; height: 60px; } .control-panel .btn { width: 40px; height: 40px; font-size: 14px; } #aiQueryInput { height: 40px; font-size: 14px; } .popup-menu { width: calc(100vw - 30px); left: 15px !important; } :root { --control-panel-height: 60px; } }
</style>
</head>
<body>
    <div class="app-container">
        <div id="chartContainer">
            <div class="chart-header">
                <h2 class="chart-title" id="chartTitle">Визуализация данных</h2>
                <div class="chart-actions">
                    <button class="chart-action-btn" id="table-view-btn" title="Таблица данных"><i class="fas fa-table"></i></button>
                    <button class="chart-action-btn" onclick="toggleFullscreen()" title="Полный экран"><i class="fas fa-expand"></i></button>
                    <button class="chart-action-btn" onclick="saveAsPNG()" title="Сохранить как PNG"><i class="fas fa-file-image"></i></button>
                    <button id="settings-btn-mobile" title="Настройки">
                        <svg class="settings-icon-cog" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                        <svg class="settings-icon-key" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor" style="display: none;"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    </button>
                    <!-- Контейнер для настроек, изначально скрыт. JS перемещает его содержимое в модальное окно -->
                    <div class="header-controls">
                        <div id="model-selector-container">
                            <button id="model-selector-button">Loading Model...</button>
                            <ul id="model-options"></ul>
                        </div>
                        <div id="api-mode-selector-container">
                            <button id="api-mode-selector-button"></button>
                            <ul id="api-mode-options"></ul>
                        </div>
                        <button id="change-key-btn" title="Изменить API ключ Gemini">
                            <i class="fas fa-key" style="margin-right: 5px;"></i> <span>Изменить ключ</span>
                        </button>
                        <button class="theme-toggle chart-action-btn" title="Переключить тему">
                             <svg class="sun-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm-9 4c0-.55-.45-1-1-1s-1 .45-1 1 .45 1 1 1 1-.45 1-1zm20 0c0-.55-.45-1-1-1s-1 .45-1 1 .45 1 1 1 1-.45 1-1zm-2.99-7c-.38-.44-1.03-.48-1.49-.1l-.05.05c-.42.42-.39 1.12.07 1.49.44.41 1.12.39 1.49-.07.36-.44.32-1.08-.02-1.37zM5.04 6.94c.44-.38.48-1.09-.01-1.47-.44-.38-1.07-.36-1.45.04-.37.47-.33 1.1.07 1.47.4.38 1.05.36 1.39.04zm-.5 11.11c.44.41 1.09.37 1.45-.04.37-.47-.33-1.1-.07-1.47-.44-.38-1.07-.36-1.45.04-.37.47-.33 1.1.07 1.47zm16.91-11.05c-.38-.44-1.03-.48-1.49-.1-.44.41-.45 1.05-.04 1.47.42.42 1.06.4 1.47-.02.42-.42.42-1.1.06-1.35zm-2.9 11.05c.44.41 1.09.37 1.45-.04.37-.47.33-1.1-.07-1.47-.44-.38-1.07-.36-1.45.04-.37.47-.33 1.1.07 1.47zM12 3c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 16c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
                             <svg class="moon-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="myChart"></canvas>
                <div id="chart-placeholder">
                    <i class="fas fa-chart-line"></i>
                    <p>Нет данных для отображения.<br>Отправьте запрос ИИ</p>
                </div>
                <div id="aiCommentOverlay">
                    <div class="ai-comment-header"><i class="fas fa-comment-dots"></i><span>Комментарий</span></div>
                    <div class="ai-comment-body"><p id="aiCommentText"></p></div>
                </div>
                <button id="aiCommentToggleBtn"><i class="fas fa-comment-alt"></i> </button>
            </div>
        </div>
        <div class="control-panel">
            <button class="btn btn-type" id="chart-type-btn" title="Тип диаграммы"><i class="fas fa-chart-pie"></i></button>
            <button class="btn btn-display" id="display-options-btn" title="Отображение"><i class="fas fa-sliders-h"></i></button>
            <button class="btn btn-appearance" id="appearance-btn" title="Внешний вид"><i class="fas fa-palette"></i></button>
            <textarea id="aiQueryInput" placeholder="Нарисуй диаграмму населения городов мира..." rows="1"></textarea>
            <button class="btn" id="sendAiRequestBtn" title="Отправить ИИ"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div id="chartTypePopup" class="popup-menu">
        <h4>Тип диаграммы</h4>
        <div class="select-wrapper">
            <select id="chartType">
                <optgroup label="Основные типы"><option value="pie">Круговая</option><option value="bar">Столбчатая</option><option value="line">Линейный</option><option value="doughnut">Кольцевая</option></optgroup>
                <optgroup label="Дополнительные"><option value="polarArea">Полярная</option><option value="radar">Радар</option><option value="horizontalBar">Горизонтальная</option></optgroup>
            </select>
        </div>
    </div>
    <div id="displayOptionsPopup" class="popup-menu">
        <h4>Отображение данных</h4>
        <div class="option-group">
            <div class="switch-container"><span>Подписи категорий</span><label class="switch"><input type="checkbox" id="showDataSwitch"><span class="slider"></span></label></div>
            <div class="switch-container"><span>Проценты</span><label class="switch"><input type="checkbox" id="showPercentSwitch"><span class="slider"></span></label></div>
            <div class="switch-container"><span>Значения</span><label class="switch"><input type="checkbox" id="showValuesSwitch"><span class="slider"></span></label></div>
            <div class="switch-container"><span>Легенда</span><label class="switch"><input type="checkbox" id="showLegendSwitch"><span class="slider"></span></label></div>
        </div>
    </div>
    <div id="appearancePopup" class="popup-menu">
        <h4>Внешний вид</h4>
        <div class="appearance-settings">
            <div class="slider-control"><label for="borderWidth">Толщина границ: <span id="borderWidthValue">1</span>px</label><input type="range" id="borderWidth" class="range-slider" min="0" max="5" step="0.5" value="1"></div>
            <div class="slider-control"><label for="fontSize">Размер шрифта: <span id="fontSizeValue">12</span>px</label><input type="range" id="fontSize" class="range-slider" min="8" max="20" step="1" value="12"></div>
            <div class="option-title">Цветовая схема:</div>
            <div class="color-picker">
                <div class="color-option active" style="background-color: #4e79a7" data-scheme="default"></div><div class="color-option" style="background-color: #ff6b6b" data-scheme="warm"></div>
                <div class="color-option" style="background-color: #48bfe3" data-scheme="cool"></div><div class="color-option" style="background-color: #06d6a0" data-scheme="pastel"></div>
                <div class="color-option" style="background-color: #118ab2" data-scheme="monochrome"></div>
            </div>
        </div>
    </div>
    <div id="dataTablePopup" class="popup-menu">
        <h4>Таблица данных</h4>
        <div id="dataTableContainer" style="max-height: 40dvh; overflow-y: auto;"><div id="dataTable"></div></div>
        <button class="btn-outline" style="margin-top: 15px; width:100%;" onclick="addTableRow()"><i class="fas fa-plus"></i> Добавить строку</button>
    </div>
    
    <div class="modal-overlay" id="api-key-modal-overlay">
        <div class="modal-content">
            <h2 id="api-key-modal-title">API ключ для Gemini</h2>
            <p id="api-key-modal-text">Для использования прямого режима вставьте ваш API-ключ Google Gemini. Он будет сохранен локально в вашем браузере.</p>
            <p><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Получить ключ в Google AI Studio</a></p>
            <input type="password" id="api-key-input" placeholder="Введите ваш API ключ...">
            <button id="save-api-key-btn">Сохранить</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal-overlay">
        <div class="modal-content" id="settings-modal-main-content">
            <h2 id="settings-modal-title">Настройки ИИ</h2>
            <div id="settings-modal-controls-container">
                <!-- Этот блок будет заполняться с помощью JavaScript -->
            </div>
            <button id="close-settings-modal-btn">Закрыть</button>
        </div>
    </div>
    
    <div id="notification-placeholder"></div>
    <textarea id="dataInput" style="display:none;"></textarea>

    <script>
        Chart.register(ChartDataLabels);

        // --- Configuration ---
        const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
        const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru"; // Your site proxy

        const MODELS = [
            { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini", tier: 'standard' },
            { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
            { id: "claude-sonnet-4-20250514", uiName: "Claude 4 Sonnet", apiType: "anthropic", tier: 'standard' },
        ];

        const API_MODES = {
            'mapruapp': {
                uiName: 'Прокси (mapruapp)',
                geminiUrl: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`,
                claudeUrl: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`,
                icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.6,15.2c-1-1.4-2.5-2.5-4.2-2.9c-0.3-0.1-0.6-0.1-0.8-0.1s-0.5,0-0.8,0.1c-1.7,0.5-3.2,1.5-4.2,2.9 c-1.2,1.6-1.8,3.5-1.8,5.5c0,0.4,0.3,0.8,0.8,0.8h11.2c0.4,0,0.8-0.3,0.8-0.8C19.5,18.7,18.8,16.8,17.6,15.2z M6.9,4.4 C8.1,3.2,9.9,2.5,12,2.5s3.9,0.7,5.1,1.9c1.2,1.2,1.9,2.9,1.9,4.7c0,1.8-0.7,3.6-1.9,4.7c-0.2,0.2-0.5,0.3-0.8,0.3s-0.6-0.1-0.8-0.3 c-0.4-0.4-0.4-1.1,0-1.5c0.8-0.8,1.2-1.8,1.2-2.9c0-1.1-0.4-2.2-1.2-2.9C15.8,5,15,5,14.1,5.4c-0.4,0.2-1,0.1-1.3-0.3 c-0.3-0.4-0.1-1,0.3-1.3C13.5,3.5,12.8,3.3,12,3.3s-1.5,0.2-2.1,0.5c0.4,0.3,0.5,0.9,0.3,1.3C10,5.4,9.4,5.6,9,5.4 C8,5,7.2,5,6.3,5.4C5.5,6.2,5.1,7.2,5.1,8.3c0,1.1,0.4,2.2,1.2,2.9c0.4,0.4,0.4,1.1,0,1.5c-0.4,0.4-1.1,0.4-1.5,0 c-1.2-1.2-1.9-2.9-1.9-4.7C3.1,7.3,3.8,5.6,4.9,4.4H6.9z" fill="var(--accent-color)"/></svg>'
            },
            'vercel': {
                uiName: 'Прокси (vercel)',
                geminiUrl: (modelId) => `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`,
                claudeUrl: () => `${VERCEL_PROXY_BASE_URL}/proxy/langdock/anthropic/eu/v1/messages`,
                icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2L2,7l10,5l10-5L12,2z M12,12.3L4.9,9.1L12,6.3l7.1,2.8L12,12.3z M2,17l10,5l10-5l-10-5L2,17z M12,17.3l-7.1-3.2L12,11.3l7.1,2.8L12,17.3z" fill="var(--accent-color)"/></svg>'
            },
            'direct': {
                uiName: 'Прямой (gemini)',
                geminiUrl: (modelId, key) => `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`,
                claudeUrl: () => null,
                icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" fill="var(--accent-color)"/></svg>'
            }
        };

        const GEMINI_API_KEY_STORAGE = 'gemini_api_key_chart';
        const API_MODE_STORAGE = 'chart_api_mode_v2';
        const MODELS_STORAGE = 'selectedModelId_chart_v2';
        
        let defaultModelId = 'gemini-2.5-flash-lite';
        if (!MODELS.find(m => m.id === defaultModelId)) {
            defaultModelId = MODELS[0]?.id || '';
        }
        let currentSelectedModelId = localStorage.getItem(MODELS_STORAGE) || defaultModelId;
        if (!MODELS.find(m => m.id === currentSelectedModelId)) {
            currentSelectedModelId = defaultModelId;
        }

        let apiKey = null;
        let currentApiMode = 'mapruapp';
        
        let chartData = { labels: [], values: [] };
        let currentAiRequestController = null;
        const displayOptionIDs = ['showDataSwitch', 'showPercentSwitch', 'showValuesSwitch', 'showLegendSwitch'];
        const colorSchemes = { default: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'], warm: ['#ff6b6b', '#f9844a', '#fee440', '#f9c74f', '#90be6d', '#43aa8b', '#577590', '#277da1', '#f94144', '#f3722c'], cool: ['#48bfe3', '#56cfe1', '#64dfdf', '#72efdd', '#80ffdb', '#a5a58d', '#b7b7a4', '#6b705c', '#023e8a', '#0077b6'], pastel: ['#ffd6ff', '#e7c6ff', '#c8b6ff', '#b8c0ff', '#bbd0ff', '#06d6a0', '#1b9aaa', '#ef476f', '#ffc43d', '#f15bb5'], monochrome: ['#118ab2', '#0096c7', '#00b4d8', '#48cae4', '#90e0ef', '#ade8f4', '#caf0f8', '#03045e', '#023e8a', '#0077b6'] };
        let currentColorScheme = 'default';

        window.onload = function() {
            initializeApp();
        };

        function initializeApp() {
            setupEventListeners();
            loadSettings();
            
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            document.body.classList.toggle('dark-theme', storedTheme ? storedTheme === 'dark' : prefersDark);

            loadApiKey();
            loadApiMode();
            
            populateModelOptions();
            populateApiModeOptions();

            updateApiModeUI();
            updateModelSelectorUI();
            
            updateApiControlsAvailability();
            updateSettingsButtonColor();
            
            processData();
        }

        function setupEventListeners() {
            document.getElementById('sendAiRequestBtn').addEventListener('click', handleAiRequest);
            document.getElementById('aiQueryInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAiRequest(); }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (currentAiRequestController) currentAiRequestController.abort();
                    closeAllPopups();
                    hideAllModals();
                }
            });

            const popupButtons = { 'chart-type-btn': 'chartTypePopup', 'display-options-btn': 'displayOptionsPopup', 'appearance-btn': 'appearancePopup', 'table-view-btn': 'dataTablePopup' };
            Object.keys(popupButtons).forEach(btnId => {
                document.getElementById(btnId).addEventListener('click', (e) => {
                    e.stopPropagation();
                    const popupId = popupButtons[btnId];
                    if (popupId === 'dataTablePopup') renderDataTable();
                    togglePopup(popupId);
                });
            });

            document.addEventListener('click', (e) => {
                const isPopup = e.target.closest('.popup-menu');
                const isModelOptions = e.target.closest('#model-options') || e.target.closest('#model-selector-button');
                const isApiModeOptions = e.target.closest('#api-mode-options') || e.target.closest('#api-mode-selector-button');
                
                if (!isPopup) closeAllPopups();
                
                if (!isModelOptions) document.getElementById('model-options').classList.remove('show');
                if (!isApiModeOptions) document.getElementById('api-mode-options').classList.remove('show');
            });

            document.getElementById('chartType').addEventListener('change', () => saveAndRedraw('chartType', document.getElementById('chartType').value));
            displayOptionIDs.forEach(id => document.getElementById(id).addEventListener('change', (e) => saveAndRedraw(id, e.target.checked)));
            document.getElementById('borderWidth').addEventListener('input', (e) => { document.getElementById('borderWidthValue').textContent = e.target.value; drawChart(); });
            document.getElementById('fontSize').addEventListener('input', (e) => { document.getElementById('fontSizeValue').textContent = e.target.value; drawChart(); });
            document.querySelectorAll('.color-option').forEach(el => el.addEventListener('click', () => setColorScheme(el, el.dataset.scheme)));
            document.getElementById('aiCommentOverlay').addEventListener('click', toggleAiComment);
            document.getElementById('aiCommentToggleBtn').addEventListener('click', toggleAiComment);

            const settingsBtnMobile = document.getElementById('settings-btn-mobile');
            const settingsModalOverlay = document.getElementById('settings-modal-overlay');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            
            settingsBtnMobile.addEventListener('click', openSettingsModal);
            closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            settingsModalOverlay.addEventListener('click', (e) => { if (e.target === settingsModalOverlay) closeSettingsModal(); });

            const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            
            const changeKeyBtn = document.getElementById('change-key-btn');
            const modelSelectorButton = document.getElementById('model-selector-button');
            const apiModeSelectorButton = document.getElementById('api-mode-selector-button');

            changeKeyBtn.addEventListener('click', showApiKeyModal);
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            apiKeyModalOverlay.addEventListener('click', (e) => { if (e.target === apiKeyModalOverlay) hideApiKeyModal(); });
            apiKeyInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); saveApiKey(); } });
            
            modelSelectorButton.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('model-options').classList.toggle('show');
            });
            apiModeSelectorButton.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('api-mode-options').classList.toggle('show');
            });
        }
        
        function handleThemeToggle() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            drawChart();
        }
        
        function openSettingsModal() {
            const headerControls = document.querySelector('.header-controls');
            const settingsModalControlsContainer = document.getElementById('settings-modal-controls-container');
            const controls = Array.from(headerControls.children);
            controls.forEach(control => settingsModalControlsContainer.appendChild(control));
            document.getElementById('settings-modal-overlay').style.display = 'flex';
        }

        function closeSettingsModal() {
            const headerControls = document.querySelector('.header-controls');
            const settingsModalControlsContainer = document.getElementById('settings-modal-controls-container');
            const controls = Array.from(settingsModalControlsContainer.children);
            controls.forEach(control => headerControls.appendChild(control));
            
            document.getElementById('settings-modal-overlay').style.display = 'none';
            document.getElementById('model-options').classList.remove('show');
            document.getElementById('api-mode-options').classList.remove('show');
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }
        function showApiKeyModal() { hideAllModals(); document.getElementById('api-key-modal-overlay').style.display = 'flex'; document.getElementById('api-key-input').focus(); }
        function hideApiKeyModal() { document.getElementById('api-key-modal-overlay').style.display = 'none'; }
        function saveApiKey() { const key = document.getElementById('api-key-input').value.trim(); if (key) { apiKey = key; localStorage.setItem(GEMINI_API_KEY_STORAGE, key); showNotification('API ключ сохранен.', 'success'); hideApiKeyModal(); } else { showNotification('Поле ключа не может быть пустым.', 'error'); } }
        function loadApiKey() { const savedKey = localStorage.getItem(GEMINI_API_KEY_STORAGE); if (savedKey) { apiKey = savedKey; document.getElementById('api-key-input').value = savedKey; } }
        
        function loadApiMode() {
            const savedMode = localStorage.getItem(API_MODE_STORAGE);
            currentApiMode = API_MODES[savedMode] ? savedMode : 'mapruapp';
        }
        
        function updateApiModeUI() {
            const mode = API_MODES[currentApiMode];
            if (!mode) return;

            const button = document.getElementById('api-mode-selector-button');
            button.innerHTML = `${mode.icon}<span class="text">${mode.uiName}</span>`;
            
            const changeKeyBtn = document.getElementById('change-key-btn');
            const isDirect = currentApiMode === 'direct';
            if(changeKeyBtn) changeKeyBtn.classList.toggle('hidden', !isDirect);

            const settingsIconCog = document.querySelector('#settings-btn-mobile .settings-icon-cog');
            const settingsIconKey = document.querySelector('#settings-btn-mobile .settings-icon-key');
            if (settingsIconCog && settingsIconKey) {
                settingsIconCog.style.display = isDirect ? 'none' : 'block';
                settingsIconKey.style.display = isDirect ? 'block' : 'none';
            }

            document.querySelectorAll('.api-mode-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.apiMode === currentApiMode);
            });
        }

        function populateModelOptions() {
            const modelOptionsList = document.getElementById('model-options');
            modelOptionsList.innerHTML = '';
            MODELS.forEach(model => {
                const option = document.createElement('li');
                option.className = 'model-option';
                option.dataset.modelId = model.id;
                option.dataset.apiType = model.apiType;
                option.textContent = model.uiName;
                option.addEventListener('click', handleModelSelection);
                modelOptionsList.appendChild(option);
            });
            highlightSelectedModel();
        }

        function populateApiModeOptions() {
            const apiModeOptionsList = document.getElementById('api-mode-options');
            apiModeOptionsList.innerHTML = '';
            for (const modeId in API_MODES) {
                const mode = API_MODES[modeId];
                const option = document.createElement('li');
                option.className = 'api-mode-option';
                option.dataset.apiMode = modeId;
                option.innerHTML = `${mode.icon} <span>${mode.uiName}</span>`;
                option.addEventListener('click', handleApiModeSelection);
                apiModeOptionsList.appendChild(option);
            }
        }
        
        function handleApiModeSelection(event) {
            const selectedOption = event.currentTarget;
            currentApiMode = selectedOption.dataset.apiMode;
            localStorage.setItem(API_MODE_STORAGE, currentApiMode);
            updateApiModeUI();
            updateSettingsButtonColor();
            document.getElementById('api-mode-options').classList.remove('show');
            if (currentApiMode === 'direct' && !apiKey) {
                showApiKeyModal();
            }
        }

        function handleModelSelection(event) {
            const selectedOption = event.currentTarget;
            currentSelectedModelId = selectedOption.dataset.modelId;
            localStorage.setItem(MODELS_STORAGE, currentSelectedModelId);
            updateModelSelectorUI();
            document.getElementById('model-options').classList.remove('show');
            
            updateApiControlsAvailability();
            updateSettingsButtonColor();
        }

        function updateModelSelectorUI() {
            const modelSelectorButton = document.getElementById('model-selector-button');
            const selectedModelInfo = MODELS.find(m => m.id === currentSelectedModelId);
            if (modelSelectorButton) {
                modelSelectorButton.textContent = selectedModelInfo ? selectedModelInfo.uiName : 'Выберите модель';
            }
            highlightSelectedModel();
        }

        function highlightSelectedModel() {
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.modelId === currentSelectedModelId);
            });
        }
        
        function updateSettingsButtonColor() {
            const settingsBtn = document.getElementById('settings-btn-mobile');
            if (!settingsBtn) return;
            const selectedModel = MODELS.find(m => m.id === currentSelectedModelId);
            const modelTier = selectedModel?.tier || 'lite';
            let colorVar;
            if (selectedModel?.apiType === 'anthropic') {
                colorVar = '--settings-color-claude';
            } else if (currentApiMode === 'direct') {
                colorVar = modelTier === 'standard' ? '--settings-color-direct-standard' : '--settings-color-direct-lite';
            } else { // All proxy modes
                colorVar = modelTier === 'standard' ? '--settings-color-proxy-standard' : '--settings-color-proxy-lite';
            }
            settingsBtn.style.color = `var(${colorVar})`;
        }

        function updateApiControlsAvailability() {
            const selectedModel = MODELS.find(m => m.id === currentSelectedModelId);
            const isGeminiModel = selectedModel?.apiType === 'gemini';
            
            const apiModeSelectorButton = document.getElementById('api-mode-selector-button');
            apiModeSelectorButton.disabled = false;
            
            document.querySelectorAll('.api-mode-option').forEach(option => {
                if (option.dataset.apiMode === 'direct') {
                    option.style.display = isGeminiModel ? 'flex' : 'none';
                }
            });

            if (!isGeminiModel && currentApiMode === 'direct') {
                currentApiMode = 'mapruapp'; // Fallback to a safe default
                localStorage.setItem(API_MODE_STORAGE, currentApiMode);
                updateApiModeUI();
                showNotification("Режим 'Прямой' недоступен для Claude. Выбран 'Прокси (MapRuApp)'.", 'info', 4000);
            }
        }
        
        function saveAndRedraw(key, value) { localStorage.setItem(key, value); drawChart(); }
        
        function loadSettings() {
            const savedType = localStorage.getItem('chartType');
            if (savedType) document.getElementById('chartType').value = savedType;
            displayOptionIDs.forEach(id => {
                const savedState = localStorage.getItem(id);
                const defaultChecked = ['showDataSwitch', 'showPercentSwitch', 'showLegendSwitch'].includes(id);
                document.getElementById(id).checked = (savedState === null) ? defaultChecked : (savedState === 'true');
            });
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) themeToggle.addEventListener('click', handleThemeToggle);
        }
        
        function togglePopup(popupId) { const targetPopup = document.getElementById(popupId); const isShowing = targetPopup.classList.contains('show'); closeAllPopups(); if (!isShowing) targetPopup.classList.add('show'); }
        function closeAllPopups() { document.querySelectorAll('.popup-menu.show').forEach(p => p.classList.remove('show')); }
        function processData() {
            const dataInput = document.getElementById('dataInput').value;
            chartData.labels = [];
            chartData.values = [];
            dataInput.split('\n').filter(line => line.trim() !== '').forEach(line => {
                const parts = line.trim().split(/[\t\s]+/);
                const label = parts.slice(0, -1).join(' ');
                const value = parseFloat(parts[parts.length - 1].replace(',', '.'));
                if (label && !isNaN(value)) {
                    chartData.labels.push(label);
                    chartData.values.push(value);
                }
            });
            drawChart();
        }
        function updateChartTitle() { const sel = document.getElementById('chartType'); document.getElementById('chartTitle').textContent = sel.options[sel.selectedIndex].text + " диаграмма"; }
        function drawChart() {
            const chartCanvas = document.getElementById('myChart');
            const placeholder = document.getElementById('chart-placeholder');
            if (!chartCanvas) return;
            if (window.myChart instanceof Chart) { window.myChart.destroy(); window.myChart = null; }
            if (chartData.values.length === 0) {
                placeholder.innerHTML = `<i class="fas fa-chart-line"></i><p>Нет данных для отображения<br>Отправьте запрос к ИИ</p>`;
                placeholder.style.display = 'block';
                chartCanvas.style.display = 'none';
                return;
            }
            placeholder.style.display = 'none';
            chartCanvas.style.display = 'block';
            const chartType = document.getElementById('chartType').value;
            window.myChart = new Chart(chartCanvas.getContext('2d'), {
                type: chartType === 'horizontalBar' ? 'bar' : chartType,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Значения',
                        data: chartData.values,
                        backgroundColor: colorSchemes[currentColorScheme].map(c => chartType === 'line' ? c + '20' : c),
                        borderColor: chartType === 'line' ? colorSchemes[currentColorScheme][0] : (document.body.classList.contains('dark-theme') ? '#1e1e1e' : 'white'),
                        borderWidth: parseFloat(document.getElementById('borderWidth').value),
                        tension: 0.4,
                        fill: chartType === 'line',
                    }]
                },
                options: getChartOptions()
            });
        }
        function getChartOptions() {
            const chartType = document.getElementById('chartType').value;
            const isDarkTheme = document.body.classList.contains('dark-theme');
            const fontSize = parseFloat(document.getElementById('fontSize').value);
            const total = chartData.values.reduce((a, b) => a + b, 0);
            return {
                indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                layout: { padding: { left: 20 } },
                scales: (['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType)) ? {} : {
                    y: { beginAtZero: true, ticks: { font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' }, grid: { color: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } },
                    x: { ticks: { font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' }, grid: { color: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } }
                },
                plugins: {
                    legend: { display: document.getElementById('showLegendSwitch').checked, position: 'bottom', labels: { usePointStyle: true, font: { size: fontSize }, color: isDarkTheme ? '#e0e0e0' : '#333' } },
                    datalabels: {
                        display: document.getElementById('showDataSwitch').checked || document.getElementById('showPercentSwitch').checked || document.getElementById('showValuesSwitch').checked,
                        color: isDarkTheme ? '#fff' : '#000',
                        font: { weight: 'bold', size: fontSize },
                        formatter: (value, ctx) => { let res = []; if(document.getElementById('showDataSwitch').checked) res.push(ctx.chart.data.labels[ctx.dataIndex]); if(document.getElementById('showPercentSwitch').checked) res.push(total > 0 ? ((value / total) * 100).toFixed(1) + '%' : "0%"); if(document.getElementById('showValuesSwitch').checked) res.push(value.toLocaleString()); return res.join('\n'); },
                        anchor: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'end',
                        align: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'start',
                        offset: 6,
                        textStrokeColor: isDarkTheme ? '#1e1e1e' : '#fff',
                        textStrokeWidth: 4
                    }
                }
            };
        }

        async function handleAiRequest() {
            closeAllPopups();
            const query = document.getElementById('aiQueryInput').value.trim();
            if (!query) { showNotification("Введите запрос для ИИ", "warning"); return; }
            
            const selectedModel = MODELS.find(m => m.id === currentSelectedModelId);
            if (!selectedModel) { showNotification("Модель ИИ не выбрана.", "error"); return; }
            
            if (selectedModel.apiType === 'gemini' && currentApiMode === 'direct' && !apiKey) { 
                showNotification("Пожалуйста, введите API ключ для Gemini.", "error"); 
                showApiKeyModal(); 
                return; 
            }

            const aiInput = document.getElementById('aiQueryInput');
            const sendBtn = document.getElementById('sendAiRequestBtn');
            aiInput.disabled = true;
            sendBtn.disabled = true;

            showLoading("ИИ обрабатывает ваш запрос...");
            displayAiComment("");
            const system_prompt = `Ты — API-сервис для генерации данных. На запрос верни JSON-объект с четырьмя ключами: "title" (короткая строка на русском - заголовок для диаграммы), "data" (массив объектов с ключами "label" (string) и "value" (number)), "comment" (строка на русском с контекстом/источником данных), и "chartType" (один из: 'bar', 'line', 'pie', 'doughnut', 'polarArea', 'radar', 'horizontalBar'). Выбери наиболее подходящий тип для сгенерированных данных. Если данных нет, "data" - пустой массив. Всегда возвращай JSON. Запрос: `;

            currentAiRequestController = new AbortController();
            
            try {
                let apiUrl;
                let requestBody;
                let fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: currentAiRequestController.signal
                };
                
                const apiModeConfig = API_MODES[currentApiMode];
                
                if (currentApiMode === 'mapruapp') {
                    apiUrl = apiModeConfig.geminiUrl();
                    requestBody = {
                        model: selectedModel.id,
                        messages: [
                            { role: "system", content: "Ты — API-сервис для генерации данных. Всегда возвращай только JSON." },
                            { role: "user", content: system_prompt + query }
                        ],
                        max_tokens: 4096,
                    };
                } else { 
                    if (selectedModel.apiType === 'gemini') {
                        apiUrl = apiModeConfig.geminiUrl(selectedModel.id, apiKey);
                        requestBody = { contents: [{ parts: [{ "text": system_prompt + query }] }] };
                    } else if (selectedModel.apiType === 'anthropic') {
                        apiUrl = apiModeConfig.claudeUrl();
                        if (!apiUrl) throw new Error(`Режим '${apiModeConfig.uiName}' не поддерживает Claude.`);
                        requestBody = {
                            model: selectedModel.id,
                            messages: [{ "role": "user", "content": system_prompt + query }],
                            max_tokens: 4096,
                            system: "Ты — API-сервис для генерации данных. Всегда возвращай только JSON."
                        };
                    }
                }
                
                fetchOptions.body = JSON.stringify(requestBody);
                const response = await fetch(apiUrl, fetchOptions);

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorDetail = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorDetail = errorJson?.error?.message || errorText;
                        if (response.status === 400 && errorDetail.includes("API_KEY_INVALID")) {
                           errorDetail = "API ключ недействителен. Проверьте ключ.";
                           showApiKeyModal();
                        }
                    } catch (e) { errorDetail = `HTTP ${response.status}: ${errorText.substring(0, 100)}`; }
                    throw new Error(errorDetail);
                }
                
                const data = await response.json();
                let textResponse;
                
                if (currentApiMode === 'mapruapp') {
                    textResponse = data.choices?.[0]?.message?.content;
                } else {
                    if (selectedModel.apiType === 'gemini') {
                        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                            const reason = data.promptFeedback?.blockReason || 'Неизвестная причина (ответ пуст)';
                            throw new Error(`Запрос заблокирован. Причина: ${reason}`);
                        }
                        textResponse = data.candidates[0].content.parts[0].text;
                    } else if (selectedModel.apiType === 'anthropic') {
                        if (!data.content?.[0]?.text) {
                            throw new Error("Claude вернул пустой или некорректный ответ.");
                        }
                        textResponse = data.content.map(block => block.type === "text" ? block.text : "").join("");
                    }
                }

                if (!textResponse) {
                    throw new Error("API вернул пустой текстовый ответ.");
                }

                const aiResponseObject = JSON.parse(textResponse.replace(/^```json\s*|\s*```$/g, ''));
                const chartTypeSelect = document.getElementById('chartType');
                const validChartTypes = Array.from(chartTypeSelect.options).map(opt => opt.value);
                if (aiResponseObject.chartType && validChartTypes.includes(aiResponseObject.chartType)) {
                    chartTypeSelect.value = aiResponseObject.chartType;
                    localStorage.setItem('chartType', aiResponseObject.chartType);
                }

                if (aiResponseObject.data && Array.isArray(aiResponseObject.data) && aiResponseObject.data.length > 0) {
                    chartData.labels = aiResponseObject.data.map(item => String(item.label || ''));
                    chartData.values = aiResponseObject.data.map(item => Number(item.value || 0));
                } else {
                    chartData.labels = [];
                    chartData.values = [];
                }
                updateTextareaFromData();
                processData();

                displayAiComment(aiResponseObject.comment);
                if (aiResponseObject.title && typeof aiResponseObject.title === 'string' && aiResponseObject.title.trim() !== '') {
                    document.getElementById('chartTitle').textContent = aiResponseObject.title;
                } else {
                   updateChartTitle();
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    showNotification('Запрос к ИИ отменен', 'info');
                } else {
                    console.error('Ошибка при запросе к ИИ:', error);
                    showNotification(`Ошибка ИИ: ${error.message || 'Неизвестная ошибка'}`, "error");
                    displayAiComment(`Произошла ошибка: ${error.message}`);
                }
                processData(); 
            } finally {
                aiInput.disabled = false;
                sendBtn.disabled = false;
                currentAiRequestController = null;
            }
        }
        
        function displayAiComment(comment) { const overlay = document.getElementById('aiCommentOverlay'); const button = document.getElementById('aiCommentToggleBtn'); const textElement = document.getElementById('aiCommentText'); if (comment && comment.trim() !== "") { const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; textElement.innerHTML = comment.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`); overlay.classList.add('show'); button.style.display = 'none'; gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.4 }); } else { overlay.classList.remove('show'); button.style.display = 'none'; } }
        function toggleAiComment() { const overlay = document.getElementById('aiCommentOverlay'); const button = document.getElementById('aiCommentToggleBtn'); const isVisible = overlay.classList.contains('show'); if (isVisible) { gsap.to(overlay, { opacity: 0, y: 20, duration: 0.3, onComplete: () => { overlay.classList.remove('show'); button.style.display = 'flex'; gsap.fromTo(button, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3 }); }}); } else { gsap.to(button, { opacity: 0, y: 10, duration: 0.3, onComplete: () => { button.style.display = 'none'; overlay.classList.add('show'); gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 }); }}); } }
        function updateTextareaFromData() { let textData = ''; chartData.labels.forEach((label, index) => { textData += `${label}\t${chartData.values[index]}\n`; }); document.getElementById('dataInput').value = textData.trim(); }
        function setColorScheme(element, scheme) { currentColorScheme = scheme; document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active')); element.classList.add('active'); drawChart(); }
        function saveAsPNG() { const canvas = document.getElementById('myChart'); const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.offsetWidth; tempCanvas.height = canvas.offsetHeight; const tempCtx = tempCanvas.getContext('2d'); tempCtx.fillStyle = document.body.classList.contains('dark-theme') ? '#1e1e1e' : '#ffffff'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); if (chartData.values.length > 0) tempCtx.drawImage(canvas, 0, 0); const dataURL = tempCanvas.toDataURL('image/png', 1.0); const link = document.createElement('a'); link.download = `chart_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`; link.href = dataURL; link.click(); showNotification('Диаграмма сохранена как PNG', "success"); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.getElementById('chartContainer').requestFullscreen().catch(err => console.error(err)); } else { document.exitFullscreen(); } }
        function showLoading(text) { const placeholder = document.getElementById('chart-placeholder'); const canvas = document.getElementById('myChart'); if (window.myChart instanceof Chart) { window.myChart.destroy(); window.myChart = null; } placeholder.innerHTML = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>${text}</p>`; placeholder.style.display = 'block'; canvas.style.display = 'none'; }
        function showNotification(message, type = 'info', duration = 3000) { const p = document.getElementById('notification-placeholder') || document.body; const n = document.createElement('div'); n.className = `notification-bar`; const iconMap = {'error': 'times-circle', 'warning': 'exclamation-triangle', 'info': 'info-circle', 'success': 'check-circle'}; const colorMap = {'error': 'btn-color-send', 'warning': 'btn-color-display', 'info': 'btn-color-appearance', 'success': 'btn-color-type'}; n.style.backgroundColor = `var(--${colorMap[type] || 'btn-color-appearance'})`; n.innerHTML = `<i class="fas fa-${iconMap[type] || 'info-circle'}" style="margin-right: 8px;"></i> ${message}`; p.appendChild(n); setTimeout(() => n.classList.add('show'), 10); setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 500); }, duration); }
        function renderDataTable() { const tableDiv = document.getElementById('dataTable'); if (chartData.labels.length === 0) { tableDiv.innerHTML = '<p style="padding:10px; text-align:center; color: var(--light-text);">Нет данных.</p>'; return; } let tableHTML = `<table class="data-table"><thead><tr><th>#</th><th>Категория</th><th>Значение</th><th><i class="fas fa-trash"></i></th></tr></thead><tbody>`; chartData.labels.forEach((label, index) => { tableHTML += `<tr><td>${index + 1}</td><td contenteditable="true" onblur="updateTableData(${index}, 'label', this.innerText)">${label}</td><td contenteditable="true" onblur="updateTableData(${index}, 'value', this.innerText)">${chartData.values[index]}</td><td><button class="chart-action-btn" style="color:#f72585;" onclick="removeTableRow(${index})"><i class="fas fa-times"></i></button></td></tr>`; }); tableHTML += `</tbody></table>`; tableDiv.innerHTML = tableHTML; }
        function addTableRow() { chartData.labels.push(`Новая категория`); chartData.values.push(0); updateTextareaFromData(); renderDataTable(); drawChart(); document.getElementById('dataTableContainer').scrollTop = document.getElementById('dataTableContainer').scrollHeight; }
        function removeTableRow(index) { chartData.labels.splice(index, 1); chartData.values.splice(index, 1); updateTextareaFromData(); renderDataTable(); drawChart(); }
        function updateTableData(index, type, value) { if (type === 'label') { chartData.labels[index] = value; } else if (type === 'value') { const numValue = parseFloat(value.replace(',', '.')); if (!isNaN(numValue)) chartData.values[index] = numValue; } updateTextareaFromData(); drawChart(); }
        window.addEventListener('resize', () => { if (window.myChart instanceof Chart) window.myChart.resize(); });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица</title>
    <link rel="icon" href="https://i.ibb.co/B28zDrny/excel.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f5f5f5;
            user-select: none;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        .toolbar {
            display: none;
        }
        button {
            display: none;
        }
        #file-input {
            display: none;
        }
        .table-container {
            flex: 1;
            overflow: auto;
            background-color: white;
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e0e0e0;
            min-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }
        th {
            background-color: #4a90e2;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tbody tr:hover {
            background-color: #eef4ff;
        }
        .status-bar {
            background-color: #f0f0f0;
            padding: 8px 15px;
            font-size: 13px;
            color: #666;
            border-top: 1px solid #ddd;
            margin: 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-bar select {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background-color: white;
            cursor: pointer;
        }
        input, select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 900;
        }
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 400px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dialog-title {
            margin-bottom: 15px;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        .dialog p {
            margin-bottom: 15px;
            color: #555;
        }
        .dialog div {
            margin-bottom: 12px;
        }
        .dialog label {
            margin-left: 8px;
            color: #333;
        }
        .dialog input[type="radio"] {
            margin-right: 8px;
        }
        .dialog input[type="text"] {
            margin-left: 8px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        .dialog-buttons button {
            display: block !important;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .dialog-buttons button:hover {
            background-color: #0056b3;
        }
        .dialog-buttons button#separator-cancel,
        .dialog-buttons button#update-separator-cancel,
        .dialog-buttons button#rename-column-cancel,
        .dialog-buttons button#save-cancel,
        .dialog-buttons button#move-column-cancel,
        .dialog-buttons button#move-row-cancel,
        .dialog-buttons button#replace-empty-cancel {
            background-color: #dc3545;
        }
        .dialog-buttons button#separator-cancel:hover,
        .dialog-buttons button#update-separator-cancel:hover,
        .dialog-buttons button#rename-column-cancel:hover,
        .dialog-buttons button#save-cancel:hover,
        .dialog-buttons button#move-column-cancel:hover,
        .dialog-buttons button#move-row-cancel:hover,
        .dialog-buttons button#replace-empty-cancel:hover {
            background-color: #c82333;
        }
        .context-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
        }
        .context-menu-item:hover {
            background-color: #f0f0f0;
        }
        .context-menu-separator {
            height: 1px;
            background-color: #ddd;
            margin: 5px 0;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            cursor: pointer;
        }
        .icon-large {
            font-size: 48px;
            margin-bottom: 15px;
            color: #aaa;
        }
        .empty-state #format-button-empty-state {
            display: inline-block;
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .empty-state #format-button-empty-state:hover {
            background-color: #0056b3;
        }
        .column-resize-handle {
            display: none;
        }
        .column-resizing {
            cursor: default;
            user-select: auto;
        }
        #rename-column-dialog input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 10px;
        }
        #preview {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            color: #333;
            white-space: pre-wrap;
        }
        .switch {
          position: relative;
          display: inline-block;
          width: 30px;
          height: 17px;
          margin: 0 5px;
        }
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 13px;
          width: 13px;
          left: 2px;
          bottom: 2px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }
        input:checked + .slider {
          background-color: #2196F3;
        }
        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
          -webkit-transform: translateX(13px);
          -ms-transform: translateX(13px);
          transform: translateX(13px);
        }
        .slider.round {
          border-radius: 17px;
        }
        .slider.round:before {
          border-radius: 50%;
        }

        /* --- Стили для выпадающего фильтра --- */
        .filter-icon {
            cursor: pointer;
            font-weight: bold;
            padding: 0 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .filter-icon:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .filter-icon.active {
            color: #ffd700; /* Ярко-желтый цвет для активного фильтра */
        }
        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 1001;
            padding: 10px;
            border-radius: 6px;
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-dropdown-search {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-dropdown-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 4px;
        }
        .filter-dropdown-list label {
            display: block;
            padding: 5px 8px;
            margin: 0;
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            color: #333;
        }
        .filter-dropdown-list label:hover {
            background-color: #f0f0f0;
        }
        .filter-dropdown-list input {
            margin-right: 8px;
        }
        .filter-dropdown-buttons {
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        .filter-dropdown-buttons button {
            display: inline-block !important; /* Override button display */
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .filter-dropdown-buttons .ok-btn {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .filter-dropdown-buttons .reset-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <input type="file" id="file-input" accept=".csv,.txt,.xlsx">
            <button id="open-file-btn">Открыть файл</button>
            <button id="save-file-btn" disabled>Сохранить</button>
            <button id="save-as-file-btn" disabled>Сохранить как</button>
        </div>
        <div class="table-container" id="table-container">
            <div class="empty-state" id="empty-state">
                <div class="icon-large">
                    <img src="https://i.ibb.co/B28zDrny/excel.png" alt="Excel Icon" style="width: 48px; height: 48px;">
                </div>
                <p>Открыть файл</p>
                <button id="format-button-empty-state">Форматировать</button>
            </div>
            <table id="data-table" style="display: none;">
                <thead>
                    <tr id="header-row"></tr>
                    <!-- Строка фильтров <tr id="filter-row"></tr> удалена -->
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div class="status-bar" id="status-bar">
            <select id="sheet-selector" style="display: none;"></select>
            <span id="status-message">Готов</span>
            <div style="flex-grow: 1;"></div>
            <input type="text" id="filter-input" placeholder="Фильтр..." style="padding: 4px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
            <div style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                <span>ячейка</span>
                <label class="switch">
                    <input type="checkbox" id="filter-mode-toggle">
                    <span class="slider round"></span>
                </label>
                <span>строка</span>
            </div>
        </div>
    </div>
    <div class="dialog-overlay" id="dialog-overlay"></div>
    <div class="dialog" id="separator-dialog">
        <h3 class="dialog-title">Выбор разделителя</h3>
        <p>Выберите разделитель для файла:</p>
        <div>
            <input type="radio" name="separator" id="comma" value=",">
            <label for="comma">Запятая (,)</label>
        </div>
        <div>
            <input type="radio" name="separator" id="semicolon" value=";" checked>
            <label for="semicolon">Точка с запятой (;)</label>
        </div>
        <div>
            <input type="radio" name="separator" id="tab" value="\t">
            <label for="tab">Табуляция</label>
        </div>
        <div>
            <input type="radio" name="separator" id="space" value=" ">
            <label for="space">Пробел</label>
        </div>
        <div>
            <input type="radio" name="separator" id="custom" value="custom">
            <label for="custom">Другой:</label>
            <input type="text" id="custom-separator" placeholder="Укажите символ" size="1" maxlength="1">
        </div>
        <div style="margin-top: 15px;">
            <input type="checkbox" id="first-row-header" checked>
            <label for="first-row-header">Заголовок в первой строке</label>
        </div>
        <div style="margin-top: 15px;">
            <label for="encoding-select">Кодировка:</label>
            <select id="encoding-select">
                <option value="utf-8" selected>UTF-8</option>
                <option value="windows-1251">ANSI (Windows-1251)</option>
            </select>
        </div>
        <div id="preview"></div>
        <div class="dialog-buttons">
            <button id="separator-cancel">Отмена</button>
            <button id="separator-confirm">Применить</button>
        </div>
    </div>
    <div class="dialog" id="rename-column-dialog">
        <h3 class="dialog-title">Переименовать столбец</h3>
        <p>Введите новое имя для столбца:</p>
        <div>
            <input type="text" id="new-column-name" placeholder="Новое имя столбца" style="width: 100%;">
        </div>
        <div class="dialog-buttons">
            <button id="rename-column-cancel">Отмена</button>
            <button id="rename-column-confirm">Применить</button>
        </div>
    </div>
    <div class="dialog" id="save-dialog">
        <h3 class="dialog-title">Сохранить файл</h3>
        <div>
            <label for="save-format">Формат файла:</label>
            <select id="save-format">
                <option value="csv">CSV</option>
                <option value="txt">TXT</option>
                <option value="xlsx">Excel (XLSX)</option>
            </select>
        </div>
        <div id="separator-container" style="margin-top: 10px;">
            <label for="save-separator">Разделитель:</label>
            <select id="save-separator">
                <option value=";">Точка с запятой (;)</option>
                <option value=",">Запятая (,)</option>
                <option value="\t">Табуляция</option>
                <option value=" ">Пробел</option>
                <option value="custom">Другой</option>
            </select>
            <input type="text" id="save-custom-separator" placeholder="Символ" size="1" maxlength="1" style="display: none;">
        </div>
        <div class="dialog-buttons">
            <button id="save-cancel">Отмена</button>
            <button id="save-confirm">Сохранить</button>
        </div>
    </div>
    <div class="context-menu" id="context-menu"></div>
    <div class="dialog" id="update-separator-dialog">
        <h3 class="dialog-title">Обновить разделитель</h3>
        <p>Выберите новый разделитель для текущих данных:</p>
        <div>
            <input type="radio" name="new-separator" id="new-comma" value=",">
            <label for="new-comma">Запятая (,)</label>
        </div>
        <div>
            <input type="radio" name="new-separator" id="new-semicolon" value=";" checked>
            <label for="new-semicolon">Точка с запятой (;)</label>
        </div>
        <div>
            <input type="radio" name="new-separator" id="new-tab" value="\t">
            <label for="new-tab">Табуляция</label>
        </div>
        <div>
            <input type="radio" name="new-separator" id="new-space" value=" ">
            <label for="new-space">Пробел</label>
        </div>
        <div>
            <input type="radio" name="new-separator" id="new-custom" value="custom">
            <label for="new-custom">Другой:</label>
            <input type="text" id="new-custom-separator" placeholder="Укажите символ" size="1" maxlength="1">
        </div>
        <div class="dialog-buttons">
            <button id="update-separator-cancel">Отмена</button>
            <button id="update-separator-confirm">Применить</button>
        </div>
    </div>
    <div class="dialog" id="move-column-dialog">
        <h3 class="dialog-title">Переместить столбец</h3>
        <p>Выберите, ПЕРЕД каким столбцом переместить столбец:</p>
        <div style="margin-top: 10px;">
            <select id="column-to-select" style="width: 100%;">
            </select>
        </div>
        <div class="dialog-buttons">
            <button id="move-column-cancel">Отмена</button>
            <button id="move-column-confirm">Переместить</button>
        </div>
    </div>
    <div class="dialog" id="move-row-dialog">
        <h3 class="dialog-title">Переместить строку</h3>
        <p>Выберите, ПЕРЕД какой строкой переместить строку:</p>
        <div style="margin-top: 10px;">
            <select id="row-to-select" style="width: 100%;">
            </select>
        </div>
        <div class="dialog-buttons">
            <button id="move-row-cancel">Отмена</button>
            <button id="move-row-confirm">Переместить</button>
        </div>
    </div>
    <div class="dialog" id="replace-empty-dialog">
        <h3 class="dialog-title">Заменить пустые строки</h3>
        <p>Введите текст для замены пустых значений в столбце:</p>
        <div>
            <input type="text" id="replace-empty-text" placeholder="Введите текст" style="width: 100%;">
        </div>
        <div class="dialog-buttons">
            <button id="replace-empty-cancel">Отмена</button>
            <button id="replace-empty-confirm">Применить</button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const tableContainer = document.getElementById('table-container');
            const dataTable = document.getElementById('data-table');
            const headerRow = document.getElementById('header-row');
            // const filterRow = document.getElementById('filter-row'); // Удалено
            const tableBody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');
            const statusBar = document.getElementById('status-bar');
            const statusMessage = document.getElementById('status-message');
            const sheetSelector = document.getElementById('sheet-selector');
            const iconLarge = emptyState.querySelector('.icon-large');
            const dialogOverlay = document.getElementById('dialog-overlay');
            const separatorDialog = document.getElementById('separator-dialog');
            const separatorCancel = document.getElementById('separator-cancel');
            const separatorConfirm = document.getElementById('separator-confirm');
            const customSeparator = document.getElementById('custom-separator');
            const preview = document.getElementById('preview');
            const saveDialog = document.getElementById('save-dialog');
            const saveFormat = document.getElementById('save-format');
            const saveSeparator = document.getElementById('save-separator');
            const saveCustomSeparator = document.getElementById('save-custom-separator');
            const saveCancel = document.getElementById('save-cancel');
            const saveConfirm = document.getElementById('save-confirm');
            const contextMenu = document.getElementById('context-menu');
            const filterInput = document.getElementById('filter-input');
            const filterModeToggle = document.getElementById('filter-mode-toggle');
            const formatButtonEmptyState = document.getElementById('format-button-empty-state');
            
            let data = [];
            let headers = [];
            let currentSeparator = null;
            let currentFilename = null;
            let currentFileSize = null;
            let modified = false;
            let contextMenuTarget = null;
            let columnWidths = {};
            let workbook = null;
            let lastActionMessage = 'Готов';
            let renameColumnDialog = document.getElementById('rename-column-dialog');
            let renameColumnCancel = document.getElementById('rename-column-cancel');
            let renameColumnConfirm = document.getElementById('rename-column-confirm');
            let newColumnNameInput = document.getElementById('new-column-name');
            let currentColumnIndex = null;
            
            // --- Новые переменные для фильтра ---
            let activeFilters = {}; // { columnIndex: [value1, value2], ... }

            function updatePreview(file, encodingSelect, previewElement) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let content;
                    const encoding = encodingSelect.value;
                    if (encoding === 'windows-1251') {
                        const uint8Array = new Uint8Array(e.target.result);
                        content = new TextDecoder('windows-1251').decode(uint8Array);
                    } else {
                        content = new TextDecoder('utf-8').decode(new Uint8Array(e.target.result));
                    }
                    const lines = content.split(/\r?\n/).filter(line => line.trim()).slice(0, 10);
                    previewElement.textContent = lines.join('\n');
                };
                reader.readAsArrayBuffer(file);
            }

            function showSeparatorDialog() {
                if (!fileInput.files[0]) return;
                const file = fileInput.files[0];
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.xlsx')) {
                    processXLSXFile(file);
                    return;
                }
                dialogOverlay.style.display = 'block';
                separatorDialog.style.display = 'block';
                document.getElementById('semicolon').checked = true;
                const encodingSelect = document.getElementById('encoding-select');
                updatePreview(file, encodingSelect, preview);
                const previewUpdateHandler = () => updatePreview(file, encodingSelect, preview);
                encodingSelect.removeEventListener('change', previewUpdateHandler);
                encodingSelect.addEventListener('change', previewUpdateHandler);
            }

            function hideSeparatorDialog() {
                dialogOverlay.style.display = 'none';
                separatorDialog.style.display = 'none';
                preview.textContent = '';
            }

            function showRenameColumnDialog(columnIndex) {
                currentColumnIndex = columnIndex;
                newColumnNameInput.value = headers[columnIndex];
                dialogOverlay.style.display = 'block';
                renameColumnDialog.style.display = 'block';
                newColumnNameInput.focus();
            }

            function hideRenameColumnDialog() {
                dialogOverlay.style.display = 'none';
                renameColumnDialog.style.display = 'none';
                currentColumnIndex = null;
            }

            renameColumnCancel.addEventListener('click', hideRenameColumnDialog);

            renameColumnConfirm.addEventListener('click', () => {
                if (currentColumnIndex !== null) {
                    const newName = newColumnNameInput.value.trim();
                    if (newName) {
                        headers[currentColumnIndex] = newName;
                        renderTable(false);
                        modified = true;
                        updateStatusBar(`Столбец переименован на "${newName}"`);
                    } else {
                        alert('Имя столбца не может быть пустым!');
                    }
                }
                hideRenameColumnDialog();
            });

            newColumnNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    renameColumnConfirm.click();
                }
            });

            fileInput.addEventListener('change', showSeparatorDialog);

            separatorCancel.addEventListener('click', () => {
                hideSeparatorDialog();
                resetFileInput();
            });

            separatorConfirm.addEventListener('click', () => {
                const selectedSeparator = document.querySelector('input[name="separator"]:checked').value;
                let separator;
                if (selectedSeparator === 'custom') {
                    separator = customSeparator.value || ';';
                } else if (selectedSeparator === '\\t') {
                    separator = '\t';
                } else {
                    separator = selectedSeparator;
                }
                hideSeparatorDialog();
                processFileContent(fileInput.files[0], separator);
            });

            document.getElementById('custom').addEventListener('change', () => {
                customSeparator.focus();
            });

            saveSeparator.addEventListener('change', () => {
                saveCustomSeparator.style.display = saveSeparator.value === 'custom' ? 'inline' : 'none';
                if (saveSeparator.value === 'custom') {
                    saveCustomSeparator.focus();
                }
            });

            saveFormat.addEventListener('change', () => {
                const separatorContainer = document.getElementById('separator-container');
                if (saveFormat.value === 'xlsx') {
                    separatorContainer.style.display = 'none';
                } else {
                    separatorContainer.style.display = 'block';
                }
            });

            saveCancel.addEventListener('click', hideSaveDialog);

            saveConfirm.addEventListener('click', () => {
                let separator;
                let format = saveFormat.value;
                if (format !== 'xlsx') {
                    if (saveSeparator.value === 'custom') {
                        separator = saveCustomSeparator.value || ';';
                    } else if (saveSeparator.value === '\\t') {
                        separator = '\t';
                    } else {
                        separator = saveSeparator.value;
                    }
                }
                let filename = currentFilename;
                if (!filename) {
                    filename = `table.${format}`;
                } else {
                    filename = filename.substring(0, filename.lastIndexOf('.')) + `.${format}`;
                }
                saveFile(filename, separator, format);
                hideSaveDialog();
            });

            tableContainer.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => {
                hideContextMenu();
                closeFilterDropdown();
            });
            iconLarge.addEventListener('click', () => {
                fileInput.click();
            });

            emptyState.querySelector('p').addEventListener('click', () => {
                fileInput.click();
            });

            sheetSelector.addEventListener('change', () => {
                loadSheet(sheetSelector.value);
            });

            filterInput.addEventListener('input', applyFilters);
            filterModeToggle.addEventListener('change', applyFilters);

            if (formatButtonEmptyState) {
                formatButtonEmptyState.addEventListener('click', () => {
                    window.location.href = 'format.html';
                });
            }

            function resetFileInput() {
                fileInput.value = '';
            }

            function processXLSXFile(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    workbook = XLSX.read(arrayBuffer, {type: 'array'});
                    currentFileSize = Math.round(file.size / 1024);
                    currentFilename = file.name;
                    sheetSelector.innerHTML = '';
                    workbook.SheetNames.forEach(sheetName => {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelector.appendChild(option);
                    });
                    sheetSelector.style.display = 'inline-block';
                    loadSheet(workbook.SheetNames[0]);
                };
                reader.onerror = function() {
                    updateStatusBar('Ошибка чтения Excel-файла.');
                    alert('Ошибка чтения Excel-файла.');
                    resetFileInput();
                };
                reader.readAsArrayBuffer(file);
            }

            function loadSheet(sheetName) {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                if (jsonData.length === 0) {
                    alert("Лист пуст или не содержит данных.");
                    return;
                }
                headers = jsonData[0].map(header => header ? String(header) : '');
                data = jsonData.slice(1).map(row => {
                    const filledRow = [...row];
                    while (filledRow.length < headers.length) {
                        filledRow.push('');
                    }
                    return filledRow.map(cell => cell !== undefined && cell !== null ? String(cell) : '');
                });
                currentSeparator = null;
                activeFilters = {};
                renderTable(true);
                updateStatusBar(`Открыт лист: ${sheetName}`);
            }

            function processFileContent(file, separator) {
                if (!file) {
                    updateStatusBar('Ошибка: Файл не выбран.');
                    return;
                }
                
                const encoding = document.getElementById('encoding-select').value;
                const reader = new FileReader();
                reader.onload = function(e) {
                    let content;
                    if (encoding === 'windows-1251') {
                        const uint8Array = new Uint8Array(e.target.result);
                        content = new TextDecoder('windows-1251').decode(uint8Array);
                    } else {
                        content = new TextDecoder('utf-8').decode(new Uint8Array(e.target.result));
                    }

                    parseCSV(content, separator);
                    currentFilename = file.name;
                    currentFileSize = Math.round(file.size / 1024);
                    currentSeparator = separator;
                    sheetSelector.style.display = 'none';
                    activeFilters = {};
                    updateStatusBar(`Открыт файл: ${file.name} (разделитель: "${separator === '\t' ? 'Табуляция' : separator === ' ' ? 'Пробел' : separator}", кодировка: ${encoding.toUpperCase()})`);
                    applyFilters();
                };
                reader.onerror = function() {
                    updateStatusBar('Ошибка чтения файла.');
                    alert('Ошибка чтения файла.');
                    resetFileInput();
                };
                reader.readAsArrayBuffer(file);
            }
            
            function parseCSV(content, separator) {
                const lines = content.split(/\r?\n/).filter(line => line.trim());
                const firstRowHeader = document.getElementById('first-row-header').checked;
                if (lines.length === 0) {
                    headers = [];
                    data = [];
                    renderTable(true);
                    updateStatusBar("Файл пуст или не содержит данных.");
                    return;
                }
                data = [];

                if (firstRowHeader) {
                    const headerLine = lines[0];
                    headers = headerLine.split(separator).map(header => header.trim());

                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        let row = parseCSVRow(lines[i], separator);
                        while (row.length < headers.length) {
                            row.push('');
                        }
                        data.push(row.map(cell => cell !== undefined && cell !== null ? String(cell) : ''));
                    }
                } else {
                    const firstLine = lines[0];
                    const columnCount = parseCSVRow(firstLine, separator).length;
                    headers = Array.from({length: columnCount}, (_, i) => `Столбец ${i + 1}`);
                    for (let i = 0; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        let row = parseCSVRow(lines[i], separator);
                        while (row.length < headers.length) {
                            row.push('');
                        }
                        data.push(row.map(cell => cell !== undefined && cell !== null ? String(cell) : ''));
                    }
                }
                renderTable(true);
            }

            function parseCSVRow(line, separator) {
                const row = [];
                let inQuote = false;
                let currentValue = '';
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        if (inQuote && j + 1 < line.length && line[j+1] === '"') {
                            currentValue += '"';
                            j++;
                            continue;
                        }
                        inQuote = !inQuote;
                    } else if (char === separator && !inQuote) {
                        row.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                row.push(currentValue.trim());
                return row;
            }

            function renderTable(doAdjustWidths = false) {
                headerRow.innerHTML = '';
                // filterRow.innerHTML = ''; // Удалено
                tableBody.innerHTML = '';
                if (headers.length === 0 && data.length === 0) {
                    dataTable.style.display = 'none';
                    emptyState.style.display = 'flex';
                    updateStatusBar('Готов. Нет данных для отображения.');
                    return;
                }
                dataTable.style.display = 'table';
                emptyState.style.display = 'none';
                
                headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.dataset.index = index;
                    th.dataset.type = 'header';
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = header || `Столбец ${index + 1}`;
                    
                    const filterIcon = document.createElement('span');
                    filterIcon.className = 'filter-icon';
                    filterIcon.innerHTML = '&#9662;'; // стрелка вниз
                    filterIcon.onclick = (e) => {
                        e.stopPropagation();
                        showFilterDropdown(index, filterIcon);
                    };
                    
                    th.appendChild(titleSpan);
                    th.appendChild(filterIcon);
                    headerRow.appendChild(th);
                });

                data.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    tr.dataset.index = rowIndex;
                    row.forEach((cell, cellIndex) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.dataset.row = rowIndex;
                        td.dataset.col = cellIndex;
                        td.dataset.type = 'cell';
                        td.addEventListener('dblclick', () => editCell(td, rowIndex, cellIndex));
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
                if (doAdjustWidths) {
                    adjustColumnWidths();
                }
                applyFilters();
            }

            function adjustColumnWidths() {
                if (headers.length === 0) return;
                headerRow.childNodes.forEach((th, colIndex) => {
                    let maxWidth = 0;
                    maxWidth = Math.max(maxWidth, th.offsetWidth);
                    tableBody.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(td => {
                        maxWidth = Math.max(maxWidth, td.offsetWidth);
                    });
                    const calculatedWidth = maxWidth + 20;
                    columnWidths[colIndex] = `${calculatedWidth}px`;
                    th.style.width = `${calculatedWidth}px`;
                    tableBody.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(td => {
                        td.style.width = `${calculatedWidth}px`;
                    });
                });
            }

            function editCell(cell, rowIndex, colIndex) {
                const currentValue = data[rowIndex][colIndex];
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.style.width = '90%';
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();
                input.addEventListener('blur', finishEdit);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        finishEdit();
                    } else if (e.key === 'Escape') {
                        cell.textContent = currentValue;
                    }
                });

                function finishEdit() {
                    const newValue = input.value;
                    cell.textContent = newValue;
                    data[rowIndex][colIndex] = newValue;
                    modified = true;
                    updateStatusBar('Данные изменены');
                    applyFilters();
                }
            }

            function handleContextMenu(e) {
                hideContextMenu();
                e.preventDefault();
                contextMenuTarget = e.target;
                contextMenu.innerHTML = '';
                if (!currentFilename && data.length === 0) {
                    addContextMenuItem('Открыть', () => {
                        fileInput.click();
                    });
                    addContextMenuSeparator();
                }
                if (currentFilename || data.length > 0) {
                    addContextMenuItem('Сохранить', () => {
                        if (currentFilename && currentFilename.endsWith('.xlsx')) {
                            saveFile(currentFilename, null, 'xlsx');
                        } else {
                            saveFile(currentFilename || 'table.csv', currentSeparator || ';');
                        }
                    });
                    addContextMenuItem('Сохранить как...', showSaveDialog);
                    addContextMenuSeparator();
                    if (currentSeparator !== null) {
                        addContextMenuItem('Обновить разделитель', () => {
                            showUpdateSeparatorDialog();
                        });
                        addContextMenuSeparator();
                    }
                }
                const element = e.target.closest('[data-type]');
                if (!element) return;
                
                const elementType = element.dataset.type;
                if (elementType === 'header' && headers.length > 0) {
                    const columnIndex = parseInt(element.dataset.index);
                    addContextMenuItem('Копировать', () => {
                        copyToClipboard(headers[columnIndex]);
                    });
                    addContextMenuItem('Переименовать столбец', () => {
                        showRenameColumnDialog(columnIndex);
                    });
                    addContextMenuItem('Заменить пустые строки на...', () => {
                        showReplaceEmptyDialog(columnIndex);
                    });
                    addContextMenuSeparator();
                    if (headers.length > 0) {
                        addContextMenuItem('Вставить столбец слева', () => {
                            insertColumn(columnIndex);
                        });
                        addContextMenuItem('Вставить столбец справа', () => {
                            insertColumn(columnIndex + 1);
                        });
                        addContextMenuSeparator();
                    }
                    if (headers.length > 1) {
                        addContextMenuItem('Переместить столбец', () => {
                            showMoveColumnDialog(columnIndex);
                        });
                        addContextMenuSeparator();
                    }
                    if (headers.length >= 1) {
                        addContextMenuItem('Удалить столбец', () => {
                            if (confirm(`Вы уверены, что хотите удалить столбец "${headers[columnIndex]}"?`)) {
                                deleteColumn(columnIndex);
                            }
                        });
                    }
                } else if (elementType === 'cell' && data.length > 0) {
                    const rowIndex = parseInt(element.dataset.row);
                    const columnIndex = parseInt(element.dataset.col);
                    addContextMenuItem('Копировать', () => {
                        copyToClipboard(data[rowIndex][columnIndex]);
                    });
                    addContextMenuItem('Копировать ячейку', () => {
                        copyToClipboard(data[rowIndex][columnIndex]);
                    });
                    addContextMenuItem('Копировать строку', () => {
                        copyToClipboard(data[rowIndex].join('\t'));
                    });
                    addContextMenuItem('Редактировать ячейку', () => {
                        editCell(element, rowIndex, columnIndex);
                    });
                    addContextMenuSeparator();
                    addContextMenuItem('Вставить строку выше', () => {
                        insertRow(rowIndex);
                    });
                    addContextMenuItem('Вставить строку ниже', () => {
                        insertRow(rowIndex + 1);
                    });
                    if (data.length > 1) {
                        addContextMenuSeparator();
                        addContextMenuItem('Переместить строку', () => {
                            showMoveRowDialog(rowIndex);
                        });
                    }
                    if (data.length >= 1) {
                        if (data.length > 1) addContextMenuSeparator();
                        addContextMenuItem('Удалить строку', () => {
                            if (confirm('Вы уверены, что хотите удалить эту строку?')) {
                                deleteRow(rowIndex);
                            }
                        });
                    }
                }
                if (contextMenu.children.length > 0) {
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.display = 'block';
                    const menuRect = contextMenu.getBoundingClientRect();
                    if (menuRect.right > window.innerWidth) {
                        contextMenu.style.left = `${e.pageX - menuRect.width}px`;
                    }
                    if (menuRect.bottom > window.innerHeight) {
                        contextMenu.style.top = `${e.pageY - menuRect.height}px`;
                    }
                }
            }
            
             // --- Новые функции для выпадающего фильтра ---

            function closeFilterDropdown() {
                const existingDropdown = document.querySelector('.filter-dropdown');
                if (existingDropdown) {
                    existingDropdown.remove();
                }
            }

// Замените функцию showFilterDropdown полностью:
function showFilterDropdown(columnIndex, iconElement) {
    closeFilterDropdown(); // Закрыть другие открытые фильтры

    const uniqueValues = [...new Set(data.map(row => row[columnIndex]))].sort((a, b) => String(a).localeCompare(String(b)));
    const currentColumnFilter = activeFilters[columnIndex] || uniqueValues; // Если фильтра нет, показываем все

    const dropdown = document.createElement('div');
    dropdown.className = 'filter-dropdown';
    dropdown.addEventListener('click', e => e.stopPropagation()); // Предотвратить закрытие при клике внутри

    // Поиск
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'filter-dropdown-search';
    searchInput.placeholder = 'Поиск значений...';

    // Список чекбоксов
    const listContainer = document.createElement('div');
    listContainer.className = 'filter-dropdown-list';
    
    // (Выбрать все)
    const selectAllLabel = document.createElement('label');
    const selectAllCheckbox = document.createElement('input');
    selectAllCheckbox.type = 'checkbox';
    selectAllLabel.appendChild(selectAllCheckbox);
    selectAllLabel.appendChild(document.createTextNode(' (Выбрать все)'));
    listContainer.appendChild(selectAllLabel);

    uniqueValues.forEach(value => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = value;
        checkbox.checked = currentColumnFilter.includes(value);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(value === '' ? '(Пустые)' : value));
        listContainer.appendChild(label);
    });

    // Кнопки
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'filter-dropdown-buttons';
    const okButton = document.createElement('button');
    okButton.className = 'ok-btn';
    okButton.textContent = 'OK';
    const resetButton = document.createElement('button');
    resetButton.className = 'reset-btn';
    resetButton.textContent = 'Сброс';
    buttonsContainer.appendChild(okButton);
    buttonsContainer.appendChild(resetButton);

    dropdown.appendChild(searchInput);
    dropdown.appendChild(listContainer);
    dropdown.appendChild(buttonsContainer);
    document.body.appendChild(dropdown);
    
    // Позиционирование
    const rect = iconElement.getBoundingClientRect();
    dropdown.style.left = `${rect.left}px`;
    dropdown.style.top = `${rect.bottom + 5}px`;

    // --- Логика внутри дропдауна ---
    const allCheckboxes = listContainer.querySelectorAll('input[type="checkbox"]');
    const valueCheckboxes = Array.from(allCheckboxes).slice(1); // Остальные чекбоксы со значениями (исключаем первый - "Выбрать все")

    function updateSelectAllState() {
        const visibleValueCheckboxes = valueCheckboxes.filter(cb => cb.parentElement.style.display !== 'none');
        if (visibleValueCheckboxes.length === 0) return;
        
        const checkedCount = visibleValueCheckboxes.filter(cb => cb.checked).length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === visibleValueCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    updateSelectAllState();

    selectAllCheckbox.addEventListener('change', () => {
        const visibleValueCheckboxes = valueCheckboxes.filter(cb => cb.parentElement.style.display !== 'none');
        visibleValueCheckboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        selectAllCheckbox.indeterminate = false;
    });

    valueCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectAllState);
    });

    searchInput.addEventListener('input', () => {
        const searchText = searchInput.value.toLowerCase();
        valueCheckboxes.forEach(cb => {
            const label = cb.parentElement;
            const labelText = label.textContent.toLowerCase();
            if (labelText.includes(searchText)) {
                label.style.display = 'block';
            } else {
                label.style.display = 'none';
            }
        });
        updateSelectAllState();
    });
    
    okButton.addEventListener('click', () => {
        const selectedValues = valueCheckboxes
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        // Если не выбрано ни одного значения, скрываем все строки
        if (selectedValues.length === 0) {
            activeFilters[columnIndex] = [];
            iconElement.classList.add('active');
        }
        // Если выбраны все, считаем, что фильтра нет
        else if (selectedValues.length === uniqueValues.length) {
            delete activeFilters[columnIndex];
            iconElement.classList.remove('active');
        } else {
            activeFilters[columnIndex] = selectedValues;
            iconElement.classList.add('active');
        }
        applyFilters();
        closeFilterDropdown();
    });

    resetButton.addEventListener('click', () => {
        delete activeFilters[columnIndex];
        iconElement.classList.remove('active');
        applyFilters();
        closeFilterDropdown();
    });
}

            function addContextMenuItem(text, handler) {
                const item = document.createElement('div');
                item.className = 'context-menu-item';
                item.textContent = text;
                item.addEventListener('click', handler);
                contextMenu.appendChild(item);
                return item;
            }

            function addContextMenuSeparator() {
                const separator = document.createElement('div');
                separator.className = 'context-menu-separator';
                contextMenu.appendChild(separator);
            }

            function hideContextMenu() {
                contextMenu.style.display = 'none';
                contextMenuTarget = null;
            }

            function showMoveColumnDialog(fromIndex) {
                hideContextMenu();
                const dialog = document.getElementById('move-column-dialog');
                const dialogContent = `
                    <h3 class="dialog-title">Переместить столбец</h3>
                    <p>Выберите, ПЕРЕД каким столбцом переместить столбец "${headers[fromIndex]}":</p>
                    <div style="margin-top: 10px;">
                        <select id="column-to-select" style="width: 100%;">
                            ${headers.map((header, idx) =>
                                `<option value="${idx}" ${idx === fromIndex ? 'disabled' : ''}>${header}</option>`
                            ).join('')}
                            <option value="${headers.length}">В конец таблицы</option>
                        </select>
                    </div>
                    <div class="dialog-buttons">
                        <button id="move-column-cancel">Отмена</button>
                        <button id="move-column-confirm">Переместить</button>
                    </div>
                `;
                dialog.innerHTML = dialogContent;
                dialogOverlay.style.display = 'block';
                dialog.style.display = 'block';
                const cancelBtn = dialog.querySelector('#move-column-cancel');
                const confirmBtn = dialog.querySelector('#move-column-confirm');
                const toSelect = dialog.querySelector('#column-to-select');
                cancelBtn.onclick = () => {
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                confirmBtn.onclick = () => {
                    const toIndex = parseInt(toSelect.value);
                    moveColumn(fromIndex, toIndex);
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
            }

            function showUpdateSeparatorDialog() {
                hideContextMenu();
                const dialog = document.getElementById('update-separator-dialog');
                dialogOverlay.style.display = 'block';
                dialog.style.display = 'block';
                const cancelBtn = dialog.querySelector('#update-separator-cancel');
                const confirmBtn = dialog.querySelector('#update-separator-confirm');
                const customSeparatorInput = dialog.querySelector('#new-custom-separator');
                cancelBtn.onclick = () => {
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                confirmBtn.onclick = () => {
                    const selectedSeparator = dialog.querySelector('input[name="new-separator"]:checked').value;
                    let newSeparator;
                    if (selectedSeparator === 'custom') {
                        newSeparator = customSeparatorInput.value || ';';
                    } else if (selectedSeparator === '\\t') {
                        newSeparator = '\t';
                    } else {
                        newSeparator = selectedSeparator;
                    }
                    updateTableWithNewSeparator(newSeparator);
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                dialog.querySelector('#new-custom').onchange = () => {
                    customSeparatorInput.focus();
                };
            }

            function updateTableWithNewSeparator(newSeparator) {
                if (currentSeparator !== null) {
                    currentSeparator = newSeparator;
                    modified = true;
                    renderTable(false);
                    updateStatusBar(`Разделитель для сохранения обновлен на "${newSeparator === '\t' ? 'Табуляция' : newSeparator === ' ' ? 'Пробел' : newSeparator}"`);
                }
            }

            function showMoveRowDialog(fromIndex) {
                hideContextMenu();
                const dialog = document.getElementById('move-row-dialog');
                const dialogContent = `
                    <h3 class="dialog-title">Переместить строку</h3>
                    <p>Выберите, ПЕРЕД какой строкой переместить строку ${fromIndex + 1}:</p>
                    <div style="margin-top: 10px;">
                        <select id="row-to-select" style="width: 100%;">
                            ${data.map((_, idx) =>
                                `<option value="${idx}" ${idx === fromIndex ? 'disabled' : ''}>Строка ${idx + 1}</option>`
                            ).join('')}
                            <option value="${data.length}">В конец таблицы</option>
                        </select>
                    </div>
                    <div class="dialog-buttons">
                        <button id="move-row-cancel">Отмена</button>
                        <button id="move-row-confirm">Переместить</button>
                    </div>
                `;
                dialog.innerHTML = dialogContent;
                dialogOverlay.style.display = 'block';
                dialog.style.display = 'block';
                const cancelBtn = dialog.querySelector('#move-row-cancel');
                const confirmBtn = dialog.querySelector('#move-row-confirm');
                const toSelect = dialog.querySelector('#row-to-select');
                cancelBtn.onclick = () => {
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                confirmBtn.onclick = () => {
                    const toIndex = parseInt(toSelect.value);
                    moveRow(fromIndex, toIndex);
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
            }

            function moveRow(fromIndex, toIndex) {
                if (fromIndex === toIndex || fromIndex < 0 || fromIndex >= data.length || toIndex < 0 || toIndex > data.length) {
                    if (toIndex === fromIndex + 1 && fromIndex < toIndex) { }
                    else if (toIndex === fromIndex && fromIndex > toIndex) { }
                    else { return; }
                }
                const rowToMove = data.splice(fromIndex, 1)[0];
                data.splice(toIndex > fromIndex ? toIndex -1 : toIndex, 0, rowToMove);
                modified = true;
                renderTable(false);
                updateStatusBar('Строка перемещена');
            }

            function showReplaceEmptyDialog(columnIndex) {
                hideContextMenu();
                const dialogOverlay = document.getElementById('dialog-overlay');
                const dialog = document.getElementById('replace-empty-dialog');
                const cancelBtn = document.getElementById('replace-empty-cancel');
                const confirmBtn = document.getElementById('replace-empty-confirm');
                const textInput = document.getElementById('replace-empty-text');
                textInput.value = '';
                dialogOverlay.style.display = 'block';
                dialog.style.display = 'block';
                textInput.focus();
                cancelBtn.onclick = () => {
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                confirmBtn.onclick = () => {
                    const replacementText = textInput.value;
                    replaceEmptyCells(columnIndex, replacementText);
                    dialogOverlay.style.display = 'none';
                    dialog.style.display = 'none';
                };
                textInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                };
            }

            function replaceEmptyCells(columnIndex, replacementText) {
                let changesMade = false;
                data.forEach(row => {
                    if (row[columnIndex] === null || row[columnIndex] === undefined || String(row[columnIndex]).trim() === '') {
                        row[columnIndex] = replacementText;
                        changesMade = true;
                    }
                });
                if (changesMade) {
                    modified = true;
                    renderTable(false);
                    updateStatusBar(`Пустые значения в столбце "${headers[columnIndex]}" заменены на "${replacementText}"`);
                } else {
                    updateStatusBar(`В столбце "${headers[columnIndex]}" нет пустых значений или замен`);
                }
            }

            function moveColumn(fromIndex, toIndex) {
                if (fromIndex === toIndex || fromIndex < 0 || fromIndex >= headers.length || toIndex < 0 || toIndex > headers.length) {
                    if (toIndex === fromIndex + 1 && fromIndex < toIndex) { }
                    else if (toIndex === fromIndex && fromIndex > toIndex) { }
                    else { return; }
                }
                const headerToMove = headers.splice(fromIndex, 1)[0];
                headers.splice(toIndex > fromIndex ? toIndex - 1 : toIndex, 0, headerToMove);
                data.forEach(row => {
                    const cellToMove = row.splice(fromIndex, 1)[0];
                    row.splice(toIndex > fromIndex ? toIndex - 1 : toIndex, 0, cellToMove);
                });
                modified = true;
                renderTable(false);
                updateStatusBar('Столбец перемещен');
            }

            function insertColumn(index) {
                const newColumnName = `Столбец ${headers.length + 1}`;
                headers.splice(index, 0, newColumnName);
                data.forEach(row => {
                    row.splice(index, 0, '');
                });
                modified = true;
                renderTable(true);
                updateStatusBar('Добавлен новый столбец');
            }

            function deleteColumn(index) {
                if (index < 0 || index >= headers.length) return;
                headers.splice(index, 1);
                data.forEach(row => {
                    if (row.length > index) {
                        row.splice(index, 1);
                    }
                });
                delete activeFilters[index]; // Удаляем фильтр для этого столбца
                modified = true;
                if (headers.length === 0) {
                    data = [];
                }
                renderTable(true);
                updateStatusBar('Столбец удален');
            }

            function insertRow(index) {
                const newRow = new Array(headers.length).fill('');
                data.splice(index, 0, newRow);
                modified = true;
                renderTable(false);
                updateStatusBar('Добавлена новая строка');
            }

            function deleteRow(index) {
                if (index < 0 || index >= data.length) return;
                data.splice(index, 1);
                modified = true;
                renderTable(false);
                updateStatusBar('Строка удалена');
                if (data.length === 0 && headers.length === 0) {
                    dataTable.style.display = 'none';
                    emptyState.style.display = 'flex';
                }
            }

            function saveFile(filename, separator, format = 'csv') {
                if (headers.length === 0 && data.length === 0) {
                    alert("Нет данных для сохранения.");
                    return;
                }
                if (format === 'xlsx') {
                    saveAsXLSX(filename || 'table.xlsx');
                    return;
                }

                const effectiveFilename = filename || (format === 'csv' ? 'table.csv' : 'table.txt');
                const effectiveSeparator = separator || (currentSeparator !== null ? currentSeparator : ';');
                let contentToSave = format === 'csv' ? "data:text/csv;charset=utf-8," : "data:text/plain;charset=utf-8,";
                let headerString = headers.map(header => formatCellValue(header, effectiveSeparator)).join(effectiveSeparator);
                contentToSave += headerString + '\r\n';
                data.forEach(row => {
                    let rowString = row.map(cell => formatCellValue(cell, effectiveSeparator)).join(effectiveSeparator);
                    contentToSave += rowString + '\r\n';
                });
                let encodedUri = encodeURI(contentToSave);
                let link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", effectiveFilename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                currentFilename = effectiveFilename;
                currentSeparator = effectiveSeparator;
                updateStatusBar(`Файл сохранен: ${effectiveFilename}`);
                modified = false;
            }

            function saveAsXLSX(filename) {
                const wb = XLSX.utils.book_new();
                const tableData = (headers.length > 0) ? [headers, ...data] : [...data];
                if (tableData.length === 0) {
                    alert("Нет данных для сохранения в XLSX.");
                    return;
                }
                const ws = XLSX.utils.aoa_to_sheet(tableData);
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, filename);
                currentFilename = filename;
                currentSeparator = null;
                updateStatusBar(`Файл сохранен: ${filename}`);
                modified = false;
            }

            function formatCellValue(value, separator) {
                if (value === null || value === undefined) return '';
                let strValue = String(value);
                if (strValue.includes(separator) || strValue.includes('"') || strValue.includes('\n') || strValue.includes('\r')) {
                    strValue = '"' + strValue.replace(/"/g, '""') + '"';
                }
                return strValue;
            }

            function showSaveDialog() {
                if (headers.length === 0 && data.length === 0) {
                    alert("Нет данных для сохранения.");
                    return;
                }
                hideContextMenu();
                dialogOverlay.style.display = 'block';
                saveDialog.style.display = 'block';
                let hasXlsxOption = Array.from(saveFormat.options).some(opt => opt.value === 'xlsx');
                if (!hasXlsxOption) {
                    const xlsxOption = document.createElement('option');
                    xlsxOption.value = 'xlsx';
                    xlsxOption.textContent = 'Excel (XLSX)';
                    saveFormat.appendChild(xlsxOption);
                }
                if (currentFilename) {
                    if (currentFilename.endsWith('.csv')) saveFormat.value = 'csv';
                    else if (currentFilename.endsWith('.txt')) saveFormat.value = 'txt';
                    else if (currentFilename.endsWith('.xlsx')) saveFormat.value = 'xlsx';
                    else saveFormat.value = 'csv';
                } else {
                    saveFormat.value = 'csv';
                }
                if (currentSeparator === '\t') {
                    saveSeparator.value = '\\t';
                } else if (currentSeparator === ',' || currentSeparator === ';' || currentSeparator === ' ') {
                    saveSeparator.value = currentSeparator;
                } else if (currentSeparator) {
                    saveSeparator.value = 'custom';
                    saveCustomSeparator.value = currentSeparator;
                    saveCustomSeparator.style.display = 'inline';
                } else {
                    saveSeparator.value = ';';
                    saveCustomSeparator.style.display = 'none';
                }

                const separatorContainer = document.getElementById('separator-container');
                separatorContainer.style.display = saveFormat.value === 'xlsx' ? 'none' : 'block';
            }

            function hideSaveDialog() {
                dialogOverlay.style.display = 'none';
                saveDialog.style.display = 'none';
            }
            
            // Новая объединенная функция фильтрации
// Также замените функцию applyFilters:
function applyFilters() {
    if (data.length === 0 && headers.length === 0) {
        updateStatusBar(lastActionMessage, 0);
        return;
    }
    const globalFilterText = filterInput.value.trim().toLowerCase();
    const globalFilterMode = filterModeToggle.checked ? 'row' : 'cell';
    const globalFilterTerms = globalFilterText.split(/\s+/).filter(term => term);

    const rows = tableBody.querySelectorAll('tr');
    let visibleRowCount = 0;
    
    rows.forEach(rowElement => {
        const rowIndex = parseInt(rowElement.dataset.index);
        if (rowIndex >= data.length || data[rowIndex] === undefined) {
            rowElement.style.display = 'none';
            return;
        }

        const rowData = data[rowIndex];
        let isVisible = true;

        // 1. Проверка по фильтрам столбцов
        for (const colIndex in activeFilters) {
            const allowedValues = activeFilters[colIndex];
            const cellValue = rowData[colIndex];
            
            // Если массив фильтра пустой, скрываем все строки для этого столбца
            if (allowedValues.length === 0) {
                isVisible = false;
                break;
            }
            
            // Если значение не входит в разрешенные, скрываем строку
            if (!allowedValues.includes(cellValue)) {
                isVisible = false;
                break;
            }
        }

        if (!isVisible) {
            rowElement.style.display = 'none';
            return;
        }

        // 2. Проверка по глобальному фильтру (если строка прошла фильтры столбцов)
        if (globalFilterTerms.length > 0) {
            if (globalFilterMode === 'cell') {
                let matchInCell = false;
                for (const cellValue of rowData) {
                    const cellString = String(cellValue).toLowerCase();
                    if (globalFilterTerms.every(term => cellString.includes(term))) {
                        matchInCell = true;
                        break;
                    }
                }
                if (!matchInCell) isVisible = false;
            } else { // 'row' mode
                const rowString = rowData.map(String).join(' ').toLowerCase();
                if (!globalFilterTerms.every(term => rowString.includes(term))) {
                    isVisible = false;
                }
            }
        }

        if (isVisible) {
            rowElement.style.display = '';
            visibleRowCount++;
        } else {
            rowElement.style.display = 'none';
        }
    });
    updateStatusBar(lastActionMessage, visibleRowCount);
}

            function updateStatusBar(message, visibleRowCount) {
                lastActionMessage = message;
                let statusText = message;

                if (currentFilename) {
                    statusText += ` | Файл: ${currentFilename}`;
                    if (currentFileSize !== null) {
                        statusText += ` (${currentFileSize} КБ)`;
                    }
                }
                statusText += ` | Строк: ${data.length}, Столбцов: ${headers.length}`;
                const totalRows = data.length;
                const currentVisible = (visibleRowCount !== undefined) ? visibleRowCount : totalRows;
                if ((filterInput.value.trim() || Object.keys(activeFilters).length > 0) && totalRows > 0) {
                    statusText += ` | Показано: ${currentVisible} из ${totalRows}`;
                }
                statusMessage.textContent = statusText;
            }

            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                updateStatusBar('Скопировано в буфер обмена');
            }

            renderTable();
        });
    </script>
</body>
</html>
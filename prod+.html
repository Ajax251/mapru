<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Health Scanner AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧬</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%);
            --primary-color: #6a82fb;
            --secondary-color: #e9e9eb;
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --text-muted: #c7c7cc;
            --background: #f2f2f7;
            --surface: #ffffff;
            --border-light: #e5e5ea;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --radius-md: 12px;
            --radius-lg: 20px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-theme {
            --primary-gradient: linear-gradient(135deg, #5e76e4 0%, #e3526f 100%);
            --primary-color: #5e76e4;
            --secondary-color: #2c2c2e;
            --text-primary: #f2f2f7;
            --text-secondary: #8e8e93;
            --text-muted: #545458;
            --background: #000000;
            --surface: #1c1c1e;
            --border-light: #3a3a3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--background);
            color: var(--text-primary);
            overflow: hidden;
        }

        .app-container { height: 100vh; width: 100%; position: relative; overflow: hidden; }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; background: var(--background);
            transition: transform var(--transition), filter var(--transition);
            padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left);
        }

        #input-page { z-index: 10; }
        #results-page { transform: translateX(100%); z-index: 20; }

        .results-visible #input-page { transform: translateX(-30%); filter: brightness(0.95); pointer-events: none; }
        .results-visible #results-page { transform: translateX(0%); }

        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; padding-top: calc(16px + env(safe-area-inset-top));
            flex-shrink: 0;
        }

        .page-title { font-size: 28px; font-weight: 700; }
        
        .icon-btn {
            width: 40px; height: 40px; border: none; border-radius: 50%;
            background: var(--surface); color: var(--text-secondary); cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm);
        }
        .icon-btn:hover { background: var(--secondary-color); }
        .icon-btn:active { transform: scale(0.92); }

        .page-content {
            flex: 1; overflow-y: auto; /* THIS SOLVES THE SCROLLING PROBLEM */
            padding: 0 20px; display: flex; flex-direction: column;
        }
        
        #results-content { padding-bottom: 120px; }

        .tabs {
            display: grid; grid-template-columns: 1fr 1fr; background: var(--secondary-color);
            padding: 4px; border-radius: var(--radius-md); margin-bottom: 24px;
        }
        .tab-btn {
            padding: 10px 16px; border: none; border-radius: 9px; font-weight: 600;
            font-size: 15px; cursor: pointer; transition: var(--transition);
            background: transparent; color: var(--text-secondary);
        }
        .tab-btn.active { background: var(--surface); color: var(--text-primary); box-shadow: var(--shadow-md); }

        .input-card {
            background: var(--surface); border-radius: var(--radius-lg); padding: 20px;
            flex: 1; display: flex; flex-direction: column; margin-bottom: 24px; min-height: 300px;
        }
        .input-label {
            font-size: 16px; font-weight: 600; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .product-input {
            flex: 1; border: none; outline: none; font-size: 17px;
            line-height: 1.5; color: var(--text-primary); background: transparent; resize: none;
        }
        .product-input::placeholder { color: var(--text-muted); }

        .fab-container {
            position: fixed; bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%; transform: translateX(-50%); z-index: 100;
        }
        .fab {
            width: 64px; height: 64px; border-radius: 50%; background: var(--primary-gradient);
            color: white; border: none; cursor: pointer; box-shadow: var(--shadow-lg);
            transition: var(--transition); display: flex; align-items: center; justify-content: center;
        }
        .fab:hover { transform: scale(1.05); }
        .fab:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: var(--shadow-md); }

        /* Image Upload */
        .image-input-container { flex: 1; display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; }
        .image-preview-card { width: 100%; max-width: 280px; position: relative; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lg); }
        .image-preview { width: 100%; height: auto; display: block; }
        .clear-image-btn { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); color: white; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .clear-image-btn:hover { background: rgba(255,59,48,0.8); transform: scale(1.1); }
        .upload-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 280px; }
        .upload-btn { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px 24px; border-radius: var(--radius-md); border: none; background: var(--primary-color); color: white; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s; }
        .upload-btn:hover { filter: brightness(1.1); }

        /* Results Screen */
        .result-intro, .result-section { background: var(--surface); border-radius: var(--radius-lg); margin-bottom: 20px; padding: 24px; }
        .result-intro { padding: 16px; color: var(--text-secondary); }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; font-size: 20px; font-weight: 700; }
        .quick-verdict { color: white; padding: 20px; border-radius: var(--radius-md); font-size: 16px; line-height: 1.5; font-weight: 500; }
        .verdict-success { background: var(--success); }
        .verdict-warning { background: var(--warning); }
        .verdict-danger { background: var(--danger); }
        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .comparison-table th, .comparison-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .comparison-table th { color: var(--text-secondary); font-weight: 600; font-size: 14px; }
        .comparison-table tr:last-child td { border-bottom: none; }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .chart-card { background: var(--surface); border-radius: var(--radius-lg); padding: 20px; }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; text-align: center; }

        /* Loading Spinner */
        .loading-container { display: flex; justify-content: center; align-items: center; padding: 60px 0; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid var(--secondary-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: all; }
        .modal-card { background: var(--surface); border-radius: var(--radius-lg); padding: 24px; width: 100%; max-width: 400px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-card { transform: scale(1); }
        .modal-header { text-align: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-weight: 600; }
        .form-select { padding: 12px 16px; border: 1px solid var(--border-light); border-radius: var(--radius-md); background: var(--secondary-color); color: var(--text-primary); font-size: 16px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .btn { flex: 1; padding: 14px 20px; border-radius: var(--radius-md); font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        
        .hidden { display: none !important; }

        @media (min-width: 600px) {
            .app-container { max-width: 480px; height: 90vh; max-height: 900px; border-radius: 32px; box-shadow: var(--shadow-lg); margin: 5vh auto; }
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- PAGE 1: INPUT -->
        <div id="input-page" class="page">
            <header class="page-header">
                <h1 class="page-title">Health Scanner</h1>
                <button class="icon-btn" id="settings-btn" aria-label="Настройки">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69, 4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61 l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54c0.05,0.24,0.24,0.41,0.48,0.41h3.84 c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32 c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6 S13.98,15.6,12,15.6z"/></svg>
                </button>
            </header>
            <main class="page-content" id="input-content">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="text">📝 Описание</button>
                    <button class="tab-btn" data-tab="image">📸 Фото</button>
                </div>

                <div class="tab-content" id="text-input-container">
                    <div class="input-card">
                         <div class="input-label">🥗 Что анализируем?</div>
                         <textarea id="product-description" class="product-input" placeholder="Например: Йогурт Данон с клубникой, 125г..."></textarea>
                    </div>
                </div>

                <div class="tab-content hidden" id="image-input-container">
                    <div id="image-preview-container" class="image-preview-card hidden">
                        <img id="image-preview" class="image-preview" alt="Предпросмотр">
                        <button id="clear-image-btn" class="clear-image-btn" aria-label="Удалить">✕</button>
                    </div>
                    <div class="upload-buttons">
                        <button class="upload-btn" id="upload-btn">Выбрать файл</button>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                </div>
            </main>
        </div>

        <!-- PAGE 2: RESULTS -->
        <div id="results-page" class="page">
            <header class="page-header">
                <button class="icon-btn" id="back-btn" aria-label="Назад">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                 <h1 class="page-title" style="font-size: 22px;">Результат анализа</h1>
                 <div style="width: 40px;"></div>
            </header>
            <main class="page-content" id="results-content"></main>
        </div>

        <div class="fab-container">
            <button id="analyze-btn" class="fab" aria-label="Начать анализ" disabled>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>
            </button>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><h2 class="modal-title">⚙️ Настройки</h2></div>
            <form class="modal-form">
                <div class="form-group">
                    <label for="theme-select" class="form-label">🎨 Тема</label>
                    <select id="theme-select" class="form-select">
                        <option value="auto">🌓 Авто</option>
                        <option value="light">☀️ Светлая</option>
                        <option value="dark">🌙 Тёмная</option>
                    </select>
                </div>
            </form>
            <div class="modal-actions">
                <button id="close-settings-btn" class="btn btn-primary">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const AI_SYSTEM_PROMPT = `Ты — персональный нутрициолог с 15-летним опытом. Твой тон дружелюбный, но профессиональный. Твоя задача — дать четкий, структурированный и полезный анализ продукта. Твой ответ ДОЛЖЕН начинаться с короткого приветственного абзаца (1-2 предложения), а затем содержать ровно 5 разделов в указанном порядке.### 🔍 Быстрая оценка\nДай краткий вердикт в 2-3 предложениях.### 📊 Сравнительная таблица\nСравни с 1-2 популярными аналогами в формате Markdown таблицы.| Показатель | [Продукт] | [Аналог 1] ||------------|-----------|------------|| Калории (100г) | X ккал | X ккал || Белки | X г | X г || Жиры | X г | X г || Углеводы | X г | X г || Сахар | X г | X г |### 💡 Персональные рекомендации\n- **✅ Подходит:** (Кому и почему)\n- **⚠️ Осторожно:** (Кому и почему)\n- **🚫 Не рекомендуется:** (Кому и почему)### 🎯 Практические советы\n- **Лучшее время:** (Например: Утром)\n- **С чем сочетать:** (Например: С ягодами)### ⭐ Итоговая оценка\n**Рейтинг: X/10**\nКраткое обоснование.В конце обязательно добавь JSON для диаграмм:\n\`\`\`json\n{ "products": ["Продукт", "Аналог 1"], "calories": [150, 180], "sugar": [10, 22], "fat": [8, 12], "protein": [5, 3], "rating": 7 }\n\`\`\``;
            
            // DOM Elements
            const dom = {
                app: document.querySelector('.app-container'),
                analyzeBtn: document.getElementById('analyze-btn'),
                backBtn: document.getElementById('back-btn'),
                resultsContent: document.getElementById('results-content'),
                productDescription: document.getElementById('product-description'),
                tabs: document.querySelectorAll('.tab-btn'),
                tabContents: document.querySelectorAll('.tab-content'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
                themeSelect: document.getElementById('theme-select'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                imagePreview: document.getElementById('image-preview'),
                clearImageBtn: document.getElementById('clear-image-btn'),
                uploadBtn: document.getElementById('upload-btn'),
                fileInput: document.getElementById('file-input'),
            };

            // State
            let state = {
                activeCharts: [],
                uploadedFileBase64: null,
                currentTheme: localStorage.getItem('scanner_theme') || 'auto',
            };

            // --- UI LOGIC ---
            const ui = {
                showResults: () => dom.app.classList.add('results-visible'),
                hideResults: () => dom.app.classList.remove('results-visible'),
                openSettings: () => dom.settingsModal.classList.add('visible'),
                closeSettings: () => dom.settingsModal.classList.remove('visible'),
                updateAnalyzeButton: () => {
                    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                    const canAnalyze = (activeTab === 'text' && dom.productDescription.value.trim().length > 0) ||
                                       (activeTab === 'image' && state.uploadedFileBase64 !== null);
                    dom.analyzeBtn.disabled = !canAnalyze;
                },
                applyTheme: (theme) => {
                    if (theme === 'auto') {
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        document.body.classList.toggle('dark-theme', prefersDark);
                    } else {
                        document.body.classList.toggle('dark-theme', theme === 'dark');
                    }
                    state.currentTheme = theme;
                    localStorage.setItem('scanner_theme', theme);
                    dom.themeSelect.value = theme;
                }
            };

            // --- EVENT HANDLERS ---
            const handlers = {
                handleAnalyze: async () => {
                    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                    let userParts = [];

                    if (activeTab === 'text') {
                        const text = dom.productDescription.value.trim();
                        if (!text) return;
                        userParts.push({ text });
                    } else {
                        if (!state.uploadedFileBase64) return;
                        const mimeType = state.uploadedFileBase64.match(/data:(.*);base64,/)[1];
                        const base64Data = state.uploadedFileBase64.split(',')[1];
                        userParts.push({ inlineData: { mimeType, data: base64Data } });
                        userParts.push({ text: "Проанализируй продукт на фото." });
                    }

                    ui.showResults();
                    dom.resultsContent.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div></div>`;
                    
                    try {
                        // Replace with your actual API call. Using a mock for this example.
                        const responseText = await api.mockCall();
                        render.processResponse(responseText);
                    } catch (error) {
                        console.error('Analysis error:', error);
                        render.showError(error.message);
                    }
                },
                handleNewAnalysis: () => {
                    ui.hideResults();
                    state.activeCharts.forEach(chart => chart.destroy());
                    state.activeCharts = [];
                },
                handleTabClick: (e) => {
                    const targetTab = e.currentTarget.dataset.tab;
                    dom.tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
                    dom.tabContents.forEach(content => content.classList.toggle('hidden', !content.id.includes(targetTab)));
                    ui.updateAnalyzeButton();
                },
                handleImageUpload: (file) => {
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.uploadedFileBase64 = e.target.result;
                        dom.imagePreview.src = e.target.result;
                        dom.imagePreviewContainer.classList.remove('hidden');
                        ui.updateAnalyzeButton();
                    };
                    reader.readAsDataURL(file);
                },
                clearImage: () => {
                    state.uploadedFileBase64 = null;
                    dom.imagePreview.src = '';
                    dom.fileInput.value = '';
                    dom.imagePreviewContainer.classList.add('hidden');
                    ui.updateAnalyzeButton();
                }
            };

            // --- API LOGIC ---
            const api = {
                // This is a mock for demonstration. Replace with your real API call.
                mockCall: async () => new Promise(resolve => setTimeout(() => resolve(`Привет! Рад помочь тебе разобраться в мире питания. Давай посмотрим, что у нас сегодня на повестке дня — печень трески.### 🔍 Быстрая оценка\nПечень трески – это настоящий суперфуд! Она очень питательна, богата полезными жирами, витаминами и минералами. Отлично подойдет тем, кто хочет поддержать здоровье сердечно-сосудистой системы. Однако из-за высокой калорийности ее стоит употреблять умеренно.### 📊 Сравнительная таблица\n| Показатель | Печень трески | Консервированный тунец ||------------|---------------|------------------------|| Калории (100г) | 613 ккал | 184 ккал || Белки | 4.2 г | 29 г || Жиры | 65.7 г | 6.1 г || Углеводы | 1.2 г | 0 г |### 💡 Персональные рекомендации\n- **✅ Подходит:** Людям с дефицитом витамина D и Омега-3.\n- **⚠️ Осторожно:** Людям с заболеваниями печени и желчного пузыря.\n- **🚫 Не рекомендуется:** В больших количествах при высоком уровне холестерина.### 🎯 Практические советы\n- **Лучшее время:** В первой половине дня на бутерброде.\n- **С чем сочетать:** Со свежей зеленью, лимонным соком.### ⭐ Итоговая оценка\n**Рейтинг: 8/10**\nОтличный источник нутриентов, но требует чувства меры.\n\`\`\`json\n{ "products": ["Печень трески", "Тунец"], "calories": [613, 184], "sugar": [0, 0], "fat": [66, 6], "protein": [4, 29], "rating": 8 }\n\`\`\``), 1500)),
                // Real call function would be here
                // callAI: async (userParts) => { ... } 
            };
            
            // --- RENDER LOGIC ---
            const render = {
                processResponse: (text) => {
                    const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
                    const jsonMatch = text.match(jsonRegex);
                    let chartData = null;
                    if (jsonMatch && jsonMatch[1]) {
                        try { chartData = JSON.parse(jsonMatch[1]); } catch (e) { console.error("JSON Parse Error:", e); }
                    }
                    const markdown = text.replace(jsonRegex, '').trim();
                    dom.resultsContent.innerHTML = render.responseToHtml(markdown);
                    if (chartData) render.charts(chartData);
                },
                responseToHtml: (markdown) => {
                    let html = '';
                    const parts = markdown.split(/(###\s.*)/g);
                    if (!parts[0].startsWith('###')) html += `<div class="result-intro">${parts.shift().trim()}</div>`;

                    for(let i = 0; i < parts.length; i += 2) {
                        if (!parts[i] || !parts[i+1]) continue;
                        const header = parts[i].replace('### ', '').trim();
                        const content = parts[i+1].trim();
                        
                        let contentHtml = content
                            .replace(/\|------------\|.*/g, '') // Remove table header line
                            .replace(/\|/g, '</td><td>')
                            .replace(/^<td>(.*?)<\/td><td>(.*?)<\/td><td>/gm, '<tr><th>$1</th><td>$2</td><td>')
                            .replace(/^<td>(.*?)<\/td><td>/gm, '<tr><td>$1</td><td>')
                            .replace(/<\/td>$/gm, '</td></tr>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/-\s(.*?)(?=\n-|$)/g, '<p>$1</p>');
                        
                        if (contentHtml.includes('<tr>')) {
                            contentHtml = `<table class="comparison-table"><tbody>${contentHtml}</tbody></table>`;
                        }
                        
                        html += `<div class="result-section"><div class="section-header">${header}</div>`;
                        if (header.includes('Быстрая оценка')) {
                            const verdictClass = content.toLowerCase().includes('осторожно') ? 'verdict-warning' : content.toLowerCase().includes('не рекоменду') ? 'verdict-danger' : 'verdict-success';
                            html += `<div class="quick-verdict ${verdictClass}">${content}</div>`;
                        } else {
                            html += contentHtml;
                        }
                        html += '</div>';
                    }
                    return html;
                },
                charts: (data) => {
                    const container = document.createElement('div');
                    container.className = 'result-section';
                    container.innerHTML = `<div class="section-header">📈 Сравнительные диаграммы</div><div class="charts-grid"></div>`;
                    dom.resultsContent.appendChild(container);
                    const grid = container.querySelector('.charts-grid');

                    if (data.calories) render.createChart(grid, 'Калории, ккал', 'doughnut', { labels: data.products, datasets: [{ data: data.calories, backgroundColor: ['#6a82fb', '#fc5c7d', '#85e0a3'] }] });
                    if (data.protein) render.createChart(grid, 'Белки, г', 'bar', { labels: data.products, datasets: [{ label: 'Белки', data: data.protein, backgroundColor: '#85e0a3' }] });
                    if (data.fat) render.createChart(grid, 'Жиры, г', 'bar', { labels: data.products, datasets: [{ label: 'Жиры', data: data.fat, backgroundColor: '#ff9500' }] });
                    if (data.sugar) render.createChart(grid, 'Сахар, г', 'bar', { labels: data.products, datasets: [{ label: 'Сахар', data: data.sugar, backgroundColor: '#ff3b30' }] });
                },
                createChart: (grid, title, type, data) => {
                    const card = document.createElement('div');
                    card.className = 'chart-card';
                    card.innerHTML = `<div class="chart-title">${title}</div>`;
                    const canvas = document.createElement('canvas');
                    card.appendChild(canvas);
                    grid.appendChild(card);
                    
                    const chart = new Chart(canvas.getContext('2d'), { type, data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut' } } } });
                    state.activeCharts.push(chart);
                },
                showError: (message) => {
                    dom.resultsContent.innerHTML = `<div class="result-section"><div class="section-header">❌ Ошибка</div><div class="quick-verdict verdict-danger"><strong>Произошла ошибка:</strong> ${message}</div></div>`;
                }
            };

            // --- INITIALIZATION ---
            function init() {
                // Event Listeners
                dom.analyzeBtn.addEventListener('click', handlers.handleAnalyze);
                dom.backBtn.addEventListener('click', handlers.handleNewAnalysis);
                dom.productDescription.addEventListener('input', ui.updateAnalyzeButton);
                dom.tabs.forEach(btn => btn.addEventListener('click', handlers.handleTabClick));
                dom.settingsBtn.addEventListener('click', ui.openSettings);
                dom.closeSettingsBtn.addEventListener('click', ui.closeSettings);
                dom.settingsModal.addEventListener('click', (e) => e.target === dom.settingsModal && ui.closeSettings());
                dom.themeSelect.addEventListener('change', (e) => ui.applyTheme(e.target.value));
                dom.uploadBtn.addEventListener('click', () => dom.fileInput.click());
                dom.fileInput.addEventListener('change', (e) => handlers.handleImageUpload(e.target.files[0]));
                dom.clearImageBtn.addEventListener('click', handlers.clearImage);

                // Initial Setup
                ui.applyTheme(state.currentTheme);
                ui.updateAnalyzeButton();
                if (state.currentTheme === 'auto') {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => ui.applyTheme('auto'));
                }
            }
            init();
        });
    </script>
</body>
</html>
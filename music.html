<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Музыка</title>
    <link rel="icon" id="favicon" href="https://img.icons8.com/?size=100&id=0U7SQQ4MZsdU&format=png&color=000000" type="image/png">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
 :root {
    --primary-color: #1DB954;
    --secondary-color: #1ED760;
    --background-color: #121212;
    --surface-color: #242424;
    --surface-color-transparent: rgba(36, 36, 36, 0.95);
    --hover-color: #2A2A2A;
    --hover-bright-color: rgba(255, 255, 255, 0.1);
    --active-bg-color: rgba(255, 255, 255, 0.06);
    --active-hover-bg-color: rgba(255, 255, 255, 0.12);
    --text-primary: #FFFFFF;
    --text-secondary: #B3B3B3;
    --shadow-color: rgba(0, 0, 0, 0.5);
    --shimmer-color: rgba(255, 255, 255, 0.6);
    --title-glow-color-soft: rgba(255, 255, 255, 0.7);
    --title-glow-color-bright: rgba(255, 255, 255, 0.9);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
}

body {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: var(--background-color);
    color: var(--text-primary);
    overflow: hidden;
}

body.player-fullscreen {
    overflow: hidden;
}

#initial-loader {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    flex-direction: column;
    gap: 15px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--background-color);
    z-index: 200;
    color: var(--text-secondary);
}
#initial-loader i {
     color: var(--primary-color);
}

.equalizer-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.08;
    filter: blur(8px);
    transform: scale(1.1);
    transition: opacity 0.8s ease-in-out, filter 0.8s ease-in-out, transform 0.8s ease-in-out, background 0.8s ease-in-out;
    z-index: 0;
    pointer-events: none;
    background: #000; /* Default background */
}

#equalizer-gif {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block; /* Initially block, JS will control */
    opacity: 0.9;
}

body:not(.player-fullscreen) .equalizer-background {
    opacity: 0.2;
    filter: blur(2px);
    transform: scale(1.05);
}

body.player-fullscreen .equalizer-background {
    opacity: 1;
    filter: blur(0px);
    transform: scale(1);
}

.player-container {
    width: 450px;
    background: var(--surface-color-transparent);
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    overflow: hidden;
    position: relative;
    display: none;
    flex-direction: column;
    transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.5s ease, backdrop-filter 0.5s ease;
    z-index: 10;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

body:not(.player-fullscreen) .player-container {
    background-color: rgba(36, 36, 36, 0.3);
    backdrop-filter: blur(3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

body.player-loaded .player-container {
    display: flex;
}

body.player-fullscreen .player-container {
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    animation: expand-flash-stronger 0.4s ease-out 0.4s forwards;
    transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.5s ease, backdrop-filter 0.5s ease;
}

.player-header {
    padding: 18px 20px;
    background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    color: var(--text-primary);
    text-align: center;
    position: relative;
    flex-shrink: 0;
    z-index: 11;
    transition: all 0.5s ease, background 0.5s ease;
    cursor: pointer;
}

body:not(.player-fullscreen) .player-header {
    background: linear-gradient(to right, rgba(29, 185, 84, 0.7), rgba(30, 215, 96, 0.7));
}

body.player-fullscreen .player-header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0));
    padding-top: 30px;
    z-index: 12;
}

@keyframes pulse-glow {
    0% {
        text-shadow:
            0 1px 3px rgba(0, 0, 0, 0.6),
            0 0 5px var(--title-glow-color-soft),
            0 0 8px var(--title-glow-color-soft);
    }
    50% {
         text-shadow:
            0 1px 3px rgba(0, 0, 0, 0.6),
            0 0 10px var(--title-glow-color-bright),
            0 0 20px var(--title-glow-color-bright);
    }
    100% {
         text-shadow:
            0 1px 3px rgba(0, 0, 0, 0.6),
            0 0 5px var(--title-glow-color-soft),
            0 0 8px var(--title-glow-color-soft);
    }
}

.player-header h2 {
    font-size: 1.3rem; margin-bottom: 3px; font-weight: 600; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; max-width: 90%; margin-left: auto;
    margin-right: auto; letter-spacing: -0.02em; transition: all 0.5s ease;
}

body.player-fullscreen .player-header h2 {
    font-size: 1.8rem;
    transition: all 0.5s ease;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
}

body.player-fullscreen .player-header #song-title {
    animation: pulse-glow 3s ease-in-out infinite;
    color: var(--text-primary);
}

.player-header p {
    font-size: 0.85rem; opacity: 0.9; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; max-width: 90%; margin-left: auto; margin-right: auto;
    font-weight: 400; transition: all 0.5s ease;
}

body.player-fullscreen .player-header p {
    font-size: 1.1rem; opacity: 0.95; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
}

.playlist {
    flex-grow: 1; height: auto; max-height: calc(100vh - 200px); overflow-y: auto;
    padding: 8px 0; display: block; background: rgba(0,0,0,0.15);
    transition: opacity 0.5s ease, visibility 0.5s ease, background 0.5s ease, backdrop-filter 0.5s ease;
    visibility: visible; opacity: 1;
    backdrop-filter: blur(3px) brightness(1.1);
    -webkit-backdrop-filter: blur(3px) brightness(1.1);
}

body:not(.player-fullscreen) .playlist {
    background: rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(1px) brightness(1.05);
}

body.player-fullscreen .playlist {
    opacity: 0; visibility: hidden; pointer-events: none; position: absolute;
    top: -9999px; left: -9999px;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.playlist-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
    color: var(--text-primary);
    border-left: 3px solid transparent;
    margin: 3px 8px;
    border-radius: 8px;
    position: relative;
}

.playlist-item:hover {
    background: var(--hover-bright-color);
}

.playlist-item.active:hover {
    background: var(--active-hover-bg-color);
}

.playlist-item-number {
    font-size: 0.85rem;
    color: var(--text-secondary);
    min-width: 20px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    transition: color 0.2s ease;
    position: relative;
    z-index: 1;
}

.playlist-item-details {
    flex: 1;
    overflow: hidden;
}
.playlist-item-title {
    font-size: 0.95rem; margin-bottom: 3px; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; font-weight: 500; letter-spacing: -0.01em;
    transition: color 0.2s ease, font-weight 0.2s ease;
}

.playlist-item-artist {
    font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s ease;
}

.playlist-item.active {
    background: var(--active-bg-color);
    border-left-color: var(--primary-color);
}

.playlist-item.active .playlist-item-number::before {
    content: '\f028';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: var(--primary-color);
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    opacity: 1;
    transition: opacity 0.3s ease, left 0.3s ease;
    z-index: 0;
}

.playlist-item .playlist-item-number::before {
    content: '\f028';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: var(--primary-color);
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    opacity: 0;
    transition: opacity 0.2s ease, left 0.2s ease 0.1s;
    z-index: 0;
}

.playlist-item.active .playlist-item-number {
    color: var(--text-secondary);
}

.playlist-item.active .playlist-item-title {
     color: var(--text-primary);
     font-weight: 500;
}

.playlist-item.active .playlist-item-artist {
    color: var(--text-secondary);
}

.playlist::-webkit-scrollbar { width: 6px; }
.playlist::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.03); border-radius: 3px; margin: 5px 0; }
.playlist::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
.playlist::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

.controls-container {
    flex-shrink: 0; padding: 15px 20px 20px 20px; background: transparent;
    border-top: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.5s ease;
    z-index: 11;
    position: relative;
}

body:not(.player-fullscreen) .controls-container {
   border-top-color: rgba(255, 255, 255, 0.03);
}

body.player-fullscreen .controls-container {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
    border-top: none; padding-bottom: 40px;
    z-index: 12;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.progress-bar {
    height: 6px; border-radius: 3px; background: rgba(255, 255, 255, 0.1); position: relative;
    cursor: pointer; overflow: hidden; margin-bottom: 8px; max-width: 600px; margin-left: auto;
    margin-right: auto; transition: all 0.5s ease;
}

body.player-fullscreen .progress-bar {
    height: 8px; background: rgba(255, 255, 255, 0.4);
}

@keyframes shimmer-left-to-right {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}

.progress {
    position: absolute; top: 0; left: 0; height: 100%; width: 0%;
    background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    border-radius: 3px; transition: width 0.1s linear;
    position: relative;
    overflow: hidden;
}

.progress::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: linear-gradient(
         90deg,
         rgba(255, 255, 255, 0) 0%,
         rgba(255, 255, 255, 0) 40%,
         var(--shimmer-color) 50%,
         rgba(255, 255, 255, 0) 60%,
         rgba(255, 255, 255, 0) 100%
     );
     background-size: 200% 100%;
     animation: shimmer-left-to-right 2s linear infinite;
     z-index: 1;
     border-radius: 3px;
}

.progress::after {
    content: ''; position: absolute; right: -5px; top: 50%; transform: translateY(-50%) scale(0);
    width: 12px; height: 12px; background-color: var(--text-primary); border-radius: 50%;
    opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5);
    z-index: 2;
}

body.player-fullscreen .progress::after { width: 16px; height: 16px; }
.progress-bar:hover .progress::after { opacity: 1; transform: translateY(-50%) scale(1); }


.time-info {
    display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.75rem;
    margin-top: 4px; font-variant-numeric: tabular-nums; max-width: 600px; margin-left: auto;
    margin-right: auto; transition: all 0.5s ease;
}

body.player-fullscreen .time-info {
    font-size: 0.9rem; color: rgba(255, 255, 255, 0.95); text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
}

.controls {
    display: flex; justify-content: center; align-items: center; padding: 12px 0 0 0; gap: 15px;
    transition: all 0.5s ease;
}

body.player-fullscreen .controls { padding-top: 20px; gap: 30px; }

.control-btn {
    background: transparent; border: none; cursor: pointer; color: var(--text-primary);
    font-size: 1.1rem; width: 42px; height: 42px; border-radius: 50%; display: flex;
    justify-content: center; align-items: center; transition: all 0.2s ease;
    flex-shrink: 0;
}

body.player-fullscreen .control-btn {
    width: 50px; height: 50px; font-size: 1.3rem; background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.control-btn:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.05); }
body.player-fullscreen .control-btn:hover { background: rgba(255, 255, 255, 0.25); }
.control-btn:active { transform: scale(0.95); }

.play-pause-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    width: 55px; height: 55px; box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
}

body.player-fullscreen .play-pause-btn {
    width: 70px; height: 70px; box-shadow: 0 4px 20px rgba(29, 185, 84, 0.6);
}

.play-pause-btn:hover { transform: scale(1.08); background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); box-shadow: 0 6px 15px rgba(29, 185, 84, 0.4); }
body.player-fullscreen .play-pause-btn:hover { box-shadow: 0 6px 25px rgba(29, 185, 84, 0.7); }
.play-pause-btn i { font-size: 1.4rem; transition: transform 0.2s ease; }
body.player-fullscreen .play-pause-btn i { font-size: 1.8rem; }
.play-pause-btn i.fa-play { transform: translateX(2px); }
.play-pause-btn i.fa-pause { transform: translateX(0); }

.mode-btn {
    color: var(--text-secondary);
    font-size: 1rem;
    transition: color 0.2s ease, transform 0.2s ease, opacity 0.4s ease, visibility 0.4s ease;
    opacity: 1;
    visibility: visible;
}

.mode-btn:hover {
    color: var(--text-primary);
}

#mode-btn.active {
    color: var(--primary-color);
}
#mode-btn.active:hover {
    color: var(--secondary-color);
}

body.player-fullscreen .mode-btn {
    opacity: 0;
    visibility: hidden;
    width: 0;
    padding: 0;
    margin: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0s linear 0.3s, width 0.3s ease, padding 0.3s ease, margin 0.3s ease;
}

#refresh-btn i.fa-spin {
    animation: fa-spin 1.5s linear infinite;
}
@keyframes fa-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#volume-feedback {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 8px 15px;
    background: rgba(0, 0, 0, 0.75); color: white; border-radius: 15px; font-size: 14px;
    z-index: 150; opacity: 0; transition: opacity 0.3s ease;
    pointer-events: none;
}

@media (max-width: 768px), (max-height: 600px) {
    .player-container {
        width: 100%;
        height: 100vh;
        border-radius: 0;
        box-sizing: border-box;
        transition: padding-bottom 0.5s ease, background-color 0.5s ease, backdrop-filter 0.5s ease;
    }

    body:not(.player-fullscreen) .player-container {
        padding-bottom: 10vh;
    }

    body.player-fullscreen .controls-container {
        position: absolute;
        bottom: 15%;
        padding-bottom: 20px;
    }

    .controls {
        padding-bottom: 25px;
    }

    body.player-fullscreen .play-pause-btn {
        width: 60px;
        height: 60px;
    }

    body.player-fullscreen .control-btn {
        width: 42px;
        height: 42px;
    }

    .progress-bar {
        margin-bottom: 4px;
    }

    body.player-fullscreen .player-header {
        padding-top: 20px;
    }

    body.player-fullscreen .player-header h2 {
        font-size: 1.5rem;
    }

    body.player-fullscreen .player-header p {
        font-size: 1rem;
    }

    body.player-fullscreen::after {
        content: '';
        display: block;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 10%;
        background: transparent;
        pointer-events: none;
        z-index: 9;
    }
}

@media (max-height: 480px) {
    body.player-fullscreen .controls-container {
        bottom: 10%;
    }

    body.player-fullscreen .play-pause-btn {
        width: 50px;
        height: 50px;
    }

    body.player-fullscreen .play-pause-btn i {
        font-size: 1.4rem;
    }

    .controls {
        gap: 15px;
        padding-top: 10px;
    }
}

@supports (padding: max(0px)) {
    body.player-fullscreen .controls-container {
        padding-bottom: max(40px, env(safe-area-inset-bottom, 40px));
    }
}

@keyframes expand-flash {
    0% {
        box-shadow: 0 20px 40px var(--shadow-color);
        transform: scale(1);
    }
    70% {
        box-shadow: 0 0 60px 25px rgba(30, 215, 96, 0.7),
                    0 0 20px 10px rgba(255, 255, 255, 0.5),
                    0 0 0 rgba(0,0,0,0);
        transform: scale(1.01);
    }
    100% {
        box-shadow: none;
        transform: scale(1);
    }
}

@keyframes expand-flash-stronger {
    0% {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        transform: scale(1);
        opacity: 1;
    }
    70% {
        box-shadow: 0 0 90px 50px rgba(46, 227, 120, 0.9),
                    0 0 40px 20px rgba(255, 255, 255, 0.9),
                    0 0 0 rgba(0,0,0,0);
        transform: scale(1.02);
        opacity: 1;
    }
    100% {
        box-shadow: none;
        transform: scale(1);
        opacity: 1;
    }
}

</style>
</head>
<body>
    <div id="initial-loader">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p>Загрузка плеера...</p>
    </div>

    <div class="equalizer-background" id="equalizer-background">
        <img id="equalizer-gif" src="" alt="Equalizer Animation">
    </div>

    <div class="player-container" id="player-container">
        <div class="player-header">
            <h2 id="song-title">Музыкальный плеер</h2>
            <p id="song-artist">Загрузка треков...</p>
        </div>

        <div class="playlist" id="playlist">
             <div class="playlist-item" style="justify-content: center; color: var(--text-secondary); font-style: italic; padding: 20px;">Загрузка плейлиста...</div>
        </div>

        <div class="controls-container">
            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn mode-btn" id="refresh-btn" title="Обновить плейлист">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn" id="prev-btn" title="Предыдущий трек"><i class="fas fa-backward"></i></button>
                <button class="control-btn play-pause-btn" id="play-pause-btn" title="Воспроизвести/Пауза"><i class="fas fa-play"></i></button>
                <button class="control-btn" id="next-btn" title="Следующий трек"><i class="fas fa-forward"></i></button>
                <button class="control-btn mode-btn" id="mode-btn" title="Режим воспроизведения: по порядку">
                    <i class="fas fa-repeat"></i>
                </button>
            </div>
        </div>
    </div>
           <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://yabhafljpgxexeehnufk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhYmhhZmxqcGd4ZXhlZWhudWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MTg1MjEsImV4cCI6MjA2MTA5NDUyMX0.f5ESSDiU28ErCNGpkN9Sx3svV-Ll08UZOhb5kF-_BTo';
            const BUCKET_NAME = 'mp3';
            const LOCAL_STORAGE_PLAYLIST_KEY = 'supabase_player_playlist_v2';
            const LOCAL_STORAGE_PLAY_MODE_KEY = 'supabase_player_play_mode';
            const LOCAL_STORAGE_VOLUME_KEY = 'supabase_player_volume';
            const LOCAL_STORAGE_PLAYBACK_STATE_KEY = 'supabase_player_playback_state';
            const LOCAL_STORAGE_BACKGROUND_TYPE_KEY = 'supabase_player_background_type'; // New
            const LOCAL_STORAGE_BACKGROUND_GRADIENT_KEY = 'supabase_player_background_gradient'; // New

            const EQ_GIF_URL = 'https://i.ibb.co/B202YnmZ/eq.gif';
            const TRANSPARENT_FAVICON = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            const FADE_OUT_DURATION_SKIP = 300; // Reduced for quicker skip
            const FADE_OUT_DURATION_PAUSE = 500;
            const FADE_INTERVAL_MS = 50;


            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const initialLoader = document.getElementById('initial-loader');
            const playerContainer = document.getElementById('player-container');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = playPauseBtn.querySelector('i');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const songTitleEl = document.getElementById('song-title');
            const songArtistEl = document.getElementById('song-artist');
            const equalizerBackground = document.getElementById('equalizer-background');
            const equalizerGif = document.getElementById('equalizer-gif');
            const playlistEl = document.getElementById('playlist');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const refreshBtn = document.getElementById('refresh-btn');
            const modeBtn = document.getElementById('mode-btn');
            const favicon = document.getElementById('favicon');
            const playerHeader = document.querySelector('.player-header');


            let songs = [];
            let currentSongIndex = 0;
            let isPlaying = false;
            const audio = new Audio();
            audio.preload = "metadata";
            let gifLoadStatus = 'pending'; // 'pending', 'success', 'error'
            let playMode = 'repeat';
            let originalFaviconHref = favicon.href;
            let faviconBlinkInterval = null;
            let isFaviconVisible = true;
            let fadeOutInterval = null;
            let savedTimeForCurrentSong = null;

            let currentBackgroundType = 'gif'; // 'gif' or 'gradient'
            let currentGradient = ''; // Stores the CSS for the current gradient if type is 'gradient'

            function clearFadeOut() {
                if (fadeOutInterval) {
                    clearInterval(fadeOutInterval);
                    fadeOutInterval = null;
                }
            }

            function fadeOutAndExecute(audioElement, duration, callback) {
                clearFadeOut();
                const startVolume = audioElement.volume;
                if (startVolume <= 0) {
                    audioElement.pause();
                    if (callback) callback();
                    return;
                }
                const steps = duration / FADE_INTERVAL_MS;
                const volumeStep = startVolume / steps;
                fadeOutInterval = setInterval(() => {
                    let newVolume = audioElement.volume - volumeStep;
                    if (newVolume <= 0) {
                        newVolume = 0;
                        audioElement.volume = newVolume;
                        audioElement.pause();
                        clearFadeOut();
                        if (callback) callback();
                    } else {
                        audioElement.volume = newVolume;
                    }
                }, FADE_INTERVAL_MS);
            }

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds === Infinity || seconds < 0) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // --- Background Management ---
            function loadBackgroundState() {
                try {
                    const savedType = localStorage.getItem(LOCAL_STORAGE_BACKGROUND_TYPE_KEY);
                    if (savedType === 'gradient' || savedType === 'gif') {
                        currentBackgroundType = savedType;
                    }
                    if (currentBackgroundType === 'gradient') {
                        const savedGradient = localStorage.getItem(LOCAL_STORAGE_BACKGROUND_GRADIENT_KEY);
                        if (savedGradient) {
                            currentGradient = savedGradient;
                        } else {
                            // Fallback: if type is gradient but no gradient is saved, generate one
                            currentGradient = generateRandomGradient();
                            // No need to save here, setBackground will handle if it's a new gradient
                        }
                    }
                } catch (e) {
                    console.error("Error loading background state:", e);
                    currentBackgroundType = 'gif'; // Default fallback
                    currentGradient = '';
                }
            }

            function saveBackgroundState() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_BACKGROUND_TYPE_KEY, currentBackgroundType);
                    if (currentBackgroundType === 'gradient') {
                        localStorage.setItem(LOCAL_STORAGE_BACKGROUND_GRADIENT_KEY, currentGradient);
                    } else {
                        localStorage.removeItem(LOCAL_STORAGE_BACKGROUND_GRADIENT_KEY); // Clean up if not gradient
                    }
                } catch (e) {
                    console.error("Error saving background state:", e);
                }
            }

            function generateRandomGradient() {
                const angle = Math.floor(Math.random() * 360);
                const numColors = Math.floor(Math.random() * 3) + 2; // 2 to 4 colors
                const colors = [];
                for (let i = 0; i < numColors; i++) {
                    colors.push(getRandomColor());
                }
                return `linear-gradient(${angle}deg, ${colors.join(', ')})`;
            }

            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            function setBackground(type, forceNewGradient = false) {
                currentBackgroundType = type; // Update the global state

                if (type === 'gif') {
                    if (gifLoadStatus === 'success') {
                        equalizerGif.src = EQ_GIF_URL;
                        equalizerGif.alt = 'Equalizer Animation';
                        equalizerGif.style.display = 'block';
                        equalizerBackground.style.background = ''; // Clear gradient
                        equalizerBackground.style.backgroundImage = '';
                        equalizerBackground.style.backgroundColor = '#000'; // Default behind GIF
                    } else { // GIF failed or pending
                        equalizerGif.src = '';
                        equalizerGif.alt = ''; // Hide alt text by hiding image
                        equalizerGif.style.display = 'none';
                        equalizerBackground.style.background = '#000'; // Fallback solid color
                        equalizerBackground.style.backgroundImage = '';
                        equalizerBackground.style.backgroundColor = '#000';
                    }
                } else if (type === 'gradient') {
                    if (forceNewGradient || !currentGradient) {
                        currentGradient = generateRandomGradient();
                    }
                    equalizerGif.src = '';
                    equalizerGif.alt = ''; // Hide alt text
                    equalizerGif.style.display = 'none';
                    equalizerBackground.style.background = currentGradient;
                    equalizerBackground.style.backgroundImage = currentGradient;
                    equalizerBackground.style.backgroundColor = 'transparent';
                }
                // player-fullscreen class on body is handled by playSong/pauseSong
            }
            // --- End Background Management ---


            function getNextSongIndex() {
                if (songs.length <= 1) return 0;
                if (playMode === 'shuffle') {
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * songs.length);
                    } while (randomIndex === currentSongIndex);
                    return randomIndex;
                } else {
                    return (currentSongIndex + 1) % songs.length;
                }
            }

            function getPreviousSongIndex() {
                if (songs.length <= 1) return 0;
                if (playMode === 'shuffle') {
                     let randomIndex;
                     do {
                         randomIndex = Math.floor(Math.random() * songs.length);
                     } while (randomIndex === currentSongIndex);
                     return randomIndex;
                } else {
                    return (currentSongIndex - 1 + songs.length) % songs.length;
                }
            }

            function playPause() {
                 if (songs.length === 0) return;
                 if (isPlaying) {
                     pauseSong();
                 } else {
                     playSong();
                 }
             }

             function playSong() {
                 if (songs.length === 0) return;
                 clearFadeOut();

                 let targetVolume = 1.0;
                 try {
                     const savedVolume = localStorage.getItem(LOCAL_STORAGE_VOLUME_KEY);
                     if (savedVolume !== null) {
                         const parsedVolume = parseFloat(savedVolume);
                         if (!isNaN(parsedVolume) && parsedVolume >= 0 && parsedVolume <= 1) {
                             targetVolume = parsedVolume;
                         }
                     }
                 } catch (e) { console.error("Error reading volume for restore:", e); }
                 audio.volume = targetVolume;

                 // Ensure correct background is set before applying fullscreen
                 setBackground(currentBackgroundType); // Re-apply, handles GIF status

                 if ((currentBackgroundType === 'gif' && gifLoadStatus === 'success') || currentBackgroundType === 'gradient') {
                     document.body.classList.add('player-fullscreen');
                 } else {
                     document.body.classList.remove('player-fullscreen');
                 }

                 playerContainer.classList.add('playing');
                 playIcon.classList.remove('fa-play');
                 playIcon.classList.add('fa-pause');
                 playPauseBtn.title = "Пауза";

                 audio.play().then(() => {
                     isPlaying = true;
                     startFaviconBlink();
                 }).catch(error => {
                     console.error("Error playing audio:", error);
                     playerContainer.classList.remove('playing');
                     document.body.classList.remove('player-fullscreen');
                     playIcon.classList.remove('fa-pause');
                     playIcon.classList.add('fa-play');
                     playPauseBtn.title = "Воспроизвести";
                     isPlaying = false;
                     stopFaviconBlink();
                 });
             }

             function pauseSong(useFade = true, fadeDuration = FADE_OUT_DURATION_PAUSE) {
                 if (!isPlaying) return;

                 stopFaviconBlink();
                 playerContainer.classList.remove('playing');
                 document.body.classList.remove('player-fullscreen'); // This triggers CSS for non-fullscreen background
                 playIcon.classList.remove('fa-pause');
                 playIcon.classList.add('fa-play');
                 playPauseBtn.title = "Воспроизвести";

                 isPlaying = false;

                 if (useFade && audio.volume > 0) {
                     fadeOutAndExecute(audio, fadeDuration, () => {});
                 } else {
                     clearFadeOut();
                     audio.pause();
                 }
             }


            async function initializePlayer() {
                loadPlayMode();
                loadVolume();
                loadBackgroundState(); // Load background type and gradient
                stopFaviconBlink();

                const gifPromise = preloadEqualizerGif();
                const playlistPromise = loadPlaylistData();

                // Wait for GIF to load/fail before setting initial background
                await gifPromise;
                setBackground(currentBackgroundType); // Set initial background based on loaded state and GIF status

                const [, playlistResult] = await Promise.allSettled([Promise.resolve(), playlistPromise]);


                if (playlistResult.status === 'rejected' || songs.length === 0) {
                    console.error("Playlist loading failed or is empty.");
                    setNoTracksState();
                } else {
                    const savedState = loadPlaybackState();
                    let initialIndex = 0;
                    if (savedState && savedState.index !== undefined && savedState.index >= 0 && savedState.index < songs.length) {
                        initialIndex = savedState.index;
                        savedTimeForCurrentSong = savedState.time;
                    } else {
                         loadLastSelectedSongIndex();
                         initialIndex = currentSongIndex;
                    }
                    currentSongIndex = initialIndex;

                    renderPlaylist(true);
                    if (songs.length > 0 && currentSongIndex >= 0 && currentSongIndex < songs.length) {
                        loadSong(songs[currentSongIndex]);
                    } else {
                        currentSongIndex = 0;
                        saveCurrentSongIndex();
                        if (songs.length > 0) {
                           loadSong(songs[0]);
                           updateActivePlaylistItem(true);
                        } else {
                            setNoTracksState();
                        }
                    }
                }

                updateModeButton();
                initialLoader.style.display = 'none';
                document.body.classList.add('player-loaded');
                setupVolumeControl();
                setupDoubleClickPause();
            }

            function loadLastSelectedSongIndex() {
                try {
                    const savedIndex = localStorage.getItem('supabase_player_current_song_index');
                    if (savedIndex !== null) {
                        const parsedIndex = parseInt(savedIndex);
                        if (!isNaN(parsedIndex) && parsedIndex >= 0 && parsedIndex < songs.length) {
                             currentSongIndex = parsedIndex;
                             return;
                        }
                    }
                    currentSongIndex = 0;
                } catch (e) {
                    console.error("Error loading legacy song index:", e);
                    currentSongIndex = 0;
                }
            }

            function saveCurrentSongIndex() {
                // Primarily for legacy, main state saved by savePlaybackState
                 try {
                     if (songs && songs.length > 0) {
                        // localStorage.setItem('supabase_player_current_song_index', currentSongIndex.toString());
                     }
                 } catch (e) { console.error("Error saving current song index:", e); }
            }

            function savePlaybackState() {
                 try {
                     if (songs && songs.length > 0) {
                         const stateToSave = {
                             index: currentSongIndex,
                             time: audio.currentTime
                         };
                         localStorage.setItem(LOCAL_STORAGE_PLAYBACK_STATE_KEY, JSON.stringify(stateToSave));
                     } else {
                         localStorage.removeItem(LOCAL_STORAGE_PLAYBACK_STATE_KEY);
                     }
                 } catch (e) { console.error("Error saving playback state:", e); }
            }

            function loadPlaybackState() {
                 try {
                     const savedState = localStorage.getItem(LOCAL_STORAGE_PLAYBACK_STATE_KEY);
                     if (savedState) {
                         const parsedState = JSON.parse(savedState);
                         if (parsedState && typeof parsedState.index === 'number' && typeof parsedState.time === 'number') {
                             return parsedState;
                         }
                     }
                 } catch (e) {
                     console.error("Error loading playback state:", e);
                     localStorage.removeItem(LOCAL_STORAGE_PLAYBACK_STATE_KEY);
                 }
                 return null;
            }

            function saveVolume(volume) {
                try {
                    localStorage.setItem(LOCAL_STORAGE_VOLUME_KEY, volume.toString());
                } catch (e) { console.error("Error saving volume:", e); }
            }

            function loadVolume() {
                let targetVolume = 1.0;
                try {
                    const savedVolume = localStorage.getItem(LOCAL_STORAGE_VOLUME_KEY);
                    if (savedVolume !== null) {
                        const parsedVolume = parseFloat(savedVolume);
                        if (!isNaN(parsedVolume) && parsedVolume >= 0 && parsedVolume <= 1) {
                            targetVolume = parsedVolume;
                        }
                    }
                } catch (e) { console.error("Error loading volume:", e); }
                audio.volume = targetVolume;
            }


            function preloadEqualizerGif() {
                gifLoadStatus = 'pending';
                return new Promise((resolve) => {
                    // Check if already loaded and src is correct
                    if (equalizerGif.src === EQ_GIF_URL && equalizerGif.complete && equalizerGif.naturalWidth > 0) {
                       gifLoadStatus = 'success';
                       resolve();
                       return;
                    }
                    const img = new Image();
                    img.src = EQ_GIF_URL;
                    img.onload = () => {
                        gifLoadStatus = 'success';
                        resolve();
                    };
                    img.onerror = (err) => {
                        console.error("Failed to load equalizer GIF:", err);
                        gifLoadStatus = 'error';
                        resolve(); // Resolve even on error, so init continues
                    };
                    // Handle cached images that might fire 'complete' before 'onload' is attached
                    if (img.complete && img.naturalWidth > 0) {
                       gifLoadStatus = 'success'; // Should be set in onload, but as a fallback
                       resolve();
                    } else if (img.complete && img.naturalWidth === 0){ // Cached but failed
                        gifLoadStatus = 'error';
                        resolve();
                    }
                });
            }

            async function loadPlaylistData() {
                 const loadedFromStorage = loadSavedPlaylist();
                 if (!loadedFromStorage || songs.length === 0) {
                     await fetchAllSupabaseSongs();
                 }
                 if (!Array.isArray(songs)) {
                     songs = [];
                     throw new Error("Playlist data is not an array.");
                 }
                 setTimeout(() => { updateActivePlaylistItem(true); }, 100);
            }

            function loadSong(song) {
                 if (!song) { setNoTracksState(); return; }
                 clearFadeOut();
                 songTitleEl.textContent = song.title || 'Unknown Title';
                 songArtistEl.textContent = song.artist || 'Unknown Artist';
                 document.title = `${song.title || 'Music'} - ${song.artist || 'Player'}`;
                 audio.src = song.url;
                 audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
                 audio.addEventListener('loadedmetadata', handleLoadedMetadata);
                 updateProgressDirect(0, 0);
                 durationEl.textContent = "0:00";
                 updateActivePlaylistItem();
                 if (!isPlaying) {
                     stopFaviconBlink();
                     playIcon.classList.remove('fa-pause');
                     playIcon.classList.add('fa-play');
                     playPauseBtn.title = "Воспроизвести";
                     playerContainer.classList.remove('playing');
                     document.body.classList.remove('player-fullscreen');
                 }
                 savePlaybackState();
            }

            function handleLoadedMetadata() {
                 updateProgressDirect(audio.currentTime, audio.duration);
                 if (savedTimeForCurrentSong !== null && isFinite(audio.duration) && savedTimeForCurrentSong < audio.duration) {
                     audio.currentTime = savedTimeForCurrentSong;
                     updateProgressDirect(audio.currentTime, audio.duration);
                 }
                 savedTimeForCurrentSong = null;
                 audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
            }


            function nextSong() {
                if (songs.length === 0) return;
                clearFadeOut();
                const wasPlaying = isPlaying;
                const nextIndex = getNextSongIndex();
                if (wasPlaying) {
                    stopFaviconBlink();
                    fadeOutAndExecute(audio, FADE_OUT_DURATION_SKIP, () => {
                        currentSongIndex = nextIndex;
                        loadSong(songs[currentSongIndex]);
                        playSong();
                    });
                } else {
                    currentSongIndex = nextIndex;
                    loadSong(songs[currentSongIndex]);
                }
            }

            function prevSong() {
                if (songs.length === 0) return;
                clearFadeOut();
                const wasPlaying = isPlaying;
                if (audio.currentTime > 3 && playMode === 'repeat' && wasPlaying) {
                    audio.currentTime = 0;
                    updateProgressDirect(audio.currentTime, audio.duration);
                    if (!playerContainer.classList.contains('playing')) { playSong(); }
                    savePlaybackState();
                    return;
                }
                const prevIndex = getPreviousSongIndex();
                if (wasPlaying) {
                    stopFaviconBlink();
                    fadeOutAndExecute(audio, FADE_OUT_DURATION_SKIP, () => {
                        currentSongIndex = prevIndex;
                        loadSong(songs[currentSongIndex]);
                        playSong();
                    });
                } else {
                    currentSongIndex = prevIndex;
                    loadSong(songs[currentSongIndex]);
                }
            }

            function togglePlayMode() {
                playMode = (playMode === 'repeat') ? 'shuffle' : 'repeat';
                savePlayMode();
                updateModeButton();
            }

            function updateModeButton() {
                const modeIcon = modeBtn.querySelector('i');
                if (playMode === 'repeat') {
                    modeIcon.classList.remove('fa-random'); modeIcon.classList.add('fa-repeat');
                    modeBtn.classList.remove('active');
                    modeBtn.title = "Режим воспроизведения: по порядку";
                } else {
                    modeIcon.classList.remove('fa-repeat'); modeIcon.classList.add('fa-random');
                    modeBtn.classList.add('active');
                    modeBtn.title = "Режим воспроизведения: случайный";
                }
            }

            function savePlayMode() {
                try { localStorage.setItem(LOCAL_STORAGE_PLAY_MODE_KEY, playMode); }
                catch (e) { console.error("Error saving play mode:", e); }
            }

            function loadPlayMode() {
                try {
                    const savedMode = localStorage.getItem(LOCAL_STORAGE_PLAY_MODE_KEY);
                    playMode = (savedMode === 'shuffle') ? 'shuffle' : 'repeat';
                } catch (e) { console.error("Error loading play mode:", e); playMode = 'repeat'; }
            }

            function updateProgress(e) {
                 if (audio.readyState >= 2 && audio.duration && isFinite(audio.duration)) {
                    updateProgressDirect(e.srcElement.currentTime, e.srcElement.duration);
                 } else if (isPlaying) {
                     updateProgressDirect(0, 0);
                 }
            }

             function updateProgressDirect(currentTime, duration) {
                 const current = isNaN(currentTime) || currentTime < 0 ? 0 : currentTime;
                 const total = isNaN(duration) || duration <= 0 ? 0 : duration;
                 if (total > 0) {
                     progress.style.width = `${Math.min(100, Math.max(0, (current / total) * 100))}%`;
                     currentTimeEl.textContent = formatTime(current);
                     const newDurationText = formatTime(total);
                     if (durationEl.textContent !== newDurationText) durationEl.textContent = newDurationText;
                 } else {
                     progress.style.width = '0%';
                     currentTimeEl.textContent = formatTime(current);
                     durationEl.textContent = '0:00';
                 }
             }

             function setProgress(e) {
                 if (!audio.duration || isNaN(audio.duration) || audio.duration <= 0) return;
                 clearFadeOut();
                 const progressBarRect = progressBar.getBoundingClientRect();
                 const clickX = e.clientX - progressBarRect.left;
                 const width = progressBarRect.width;
                 if (width > 0) {
                     const seekRatio = Math.max(0, Math.min(1, clickX / width));
                     const newTime = seekRatio * audio.duration;
                     if (isFinite(newTime)) {
                         audio.currentTime = newTime;
                         updateProgressDirect(audio.currentTime, audio.duration);
                         if (audio.volume < 1 && !isPlaying) { loadVolume(); }
                         savePlaybackState();
                     }
                 }
            }

            function renderPlaylist(isInitial = false) {
                playlistEl.innerHTML = '';
                if (songs.length === 0) {
                    playlistEl.innerHTML = `<div class="playlist-item" style="justify-content: center; color: var(--text-secondary); font-style: italic; padding: 20px;">Плейлист пуст. Нажмите <i class="fas fa-sync-alt" style="margin: 0 5px;"></i> для загрузки.</div>`;
                    return;
                }
                songs.forEach((song, index) => {
                    const item = document.createElement('div');
                    item.classList.add('playlist-item');
                    item.dataset.index = index;
                    if (index === currentSongIndex) item.classList.add('active');
                    const title = song.title || 'Unnamed Track';
                    const artist = song.artist || 'Unknown Artist';
                    item.innerHTML = `
                        <div class="playlist-item-number">${index + 1}</div>
                        <div class="playlist-item-details">
                            <div class="playlist-item-title" title="${title} - ${artist}">${title}</div>
                            <div class="playlist-item-artist">${artist}</div>
                        </div>`;
                    item.addEventListener('click', () => {
                         if (currentSongIndex !== index) {
                             currentSongIndex = index;
                             loadSong(songs[currentSongIndex]);
                             playSong();
                         } else { playPause(); }
                    });
                    playlistEl.appendChild(item);
                });
                 scrollToActiveItem(isInitial);
            }

            function scrollToActiveItem(isInitialLoad = false) {
                if (playlistEl.offsetParent === null) return;
                setTimeout(() => {
                    const activeItem = playlistEl.querySelector('.playlist-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({
                            behavior: isInitialLoad ? 'auto' : 'smooth',
                            block: isInitialLoad ? 'center' : 'nearest',
                        });
                    }
                }, isInitialLoad ? 50 : 0);
            }

            function updateActivePlaylistItem(isInitialLoad = false) {
                const items = playlistEl.querySelectorAll('.playlist-item[data-index]');
                items.forEach(item => {
                    const itemIndex = parseInt(item.dataset.index, 10);
                    item.classList.toggle('active', itemIndex === currentSongIndex);
                });
                if (isInitialLoad !== false) scrollToActiveItem(isInitialLoad);
            }

             function setNoTracksState() {
                 songTitleEl.textContent = "Плейлист пуст";
                 songArtistEl.textContent = "Нажмите обновить";
                 document.title = "Музыкальный плеер";
                 updateProgressDirect(0, 0);
                 renderPlaylist();
                 if (isPlaying) pauseSong(false);
                 songs = []; currentSongIndex = 0;
                 stopFaviconBlink();
                 playIcon.classList.remove('fa-pause'); playIcon.classList.add('fa-play');
                 playerContainer.classList.remove('playing');
                 document.body.classList.remove('player-fullscreen');
                 savePlaybackState();
             }

            async function fetchAllSupabaseSongs() {
                const refreshIcon = refreshBtn.querySelector('i');
                refreshIcon?.classList.add('fa-spin');
                refreshBtn.disabled = true;
                let fetchedSongs = [];

                 try {
                     const { data, error } = await supabaseClient.storage
                         .from(BUCKET_NAME)
                         .list('', { limit: 1000, offset: 0, sortBy: { column: 'name', order: 'asc' } });
                     if (error) throw error;

                     if (data && data.length > 0) {
                         const audioFiles = data.filter(file =>
                             file.name.toLowerCase().match(/\.(mp3|wav|ogg|m4a|flac)$/i) && !file.name.startsWith('.')
                         );
                         for (const file of audioFiles) {
                             const { data: urlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(file.name);
                             if (urlData && urlData.publicUrl) {
                                 let baseName = file.name.replace(/\.[^.]+$/i, '');
                                 let title = baseName, artist = 'Unknown Artist';
                                 const parts = baseName.split(' - ');
                                 if (parts.length > 1) { artist = parts[0].trim(); title = parts.slice(1).join(' - ').trim(); }
                                 fetchedSongs.push({ title: title || 'Unnamed Track', artist, url: urlData.publicUrl, type: 'supabase' });
                             }
                         }
                     }
                     fetchedSongs.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));
                     songs = fetchedSongs;
                     savePlaylist();

                     if (songs.length > 0) {
                         currentSongIndex = 0; savedTimeForCurrentSong = null;
                         savePlaybackState(); renderPlaylist(true);
                         loadSong(songs[currentSongIndex]); pauseSong(false);
                         playIcon.classList.remove('fa-pause'); playIcon.classList.add('fa-play');
                         playerContainer.classList.remove('playing');
                         document.body.classList.remove('player-fullscreen');
                         // Background state (currentBackgroundType) persists; setBackground not needed here
                         // as play/pause will handle fullscreen class which CSS uses.
                     } else {
                         setNoTracksState();
                     }
                 } catch (error) {
                     console.error("Error fetching Supabase songs:", error);
                     const fallbackLoaded = loadSavedPlaylist();
                     if (fallbackLoaded && songs.length > 0) {
                         songArtistEl.textContent = "Ошибка загрузки, исп. кэш";
                         const savedState = loadPlaybackState();
                         let fallbackIndex = 0;
                         if (savedState && savedState.index !== undefined && savedState.index >= 0 && savedState.index < songs.length) {
                             fallbackIndex = savedState.index; savedTimeForCurrentSong = savedState.time;
                         } else { savedTimeForCurrentSong = null; }
                         currentSongIndex = fallbackIndex; savePlaybackState();
                         renderPlaylist(true);
                         if(currentSongIndex >= 0 && currentSongIndex < songs.length) loadSong(songs[currentSongIndex]);
                         else { currentSongIndex = 0; savedTimeForCurrentSong = null; savePlaybackState(); loadSong(songs[0]); }
                         pauseSong(false);
                     } else {
                         songArtistEl.textContent = "Ошибка загрузки"; setNoTracksState();
                     }
                 } finally {
                     refreshIcon?.classList.remove('fa-spin'); refreshBtn.disabled = false;
                 }
            }

            function savePlaylist() {
                 try {
                     const savableSongs = songs.filter(s => s && s.type === 'supabase' && s.url && s.title);
                     if (savableSongs.length > 0) {
                        localStorage.setItem(LOCAL_STORAGE_PLAYLIST_KEY, JSON.stringify({ songs: savableSongs, timestamp: Date.now() }));
                     } else { localStorage.removeItem(LOCAL_STORAGE_PLAYLIST_KEY); }
                 } catch (e) { console.error("Error saving playlist:", e); }
            }

            function loadSavedPlaylist() {
                 try {
                     const savedData = localStorage.getItem(LOCAL_STORAGE_PLAYLIST_KEY);
                     if (savedData) {
                         const parsedData = JSON.parse(savedData);
                         if (parsedData && Array.isArray(parsedData.songs)) {
                             const validSongs = parsedData.songs.filter(s => s && s.url && s.type === 'supabase' && s.title);
                             if (validSongs.length > 0) { songs = validSongs; return true; }
                         }
                     }
                 } catch (e) { console.error("Error loading saved playlist:", e); localStorage.removeItem(LOCAL_STORAGE_PLAYLIST_KEY); }
                 songs = []; return false;
            }

            function setupVolumeControl() {
                 document.body.addEventListener('wheel', handleVolumeScroll, { passive: false });
            }

            function handleVolumeScroll(event) {
                 if (!document.body.classList.contains('player-fullscreen') || !audio || songs.length === 0 || audio.readyState < 1) return;
                 event.preventDefault(); clearFadeOut();
                 const scrollDelta = Math.sign(event.deltaY), volumeStep = 0.05;
                 let newVolume = audio.volume + (scrollDelta < 0 ? volumeStep : -volumeStep);
                 newVolume = Math.max(0, Math.min(1, newVolume));
                 audio.volume = newVolume; saveVolume(newVolume);
                 showVolumeFeedback(Math.round(audio.volume * 100));
             }

             let volumeFeedbackTimeout;
             function showVolumeFeedback(volumePercent) {
                 let feedbackEl = document.getElementById('volume-feedback');
                 if (!feedbackEl) {
                     feedbackEl = document.createElement('div'); feedbackEl.id = 'volume-feedback';
                     document.body.appendChild(feedbackEl);
                 }
                 feedbackEl.textContent = `Громкость: ${volumePercent}%`; feedbackEl.style.opacity = '1';
                 clearTimeout(volumeFeedbackTimeout);
                 volumeFeedbackTimeout = setTimeout(() => { feedbackEl.style.opacity = '0'; }, 1500);
             }

            function startFaviconBlink() {
                if (faviconBlinkInterval) return;
                isFaviconVisible = true; favicon.href = originalFaviconHref;
                faviconBlinkInterval = setInterval(() => {
                    isFaviconVisible = !isFaviconVisible;
                    favicon.href = isFaviconVisible ? originalFaviconHref : TRANSPARENT_FAVICON;
                }, 800);
            }

            function stopFaviconBlink() {
                if (faviconBlinkInterval) { clearInterval(faviconBlinkInterval); faviconBlinkInterval = null; }
                if (favicon.href !== originalFaviconHref) favicon.href = originalFaviconHref;
                isFaviconVisible = true;
            }

            function setupDoubleClickPause() {
                document.body.addEventListener('dblclick', handleBodyDoubleClick);
            }

            function handleBodyDoubleClick(event) {
                if (event.target.closest('.controls, .progress-bar, .playlist-item, .player-header')) return;
                if (isPlaying && document.body.classList.contains('player-fullscreen')) {
                    pauseSong(true, FADE_OUT_DURATION_PAUSE);
                } else if (!isPlaying && !document.body.classList.contains('player-fullscreen') && songs.length > 0) {
                    playSong();
                }
            }

            // --- Event Listeners ---
            playPauseBtn.addEventListener('click', playPause);
            nextBtn.addEventListener('click', nextSong);
            prevBtn.addEventListener('click', prevSong);
            progressBar.addEventListener('click', setProgress);
            modeBtn.addEventListener('click', togglePlayMode);

            refreshBtn.addEventListener('click', async () => {
                if (refreshBtn.disabled) return;
                if (isPlaying) pauseSong(false);
                songArtistEl.textContent = "Обновление...";
                await fetchAllSupabaseSongs();
            });

            playerHeader.addEventListener('dblclick', () => {
                if (songs.length === 0) return;

                let newType;
                let forceNewGradientOnSet = false;

                if (currentBackgroundType === 'gif') {
                    newType = 'gradient';
                    forceNewGradientOnSet = true; // Generate a new gradient when switching to this mode
                } else {
                    newType = 'gif';
                }

                setBackground(newType, forceNewGradientOnSet);
                saveBackgroundState(); // Save the toggled state

                // If playing, ensure fullscreen is correctly applied based on new background
                if (isPlaying) {
                    if ((currentBackgroundType === 'gif' && gifLoadStatus === 'success') || currentBackgroundType === 'gradient') {
                        document.body.classList.add('player-fullscreen');
                    } else {
                        document.body.classList.remove('player-fullscreen');
                    }
                }
                // If not playing, fullscreen class is already removed by pauseSong(), CSS handles appearance.
            });


            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('error', (e) => {
                 clearFadeOut(); console.error("Audio error:", e, audio.error);
                 songArtistEl.textContent = `Ошибка: ${songs[currentSongIndex]?.title || 'Трек'}`;
                 stopFaviconBlink(); playerContainer.classList.remove('playing');
                 document.body.classList.remove('player-fullscreen');
                 playIcon.classList.remove('fa-pause'); playIcon.classList.add('fa-play');
                 playPauseBtn.title = "Воспроизвести"; isPlaying = false; savePlaybackState();
                 if (songs.length > 1) {
                     setTimeout(() => {
                         currentSongIndex = getNextSongIndex();
                         loadSong(songs[currentSongIndex]); playSong();
                     }, 2000);
                 } else { setNoTracksState(); }
             });
            audio.addEventListener('ended', () => {
                clearFadeOut(); currentSongIndex = getNextSongIndex();
                loadSong(songs[currentSongIndex]); playSong();
            });
            document.addEventListener('mousedown', (event) => {
                if (event.button === 1) { event.preventDefault(); nextSong(); }
            });
            window.addEventListener('beforeunload', savePlaybackState);
            window.addEventListener('pagehide', savePlaybackState);

            initializePlayer();
        });
    </script>

</body>
</html>
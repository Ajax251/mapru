<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–§–æ—Ç–æ–∞–ª—å–±–æ–º</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéûÔ∏è</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --bg-card: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #606060;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --accent-subtle: rgba(139, 92, 246, 0.1);
            --accent-glow: rgba(139, 92, 246, 0.3);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.6);
            --danger: #ef4444;
            --danger-hover: #f87171;
            --success: #22c55e;
            --warning: #f59e0b;
            --radius: 12px;
            --radius-lg: 16px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-accent: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        }

        [data-theme="light"] {
            --bg-primary: #faf5ff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3e8ff;
            --bg-card: #ffffff;
            --text-primary: #1e1b4b;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --accent: #7c3aed;
            --accent-hover: #6d28d9;
            --accent-subtle: rgba(124, 58, 237, 0.08);
            --accent-glow: rgba(124, 58, 237, 0.2);
            --border: rgba(0, 0, 0, 0.08);
            --border-hover: rgba(0, 0, 0, 0.15);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html { scroll-behavior: smooth; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            transition: background var(--transition), color var(--transition);
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        header {
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            gap: 16px;
            flex-wrap: wrap;
            backdrop-filter: blur(20px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 200px;
        }

        .logo {
            width: 42px;
            height: 42px;
            background: var(--gradient-accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px var(--accent-glow);
            flex-shrink: 0;
        }

        .logo svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        #album-title {
            font-weight: 500;
            font-size: 1.1rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--radius);
            width: 100%;
            max-width: 300px;
            transition: all var(--transition);
        }

        #album-title:hover { background: var(--accent-subtle); }
        #album-title:focus { 
            outline: none; 
            background: var(--accent-subtle);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .photo-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            white-space: nowrap;
            border: 1px solid var(--border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .btn:hover { 
            background: var(--accent-subtle); 
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        .btn:active { transform: scale(0.97); }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: var(--gradient-accent);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px var(--accent-glow);
        }
        
        .btn-primary:hover { 
            box-shadow: 0 6px 20px var(--accent-glow);
            border-color: transparent;
            background: var(--gradient-accent);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent-subtle);
        }

        .btn-icon {
            width: 42px;
            height: 42px;
            padding: 0;
            border-radius: 50%;
        }

        .btn-icon svg { width: 20px; height: 20px; }

        #file-input { display: none; }

        .theme-toggle {
            position: relative;
            width: 42px;
            height: 42px;
        }

        .theme-toggle input { display: none; }

        .theme-toggle label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            transition: all var(--transition);
        }

        .theme-toggle label:hover { 
            background: var(--accent-subtle);
            border-color: var(--accent);
        }

        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon { 
            width: 20px; 
            height: 20px;
            transition: all var(--transition);
        }

        .theme-toggle .icon-sun { display: none; }
        .theme-toggle .icon-moon { display: block; }
        
        [data-theme="light"] .theme-toggle .icon-sun { display: block; }
        [data-theme="light"] .theme-toggle .icon-moon { display: none; }

        main {
            flex: 1;
            padding: 24px;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .drop-zone {
            position: relative;
            min-height: calc(100vh - 200px);
            min-height: calc(100dvh - 200px);
        }

        .drop-zone.drag-over::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-subtle);
            border: 3px dashed var(--accent);
            border-radius: var(--radius-lg);
            z-index: 10;
            pointer-events: none;
            animation: pulse 1s ease-in-out infinite;
        }

        .drop-zone.drag-over::after {
            content: 'üìÅ –û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª—ã –∑–¥–µ—Å—å';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--accent);
            z-index: 11;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .photo-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all var(--transition);
        }

        .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px var(--accent-glow);
            border-color: var(--accent);
        }

        .photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .photo-card:hover img { transform: scale(1.05); }

        .photo-card .card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 12px;
        }

        .photo-card:hover .card-overlay { opacity: 1; }

        .photo-card .card-caption {
            color: white;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .photo-card .card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .photo-card:hover .card-actions { opacity: 1; }

        .card-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            backdrop-filter: blur(10px);
        }

        .card-btn:hover { transform: scale(1.1); }
        .card-btn.delete:hover { background: var(--danger); }
        .card-btn.edit:hover { background: var(--accent); }

        .card-btn svg { width: 16px; height: 16px; }

        .photo-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        .photo-card.drag-over-card {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 24px;
            background: var(--gradient-accent);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.3;
        }

        .empty-state-icon svg {
            width: 60px;
            height: 60px;
            color: white;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.95rem;
            max-width: 300px;
        }

        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .lightbox.active { 
            opacity: 1; 
            visibility: visible;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .lightbox img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            user-select: none;
            -webkit-user-drag: none;
        }

        .lightbox-info-area {
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            pointer-events: none;
        }

        .lightbox-caption {
            color: white;
            font-size: 1rem;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            max-width: 80vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        .lightbox-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            opacity: 0.8;
            flex-wrap: wrap;
        }

        .lightbox-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lb-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            z-index: 10;
        }

        .lb-btn:hover { 
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .lb-btn svg { width: 24px; height: 24px; }

        .lb-close { top: 20px; right: 20px; }
        .lb-prev { left: 20px; top: 50%; transform: translateY(-50%); }
        .lb-next { right: 20px; top: 50%; transform: translateY(-50%); }
        .lb-prev:hover, .lb-next:hover { transform: translateY(-50%) scale(1.1); }

        .lb-fullscreen { top: 20px; right: 80px; }
        .lb-slideshow { top: 20px; right: 140px; }
        .lb-slideshow.active { background: var(--accent); }

        .lb-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .lb-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            display: flex;
            gap: 16px;
        }

        .lb-hint span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lb-hint kbd {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-header-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all var(--transition);
        }

        .modal-close:hover { 
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .modal-body { padding: 24px; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-value {
            font-weight: 600;
            color: var(--accent);
        }

        .form-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .form-slider.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform var(--transition);
            box-shadow: 0 2px 8px var(--accent-glow);
        }
        
        .form-slider.disabled::-webkit-slider-thumb { background: var(--text-muted); box-shadow: none; }

        .form-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .form-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.95rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .toggle-label {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .toggle-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: block;
            margin-top: 2px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider { background: var(--gradient-accent); border-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); background-color: white; }

        .info-alert {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .info-alert svg { flex-shrink: 0; color: var(--accent); margin-top: 2px; }
        .info-alert.warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); }
        .info-alert.warning svg { color: var(--warning); }

        .stats-box {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            border: 1px solid var(--border);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.2;
        }

        .progress-container {
            margin-top: 16px;
            display: none;
        }

        .progress-container.active { display: block; }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-accent);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        .caption-modal .modal { max-width: 400px; }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-overlay.active { display: flex; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loader-text {
            margin-top: 16px;
            color: white;
            font-size: 0.95rem;
        }

        body.view-mode .controls-edit { display: none !important; }
        body.edit-mode .controls-view { display: none !important; }

        .controls-view {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .export-option {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
            background: var(--bg-tertiary);
        }

        .export-option:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }

        .export-option.selected {
            border-color: var(--accent);
            background: var(--accent-subtle);
            box-shadow: 0 0 0 1px var(--accent);
        }

        .export-option-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .export-option-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            header { padding: 12px 16px; }
            .header-left { min-width: 150px; }
            #album-title { font-size: 1rem; padding: 6px 10px; }
            .btn { padding: 8px 14px; font-size: 0.85rem; }
            .btn span.btn-text { display: none; }
            main { padding: 16px; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
            .photo-card .card-actions { opacity: 1; }
            .lb-btn { width: 44px; height: 44px; }
            .lb-prev { left: 10px; }
            .lb-next { right: 10px; }
            .lb-close { top: 10px; right: 10px; }
            .lb-fullscreen { top: 10px; right: 64px; }
            .lb-slideshow { top: 10px; right: 118px; }
            .lb-counter { top: 10px; left: 10px; font-size: 0.8rem; padding: 6px 12px; }
            .lb-hint { display: none; }
            .lightbox-info-area { bottom: 20px; }
            .lightbox-caption { font-size: 0.9rem; }
            .lightbox-meta { font-size: 0.7rem; }
            .modal { margin: 10px; }
            .modal-header, .modal-body, .modal-footer { padding: 16px; }
            .photo-count { display: none; }
            .export-options { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .header-right { gap: 8px; }
            .btn-icon { width: 38px; height: 38px; }
            .theme-toggle, .theme-toggle label { width: 38px; height: 38px; }
            .stats-box { grid-template-columns: 1fr; }
            .logo { width: 36px; height: 36px; border-radius: 10px; }
            .logo svg { width: 20px; height: 20px; }
        }
    </style>
</head>
<body class="edit-mode" data-theme="dark">

    <header>
        <div class="header-left">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
            </div>
            <input type="text" id="album-title" value="–ú–æ–π —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞" class="controls-edit">
            <span class="controls-view" id="album-title-view">–ú–æ–π —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º</span>
        </div>
        <div class="header-right">
            <span class="photo-count" id="photo-count">0 —Ñ–æ—Ç–æ</span>
            
            <div class="controls-edit" style="display: flex; gap: 12px;">
                <button class="btn" onclick="document.getElementById('file-input').click()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å</span>
                </button>
                <button class="btn btn-primary" onclick="openExportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="btn-text">–≠–∫—Å–ø–æ—Ä—Ç</span>
                </button>
            </div>

            <button class="btn btn-secondary controls-view" onclick="openViewExportModal()" id="view-export-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span class="btn-text">–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</span>
            </button>

            <div class="theme-toggle">
                <input type="checkbox" id="theme-switch" onchange="toggleTheme()">
                <label for="theme-switch">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </label>
            </div>
        </div>
    </header>

    <input type="file" id="file-input" multiple accept="image/*" onchange="handleFiles(this.files)">

    <main>
        <div class="drop-zone" id="drop-zone">
            <div id="gallery" class="gallery-grid"></div>
            
            <div id="empty-state" class="empty-state">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </div>
                <h3>–ê–ª—å–±–æ–º –ø—É—Å—Ç</h3>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å"</p>
            </div>
        </div>
    </main>

    <div id="lightbox" class="lightbox">
        <div class="lb-counter"><span id="lb-current">1</span> / <span id="lb-total">1</span></div>
        
        <button class="lb-btn lb-slideshow" id="lb-slideshow-btn" onclick="toggleSlideshow()" title="–°–ª–∞–π–¥—à–æ—É">
            <svg id="slideshow-play" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <svg id="slideshow-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        </button>
        <button class="lb-btn lb-fullscreen" onclick="toggleFullscreen()" title="–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
        </button>
        <button class="lb-btn lb-close" onclick="closeLightbox()" title="–ó–∞–∫—Ä—ã—Ç—å">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        
        <button class="lb-btn lb-prev" onclick="changeSlide(-1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        
        <div class="lightbox-content">
            <img id="lb-img" src="" alt="" draggable="false">
            <div class="lightbox-info-area">
                <div class="lightbox-caption" id="lb-caption"></div>
                <div class="lightbox-meta" id="lb-meta"></div>
            </div>
        </div>
        
        <button class="lb-btn lb-next" onclick="changeSlide(1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
        
        <div class="lb-hint">
            <span><kbd>‚Üê</kbd><kbd>‚Üí</kbd> –Ω–∞–≤–∏–≥–∞—Ü–∏—è</span>
            <span><kbd>Esc</kbd> –∑–∞–∫—Ä—ã—Ç—å</span>
            <span><kbd>Space</kbd> —Å–ª–∞–π–¥—à–æ—É</span>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <div class="modal-header-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </div>
                    –≠–∫—Å–ø–æ—Ä—Ç –∞–ª—å–±–æ–º–∞
                </h2>
                <button class="modal-close" onclick="closeExportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                
                <div class="export-options">
                    <div class="export-option selected" onclick="selectExportType('html')" data-type="html">
                        <div class="export-option-icon">üåê</div>
                        <div class="export-option-title">HTML –ê–ª—å–±–æ–º</div>
                        <div class="export-option-desc">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞</div>
                    </div>
                    <div class="export-option" onclick="selectExportType('images')" data-type="images">
                        <div class="export-option-icon">üñºÔ∏è</div>
                        <div class="export-option-title">–¢–æ–ª—å–∫–æ —Ñ–æ—Ç–æ</div>
                        <div class="export-option-desc">JPG/PNG —Ñ–∞–π–ª—ã –≤ ZIP</div>
                    </div>
                </div>

                <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>

                <div id="png-warning" class="info-alert warning" style="display:none">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã PNG —Ñ–∞–π–ª—ã. –°–∂–∞—Ç–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è PNG (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞).</span>
                </div>

                <div class="toggle-row" id="force-jpeg-container" style="display:none">
                    <div>
                        <div class="toggle-label">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JPEG</div>
                        <span class="toggle-sub">–ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏, –¥–æ—Å—Ç—É–ø–Ω–æ —Å–∂–∞—Ç–∏–µ</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="force-jpeg" onchange="updateExportPreview()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group" id="quality-group">
                    <div class="form-label">
                        <span>–ö–∞—á–µ—Å—Ç–≤–æ JPEG</span>
                        <span class="form-value" id="quality-value">100%</span>
                    </div>
                    <input type="range" class="form-slider" id="quality-slider" min="10" max="100" value="100" oninput="updateExportPreview()">
                </div>
                
                <div class="form-group">
                    <div class="form-label">
                        <span>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                        <span class="form-value" id="size-value">100%</span>
                    </div>
                    <input type="range" class="form-slider" id="size-slider" min="10" max="100" value="100" oninput="updateExportPreview()">
                </div>

                <div class="toggle-row" id="meta-toggle-row" style="margin-top: 20px;">
                    <div>
                        <div class="toggle-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ç–æ</div>
                        <span class="toggle-sub">–ò–º—è —Ñ–∞–π–ª–∞, —Ä–∞–∑–º–µ—Ä, –¥–∞—Ç–∞ –≤ HTML</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="export-meta" checked onchange="updateExportPreview()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <div class="stats-box">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-photos">0</div>
                            <div class="stat-label">—Ñ–æ—Ç–æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-orig-size">0 MB</div>
                            <div class="stat-label">–∏—Å—Ö–æ–¥–Ω—ã–π</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-est-size">0 MB</div>
                            <div class="stat-label">–≥–æ—Ç–æ–≤—ã–π (~)</div>
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="export-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeExportModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="exportAlbum()" id="export-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ZIP
                </button>
            </div>
        </div>
    </div>

    <!-- VIEW MODE EXPORT MODAL -->
    <div id="view-export-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <div class="modal-header-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </div>
                    –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                </h2>
                <button class="modal-close" onclick="closeViewExportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                
                <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>

                <div id="view-png-warning" class="info-alert warning" style="display:none">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã PNG —Ñ–∞–π–ª—ã. –°–∂–∞—Ç–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è PNG.</span>
                </div>

                <div class="toggle-row" id="view-force-jpeg-container" style="display:none">
                    <div>
                        <div class="toggle-label">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JPEG</div>
                        <span class="toggle-sub">–ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="view-force-jpeg" onchange="updateViewExportPreview()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <div class="form-label">
                        <span>–ö–∞—á–µ—Å—Ç–≤–æ JPEG</span>
                        <span class="form-value" id="view-quality-value">100%</span>
                    </div>
                    <input type="range" class="form-slider" id="view-quality-slider" min="10" max="100" value="100" oninput="updateViewExportPreview()">
                </div>
                
                <div class="form-group">
                    <div class="form-label">
                        <span>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                        <span class="form-value" id="view-size-value">100%</span>
                    </div>
                    <input type="range" class="form-slider" id="view-size-slider" min="10" max="100" value="100" oninput="updateViewExportPreview()">
                </div>

                <div class="form-group">
                    <div class="stats-box">
                        <div class="stat-item">
                            <div class="stat-value" id="view-stat-photos">0</div>
                            <div class="stat-label">—Ñ–æ—Ç–æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="view-stat-orig-size">0 MB</div>
                            <div class="stat-label">–∏—Å—Ö–æ–¥–Ω—ã–π</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="view-stat-est-size">0 MB</div>
                            <div class="stat-label">–≥–æ—Ç–æ–≤—ã–π (~)</div>
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="view-export-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="view-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="view-progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeViewExportModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="exportImagesFromViewMode()" id="view-export-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    –°–∫–∞—á–∞—Ç—å ZIP
                </button>
            </div>
        </div>
    </div>

    <div id="caption-modal" class="modal-overlay caption-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <div class="modal-header-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                    –ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ
                </h2>
                <button class="modal-close" onclick="closeCaptionModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="caption-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å..." maxlength="100">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCaptionModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveCaption()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script id="album-data">
        window.ALBUM_DATA = null;
        window.ALBUM_TITLE = null;
        window.ALBUM_THEME = null;
    </script>

    <script>
        let images = [];
        let currentIdx = 0;
        let slideshowInterval = null;
        let editingCaptionIdx = null;
        let draggedItem = null;
        let exportType = 'html';

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initDropZone();
            initTouchSwipe();
            
            if (window.ALBUM_DATA && Array.isArray(window.ALBUM_DATA) && window.ALBUM_DATA.length > 0) {
                images = window.ALBUM_DATA;
                document.body.classList.remove('edit-mode');
                document.body.classList.add('view-mode');
                
                if (window.ALBUM_TITLE) {
                    document.getElementById('album-title-view').textContent = window.ALBUM_TITLE;
                    document.title = window.ALBUM_TITLE;
                }
                
                if (window.ALBUM_THEME) {
                    document.body.dataset.theme = window.ALBUM_THEME;
                    document.getElementById('theme-switch').checked = window.ALBUM_THEME === 'light';
                }
                
                renderGallery();
            }
            
            updatePhotoCount();
        });

        function initTheme() {
            const saved = localStorage.getItem('photoalbum-theme');
            if (saved) {
                document.body.dataset.theme = saved;
                document.getElementById('theme-switch').checked = saved === 'light';
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.body.dataset.theme = 'light';
                document.getElementById('theme-switch').checked = true;
            }
        }

        function toggleTheme() {
            const isLight = document.getElementById('theme-switch').checked;
            document.body.dataset.theme = isLight ? 'light' : 'dark';
            localStorage.setItem('photoalbum-theme', document.body.dataset.theme);
        }

        function initDropZone() {
            const dropZone = document.getElementById('drop-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(event => {
                dropZone.addEventListener(event, () => {
                    if (document.body.classList.contains('edit-mode')) {
                        dropZone.classList.add('drag-over');
                    }
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, () => {
                    dropZone.classList.remove('drag-over');
                });
            });

            dropZone.addEventListener('drop', e => {
                if (document.body.classList.contains('edit-mode') && e.dataTransfer.files.length) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        function initTouchSwipe() {
            const lightbox = document.getElementById('lightbox');
            let touchStartX = 0;
            let touchStartY = 0;

            lightbox.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            lightbox.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = Math.abs(touchStartY - touchEndY);
                
                if (Math.abs(diffX) > 50 && diffY < 100) {
                    if (diffX > 0) changeSlide(1);
                    else changeSlide(-1);
                }
            }, { passive: true });
        }

        async function handleFiles(files) {
            if (!files.length) return;
            showLoader(true, '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...');
            
            const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            
            const promises = imageFiles.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            resolve({
                                id: Date.now() + Math.random(),
                                src: e.target.result,
                                caption: '',
                                name: file.name,
                                size: file.size,
                                date: file.lastModified,
                                type: file.type,
                                width: img.width,
                                height: img.height
                            });
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            });

            const newImages = await Promise.all(promises);
            images = [...images, ...newImages];
            renderGallery();
            updatePhotoCount();
            showLoader(false);
            document.getElementById('file-input').value = '';
        }

        function formatBytes(bytes, decimals = 1) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('ru-RU');
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('empty-state');
            gallery.innerHTML = '';

            if (images.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            
            emptyState.style.display = 'none';

            images.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card';
                card.draggable = document.body.classList.contains('edit-mode');
                card.dataset.index = index;
                
                card.innerHTML = `
                    <img src="${img.src}" loading="lazy" alt="${img.caption || ''}">
                    <div class="card-overlay">
                        ${img.caption ? `<div class="card-caption">${escapeHtml(img.caption)}</div>` : ''}
                    </div>
                    <div class="card-actions controls-edit">
                        <button class="card-btn edit" onclick="event.stopPropagation(); openCaptionModal(${index})" title="–ü–æ–¥–ø–∏—Å—å">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="card-btn delete" onclick="event.stopPropagation(); deletePhoto(${index})" title="–£–¥–∞–ª–∏—Ç—å">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                
                card.addEventListener('click', () => openLightbox(index));
                
                if (document.body.classList.contains('edit-mode')) {
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragleave', handleDragLeave);
                }
                
                gallery.appendChild(card);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.photo-card').forEach(card => {
                card.classList.remove('drag-over-card');
            });
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedItem) {
                this.classList.add('drag-over-card');
            }
        }

        function handleDragLeave() {
            this.classList.remove('drag-over-card');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over-card');
            
            if (this !== draggedItem && draggedItem) {
                const fromIdx = parseInt(draggedItem.dataset.index);
                const toIdx = parseInt(this.dataset.index);
                
                const item = images.splice(fromIdx, 1)[0];
                images.splice(toIdx, 0, item);
                renderGallery();
            }
        }

        function deletePhoto(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) {
                images.splice(index, 1);
                renderGallery();
                updatePhotoCount();
            }
        }

        function openCaptionModal(index) {
            editingCaptionIdx = index;
            document.getElementById('caption-input').value = images[index].caption || '';
            document.getElementById('caption-modal').classList.add('active');
            document.getElementById('caption-input').focus();
        }

        function closeCaptionModal() {
            document.getElementById('caption-modal').classList.remove('active');
            editingCaptionIdx = null;
        }

        function saveCaption() {
            if (editingCaptionIdx !== null) {
                images[editingCaptionIdx].caption = document.getElementById('caption-input').value.trim();
                renderGallery();
            }
            closeCaptionModal();
        }

        function updatePhotoCount() {
            const count = images.length;
            const text = count === 0 ? '0 —Ñ–æ—Ç–æ' : 
                         count === 1 ? '1 —Ñ–æ—Ç–æ' : 
                         count < 5 ? `${count} —Ñ–æ—Ç–æ` : `${count} —Ñ–æ—Ç–æ`;
            document.getElementById('photo-count').textContent = text;
        }

        function openLightbox(index) {
            currentIdx = index;
            updateLightbox();
            document.getElementById('lightbox').classList.add('active');
            document.addEventListener('keydown', handleLightboxKeys);
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.removeEventListener('keydown', handleLightboxKeys);
            document.body.style.overflow = '';
            stopSlideshow();
        }

        function changeSlide(dir) {
            currentIdx += dir;
            if (currentIdx >= images.length) currentIdx = 0;
            if (currentIdx < 0) currentIdx = images.length - 1;
            updateLightbox();
        }

        function updateLightbox() {
            const img = images[currentIdx];
            document.getElementById('lb-img').src = img.src;
            document.getElementById('lb-current').textContent = currentIdx + 1;
            document.getElementById('lb-total').textContent = images.length;
            document.getElementById('lb-caption').textContent = img.caption || '';
            
            const metaContainer = document.getElementById('lb-meta');
            let metaHtml = '';
            if (img.name) metaHtml += `<span>üìÑ ${escapeHtml(img.name)}</span>`;
            if (img.width && img.height) metaHtml += `<span>üìê ${img.width}√ó${img.height}</span>`;
            if (img.date) metaHtml += `<span>üìÖ ${formatDate(img.date)}</span>`;
            if (img.size) metaHtml += `<span>üíæ ${formatBytes(img.size)}</span>`;
            metaContainer.innerHTML = metaHtml;
        }

        function handleLightboxKeys(e) {
            switch(e.key) {
                case 'Escape': closeLightbox(); break;
                case 'ArrowRight': changeSlide(1); break;
                case 'ArrowLeft': changeSlide(-1); break;
                case ' ': e.preventDefault(); toggleSlideshow(); break;
                case 'f': toggleFullscreen(); break;
            }
        }

        function toggleSlideshow() {
            const btn = document.getElementById('lb-slideshow-btn');
            const playIcon = document.getElementById('slideshow-play');
            const pauseIcon = document.getElementById('slideshow-pause');
            
            if (slideshowInterval) {
                stopSlideshow();
            } else {
                slideshowInterval = setInterval(() => changeSlide(1), 3000);
                btn.classList.add('active');
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            }
        }

        function stopSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                const btn = document.getElementById('lb-slideshow-btn');
                btn.classList.remove('active');
                document.getElementById('slideshow-play').style.display = 'block';
                document.getElementById('slideshow-pause').style.display = 'none';
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.getElementById('lightbox').requestFullscreen?.() || 
                document.getElementById('lightbox').webkitRequestFullscreen?.();
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
            }
        }

        function selectExportType(type) {
            exportType = type;
            document.querySelectorAll('.export-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.type === type);
            });
            
            // Show/hide meta toggle only for HTML export
            document.getElementById('meta-toggle-row').style.display = type === 'html' ? 'flex' : 'none';
            
            updateExportPreview();
        }

        function openExportModal() {
            if (images.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏!');
                return;
            }
            updateExportPreview();
            document.getElementById('export-modal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('active');
            document.getElementById('export-progress').classList.remove('active');
        }

        function updateExportPreview() {
            const quality = document.getElementById('quality-slider').value;
            const size = document.getElementById('size-slider').value;
            const forceJpegToggle = document.getElementById('force-jpeg');
            const forceJpeg = forceJpegToggle.checked;
            
            const hasPng = images.some(img => img.type === 'image/png' || img.type === 'image/webp' || img.src.startsWith('data:image/png'));
            const warningBox = document.getElementById('png-warning');
            const qualitySlider = document.getElementById('quality-slider');
            const forceJpegContainer = document.getElementById('force-jpeg-container');

            forceJpegContainer.style.display = hasPng ? 'flex' : 'none';

            if (hasPng && !forceJpeg) {
                warningBox.style.display = 'flex';
                qualitySlider.classList.add('disabled');
                qualitySlider.disabled = true;
                document.getElementById('quality-value').textContent = "N/A";
            } else {
                warningBox.style.display = 'none';
                qualitySlider.classList.remove('disabled');
                qualitySlider.disabled = false;
                document.getElementById('quality-value').textContent = quality + '%';
            }

            document.getElementById('size-value').textContent = size + '%';
            document.getElementById('stat-photos').textContent = images.length;
            
            let totalOrigSize = 0;
            let totalEstSize = 0;
            
            images.forEach(img => {
                let imgSize = 0;
                if (img.size) {
                    imgSize = img.size;
                } else {
                    const base64Length = img.src.length - (img.src.indexOf(',') + 1);
                    imgSize = base64Length * 0.75;
                }
                totalOrigSize += imgSize;

                const isPng = img.type === 'image/png' || img.src.startsWith('data:image/png');
                const isWebp = img.type === 'image/webp' || img.src.startsWith('data:image/webp');
                
                const resizeFactor = (size / 100) ** 2;
                
                if ((isPng || isWebp) && !forceJpeg) {
                    totalEstSize += imgSize * resizeFactor; 
                } else {
                    const qualityFactor = (quality / 100) ** 0.8;
                    totalEstSize += imgSize * resizeFactor * qualityFactor;
                }
            });
            
            document.getElementById('stat-orig-size').textContent = formatBytes(totalOrigSize);
            document.getElementById('stat-est-size').textContent = formatBytes(totalEstSize);
        }

        // View mode export modal functions
        function openViewExportModal() {
            if (images.length === 0) {
                alert('–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!');
                return;
            }
            updateViewExportPreview();
            document.getElementById('view-export-modal').classList.add('active');
        }

        function closeViewExportModal() {
            document.getElementById('view-export-modal').classList.remove('active');
            document.getElementById('view-export-progress').classList.remove('active');
        }

        function updateViewExportPreview() {
            const quality = document.getElementById('view-quality-slider').value;
            const size = document.getElementById('view-size-slider').value;
            const forceJpegToggle = document.getElementById('view-force-jpeg');
            const forceJpeg = forceJpegToggle.checked;
            
            const hasPng = images.some(img => img.type === 'image/png' || img.type === 'image/webp' || img.src.startsWith('data:image/png'));
            const warningBox = document.getElementById('view-png-warning');
            const qualitySlider = document.getElementById('view-quality-slider');
            const forceJpegContainer = document.getElementById('view-force-jpeg-container');

            forceJpegContainer.style.display = hasPng ? 'flex' : 'none';

            if (hasPng && !forceJpeg) {
                warningBox.style.display = 'flex';
                qualitySlider.classList.add('disabled');
                qualitySlider.disabled = true;
                document.getElementById('view-quality-value').textContent = "N/A";
            } else {
                warningBox.style.display = 'none';
                qualitySlider.classList.remove('disabled');
                qualitySlider.disabled = false;
                document.getElementById('view-quality-value').textContent = quality + '%';
            }

            document.getElementById('view-size-value').textContent = size + '%';
            document.getElementById('view-stat-photos').textContent = images.length;
            
            let totalOrigSize = 0;
            let totalEstSize = 0;
            
            images.forEach(img => {
                let imgSize = 0;
                if (img.size) {
                    imgSize = img.size;
                } else {
                    const base64Length = img.src.length - (img.src.indexOf(',') + 1);
                    imgSize = base64Length * 0.75;
                }
                totalOrigSize += imgSize;

                const isPng = img.type === 'image/png' || img.src.startsWith('data:image/png');
                const isWebp = img.type === 'image/webp' || img.src.startsWith('data:image/webp');
                
                const resizeFactor = (size / 100) ** 2;
                
                if ((isPng || isWebp) && !forceJpeg) {
                    totalEstSize += imgSize * resizeFactor; 
                } else {
                    const qualityFactor = (quality / 100) ** 0.8;
                    totalEstSize += imgSize * resizeFactor * qualityFactor;
                }
            });
            
            document.getElementById('view-stat-orig-size').textContent = formatBytes(totalOrigSize);
            document.getElementById('view-stat-est-size').textContent = formatBytes(totalEstSize);
        }

        async function exportAlbum() {
            if (exportType === 'images') {
                await exportImagesOnly();
            } else {
                await exportHtmlAlbum();
            }
        }

        async function exportImagesOnly() {
            const quality = document.getElementById('quality-slider').value / 100;
            const sizePercent = document.getElementById('size-slider').value / 100;
            const forceJpeg = document.getElementById('force-jpeg').checked;
            
            await doExportImages(quality, sizePercent, forceJpeg, 'export-progress', 'progress-fill', 'progress-text', 'export-btn', () => closeExportModal());
        }

        async function exportImagesFromViewMode() {
            const quality = document.getElementById('view-quality-slider').value / 100;
            const sizePercent = document.getElementById('view-size-slider').value / 100;
            const forceJpeg = document.getElementById('view-force-jpeg').checked;
            
            await doExportImages(quality, sizePercent, forceJpeg, 'view-export-progress', 'view-progress-fill', 'view-progress-text', 'view-export-btn', () => closeViewExportModal());
        }

        async function doExportImages(quality, sizePercent, forceJpeg, progressContainerId, progressFillId, progressTextId, exportBtnId, closeCallback) {
            if (images.length === 0) {
                alert('–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
                return;
            }

            const titleInput = document.getElementById('album-title')?.value || 
                              document.getElementById('album-title-view')?.textContent || 
                              'photos';
            const safeFileName = titleInput
                .replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9\-_]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                || 'photos';

            const progressContainer = document.getElementById(progressContainerId);
            const progressFill = document.getElementById(progressFillId);
            const progressText = document.getElementById(progressTextId);
            const exportBtn = document.getElementById(exportBtnId);
            
            if (progressContainer) progressContainer.classList.add('active');
            if (exportBtn) exportBtn.disabled = true;

            try {
                const zip = new JSZip();
                const folder = zip.folder(safeFileName);

                for (let i = 0; i < images.length; i++) {
                    const img = images[i];
                    if (progressText) progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ ${i + 1} –∏–∑ ${images.length}...`;
                    if (progressFill) progressFill.style.width = ((i / images.length) * 80) + '%';

                    // Process image with quality/size settings
                    const processed = await processImage(img, quality, sizePercent, forceJpeg);
                    
                    // Extract base64 data
                    const base64Data = processed.src.split(',')[1];
                    
                    // Determine extension based on processed type
                    let ext = 'jpg';
                    if (processed.type === 'image/png' || processed.src.startsWith('data:image/png')) ext = 'png';
                    else if (processed.type === 'image/webp' || processed.src.startsWith('data:image/webp')) ext = 'webp';
                    else if (processed.type === 'image/gif' || processed.src.startsWith('data:image/gif')) ext = 'gif';

                    // Use original name or generate one
                    let fileName = img.name || `photo_${String(i + 1).padStart(3, '0')}.${ext}`;
                    
                    // Update extension if format changed (e.g., PNG to JPEG)
                    const nameParts = fileName.split('.');
                    if (nameParts.length > 1) nameParts.pop();
                    fileName = nameParts.join('.') + '.' + ext;

                    folder.file(fileName, base64Data, { base64: true });
                    
                    await new Promise(r => setTimeout(r, 10));
                }

                if (progressText) progressText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
                if (progressFill) progressFill.style.width = '90%';

                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                if (progressFill) progressFill.style.width = '100%';
                if (progressText) progressText.textContent = '–ì–æ—Ç–æ–≤–æ!';

                saveAs(content, `${safeFileName}-photos.zip`);

                setTimeout(() => {
                    if (progressContainer) progressContainer.classList.remove('active');
                    if (closeCallback) closeCallback();
                }, 1000);

            } catch (error) {
                console.error(error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            } finally {
                if (exportBtn) exportBtn.disabled = false;
            }
        }

        async function exportHtmlAlbum() {
            const quality = document.getElementById('quality-slider').value / 100;
            const sizePercent = document.getElementById('size-slider').value / 100;
            const forceJpeg = document.getElementById('force-jpeg').checked;
            const exportMeta = document.getElementById('export-meta').checked;
            
            const titleInput = document.getElementById('album-title').value.trim() || 'photo-album';
            const safeFileName = titleInput
                .replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9\-_]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                || 'album';

            const progressContainer = document.getElementById('export-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const exportBtn = document.getElementById('export-btn');
            
            progressContainer.classList.add('active');
            exportBtn.disabled = true;
            
            try {
                const processedImages = [];
                for (let i = 0; i < images.length; i++) {
                    progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ ${i + 1} –∏–∑ ${images.length}...`;
                    progressFill.style.width = ((i / images.length) * 50) + '%';
                    
                    const processed = await processImage(images[i], quality, sizePercent, forceJpeg);
                    
                    const imgData = {
                        src: processed.src,
                        caption: processed.caption
                    };
                    if (exportMeta) {
                        imgData.name = processed.name;
                        imgData.size = processed.size;
                        imgData.date = processed.date;
                        imgData.width = processed.width;
                        imgData.height = processed.height;
                        imgData.type = processed.type;
                    }

                    processedImages.push(imgData);
                    
                    await new Promise(r => setTimeout(r, 10));
                }
                
                progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML...';
                progressFill.style.width = '60%';
                await new Promise(r => setTimeout(r, 50));
                
                const htmlContent = generateOptimizedHTML(processedImages);
                
                progressText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
                progressFill.style.width = '80%';
                
                const zip = new JSZip();
                zip.file(`${safeFileName}.html`, htmlContent);
                
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 9 }
                });
                
                progressFill.style.width = '100%';
                progressText.textContent = '–ì–æ—Ç–æ–≤–æ!';
                
                saveAs(content, `${safeFileName}.zip`);
                
                setTimeout(() => closeExportModal(), 1000);
                
            } catch (error) {
                console.error(error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            } finally {
                exportBtn.disabled = false;
            }
        }

        async function processImage(img, quality, sizePercent, forceJpeg) {
            return new Promise((resolve) => {
                const isPng = img.type === 'image/png' || img.src.startsWith('data:image/png');
                const isWebp = img.type === 'image/webp' || img.src.startsWith('data:image/webp');
                
                // If no changes needed, return original
                if (!forceJpeg && (isPng || isWebp) && sizePercent === 1) {
                    resolve({ ...img });
                    return;
                }
                
                if (!isPng && !isWebp && quality === 1 && sizePercent === 1) {
                    resolve({ ...img });
                    return;
                }
                
                const image = new Image();
                image.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const newWidth = Math.round(image.width * sizePercent);
                    const newHeight = Math.round(image.height * sizePercent);

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Determine output format
                    let mimeType = 'image/jpeg';
                    if (!forceJpeg) {
                        if (isPng) mimeType = 'image/png';
                        else if (isWebp) mimeType = 'image/webp';
                    }
                    
                    // Fill background for JPEG (no transparency)
                    if (mimeType === 'image/jpeg') {
                        ctx.fillStyle = "#000000";
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                    
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                    
                    // For PNG, quality parameter is ignored
                    const outputQuality = mimeType === 'image/png' ? 1 : quality;
                    const newSrc = canvas.toDataURL(mimeType, outputQuality);
                    
                    const head = 'data:' + mimeType + ';base64,';
                    const sizeInBytes = Math.round((newSrc.length - head.length) * 3 / 4);
                    
                    resolve({ 
                        ...img, 
                        src: newSrc, 
                        size: sizeInBytes,
                        width: newWidth,
                        height: newHeight,
                        type: mimeType
                    });
                };
                image.src = img.src;
            });
        }

        function generateOptimizedHTML(processedImages) {
            const albumTitle = document.getElementById('album-title').value || '–§–æ—Ç–æ–∞–ª—å–±–æ–º';
            const currentTheme = document.body.dataset.theme;
            
            const exportData = processedImages.map(img => ({
                src: img.src,
                caption: img.caption,
                name: img.name,
                size: img.size,
                date: img.date,
                width: img.width,
                height: img.height,
                type: img.type
            }));
            
            const dataString = JSON.stringify(exportData);
            
            return `<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>${escapeHtml(albumTitle)}</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéûÔ∏è</text></svg>">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"><\/script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"><\/script>
<style>
:root{--bg:#0a0a0a;--bg2:#141414;--bg3:#1e1e1e;--txt:#fff;--txt2:#a0a0a0;--txt3:#606060;--acc:#8b5cf6;--acc-h:#a78bfa;--glow:rgba(139,92,246,0.3);--brd:rgba(255,255,255,.08);--grad:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%)}
[data-theme=light]{--bg:#faf5ff;--bg2:#fff;--bg3:#f3e8ff;--txt:#1e1b4b;--txt2:#6b7280;--txt3:#9ca3af;--acc:#7c3aed;--acc-h:#6d28d9;--glow:rgba(124,58,237,0.2);--brd:rgba(0,0,0,.08)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font-family:system-ui,sans-serif;min-height:100vh;min-height:100dvh}
header{background:var(--bg2);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--brd);position:sticky;top:0;z-index:100;backdrop-filter:blur(20px);flex-wrap:wrap;gap:12px}
.logo{width:42px;height:42px;background:var(--grad);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px var(--glow);flex-shrink:0}
.logo svg{width:24px;height:24px;color:#fff}
h1{font-size:1.1rem;font-weight:500}
.hdr-left{display:flex;align-items:center;gap:16px}
.hdr-right{display:flex;align-items:center;gap:12px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 18px;font-size:.9rem;font-weight:500;border-radius:12px;border:1px solid var(--acc);background:transparent;color:var(--acc);cursor:pointer;transition:all .2s}
.btn:hover{background:rgba(139,92,246,.1)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn svg{width:18px;height:18px}
.theme-btn{width:42px;height:42px;border-radius:50%;border:1px solid var(--brd);background:var(--bg3);color:var(--txt);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.theme-btn:hover{border-color:var(--acc);background:rgba(139,92,246,.1)}
main{padding:24px;max-width:1800px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.card{aspect-ratio:1;border-radius:12px;overflow:hidden;cursor:pointer;background:var(--bg3);border:1px solid var(--brd);position:relative;transition:all .2s}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 40px rgba(0,0,0,.3),0 0 30px var(--glow);border-color:var(--acc)}
.card img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.card:hover img{transform:scale(1.05)}
.card-cap{position:absolute;bottom:0;left:0;right:0;padding:12px;background:linear-gradient(transparent,rgba(0,0,0,.8));color:#fff;font-size:.85rem;opacity:0;transition:.2s}
.card:hover .card-cap{opacity:1}
.lb{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.3s}
.lb.active{opacity:1;visibility:visible}
.lb-content{position:relative;display:flex;flex-direction:column;align-items:center}
.lb img{max-width:90vw;max-height:80vh;object-fit:contain;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.lb-info{position:absolute;bottom:-60px;width:100%;text-align:center;pointer-events:none}
.lb-cap{color:#fff;font-size:1rem;margin-bottom:4px;text-shadow:0 2px 4px rgba(0,0,0,.5)}
.lb-meta{color:rgba(255,255,255,.6);font-size:.75rem;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
.lb-btn{position:absolute;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:none;color:#fff;cursor:pointer;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;z-index:10;transition:all .2s}
.lb-btn:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
.lb-close{top:20px;right:20px}
.lb-fs{top:20px;right:80px}
.lb-prev{left:20px;top:50%;transform:translateY(-50%)}
.lb-next{right:20px;top:50%;transform:translateY(-50%)}
.lb-prev:hover,.lb-next:hover{transform:translateY(-50%) scale(1.1)}
.lb-counter{position:absolute;top:20px;left:20px;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);padding:8px 16px;border-radius:20px;font-size:.9rem}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-box{background:var(--bg2);border-radius:16px;border:1px solid var(--brd);box-shadow:0 8px 40px rgba(0,0,0,.6);max-width:480px;width:100%;max-height:90vh;overflow-y:auto}
.modal-hdr{padding:20px 24px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center}
.modal-hdr h2{font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:10px}
.modal-icon{width:32px;height:32px;background:var(--grad);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.modal-icon svg{width:18px;height:18px;color:#fff}
.modal-close{background:none;border:none;color:var(--txt2);cursor:pointer;padding:4px;border-radius:6px}
.modal-close:hover{color:var(--txt);background:var(--bg3)}
.modal-body{padding:24px}
.modal-ftr{padding:16px 24px;border-top:1px solid var(--brd);display:flex;justify-content:flex-end;gap:12px}
.section-title{font-size:.8rem;font-weight:600;color:var(--txt3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.form-group{margin-bottom:20px}
.form-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:.9rem;color:var(--txt2)}
.form-value{font-weight:600;color:var(--acc)}
.form-slider{-webkit-appearance:none;appearance:none;width:100%;height:6px;background:var(--bg3);border-radius:3px;outline:none}
.form-slider:disabled{opacity:.5;cursor:not-allowed}
.form-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:var(--acc);border-radius:50%;cursor:pointer;box-shadow:0 2px 8px var(--glow)}
.form-slider:disabled::-webkit-slider-thumb{background:var(--txt3);box-shadow:none}
.toggle-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.toggle-label{font-size:.9rem;color:var(--txt)}
.toggle-sub{font-size:.8rem;color:var(--txt2);display:block;margin-top:2px}
.toggle-switch{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--bg3);border:1px solid var(--brd);transition:.3s;border-radius:24px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background-color:var(--txt3);transition:.3s;border-radius:50%}
input:checked+.slider{background:var(--grad);border-color:var(--acc)}
input:checked+.slider:before{transform:translateX(20px);background-color:#fff}
.info-alert{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);padding:12px;border-radius:8px;font-size:.85rem;color:var(--txt);margin-bottom:16px;display:none;align-items:flex-start;gap:10px}
.info-alert.show{display:flex}
.info-alert svg{flex-shrink:0;color:#f59e0b;margin-top:2px}
.stats-box{background:var(--bg3);border-radius:12px;padding:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;border:1px solid var(--brd)}
.stat-item{text-align:center}
.stat-value{font-size:1.25rem;font-weight:600;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-label{font-size:.75rem;color:var(--txt3);margin-top:4px}
.progress-container{margin-top:16px;display:none}
.progress-container.active{display:block}
.progress-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--grad);border-radius:4px;transition:width .3s;width:0}
.progress-text{font-size:.85rem;color:var(--txt2);margin-top:8px;text-align:center}
.btn-primary{background:var(--grad);color:#fff;border-color:transparent;box-shadow:0 4px 15px var(--glow)}
.btn-primary:hover{box-shadow:0 6px 20px var(--glow);filter:brightness(1.1)}
@media(max-width:768px){.grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}main{padding:16px}.lb-btn{width:44px;height:44px}.lb-fs{right:74px}.card-cap{opacity:1}.lb-info{bottom:20px}.lb-meta{font-size:.7rem}.btn span{display:none}.btn{padding:10px}.stats-box{grid-template-columns:1fr}}
</style>
</head>
<body data-theme="${currentTheme}">
<header>
<div class="hdr-left">
<div class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
<h1>${escapeHtml(albumTitle)}</h1>
</div>
<div class="hdr-right">
<button class="btn" onclick="openExportModal()" title="–°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
<span>–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</span>
</button>
<button class="theme-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
</button>
</div>
</header>
<main>
<div class="grid" id="g"></div>
</main>
<div class="lb" id="lb">
<div class="lb-counter"><span id="cur">1</span>/<span id="tot">1</span></div>
<button class="lb-btn lb-fs" onclick="toggleFs()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
<button class="lb-btn lb-close" onclick="closeLb()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
<button class="lb-btn lb-prev" onclick="nav(-1)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
<div class="lb-content">
<img id="lbi" src="">
<div class="lb-info">
<div class="lb-cap" id="lbc"></div>
<div class="lb-meta" id="lbm"></div>
</div>
</div>
<button class="lb-btn lb-next" onclick="nav(1)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
</div>
<div class="modal" id="exportModal">
<div class="modal-box">
<div class="modal-hdr">
<h2><div class="modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div>–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
<button class="modal-close" onclick="closeExportModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>
<div class="modal-body">
<div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>
<div class="info-alert" id="pngWarn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg><span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã PNG. –°–∂–∞—Ç–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è PNG.</span></div>
<div class="toggle-row" id="forceJpegRow" style="display:none"><div><div class="toggle-label">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JPEG</div><span class="toggle-sub">–ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏</span></div><label class="toggle-switch"><input type="checkbox" id="forceJpeg" onchange="updPreview()"><span class="slider"></span></label></div>
<div class="form-group"><div class="form-label"><span>–ö–∞—á–µ—Å—Ç–≤–æ JPEG</span><span class="form-value" id="qualVal">100%</span></div><input type="range" class="form-slider" id="qualSlider" min="10" max="100" value="100" oninput="updPreview()"></div>
<div class="form-group"><div class="form-label"><span>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span><span class="form-value" id="sizeVal">100%</span></div><input type="range" class="form-slider" id="sizeSlider" min="10" max="100" value="100" oninput="updPreview()"></div>
<div class="form-group"><div class="stats-box"><div class="stat-item"><div class="stat-value" id="statPhotos">0</div><div class="stat-label">—Ñ–æ—Ç–æ</div></div><div class="stat-item"><div class="stat-value" id="statOrig">0 MB</div><div class="stat-label">–∏—Å—Ö–æ–¥–Ω—ã–π</div></div><div class="stat-item"><div class="stat-value" id="statEst">0 MB</div><div class="stat-label">–≥–æ—Ç–æ–≤—ã–π (~)</div></div></div></div>
<div class="progress-container" id="prog"><div class="progress-bar"><div class="progress-fill" id="progFill"></div></div><div class="progress-text" id="progText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div></div>
</div>
<div class="modal-ftr"><button class="btn" onclick="closeExportModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="downloadPhotos()" id="dlBtn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>–°–∫–∞—á–∞—Ç—å ZIP</button></div>
</div>
</div>
<script>
const D=${dataString};
const albumName="${escapeHtml(albumTitle).replace(/"/g, '\\"')}";
let I=0;
const g=document.getElementById('g');
D.forEach((p,i)=>{const c=document.createElement('div');c.className='card';c.innerHTML='<img src="'+p.src+'" loading="lazy">'+(p.caption?'<div class="card-cap">'+p.caption+'</div>':'');c.onclick=()=>openLb(i);g.appendChild(c)});
document.getElementById('tot').textContent=D.length;
function fmtBytes(b){if(!b)return'0 B';const k=1024,i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(1))+' '+['B','KB','MB','GB'][i]}
function fmtDate(t){return t?new Date(t).toLocaleDateString('ru-RU'):''}
function openLb(i){I=i;updLb();document.getElementById('lb').classList.add('active');document.addEventListener('keydown',onKey)}
function closeLb(){document.getElementById('lb').classList.remove('active');document.removeEventListener('keydown',onKey)}
function toggleFs(){if(!document.fullscreenElement){document.getElementById('lb').requestFullscreen()}else{document.exitFullscreen()}}
function nav(d){I+=d;if(I>=D.length)I=0;if(I<0)I=D.length-1;updLb()}
function updLb(){const d=D[I];document.getElementById('lbi').src=d.src;document.getElementById('cur').textContent=I+1;document.getElementById('lbc').textContent=d.caption||'';let m='';if(d.name)m+='<span>üìÑ '+d.name+'</span>';if(d.width&&d.height)m+='<span>üìê '+d.width+'√ó'+d.height+'</span>';if(d.date)m+='<span>üìÖ '+fmtDate(d.date)+'</span>';if(d.size)m+='<span>üíæ '+fmtBytes(d.size)+'</span>';document.getElementById('lbm').innerHTML=m}
function onKey(e){if(e.key==='Escape')closeLb();if(e.key==='ArrowRight')nav(1);if(e.key==='ArrowLeft')nav(-1);if(e.key==='f')toggleFs()}
function toggleTheme(){document.body.dataset.theme=document.body.dataset.theme==='dark'?'light':'dark'}
let tx=0;document.getElementById('lb').addEventListener('touchstart',e=>tx=e.changedTouches[0].screenX,{passive:true});
document.getElementById('lb').addEventListener('touchend',e=>{const d=tx-e.changedTouches[0].screenX;if(Math.abs(d)>50){d>0?nav(1):nav(-1)}},{passive:true});

function openExportModal(){updPreview();document.getElementById('exportModal').classList.add('active')}
function closeExportModal(){document.getElementById('exportModal').classList.remove('active');document.getElementById('prog').classList.remove('active')}
function updPreview(){
const qual=document.getElementById('qualSlider').value;
const size=document.getElementById('sizeSlider').value;
const forceJpeg=document.getElementById('forceJpeg').checked;
const hasPng=D.some(img=>img.type==='image/png'||img.type==='image/webp'||(img.src&&img.src.startsWith('data:image/png')));
const warn=document.getElementById('pngWarn');
const qs=document.getElementById('qualSlider');
const fjRow=document.getElementById('forceJpegRow');
fjRow.style.display=hasPng?'flex':'none';
if(hasPng&&!forceJpeg){warn.classList.add('show');qs.disabled=true;qs.classList.add('disabled');document.getElementById('qualVal').textContent='N/A'}
else{warn.classList.remove('show');qs.disabled=false;qs.classList.remove('disabled');document.getElementById('qualVal').textContent=qual+'%'}
document.getElementById('sizeVal').textContent=size+'%';
document.getElementById('statPhotos').textContent=D.length;
let totalOrig=0,totalEst=0;
D.forEach(img=>{let sz=img.size||0;if(!sz&&img.src){const b64=img.src.length-(img.src.indexOf(',')+1);sz=b64*0.75}totalOrig+=sz;const isPng=img.type==='image/png'||(img.src&&img.src.startsWith('data:image/png'));const isWebp=img.type==='image/webp'||(img.src&&img.src.startsWith('data:image/webp'));const rf=(size/100)**2;if((isPng||isWebp)&&!forceJpeg){totalEst+=sz*rf}else{const qf=(qual/100)**0.8;totalEst+=sz*rf*qf}});
document.getElementById('statOrig').textContent=fmtBytes(totalOrig);
document.getElementById('statEst').textContent=fmtBytes(totalEst)}

async function processImg(img,qual,sizePct,forceJpeg){
return new Promise(resolve=>{
const isPng=img.type==='image/png'||(img.src&&img.src.startsWith('data:image/png'));
const isWebp=img.type==='image/webp'||(img.src&&img.src.startsWith('data:image/webp'));
if(!forceJpeg&&(isPng||isWebp)&&sizePct===1){resolve({...img});return}
if(!isPng&&!isWebp&&qual===1&&sizePct===1){resolve({...img});return}
const image=new Image();
image.onload=()=>{
const canvas=document.createElement('canvas');
const ctx=canvas.getContext('2d');
const nw=Math.round(image.width*sizePct);
const nh=Math.round(image.height*sizePct);
canvas.width=nw;canvas.height=nh;
let mime='image/jpeg';
if(!forceJpeg){if(isPng)mime='image/png';else if(isWebp)mime='image/webp'}
if(mime==='image/jpeg'){ctx.fillStyle='#000';ctx.fillRect(0,0,nw,nh)}
ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='high';
ctx.drawImage(image,0,0,nw,nh);
const outQual=mime==='image/png'?1:qual;
const newSrc=canvas.toDataURL(mime,outQual);
const head='data:'+mime+';base64,';
const szBytes=Math.round((newSrc.length-head.length)*3/4);
resolve({...img,src:newSrc,size:szBytes,width:nw,height:nh,type:mime})
};
image.src=img.src
})}

async function downloadPhotos(){
const qual=document.getElementById('qualSlider').value/100;
const sizePct=document.getElementById('sizeSlider').value/100;
const forceJpeg=document.getElementById('forceJpeg').checked;
const prog=document.getElementById('prog');
const progFill=document.getElementById('progFill');
const progText=document.getElementById('progText');
const dlBtn=document.getElementById('dlBtn');
prog.classList.add('active');
dlBtn.disabled=true;
try{
const zip=new JSZip();
const safeName=albumName.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9\\-_]/g,'-').replace(/-+/g,'-').replace(/^-|-\$/g,'')||'photos';
const folder=zip.folder(safeName);
for(let i=0;i<D.length;i++){
progText.textContent='–û–±—Ä–∞–±–æ—Ç–∫–∞ '+(i+1)+' –∏–∑ '+D.length+'...';
progFill.style.width=((i/D.length)*80)+'%';
const processed=await processImg(D[i],qual,sizePct,forceJpeg);
const base64=processed.src.split(',')[1];
let ext='jpg';
if(processed.type==='image/png'||processed.src.startsWith('data:image/png'))ext='png';
else if(processed.type==='image/webp'||processed.src.startsWith('data:image/webp'))ext='webp';
let fn=D[i].name||('photo_'+String(i+1).padStart(3,'0')+'.'+ext);
const parts=fn.split('.');if(parts.length>1)parts.pop();fn=parts.join('.')+'.'+ext;
folder.file(fn,base64,{base64:true});
await new Promise(r=>setTimeout(r,10))
}
progText.textContent='–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
progFill.style.width='90%';
const content=await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
progFill.style.width='100%';
progText.textContent='–ì–æ—Ç–æ–≤–æ!';
saveAs(content,safeName+'-photos.zip');
setTimeout(()=>{prog.classList.remove('active');closeExportModal()},1000)
}catch(e){alert('–û—à–∏–±–∫–∞: '+e.message)}
finally{dlBtn.disabled=false}
}
<\/script>
</body>
</html>`;
        }

        function showLoader(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            document.getElementById('loader-text').textContent = text;
            document.getElementById('loader').classList.toggle('active', show);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        document.getElementById('caption-input').addEventListener('keydown', e => {
            if (e.key === 'Enter') saveCaption();
            if (e.key === 'Escape') closeCaptionModal();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Admin Panel</title>
    <link id="favicon" rel="icon" href="img/supabase.png" type="image/png">

    <!-- Локальные ресурсы БЕЗ Tailwind -->
    <script src="webfonts/supabase-js@2.js"></script>
    <script src="webfonts/xlsx.full.min.js"></script>
    <script src="webfonts/jszip.min.js"></script>
    <script src="webfonts/FileSaver.min.js"></script>
    
    <style>
        /* Минимальные стили для замены Tailwind */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; }
        .flex { display: flex; }
        .h-screen { height: 100vh; }
        .p-6 { padding: 1.5rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .w-full { width: 100%; }
        .p-2 { padding: 0.5rem; }
        .rounded { border-radius: 0.375rem; }
        .bg-gray-800 { background-color: #1f2937; }
        .text-white { color: #ffffff; }
        .bg-gray-700 { background-color: #374151; }
        .border { border-width: 1px; }
        .border-gray-600 { border-color: #4b5563; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .bg-green-600 { background-color: #16a34a; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .bg-blue-600 { background-color: #2563eb; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        
        /* Стили, которые были в прошлом коде */
        .sidebar { width: 320px; transition: transform 0.3s ease-in-out; overflow-y: auto; position: fixed; top: 0; left: 0; height: 100%;}
        .main-content { transition: margin-left 0.3s ease-in-out; flex: 1; padding: 2rem; overflow-y: auto; margin-left: 320px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.5rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .gap-8 { gap: 2rem; }
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div id="loadingSpinnerSection">
            <div class="spinner"></div>
            <span id="loadingMessage" class="ml-3 mt-2">Загрузка...</span>
        </div>
    </div>

    <div class="flex h-screen">
        <aside id="sidebar" class="sidebar bg-gray-800 text-white p-6 space-y-6">
            <h1 style="font-size: 1.5rem; font-weight: 600;">Supabase Admin</h1>
            <div>
                <h2 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">Подключение</h2>
                <form id="connectionForm" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <input type="text" id="connName" placeholder="Имя подключения (имя файла)" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" required autocomplete="off">
                    <input type="url" id="connUrl" placeholder="Supabase URL (https://xyz.supabase.co)" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" required autocomplete="url">
                    <input type="password" id="connKey" placeholder="Service Role Secret" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" required autocomplete="current-password">
                    <button type="submit" id="connectButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-2 rounded">Подключиться</button>
                </form>
                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                    <button id="saveConnectionFileButton" style="flex: 1;" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded text-sm">Сохранить</button>
                    <button id="loadConnectionFileButton" style="flex: 1;" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded text-sm">Открыть</button>
                </div>
            </div>
            <hr style="border-color: #374151;">
             <div id="sqlSetupSection" style="padding: 0.25rem; background-color: #374151; border-radius: 0.5rem;">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">SQL Настройка</h3>
                <p style="font-size: 0.75rem; margin-bottom: 0.5rem; padding: 0 0.5rem;">Для работы панели выполните SQL скрипт в вашем Supabase проекте (SQL Editor):</p>
                <div style="position: relative; background-color: #111827; padding: 0.75rem; border-radius: 0.25rem; margin: 0.5rem;">
                    <button id="copySqlButton" style="position: absolute; top: 0.5rem; right: 0.5rem; background-color: #4f46e5; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; z-index: 10;">Копировать SQL</button>
                    <pre><code id="sqlScriptContent" style="font-size: 0.75rem; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; display: block;">-- SQL script will be here later --</code></pre>
                </div>
            </div>
        </aside>

        <main id="mainContent" class="main-content">
            <div id="welcomeMessage" class="text-center">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Добро пожаловать в Supabase Admin Panel</h2>
                <p style="color: #4b5563;">Для начала работы введите данные для подключения в панели слева или загрузите сохраненный файл конфигурации (.spb).</p>
            </div>
            <div id="dashboard" class="hidden">
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.875rem; font-weight: 700;">Панель: <span id="currentConnectionName" style="color: #4f46e5;"></span></h2>
                    <button id="disconnectButton" style="background-color: #ef4444; color: white; font-weight: 700; padding: 0.5rem 1rem; border-radius: 0.25rem;">Отключиться</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <section>
                        <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Таблицы (схема: public)</h3>
                        <div id="tablesList" style="display: flex; flex-direction: column; gap: 0.75rem; background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);"></div>
                    </section>
                    <section>
                        <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">Buckets (Хранилище)</h3>
                        <div id="bucketsList" style="display: flex; flex-direction: column; gap: 0.75rem; background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);"></div>
                    </section>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- УСИЛЕННОЕ ЛОГИРОВАНИЕ ---
    function log(level, message, ...data) {
        const timestamp = new Date().toISOString();
        const prefix = `[Supabase Admin - ${level.toUpperCase()}]`;

        switch (level) {
            case 'error': console.error(`${timestamp} ${prefix}`, message, ...data); break;
            case 'warn': console.warn(`${timestamp} ${prefix}`, message, ...data); break;
            default: console.log(`${timestamp} ${prefix}`, message, ...data);
        }
    }

    log('info', '>>> DOMContentLoaded event fired. Initializing application...');

    // --- Глобальные переменные ---
    const { createClient } = supabase;
    let supabaseClient = null;
    let currentConnectionDetails = null;

    // --- DOM Элементы ---
    const el = (id) => document.getElementById(id);
    const connectionForm = el('connectionForm');
    const connNameInput = el('connName');
    const connUrlInput = el('connUrl');
    const connKeyInput = el('connKey');
    const loadConnectionFileButton = el('loadConnectionFileButton');
    const dashboardEl = el('dashboard');
    const welcomeMessageEl = el('welcomeMessage');
    const currentConnectionNameEl = el('currentConnectionName');
    const disconnectButton = el('disconnectButton');
    const tablesListEl = el('tablesList');
    const bucketsListEl = el('bucketsList');
    const loadingOverlay = el('loadingOverlay');
    const loadingMessageEl = el('loadingMessage');
    const sqlScriptContentEl = el('sqlScriptContent');

    // --- Функции-помощники ---
    function showLoading(message = 'Загрузка...') {
        log('warn', `>>> CALLING showLoading() with message: "${message}"`);
        loadingMessageEl.textContent = message;
        loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        log('warn', `<<< CALLING hideLoading()`);
        loadingOverlay.classList.add('hidden');
    }

    function showDisconnectedState() {
        log('info', 'Setting UI to disconnected state.');
        dashboardEl.classList.add('hidden');
        welcomeMessageEl.classList.remove('hidden');
        tablesListEl.innerHTML = '';
        bucketsListEl.innerHTML = '';
        currentConnectionNameEl.textContent = '';
    }

    // --- Основные функции ---
    async function connectToSupabase(connection) {
        log('info', '>>> ENTERING connectToSupabase');
        showLoading('Подключение...');
        try {
            log('info', 'connectToSupabase: try block started.');
            if (supabaseClient) {
                log('info', 'connectToSupabase: Removing existing channels.');
                supabaseClient.removeAllChannels();
            }
            supabaseClient = createClient(connection.url, connection.key, { auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false } });
            log('info', 'connectToSupabase: Client created. Testing connection...');
            
            // Заглушка для RPC вызова для теста
            // В реальном коде здесь будет вызов RPC
            await new Promise(resolve => setTimeout(resolve, 500)); // Имитация задержки сети
            
            log('info', 'connectToSupabase: Connection test successful.');
            currentConnectionDetails = connection;
            currentConnectionNameEl.textContent = connection.name;
            welcomeMessageEl.classList.add('hidden');
            dashboardEl.classList.remove('hidden');
            log('info', 'connectToSupabase: UI updated to connected state.');
            await loadDashboardData();

        } catch (err) {
            log('error', 'connectToSupabase: CATCH block executed.', err);
            supabaseClient = null;
            currentConnectionDetails = null;
            showDisconnectedState();
        } finally {
            log('info', 'connectToSupabase: FINALLY block executed.');
            hideLoading();
        }
        log('info', '<<< EXITING connectToSupabase');
    }

    async function loadDashboardData() {
        log('info', '>>> ENTERING loadDashboardData');
        showLoading('Загрузка данных...');
        try {
            log('info', 'loadDashboardData: try block started.');
            // Имитация загрузки таблиц и бакетов
            await new Promise(resolve => setTimeout(resolve, 500));
            tablesListEl.innerHTML = '<div>Таблица 1</div>';
            bucketsListEl.innerHTML = '<div>Бакет 1</div>';
            log('info', 'loadDashboardData: Mock data loaded.');
        } catch (err) {
            log('error', 'loadDashboardData: CATCH block executed.', err);
        } finally {
            log('info', 'loadDashboardData: FINALLY block executed.');
            hideLoading();
        }
        log('info', '<<< EXITING loadDashboardData');
    }
    
    // --- Обработчики событий ---
    log('info', 'Attaching event listeners...');

    connectionForm.addEventListener('submit', (e) => {
        log('info', 'Event: connectionForm submitted.');
        e.preventDefault();
        const name = connNameInput.value.trim();
        const url = connUrlInput.value.trim();
        const key = connKeyInput.value.trim();
        if (!name || !url || !key) {
             log('warn', 'Connection form submitted with empty fields.');
             return;
        }
        connectToSupabase({ name, url, key });
    });

    loadConnectionFileButton.addEventListener('click', () => {
        log('info', 'Event: loadConnectionFileButton clicked.');
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.spb';
        input.onchange = (event) => {
            log('info', 'Event: file selected via input.');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    log('info', 'FileReader onload event triggered.');
                    // Здесь будет логика деобфускации и авто-подключения.
                    // Для теста просто вызовем connectToSupabase с фейковыми данными
                     const connectionName = file.name.replace(/\.spb$/i, '');
                     connNameInput.value = connectionName;
                     connUrlInput.value = 'https://mock.supabase.co';
                     connKeyInput.value = 'mock-key';
                     await connectToSupabase({
                         name: connectionName,
                         url: 'https://mock.supabase.co',
                         key: 'mock-key'
                     });
                };
                reader.onerror = () => {
                    log('error', 'FileReader onerror event triggered.');
                }
                reader.readAsText(file);
            } else {
                 log('info', 'File selection cancelled.');
            }
        };
        input.click();
    });

    disconnectButton.addEventListener('click', () => {
        log('info', 'Event: disconnectButton clicked.');
        if (supabaseClient) supabaseClient.removeAllChannels();
        supabaseClient = null;
        currentConnectionDetails = null;
        showDisconnectedState();
    });

    // --- Начальная настройка ---
    log('info', 'Performing initial UI setup.');
    showDisconnectedState(); // Устанавливаем начальное состояние
    
    // Восстанавливаем SQL-скрипт в поле
    sqlScriptContentEl.textContent = `-- 1. Функция для тестирования соединения\nCREATE OR REPLACE FUNCTION test_connection_schema() ...\n-- 2. Функция для получения списка таблиц\nCREATE OR REPLACE FUNCTION get_public_user_tables() ...\n-- и т.д.`;

    log('info', '<<< Application initialization complete.');
});
</script>
</body>
</html>
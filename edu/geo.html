<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ì–µ–æ-–°–∫–∞–Ω–µ—Ä: –®–∏—Ä–æ—Ç–∞ –∏ –î–æ–ª–≥–æ—Ç–∞</title>
<style>
    :root {
        --bg-color: #0d1117;
        --card-bg: #161b22;
        --accent: #2f81f7;
        --text-main: #c9d1d9;
        --text-muted: #8b949e;
        --border: #30363d;
        --highlight: #238636;
    }

    body {
        font-family: 'Segoe UI', 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    h1 { margin-bottom: 20px; color: var(--accent); }

    .search-box {
        display: flex;
        gap: 10px;
        width: 100%;
        max-width: 600px;
        margin-bottom: 30px;
    }

    input {
        flex: 1;
        padding: 12px 20px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: #fff;
        font-size: 16px;
        outline: none;
    }

    input:focus { border-color: var(--accent); }

    button {
        padding: 12px 24px;
        background: var(--accent);
        border: none;
        border-radius: 6px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    button:hover { opacity: 0.9; }
    button:disabled { background: var(--text-muted); cursor: not-allowed; }

    #target-info {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 8px;
        border: 1px solid var(--border);
        width: 100%;
        max-width: 600px;
        display: none;
    }

    .coords-display {
        font-family: 'Consolas', monospace;
        color: var(--accent);
        font-size: 1.2em;
        margin-top: 10px;
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
        max-width: 1200px;
    }

    .column {
        flex: 1;
        min-width: 300px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .col-header {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
    }

    .city-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 600px;
        overflow-y: auto;
    }

    .city-item {
        padding: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .city-item:hover { background: rgba(255,255,255,0.03); }

    .city-name { font-weight: 500; color: #fff; }
    .city-meta { font-size: 0.85em; color: var(--text-muted); text-align: right; }
    .current-city { background: rgba(47, 129, 247, 0.15); border-left: 3px solid var(--accent); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-color); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    .loader {
        display: inline-block;
        width: 20px; height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .badge {
        font-size: 0.75em;
        padding: 2px 6px;
        border-radius: 4px;
        background: #333;
        margin-left: 8px;
    }
</style>
</head>
<body>

    <h1>üåç –ì–µ–æ-–°–∫–∞–Ω–µ—Ä</h1>

    <div class="search-box">
        <input type="text" id="cityInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, Tokyo, New York)..." onkeydown="if(event.key==='Enter') startSearch()">
        <button onclick="startSearch()" id="btnSearch">–ü–æ–∏—Å–∫</button>
    </div>

    <div id="target-info">
        <h2 id="target-name" style="margin:0; color:#fff;"></h2>
        <div class="coords-display" id="target-coords"></div>
        <div style="margin-top:10px; font-size:0.9em; color:var(--text-muted);">
            –ò—â–µ–º —Å–æ—Å–µ–¥–µ–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö <span style="color:#fff;">¬±0.5¬∞</span>
        </div>
    </div>

    <div class="container" id="results-container" style="display:none;">
        <!-- –ö–æ–ª–æ–Ω–∫–∞ —à–∏—Ä–æ—Ç—ã -->
        <div class="column">
            <div class="col-header">
                <span>‚Üî –ù–∞ —Ç–æ–π –∂–µ –®–ò–†–û–¢–ï</span>
                <div class="loader" id="loader-lat"></div>
            </div>
            <div style="font-size:0.8em; color:var(--text-muted); margin-bottom:10px;">
                (–° –ó–∞–ø–∞–¥–∞ –Ω–∞ –í–æ—Å—Ç–æ–∫)
            </div>
            <ul class="city-list" id="list-lat"></ul>
        </div>

        <!-- –ö–æ–ª–æ–Ω–∫–∞ –¥–æ–ª–≥–æ—Ç—ã -->
        <div class="column">
            <div class="col-header">
                <span>‚Üï –ù–∞ —Ç–æ–π –∂–µ –î–û–õ–ì–û–¢–ï</span>
                <div class="loader" id="loader-lon"></div>
            </div>
            <div style="font-size:0.8em; color:var(--text-muted); margin-bottom:10px;">
                (–° –°–µ–≤–µ—Ä–∞ –Ω–∞ –Æ–≥)
            </div>
            <ul class="city-list" id="list-lon"></ul>
        </div>
    </div>

<script>
    const el = {
        input: document.getElementById('cityInput'),
        btn: document.getElementById('btnSearch'),
        targetInfo: document.getElementById('target-info'),
        targetName: document.getElementById('target-name'),
        targetCoords: document.getElementById('target-coords'),
        results: document.getElementById('results-container'),
        listLat: document.getElementById('list-lat'),
        listLon: document.getElementById('list-lon'),
        loaderLat: document.getElementById('loader-lat'),
        loaderLon: document.getElementById('loader-lon')
    };

    let currentTarget = null;

    async function startSearch() {
        const query = el.input.value.trim();
        if (!query) return;

        // –°–±—Ä–æ—Å UI
        el.btn.disabled = true;
        el.targetInfo.style.display = 'none';
        el.results.style.display = 'none';
        el.listLat.innerHTML = '';
        el.listLon.innerHTML = '';

        try {
            // 1. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≥–æ—Ä–æ–¥–∞)
            const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&accept-language=ru`;
            const res = await fetch(searchUrl);
            const data = await res.json();

            if (!data || data.length === 0) {
                alert('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                el.btn.disabled = false;
                return;
            }

            currentTarget = {
                name: data[0].display_name.split(',')[0],
                full_name: data[0].display_name,
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon)
            };

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            el.targetName.innerText = currentTarget.name;
            el.targetCoords.innerHTML = `LAT: ${currentTarget.lat.toFixed(4)} &nbsp;|&nbsp; LON: ${currentTarget.lon.toFixed(4)}`;
            el.targetInfo.style.display = 'block';
            el.results.style.display = 'flex';

            // –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π
            el.btn.disabled = false;
            fetchSameLatitude();
            fetchSameLongitude();

        } catch (e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
            el.btn.disabled = false;
        }
    }

    async function fetchSameLatitude() {
        el.loaderLat.style.display = 'inline-block';
        const lat = currentTarget.lat;
        const offset = 0.5;

        // Overpass Query: –ò—â–µ–º –≥–æ—Ä–æ–¥–∞ –≤ –ø–æ–ª–æ—Å–µ —à–∏—Ä–æ—Ç, –ø–æ –≤—Å–µ–π –¥–æ–ª–≥–æ—Ç–µ (-180..180)
        // –§–∏–ª—å—Ç—Ä: place=city –ò–õ–ò (place=town –ò –Ω–∞—Å–µ–ª–µ–Ω–∏–µ > 50000)
        const query = `
            [out:json][timeout:25];
            (
              node["place"="city"](${lat - offset},-180,${lat + offset},180);
              node["place"="town"](if:t["population"] > 50000)(${lat - offset},-180,${lat + offset},180);
            );
            out body;
        `;

        try {
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            const data = await res.json();

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–æ–ª–≥–æ—Ç–µ (West -> East)
            const cities = data.elements.sort((a, b) => a.lon - b.lon);
            renderList(cities, el.listLat, 'lon');
        } catch (e) {
            el.listLat.innerHTML = '<li class="city-item">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö OSM</li>';
        } finally {
            el.loaderLat.style.display = 'none';
        }
    }

    async function fetchSameLongitude() {
        el.loaderLon.style.display = 'inline-block';
        const lon = currentTarget.lon;
        const offset = 0.5;

        // Overpass Query: –ò—â–µ–º –≥–æ—Ä–æ–¥–∞ –≤ –ø–æ–ª–æ—Å–µ –¥–æ–ª–≥–æ—Ç, –ø–æ –≤—Å–µ–π —à–∏—Ä–æ—Ç–µ (-90..90)
        const query = `
            [out:json][timeout:25];
            (
              node["place"="city"](-90,${lon - offset},90,${lon + offset});
              node["place"="town"](if:t["population"] > 50000)(-90,${lon - offset},90,${lon + offset});
            );
            out body;
        `;

        try {
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            const data = await res.json();

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —à–∏—Ä–æ—Ç–µ (North -> South)
            const cities = data.elements.sort((a, b) => b.lat - a.lat);
            renderList(cities, el.listLon, 'lat');
        } catch (e) {
            el.listLon.innerHTML = '<li class="city-item">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö OSM</li>';
        } finally {
            el.loaderLon.style.display = 'none';
        }
    }

    function renderList(cities, container, varyCoord) {
        container.innerHTML = '';
        if (cities.length === 0) {
            container.innerHTML = '<li class="city-item" style="color:#666">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>';
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏—â–µ–º –≥–æ—Ä–æ–¥ –≤ —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç (–¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏), –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ
        // –ù–æ –ø—Ä–æ—â–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ø–æ—Ö–æ–∂–∏–π, –µ—Å–ª–∏ –æ–Ω –Ω–∞–π–¥–µ—Ç—Å—è
        
        cities.forEach(city => {
            const name = city.tags['name:ru'] || city.tags['name:en'] || city.tags['name'];
            const population = city.tags['population'];
            const lat = city.lat.toFixed(2);
            const lon = city.lon.toFixed(2);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—à –ª–∏ —ç—Ç–æ –∏—Å—Ö–æ–¥–Ω—ã–π –≥–æ—Ä–æ–¥ (–ø–æ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º)
            const isCurrent = (Math.abs(city.lat - currentTarget.lat) < 0.05 && Math.abs(city.lon - currentTarget.lon) < 0.05);

            const li = document.createElement('li');
            li.className = `city-item ${isCurrent ? 'current-city' : ''}`;

            let popStr = population ? `<br>üë• ${(population/1000).toFixed(0)}k` : '';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            let coordInfo = '';
            if (varyCoord === 'lon') {
                // –í —Å–ø–∏—Å–∫–µ —à–∏—Ä–æ—Ç –º–µ–Ω—è–µ—Ç—Å—è –¥–æ–ª–≥–æ—Ç–∞
                coordInfo = `<span style="color:#fff">${lon}¬∞</span> / ${lat}¬∞`;
            } else {
                // –í —Å–ø–∏—Å–∫–µ –¥–æ–ª–≥–æ—Ç –º–µ–Ω—è–µ—Ç—Å—è —à–∏—Ä–æ—Ç–∞
                coordInfo = `${lon}¬∞ / <span style="color:#fff">${lat}¬∞</span>`;
            }

            li.innerHTML = `
                <div>
                    <div class="city-name">${name} <span class="badge">${city.tags['place']}</span></div>
                </div>
                <div class="city-meta">
                    ${coordInfo}
                    ${popStr}
                </div>
            `;
            container.appendChild(li);
            
            if (isCurrent) {
                setTimeout(() => li.scrollIntoView({ behavior: "smooth", block: "center" }), 500);
            }
        });
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 11 Cloud Ultimate</title>
    <!-- Иконки -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- Библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-color: #f3f3f3;
            --win-bg: rgba(255, 255, 255, 0.96);
            --taskbar-bg: rgba(243, 243, 243, 0.85);
            --primary-color: #0067c0;
            --sel-color: #cce8ff;
            --hover-color: #e5f3ff;
        }
        * { box-sizing: border-box; user-select: none; margin: 0; padding: 0; outline: none; font-family: 'Segoe UI', sans-serif; }
        
        body {
            overflow: hidden; height: 100vh;
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564') no-repeat center center/cover;
            display: flex; flex-direction: column;
        }

        /* --- Lock Screen --- */
        #lock-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: inherit; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); transition: top 0.6s ease-in-out;
        }
        #lock-screen.hidden { top: -100%; }
        
        .auth-box {
            background: rgba(255,255,255,0.95); padding: 30px; border-radius: 8px;
            width: 320px; text-align: center; display: flex; flex-direction: column; gap: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .auth-btn { 
            padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 12px; font-weight: 600; font-size: 14px; transition: 0.2s; color: #444;
        }
        .auth-btn:hover { background: #f5f5f5; border-color: #ccc; }

        /* --- User Widget & Menu --- */
        .desktop { flex: 1; padding: 10px; display: flex; flex-direction: column; gap: 10px; position: relative; align-items: flex-start; }
        
        .user-widget {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.2); padding: 6px 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 10px; color: white;
            backdrop-filter: blur(10px); cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s; z-index: 5000;
        }
        .user-widget:hover { background: rgba(0,0,0,0.4); }
        .user-widget-avatar { width: 24px; height: 24px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #333; }

        #user-menu {
            position: absolute; top: 55px; right: 15px; width: 220px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: none; flex-direction: column; overflow: hidden; z-index: 5001;
            border: 1px solid rgba(0,0,0,0.1); padding: 5px;
        }
        .um-item { padding: 8px 10px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; color: #333; border-radius: 4px; }
        .um-item:hover { background: var(--primary-color); color: white; }
        .um-sep { height: 1px; background: #ddd; margin: 4px 10px; }
        .um-danger:hover { background: #e81123; color: white; }

        .desktop-icon {
            width: 80px; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; padding: 8px 5px; border-radius: 4px; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); transition: 0.2s;
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.1); }
        .desktop-icon i { font-size: 36px; margin-bottom: 5px; color: #4db2ff; }
        .desktop-icon span { font-size: 12px; text-align: center; line-height: 1.2; }

        /* --- Window System --- */
        .window {
            position: absolute; background: var(--win-bg); backdrop-filter: blur(25px);
            border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid #aaa; display: flex; flex-direction: column;
            overflow: hidden; opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s;
        }
        .window.show { opacity: 1; pointer-events: auto; transform: scale(1); }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: calc(100% - 48px) !important; border-radius: 0; transform: none !important; }

        .win-header {
            height: 32px; display: flex; justify-content: space-between; align-items: center;
            padding-left: 10px; background: transparent; flex-shrink: 0;
        }
        .win-title { font-size: 12px; color: #333; display: flex; align-items: center; gap: 8px; }
        .win-controls { display: flex; height: 100%; z-index: 200; }
        .win-btn { width: 45px; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .win-btn:hover { background: rgba(0,0,0,0.1); }
        .win-btn.close:hover { background: #e81123; color: white; }

        /* Explorer */
        #explorer { width: 800px; height: 500px; top: 10%; left: 15%; }
        .exp-toolbar { padding: 8px; border-bottom: 1px solid #eee; display: flex; gap: 10px; background: rgba(255,255,255,0.5); }
        .exp-btn { display: flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 13px; border: 1px solid transparent; background: transparent; }
        .exp-btn:hover { background: rgba(0,0,0,0.05); }
        .exp-btn.blue { color: var(--primary-color); }
        
        .exp-layout { flex: 1; display: flex; overflow: hidden; }
        .exp-sidebar { width: 180px; padding: 10px; background: rgba(255,255,255,0.4); border-right: 1px solid #eee; }
        .side-item { padding: 8px; border-radius: 4px; cursor: pointer; display: flex; gap: 10px; font-size: 13px; align-items: center; color: #444; }
        .side-item:hover { background: rgba(0,0,0,0.05); }
        .side-item.active { background: rgba(0,0,0,0.08); color: var(--primary-color); font-weight: 500; }
        
        .exp-content { flex: 1; padding: 10px; background: white; overflow-y: auto; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .file-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 4px; cursor: pointer; text-align: center; border: 1px solid transparent; }
        .file-item:hover { background: var(--hover-color); }
        .file-item.selected { background: var(--sel-color); border-color: #99d1ff; }
        .f-icon { font-size: 36px; margin-bottom: 5px; }
        .f-name { font-size: 11px; word-break: break-word; line-height: 1.3; }

        /* Apps */
        #notepad { width: 500px; height: 400px; top: 15%; left: 30%; background: white; }
        .np-menu { padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 12px; }
        .np-area { flex: 1; border: none; resize: none; padding: 10px; font-family: monospace; font-size: 14px; }

        #photoviewer { width: 700px; height: 500px; top: 12%; left: 20%; background: #202020; }
        #photoviewer .win-title { color: white; } #photoviewer .win-btn { color: white; }
        .pv-body { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #pv-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Browser */
        #yandex { width: 1000px; height: 700px; top: 5%; left: 8%; background: #f0f2f5; }
        .ya-header { height: 70px; background: #dee1e6; display: flex; flex-direction: column; flex-shrink: 0; border-bottom: 1px solid #ccc; }
        .ya-tabs-strip { height: 32px; display: flex; align-items: flex-end; padding-left: 10px; }
        .ya-tab { 
            background: #fff; padding: 5px 15px; border-radius: 10px 10px 0 0; 
            font-size: 12px; display: flex; align-items: center; min-width: 150px; 
            position: relative; box-shadow: 0 -1px 2px rgba(0,0,0,0.05); gap: 8px;
        }
        .ya-favicon { width: 16px; height: 16px; background: red; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 10px; }
        .ya-nav-bar { 
            flex: 1; display: flex; align-items: center; padding: 0 15px; background: #fff; 
            border-bottom: 1px solid #dfe1e5; gap: 15px;
        }
        .ya-nav-btns { display: flex; gap: 10px; }
        .ya-nav-btn { cursor: pointer; border: none; background: none; font-size: 18px; color: #555; }
        .ya-nav-btn:hover { color: #000; }
        .ya-omnibox { 
            flex: 1; height: 34px; background: #f2f2f2; border-radius: 18px; 
            display: flex; align-items: center; padding: 0 15px; border: 2px solid transparent; 
            transition: 0.2s; max-width: 800px;
        }
        .ya-omnibox:focus-within { background: #fff; border-color: #fc0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ya-url-input { flex: 1; border: none; background: transparent; font-size: 14px; outline: none; margin-left: 5px; }
        #ya-frame { width: 100%; height: 100%; border: none; background: white; }

        /* Taskbar */
        .taskbar {
            height: 48px; background: var(--taskbar-bg); backdrop-filter: blur(20px);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
            border-top: 1px solid rgba(255,255,255,0.4);
        }
        .tb-icons { display: flex; gap: 5px; }
        .tb-icon {
            width: 40px; height: 40px; border-radius: 4px; display: flex;
            justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .tb-icon:hover { background: rgba(255,255,255,0.5); }
        .tb-icon.active::after { content: ''; position: absolute; bottom: 3px; width: 12px; height: 3px; background: var(--primary-color); border-radius: 2px; }
        .tb-icon i { font-size: 24px; }
        .start-btn { position: absolute; left: 10px; cursor: pointer; }
        .tb-clock { position: absolute; right: 15px; text-align: right; font-size: 12px; color: #222; }

        /* Context Menu */
        #ctxMenu {
            position: absolute; width: 180px; background: #fcfcfc; 
            border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; flex-direction: column; padding: 4px; z-index: 100000;
        }
        .ctx-item { padding: 6px 10px; display: flex; align-items: center; gap: 10px; font-size: 13px; cursor: pointer; border-radius: 4px; color: #333; }
        .ctx-item:hover { background: var(--primary-color); color: white; }
        .ctx-item.disabled { color: #aaa; pointer-events: none; }
        .ctx-sep { height: 1px; background: #ddd; margin: 3px 0; }

        .c-yellow { color: #ffe68e; } .c-blue { color: #4db2ff; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 20000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-input { width: 100%; padding: 8px; margin: 15px 0; border: 1px solid #ddd; border-radius: 4px; }
        .modal-btns { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        
        /* Styles for Table/List View */
        .file-list { display: flex; flex-direction: column; width: 100%; }
        .file-row { 
            display: flex; align-items: center; padding: 6px 10px; 
            border-bottom: 1px solid #f0f0f0; cursor: pointer; 
            color: #333; font-size: 13px;
        }
        .file-row:hover { background: var(--hover-color); }
        .file-row.selected { background: var(--sel-color); border-color: #99d1ff; }
        
        .list-header { 
            font-weight: 600; background: #fafafa; border-bottom: 1px solid #ddd; 
            cursor: default !important; color: #666; font-size: 12px;
        }
        .list-header:hover { background: #fafafa; }
        
        /* Columns in List View */
        .row-icon { width: 30px; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .row-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 10px; }
        .row-size { width: 100px; text-align: right; color: #777; font-size: 12px; }
        
    </style>
</head>
<body>

    <!-- LOCK SCREEN -->
    <div id="lock-screen">
        <div style="font-size:64px; color:white; margin-bottom:30px" id="ls-time">12:00</div>
        <div class="auth-box">
            <div style="display:flex; justify-content:center"><i class='bx bxs-user' style="font-size:50px; color:#555; background:#eee; padding:15px; border-radius:50%"></i></div>
            <div style="font-weight:bold; font-size:18px;">Вход в систему</div>
            <button class="auth-btn" onclick="loginWithGoogle()">
                <i class='bx bxl-google' style="color: #db4437; font-size: 20px;"></i> Войти через Google Account
            </button>
            <div style="color:red; font-size:12px" id="auth-error"></div>
        </div>
    </div>

    <!-- USER MENU -->
    <div id="user-menu">
        <div class="um-item" onclick="downloadAllData()"><i class='bx bx-archive-in'></i> Сохранить данные (Zip)</div>
        <div class="um-sep"></div>
        <div class="um-item um-danger" onclick="confirmDelete()"><i class='bx bx-trash'></i> Удалить все данные</div>
        <div class="um-sep"></div>
        <div class="um-item" onclick="doLogout()"><i class='bx bx-log-out'></i> Выход</div>
    </div>

    <!-- DESKTOP -->
    <div id="ctxMenu"></div>
    
    <div class="desktop" id="desktop" onclick="handleBgClick()">
        <div class="user-widget" onclick="event.stopPropagation(); document.getElementById('user-menu').style.display='flex'">
            <div class="user-widget-avatar"><i class='bx bxs-user'></i></div>
            <span id="widget-username">Загрузка...</span>
        </div>

        <div class="desktop-icon" onclick="openApp('explorer')">
            <i class='bx bxs-folder'></i><span>Этот<br>компьютер</span>
        </div>
        <div class="desktop-icon" onclick="openApp('yandex')">
            <div style="width:32px; height:32px; background:white; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-bottom:5px">
                <span style="color:red; font-weight:bold; font-size:18px">Я</span>
            </div>
            <span>Браузер</span>
        </div>
    </div>

    <!-- WINDOW: EXPLORER -->
    <div class="window" id="explorer" onmousedown="focusWin('explorer')">
        <div class="win-header" id="explorer-header">
            <div class="win-title"><i class='bx bxs-folder c-yellow'></i> Проводник</div>
            <div class="win-controls">
                <div class="win-btn" onclick="minWindow('explorer')"><i class='bx bx-minus'></i></div>
                <div class="win-btn" onclick="maxWindow('explorer')"><i class='bx bx-square'></i></div>
                <div class="win-btn close" onclick="closeWindow('explorer')"><i class='bx bx-x'></i></div>
            </div>
        </div>
        <div class="exp-toolbar">
            <button class="exp-btn blue" onclick="document.getElementById('upl').click()"><i class='bx bx-plus'></i> Загрузить</button>
            <input type="file" id="upl" hidden multiple onchange="uploadFiles(event)">
            <div style="width:1px; background:#ddd; height:20px"></div>
            <button class="exp-btn" onclick="openFolderModal()"><i class='bx bx-folder-plus'></i> Папка</button>
            <button class="exp-btn" onclick="fsDelete()"><i class='bx bx-trash'></i> Удалить</button>
            <button class="exp-btn" onclick="loadFiles()"><i class='bx bx-refresh'></i></button>
             <button class="exp-btn" onclick="toggleView()"><i class='bx bx-list-ul'></i> Вид</button>
        </div>
        <div class="exp-layout">
            <div class="exp-sidebar">
                <div class="side-item active" id="nav-desktop" onclick="navigate('desktop')"><i class='bx bx-desktop'></i> Рабочий стол</div>
                <div class="side-item" id="nav-downloads" onclick="navigate('downloads')"><i class='bx bx-download'></i> Загрузки</div>
                <div class="side-item" id="nav-documents" onclick="navigate('documents')"><i class='bx bx-file'></i> Документы</div>
                <div class="side-item" id="nav-images" onclick="navigate('images')"><i class='bx bx-image'></i> Изображения</div>
                <div class="side-item" id="nav-trash" onclick="navigate('trash')"><i class='bx bxs-trash'></i> Корзина</div>
            </div>
            <div class="exp-content" id="file-view" onclick="event.stopPropagation(); deselectAll()">Loading...</div>
        </div>
    </div>

    <!-- WINDOW: NOTEPAD -->
    <div class="window" id="notepad" onmousedown="focusWin('notepad')">
        <div class="win-header" id="notepad-header">
            <div class="win-title"><i class='bx bxs-notepad c-blue'></i> Блокнот</div>
            <div class="win-controls">
                <div class="win-btn close" onclick="closeWindow('notepad')"><i class='bx bx-x'></i></div>
            </div>
        </div>
        <div class="np-menu">
            <span style="cursor:pointer; font-weight:bold" onclick="saveNotepad()">Файл (Сохранить)</span>
        </div>
        <textarea class="np-area" id="np-text"></textarea>
    </div>

    <!-- WINDOW: PHOTO VIEWER -->
    <div class="window" id="photoviewer" onmousedown="focusWin('photoviewer')">
        <div class="win-header" id="photoviewer-header">
            <div class="win-title"><i class='bx bxs-image'></i> Фотографии</div>
            <div class="win-controls">
                <div class="win-btn close" onclick="closeWindow('photoviewer')"><i class='bx bx-x'></i></div>
            </div>
        </div>
        <div class="pv-body">
            <img id="pv-img" src="">
        </div>
    </div>

    <!-- WINDOW: YANDEX BROWSER -->
    <div class="window" id="yandex" onmousedown="focusWin('yandex')">
        <div style="position:absolute; top:0; right:0; display:flex; z-index:100; padding:5px;">
            <div class="win-btn" onclick="minWindow('yandex')"><i class='bx bx-minus'></i></div>
            <div class="win-btn" onclick="maxWindow('yandex')"><i class='bx bx-square'></i></div>
            <div class="win-btn close" onclick="closeWindow('yandex')"><i class='bx bx-x'></i></div>
        </div>
        <div class="ya-header" id="yandex-header">
            <div class="ya-tabs-strip">
                <div class="ya-tab">
                    <div class="ya-favicon">Я</div>
                    <span id="ya-tab-title">Новая вкладка</span>
                </div>
            </div>
            <div class="ya-nav-bar">
                <div class="ya-nav-btns">
                    <button class="ya-nav-btn" onclick="document.getElementById('ya-frame').contentWindow.history.back()">←</button>
                    <button class="ya-nav-btn" onclick="document.getElementById('ya-frame').contentWindow.history.forward()">→</button>
                    <button class="ya-nav-btn" onclick="yaNavigate()">↻</button>
                </div>
                <div class="ya-omnibox">
                    <i class='bx bxs-lock-alt' style="color:#00b341; font-size:14px"></i>
                    <input type="text" class="ya-url-input" id="ya-url" placeholder="Введите адрес сайта или запрос" onkeydown="if(event.key==='Enter') yaNavigate()">
                </div>
            </div>
        </div>
        <div style="flex:1; position:relative; background:white;">
            <iframe id="ya-frame" sandbox="allow-forms allow-scripts allow-same-origin allow-presentation" src=""></iframe>
        </div>
    </div>

    <!-- TASKBAR -->
    <div class="taskbar">
        <div class="start-btn" onclick="document.getElementById('user-menu').style.display='flex'"><i class='bx bxl-windows' style="font-size:24px; color:#0067c0"></i></div>
        <div class="tb-icons">
            <div class="tb-icon" id="tb-explorer" onclick="openApp('explorer')"><i class='bx bxs-folder c-yellow'></i></div>
            <div class="tb-icon" id="tb-yandex" onclick="openApp('yandex')"><span style="color:red; font-weight:bold">Я</span></div>
            <div class="tb-icon" id="tb-notepad" onclick="openApp('notepad')" style="display:none"><i class='bx bxs-notepad c-blue'></i></div>
            <div class="tb-icon" id="tb-photoviewer" onclick="openApp('photoviewer')" style="display:none"><i class='bx bxs-image'></i></div>
        </div>
        <div class="tb-clock" id="clock">12:00<br>01.01.2025</div>
    </div>

    <!-- MODALS -->
    <!-- Delete Confirm -->
    <div class="modal" id="del-modal">
        <div class="modal-box">
            <h3>Удалить все данные?</h3>
            <p style="color:#666; font-size:13px; margin:10px 0">Это удалит все ваши файлы из облака безвозвратно. Продолжить?</p>
            <div class="modal-btns">
                <button class="exp-btn" onclick="document.getElementById('del-modal').style.display='none'">Отмена</button>
                <button class="exp-btn" style="background:#e81123; color:white" onclick="nukeData()">УДАЛИТЬ</button>
            </div>
        </div>
    </div>

    <!-- Create Folder -->
    <div class="modal" id="folder-modal">
        <div class="modal-box">
            <h3>Новая папка</h3>
            <input type="text" class="modal-input" id="folder-name-input" placeholder="Имя папки" value="Новая папка">
            <div class="modal-btns">
                <button class="exp-btn" onclick="document.getElementById('folder-modal').style.display='none'">Отмена</button>
                <button class="exp-btn blue" style="background:var(--primary-color); color:white" onclick="confirmCreateFolder()">Создать</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        //  НАСТРОЙКИ (Вставьте свои ключи!)
        // ===============================================
        const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
        // ===============================================

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let files = [];
        let currentPath = 'desktop';
        let selectedIds = [];
        let openFileId = null;
        let appClipboard = null; // { op: 'copy'|'cut', items: [] }
             let viewMode = 'grid'; 

        // --- AUTH ---
        window.addEventListener('load', async () => {
            updateClock(); setInterval(updateClock, 1000);
            
            const { data: { session } } = await sb.auth.getSession();
            if(session) authSuccess(session.user);
            
            sb.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) authSuccess(session.user);
            });

            // Context Menu Listener
            document.addEventListener('contextmenu', e => {
                // Если клик не в десктопе и не в проводнике, стандартное меню
                if(!e.target.closest('.desktop') && !e.target.closest('.exp-content')) return;
                
                e.preventDefault();
                showContextMenu(e);
            });
        });

        async function loginWithGoogle() {
            await sb.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: 'https://vsemap.ru/win' }
            });
        }

        function authSuccess(user) {
            currentUser = user;
            const name = user.user_metadata.full_name || user.email.split('@')[0];
            document.getElementById('widget-username').innerText = name;
            document.getElementById('lock-screen').classList.add('hidden');
            loadFiles();
        }

        async function doLogout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        function handleBgClick() {
            deselectAll();
            document.getElementById('user-menu').style.display='none';
            document.getElementById('ctxMenu').style.display='none';
        }

        // --- FILESYSTEM CORE ---
        async function loadFiles() {
            if(!currentUser) return;
            const { data, error } = await sb.from('files').select('*');
            if(!error) {
                files = data;
                renderFiles();
            }
        }

        // --- CONTEXT MENU LOGIC ---
        function showContextMenu(e) {
            const ctx = document.getElementById('ctxMenu');
            const fileItem = e.target.closest('.file-item');
            
            let html = '';

            if (fileItem) {
                // Clicked on a file/folder
                // Ensure selection
                const id = fileItem.getAttribute('data-id');
                if(!selectedIds.includes(id)) {
                    selectedIds = [id];
                    renderFiles();
                }
                const f = files.find(x => x.id === id);

                html += `<div class="ctx-item" onclick="openFileById('${id}')"><i class='bx bx-folder-open'></i> Открыть</div>`;
                if(f.type !== 'folder') html += `<div class="ctx-item" onclick="downloadFile('${id}')"><i class='bx bx-download'></i> Скачать</div>`;
                html += `<div class="ctx-sep"></div>`;
                html += `<div class="ctx-item" onclick="fsCut()"><i class='bx bx-cut'></i> Вырезать</div>`;
                html += `<div class="ctx-item" onclick="fsCopy()"><i class='bx bx-copy'></i> Копировать</div>`;
                html += `<div class="ctx-sep"></div>`;
                html += `<div class="ctx-item" onclick="fsDelete()"><i class='bx bx-trash'></i> Удалить</div>`;
            } else {
                // Clicked on background
                const canPaste = appClipboard && appClipboard.items.length > 0;
                html += `<div class="ctx-item" onclick="openFolderModal()"><i class='bx bx-folder-plus'></i> Создать папку</div>`;
                html += `<div class="ctx-sep"></div>`;
                html += `<div class="ctx-item ${canPaste?'':'disabled'}" onclick="fsPaste()"><i class='bx bx-paste'></i> Вставить</div>`;
                html += `<div class="ctx-sep"></div>`;
                html += `<div class="ctx-item" onclick="loadFiles()"><i class='bx bx-refresh'></i> Обновить</div>`;
            }

            ctx.innerHTML = html;
            ctx.style.display = 'flex';
            ctx.style.left = e.pageX + 'px';
            ctx.style.top = e.pageY + 'px';
        }

        function openFileById(id) {
            const f = files.find(x => x.id === id);
            if(f) openFile(f);
        }

        // --- CLIPBOARD ACTIONS ---
        function fsCopy() {
            if(!selectedIds.length) return;
            // Копировать можно только файлы (папки сложно рекурсивно копировать)
            const items = files.filter(f => selectedIds.includes(f.id) && f.type !== 'folder');
            if(items.length === 0) return alert("Копирование папок пока не поддерживается");
            appClipboard = { op: 'copy', items: items };
            document.getElementById('ctxMenu').style.display = 'none';
        }

        function fsCut() {
            if(!selectedIds.length) return;
            const items = files.filter(f => selectedIds.includes(f.id));
            appClipboard = { op: 'cut', items: items };
            document.getElementById('ctxMenu').style.display = 'none';
        }

         async function fsPaste() {
            document.getElementById('ctxMenu').style.display = 'none';
            if(!appClipboard || !appClipboard.items.length) return;

            const targetFolder = currentPath;

            if (appClipboard.op === 'cut') {
                for(let item of appClipboard.items) {
                    await sb.from('files').update({ parent_id: targetFolder }).eq('id', item.id);
                }
                appClipboard = null;
            } else {
                // COPY
                for(let item of appClipboard.items) {
                    const newName = "Копия - " + item.name;
                    // При копировании переносим и размер (item.size)
                    if (item.content) {
                        await sb.from('files').insert({
                            name: newName, type: item.type, parent_id: targetFolder, 
                            content: item.content, size: item.size, user_id: currentUser.id
                        });
                    } else if (item.storage_path) {
                        await sb.from('files').insert({
                            name: newName, type: item.type, parent_id: targetFolder,
                            storage_path: item.storage_path, size: item.size, user_id: currentUser.id
                        });
                    }
                }
            }
            loadFiles();
        }

        // --- FOLDER CREATION ---
        function openFolderModal() {
            document.getElementById('ctxMenu').style.display = 'none';
            document.getElementById('folder-modal').style.display = 'flex';
            document.getElementById('folder-name-input').focus();
        }

        async function confirmCreateFolder() {
            const name = document.getElementById('folder-name-input').value;
            if(name) {
                await sb.from('files').insert({
                    name: name, type: 'folder', parent_id: currentPath, user_id: currentUser.id
                });
                loadFiles();
            }
            document.getElementById('folder-modal').style.display = 'none';
        }

           async function uploadFiles(e) {
            const upFiles = Array.from(e.target.files);
            if(!upFiles.length) return;

            for(let file of upFiles) {
                const safeName = file.name.replace(/[<>:"/\\|?*]/g, '');
                let type = 'file';
                if(file.type.startsWith('image/')) type = 'img';
                else if(file.type.includes('text')) type = 'txt';

                let storagePath = null;
                let content = null;

                if(type === 'txt' && file.size < 100000) {
                    content = await file.text();
                } else {
                    const path = `${currentUser.id}/${Date.now()}_${safeName}`;
                    const { error } = await sb.storage.from('user_files').upload(path, file);
                    if(error) { alert('Err: ' + error.message); continue; }
                    storagePath = path;
                }

                // ДОБАВЛЕНО: поле size
                await sb.from('files').insert({
                    name: safeName, type: type, parent_id: currentPath,
                    content: content, storage_path: storagePath, 
                    size: file.size, // Сохраняем размер в байтах
                    user_id: currentUser.id
                });
            }
            e.target.value = '';
            loadFiles();
        }

        async function fsDelete() {
            document.getElementById('ctxMenu').style.display = 'none';
            if(!selectedIds.length) return;
            const toDel = files.filter(f => selectedIds.includes(f.id));
            
            if(currentPath === 'trash') {
                for(let f of toDel) {
                    if(f.storage_path) await sb.storage.from('user_files').remove([f.storage_path]);
                    await sb.from('files').delete().eq('id', f.id);
                }
            } else {
                for(let f of toDel) {
                    await sb.from('files').update({ parent_id: 'trash' }).eq('id', f.id);
                }
            }
            selectedIds = [];
            loadFiles();
        }

        // --- RECURSIVE ZIP DOWNLOAD ---
        async function downloadAllData() {
            if(!files.length) return alert("Нет файлов");
            
            const zip = new JSZip();
            document.getElementById('widget-username').innerText = "Архивация...";

            // Рекурсивная функция для построения дерева
            async function addFolderToZip(zipFolder, parentId) {
                // Находим файлы в текущей папке
                const items = files.filter(f => f.parent_id === parentId);
                
                for (const item of items) {
                    if (item.type === 'folder') {
                        // Создаем папку в ZIP и идем внутрь
                        const newZipFolder = zipFolder.folder(item.name);
                        await addFolderToZip(newZipFolder, item.id);
                    } else {
                        // Добавляем файл
                        if (item.content) {
                            zipFolder.file(item.name, item.content);
                        } else if (item.storage_path) {
                            const { data } = await sb.storage.from('user_files').download(item.storage_path);
                            if(data) zipFolder.file(item.name, data);
                        }
                    }
                }
            }

            // Начинаем с корня ('desktop') и других папок ('documents', etc.)
            // Для простоты скачиваем только то, что на 'desktop' и в стандартных папках
            // Если вы хотите скачать ВСЕ, можно начать с виртуального корня
            const roots = ['desktop', 'documents', 'downloads', 'images'];
            for(let root of roots) {
                const rootFolder = zip.folder(root);
                await addFolderToZip(rootFolder, root);
            }

            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "MyCloudData.zip");
                document.getElementById('widget-username').innerText = currentUser.user_metadata.full_name;
            });
        }

        // --- NUKE DATA ---
        function confirmDelete() { document.getElementById('del-modal').style.display='flex'; }
        
        async function nukeData() {
            document.getElementById('del-modal').style.display='none';
            document.getElementById('widget-username').innerText = "Удаление...";
            
            const { data: stFiles } = await sb.storage.from('user_files').list(currentUser.id);
            if(stFiles && stFiles.length > 0) {
                const paths = stFiles.map(f => `${currentUser.id}/${f.name}`);
                await sb.storage.from('user_files').remove(paths);
            }

            await sb.from('files').delete().neq('id', '00000000-0000-0000-0000-000000000000'); 
            doLogout();
        }

        // --- NAVIGATION ---
        function navigate(path) {
            currentPath = path; selectedIds = [];
            document.querySelectorAll('.side-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById('nav-'+path);
            if(btn) btn.classList.add('active');
            renderFiles();
        }

        function enterFolder(id) { currentPath = id; selectedIds = []; renderFiles(); }

    function toggleView() {
            viewMode = viewMode === 'grid' ? 'list' : 'grid';
            renderFiles();
        }

        // --- Вспомогательная функция для размера (можно доработать) ---
          function getSize(f) {
            if (f.type === 'folder') return '';
            
            let bytes = 0;
            // Если есть сохраненный размер в БД (новые файлы)
            if (f.size) {
                bytes = f.size;
            } 
            // Фоллбэк для старых текстовых файлов
            else if (f.content) {
                bytes = new Blob([f.content]).size;
            } else {
                return '-';
            }

            if (bytes < 1024) return bytes + ' Б';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' Кб';
            return (bytes / (1024 * 1024)).toFixed(2) + ' Мб';
        }

        // --- ОБНОВЛЕННАЯ функция рендеринга ---
        function renderFiles() {
            const view = document.getElementById('file-view');
            view.innerHTML = '';
            
            const currentFiles = files.filter(f => f.parent_id === String(currentPath));

            if(currentFiles.length === 0) {
                view.innerHTML = '<div style="color:#999; text-align:center; margin-top:50px">Пусто</div>'; 
                return;
            }

            // РЕЖИМ СЕТКИ (Крупные иконки)
            if (viewMode === 'grid') {
                const grid = document.createElement('div');
                grid.className = 'file-grid';
                currentFiles.forEach(f => {
                    const el = document.createElement('div');
                    el.className = `file-item ${selectedIds.includes(f.id) ? 'selected' : ''}`;
                    // Сохраняем ID для контекстного меню
                    el.setAttribute('data-id', f.id); 
                    el.innerHTML = `${getIcon(f.type)}<div class="f-name">${f.name}</div>`;
                    
                    el.onclick = (e) => { e.stopPropagation(); selectedIds = [f.id]; renderFiles(); };
                    el.ondblclick = () => openFile(f);
                    grid.appendChild(el);
                });
                view.appendChild(grid);
            } 
            
            // РЕЖИМ ТАБЛИЦЫ (Список с размером)
            else {
                const list = document.createElement('div');
                list.className = 'file-list';
                
                // Заголовок таблицы
                list.innerHTML = `
                    <div class="file-row list-header">
                        <div class="row-icon"></div>
                        <div class="row-name">Имя</div>
                        <div class="row-size">Размер</div>
                    </div>
                `;

                currentFiles.forEach(f => {
                    const el = document.createElement('div');
                    el.className = `file-row ${selectedIds.includes(f.id) ? 'selected' : ''}`;
                    el.setAttribute('data-id', f.id);
                    
                    // Маленькая иконка для списка
                    let iconHtml = getIcon(f.type);
                    // Уменьшаем размер иконки через style или класс (тут хак заменой класса для простоты)
                    iconHtml = iconHtml.replace('font-size: 36px', 'font-size: 20px').replace('f-icon', ''); 

                    el.innerHTML = `
                        <div class="row-icon">${iconHtml}</div>
                        <div class="row-name">${f.name}</div>
                        <div class="row-size">${getSize(f)}</div>
                    `;
                    
                    el.onclick = (e) => { e.stopPropagation(); selectedIds = [f.id]; renderFiles(); };
                    el.ondblclick = () => openFile(f);
                    list.appendChild(el);
                });
                view.appendChild(list);
            }
        }

        function getIcon(type) {
            if(type==='folder') return `<i class='bx bxs-folder c-yellow f-icon'></i>`;
            if(type==='img') return `<i class='bx bxs-image c-blue f-icon'></i>`;
            if(type==='txt') return `<i class='bx bxs-file-txt f-icon' style="color:#777"></i>`;
            return `<i class='bx bxs-file f-icon' style="color:#aaa"></i>`;
        }

        function deselectAll() { selectedIds = []; renderFiles(); }

        // --- APP LOGIC ---
        async function openFile(f) {
            if(f.type === 'folder') enterFolder(f.id);
            else if(f.type === 'txt') {
                openApp('notepad');
                document.getElementById('np-text').value = f.content || '';
                openFileId = f.id;
            }
            else if(f.type === 'img' && f.storage_path) {
                const { data } = await sb.storage.from('user_files').createSignedUrl(f.storage_path, 3600);
                if(data) { openApp('photoviewer'); document.getElementById('pv-img').src = data.signedUrl; }
            }
        }

        let zIndex = 100;
        function openApp(id) {
            const win = document.getElementById(id);
            const tb = document.getElementById('tb-' + id);
            win.classList.add('show');
            if(tb) { tb.style.display = 'flex'; tb.classList.add('active'); }
            win.style.zIndex = ++zIndex;
            if(id === 'notepad' && !openFileId) document.getElementById('np-text').value = '';
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            win.classList.remove('show');
            const tb = document.getElementById('tb-' + id);
            if(tb) { tb.classList.remove('active'); if(id!=='explorer' && id!=='yandex') setTimeout(()=>tb.style.display='none', 200); }
            if(id==='notepad') openFileId = null;
        }

        function minWindow(id) { document.getElementById(id).classList.remove('show'); }
        function maxWindow(id) { document.getElementById(id).classList.toggle('maximized'); }
        function focusWin(id) { document.getElementById(id).style.zIndex = ++zIndex; }

              async function saveNotepad() {
            const val = document.getElementById('np-text').value;
            // Считаем размер строки в байтах
            const blobSize = new Blob([val]).size;

            if(openFileId) {
                await sb.from('files').update({ content: val, size: blobSize }).eq('id', openFileId);
            } else {
                await sb.from('files').insert({
                    name: 'New.txt', type: 'txt', parent_id: 'desktop', 
                    content: val, size: blobSize, user_id: currentUser.id
                });
            }
            loadFiles();
            alert('Сохранено');
        }

        function yaNavigate() {
            let val = document.getElementById('ya-url').value.trim();
            const frame = document.getElementById('ya-frame');
            const tabTitle = document.getElementById('ya-tab-title');
            
            if(!val) return;

            let url = "";
            const isDomain = /^[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+(\/.*)?$/.test(val);

            if (isDomain) {
                url = val.startsWith('http') ? val : 'https://' + val;
            } else {
                url = 'https://www.bing.com/search?q=' + encodeURIComponent(val);
            }

            let shortTitle = url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0];
            if(shortTitle.length > 20) shortTitle = shortTitle.substring(0, 20) + '...';
            tabTitle.innerText = shortTitle;
            
            frame.src = url;
        }

        async function downloadFile(id) {
            document.getElementById('ctxMenu').style.display='none';
            const f = files.find(x => x.id === id);
            if(!f) return;
            let url;
            if(f.content) url = URL.createObjectURL(new Blob([f.content], {type: 'text/plain'}));
            else if(f.storage_path) {
                const { data } = await sb.storage.from('user_files').download(f.storage_path);
                url = URL.createObjectURL(data);
            }
            const a = document.createElement('a'); a.href = url; a.download = f.name; a.click();
        }

        function makeDraggable(id, handle) {
            const win = document.getElementById(id);
            const head = document.getElementById(handle || id + '-header');
            let isDown = false, offX, offY;
            head.onmousedown = (e) => { 
                if(e.target.closest('.win-btn') || e.target.tagName === 'INPUT') return;
                isDown = true; 
                offX = e.clientX - win.offsetLeft; offY = e.clientY - win.offsetTop;
                win.style.zIndex = ++zIndex;
            };
            window.onmousemove = (e) => {
                if(isDown && !win.classList.contains('maximized')) {
                    win.style.left = (e.clientX - offX) + 'px'; win.style.top = (e.clientY - offY) + 'px';
                }
            };
            window.onmouseup = () => isDown = false;
        }
        makeDraggable('explorer'); makeDraggable('notepad'); makeDraggable('photoviewer'); makeDraggable('yandex', 'yandex-header');

        function updateClock() {
            const d = new Date();
            document.getElementById('clock').innerHTML = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + '<br>' + d.toLocaleDateString();
            document.getElementById('ls-time').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }
    </script>
</body>
</html>
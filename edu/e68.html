<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0" />
  <title>Solar System: Dual Theme</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Jura:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Переменные по умолчанию (Dark Theme) */
      --bg-color: #050508;
      --panel-bg: rgba(20, 20, 35, 0.6);
      --panel-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-sec: #8b9bb4;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.5);
      --btn-bg: rgba(255, 255, 255, 0.05);
      --btn-hover: rgba(255, 255, 255, 0.15);
      --chip-active-bg: rgba(59, 130, 246, 0.2);
      --chip-active-border: #3b82f6;
      
      --font-display: 'Jura', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    /* Светлая тема */
    [data-theme="light"] {
      --bg-color: #f2f4f6; /* Светло-серый, "лабораторный" */
      --panel-bg: rgba(255, 255, 255, 0.75);
      --panel-border: rgba(0, 0, 0, 0.05);
      --text-main: #1a1c20;
      --text-sec: #64748b;
      --accent: #2563eb;
      --accent-glow: rgba(37, 99, 235, 0.2);
      --btn-bg: rgba(0, 0, 0, 0.04);
      --btn-hover: rgba(0, 0, 0, 0.08);
      --chip-active-bg: #eff6ff;
      --chip-active-border: #2563eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: var(--bg-color);
      font-family: var(--font-body);
      color: var(--text-main);
      transition: background 0.5s ease, color 0.5s ease;
    }

    canvas { display: block; outline: none; z-index: 1; }

    /* UI Layer */
    #ui-layer {
      position: absolute; inset: 0; z-index: 10; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 24px;
    }

    /* Top Bar */
    .top-bar {
      pointer-events: auto;
      display: flex; justify-content: space-between; align-items: flex-start;
    }

    .app-title h1 {
      font-family: var(--font-display); font-weight: 700; font-size: 24px;
      letter-spacing: 1px; text-transform: uppercase;
      background: linear-gradient(135deg, var(--text-main), var(--text-sec));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .app-title span { font-size: 10px; color: var(--text-sec); letter-spacing: 2px; text-transform: uppercase; font-weight: 600; }

    /* Theme Toggle */
    .theme-toggle {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--panel-bg); border: 1px solid var(--panel-border);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-main);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .theme-toggle:hover { transform: scale(1.05); background: var(--btn-hover); }
    .theme-toggle svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }

    /* Bottom Dock */
    .dock-container {
      pointer-events: auto;
      align-self: center; width: 100%; max-width: 800px;
      display: flex; justify-content: center;
    }

    .dock {
      background: var(--panel-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--panel-border);
      padding: 12px; border-radius: 24px;
      display: flex; gap: 12px; align-items: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }

    /* Planet Chips */
    .planet-scroller {
      display: flex; gap: 6px; overflow-x: auto; padding: 4px;
      -ms-overflow-style: none; scrollbar-width: none;
    }
    .planet-scroller::-webkit-scrollbar { display: none; }

    .planet-chip {
      padding: 8px 16px; border-radius: 14px;
      background: var(--btn-bg); color: var(--text-sec);
      font-family: var(--font-display); font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap; border: 1px solid transparent;
      transition: all 0.2s; user-select: none;
    }
    .planet-chip:hover { background: var(--btn-hover); color: var(--text-main); }
    .planet-chip.active {
      background: var(--chip-active-bg); color: var(--accent);
      border-color: var(--chip-active-border);
      box-shadow: 0 2px 10px var(--accent-glow);
    }

    /* Reset Button (Sun) */
    .reset-btn {
      width: 44px; height: 44px; flex-shrink: 0;
      border-radius: 14px; background: var(--btn-bg);
      border: 1px solid transparent; color: var(--text-sec);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s;
    }
    .reset-btn:hover {
      background: #fbbf24; color: #fff; /* Gold color for sun */
      box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
      border-color: #f59e0b;
    }
    .reset-btn svg { width: 22px; height: 22px; stroke-width: 2; }
    
    .divider { width: 1px; height: 24px; background: var(--panel-border); margin: 0 4px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
      opacity: 0; visibility: hidden; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }

    .info-card {
      width: 90%; max-width: 420px;
      background: var(--bg-color); color: var(--text-main);
      border: 1px solid var(--panel-border);
      border-radius: 24px; padding: 32px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      transform: translateY(20px) scale(0.95); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .modal-overlay.visible .info-card { transform: translateY(0) scale(1); }

    .card-title { font-family: var(--font-display); font-size: 32px; margin-bottom: 4px; }
    .card-subtitle { color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 24px; font-weight: 600; }
    
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .stat-item h4 { font-size: 10px; text-transform: uppercase; color: var(--text-sec); margin-bottom: 4px; }
    .stat-item p { font-family: var(--font-display); font-size: 16px; font-weight: 500; }
    
    .card-fact { font-size: 14px; line-height: 1.5; color: var(--text-sec); padding-top: 16px; border-top: 1px solid var(--panel-border); }

    @media (max-width: 600px) {
      .dock { flex-direction: column-reverse; padding: 10px; width: 100%; border-radius: 20px; gap: 10px; }
      .dock-container { max-width: 100%; }
      .planet-scroller { width: 100%; justify-content: flex-start; padding: 0 4px; }
      .divider { display: none; }
      .reset-btn { width: 100%; height: 40px; border-radius: 12px; }
      .top-bar { margin-bottom: 20px; }
    }
  </style>
</head>
<body data-theme="dark">

  <!-- UI -->
  <div id="ui-layer">
    <div class="top-bar">
      <div class="app-title">
        <h1>Solaris</h1>
        <span>Interactive System</span>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()" title="Сменить тему">
        <!-- Moon Icon -->
        <svg class="moon-icon" viewBox="0 0 24 24" style="display:block"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <!-- Sun Icon (hidden by default logic) -->
        <svg class="sun-icon" viewBox="0 0 24 24" style="display:none"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      </button>
    </div>

    <div class="dock-container">
      <div class="dock">
        <button class="reset-btn" onclick="clearAll()" title="Сбросить (Новая система)">
          <!-- Красивое солнце -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path><path d="M12 20v2"></path>
            <path d="M4.93 4.93l1.41 1.41"></path><path d="M17.66 17.66l1.41 1.41"></path>
            <path d="M2 12h2"></path><path d="M20 12h2"></path>
            <path d="M6.34 17.66l-1.41 1.41"></path><path d="M19.07 4.93l-1.41 1.41"></path>
          </svg>
        </button>
        <div class="divider"></div>
        <div class="planet-scroller" id="planetButtons">
          <!-- JS Generation -->
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal">
    <div class="info-card">
      <h2 class="card-title" id="mTitle">Mars</h2>
      <p class="card-subtitle" id="mType">Planet</p>
      <div class="stats-row" id="mStats"></div>
      <p class="card-fact" id="mFact">...</p>
      <button onclick="closeModal()" style="margin-top:20px; width:100%; padding:12px; background:var(--btn-bg); border:none; border-radius:12px; cursor:pointer; color:var(--text-sec);">Закрыть</button>
    </div>
  </div>

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";

    // --- CONFIG ---
    const PLANETS = {
      Меркурий: { order: 1, radius: 2439, tex: 'textures/mercury2.jpg', bump: 'textures/mercury2.jpg', info: { mass: '3.3 × 10²³', temp: '427°C', dist: '58M km' }, fact: 'Самая маленькая планета системы.', type: 'Земная группа' },
      Венера: { order: 2, radius: 6051, tex: 'textures/venus.jpg', bump: 'textures/venus.jpg', glow: 0xffaa55, info: { mass: '4.9 × 10²⁴', temp: '462°C', dist: '108M km' }, fact: 'Вращается в обратную сторону.', type: 'Земная группа' },
      Земля: { order: 3, radius: 6371, tex: 'textures/earth-blue-marble.jpg', spec: 'textures/earth2.jpg', glow: 0x4488ff, info: { mass: '5.9 × 10²⁴', temp: '15°C', dist: '150M km' }, fact: 'Единственный дом для жизни.', type: 'Земная группа' },
      Марс: { order: 4, radius: 3389, tex: 'textures/mars.jpg', bump: 'textures/mars2.jpg', glow: 0xff4422, info: { mass: '6.4 × 10²³', temp: '-60°C', dist: '228M km' }, fact: 'Имеет самую высокую гору Олимп.', type: 'Земная группа' },
      Юпитер: { order: 5, radius: 69911, tex: 'textures/jupiter.jpg', glow: 0xeebb99, info: { mass: '1.9 × 10²⁷', temp: '-108°C', dist: '778M km' }, fact: 'Больше всех планет вместе взятых.', type: 'Газовый гигант' },
      Сатурн: { order: 6, radius: 58232, tex: 'textures/saturn.jpg', glow: 0xeeddcc, ring: { tex: 'textures/saturn2.png', inner: 1.3, outer: 2.4 }, info: { mass: '5.7 × 10²⁶', temp: '-139°C', dist: '1.4B km' }, fact: 'Кольца состоят из льда и пыли.', type: 'Газовый гигант' },
      Уран: { order: 7, radius: 25362, tex: 'textures/uranus.jpg', glow: 0x88ffff, info: { mass: '8.7 × 10²⁵', temp: '-197°C', dist: '2.9B km' }, fact: 'Вращается "лёжа на боку".', type: 'Ледяной гигант' },
      Нептун: { order: 8, radius: 24622, tex: 'textures/neptune.jpg', glow: 0x3355ff, info: { mass: '1.0 × 10²⁶', temp: '-201°C', dist: '4.5B km' }, fact: 'Ветры дуют быстрее звука.', type: 'Ледяной гигант' }
    };
    const BASE_SCALE = 1 / 4000;

    // --- SCENE ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050508);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 50000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ReinhardToneMapping;
    document.body.appendChild(renderer.domElement);

    // --- POST PROCESSING ---
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85);
    composer.addPass(bloomPass);

    // --- CONTROLS ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.minDistance = 10;
    controls.maxDistance = 1000;
    controls.enableZoom = false; // Custom handling

    // --- LIGHTS ---
    const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
    dirLight.position.set(50, 20, 50);
    scene.add(dirLight);

    // --- STARS (Dark Mode Only) ---
    function createStars() {
      const geo = new THREE.BufferGeometry();
      const count = 3000;
      const pos = new Float32Array(count * 3);
      const sizes = new Float32Array(count);
      for(let i=0; i<count; i++){
        const r = 800 + Math.random()*1000;
        const theta = Math.random()*Math.PI*2;
        const phi = Math.acos(2*Math.random()-1);
        pos[i*3] = r*Math.sin(phi)*Math.cos(theta);
        pos[i*3+1] = r*Math.cos(phi);
        pos[i*3+2] = r*Math.sin(phi)*Math.sin(theta);
        sizes[i] = Math.random() * 1.5;
      }
      geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
      
      const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 1, transparent: true, opacity: 0.8 });
      const stars = new THREE.Points(geo, mat);
      return stars;
    }
    const starField = createStars();
    scene.add(starField);

    // --- METEORS (Shooting Stars) ---
    class MeteorSystem {
      constructor() {
        this.meteors = [];
        const geo = new THREE.BufferGeometry();
        // 20 lines
        const pos = new Float32Array(20 * 6); // 2 points * 3 coords
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        this.mesh = new THREE.LineSegments(geo, new THREE.LineBasicMaterial({ 
          color: 0xaaddff, transparent: true, opacity: 0.6 
        }));
        scene.add(this.mesh);
        
        for(let i=0; i<20; i++) {
          this.meteors.push({
            x: (Math.random()-0.5)*1000, y: (Math.random()-0.5)*600, z: -500 - Math.random()*500,
            speed: 2 + Math.random()*3,
            len: 30 + Math.random()*50,
            active: Math.random() > 0.5
          });
        }
      }
      update() {
        const posAttr = this.mesh.geometry.attributes.position;
        this.meteors.forEach((m, i) => {
          if(!m.active) {
            if(Math.random() < 0.005) { // Chance to spawn
              m.active = true;
              m.x = 400 + Math.random()*200;
              m.y = 300 + Math.random()*200;
              m.z = -200 - Math.random()*400;
            }
          } else {
            m.x -= m.speed * 2;
            m.y -= m.speed;
            if(m.x < -600 || m.y < -400) m.active = false;
          }
          // Update line segment
          if(m.active) {
            posAttr.setXYZ(i*2, m.x, m.y, m.z);
            posAttr.setXYZ(i*2+1, m.x + m.len, m.y + m.len*0.5, m.z);
          } else {
            posAttr.setXYZ(i*2, 0,0,0); posAttr.setXYZ(i*2+1, 0,0,0);
          }
        });
        posAttr.needsUpdate = true;
      }
    }
    const meteors = new MeteorSystem();

    // --- PLANET LOGIC ---
    const texLoader = new THREE.TextureLoader();
    const planetsGroup = new THREE.Group();
    scene.add(planetsGroup);
    let activePlanets = [];
    const addedKeys = new Set();

    function createPlanet(key) {
      const d = PLANETS[key];
      const r = d.radius * BASE_SCALE;
      const grp = new THREE.Group();
      
      // Main Mesh
      const mat = new THREE.MeshPhongMaterial({ 
        map: texLoader.load(d.tex), shininess: 10 
      });
      if(d.bump) { mat.bumpMap = texLoader.load(d.bump); mat.bumpScale = 0.01; }
      if(d.spec) mat.specularMap = texLoader.load(d.spec);
      
      const mesh = new THREE.Mesh(new THREE.SphereGeometry(r, 64, 64), mat);
      grp.add(mesh);

      // --- SUBTLE GLOW ---
      // p: 6.0 (high power makes it thin), c: 0.3 (low coef makes it faint)
      const glowMat = new THREE.ShaderMaterial({
        uniforms: { 
          c: { value: 0.35 }, p: { value: 6.5 },
          glowColor: { value: new THREE.Color(d.glow || 0x4488ff) },
          viewVector: { value: camera.position }
        },
        vertexShader: `uniform vec3 viewVector; uniform float c; uniform float p; varying float intensity; void main() { vec3 vNormal = normalize( normalMatrix * normal ); vec3 vNormel = normalize( normalMatrix * viewVector ); intensity = pow( c - dot(vNormal, vNormel), p ); gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`,
        fragmentShader: `uniform vec3 glowColor; varying float intensity; void main() { gl_FragColor = vec4( glowColor, intensity ); }`,
        side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false
      });
      const glow = new THREE.Mesh(new THREE.SphereGeometry(r*1.15, 64, 64), glowMat);
      // Store ref to disable in light mode if needed, but subtle glow looks ok in light mode too
      grp.userData.glow = glow; 
      grp.add(glow);

      // Rings
      if(d.ring) {
        const ringGeo = new THREE.RingGeometry(d.radius * d.ring.inner * BASE_SCALE, d.radius * d.ring.outer * BASE_SCALE, 128);
        const ringMat = new THREE.MeshStandardMaterial({ 
          map: texLoader.load(d.ring.tex), side: THREE.DoubleSide, transparent: true, opacity: 0.8 
        });
        // UV Fix
        const pos = ringGeo.attributes.position; const v3 = new THREE.Vector3();
        for(let i=0; i<pos.count; i++) {
          v3.fromBufferAttribute(pos, i);
          const maxR = d.radius * d.ring.outer * BASE_SCALE;
          ringGeo.attributes.uv.setXY(i, 0.5+v3.x/(maxR*2), 0.5+v3.y/(maxR*2));
        }
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.rotation.x = -Math.PI/2;
        grp.add(ring);
      }

      grp.userData = { name: key, ...d };
      return grp;
    }

    // --- POSITIONS & CAMERA ---
    let camTarget = new THREE.Vector3();
    let camPosTarget = new THREE.Vector3(0, 30, 80);
    let interacting = false;

    function updateLayout() {
      if(activePlanets.length === 0) return;
      activePlanets.sort((a,b) => PLANETS[a.userData.name].order - PLANETS[b.userData.name].order);
      
      let x = 0;
      activePlanets.forEach((p, i) => {
        if(i > 0) {
          const prev = activePlanets[i-1];
          const gap = (p.userData.radius + prev.userData.radius) * BASE_SCALE * 1.5 + 4; // gap
          // Extra space for rings
          const prevRing = PLANETS[prev.userData.name].ring ? prev.userData.radius*BASE_SCALE : 0;
          const currRing = PLANETS[p.userData.name].ring ? p.userData.radius*BASE_SCALE : 0;
          x += gap + prevRing + currRing;
        }
        p.userData.tx = x;
      });
      // Center
      const total = activePlanets[activePlanets.length-1].userData.tx;
      activePlanets.forEach(p => p.userData.tx -= total/2);
      
      // Cam Fit
      const width = total + 10;
      const dist = Math.max(width, 25) * 1.2;
      camPosTarget.set(0, dist*0.4, dist);
      interacting = false;
    }

    // --- INTERACTION ---
    window.addPlanet = (k) => {
      if(addedKeys.has(k)) return;
      const p = createPlanet(k);
      p.scale.set(0,0,0);
      planetsGroup.add(p);
      activePlanets.push(p);
      addedKeys.add(k);
      updateLayout();
      updateUI();
      // Anim in
      let t=0; function anim(){ t+=0.05; p.scale.setScalar(Math.min(t,1)); if(t<1) requestAnimationFrame(anim); } anim();
    };
    
    window.removePlanet = (k) => {
      const p = activePlanets.find(x => x.userData.name === k);
      if(!p) return;
      let t=1;
      function anim(){ 
        t-=0.08; p.scale.setScalar(Math.max(t,0)); 
        if(t>0) requestAnimationFrame(anim); 
        else { planetsGroup.remove(p); activePlanets = activePlanets.filter(x=>x!==p); addedKeys.delete(k); updateLayout(); updateUI(); }
      } anim();
    };

    window.clearAll = () => { [...activePlanets].forEach(p => window.removePlanet(p.userData.name)); };

    // --- UI & THEME ---
    const btnBox = document.getElementById('planetButtons');
    Object.keys(PLANETS).forEach(k => {
      const b = document.createElement('div');
      b.className = 'planet-chip'; b.textContent = k; b.dataset.p = k;
      b.onclick = () => { if(addedKeys.has(k)) window.removePlanet(k); else window.addPlanet(k); };
      btnBox.appendChild(b);
    });

    function updateUI() {
      document.querySelectorAll('.planet-chip').forEach(b => {
        if(addedKeys.has(b.dataset.p)) b.classList.add('active'); else b.classList.remove('active');
      });
    }

    // --- THEME LOGIC ---
    let isDark = true;
    window.toggleTheme = () => {
      isDark = !isDark;
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
      
      // Update Icons
      document.querySelector('.moon-icon').style.display = isDark ? 'block' : 'none';
      document.querySelector('.sun-icon').style.display = isDark ? 'none' : 'block';

      // Update 3D Scene
      if (isDark) {
        scene.background = new THREE.Color(0x050508);
        scene.fog = null;
        starField.visible = true;
        meteors.mesh.visible = true;
        bloomPass.strength = 1.0;
        ambLight.intensity = 0.6;
      } else {
        scene.background = new THREE.Color(0xf2f4f6); // Light gray lab
        scene.fog = new THREE.Fog(0xf2f4f6, 50, 500); // Soft fog
        starField.visible = false;
        meteors.mesh.visible = false;
        bloomPass.strength = 0; // Bloom looks bad on white
        ambLight.intensity = 1.0; // Brighter ambient
      }
    };

    // Initial Planet
    window.addPlanet('Земля');
    window.addPlanet('Марс');

    // --- LOOP ---
    renderer.domElement.addEventListener('wheel', () => interacting = true);
    controls.addEventListener('start', () => interacting = true);

    function animate() {
      requestAnimationFrame(animate);
      
      if(!interacting) {
        camera.position.lerp(camPosTarget, 0.05);
        controls.target.lerp(new THREE.Vector3(0,0,0), 0.05);
      }
      
      activePlanets.forEach(p => {
        p.position.x += (p.userData.tx - p.position.x) * 0.1;
        p.children[0].rotation.y += 0.002;
        if(p.userData.glow) p.userData.glow.material.uniforms.viewVector.value = camera.position;
      });

      if(isDark) meteors.update();

      controls.update();
      composer.render();
    }
    
    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();

    // Modal Logic
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    window.addEventListener('dblclick', (e) => {
      mouse.x = (e.clientX/innerWidth)*2-1; mouse.y = -(e.clientY/innerHeight)*2+1;
      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(planetsGroup.children, true);
      if(hits.length) {
        let obj = hits[0].object;
        while(obj.parent && obj.parent !== planetsGroup) obj = obj.parent;
        const d = obj.userData;
        document.getElementById('mTitle').textContent = d.name;
        document.getElementById('mType').textContent = d.type;
        document.getElementById('mStats').innerHTML = `
          <div class="stat-item"><h4>Масса</h4><p>${d.info.mass}</p></div>
          <div class="stat-item"><h4>t°</h4><p>${d.info.temp}</p></div>
          <div class="stat-item"><h4>От Солнца</h4><p>${d.info.dist}</p></div>
        `;
        document.getElementById('mFact').textContent = d.fact;
        document.getElementById('modal').classList.add('visible');
      }
    });
    window.closeModal = () => document.getElementById('modal').classList.remove('visible');
  </script>
</body>
</html>
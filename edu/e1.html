<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ñ–æ –æ –≥–æ—Ä–æ–¥–µ –Ω–∞ –∫–∞—Ä—Ç–µ</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { width: 100%; height: 100%; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–∞–ª—É–Ω–∞ (–æ–∫–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏) */
        .balloon-content {
            min-width: 250px;
            max-width: 300px;
        }
        .balloon-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #ffcc00; /* –Ø–Ω–¥–µ–∫—Å –∂–µ–ª—Ç—ã–π */
            padding-bottom: 5px;
        }
        .balloon-row {
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .balloon-row span:first-child {
            font-weight: 600;
            color: #333;
        }
        .weather-block {
            background-color: #f0f8ff;
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .weather-icon { font-size: 24px; }
        .wiki-link {
            display: block;
            margin-top: 12px;
            text-align: right;
            color: #007bff;
            text-decoration: none;
            font-size: 13px;
        }
        .wiki-link:hover { text-decoration: underline; }
        .loader { text-align: center; color: #888; font-style: italic; }
    </style>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã. –ö–ª—é—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π/–ø—É–±–ª–∏—á–Ω—ã–π, –ª—É—á—à–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>

<div id="map"></div>

<script>
    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API ---
    const WIKI_API = "https://ru.wikipedia.org/w/api.php";
    const WIKIDATA_API = "https://www.wikidata.org/w/api.php";
    const WEATHER_API = "https://api.open-meteo.com/v1/forecast";

    // --- –°–ª–æ–≤–∞—Ä–∏–∫ –∫–æ–¥–æ–≤ –ø–æ–≥–æ–¥—ã WMO ---
    const weatherCodes = {
        0: ['‚òÄÔ∏è', '–Ø—Å–Ω–æ'], 1: ['üå§Ô∏è', '–ü—Ä–µ–∏–º. —è—Å–Ω–æ'], 2: ['‚õÖ', '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å'], 3: ['‚òÅÔ∏è', '–ü–∞—Å–º—É—Ä–Ω–æ'],
        45: ['üå´Ô∏è', '–¢—É–º–∞–Ω'], 48: ['üå´Ô∏è', '–ò–∑–º–æ—Ä–æ–∑—å'],
        51: ['üåßÔ∏è', '–õ—ë–≥–∫–∞—è –º–æ—Ä–æ—Å—å'], 53: ['üåßÔ∏è', '–ú–æ—Ä–æ—Å—å'], 55: ['üåßÔ∏è', '–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å'],
        61: ['üåßÔ∏è', '–°–ª–∞–±—ã–π –¥–æ–∂–¥—å'], 63: ['üåßÔ∏è', '–î–æ–∂–¥—å'], 65: ['üåßÔ∏è', '–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å'],
        71: ['‚ùÑÔ∏è', '–°–ª–∞–±—ã–π —Å–Ω–µ–≥'], 73: ['‚ùÑÔ∏è', '–°–Ω–µ–≥'], 75: ['‚ùÑÔ∏è', '–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥'],
        80: ['üå¶Ô∏è', '–õ–∏–≤–µ–Ω—å'], 95: ['‚õàÔ∏è', '–ì—Ä–æ–∑–∞']
    };

    ymaps.ready(init);

    function init() {
        const map = new ymaps.Map("map", {
            center: [55.751574, 37.573856], // –ú–æ—Å–∫–≤–∞
            zoom: 9,
            controls: ['zoomControl', 'searchControl', 'typeSelector']
        });

        // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑—É–º –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞—à–µ —Å–æ–±—ã—Ç–∏–µ
        map.behaviors.disable('dblClickZoom');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        map.events.add('dblclick', async function (e) {
            const coords = e.get('coords');
            
            // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å—Ä–∞–∑—É –≤ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞
            map.balloon.open(coords, {
                contentHeader: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                contentBody: '<div class="loader">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–º –ø—É–Ω–∫—Ç–µ...</div>'
            });

            try {
                // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const data = await gatherCityInfo(coords);
                
                // 3. –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –±–∞–ª—É–Ω–∞
                const htmlContent = buildBalloonContent(data);

                // 4. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª—É–Ω
                map.balloon.setData({
                    contentBody: htmlContent
                });

            } catch (error) {
                console.error(error);
                map.balloon.setData({
                    contentBody: `<div style="color:red;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –Ω–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç.</div>`
                });
            }
        });
    }

    // --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ---
    async function gatherCityInfo(coords) {
        const [lat, lon] = coords;
        
        // 1. –Ø–Ω–¥–µ–∫—Å –ì–µ–æ–∫–æ–¥–µ—Ä (–ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ)
        const geocodeRes = await ymaps.geocode(coords, { kind: 'locality', results: 1 });
        const firstGeoObject = geocodeRes.geoObjects.get(0);
        
        if (!firstGeoObject) throw new Error("–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–æ—Å–∫–≤–∞")
        const cityName = firstGeoObject.getLocalities().length > 0 
            ? firstGeoObject.getLocalities()[0] 
            : firstGeoObject.getName();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–æ—Å—ã –∫ –í–∏–∫–∏–ø–µ–¥–∏–∏/–í–∏–∫–∏–¥–∞–Ω–Ω—ã–º –∏ –ü–æ–≥–æ–¥–µ
        const [wikiData, weatherData] = await Promise.all([
            fetchWikiData(cityName),
            fetchWeather(lat, lon)
        ]);

        return {
            name: cityName,
            ...wikiData,
            ...weatherData
        };
    }

    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏ –∏ –í–∏–∫–∏–¥–∞–Ω–Ω—ã—Ö ---
    async function fetchWikiData(query) {
        const result = { population: '–Ω/–¥', area: '–Ω/–¥', wikiUrl: '#', summary: '' };

        try {
            // –ê. –ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏
            const searchUrl = `${WIKI_API}?origin=*&action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json`;
            const searchRes = await fetch(searchUrl).then(r => r.json());
            
            if (!searchRes.query.search.length) return result;
            
            const title = searchRes.query.search[0].title;
            
            // –ë. –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Å—Ç–∞—Ç—å–∏ –∏ ID —Å—É—â–Ω–æ—Å—Ç–∏ –í–∏–∫–∏–¥–∞–Ω–Ω—ã—Ö (Wikibase Item)
            const infoUrl = `${WIKI_API}?origin=*&action=query&prop=info|pageprops&inprop=url&ppprop=wikibase_item&titles=${encodeURIComponent(title)}&format=json`;
            const infoRes = await fetch(infoUrl).then(r => r.json());
            
            const pageId = Object.keys(infoRes.query.pages)[0];
            const pageData = infoRes.query.pages[pageId];

            result.wikiUrl = pageData.fullurl;
            
            if (pageData.pageprops && pageData.pageprops.wikibase_item) {
                // –í. –ó–∞–ø—Ä–æ—Å –∫ –í–∏–∫–∏–¥–∞–Ω–Ω—ã–º (–∑–∞ –Ω–∞—Å–µ–ª–µ–Ω–∏–µ–º –∏ –ø–ª–æ—â–∞–¥—å—é)
                const qId = pageData.pageprops.wikibase_item; // –ù–∞–ø—Ä–∏–º–µ—Ä, Q649
                const wdUrl = `${WIKIDATA_API}?origin=*&action=wbgetentities&ids=${qId}&props=claims&format=json`;
                const wdRes = await fetch(wdUrl).then(r => r.json());
                
                const claims = wdRes.entities[qId].claims;

                // P1082 - –ù–∞—Å–µ–ª–µ–Ω–∏–µ
                if (claims.P1082 && claims.P1082[0]) {
                    const popVal = claims.P1082[0].mainsnak.datavalue.value.amount;
                    result.population = parseInt(popVal.replace('+', '')).toLocaleString('ru-RU');
                }

                // P2046 - –ü–ª–æ—â–∞–¥—å
                if (claims.P2046 && claims.P2046[0]) {
                    const areaVal = claims.P2046[0].mainsnak.datavalue.value.amount;
                    result.area = parseFloat(areaVal.replace('+', '')).toFixed(1) + ' –∫–º¬≤';
                }
            }
        } catch (e) {
            console.warn("Wiki fetch error", e);
        }
        return result;
    }

    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã ---
    async function fetchWeather(lat, lon) {
        try {
            const url = `${WEATHER_API}?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&wind_speed_unit=ms`;
            const res = await fetch(url).then(r => r.json());
            
            if (!res.current) return { temp: '?', weatherText: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', weatherIcon: '‚ùì' };

            const code = res.current.weather_code;
            const weatherInfo = weatherCodes[code] || ['üå°Ô∏è', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
            
            return {
                temp: Math.round(res.current.temperature_2m),
                weatherIcon: weatherInfo[0],
                weatherText: weatherInfo[1]
            };
        } catch (e) {
            return { temp: '?', weatherText: '–û—à–∏–±–∫–∞', weatherIcon: '‚ö†Ô∏è' };
        }
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---
    function buildBalloonContent(data) {
        return `
            <div class="balloon-content">
                <div class="balloon-header">${data.name}</div>
                
                <div class="balloon-row">
                    <span>üë• –ù–∞—Å–µ–ª–µ–Ω–∏–µ:</span>
                    <span>${data.population}</span>
                </div>
                <div class="balloon-row">
                    <span>üìê –ü–ª–æ—â–∞–¥—å:</span>
                    <span>${data.area}</span>
                </div>

                <div class="weather-block">
                    <div class="weather-icon">${data.weatherIcon}</div>
                    <div>
                        <div style="font-weight:bold; font-size:16px;">${data.temp > 0 ? '+' : ''}${data.temp}¬∞C</div>
                        <div style="font-size:12px; color:#666;">${data.weatherText}</div>
                    </div>
                </div>

                <a href="${data.wikiUrl}" target="_blank" class="wiki-link">
                    üìñ –ß–∏—Ç–∞—Ç—å –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏ &rarr;
                </a>
            </div>
        `;
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢–µ—Å—Ç: –ù—É—Ä–ª–∞—Ç (–†–∞—Å—á–µ—Ç vs API)</title>
<style>
    body {
        background-color: #0e1217;
        color: #fff;
        font-family: 'Segoe UI', system-ui, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px;
    }
    h1 { margin-bottom: 10px; color: #ffd700; }
    .subtitle { color: #8ba4b8; margin-bottom: 40px; }
    
    .container {
        display: flex;
        gap: 40px;
        width: 100%;
        max-width: 900px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .card {
        flex: 1;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .card h2 {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 15px;
        margin-top: 0;
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .card.math h2 { color: #00f3ff; }
    .card.api h2 { color: #00ff88; }

    .result-row {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
        font-size: 16px;
    }
    .label { color: #8ba4b8; }
    .value { font-family: 'Consolas', monospace; font-weight: bold; font-size: 18px; }
    
    .sun-val { color: #ffdd44; }
    .moon-val { color: #aaccff; }

    .diff-info {
        margin-top: 30px;
        font-size: 13px;
        color: #555;
        max-width: 600px;
        text-align: center;
    }
    
    button {
        padding: 12px 24px;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 20px;
        transition: 0.2s;
    }
    button:hover { background: #0052cc; }

</style>
</head>
<body>

    <h1>–ù—É—Ä–ª–∞—Ç, –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω</h1>
    <div class="subtitle">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 54.43¬∞ N, 50.80¬∞ E | –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: UTC+3</div>

    <button onclick="runComparison()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>

    <div class="container">
        <!-- –ë–ª–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ -->
        <div class="card math">
            <h2>üßÆ JS –†–∞—Å—á–µ—Ç (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)</h2>
            <div id="math-results">
                <div class="result-row"><span class="label">–°—Ç–∞—Ç—É—Å:</span> <span class="value">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ API -->
        <div class="card api">
            <h2>üì° –î–∞–Ω–Ω—ã–µ API (Open-Meteo)</h2>
            <div id="api-results">
                <div class="result-row"><span class="label">–°—Ç–∞—Ç—É—Å:</span> <span class="value">–û–∂–∏–¥–∞–Ω–∏–µ...</span></div>
            </div>
        </div>
    </div>

    <div class="diff-info">
        * "JS –†–∞—Å—á–µ—Ç" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Å–æ—Ç—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.<br>
        * API —É—á–∏—Ç—ã–≤–∞–µ—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—É—é —Ä–µ—Ñ—Ä–∞–∫—Ü–∏—é –∏ —Å–ª–æ–∂–Ω—ã–π —Ä–µ–ª—å–µ—Ñ, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–Ω–∏—Ü–∞ –≤ 2-5 –º–∏–Ω—É—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–∞.
    </div>

<script>
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ù—É—Ä–ª–∞—Ç–∞
    const NURLAT_LAT = 54.43;
    const NURLAT_LON = 50.80;

    // --- –ë–õ–û–ö –ú–ê–¢–ï–ú–ê–¢–ò–ö–ò (–ò–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ + —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã) ---

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∞—Ç
    function getJulianDate(date) { return (date.getTime() / 86400000) + 2440587.5; }
    function getGMST(jd) {
        const T = (jd - 2451545.0) / 36525.0;
        let st = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * T * T - T * T * T / 38710000.0;
        return ((st % 360) + 360) % 360 * (Math.PI / 180);
    }

    // –§–æ—Ä–º—É–ª–∞ –°–æ–ª–Ω—Ü–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è NOAA)
    function getSunAltitude(lat, lon, date) {
        const DEG = Math.PI / 180;
        const jd = getJulianDate(date);
        const n = jd - 2451545.0;
        const L = (280.466 + 0.9856474 * n) % 360;
        const g = (357.528 + 0.9856003 * n) % 360 * DEG;
        const lambda = (L + 1.915 * Math.sin(g) + 0.020 * Math.sin(2 * g)) * DEG;
        const epsilon = 23.439 * DEG;
        const dec = Math.asin(Math.sin(epsilon) * Math.sin(lambda));
        
        const gmst = getGMST(jd);
        const ha = gmst + (lon * DEG) - Math.atan2(Math.cos(epsilon) * Math.sin(lambda), Math.cos(lambda));
        
        const latRad = lat * DEG;
        const sinAlt = Math.sin(dec) * Math.sin(latRad) + Math.cos(dec) * Math.cos(latRad) * Math.cos(ha);
        return Math.asin(sinAlt) * (180 / Math.PI);
    }

    // –§–æ—Ä–º—É–ª–∞ –õ—É–Ω—ã (–∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
    function getMoonAltitude(lat, lon, date) {
        const DEG = Math.PI / 180;
        const jd = getJulianDate(date);
        const T = (jd - 2451545.0) / 36525.0;
        
        const L0 = (218.3164477 + 481267.88123421 * T) % 360;
        const M = (134.9633964 + 477198.8675055 * T) % 360 * DEG;
        const F = (93.2720950 + 483202.0175233 * T) % 360 * DEG;
        const D = (297.8501921 + 445267.1114034 * T) % 360 * DEG;
        
        let lambda = L0 + 6.289 * Math.sin(M);
        lambda += 1.274 * Math.sin(2 * D - M);
        lambda += 0.658 * Math.sin(2 * D);
        lambda += 0.214 * Math.sin(2 * M);
        lambda *= DEG;

        let beta = (5.128 * Math.sin(F) + 0.281 * Math.sin(M + F)) * DEG;
        const epsilon = 23.439 * DEG;

        const sinDec = Math.sin(beta) * Math.cos(epsilon) + Math.cos(beta) * Math.sin(epsilon) * Math.sin(lambda);
        const dec = Math.asin(sinDec);
        
        const y = Math.sin(lambda) * Math.cos(epsilon) - Math.tan(beta) * Math.sin(epsilon);
        const x = Math.cos(lambda);
        let ra = Math.atan2(y, x);
        
        const gmst = getGMST(jd);
        const lst = gmst + lon * DEG;
        const ha = lst - ra;
        const latRad = lat * DEG;
        
        const sinAlt = Math.sin(dec) * Math.sin(latRad) + Math.cos(dec) * Math.cos(latRad) * Math.cos(ha);
        return Math.asin(sinAlt) * (180 / Math.PI);
    }

    // –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π (–∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä –º–∏–Ω—É—Ç)
    // –ú—ã –ø—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –º–∏–Ω—É—Ç–∞–º –¥–Ω—è –∏ —Å–º–æ—Ç—Ä–∏–º, –∫–æ–≥–¥–∞ –≤—ã—Å–æ—Ç–∞ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç (-0.833 –¥–ª—è —Å–æ–ª–Ω—Ü–∞, 0.125 –¥–ª—è –ª—É–Ω—ã)
    function findEventsMath() {
        const date = new Date();
        date.setHours(0,0,0,0);
        
        let sunRise = null, sunSet = null;
        let moonRise = null, moonSet = null;

        // –ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ä–∞–¥–∏—É—Å –¥–∏—Å–∫–∞ –∏ —Ä–µ—Ñ—Ä–∞–∫—Ü–∏—é –¥–ª—è –°–æ–ª–Ω—Ü–∞ (-0.833 –≥—Ä–∞–¥—É—Å–∞)
        const sunHorizon = -0.833; 
        const moonHorizon = 0.125; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ–ø—Ä–∞–≤–∫–∞ –¥–ª—è –õ—É–Ω—ã

        let prevSunAlt = getSunAltitude(NURLAT_LAT, NURLAT_LON, date);
        let prevMoonAlt = getMoonAltitude(NURLAT_LAT, NURLAT_LON, date);

        // –ü–µ—Ä–µ–±–æ—Ä 1440 –º–∏–Ω—É—Ç –≤ —Å—É—Ç–∫–∞—Ö
        for (let i = 1; i < 1440; i++) {
            const now = new Date(date.getTime() + i * 60000);
            const sAlt = getSunAltitude(NURLAT_LAT, NURLAT_LON, now);
            const mAlt = getMoonAltitude(NURLAT_LAT, NURLAT_LON, now);

            // –ü–æ–∏—Å–∫ –≤–æ—Å—Ö–æ–¥–∞ —Å–æ–ª–Ω—Ü–∞ (–ø–µ—Ä–µ—Ö–æ–¥ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö —á–µ—Ä–µ–∑ –≥–æ—Ä–∏–∑–æ–Ω—Ç)
            if (prevSunAlt < sunHorizon && sAlt >= sunHorizon) sunRise = now;
            // –ü–æ–∏—Å–∫ –∑–∞–∫–∞—Ç–∞ —Å–æ–ª–Ω—Ü–∞
            if (prevSunAlt > sunHorizon && sAlt <= sunHorizon) sunSet = now;

            // –ü–æ–∏—Å–∫ –≤–æ—Å—Ö–æ–¥–∞ –ª—É–Ω—ã
            if (prevMoonAlt < moonHorizon && mAlt >= moonHorizon) moonRise = now;
            // –ü–æ–∏—Å–∫ –∑–∞—Ö–æ–¥–∞ –ª—É–Ω—ã
            if (prevMoonAlt > moonHorizon && mAlt <= moonHorizon) moonSet = now;

            prevSunAlt = sAlt;
            prevMoonAlt = mAlt;
        }

        return { sunRise, sunSet, moonRise, moonSet };
    }

    function formatTime(date) {
        if (!date) return "--:--";
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    // --- –õ–û–ì–ò–ö–ê –ó–ê–ü–£–°–ö–ê ---

    async function runComparison() {
        document.getElementById('math-results').innerHTML = '<div class="value">–°—á–∏—Ç–∞–µ–º...</div>';
        document.getElementById('api-results').innerHTML = '<div class="value">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        // 1. –í—ã–ø–æ–ª–Ω—è–µ–º JS —Ä–∞—Å—á–µ—Ç
        // –î–µ–ª–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã UI –æ–±–Ω–æ–≤–∏–ª—Å—è
        setTimeout(() => {
            const mathData = findEventsMath();
            renderResults('math-results', mathData);
        }, 100);

        // 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º API
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è –ù—É—Ä–ª–∞—Ç–∞, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∞–≤—Ç–æ (–∏–ª–∏ –ú–æ—Å–∫–≤–∞)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${NURLAT_LAT}&longitude=${NURLAT_LON}&daily=sunrise,sunset,moonrise,moonset&timezone=Europe%2FMoscow&forecast_days=1`;
            
            const resp = await fetch(url);
            const data = await resp.json();
            const daily = data.daily;

            const apiData = {
                sunRise: daily.sunrise[0] ? new Date(daily.sunrise[0]) : null,
                sunSet: daily.sunset[0] ? new Date(daily.sunset[0]) : null,
                moonRise: daily.moonrise[0] ? new Date(daily.moonrise[0]) : null,
                moonSet: daily.moonset[0] ? new Date(daily.moonset[0]) : null
            };
            
            renderResults('api-results', apiData);

        } catch (e) {
            document.getElementById('api-results').innerHTML = `<div class="value" style="color:red">–û—à–∏–±–∫–∞ API: ${e.message}</div>`;
        }
    }

    function renderResults(elementId, data) {
        const html = `
            <div class="result-row">
                <span class="label">‚òÄÔ∏è –í–æ—Å—Ö–æ–¥:</span>
                <span class="value sun-val">${formatTime(data.sunRise)}</span>
            </div>
            <div class="result-row">
                <span class="label">‚òÄÔ∏è –ó–∞–∫–∞—Ç:</span>
                <span class="value sun-val">${formatTime(data.sunSet)}</span>
            </div>
            <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin: 10px 0;"></div>
            <div class="result-row">
                <span class="label">üåô –í–æ—Å—Ö–æ–¥:</span>
                <span class="value moon-val">${formatTime(data.moonRise)}</span>
            </div>
            <div class="result-row">
                <span class="label">üåô –ó–∞—Ö–æ–¥:</span>
                <span class="value moon-val">${formatTime(data.moonSet)}</span>
            </div>
        `;
        document.getElementById(elementId).innerHTML = html;
    }

</script>

</body>
</html>
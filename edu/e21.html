<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0" />
  <title>Звезды - Сравнение</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Jura:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #020205;
      --panel-bg: rgba(10, 10, 20, 0.8);
      --panel-border: rgba(255, 255, 255, 0.12);
      --text-main: #ffffff;
      --text-sec: #94a3b8;
      --accent: #4da6ff;
      --accent-glow: rgba(77, 166, 255, 0.4);
      --btn-bg: rgba(255, 255, 255, 0.08);
      --btn-hover: rgba(255, 255, 255, 0.2);
      --font-display: 'Jura', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: var(--bg-color);
      font-family: var(--font-body);
      color: var(--text-main);
    }

    canvas { display: block; outline: none; z-index: 1; }

    #ui-layer {
      position: absolute; inset: 0; z-index: 10; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 24px;
    }

    .top-bar {
      pointer-events: auto;
      display: flex; justify-content: space-between; align-items: flex-start;
    }

    .app-title h1 {
      font-family: var(--font-display); font-weight: 700; font-size: 28px;
      letter-spacing: 2px; text-transform: uppercase;
      background: linear-gradient(135deg, #fff, #4da6ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .app-title span { font-size: 11px; color: var(--accent); letter-spacing: 4px; text-transform: uppercase; font-weight: 700; }

    .controls-right { display: flex; gap: 12px; align-items: center; }

    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--panel-bg); border: 1px solid var(--panel-border);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-main);
      transition: all 0.3s;
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--btn-hover); color: var(--accent); }
    .icon-btn svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }

    /* Температурная шкала */
    .temp-guide {
      pointer-events: auto;
      position: absolute; left: 24px; top: 50%; transform: translateY(-50%);
      background: var(--panel-bg); border: 1px solid var(--panel-border);
      padding: 16px; border-radius: 20px; backdrop-filter: blur(10px);
      display: flex; flex-direction: column; gap: 10px;
    }
    .temp-item { display: flex; align-items: center; gap: 8px; font-size: 10px; font-family: var(--font-display); }
    .t-color { width: 12px; height: 12px; border-radius: 50%; }

    /* Нижняя панель */
    .dock-wrapper {
      pointer-events: auto;
      align-self: center; width: 100%; max-width: 1000px;
      display: flex; justify-content: center;
    }

    .dock {
      background: var(--panel-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--panel-border);
      padding: 12px 20px; border-radius: 28px;
      display: flex; gap: 16px; align-items: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      width: 100%;
    }

    .star-scroll {
      display: flex; gap: 8px; overflow-x: auto; padding: 4px;
      flex: 1;
      scrollbar-width: none; /* Firefox */
    }
    .star-scroll::-webkit-scrollbar { display: none; }

    .chip {
      padding: 10px 18px; border-radius: 14px;
      background: var(--btn-bg); color: var(--text-sec);
      font-family: var(--font-display); font-size: 12px; font-weight: 600;
      cursor: pointer; white-space: nowrap; border: 1px solid transparent;
      transition: all 0.2s;
    }
    .chip:hover { background: var(--btn-hover); color: #fff; }
    .chip.active {
      background: rgba(77, 166, 255, 0.2); color: var(--accent);
      border-color: rgba(77, 166, 255, 0.4);
    }

    .reset-btn {
      width: 48px; height: 48px; flex-shrink: 0;
      border-radius: 16px; background: var(--btn-bg);
      border: 1px solid var(--panel-border); color: var(--text-sec);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.3s;
    }
    .reset-btn:hover { background: #4da6ff; color: #fff; transform: rotate(90deg); }

    /* Modal */
    .modal {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,0.75); backdrop-filter: blur(10px);
      opacity: 0; visibility: hidden; transition: 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal.visible { opacity: 1; visibility: visible; }
    .card {
      width: 90%; max-width: 650px; background: #0a0a0f;
      border: 1px solid var(--panel-border); border-radius: 32px; padding: 40px;
    }
    .card h2 { font-family: var(--font-display); font-size: 38px; margin-bottom: 10px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
    .stat h4 { font-size: 10px; color: var(--text-sec); text-transform: uppercase; }
    .stat p { font-size: 16px; font-weight: 600; font-family: var(--font-display); }
    .close-modal { position: absolute; top: 30px; right: 30px; cursor: pointer; font-size: 30px; color: var(--text-sec); background: none; border: none; }

    @media (max-width: 768px) {
      .temp-guide { display: none; }
      .stats { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <div id="ui-layer">
    <div class="top-bar">
      <div class="app-title">
        <h1>Звезды</h1>
        <span>Великие светила</span>
      </div>
      <div class="controls-right">
        <button class="icon-btn" onclick="toggleAutoRotate()" title="Вращение">
          <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
        </button>
      </div>
    </div>

    <div class="temp-guide">
      <div class="temp-item"><div class="t-color" style="background: #99bbff"></div> 30,000K+</div>
      <div class="temp-item"><div class="t-color" style="background: #ffffff"></div> 10,000K</div>
      <div class="temp-item"><div class="t-color" style="background: #fff5e0"></div> 6,000K</div>
      <div class="temp-item"><div class="t-color" style="background: #ffb347"></div> 4,000K</div>
      <div class="temp-item"><div class="t-color" style="background: #ff6b4a"></div> 3,000K</div>
    </div>

    <div class="dock-wrapper">
      <div class="dock">
        <button class="reset-btn" onclick="clearAll()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
        </button>
        <div class="star-scroll" id="starBtns"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <button class="close-modal" onclick="closeModal()">×</button>
      <h2 id="mTitle">Звезда</h2>
      <p id="mType" style="color: var(--accent); font-weight: 700; margin-bottom: 20px;"></p>
      <div class="stats" id="mStats"></div>
      <p id="mFact" style="color: var(--text-sec); line-height: 1.6; border-top: 1px solid #222; padding-top: 20px;"></p>
    </div>
  </div>

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { STARS_DATA } from './stars.js';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.8; // Увеличена яркость
    document.body.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    composer.addPass(bloomPass);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxDistance = 30000;

    // Фон Млечный Путь
    const loader = new THREE.TextureLoader();
    const bgGeo = new THREE.SphereGeometry(50000, 64, 64);
    const bgMat = new THREE.MeshBasicMaterial({
      map: loader.load('textures/milkyway.jpg'),
      side: THREE.BackSide,
      transparent: true,
      opacity: 0.7
    });
    scene.add(new THREE.Mesh(bgGeo, bgMat));

    const ambLight = new THREE.AmbientLight(0xffffff, 0.1);
    scene.add(ambLight);

    // Звездная группа
    const starsGroup = new THREE.Group();
    scene.add(starsGroup);

    let activeStars = [];
    let addedKeys = new Set();
    let autoRotate = true;

    // Шейдер поверхности звезды (реалистичные пятна и протуберанцы)
    const starShader = {
      uniforms: {
        time: { value: 0 },
        color: { value: new THREE.Color(0xffffff) }
      },
      vertexShader: `
        varying vec2 vUv;
        varying vec3 vNormal;
        void main() {
          vUv = uv;
          vNormal = normalize(normalMatrix * normal);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        uniform float time;
        uniform vec3 color;
        varying vec2 vUv;
        varying vec3 vNormal;
        
        float noise(vec3 p) {
          return fract(sin(dot(p, vec3(12.9898, 78.233, 45.123))) * 43758.5453);
        }

        void main() {
          float n = noise(vec3(vUv * 10.0, time * 0.1));
          float pulse = 0.8 + 0.2 * sin(time * 2.0 + vUv.y * 10.0);
          vec3 finalColor = color * (0.9 + 0.3 * n) * pulse;
          gl_FragColor = vec4(finalColor * 1.5, 1.0);
        }
      `
    };

    function createStarObject(key) {
      const data = STARS_DATA[key];
      // МАСШТАБИРОВАНИЕ: Используем логарифмическо-степенной масштаб, 
      // чтобы Солнце не исчезало, а Бетельгейзе (887x) была реально огромной.
      const visualRadius = Math.pow(data.radius, 0.6) * 5; 
      
      const group = new THREE.Group();
      
      // Сама звезда
      const mat = new THREE.ShaderMaterial({
        uniforms: THREE.UniformsUtils.clone(starShader.uniforms),
        vertexShader: starShader.vertexShader,
        fragmentShader: starShader.fragmentShader
      });
      mat.uniforms.color.value.set(data.color);
      
      const mesh = new THREE.Mesh(new THREE.SphereGeometry(visualRadius, 64, 64), mat);
      group.add(mesh);

      // Корона (уменьшена и сделана аккуратнее)
      const coronaGeo = new THREE.SpriteMaterial({
        map: loader.load('https://threejs.org/examples/textures/lensflare/lensflare0.png'),
        color: data.coronaColor,
        transparent: true,
        blending: THREE.AdditiveBlending,
        opacity: 0.6
      });
      const corona = new THREE.Sprite(coronaGeo);
      corona.scale.set(visualRadius * 3.5, visualRadius * 3.5, 1);
      group.add(corona);

      // Свет от звезды
      const light = new THREE.PointLight(data.color, 2, visualRadius * 50);
      group.add(light);

      group.userData = { name: key, radius: visualRadius, data: data };
      return group;
    }

    function updateLayout() {
      if (activeStars.length === 0) return;

      // Сортировка по порядку из данных
      activeStars.sort((a, b) => a.userData.data.order - b.userData.data.order);

      let currentX = 0;
      const gap = 40;

      activeStars.forEach((star, i) => {
        if (i > 0) {
          const prev = activeStars[i-1];
          currentX += prev.userData.radius + star.userData.radius + gap;
        }
        star.userData.targetX = currentX;
      });

      const totalWidth = currentX;
      activeStars.forEach(star => {
        star.userData.targetX -= totalWidth / 2;
      });

      // Камера подстраивается под размер системы
      const camZ = Math.max(totalWidth * 0.8, 150);
      const camY = totalWidth * 0.2;
      window.targetCamPos = new THREE.Vector3(0, camY, camZ);
    }

    window.addStar = (key) => {
      if (addedKeys.has(key)) return;
      const star = createStarObject(key);
      star.position.set(star.userData.targetX || 0, -1000, 0);
      starsGroup.add(star);
      activeStars.push(star);
      addedKeys.add(key);
      updateLayout();
      updateUI();
    };

    window.removeStar = (key) => {
      const star = activeStars.find(s => s.userData.name === key);
      if (star) {
        starsGroup.remove(star);
        activeStars = activeStars.filter(s => s !== star);
        addedKeys.delete(key);
        updateLayout();
        updateUI();
      }
    };

    window.clearAll = () => {
      activeStars.forEach(s => starsGroup.remove(s));
      activeStars = [];
      addedKeys.clear();
      updateUI();
    };

    window.toggleAutoRotate = () => autoRotate = !autoRotate;

    // Наполнение кнопок
    const btnContainer = document.getElementById('starBtns');
    Object.keys(STARS_DATA).sort((a,b) => STARS_DATA[a].order - STARS_DATA[b].order).forEach(key => {
      const btn = document.createElement('div');
      btn.className = 'chip';
      btn.textContent = key;
      btn.dataset.key = key;
      btn.onclick = () => addedKeys.has(key) ? window.removeStar(key) : window.addStar(key);
      btnContainer.appendChild(btn);
    });

    // Прокрутка колесиком
    btnContainer.addEventListener('wheel', (e) => {
      e.preventDefault();
      btnContainer.scrollLeft += e.deltaY;
    });

    function updateUI() {
      document.querySelectorAll('.chip').forEach(btn => {
        btn.classList.toggle('active', addedKeys.has(btn.dataset.key));
      });
    }

    function animate(time) {
      requestAnimationFrame(animate);
      const t = time * 0.001;

      activeStars.forEach(star => {
        // Плавное движение к позиции
        star.position.x += (star.userData.targetX - star.position.x) * 0.05;
        star.position.y += (0 - star.position.y) * 0.05;
        
        // Вращение поверхности
        star.children[0].material.uniforms.time.value = t;
        star.children[0].rotation.y += 0.002;
      });

      if (autoRotate && !window.isInteracting) {
        starsGroup.rotation.y += 0.001;
      }

      if (window.targetCamPos) {
        camera.position.lerp(window.targetCamPos, 0.05);
        controls.target.lerp(new THREE.Vector3(0,0,0), 0.05);
      }

      controls.update();
      composer.render();
    }

    // Инициализация
    window.addStar('Солнце');
    window.addStar('Сириус A');
    animate(0);

    // Modal logic
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    window.addEventListener('dblclick', (e) => {
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(starsGroup.children, true);
      if (intersects.length > 0) {
        let obj = intersects[0].object;
        while(obj.parent && !obj.userData.name) obj = obj.parent;
        const d = obj.userData.data;
        showModal(obj.userData.name, d);
      }
    });

    function showModal(name, d) {
      document.getElementById('mTitle').textContent = name;
      document.getElementById('mType').textContent = d.type;
      document.getElementById('mFact').textContent = d.facts[Math.floor(Math.random()*d.facts.length)];
      document.getElementById('mStats').innerHTML = `
        <div class="stat"><h4>Радиус</h4><p>${d.info.diamSun} R☉</p></div>
        <div class="stat"><h4>Масса</h4><p>${d.info.massSun} M☉</p></div>
        <div class="stat"><h4>Светимость</h4><p>${d.info.lumSun} L☉</p></div>
        <div class="stat"><h4>Температура</h4><p>${d.temperature} K</p></div>
        <div class="stat"><h4>Дистанция</h4><p>${d.distance} св. лет</p></div>
        <div class="stat"><h4>Созвездие</h4><p>${d.constellation}</p></div>
      `;
      document.getElementById('modal').classList.add('visible');
    }

    window.closeModal = () => document.getElementById('modal').classList.remove('visible');
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    renderer.domElement.addEventListener('mousedown', () => window.isInteracting = true);
    renderer.domElement.addEventListener('mouseup', () => window.isInteracting = false);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Security Auditor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', monospace; 
            padding: 20px; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee; 
            min-height: 100vh;
            margin: 0;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { 
            color: #00d9ff; 
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0,217,255,0.3);
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        
        .config-panel {
            background: linear-gradient(145deg, #252542, #1e1e36);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #3a3a5c;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .config-panel h2 {
            margin-top: 0;
            color: #ffa500;
            font-size: 18px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 12px 15px;
            background: #111;
            border: 1px solid #444;
            border-radius: 8px;
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0,217,255,0.2);
        }
        .input-group input::placeholder { color: #555; }
        
        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0067c0);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,217,255,0.4);
        }
        .btn-primary:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; }
        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #c0392b);
            color: white;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: linear-gradient(145deg, #252542, #1e1e36);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #3a3a5c;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .card h3 {
            margin: 0 0 15px 0;
            color: #ffa500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card h3 .icon { font-size: 20px; }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status-waiting { background: #333; color: #888; }
        .status-loading { background: #1e3a5f; color: #5dade2; }
        .status-ok { background: #1e5631; color: #58d68d; }
        .status-warn { background: #5d4e0f; color: #f4d03f; }
        .status-danger { background: #641e16; color: #f1948a; }
        .status-info { background: #1a3a4a; color: #85c1e9; }
        
        pre {
            background: #0a0a15;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333;
            color: #7bed9f;
            font-size: 12px;
            max-height: 200px;
            margin: 0;
        }
        
        .summary-panel {
            background: linear-gradient(145deg, #1a2a1a, #162016);
            border: 2px solid #2d5a2d;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
        }
        .summary-panel.visible { display: block; }
        .summary-panel h2 {
            margin: 0 0 15px 0;
            color: #58d68d;
        }
        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-label { color: #888; font-size: 14px; }
        .stat-ok { color: #58d68d; }
        .stat-warn { color: #f4d03f; }
        .stat-danger { color: #f1948a; }
        
        .progress-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #58d68d);
            width: 0%;
            transition: width 0.3s;
        }
        
        .tables-input {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .tables-input label { color: #aaa; font-size: 13px; }
        .tables-input input { margin-top: 5px; }
        .hint { font-size: 12px; color: #666; margin-top: 5px; }
        
        .check-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        .check-list li {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .check-list li:last-child { border-bottom: none; }
        .check-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge-ok { background: #1e5631; color: #58d68d; }
        .badge-warn { background: #5d4e0f; color: #f4d03f; }
        .badge-danger { background: #641e16; color: #f1948a; }
        .badge-skip { background: #333; color: #888; }

        @media (max-width: 600px) {
            .results-grid { grid-template-columns: 1fr; }
            .btn-row { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîí Supabase Security Auditor</h1>
    <p class="subtitle">–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ Supabase –ø—Ä–æ–µ–∫—Ç–∞</p>

    <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
    <div class="config-panel">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <div class="input-group">
            <label>Supabase URL</label>
            <input type="text" id="supabase-url" placeholder="https://your-project.supabase.co">
        </div>
        <div class="input-group">
            <label>Anon Key (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á)</label>
            <input type="text" id="anon-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>
        
        <div class="tables-input">
            <div class="input-group">
                <label>–¢–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="tables-list" placeholder="users, posts, files, orders, profiles, messages">
                <div class="hint">–£–∫–∞–∂–∏—Ç–µ –∏–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.</div>
            </div>
            <div class="input-group">
                <label>Storage –±–∞–∫–µ—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="buckets-list" placeholder="avatars, uploads, user_files, documents">
                <div class="hint">–£–∫–∞–∂–∏—Ç–µ –∏–º–µ–Ω–∞ storage –±–∞–∫–µ—Ç–æ–≤. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –±–∞–∫–µ—Ç–æ–≤.</div>
            </div>
        </div>
        
        <div class="btn-row" style="margin-top: 20px;">
            <button class="btn-primary" id="run-btn" onclick="runFullAudit()">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç
            </button>
            <button class="btn-secondary" onclick="runQuickCheck()">
                ‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            </button>
            <button class="btn-secondary" onclick="clearResults()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <button class="btn-secondary" onclick="exportResults()">
                üìÑ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞
            </button>
        </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="progress-bar">
        <div class="fill" id="progress-fill"></div>
    </div>

    <!-- –°–≤–æ–¥–∫–∞ -->
    <div class="summary-panel" id="summary-panel">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞</h2>
        <div class="summary-stats">
            <div class="stat-item">
                <div class="stat-value stat-ok" id="stat-passed">0</div>
                <div class="stat-label">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value stat-warn" id="stat-warnings">0</div>
                <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</div>
            </div>
            <div class="stat-item">
                <div class="stat-value stat-danger" id="stat-critical">0</div>
                <div class="stat-label">–ö—Ä–∏—Ç–∏—á–Ω–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color:#888" id="stat-total">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫</div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="results-grid" id="results-grid">
        
        <!-- RLS Check -->
        <div class="card">
            <h3><span class="icon">üóÑÔ∏è</span> Database RLS (Row Level Security)</h3>
            <div class="status status-waiting" id="rls-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="rls-list"></ul>
            <pre id="rls-result" style="display:none;"></pre>
        </div>

        <!-- Storage Check -->
        <div class="card">
            <h3><span class="icon">üìÅ</span> Storage Policies</h3>
            <div class="status status-waiting" id="storage-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="storage-list"></ul>
            <pre id="storage-result" style="display:none;"></pre>
        </div>

        <!-- Auth Check -->
        <div class="card">
            <h3><span class="icon">üîë</span> Auth Configuration</h3>
            <div class="status status-waiting" id="auth-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="auth-list"></ul>
            <pre id="auth-result" style="display:none;"></pre>
        </div>

        <!-- API Exposure -->
        <div class="card">
            <h3><span class="icon">üåê</span> API Exposure</h3>
            <div class="status status-waiting" id="api-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="api-list"></ul>
            <pre id="api-result" style="display:none;"></pre>
        </div>

        <!-- Data Leak Check -->
        <div class="card">
            <h3><span class="icon">üîç</span> Sensitive Data Exposure</h3>
            <div class="status status-waiting" id="data-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="data-list"></ul>
            <pre id="data-result" style="display:none;"></pre>
        </div>

        <!-- Functions Check -->
        <div class="card">
            <h3><span class="icon">‚ö°</span> Edge Functions / RPC</h3>
            <div class="status status-waiting" id="rpc-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="rpc-list"></ul>
            <pre id="rpc-result" style="display:none;"></pre>
        </div>

        <!-- Realtime Check -->
        <div class="card">
            <h3><span class="icon">üì°</span> Realtime Subscriptions</h3>
            <div class="status status-waiting" id="realtime-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="realtime-list"></ul>
            <pre id="realtime-result" style="display:none;"></pre>
        </div>

        <!-- JWT Analysis -->
        <div class="card">
            <h3><span class="icon">üé´</span> JWT Token Analysis</h3>
            <div class="status status-waiting" id="jwt-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
            <ul class="check-list" id="jwt-list"></ul>
            <pre id="jwt-result" style="display:none;"></pre>
        </div>

    </div>
</div>

<script>
    let supabaseClient = null;
    let auditResults = {
        passed: 0,
        warnings: 0,
        critical: 0,
        details: []
    };

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –±–∞–∫–µ—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const DEFAULT_TABLES = ['users', 'profiles', 'posts', 'files', 'documents', 'orders', 'products', 'messages', 'comments', 'settings', 'accounts', 'sessions', 'logs', 'events', 'notifications'];
    const DEFAULT_BUCKETS = ['avatars', 'uploads', 'user_files', 'documents', 'images', 'files', 'public', 'private', 'media'];
    
    // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞
    const SENSITIVE_FIELDS = ['password', 'hash', 'secret', 'token', 'api_key', 'apikey', 'private_key', 'credit_card', 'ssn', 'social_security', 'bank', 'cvv', 'pin'];

    function getConfig() {
        const url = document.getElementById('supabase-url').value.trim();
        const key = document.getElementById('anon-key').value.trim();
        
        const tablesInput = document.getElementById('tables-list').value.trim();
        const bucketsInput = document.getElementById('buckets-list').value.trim();
        
        const tables = tablesInput ? tablesInput.split(',').map(t => t.trim()).filter(t => t) : DEFAULT_TABLES;
        const buckets = bucketsInput ? bucketsInput.split(',').map(b => b.trim()).filter(b => b) : DEFAULT_BUCKETS;
        
        return { url, key, tables, buckets };
    }

    function validateConfig(config) {
        if (!config.url) {
            alert('‚ùå –í–≤–µ–¥–∏—Ç–µ Supabase URL');
            return false;
        }
        if (!config.key) {
            alert('‚ùå –í–≤–µ–¥–∏—Ç–µ Anon Key');
            return false;
        }
        if (!config.url.includes('supabase.co') && !config.url.includes('supabase.in')) {
            if (!confirm('URL –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Supabase URL. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return false;
            }
        }
        return true;
    }

    function initClient(config) {
        try {
            supabaseClient = window.supabase.createClient(config.url, config.key);
            return true;
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: ' + e.message);
            return false;
        }
    }

    function resetResults() {
        auditResults = { passed: 0, warnings: 0, critical: 0, details: [] };
        document.querySelectorAll('.status').forEach(el => {
            el.className = 'status status-waiting';
            el.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
        });
        document.querySelectorAll('.check-list').forEach(el => el.innerHTML = '');
        document.querySelectorAll('pre').forEach(el => {
            el.style.display = 'none';
            el.textContent = '';
        });
        updateSummary();
    }

    function updateProgress(percent) {
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    function updateSummary() {
        document.getElementById('stat-passed').textContent = auditResults.passed;
        document.getElementById('stat-warnings').textContent = auditResults.warnings;
        document.getElementById('stat-critical').textContent = auditResults.critical;
        document.getElementById('stat-total').textContent = auditResults.passed + auditResults.warnings + auditResults.critical;
        document.getElementById('summary-panel').classList.add('visible');
    }

    function addCheckResult(listId, name, status, details = '') {
        const list = document.getElementById(listId);
        const li = document.createElement('li');
        
        let badgeClass = 'badge-skip';
        let badgeText = 'SKIP';
        
        if (status === 'ok') {
            badgeClass = 'badge-ok';
            badgeText = 'OK';
            auditResults.passed++;
        } else if (status === 'warn') {
            badgeClass = 'badge-warn';
            badgeText = 'WARN';
            auditResults.warnings++;
        } else if (status === 'danger') {
            badgeClass = 'badge-danger';
            badgeText = 'FAIL';
            auditResults.critical++;
        }
        
        li.innerHTML = `
            <span>${name} ${details ? `<small style="color:#666">(${details})</small>` : ''}</span>
            <span class="check-badge ${badgeClass}">${badgeText}</span>
        `;
        list.appendChild(li);
        
        auditResults.details.push({ check: name, status, details });
        updateSummary();
    }

    function setStatus(id, type, text) {
        const el = document.getElementById(id);
        el.className = `status status-${type}`;
        el.textContent = text;
    }

    function showResult(id, data) {
        const el = document.getElementById(id);
        el.style.display = 'block';
        el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    // ========== –ü–†–û–í–ï–†–ö–ò ==========

    async function checkRLS(tables) {
        setStatus('rls-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫...');
        const results = [];
        
        for (const table of tables) {
            try {
                // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                const { data, error, count } = await supabaseClient
                    .from(table)
                    .select('*', { count: 'exact' })
                    .limit(10);
                
                if (error) {
                    if (error.code === '42P01') {
                        // –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        addCheckResult('rls-list', table, 'skip', '—Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    } else if (error.message.includes('permission denied') || error.code === '42501') {
                        addCheckResult('rls-list', table, 'ok', '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
                    } else {
                        addCheckResult('rls-list', table, 'ok', error.message);
                    }
                } else {
                    if (data && data.length > 0) {
                        addCheckResult('rls-list', table, 'danger', `–¥–æ—Å—Ç—É–ø–Ω–æ ${count || data.length} –∑–∞–ø–∏—Å–µ–π!`);
                        results.push({ table, data: data.slice(0, 3) });
                    } else {
                        addCheckResult('rls-list', table, 'warn', '–ø—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ RLS');
                    }
                }
            } catch (e) {
                addCheckResult('rls-list', table, 'ok', '–æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
        
        if (results.length > 0) {
            setStatus('rls-status', 'danger', `‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ù–∞–π–¥–µ–Ω—ã –Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã!`);
            showResult('rls-result', results);
        } else {
            setStatus('rls-status', 'ok', '‚úÖ RLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
        }
    }

    async function checkStorage(buckets) {
        setStatus('storage-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ Storage –ø–æ–ª–∏—Ç–∏–∫...');
        const results = [];
        
        for (const bucket of buckets) {
            try {
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                const { data, error } = await supabaseClient.storage
                    .from(bucket)
                    .list('', { limit: 10 });
                
                if (error) {
                    if (error.message.includes('not found') || error.message.includes('does not exist')) {
                        addCheckResult('storage-list', bucket, 'skip', '–±–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    } else {
                        addCheckResult('storage-list', bucket, 'ok', '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
                    }
                } else {
                    if (data && data.length > 0) {
                        addCheckResult('storage-list', bucket, 'warn', `–≤–∏–¥–Ω–æ ${data.length} –æ–±—ä–µ–∫—Ç–æ–≤`);
                        results.push({ bucket, files: data });
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª—ã
                        for (const file of data.slice(0, 2)) {
                            if (file.name && !file.id) {
                                const { data: dlData, error: dlError } = await supabaseClient.storage
                                    .from(bucket)
                                    .download(file.name);
                                
                                if (!dlError && dlData) {
                                    addCheckResult('storage-list', `${bucket}/${file.name}`, 'danger', '—Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!');
                                }
                            }
                        }
                    } else {
                        addCheckResult('storage-list', bucket, 'ok', '–ø—É—Å—Ç–æ–π –∏–ª–∏ –∑–∞—â–∏—â—ë–Ω');
                    }
                }
            } catch (e) {
                addCheckResult('storage-list', bucket, 'ok', '–æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞');
            }
        }
        
        if (results.length > 0) {
            setStatus('storage-status', 'warn', `‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–∫–µ—Ç—ã`);
            showResult('storage-result', results);
        } else {
            setStatus('storage-status', 'ok', '‚úÖ Storage –∑–∞—â–∏—â—ë–Ω');
        }
    }

    async function checkAuth() {
        setStatus('auth-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ Auth –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (session) {
            addCheckResult('auth-list', '–ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è', 'warn', '–µ—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        } else {
            addCheckResult('auth-list', '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø', 'ok', '–Ω–µ—Ç —Å–µ—Å—Å–∏–∏');
        }
        
        // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º –ø–∞—Ä–æ–ª–µ–º
        const testEmail = `test_${Date.now()}@security-audit.local`;
        const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
            email: testEmail,
            password: '123'  // –°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å
        });
        
        if (!signUpError) {
            addCheckResult('auth-list', '–°–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏', 'warn', '—Ä–∞–∑—Ä–µ—à—ë–Ω –ø–∞—Ä–æ–ª—å "123"');
        } else if (signUpError.message.includes('password')) {
            addCheckResult('auth-list', '–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π', 'ok', '—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        } else {
            addCheckResult('auth-list', '–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π', 'ok', signUpError.message);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Auth
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        
        if (user) {
            addCheckResult('auth-list', 'User Info Exposure', 'warn', '–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã');
            showResult('auth-result', user);
        } else {
            addCheckResult('auth-list', 'User Info Protection', 'ok', '–¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã');
        }
        
        setStatus('auth-status', 'ok', '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Auth –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    }

    async function checkAPIExposure(config) {
        setStatus('api-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints...');
        
        const endpoints = [
            { path: '/rest/v1/', name: 'REST API' },
            { path: '/auth/v1/settings', name: 'Auth Settings' },
            { path: '/storage/v1/bucket', name: 'Storage API' },
        ];
        
        for (const ep of endpoints) {
            try {
                const response = await fetch(config.url + ep.path, {
                    headers: {
                        'apikey': config.key,
                        'Authorization': `Bearer ${config.key}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        addCheckResult('api-list', ep.name, 'warn', '–¥–æ—Å—Ç—É–ø–µ–Ω –ø—É–±–ª–∏—á–Ω–æ');
                    } else if (typeof data === 'object' && Object.keys(data).length > 0) {
                        addCheckResult('api-list', ep.name, 'warn', '–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ');
                    } else {
                        addCheckResult('api-list', ep.name, 'ok', '–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
                    }
                } else {
                    addCheckResult('api-list', ep.name, 'ok', `HTTP ${response.status}`);
                }
            } catch (e) {
                addCheckResult('api-list', ep.name, 'ok', '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ OpenAPI/Swagger
        try {
            const swaggerResp = await fetch(config.url + '/rest/v1/', {
                headers: { 'apikey': config.key },
                method: 'OPTIONS'
            });
            if (swaggerResp.ok) {
                addCheckResult('api-list', 'Schema Exposure', 'warn', '—Å—Ö–µ–º–∞ API –¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        } catch (e) {}
        
        setStatus('api-status', 'ok', '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    }

    async function checkSensitiveData(tables) {
        setStatus('data-status', 'loading', '–ü–æ–∏—Å–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
        let foundSensitive = false;
        
        for (const table of tables) {
            try {
                const { data, error } = await supabaseClient
                    .from(table)
                    .select('*')
                    .limit(1);
                
                if (!error && data && data.length > 0) {
                    const row = data[0];
                    const columns = Object.keys(row);
                    
                    for (const col of columns) {
                        const colLower = col.toLowerCase();
                        for (const sensitive of SENSITIVE_FIELDS) {
                            if (colLower.includes(sensitive)) {
                                addCheckResult('data-list', `${table}.${col}`, 'danger', '—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–æ—Å—Ç—É–ø–Ω–æ!');
                                foundSensitive = true;
                            }
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ email'—ã –≤ –¥–∞–Ω–Ω—ã—Ö
                    const jsonStr = JSON.stringify(row);
                    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
                    const emails = jsonStr.match(emailRegex);
                    if (emails && emails.length > 0) {
                        addCheckResult('data-list', `${table}`, 'warn', `–Ω–∞–π–¥–µ–Ω—ã email –∞–¥—Ä–µ—Å–∞`);
                    }
                }
            } catch (e) {}
        }
        
        if (!foundSensitive) {
            addCheckResult('data-list', 'Sensitive Fields', 'ok', '—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
        
        setStatus('data-status', foundSensitive ? 'danger' : 'ok', 
            foundSensitive ? '‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!' : '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    }

    async function checkRPCFunctions() {
        setStatus('rpc-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ RPC —Ñ—É–Ω–∫—Ü–∏–π...');
        
        // –°–ø–∏—Å–æ–∫ —Ç–∏–ø–∏—á–Ω—ã—Ö RPC —Ñ—É–Ω–∫—Ü–∏–π
        const commonFunctions = [
            'get_user_data',
            'get_all_users',
            'delete_user',
            'admin_action',
            'execute_sql',
            'run_query',
            'get_settings',
            'update_settings',
            'get_stats'
        ];
        
        let foundExposed = false;
        
        for (const func of commonFunctions) {
            try {
                const { data, error } = await supabaseClient.rpc(func);
                
                if (!error) {
                    addCheckResult('rpc-list', func, 'danger', '—Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!');
                    foundExposed = true;
                } else if (error.code === 'PGRST202') {
                    // –§—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - OK
                } else if (error.message.includes('permission denied')) {
                    addCheckResult('rpc-list', func, 'ok', '—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (e) {}
        }
        
        if (!foundExposed) {
            addCheckResult('rpc-list', 'RPC Functions', 'ok', '–Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
        
        setStatus('rpc-status', foundExposed ? 'danger' : 'ok',
            foundExposed ? '‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ RPC!' : '‚úÖ RPC –∑–∞—â–∏—â–µ–Ω—ã');
    }

    async function checkRealtime(tables) {
        setStatus('realtime-status', 'loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ Realtime –ø–æ–¥–ø–∏—Å–æ–∫...');
        
        let realtimeExposed = false;
        const results = [];
        
        for (const table of tables.slice(0, 5)) {  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —Ç–∞–±–ª–∏—Ü
            try {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => resolve('timeout'), 3000);
                    
                    const channel = supabaseClient
                        .channel(`test_${table}`)
                        .on(
                            'postgres_changes',
                            { event: '*', schema: 'public', table: table },
                            (payload) => {
                                realtimeExposed = true;
                                results.push({ table, payload });
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                addCheckResult('realtime-list', table, 'warn', '–ø–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞');
                                clearTimeout(timeout);
                                supabaseClient.removeChannel(channel);
                                resolve('subscribed');
                            } else if (status === 'CHANNEL_ERROR') {
                                addCheckResult('realtime-list', table, 'ok', '–ø–æ–¥–ø–∏—Å–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞');
                                clearTimeout(timeout);
                                resolve('error');
                            }
                        });
                });
            } catch (e) {
                addCheckResult('realtime-list', table, 'ok', '–æ—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏');
            }
        }
        
        if (results.length > 0) {
            showResult('realtime-result', results);
        }
        
        setStatus('realtime-status', realtimeExposed ? 'warn' : 'ok',
            realtimeExposed ? '‚ö†Ô∏è Realtime –ø–æ–¥–ø–∏—Å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã' : '‚úÖ Realtime –∑–∞—â–∏—â—ë–Ω');
    }

    function analyzeJWT(config) {
        setStatus('jwt-status', 'loading', '–ê–Ω–∞–ª–∏–∑ JWT —Ç–æ–∫–µ–Ω–∞...');
        
        try {
            const parts = config.key.split('.');
            if (parts.length !== 3) {
                addCheckResult('jwt-list', 'JWT Format', 'warn', '–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
                return;
            }
            
            const payload = JSON.parse(atob(parts[1]));
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
            if (payload.role === 'anon') {
                addCheckResult('jwt-list', 'Role', 'ok', 'anonymous role');
            } else if (payload.role === 'service_role') {
                addCheckResult('jwt-list', 'Role', 'danger', 'SERVICE ROLE KEY! –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ!');
            } else {
                addCheckResult('jwt-list', 'Role', 'warn', payload.role);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
            if (payload.exp) {
                const expDate = new Date(payload.exp * 1000);
                const now = new Date();
                const daysUntilExp = Math.floor((expDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExp < 0) {
                    addCheckResult('jwt-list', 'Expiration', 'danger', '—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫!');
                } else if (daysUntilExp < 30) {
                    addCheckResult('jwt-list', 'Expiration', 'warn', `–∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${daysUntilExp} –¥–Ω–µ–π`);
                } else {
                    addCheckResult('jwt-list', 'Expiration', 'ok', expDate.toLocaleDateString());
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ issuer
            if (payload.iss) {
                addCheckResult('jwt-list', 'Issuer', 'ok', payload.iss);
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ ref
            if (payload.ref) {
                addCheckResult('jwt-list', 'Project Ref', 'info', payload.ref);
            }
            
            showResult('jwt-result', payload);
            setStatus('jwt-status', 'ok', '‚úÖ JWT –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            
        } catch (e) {
            addCheckResult('jwt-list', 'JWT Parse', 'warn', '–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω');
            setStatus('jwt-status', 'warn', '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ JWT');
        }
    }

    // ========== –ì–õ–ê–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

    async function runFullAudit() {
        const config = getConfig();
        if (!validateConfig(config)) return;
        if (!initClient(config)) return;
        
        document.getElementById('run-btn').disabled = true;
        resetResults();
        
        const steps = [
            { name: 'JWT', fn: () => analyzeJWT(config), progress: 10 },
            { name: 'RLS', fn: () => checkRLS(config.tables), progress: 30 },
            { name: 'Storage', fn: () => checkStorage(config.buckets), progress: 45 },
            { name: 'Auth', fn: () => checkAuth(), progress: 55 },
            { name: 'API', fn: () => checkAPIExposure(config), progress: 70 },
            { name: 'Data', fn: () => checkSensitiveData(config.tables), progress: 80 },
            { name: 'RPC', fn: () => checkRPCFunctions(), progress: 90 },
            { name: 'Realtime', fn: () => checkRealtime(config.tables), progress: 100 }
        ];
        
        for (const step of steps) {
            await step.fn();
            updateProgress(step.progress);
        }
        
        document.getElementById('run-btn').disabled = false;
    }

    async function runQuickCheck() {
        const config = getConfig();
        if (!validateConfig(config)) return;
        if (!initClient(config)) return;
        
        resetResults();
        
        analyzeJWT(config);
        updateProgress(25);
        
        await checkRLS(config.tables.slice(0, 5));
        updateProgress(50);
        
        await checkStorage(config.buckets.slice(0, 3));
        updateProgress(75);
        
        await checkAuth();
        updateProgress(100);
    }

    function clearResults() {
        resetResults();
        updateProgress(0);
        document.getElementById('summary-panel').classList.remove('visible');
    }

    function exportResults() {
        if (auditResults.details.length === 0) {
            alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞—É–¥–∏—Ç');
            return;
        }
        
        const config = getConfig();
        const report = {
            timestamp: new Date().toISOString(),
            project_url: config.url,
            summary: {
                passed: auditResults.passed,
                warnings: auditResults.warnings,
                critical: auditResults.critical,
                total: auditResults.passed + auditResults.warnings + auditResults.critical
            },
            checks: auditResults.details
        };
        
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `supabase-audit-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ localStorage
    window.addEventListener('load', () => {
        const savedUrl = localStorage.getItem('supabase_audit_url');
        const savedTables = localStorage.getItem('supabase_audit_tables');
        const savedBuckets = localStorage.getItem('supabase_audit_buckets');
        
        if (savedUrl) document.getElementById('supabase-url').value = savedUrl;
        if (savedTables) document.getElementById('tables-list').value = savedTables;
        if (savedBuckets) document.getElementById('buckets-list').value = savedBuckets;
    });

    document.getElementById('supabase-url').addEventListener('change', (e) => {
        localStorage.setItem('supabase_audit_url', e.target.value);
    });
    document.getElementById('tables-list').addEventListener('change', (e) => {
        localStorage.setItem('supabase_audit_tables', e.target.value);
    });
    document.getElementById('buckets-list').addEventListener('change', (e) => {
        localStorage.setItem('supabase_audit_buckets', e.target.value);
    });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Сравнение Планет</title>
  <style>
    :root {
      --panel-bg: rgba(15, 20, 30, 0.95);
      --panel-border: #445;
      --cyan: #00bcd4;
      --gold: #ffcc00;
      --danger: #ff4444;
    }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      font-family: "Segoe UI", system-ui, sans-serif;
    }

    canvas { display: block; }

    #ui {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-bg);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      color: white;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 90vw;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      z-index: 10;
    }

    .title {
      text-align: center;
      font-size: 14px;
      color: #aaa;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    button {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
      text-transform: capitalize;
    }

    button:hover { background: var(--cyan); border-color: var(--cyan); color: #000; }
    button:active { transform: scale(0.95); }

    .remove-btn {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--danger);
      border-color: var(--danger);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    /* Подсказка при наведении на планету (реализуем через raycaster позже или просто UI) */
    #info {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      pointer-events: none;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <div id="info">ЛКМ - Вращать | Колесо - Зум | ПКМ - Сдвиг</div>

  <div id="ui">
    <div class="title">Добавить объект</div>
    <div class="button-group" id="planetButtons">
      <!-- Кнопки генерируются JS -->
    </div>
    
    <div style="border-top: 1px solid #334; margin: 5px 0;"></div>
    
    <div class="button-group">
      <button onclick="clearAll()" style="color: #ff8888; border-color: #522;">Очистить все</button>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    // --- КОНФИГУРАЦИЯ ---
    // Радиусы в км

    const PLANETS = {
      Mercury: { 
        radius: 2439, 
        tex: 'textures/mercury2.jpg', 
        bump: 'textures/mercury2.jpg' 
      },
      Venus: { 
        radius: 6051, 
        // Карта поверхности (не облака!)
        tex:  'textures/venus.jpg',
        bump: 'textures/venus.jpg'
      },
      Earth: { 
        radius: 6371, 
        tex: 'textures/earth-blue-marble.jpg',
        spec: 'textures/earth2.jpg'
      },
      Moon: { 
        radius: 1737, 
        tex:  'textures/moon.png',
        bump: 'textures/moon.png'
      },
      Mars: { 
        radius: 3389, 
        tex: 'textures/mars.jpg',
        bump:  'textures/mars2.jpg'
      },
      Jupiter: { 
        radius: 69911, 
        tex: 'textures/jupiter.jpg' 
      },
      Saturn: { 
        radius: 58232, 
        tex: 'textures/saturn.jpg',
        ring: {
          tex:  'textures/saturn2.jpg',
          inner: 74500,
          outer: 140220
        }
      },
      Uranus: { 
        radius: 25362, 
        tex: 'textures/uranus.jpg'
      },
      Neptune: { 
        radius: 24622, 
        tex: 'textures/neptune.jpg' 
      }
      
      Pluto: { 
        radius: 1188, 
        tex: 'textures/pluto.jpg',
        bump: 'textures/pluto.jpg' 
      }
    };

    // Масштаб: 1 единица Three.js = 1000 км
    const SCALE = 1 / 1000; 
    
    // Сцена
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);
    camera.position.set(0, 0, 50);

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = true;

    // Освещение: Равномерное со всех сторон
    const ambientLight = new THREE.AmbientLight(0xffffff, 3.0);
    scene.add(ambientLight);

    // Звезды (из вашего кода)
    function createStars(count = 5000) {
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array(count * 3);
      for (let i = 0; i < count; i++) {
        const r = 2000 + Math.random() * 2000; 
        const theta = 2 * Math.PI * Math.random();
        const phi = Math.acos(2 * Math.random() - 1);
        pos[i * 3] = r * Math.sin(phi) * Math.cos(theta);
        pos[i * 3 + 1] = r * Math.cos(phi);
        pos[i * 3 + 2] = r * Math.sin(phi) * Math.sin(theta);
      }
      geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
      const mat = new THREE.PointsMaterial({ color: 0x888888, size: 2, sizeAttenuation: false });
      return new THREE.Points(geo, mat);
    }
    scene.add(createStars());

    // Менеджер текстур
    const texLoader = new THREE.TextureLoader();
    const textureCache = {};

    function getTexture(url) {
      if (!textureCache[url]) {
        textureCache[url] = texLoader.load(url);
        textureCache[url].colorSpace = THREE.SRGBColorSpace;
      }
      return textureCache[url];
    }

    // Хранилище активных планет
    let activePlanets = []; 
    const planetsGroup = new THREE.Group();
    scene.add(planetsGroup);

    // --- ЛОГИКА СОЗДАНИЯ ---

    function createPlanet(key) {
      const data = PLANETS[key];
      const radius = data.radius * SCALE;
      
      const geometry = new THREE.SphereGeometry(radius, 64, 64);
      const material = new THREE.MeshPhongMaterial({
        map: getTexture(data.tex),
        shininess: 5
      });

      if (data.bump) {
        material.bumpMap = getTexture(data.bump);
        material.bumpScale = 0.5 * SCALE; // Небольшой рельеф
      }
      if (data.spec) {
        material.specularMap = getTexture(data.spec);
        material.specular = new THREE.Color(0x333333);
      }

      const mesh = new THREE.Mesh(geometry, material);
      const container = new THREE.Group(); // Контейнер для планеты и колец
      container.add(mesh);
      
      // Добавляем кольца если есть
      if (data.ring) {
        const inner = data.ring.inner * SCALE;
        const outer = data.ring.outer * SCALE;
        const ringGeo = new THREE.RingGeometry(inner, outer, 64);
        const ringPos = ringGeo.attributes.position;
        const ringUV = ringGeo.attributes.uv;
        
        // Коррекция UV для колец
        for (let i = 0; i < ringUV.count; i++) {
          const x = ringPos.getX(i);
          const y = ringPos.getY(i);
          const len = Math.sqrt(x*x + y*y);
          // Мапим текстуру от внутреннего радиуса к внешнему
          const u = (len - inner) / (outer - inner);
          ringUV.setXY(i, u, 0.5); 
        }

        const ringMat = new THREE.MeshBasicMaterial({
          map: getTexture(data.ring.tex),
          side: THREE.DoubleSide,
          transparent: true,
          opacity: 0.8
        });
        
        const ringMesh = new THREE.Mesh(ringGeo, ringMat);
        ringMesh.rotation.x = -Math.PI / 2;
        container.add(ringMesh);
      }

      // Добавляем объект данных для расчетов
      container.userData = { 
        name: key, 
        radius: radius,
        realRadius: data.radius 
      };

      // Raycaster hitbox (чуть больше планеты для удобства удаления)
      const hitBox = new THREE.Mesh(
        new THREE.SphereGeometry(radius * 1.05, 16, 16),
        new THREE.MeshBasicMaterial({ visible: false })
      );
      hitBox.userData = { isHitbox: true, parent: container };
      container.add(hitBox);

      return container;
    }

    // --- УПРАВЛЕНИЕ ПОЗИЦИЯМИ ---

    function recalculatePositions() {
      let currentX = 0;
      const padding = 2; // Отступ между планетами (2000 км)

      // 1. Вычисляем позиции
      activePlanets.forEach((obj, index) => {
        const r = obj.userData.radius;
        // Если это первая планета, ставим её центр на r
        // Если нет, добавляем радиус предыдущей + отступ + радиус текущей
        if (index === 0) {
          currentX = 0;
        } else {
          const prevR = activePlanets[index - 1].userData.radius;
          // У Сатурна кольца широкие, нужно больше места.
          // Простая эвристика: если радиус большой (> 20), даем больше места
          const extraSpace = (r > 20 || prevR > 20) ? 10 : 0;
          currentX += prevR + r + padding + extraSpace;
        }
        obj.position.setX(currentX);
      });

      // 2. Центрируем всю группу
      const totalWidth = currentX;
      const offset = totalWidth / 2;
      activePlanets.forEach(obj => {
        obj.position.x -= offset;
      });

      // 3. Адаптируем камеру
      fitCamera();
    }

    function fitCamera() {
      if (activePlanets.length === 0) return;

      const box = new THREE.Box3();
      activePlanets.forEach(obj => box.expandByObject(obj));

      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      // Определяем максимальный размер сцены
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      
      // Вычисляем дистанцию, чтобы объект влез
      let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
      cameraZ *= 1.3; // Запас 30%

      // Ограничения чтобы не улетать в бесконечность или внутрь
      cameraZ = Math.max(cameraZ, 10);
      
      // Плавная анимация камеры (через target в animate loop)
      targetCameraZ = cameraZ;
      controls.target.copy(center);
    }

    let targetCameraZ = 50;

    // --- UI ИНТЕРАКТИВ ---

    window.addPlanet = (key) => {
      const planet = createPlanet(key);
      planetsGroup.add(planet);
      activePlanets.push(planet);
      recalculatePositions();
    };

    window.clearAll = () => {
      activePlanets.forEach(p => planetsGroup.remove(p));
      activePlanets = [];
      recalculatePositions();
    };

    // Генерация кнопок
    const btnContainer = document.getElementById("planetButtons");
    Object.keys(PLANETS).forEach(key => {
      const btn = document.createElement("button");
      btn.textContent = key === "Moon" ? "Луна" : key;
      btn.onclick = () => window.addPlanet(key);
      btnContainer.appendChild(btn);
    });

    // Удаление по клику (Raycaster)
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    window.addEventListener('dblclick', (event) => {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(planetsGroup.children, true);

      if (intersects.length > 0) {
        // Ищем корневой объект
        let target = intersects[0].object;
        while(target.parent && target.parent !== planetsGroup) {
          target = target.parent;
        }
        
        // Удаляем
        const index = activePlanets.indexOf(target);
        if (index > -1) {
          activePlanets.splice(index, 1);
          planetsGroup.remove(target);
          recalculatePositions();
        }
      }
    });

    // Добавим Землю и Луну для старта
    window.addPlanet('Earth');
    window.addPlanet('Moon');

    // --- ANIMATION LOOP ---

    function animate() {
      requestAnimationFrame(animate);

      // Плавный зум камеры
      if (Math.abs(camera.position.z - targetCameraZ) > 0.1) {
        camera.position.z += (targetCameraZ - camera.position.z) * 0.05;
      }

      // Вращение планет для красоты
      activePlanets.forEach(obj => {
        // Вращаем саму меш внутри группы, чтобы наклон колец не ломался, 
        // но здесь у нас группа. Просто вращаем по Y.
        obj.children[0].rotation.y += 0.002;
      });

      controls.update();
      renderer.render(scene, camera);
    }

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();

  </script>
</body>
</html>
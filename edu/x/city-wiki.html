<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Ä–æ–¥–∞</title>
    <!-- –ò–∫–æ–Ω–∫–∏ (FontAwesome) –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        #map { width: 100%; height: 100%; }

        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (Overlay) --- */
        .modal-overlay {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
            backdrop-filter: blur(5px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Ä–æ–¥–∞ --- */
        .city-card {
            background: #fff;
            width: 90%;
            max-width: 450px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-overlay.active .city-card {
            transform: translateY(0);
        }

        /* --- –®–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ --- */
        .card-header {
            height: 200px;
            background-color: #eee;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç */
        .card-header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        
        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 32px; height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #333;
            z-index: 10;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .close-btn:hover { background: #fff; }

        .city-title-block {
            position: absolute;
            bottom: 15px; left: 20px;
            z-index: 5;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .city-name { font-size: 28px; font-weight: 700; margin: 0; }
        .city-coords { font-size: 13px; opacity: 0.9; font-weight: 300; }

        /* --- –ö–æ–Ω—Ç–µ–Ω—Ç (–°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è —á–∞—Å—Ç—å) --- */
        .card-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* --- –¢–∞–±–ª–∏—Ü–∞ --- */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .info-table tr { border-bottom: 1px solid #f0f0f0; }
        .info-table tr:last-child { border-bottom: none; }
        .info-table td { padding: 12px 5px; font-size: 15px; vertical-align: middle; }
        
        .td-icon { width: 30px; color: #555; text-align: center; font-size: 16px; }
        .td-label { color: #666; font-weight: 500; }
        .td-value { text-align: right; color: #333; font-weight: 600; }
        
        .flag-img { height: 24px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* --- –ë–ª–æ–∫ –ø–æ–≥–æ–¥—ã --- */
        .weather-badge {
            background: linear-gradient(135deg, #e0f7fa, #bbdefb);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #0277bd;
        }
        .weather-left { display: flex; align-items: center; gap: 10px; }
        .weather-icon { font-size: 32px; }
        .weather-temp { font-size: 24px; font-weight: bold; }
        .weather-desc { font-size: 14px; opacity: 0.8; }

        /* --- –ö–Ω–æ–ø–∫–∞ –í–∏–∫–∏ --- */
        .wiki-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #000;
            color: #fff;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .wiki-btn:hover { background-color: #333; }
        
        /* --- –õ–æ–∞–¥–µ—Ä --- */
        .loader-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 200px; color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { color: #e74c3c; text-align: center; padding: 20px; }
    </style>

    <!-- –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–º–µ–Ω–∏—Ç–µ –∫–ª—é—á –Ω–∏–∂–µ –Ω–∞ –í–ê–®, –µ—Å–ª–∏ —ç—Ç–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>

<!-- –ö–∞—Ä—Ç–∞ -->
<div id="map"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal-overlay" id="cityModal">
    <div class="city-card">
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å -->
        <button class="close-btn" onclick="closeModal()">&times;</button>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        <div id="modalContent">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ -->
        </div>
    </div>
</div>

<script>
    const WIKI_API = "https://ru.wikipedia.org/w/api.php";
    const WIKIDATA_API = "https://www.wikidata.org/w/api.php";
    const WEATHER_API = "https://api.open-meteo.com/v1/forecast";

    // –ö–æ–¥—ã –ø–æ–≥–æ–¥—ã WMO
    const weatherCodes = {
        0: ['‚òÄÔ∏è', '–Ø—Å–Ω–æ'], 1: ['üå§Ô∏è', '–ü—Ä–µ–∏–º. —è—Å–Ω–æ'], 2: ['‚õÖ', '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è'], 3: ['‚òÅÔ∏è', '–ü–∞—Å–º—É—Ä–Ω–æ'],
        45: ['üå´Ô∏è', '–¢—É–º–∞–Ω'], 48: ['üå´Ô∏è', '–ò–∑–º–æ—Ä–æ–∑—å'],
        51: ['üåßÔ∏è', '–ú–æ—Ä–æ—Å—å'], 53: ['üåßÔ∏è', '–ú–æ—Ä–æ—Å—å'], 55: ['üåßÔ∏è', '–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å'],
        61: ['üåßÔ∏è', '–î–æ–∂–¥—å'], 63: ['üåßÔ∏è', '–î–æ–∂–¥—å'], 65: ['üåßÔ∏è', '–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å'],
        71: ['‚ùÑÔ∏è', '–°–Ω–µ–≥'], 73: ['‚ùÑÔ∏è', '–°–Ω–µ–≥'], 75: ['‚ùÑÔ∏è', '–ú–µ—Ç–µ–ª—å'],
        80: ['üå¶Ô∏è', '–õ–∏–≤–µ–Ω—å'], 95: ['‚õàÔ∏è', '–ì—Ä–æ–∑–∞']
    };

    ymaps.ready(init);

    function init() {
        const map = new ymaps.Map("map", {
            center: [55.751574, 37.573856],
            zoom: 5,
            controls: ['zoomControl', 'searchControl']
        });

        map.behaviors.disable('dblClickZoom');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        map.events.add('dblclick', async function (e) {
            const coords = e.get('coords');
            
            // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –ª–æ–∞–¥–µ—Ä–æ–º
            openModal();
            showLoader();

            try {
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const data = await gatherCityInfo(coords);
                // 3. –†–∏—Å—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                renderModalContent(data);
            } catch (error) {
                console.error(error);
                let msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.";
                if (error.message.includes('scriptError')) msg += "<br>–ü—Ä–æ–±–ª–µ–º–∞ —Å API-–∫–ª—é—á–æ–º –Ø–Ω–¥–µ–∫—Å.";
                else msg += "<br>–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –Ω–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç.";
                
                showError(msg);
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        document.getElementById('cityModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    }

    // --- –õ–û–ì–ò–ö–ê –°–ë–û–†–ê –î–ê–ù–ù–´–• ---

    async function gatherCityInfo(coords) {
        const [lat, lon] = coords;
        
        // 1. –ì–µ–æ–∫–æ–¥–µ—Ä (–∏–º—è –≥–æ—Ä–æ–¥–∞)
        const geocodeRes = await ymaps.geocode(coords, { kind: 'locality', results: 1 });
        const firstGeoObject = geocodeRes.geoObjects.get(0);
        
        if (!firstGeoObject) throw new Error("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        
        const cityName = firstGeoObject.getLocalities().length > 0 
            ? firstGeoObject.getLocalities()[0] 
            : firstGeoObject.getName();

        // 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–í–∏–∫–∏ + –ü–æ–≥–æ–¥–∞)
        const [wikiData, weatherData] = await Promise.all([
            fetchWikiData(cityName),
            fetchWeather(lat, lon)
        ]);

        return {
            name: cityName,
            lat: lat.toFixed(4),
            lon: lon.toFixed(4),
            ...wikiData,
            ...weatherData
        };
    }

    async function fetchWikiData(query) {
        const result = { 
            population: null, area: null, wikiUrl: '#', 
            founded: null, height: null, flag: null, photo: null, website: null
        };

        try {
            // –ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const searchUrl = `${WIKI_API}?origin=*&action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json`;
            const searchRes = await fetch(searchUrl).then(r => r.json());
            if (!searchRes.query.search.length) return result;
            
            const title = searchRes.query.search[0].title;
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ ID
            const infoUrl = `${WIKI_API}?origin=*&action=query&prop=info|pageprops&inprop=url&ppprop=wikibase_item&titles=${encodeURIComponent(title)}&format=json`;
            const infoRes = await fetch(infoUrl).then(r => r.json());
            const pageId = Object.keys(infoRes.query.pages)[0];
            const pageData = infoRes.query.pages[pageId];

            result.wikiUrl = pageData.fullurl;
            
            if (pageData.pageprops && pageData.pageprops.wikibase_item) {
                const qId = pageData.pageprops.wikibase_item;
                const wdUrl = `${WIKIDATA_API}?origin=*&action=wbgetentities&ids=${qId}&props=claims&format=json`;
                const wdRes = await fetch(wdUrl).then(r => r.json());
                const claims = wdRes.entities[qId].claims;

                // --- –ü–∞—Ä—Å–∏–Ω–≥ –í–∏–∫–∏–¥–∞–Ω–Ω—ã—Ö ---

                // P1082: –ù–∞—Å–µ–ª–µ–Ω–∏–µ (—É–º–Ω—ã–π –ø–æ–∏—Å–∫ –º–∞–∫—Å. –∑–Ω–∞—á–µ–Ω–∏—è)
                if (claims.P1082) {
                    let bestPop = 0;
                    for (const c of claims.P1082) {
                        try {
                            const val = parseInt(c.mainsnak.datavalue.value.amount.replace('+',''));
                            let year = 0;
                            if (c.qualifiers && c.qualifiers.P585) {
                                year = parseInt(c.qualifiers.P585[0].datavalue.value.time.replace('+','').split('-')[0]);
                            }
                            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: preferred –∏–ª–∏ –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–π –≥–æ–¥
                            if (c.rank === 'preferred' && val > 0) bestPop = val; 
                            else if (year > 2020 && val > bestPop) bestPop = val; // –µ—Å–ª–∏ —Å–≤–µ–∂–µ–µ 2020
                            else if (bestPop === 0 && val > 0) bestPop = val; // —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ
                            
                            // –ü—Ä–æ—Å—Ç–æ–π —Ö–∞–∫: –±–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ, —Ç.–∫. –Ω–∞—Å–µ–ª–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ —Ä–∞—Å—Ç–µ—Ç
                            if (val > bestPop) bestPop = val;
                        } catch(e){}
                    }
                    if (bestPop > 0) result.population = bestPop.toLocaleString('ru-RU');
                }

                // P2046: –ü–ª–æ—â–∞–¥—å
                if (claims.P2046) {
                    const val = parseFloat(claims.P2046[0].mainsnak.datavalue.value.amount.replace('+',''));
                    result.area = val.toFixed(1) + ' –∫–º¬≤';
                }

                // P571: –î–∞—Ç–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è
                if (claims.P571) {
                    const rawDate = claims.P571[0].mainsnak.datavalue.value.time;
                    result.founded = rawDate.replace('+','').split('-')[0] + ' –≥.';
                }

                // P2044: –í—ã—Å–æ—Ç–∞
                if (claims.P2044) {
                    const val = claims.P2044[0].mainsnak.datavalue.value.amount.replace('+','');
                    result.height = parseInt(val) + ' –º';
                }

                // P856: –°–∞–π—Ç
                if (claims.P856) {
                    result.website = claims.P856[0].mainsnak.datavalue.value;
                }

                // P41: –§–ª–∞–≥ (–∫–∞—Ä—Ç–∏–Ω–∫–∞)
                if (claims.P41) {
                    const imgName = claims.P41[0].mainsnak.datavalue.value;
                    result.flag = `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(imgName)}?width=100`;
                }

                // P18: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ)
                if (claims.P18) {
                    const imgName = claims.P18[0].mainsnak.datavalue.value;
                    // width=600 –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
                    result.photo = `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(imgName)}?width=600`;
                }
            }
        } catch (e) { console.warn(e); }
        return result;
    }

    async function fetchWeather(lat, lon) {
        try {
            const url = `${WEATHER_API}?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m`;
            const res = await fetch(url).then(r => r.json());
            const cur = res.current;
            if (!cur) throw new Error();

            const code = cur.weather_code;
            const info = weatherCodes[code] || ['üå°Ô∏è', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];

            return {
                temp: Math.round(cur.temperature_2m),
                humidity: cur.relative_humidity_2m,
                wind: cur.wind_speed_10m,
                weatherIcon: info[0],
                weatherText: info[1]
            };
        } catch (e) {
            return { temp: null };
        }
    }

    // --- UI –§–£–ù–ö–¶–ò–ò ---

    function openModal() {
        const modal = document.getElementById('cityModal');
        modal.classList.add('active');
    }

    function closeModal() {
        const modal = document.getElementById('cityModal');
        modal.classList.remove('active');
    }

    function showLoader() {
        document.getElementById('modalContent').innerHTML = `
            <div class="loader-container">
                <div class="spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        `;
    }

    function showError(msg) {
        document.getElementById('modalContent').innerHTML = `<div class="error-msg">${msg}</div>`;
    }

    function renderModalContent(data) {
        const container = document.getElementById('modalContent');
        
        // –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∏–ª–∏ —Å–µ—Ä—ã–π —Ñ–æ–Ω)
        const bgStyle = data.photo ? `background-image: url('${data.photo}');` : '';
        
        // –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (—Å–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
        let rows = '';
        
        if (data.flag) {
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-flag"></i></td>
                <td class="td-label">–§–ª–∞–≥</td>
                <td class="td-value"><img src="${data.flag}" class="flag-img" alt="–§–ª–∞–≥"></td>
            </tr>`;
        }
        if (data.population) {
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-users"></i></td>
                <td class="td-label">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</td>
                <td class="td-value">${data.population} —á–µ–ª.</td>
            </tr>`;
        }
        if (data.area) {
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-ruler-combined"></i></td>
                <td class="td-label">–ü–ª–æ—â–∞–¥—å</td>
                <td class="td-value">${data.area}</td>
            </tr>`;
        }
        if (data.founded) {
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-calendar-day"></i></td>
                <td class="td-label">–û—Å–Ω–æ–≤–∞–Ω</td>
                <td class="td-value">${data.founded}</td>
            </tr>`;
        }
        if (data.height) {
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-mountain"></i></td>
                <td class="td-label">–í—ã—Å–æ—Ç–∞</td>
                <td class="td-value">${data.height}</td>
            </tr>`;
        }
        if (data.website) {
            // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π URL –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            const shortLink = data.website.replace(/^https?:\/\/(www\.)?/, '').split('/')[0];
            rows += `<tr>
                <td class="td-icon"><i class="fa-solid fa-globe"></i></td>
                <td class="td-label">–°–∞–π—Ç</td>
                <td class="td-value"><a href="${data.website}" target="_blank" style="color:#007bff;text-decoration:none;">${shortLink}</a></td>
            </tr>`;
        }

        // –ë–ª–æ–∫ –ø–æ–≥–æ–¥—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
        let weatherBlock = '';
        if (data.temp !== null) {
            weatherBlock = `
                <div class="weather-badge">
                    <div class="weather-left">
                        <div class="weather-icon">${data.weatherIcon}</div>
                        <div>
                            <div class="weather-temp">${data.temp > 0 ? '+' : ''}${data.temp}¬∞C</div>
                            <div class="weather-desc">${data.weatherText}</div>
                        </div>
                    </div>
                    <div style="text-align:right; font-size:12px;">
                        <div>üíß ${data.humidity}%</div>
                        <div>üí® ${data.wind} –º/—Å</div>
                    </div>
                </div>
            `;
        }

        // –°–æ–±–∏—Ä–∞–µ–º HTML
        const html = `
            <div class="card-header" style="${bgStyle}">
                <div class="city-title-block">
                    <h1 class="city-name">${data.name}</h1>
                    <div class="city-coords">${data.lat}, ${data.lon}</div>
                </div>
            </div>
            
            <div class="card-body">
                ${weatherBlock}
                
                <table class="info-table">
                    ${rows}
                </table>
                
                <a href="${data.wikiUrl}" target="_blank" class="wiki-btn">
                    <i class="fa-brands fa-wikipedia-w"></i> –ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é
                </a>
            </div>
        `;

        container.innerHTML = html;
    }
</script>

</body>
</html>
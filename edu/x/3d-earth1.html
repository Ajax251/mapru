<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Земля и МКС</title>
<link rel="icon" href="worldwide.png"="image/png">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        
        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc; letter-spacing: 2px; font-size: 18px; pointer-events: none;
            text-transform: uppercase;
        }

        #ui {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(15, 20, 30, 0.9);
            padding: 20px; border-radius: 12px; border: 1px solid #445;
            color: white; width: 260px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        
        /* Стили переключателей */
        .switch { position: relative; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00bcd4; } /* Цвет Cyan */
        input:checked + .slider:before { transform: translateX(20px); }

        #data { 
            font-family: 'Consolas', monospace; 
            font-size: 12px; 
            color: #00bcd4; 
            margin-top: 5px; 
            padding-top: 10px;
            border-top: 1px solid #334;
            line-height: 1.6; 
            min-height: 60px; 
        }
    </style>
</head>
<body>

    <div id="loading">ПОДКЛЮЧЕНИЕ К СПУТНИКАМ...</div>

    <div id="ui">
        <div class="row">
            <span>День/Ночь</span>
            <label class="switch"><input type="checkbox" id="chk-sun" checked><span class="slider"></span></label>
        </div>
        <div class="row">
            <span>МКС</span>
            <label class="switch"><input type="checkbox" id="chk-iss" checked><span class="slider"></span></label>
        </div>
        <div id="data">Ожидание данных...</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- ИНИЦИАЛИЗАЦИЯ ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205); 

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, 0, 28);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // --- ОСВЕЩЕНИЕ ---
        const ambientLight = new THREE.AmbientLight(0x404060, 0.1); 
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- ВИЗУАЛЬНОЕ СОЛНЦЕ (Спрайт) ---
        function createSunSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)'); 
            gradient.addColorStop(0.2, 'rgba(255, 255, 220, 1)');
            gradient.addColorStop(0.5, 'rgba(255, 200, 100, 0.8)');
            gradient.addColorStop(1, 'rgba(255, 100, 0, 0)'); 
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture, 
                blending: THREE.AdditiveBlending,
                color: 0xffaa33,
                depthWrite: false // Чтобы не перекрывало звезды неправильно
            });
            const sprite = new THREE.Sprite(material);
            
            // УМЕНЬШИЛИ РАЗМЕР СОЛНЦА (Было 80)
            sprite.scale.set(12, 12, 1); 
            
            return sprite;
        }
        const sunSprite = createSunSprite();
        scene.add(sunSprite);


        // --- КОНТРОЛЛЫ ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 12;
        controls.maxDistance = 200;
        
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const texLoader = new THREE.TextureLoader();
        
        // --- ЗЕМЛЯ ---
        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 0.1,
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            specular: new THREE.Color(0x222222),
            shininess: 10
        });
        const earth = new THREE.Mesh(new THREE.SphereGeometry(10, 64, 64), earthMat);
        earthGroup.add(earth);

        // --- ОБЛАКА ---
        const cloudMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-clouds.png'),
            transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, side: THREE.DoubleSide,
            depthWrite: false
        });
        const clouds = new THREE.Mesh(new THREE.SphereGeometry(10.15, 64, 64), cloudMat);
        earthGroup.add(clouds);

        // --- АТМОСФЕРА ---
        const atmoMat = new THREE.ShaderMaterial({
            vertexShader: `varying vec3 vN; void main(){vN=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
            fragmentShader: `varying vec3 vN; void main(){float i=pow(0.5-dot(vN,vec3(0,0,1)),3.0);gl_FragColor=vec4(0.3,0.6,1.0,1.0)*i*1.3;}`,
            blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent: true
        });
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(10.3, 64, 64), atmoMat));

        // --- ЗВЕЗДЫ ---
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(5000 * 3);
        for(let i=0; i<5000*3; i++) starPos[i] = (Math.random()-0.5)*800;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.4, transparent:true, opacity:0.7}));
        scene.add(stars);

        // --- СИСТЕМА МКС ---
        const issContainer = new THREE.Group();
        earthGroup.add(issContainer);

        const issModel = new THREE.Group();
        
        // Модель МКС (Белая)
        const mainModule = new THREE.Mesh(
            new THREE.CylinderGeometry(0.08, 0.08, 0.8, 16), 
            new THREE.MeshPhongMaterial({color: 0xffffff, shininess: 100})
        );
        mainModule.rotation.z = Math.PI/2;
        issModel.add(mainModule);

        const crossModule = new THREE.Mesh(
            new THREE.CylinderGeometry(0.06, 0.06, 0.5, 16),
            new THREE.MeshPhongMaterial({color: 0xeeeeee})
        );
        issModel.add(crossModule);

        const panelGeo = new THREE.BoxGeometry(1.5, 0.02, 0.3);
        const panelMat = new THREE.MeshPhongMaterial({
            color: 0x111111, 
            emissive: 0x000033, 
            emissiveIntensity: 0.5,
            specular: 0xffffff,
            shininess: 50
        });
        const panels = new THREE.Mesh(panelGeo, panelMat);
        issModel.add(panels);

        const beacon = new THREE.Mesh(
            new THREE.SphereGeometry(0.05, 8, 8),
            new THREE.MeshBasicMaterial({color: 0x00ff00})
        );
        beacon.position.y = 0.2;
        issModel.add(beacon);

        issContainer.add(issModel);

        // --- ОРБИТА ---
        const MAX_POINTS = 3000;
        const trailGeo = new THREE.BufferGeometry();
        const positions = new Float32Array(MAX_POINTS * 3);
        trailGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        trailGeo.setDrawRange(0, 0);

        const trailMat = new THREE.LineDashedMaterial({ 
            color: 0x00ffff, 
            linewidth: 1, 
            scale: 1, 
            dashSize: 0.3, 
            gapSize: 0.2,
            transparent: true,
            opacity: 0.8
        });
        
        const trailLine = new THREE.Line(trailGeo, trailMat);
        issContainer.add(trailLine);

        let trailIndex = 0;
        let lastPosVector = null;
        let totalDistance = 0; // Переменная для подсчета расстояния

        function getVector(lat, lon, alt, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const r = radius + (alt * (10 / 6371));
            return new THREE.Vector3(-(r * Math.sin(phi) * Math.cos(theta)), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
        }

        async function updateISS() {
            try {
                const res = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await res.json();
                
                const pos = getVector(data.latitude, data.longitude, data.altitude, 10);
                
                issModel.position.copy(pos);
                issModel.lookAt(0,0,0); 
                
                let jump = false;
                if (lastPosVector) {
                    const distUnits = lastPosVector.distanceTo(pos);
                    // Проверка на прыжок через линию перемены дат (телепортация через Тихий океан)
                    if (distUnits > 5) { 
                         trailIndex = 0; // Сбрасываем линию, чтобы не чертить сквозь Землю
                         jump = true;
                    } else {
                        // Если прыжка нет, считаем расстояние
                        // 1 Unit = 637.1 km (Радиус Земли 6371 / Радиус модели 10)
                        const distKm = distUnits * 637.1;
                        totalDistance += distKm;
                    }
                }
                lastPosVector = pos.clone();

                if (!jump && trailIndex < MAX_POINTS) {
                    const posArr = trailLine.geometry.attributes.position.array;
                    posArr[trailIndex * 3] = pos.x;
                    posArr[trailIndex * 3 + 1] = pos.y;
                    posArr[trailIndex * 3 + 2] = pos.z;
                    trailIndex++;
                    
                    trailLine.geometry.setDrawRange(0, trailIndex);
                    trailLine.geometry.attributes.position.needsUpdate = true;
                    trailLine.computeLineDistances();
                }

                document.getElementById('data').innerHTML = 
                    `ШИРОТА : ${data.latitude.toFixed(4)}<br>` +
                    `ДОЛГОТА: ${data.longitude.toFixed(4)}<br>` +
                    `ВЫСОТА : ${data.altitude.toFixed(1)} км<br>` +
                    `СКОРОСТЬ: ${Math.round(data.velocity)} км/ч<br>` +
                    `РАССТОЯНИЕ: ${totalDistance.toFixed(1)} км`; // Новая строка
                
                document.getElementById('loading').style.display = 'none';
            } catch (e) { }
        }
        
        setInterval(updateISS, 2000);
        updateISS();

        function updateSunPosition() {
            if (!document.getElementById('chk-sun').checked) {
                sunLight.position.copy(camera.position);
                sunLight.intensity = 1.0;
                ambientLight.intensity = 1.0;
                sunSprite.visible = false;
                return;
            }

            sunSprite.visible = true;
            const now = new Date();
            
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const declination = -23.44 * Math.cos((360 / 365) * (dayOfYear + 10) * (Math.PI / 180));
            
            const utcHours = now.getUTCHours() + now.getUTCMinutes() / 60;
            const sunLong = (12 - utcHours) * 15;

            const sunPos = getVector(declination, sunLong, 200000, 10); 
            const visualSunPos = sunPos.clone().normalize().multiplyScalar(100);

            sunLight.position.copy(visualSunPos);
            sunSprite.position.copy(visualSunPos);

            sunLight.intensity = 2.0;
            ambientLight.intensity = 0.05; 
        }

        document.getElementById('chk-iss').addEventListener('change', (e) => issContainer.visible = e.target.checked);
        document.getElementById('chk-sun').addEventListener('change', updateSunPosition);

        function animate() {
            requestAnimationFrame(animate);
            clouds.rotation.y += 0.0001; 
            updateSunPosition();
            controls.update();
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
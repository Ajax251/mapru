<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro IPTV Player</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: currentColor; opacity: 0.3; border-radius: 3px; }
        
        .loader {
            border: 3px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        [v-cloak] { display: none; }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid currentColor; border-radius: 6px; }
        
        video::-webkit-media-controls-panel {
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

<div id="app" v-cloak class="flex h-full w-full" :style="themeStyles">

    <!-- SIDEBAR -->
    <aside 
        class="flex flex-col relative z-20 border-r-2"
        :style="{
            width: isSidebarOpen ? '320px' : '0',
            opacity: isSidebarOpen ? '1' : '0',
            overflow: isSidebarOpen ? 'visible' : 'hidden',
            backgroundColor: theme.sidebar,
            borderColor: theme.border,
            color: theme.text
        }"
    >
        <!-- Header -->
        <div class="p-3 border-b-2" :style="{borderColor: theme.border}">
            <!-- Logo & Settings -->
            <div class="flex items-center justify-between mb-3">
                <h1 class="text-lg font-bold flex items-center gap-2" :style="{color: theme.accent}">
                    <i class="ph-fill ph-television-simple text-2xl"></i> IPTV Pro
                </h1>
                <div class="flex items-center gap-1">
                    <span class="text-xs font-mono px-2 py-1 rounded" :style="{backgroundColor: theme.hover}" v-if="channels.length">{{ channels.length }} кан.</span>
                    <button @click="showSettings = !showSettings" class="p-2 rounded-lg font-bold" :style="{backgroundColor: showSettings ? theme.accent : 'transparent', color: showSettings ? theme.buttonText : theme.text}">
                        <i class="ph ph-gear text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div v-if="showSettings" class="p-3 rounded-lg mb-3 border-2" :style="{backgroundColor: theme.card, borderColor: theme.border}">
                <div class="text-xs font-bold mb-2 uppercase tracking-wide" :style="{color: theme.textMuted}">Настройки темы</div>
                
                <!-- Theme Presets -->
                <div class="flex gap-2 mb-3">
                    <button 
                        v-for="(preset, key) in themePresets" 
                        :key="key"
                        @click="applyTheme(key)"
                        class="w-8 h-8 rounded-lg border-2 flex items-center justify-center"
                        :style="{
                            backgroundColor: preset.accent,
                            borderColor: currentTheme === key ? theme.text : 'transparent'
                        }"
                        :title="preset.name"
                    >
                        <i v-if="currentTheme === key" class="ph-bold ph-check text-white text-sm"></i>
                    </button>
                </div>
                
                <!-- Custom Color -->
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium">Свой цвет</span>
                    <input type="color" v-model="customAccent" @input="applyCustomColor" class="w-8 h-8 rounded-lg cursor-pointer">
                </div>
                
                <!-- Clear Storage -->
                <div class="pt-3 border-t" :style="{borderColor: theme.border}">
                    <div class="text-xs font-bold mb-2 uppercase tracking-wide" :style="{color: theme.textMuted}">Данные</div>
                    <button 
                        @click="clearAllData" 
                        class="w-full text-xs py-2 px-3 rounded-lg font-medium flex items-center justify-center gap-2"
                        style="background-color: #dc2626; color: white;"
                    >
                        <i class="ph ph-trash"></i> Очистить локальное хранилище
                    </button>
                    <p class="text-xs mt-2" :style="{color: theme.textMuted}">Удалит избранное и настройки</p>
                </div>
            </div>

            <!-- Load Playlist -->
            <div class="p-3 rounded-lg mb-3 border-2" :style="{backgroundColor: theme.card, borderColor: theme.border}">
                <div class="text-xs font-bold mb-2 uppercase tracking-wide" :style="{color: theme.textMuted}">Загрузить плейлист</div>
                
                <!-- Load Actions -->
                <div class="flex gap-2">
                    <label class="flex-1 cursor-pointer text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2 font-medium border-2" 
                           :style="{backgroundColor: theme.button, borderColor: theme.border, color: theme.text}">
                        <i class="ph ph-file-arrow-up"></i> M3U файл
                        <input type="file" @change="handleFileUpload" accept=".m3u,.m3u8" class="hidden">
                    </label>
                </div>
                
                <!-- URL Input -->
                <div class="mt-2">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            v-model="urlInput"
                            @keyup.enter="loadFromUrl"
                            placeholder="URL плейлиста..." 
                            class="flex-1 text-xs rounded-lg px-3 py-2 border-2 focus:outline-none"
                            :style="{backgroundColor: theme.input, borderColor: theme.border, color: theme.text}"
                        >
                        <button @click="loadFromUrl" class="px-3 py-2 rounded-lg font-bold text-xs" :style="{backgroundColor: theme.accent, color: theme.buttonText}">
                            <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex rounded-lg p-1 mb-3" :style="{backgroundColor: theme.hover}">
                <button 
                    @click="currentTab = 'all'" 
                    class="flex-1 text-xs py-2 rounded-md font-bold"
                    :style="currentTab === 'all' ? {backgroundColor: theme.accent, color: theme.buttonText} : {color: theme.textMuted}"
                >
                    Все каналы
                </button>
                <button 
                    @click="currentTab = 'favorites'" 
                    class="flex-1 text-xs py-2 rounded-md font-bold flex items-center justify-center gap-1"
                    :style="currentTab === 'favorites' ? {backgroundColor: theme.accent, color: theme.buttonText} : {color: theme.textMuted}"
                >
                    <i class="ph-fill ph-star"></i> Избранное ({{ favorites.length }})
                </button>
            </div>

            <!-- Search -->
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5" :style="{color: theme.textMuted}"></i>
                <input 
                    type="text" 
                    v-model="searchQuery" 
                    placeholder="Поиск каналов..." 
                    class="w-full text-sm rounded-lg pl-10 pr-3 py-2.5 border-2 focus:outline-none"
                    :style="{backgroundColor: theme.input, borderColor: theme.border, color: theme.text}"
                >
            </div>
        </div>

        <!-- Channel List -->
        <div class="flex-1 overflow-y-auto p-2">
            <div v-if="displayedChannels.length === 0 && channels.length > 0" class="text-center mt-10 text-sm font-medium" :style="{color: theme.textMuted}">
                <i class="ph ph-magnifying-glass text-3xl mb-2"></i>
                <p>Ничего не найдено</p>
            </div>
            
            <div v-if="channels.length === 0" class="text-center mt-10 px-4 text-sm" :style="{color: theme.textMuted}">
                <i class="ph ph-television text-4xl mb-2"></i>
                <p class="font-medium">Загрузите плейлист</p>
                <p class="text-xs mt-1">M3U файл или URL</p>
            </div>

            <div 
                v-for="channel in displayedChannels" 
                :key="channel.id"
                class="w-full text-left px-3 py-2.5 rounded-lg flex items-center gap-3 cursor-pointer mb-1"
                :style="{
                    backgroundColor: currentChannel?.id === channel.id ? theme.accent : 'transparent',
                    color: currentChannel?.id === channel.id ? theme.buttonText : theme.text
                }"
                @click="playChannel(channel)"
                @mouseenter="$event.target.style.backgroundColor = currentChannel?.id === channel.id ? theme.accent : theme.hover"
                @mouseleave="$event.target.style.backgroundColor = currentChannel?.id === channel.id ? theme.accent : 'transparent'"
            >
                <div class="w-9 h-9 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0 border-2" 
                     :style="{backgroundColor: theme.card, borderColor: theme.border}">
                    <img v-if="channel.logo" :src="channel.logo" @error="channel.logo = null" class="w-full h-full object-contain">
                    <i v-else class="ph ph-television" :style="{color: theme.textMuted}"></i>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="font-semibold truncate text-sm">{{ channel.name }}</div>
                    <div class="text-xs truncate" :style="{opacity: 0.7}" v-if="channel.group">{{ channel.group }}</div>
                </div>

                <button 
                    @click.stop="toggleFavorite(channel)" 
                    class="p-1.5 rounded"
                    :style="{color: isFavorite(channel.id) ? '#f59e0b' : (currentChannel?.id === channel.id ? theme.buttonText : theme.textMuted)}"
                >
                    <i :class="isFavorite(channel.id) ? 'ph-fill ph-star' : 'ph ph-star'" class="text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Export Favorites -->
        <div v-if="favorites.length > 0" class="p-2 border-t-2" :style="{borderColor: theme.border}">
            <button 
                @click="exportFavorites" 
                class="w-full text-xs py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 border-2"
                :style="{backgroundColor: theme.button, borderColor: theme.border, color: theme.text}"
            >
                <i class="ph ph-download-simple"></i> Экспорт избранного (.m3u)
            </button>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 relative flex flex-col h-full" :style="{backgroundColor: theme.player}">
        
        <!-- Toggle Sidebar -->
        <button 
            @click="isSidebarOpen = !isSidebarOpen"
            class="absolute top-3 left-3 z-30 p-2.5 rounded-lg border-2 font-bold"
            :style="{backgroundColor: theme.sidebar, borderColor: theme.border, color: theme.text}"
        >
            <i :class="isSidebarOpen ? 'ph ph-caret-left' : 'ph ph-list'" class="text-lg"></i>
        </button>

        <!-- Video Container -->
        <div class="flex-1 relative flex items-center justify-center overflow-hidden bg-black">
            <video 
                id="videoPlayer" 
                controls 
                autoplay
                class="w-full h-full object-contain focus:outline-none"
            ></video>

            <div v-if="!currentChannel" class="absolute inset-0 flex flex-col items-center justify-center select-none pointer-events-none" :style="{color: theme.textMuted}">
                <i class="ph ph-monitor-play text-8xl mb-4" style="opacity: 0.3"></i>
                <h2 class="text-xl font-bold" style="opacity: 0.5">Выберите канал для просмотра</h2>
            </div>
            
            <div v-if="isLoadingVideo" class="absolute inset-0 bg-black/70 flex items-center justify-center z-10">
                <div class="loader" style="color: white"></div>
            </div>
        </div>

        <!-- Info Bar -->
        <div v-if="currentChannel" class="h-14 flex items-center px-4 justify-between border-t-2" :style="{backgroundColor: theme.sidebar, borderColor: theme.border}">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden border-2" 
                     :style="{backgroundColor: theme.card, borderColor: theme.border}">
                    <img v-if="currentChannel.logo" :src="currentChannel.logo" class="w-full h-full object-contain">
                    <i v-else class="ph ph-television" :style="{color: theme.textMuted}"></i>
                </div>
                <div>
                    <h2 class="font-bold text-sm" :style="{color: theme.text}">{{ currentChannel.name }}</h2>
                    <p class="text-xs" :style="{color: theme.textMuted}">{{ currentChannel.group || 'Без категории' }}</p>
                </div>
            </div>
            <div class="flex gap-1">
                <button 
                    @click="toggleFavorite(currentChannel)" 
                    class="p-2.5 rounded-lg"
                    :style="{color: isFavorite(currentChannel.id) ? '#f59e0b' : theme.textMuted, backgroundColor: theme.hover}"
                >
                    <i :class="isFavorite(currentChannel.id) ? 'ph-fill ph-star' : 'ph ph-star'" class="text-xl"></i>
                </button>
                <button @click="toggleFit" class="p-2.5 rounded-lg" :style="{color: theme.text, backgroundColor: theme.hover}">
                    <i class="ph ph-corners-out text-xl"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Toast Error -->
    <div v-if="errorMsg" class="fixed bottom-5 right-5 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50 font-medium" style="background-color: #dc2626; color: white;">
        <i class="ph ph-warning-circle text-xl"></i>
        <span>{{ errorMsg }}</span>
        <button @click="errorMsg = null" class="ml-2"><i class="ph ph-x"></i></button>
    </div>
    
    <!-- Toast Success -->
    <div v-if="successMsg" class="fixed bottom-5 right-5 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50 font-medium" style="background-color: #16a34a; color: white;">
        <i class="ph ph-check-circle text-xl"></i>
        <span>{{ successMsg }}</span>
    </div>

    <!-- Confirm Dialog -->
    <div v-if="showConfirmDialog" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="rounded-xl p-5 max-w-sm w-full mx-4 border-2" :style="{backgroundColor: theme.sidebar, borderColor: theme.border}">
            <div class="flex items-center gap-3 mb-4">
                <i class="ph ph-warning text-3xl" style="color: #f59e0b;"></i>
                <h3 class="font-bold text-lg" :style="{color: theme.text}">Подтверждение</h3>
            </div>
            <p class="mb-5" :style="{color: theme.textMuted}">{{ confirmMessage }}</p>
            <div class="flex gap-3">
                <button 
                    @click="showConfirmDialog = false" 
                    class="flex-1 py-2.5 rounded-lg font-bold border-2"
                    :style="{backgroundColor: theme.button, borderColor: theme.border, color: theme.text}"
                >
                    Отмена
                </button>
                <button 
                    @click="confirmAction" 
                    class="flex-1 py-2.5 rounded-lg font-bold"
                    style="background-color: #dc2626; color: white;"
                >
                    Удалить
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                channels: [],
                favorites: [],
                searchQuery: '',
                currentChannel: null,
                isSidebarOpen: true,
                urlInput: '',
                isLoadingVideo: false,
                errorMsg: null,
                successMsg: null,
                hls: null,
                videoElement: null,
                showSettings: false,
                currentTab: 'all',
                currentTheme: 'dark',
                customAccent: '#6366f1',
                showConfirmDialog: false,
                confirmMessage: '',
                confirmCallback: null,
                
                themePresets: {
                    light: {
                        name: 'Светлая',
                        accent: '#6366f1',
                        sidebar: '#ffffff',
                        card: '#f8fafc',
                        input: '#f1f5f9',
                        button: '#f1f5f9',
                        hover: '#e2e8f0',
                        border: '#cbd5e1',
                        text: '#1e293b',
                        textMuted: '#64748b',
                        buttonText: '#ffffff',
                        player: '#0f172a'
                    },
                    sky: {
                        name: 'Голубая',
                        accent: '#0ea5e9',
                        sidebar: '#f0f9ff',
                        card: '#e0f2fe',
                        input: '#e0f2fe',
                        button: '#e0f2fe',
                        hover: '#bae6fd',
                        border: '#7dd3fc',
                        text: '#0c4a6e',
                        textMuted: '#0369a1',
                        buttonText: '#ffffff',
                        player: '#082f49'
                    },
                    blue: {
                        name: 'Синяя',
                        accent: '#3b82f6',
                        sidebar: '#1e3a5f',
                        card: '#1e40af',
                        input: '#1e3a8a',
                        button: '#1e3a8a',
                        hover: '#2563eb',
                        border: '#3b82f6',
                        text: '#e0f2fe',
                        textMuted: '#93c5fd',
                        buttonText: '#ffffff',
                        player: '#0f172a'
                    },
                    emerald: {
                        name: 'Изумрудная',
                        accent: '#10b981',
                        sidebar: '#022c22',
                        card: '#064e3b',
                        input: '#065f46',
                        button: '#065f46',
                        hover: '#047857',
                        border: '#059669',
                        text: '#d1fae5',
                        textMuted: '#6ee7b7',
                        buttonText: '#ffffff',
                        player: '#011f17'
                    },
                    dark: {
                        name: 'Тёмная',
                        accent: '#8b5cf6',
                        sidebar: '#18181b',
                        card: '#27272a',
                        input: '#27272a',
                        button: '#27272a',
                        hover: '#3f3f46',
                        border: '#3f3f46',
                        text: '#fafafa',
                        textMuted: '#a1a1aa',
                        buttonText: '#ffffff',
                        player: '#09090b'
                    }
                }
            }
        },
        computed: {
            theme() {
                return this.themePresets[this.currentTheme] || this.themePresets.dark;
            },
            themeStyles() {
                return {
                    '--accent-color': this.theme.accent
                };
            },
            displayedChannels() {
                let list = this.currentTab === 'favorites' 
                    ? this.channels.filter(ch => this.favorites.includes(ch.id))
                    : this.channels;
                    
                if (!this.searchQuery) return list;
                const lowerQuery = this.searchQuery.toLowerCase();
                return list.filter(ch => 
                    ch.name.toLowerCase().includes(lowerQuery) || 
                    (ch.group && ch.group.toLowerCase().includes(lowerQuery))
                );
            }
        },
        mounted() {
            this.videoElement = document.getElementById('videoPlayer');
            this.loadSettings();
            this.loadFavorites();
            
            this.videoElement.addEventListener('waiting', () => this.isLoadingVideo = true);
            this.videoElement.addEventListener('playing', () => this.isLoadingVideo = false);
            this.videoElement.addEventListener('canplay', () => this.isLoadingVideo = false);
            this.videoElement.addEventListener('error', () => {
                this.isLoadingVideo = false;
                this.showError('Ошибка воспроизведения потока');
            });

            if (window.innerWidth < 768) {
                this.isSidebarOpen = false;
            }
        },
        methods: {
            applyTheme(themeKey) {
                this.currentTheme = themeKey;
                this.saveSettings();
            },
            
            applyCustomColor() {
                this.themePresets.custom = {
                    ...this.themePresets.dark,
                    name: 'Пользовательская',
                    accent: this.customAccent
                };
                this.currentTheme = 'custom';
                this.saveSettings();
            },

            clearAllData() {
                this.confirmMessage = 'Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.';
                this.confirmCallback = () => {
                    localStorage.clear();
                    this.favorites = [];
                    this.currentTheme = 'dark';
                    this.customAccent = '#6366f1';
                    delete this.themePresets.custom;
                    this.showSuccess('Локальное хранилище очищено');
                    this.showConfirmDialog = false;
                };
                this.showConfirmDialog = true;
            },

            confirmAction() {
                if (this.confirmCallback) {
                    this.confirmCallback();
                }
            },

            parseM3U(content) {
                const lines = content.split('\n');
                const result = [];
                let currentItem = {};
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.startsWith('#EXTINF:')) {
                        const info = line.substring(8);
                        const parts = info.split(',');
                        currentItem.name = parts[parts.length - 1].trim();
                        
                        const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                        if (logoMatch) currentItem.logo = logoMatch[1];
                        
                        const groupMatch = line.match(/group-title="([^"]*)"/);
                        currentItem.group = groupMatch ? groupMatch[1] : 'Разное';

                    } else if (line.startsWith('http')) {
                        currentItem.url = line;
                        currentItem.id = Math.random().toString(36).substr(2, 9);
                        result.push(currentItem);
                        currentItem = {};
                    }
                });
                return result;
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    this.channels = this.parseM3U(content);
                    if (this.channels.length === 0) {
                        this.showError('Каналы не найдены в файле');
                    } else {
                        this.showSuccess(`Загружено ${this.channels.length} каналов`);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            async loadFromUrl() {
                if (!this.urlInput) return;
                try {
                    this.isLoadingVideo = true;
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = this.urlInput.startsWith('http') ? this.urlInput : `https://${this.urlInput}`;
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                    if (!response.ok) throw new Error('Network error');
                    const text = await response.text();
                    
                    this.channels = this.parseM3U(text);
                    this.isLoadingVideo = false;
                    
                    if (this.channels.length === 0) {
                        this.showError('Каналы не найдены');
                    } else {
                        this.showSuccess(`Загружено ${this.channels.length} каналов`);
                        this.urlInput = '';
                    }
                } catch (e) {
                    this.isLoadingVideo = false;
                    this.showError('Ошибка загрузки (CORS или неверная ссылка)');
                    console.error(e);
                }
            },

            playChannel(channel) {
                this.currentChannel = channel;
                this.isLoadingVideo = true;
                
                if (window.innerWidth < 768) {
                    this.isSidebarOpen = false;
                }

                if (Hls.isSupported()) {
                    if (this.hls) {
                        this.hls.destroy();
                    }
                    this.hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    this.hls.loadSource(channel.url);
                    this.hls.attachMedia(this.videoElement);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        this.videoElement.play().catch(e => console.log("Autoplay blocked", e));
                    });
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    this.hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    this.hls.recoverMediaError();
                                    break;
                                default:
                                    this.hls.destroy();
                                    this.isLoadingVideo = false;
                                    break;
                            }
                        }
                    });
                } else if (this.videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    this.videoElement.src = channel.url;
                    this.videoElement.addEventListener('loadedmetadata', () => {
                        this.videoElement.play();
                    });
                } else {
                    this.showError('HLS не поддерживается вашим браузером');
                }
            },

            toggleFit() {
                this.videoElement.style.objectFit = this.videoElement.style.objectFit === 'cover' ? 'contain' : 'cover';
            },

            isFavorite(id) {
                return this.favorites.includes(id);
            },

            toggleFavorite(channel) {
                const idx = this.favorites.indexOf(channel.id);
                if (idx > -1) {
                    this.favorites.splice(idx, 1);
                } else {
                    this.favorites.push(channel.id);
                }
                this.saveFavorites();
            },

            saveFavorites() {
                localStorage.setItem('iptv_favorites', JSON.stringify(this.favorites));
            },

            loadFavorites() {
                const saved = localStorage.getItem('iptv_favorites');
                if (saved) {
                    try {
                        this.favorites = JSON.parse(saved);
                    } catch (e) {
                        this.favorites = [];
                    }
                }
            },

            exportFavorites() {
                const favChannels = this.channels.filter(ch => this.favorites.includes(ch.id));
                if (favChannels.length === 0) return;

                let m3u = '#EXTM3U\n';
                favChannels.forEach(ch => {
                    m3u += `#EXTINF:-1 tvg-logo="${ch.logo || ''}" group-title="${ch.group || ''}",${ch.name}\n`;
                    m3u += `${ch.url}\n`;
                });

                const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'favorites.m3u';
                a.click();
                URL.revokeObjectURL(url);
                this.showSuccess('Избранное экспортировано');
            },

            saveSettings() {
                localStorage.setItem('iptv_settings', JSON.stringify({
                    currentTheme: this.currentTheme,
                    customAccent: this.customAccent,
                    customTheme: this.themePresets.custom
                }));
            },

            loadSettings() {
                const saved = localStorage.getItem('iptv_settings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        this.currentTheme = settings.currentTheme || 'dark';
                        this.customAccent = settings.customAccent || '#6366f1';
                        if (settings.customTheme) {
                            this.themePresets.custom = settings.customTheme;
                        }
                    } catch (e) {
                        console.error('Error loading settings:', e);
                    }
                }
            },

            showError(msg) {
                this.errorMsg = msg;
                setTimeout(() => this.errorMsg = null, 4000);
            },
            
            showSuccess(msg) {
                this.successMsg = msg;
                setTimeout(() => this.successMsg = null, 2500);
            }
        }
    }).mount('#app');
</script>

</body>
</html>
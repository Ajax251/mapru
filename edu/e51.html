<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Сравнение Планет Солнечной Системы</title>
  <style>
    :root {
      --panel-bg: rgba(10, 15, 25, 0.92);
      --panel-border: #334455;
      --cyan: #00bcd4;
      --gold: #ffc107;
      --danger: #ff4444;
      --success: #4caf50;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    canvas { display: block; }

    /* Заголовок */
    #header {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      text-align: center;
      z-index: 10;
      pointer-events: none;
    }

    #header h1 {
      font-size: 28px;
      font-weight: 300;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(0, 188, 212, 0.5);
      margin-bottom: 5px;
    }

    #header p {
      font-size: 13px;
      color: #888;
      letter-spacing: 1px;
    }

    /* Панель управления */
    #ui {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--panel-bg);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--panel-border);
      color: white;
      max-width: 280px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      z-index: 10;
      max-height: 80vh;
      overflow-y: auto;
    }

    #ui::-webkit-scrollbar {
      width: 6px;
    }

    #ui::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    #ui::-webkit-scrollbar-thumb {
      background: var(--cyan);
      border-radius: 3px;
    }

    .ui-title {
      font-size: 14px;
      color: var(--cyan);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
    }

    .planet-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .planet-btn {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      padding: 12px 8px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .planet-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--cyan);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
      z-index: -1;
    }

    .planet-btn:hover::before {
      width: 200px;
      height: 200px;
    }

    .planet-btn:hover {
      border-color: var(--cyan);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
    }

    .planet-btn:active {
      transform: translateY(0);
    }

    .planet-btn.added {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.1));
      border-color: var(--success);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .planet-btn.added::after {
      content: '✓';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--success);
      font-weight: bold;
    }

    .control-btn {
      width: 100%;
      background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(255, 68, 68, 0.1));
      border: 1px solid var(--danger);
      color: white;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
      font-weight: 500;
      margin-top: 10px;
    }

    .control-btn:hover {
      background: var(--danger);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 68, 68, 0.4);
    }

    /* Информационная панель */
    #info-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-bg);
      padding: 25px 30px;
      border-radius: 16px;
      border: 1px solid var(--panel-border);
      color: white;
      min-width: 600px;
      max-width: 80vw;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #info-panel.visible {
      opacity: 1;
      pointer-events: all;
      transform: translateX(-50%) translateY(0);
    }

    .info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-header h2 {
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 1px;
      color: var(--cyan);
    }

    .close-info {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .close-info:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .info-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s;
    }

    .info-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--cyan);
      transform: translateY(-2px);
    }

    .info-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .info-value {
      font-size: 16px;
      color: white;
      font-weight: 500;
    }

    .info-fact {
      padding: 20px;
      background: linear-gradient(135deg, rgba(0, 188, 212, 0.1), rgba(0, 188, 212, 0.05));
      border-left: 3px solid var(--cyan);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      color: #ddd;
      position: relative;
      overflow: hidden;
    }

    .info-fact::before {
      content: '"';
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 60px;
      color: rgba(0, 188, 212, 0.2);
      font-family: Georgia, serif;
      line-height: 1;
    }

    /* Подсказки */
    #hints {
      position: absolute;
      top: 20px;
      left: 20px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      font-family: 'Courier New', monospace;
      z-index: 5;
      line-height: 1.8;
    }

    /* Адаптив */
    @media (max-width: 768px) {
      #ui {
        top: auto;
        bottom: 20px;
        right: 20px;
        max-width: calc(100vw - 40px);
      }

      .planet-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      #info-panel {
        min-width: auto;
        width: calc(100vw - 40px);
        padding: 20px;
      }

      .info-content {
        grid-template-columns: repeat(2, 1fr);
      }

      #header h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>СРАВНЕНИЕ ПЛАНЕТ</h1>
    <p>Интерактивная визуализация масштабов Солнечной системы</p>
  </div>

  <div id="hints">
    ЛКМ - Вращать<br>
    Колесо - Зум<br>
    ПКМ - Сдвиг<br>
    Двойной клик - Информация
  </div>

  <div id="ui">
    <div class="ui-title">Планеты</div>
    <div class="planet-grid" id="planetButtons"></div>
    <button class="control-btn" onclick="clearAll()">Очистить всё</button>
  </div>

  <div id="info-panel">
    <div class="info-header">
      <h2 id="planet-name">Земля</h2>
      <button class="close-info" onclick="hideInfo()">×</button>
    </div>
    <div class="info-content" id="info-content"></div>
    <div class="info-fact" id="info-fact"></div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";

    // --- КОНФИГУРАЦИЯ ПЛАНЕТ (по порядку от Солнца) ---
    const PLANETS = {
      Меркурий: {
        order: 1,
        radius: 2439,
        tex: 'textures/mercury2.jpg',
        bump: 'textures/mercury2.jpg',
        info: {
          radius: '2 439 км',
          mass: '3.3 × 10²³ кг',
          temp: '-173°C до +427°C',
          day: '58.6 земных суток',
          distance: '57.9 млн км от Солнца',
          fact: 'Меркурий — самая быстрая планета, совершающая оборот вокруг Солнца за 88 земных дней. У неё практически нет атмосферы, поэтому температура колеблется от экстремально холодной до невероятно жаркой.'
        }
      },
      Венера: {
        order: 2,
        radius: 6051,
        tex: 'textures/venus.jpg',
        bump: 'textures/venus.jpg',
        glow: 0xffaa55,
        info: {
          radius: '6 051 км',
          mass: '4.87 × 10²⁴ кг',
          temp: '+462°C (средняя)',
          day: '243 земных суток',
          distance: '108.2 млн км от Солнца',
          fact: 'Венера — самая горячая планета Солнечной системы благодаря плотной атмосфере из углекислого газа, создающей сильнейший парниковый эффект. Она вращается в обратном направлении и один день там длиннее года!'
        }
      },
      Земля: {
        order: 3,
        radius: 6371,
        tex: 'textures/earth-blue-marble.jpg',
        spec: 'textures/earth2.jpg',
        glow: 0x4488ff,
        info: {
          radius: '6 371 км',
          mass: '5.97 × 10²⁴ кг',
          temp: '-89°C до +58°C',
          day: '24 часа',
          distance: '149.6 млн км от Солнца',
          fact: 'Земля — единственная известная планета с жидкой водой на поверхности и жизнью. Около 71% её поверхности покрыто океанами, а атмосфера защищает от космической радиации.'
        }
      },
      Луна: {
        order: 3.5,
        radius: 1737,
        tex: 'textures/moon.png',
        bump: 'textures/moon.png',
        info: {
          radius: '1 737 км',
          mass: '7.35 × 10²² кг',
          temp: '-173°C до +127°C',
          day: '27.3 земных суток',
          distance: '384 400 км от Земли',
          fact: 'Луна — единственный естественный спутник Земли и пятый по величине спутник в Солнечной системе. Она всегда повёрнута к Земле одной стороной из-за приливного захвата. Лунные моря — это застывшая лава древних извержений.'
        }
      },
      Марс: {
        order: 4,
        radius: 3389,
        tex: 'textures/mars.jpg',
        bump: 'textures/mars2.jpg',
        glow: 0xff6644,
        info: {
          radius: '3 389 км',
          mass: '6.42 × 10²³ кг',
          temp: '-87°C до -5°C',
          day: '24.6 часа',
          distance: '227.9 млн км от Солнца',
          fact: 'Марс известен как "Красная планета" из-за оксида железа на поверхности. На нём находится самая высокая гора в Солнечной системе — Олимп (21 км). Учёные ищут признаки древней жизни в марсианских кратерах.'
        }
      },
      Юпитер: {
        order: 5,
        radius: 69911,
        tex: 'textures/jupiter.jpg',
        glow: 0xffcc88,
        info: {
          radius: '69 911 км',
          mass: '1.9 × 10²⁷ кг',
          temp: '-108°C (в облаках)',
          day: '9.9 часа',
          distance: '778.5 млн км от Солнца',
          fact: 'Юпитер — крупнейшая планета Солнечной системы, газовый гигант с массой в 2.5 раза больше всех остальных планет вместе взятых. Большое Красное Пятно — это ураган размером больше Земли, бушующий уже 350+ лет!'
        }
      },
      Сатурн: {
        order: 6,
        radius: 58232,
        tex: 'textures/saturn.jpg',
        glow: 0xffdd99,
        ring: {
          tex: 'textures/saturn2.jpg',
          inner: 74500,
          outer: 140220
        },
        info: {
          radius: '58 232 км',
          mass: '5.68 × 10²⁶ кг',
          temp: '-139°C (в облаках)',
          day: '10.7 часа',
          distance: '1.43 млрд км от Солнца',
          fact: 'Сатурн знаменит своими величественными кольцами из миллиардов частиц льда и камня. Его средняя плотность меньше воды — теоретически он мог бы плавать! У него 146 известных спутников, включая Титан с плотной атмосферой.'
        }
      },
      Уран: {
        order: 7,
        radius: 25362,
        tex: 'textures/uranus.jpg',
        glow: 0x4499cc,
        info: {
          radius: '25 362 км',
          mass: '8.68 × 10²⁵ кг',
          temp: '-197°C (в облаках)',
          day: '17.2 часа',
          distance: '2.87 млрд км от Солнца',
          fact: 'Уран — "лежачая планета", наклонённая на 98° к плоскости орбиты, словно катящаяся по ней бочком. Он имеет слабые кольца и 27 известных спутников. Атмосфера содержит метан, придающий планете сине-зелёный цвет.'
        }
      },
      Нептун: {
        order: 8,
        radius: 24622,
        tex: 'textures/neptune.jpg',
        glow: 0x4466ee,
        info: {
          radius: '24 622 км',
          mass: '1.02 × 10²⁶ кг',
          temp: '-201°C (в облаках)',
          day: '16.1 часа',
          distance: '4.5 млрд км от Солнца',
          fact: 'Нептун — самая дальняя планета Солнечной системы с самыми быстрыми ветрами (до 2100 км/ч)! Его интенсивный синий цвет обусловлен метаном в атмосфере. Один год на Нептуне равен 165 земным годам.'
        }
      },
      Плутон: {
        order: 9,
        radius: 1188,
        tex: 'textures/pluto.jpg',
        bump: 'textures/pluto.jpg',
        info: {
          radius: '1 188 км',
          mass: '1.3 × 10²² кг',
          temp: '-223°C (средняя)',
          day: '6.4 земных суток',
          distance: '5.9 млрд км от Солнца',
          fact: 'Плутон — карликовая планета в поясе Койпера. Несмотря на малые размеры, у него 5 спутников и сердцевидная равнина из азотного льда (Равнина Спутника). Миссия New Horizons показала удивительно активный геологический мир!'
        }
      }
    };

    const SCALE = 1 / 1000;

    // Сцена
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000508);
    scene.fog = new THREE.FogExp2(0x000508, 0.00015);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 50000);
    camera.position.set(0, 15, 50);

    const renderer = new THREE.WebGLRenderer({ 
      antialias: true, 
      powerPreference: "high-performance",
      alpha: true 
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;
    document.body.appendChild(renderer.domElement);

    // Post-processing для свечения
    const composer = new EffectComposer(renderer);
    const renderPass = new RenderPass(scene, camera);
    composer.addPass(renderPass);

    const bloomPass = new UnrealBloomPass(
      new THREE.Vector2(window.innerWidth, window.innerHeight),
      0.6,  // strength
      0.4,  // radius
      0.85  // threshold
    );
    composer.addPass(bloomPass);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = true;
    controls.minDistance = 5;
    controls.maxDistance = 1000;

    // Освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
    mainLight.position.set(50, 50, 50);
    scene.add(mainLight);

    const fillLight = new THREE.DirectionalLight(0x8899ff, 0.3);
    fillLight.position.set(-50, 0, -50);
    scene.add(fillLight);

    // Звёзды
    function createStars(count = 8000) {
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array(count * 3);
      const colors = new Float32Array(count * 3);
      const sizes = new Float32Array(count);
      
      for (let i = 0; i < count; i++) {
        const r = 1500 + Math.random() * 2500;
        const theta = 2 * Math.PI * Math.random();
        const phi = Math.acos(2 * Math.random() - 1);
        
        pos[i * 3] = r * Math.sin(phi) * Math.cos(theta);
        pos[i * 3 + 1] = r * Math.cos(phi);
        pos[i * 3 + 2] = r * Math.sin(phi) * Math.sin(theta);
        
        // Разные оттенки звёзд
        const temp = Math.random();
        if (temp > 0.9) {
          colors[i * 3] = 0.6;
          colors[i * 3 + 1] = 0.8;
          colors[i * 3 + 2] = 1.0;
        } else if (temp > 0.7) {
          colors[i * 3] = 1.0;
          colors[i * 3 + 1] = 0.9;
          colors[i * 3 + 2] = 0.7;
        } else {
          colors[i * 3] = 1.0;
          colors[i * 3 + 1] = 1.0;
          colors[i * 3 + 2] = 1.0;
        }
        
        sizes[i] = Math.random() * 2.5 + 0.5;
      }
      
      geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
      geo.setAttribute("color", new THREE.BufferAttribute(colors, 3));
      geo.setAttribute("size", new THREE.BufferAttribute(sizes, 1));
      
      const mat = new THREE.PointsMaterial({ 
        size: 2, 
        sizeAttenuation: true,
        vertexColors: true,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending
      });
      
      return new THREE.Points(geo, mat);
    }
    scene.add(createStars());

    // Текстуры
    const texLoader = new THREE.TextureLoader();
    const textureCache = {};

    function getTexture(url) {
      if (!textureCache[url]) {
        textureCache[url] = texLoader.load(url);
        textureCache[url].colorSpace = THREE.SRGBColorSpace;
      }
      return textureCache[url];
    }

    // Хранилище
    let activePlanets = [];
    const addedPlanetKeys = new Set();
    const planetsGroup = new THREE.Group();
    scene.add(planetsGroup);

    // --- СОЗДАНИЕ ПЛАНЕТЫ ---
    function createPlanet(key) {
      const data = PLANETS[key];
      const radius = data.radius * SCALE;

      const geometry = new THREE.SphereGeometry(radius, 128, 128);
      const material = new THREE.MeshPhongMaterial({
        map: getTexture(data.tex),
        shininess: data.spec ? 30 : 5,
        emissive: data.glow ? new THREE.Color(data.glow) : new THREE.Color(0x000000),
        emissiveIntensity: data.glow ? 0.15 : 0
      });

      if (data.bump) {
        material.bumpMap = getTexture(data.bump);
        material.bumpScale = 0.3 * SCALE;
      }
      if (data.spec) {
        material.specularMap = getTexture(data.spec);
        material.specular = new THREE.Color(0x666666);
      }

      const mesh = new THREE.Mesh(geometry, material);
      const container = new THREE.Group();
      container.add(mesh);

      // Атмосферное свечение
      if (data.glow) {
        const glowGeometry = new THREE.SphereGeometry(radius * 1.15, 64, 64);
        const glowMaterial = new THREE.ShaderMaterial({
          uniforms: {
            glowColor: { value: new THREE.Color(data.glow) },
            viewVector: { value: camera.position }
          },
          vertexShader: `
            uniform vec3 viewVector;
            varying float intensity;
            void main() {
              vec3 vNormal = normalize(normalMatrix * normal);
              vec3 vNormel = normalize(normalMatrix * viewVector);
              intensity = pow(0.7 - dot(vNormal, vNormel), 3.0);
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,
          fragmentShader: `
            uniform vec3 glowColor;
            varying float intensity;
            void main() {
              vec3 glow = glowColor * intensity;
              gl_FragColor = vec4(glow, intensity * 0.5);
            }
          `,
          side: THREE.BackSide,
          blending: THREE.AdditiveBlending,
          transparent: true
        });
        const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
        container.add(glowMesh);
      }

      // Кольца
      if (data.ring) {
        const inner = data.ring.inner * SCALE;
        const outer = data.ring.outer * SCALE;
        const ringGeo = new THREE.RingGeometry(inner, outer, 128);
        const ringPos = ringGeo.attributes.position;
        const ringUV = ringGeo.attributes.uv;

        for (let i = 0; i < ringUV.count; i++) {
          const x = ringPos.getX(i);
          const y = ringPos.getY(i);
          const len = Math.sqrt(x * x + y * y);
          const u = (len - inner) / (outer - inner);
          ringUV.setXY(i, u, 0.5);
        }

        const ringMat = new THREE.MeshBasicMaterial({
          map: getTexture(data.ring.tex),
          side: THREE.DoubleSide,
          transparent: true,
          opacity: 0.9,
          blending: THREE.AdditiveBlending
        });

        const ringMesh = new THREE.Mesh(ringGeo, ringMat);
        ringMesh.rotation.x = -Math.PI / 2;
        container.add(ringMesh);
      }

      container.userData = {
        name: key,
        radius: radius,
        realRadius: data.radius,
        info: data.info,
        rotationSpeed: 0.001 + Math.random() * 0.002
      };

      // Hitbox
      const hitBox = new THREE.Mesh(
        new THREE.SphereGeometry(radius * 1.2, 32, 32),
        new THREE.MeshBasicMaterial({ visible: false })
      );
      hitBox.userData = { isHitbox: true, parent: container };
      container.add(hitBox);

      return container;
    }

    // --- УПРАВЛЕНИЕ ПОЗИЦИЯМИ ---
    function recalculatePositions() {
      if (activePlanets.length === 0) {
        hideInfo();
        return;
      }

      // Сортируем по order
      activePlanets.sort((a, b) => {
        const orderA = PLANETS[a.userData.name].order;
        const orderB = PLANETS[b.userData.name].order;
        return orderA - orderB;
      });

      let currentX = 0;
      const padding = 15; // Увеличили отступы

      activePlanets.forEach((obj, index) => {
        const r = obj.userData.radius;
        if (index === 0) {
          currentX = r;
        } else {
          const prevR = activePlanets[index - 1].userData.radius;
          const extraSpace = (r > 20 || prevR > 20) ? 40 : 20; // Увеличили дополнительное пространство
          currentX += prevR + r + padding + extraSpace;
        }
        
        // Анимация появления
        const targetX = currentX;
        const startX = obj.position.x;
        animatePosition(obj, startX, targetX, 0.8);
      });

      // Центрируем
      const totalWidth = currentX;
      const offset = totalWidth / 2;
      activePlanets.forEach(obj => {
        obj.userData.targetX = (obj.userData.targetX || obj.position.x) - offset;
      });

      fitCamera();
    }

    function animatePosition(obj, start, end, duration) {
      const startTime = performance.now();
      obj.userData.targetX = end;
      
      function update() {
        const elapsed = (performance.now() - startTime) / 1000;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeOutCubic(progress);
        
        if (obj.userData.targetX !== undefined) {
          const current = start + (obj.userData.targetX - start) * eased;
          obj.position.x = current;
        }
        
        if (progress < 1 && activePlanets.includes(obj)) {
          requestAnimationFrame(update);
        }
      }
      update();
    }

    function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    function fitCamera() {
      if (activePlanets.length === 0) return;

      const box = new THREE.Box3();
      activePlanets.forEach(obj => box.expandByObject(obj));

      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);

      let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
      cameraZ *= 1.5;
      cameraZ = Math.max(cameraZ, 10);

      targetCameraZ = cameraZ;
      targetCameraPos.copy(center);
    }

    let targetCameraZ = 50;
    const targetCameraPos = new THREE.Vector3(0, 0, 0);

    // --- UI ---
    window.addPlanet = (key) => {
      if (addedPlanetKeys.has(key)) return;

      const planet = createPlanet(key);
      planet.scale.set(0.01, 0.01, 0.01);
      planetsGroup.add(planet);
      activePlanets.push(planet);
      addedPlanetKeys.add(key);

      // Анимация появления
      const targetScale = 1;
      const duration = 0.6;
      const startTime = performance.now();

      function scaleUp() {
        const elapsed = (performance.now() - startTime) / 1000;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeOutCubic(progress);
        const scale = 0.01 + (targetScale - 0.01) * eased;
        planet.scale.set(scale, scale, scale);

        if (progress < 1) {
          requestAnimationFrame(scaleUp);
        }
      }
      scaleUp();

      recalculatePositions();
      updateButtons();
    };

    window.clearAll = () => {
      activePlanets.forEach(p => {
        const duration = 0.4;
        const startTime = performance.now();
        const startScale = 1;

        function scaleDown() {
          const elapsed = (performance.now() - startTime) / 1000;
          const progress = Math.min(elapsed / duration, 1);
          const scale = startScale * (1 - progress);
          p.scale.set(scale, scale, scale);

          if (progress < 1) {
            requestAnimationFrame(scaleDown);
          } else {
            planetsGroup.remove(p);
          }
        }
        scaleDown();
      });

      activePlanets = [];
      addedPlanetKeys.clear();
      hideInfo();
      updateButtons();
      setTimeout(recalculatePositions, 500);
    };

    // Генерация кнопок
    const btnContainer = document.getElementById("planetButtons");
    Object.keys(PLANETS).forEach(key => {
      const btn = document.createElement("button");
      btn.className = "planet-btn";
      btn.textContent = key;
      btn.dataset.planet = key;
      btn.onclick = () => window.addPlanet(key);
      btnContainer.appendChild(btn);
    });

    function updateButtons() {
      document.querySelectorAll('.planet-btn').forEach(btn => {
        const key = btn.dataset.planet;
        if (addedPlanetKeys.has(key)) {
          btn.classList.add('added');
        } else {
          btn.classList.remove('added');
        }
      });
    }

    // Информация о планете
    function showInfo(planetObj) {
      const data = planetObj.userData;
      const info = data.info;

      document.getElementById('planet-name').textContent = data.name;

      const content = document.getElementById('info-content');
      content.innerHTML = `
        <div class="info-item">
          <div class="info-label">Радиус</div>
          <div class="info-value">${info.radius}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Масса</div>
          <div class="info-value">${info.mass}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Температура</div>
          <div class="info-value">${info.temp}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Сутки</div>
          <div class="info-value">${info.day}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Расстояние</div>
          <div class="info-value">${info.distance}</div>
        </div>
      `;

      document.getElementById('info-fact').textContent = info.fact;
      document.getElementById('info-panel').classList.add('visible');
    }

    window.hideInfo = () => {
      document.getElementById('info-panel').classList.remove('visible');
    };

    // Raycaster для двойного клика
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let clickTime = 0;

    window.addEventListener('dblclick', (event) => {
      const now = Date.now();
      if (now - clickTime < 300) return; // Защита от двойного клика
      clickTime = now;

      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(planetsGroup.children, true);

      if (intersects.length > 0) {
        let target = intersects[0].object;
        while (target.parent && target.parent !== planetsGroup) {
          target = target.parent;
        }

        if (activePlanets.includes(target)) {
          // Если панель уже открыта и отображает информацию о той же планете, то закрываем
          if (document.getElementById('info-panel').classList.contains('visible') && 
              document.getElementById('planet-name').textContent === target.userData.name) {
            hideInfo();
          } else {
            showInfo(target);
          }
        }
      } else {
        hideInfo();
      }
    });

    // Добавляем начальные планеты
    setTimeout(() => {
      window.addPlanet('Земля');
      setTimeout(() => window.addPlanet('Луна'), 200);
    }, 100);

    // --- ANIMATION LOOP ---
    function animate() {
      requestAnimationFrame(animate);

      // Плавное движение камеры
      if (Math.abs(camera.position.z - targetCameraZ) > 0.1) {
        camera.position.z += (targetCameraZ - camera.position.z) * 0.05;
      }

      camera.position.x += (targetCameraPos.x - camera.position.x) * 0.05;
      camera.position.y += (targetCameraPos.y + 15 - camera.position.y) * 0.05;

      // Вращение планет
      activePlanets.forEach(obj => {
        if (obj.children[0]) {
          obj.children[0].rotation.y += obj.userData.rotationSpeed;
        }
      });

      controls.update();
      composer.render();
    }

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
  </script>
</body>
</html>
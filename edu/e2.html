<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0" />
<title>–ü–ª–∞–Ω–µ—Ç–∞—Ä–∏–π 3D: –ù–µ–±–µ—Å–Ω–∞—è –°—Ñ–µ—Ä–∞</title>
<style>
    :root {
        --bg-color: #050a10;
        --panel-bg: rgba(15, 23, 35, 0.9);
        --accent: #00e5ff;
        --accent-dim: rgba(0, 229, 255, 0.1);
        --gold: #ffd700;
        --text-main: #e0f7fa;
        --border: rgba(0, 229, 255, 0.3);
    }

    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        background-color: var(--bg-color);
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        color: var(--text-main);
    }

    canvas { display: block; width: 100%; height: 100%; outline: none; }

    /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ü–ò–°–û–ö –°–û–ó–í–ï–ó–î–ò–ô --- */
    #constellation-panel {
        position: absolute; top: 20px; left: 20px; bottom: 20px;
        width: 280px;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        display: flex; flex-direction: column;
        backdrop-filter: blur(12px);
        z-index: 10;
        transition: transform 0.3s ease;
    }
    
    .panel-header {
        padding: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }

    .panel-title {
        font-size: 14px; font-weight: 700; color: var(--accent);
        text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
    }

    #search-const {
        width: 100%; padding: 8px 12px;
        background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
        border-radius: 6px; color: white; font-size: 13px; outline: none;
        box-sizing: border-box;
    }
    #search-const:focus { border-color: var(--accent); }

    #const-list {
        flex: 1; overflow-y: auto; padding: 5px;
        scrollbar-width: thin; scrollbar-color: var(--accent) transparent;
    }
    #const-list::-webkit-scrollbar { width: 4px; }
    #const-list::-webkit-scrollbar-thumb { background: var(--accent); }

    .const-item {
        padding: 8px 12px; cursor: pointer;
        font-size: 13px; border-radius: 4px;
        margin-bottom: 2px; transition: 0.2s;
        display: flex; justify-content: space-between;
    }
    .const-item:hover { background: var(--accent-dim); color: var(--accent); }
    .const-item.active { background: rgba(0, 229, 255, 0.25); color: #fff; font-weight: bold; border-left: 3px solid var(--accent); }
    .latin-name { font-size: 10px; opacity: 0.6; font-style: italic; }

    #btn-reset-view {
        margin-top: 5px; width: 100%; padding: 8px;
        background: transparent; border: 1px solid var(--accent);
        color: var(--accent); cursor: pointer; border-radius: 4px;
        text-transform: uppercase; font-size: 11px; font-weight: bold;
    }
    #btn-reset-view:hover { background: var(--accent); color: #000; }


    /* --- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ù–ê–°–¢–†–û–ô–ö–ò --- */
    #controls-panel {
        position: absolute; top: 20px; right: 20px;
        width: 240px;
        background: var(--panel-bg);
        border: 1px solid var(--border);
        border-radius: 12px; padding: 15px;
        backdrop-filter: blur(12px);
    }
    .ctrl-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; font-size: 13px;
    }
    
    .switch { position: relative; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #334; border-radius: 34px; transition: .3s; border: 1px solid #556;
    }
    .slider:before {
        position: absolute; content: ""; height: 14px; width: 14px;
        left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s;
    }
    input:checked + .slider { background-color: rgba(0, 229, 255, 0.3); border-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(20px); background-color: var(--accent); }


    /* --- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ò–ù–§–û --- */
    #info-panel {
        position: absolute; bottom: 20px; right: 20px;
        background: var(--panel-bg); border: 1px solid var(--border);
        border-radius: 12px; padding: 15px;
        backdrop-filter: blur(12px); pointer-events: none;
        text-align: right; min-width: 200px;
    }
    .info-data { font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.5; }
    .val-gold { color: var(--gold); }

    /* LOADING */
    #loading {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; display: flex; justify-content: center; align-items: center;
        z-index: 9999; color: var(--accent); font-size: 20px; text-transform: uppercase; letter-spacing: 2px;
    }
</style>
</head>
<body>

<div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ê—Ç–ª–∞—Å–∞...</div>

<!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
<div id="constellation-panel">
    <div class="panel-header">
        <div class="panel-title">‚≠ê –°–æ–∑–≤–µ–∑–¥–∏—è</div>
        <input type="text" id="search-const" placeholder="–§–∏–ª—å—Ç—Ä..." autocomplete="off">
        <button id="btn-reset-view">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
    </div>
    <div id="const-list">
        <!-- –°–ø–∏—Å–æ–∫ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
    </div>
</div>

<!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
<div id="controls-panel">
    <div class="panel-title" style="text-align: center;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∞</div>
    <div class="ctrl-row">
        <span>üåê –°–µ—Ç–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</span>
        <label class="switch"><input type="checkbox" id="chk-grid" checked><span class="slider"></span></label>
    </div>
    <div class="ctrl-row">
        <span>‚ú® –õ–∏–Ω–∏–∏ —Å–æ–∑–≤–µ–∑–¥–∏–π</span>
        <label class="switch"><input type="checkbox" id="chk-lines" checked><span class="slider"></span></label>
    </div>
    <div class="ctrl-row">
        <span>üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏—è (–°–æ–∑–≤.)</span>
        <label class="switch"><input type="checkbox" id="chk-const-names" checked><span class="slider"></span></label>
    </div>
    <div class="ctrl-row">
        <span>ü™ê –ü–ª–∞–Ω–µ—Ç—ã</span>
        <label class="switch"><input type="checkbox" id="chk-planets" checked><span class="slider"></span></label>
    </div>
    <div class="ctrl-row">
        <span>„Ä∞Ô∏è –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏</span>
        <label class="switch"><input type="checkbox" id="chk-traj" checked><span class="slider"></span></label>
    </div>
    <div class="ctrl-row">
        <span>üåç –ì–æ—Ä–∏–∑–æ–Ω—Ç</span>
        <label class="switch"><input type="checkbox" id="chk-ground" checked><span class="slider"></span></label>
    </div>
</div>

<!-- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
<div id="info-panel">
    <div style="font-weight:bold; margin-bottom:5px; font-size:13px; color:white;">–ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨</div>
    <div class="info-data" id="loc-data">GPS...</div>
    <div class="info-data val-gold" id="time-data">--:--</div>
</div>

<!-- LIBRARIES -->
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<!-- –í–ê–ñ–ù–û: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<script src="constellations.js"></script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

// === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
let scene, camera, renderer, controls;
const SPHERE_RADIUS = 50; 
let observerLat = 55.75, observerLon = 37.61; // –ú–æ—Å–∫–≤–∞
let activeConstellation = null; // –¢–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–∑–≤–µ–∑–¥–∏–µ

const PLANETS = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];

// –ì—Ä—É–ø–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤ —Å—Ü–µ–Ω—ã
const groups = {
    grid: new THREE.Group(),
    stars: new THREE.Group(),         // –í—Å–µ –∑–≤–µ–∑–¥—ã
    constellations: new THREE.Group(),// –õ–∏–Ω–∏–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è
    planets: new THREE.Group(),
    trajectories: new THREE.Group(),
    sunMoon: new THREE.Group(),
    ground: new THREE.Group()
};

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∑–≤–µ–∑–¥–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { "–ë–æ–ª—å—à–∞—è –ú–µ–¥–≤–µ–¥–∏—Ü–∞": { lines: THREE.Group, labels: THREE.Group, stars: [] } }
const constellationMap = {}; 

function init() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö
    if (typeof CONSTELLATIONS === 'undefined') {
        alert("–û—à–∏–±–∫–∞: —Ñ–∞–π–ª constellations.js –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç!");
        return;
    }

    // 1. –°—Ü–µ–Ω–∞
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020408);

    // 2. –ö–∞–º–µ—Ä–∞ (–°–Ω–∞—Ä—É–∂–∏ —Å—Ñ–µ—Ä—ã)
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 40, 90);

    // 3. –†–µ–Ω–¥–µ—Ä
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // 4. –ö–æ–Ω—Ç—Ä–æ–ª—ã
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 10;
    controls.maxDistance = 250;

    // 5. –°–≤–µ—Ç
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const dir = new THREE.DirectionalLight(0xffffff, 1);
    dir.position.set(100, 50, 50);
    scene.add(dir);

    // 6. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
    buildGrid();
    buildGround();
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø
    Object.values(groups).forEach(g => scene.add(g));

    // 7. UI –∏ –°–æ–±—ã—Ç–∏—è
    window.addEventListener('resize', onResize);
    setupUI();
    buildConstellationList();

    // 8. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            observerLat = pos.coords.latitude;
            observerLon = pos.coords.longitude;
            updateSky(); // –ü–µ—Ä–µ—Å—á–µ—Ç –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
        });
    }

    // 9. –ó–∞–ø—É—Å–∫
    updateSky();
    setInterval(updateSky, 60000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
    animate();
    document.getElementById('loading').style.display = 'none';
}

// --- –£–¢–ò–õ–ò–¢–´ –ì–†–ê–§–ò–ö–ò ---

function sphericalToCartesian(radius, azDeg, altDeg) {
    const altRad = THREE.MathUtils.degToRad(altDeg);
    const azRad = THREE.MathUtils.degToRad(azDeg);
    // Y –≤–≤–µ—Ä—Ö, Z –Ω–∞ –Æ–≥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ Astronomy.js –∞–∑–∏–º—É—Ç 0 = –°–µ–≤–µ—Ä, 90 = –í–æ—Å—Ç–æ–∫)
    // –í Three.js: -Z = –°–µ–≤–µ—Ä, +X = –í–æ—Å—Ç–æ–∫
    const x = radius * Math.cos(altRad) * Math.sin(azRad);
    const y = radius * Math.sin(altRad);
    const z = -radius * Math.cos(altRad) * Math.cos(azRad);
    return new THREE.Vector3(x, y, z);
}

function createTextSprite(text, color, scale = 1) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const fontSize = 48; // –í—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
    ctx.font = `bold ${fontSize}px Arial`;
    const w = ctx.measureText(text).width + 20;
    canvas.width = w; canvas.height = fontSize + 20;
    
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.shadowColor = 'black'; ctx.shadowBlur = 4;
    ctx.fillText(text, w/2, canvas.height/2);
    
    const tex = new THREE.CanvasTexture(canvas);
    const mat = new THREE.SpriteMaterial({ map: tex, depthTest: false });
    const sprite = new THREE.Sprite(mat);
    
    // –£–ú–ï–ù–¨–®–ï–ù–ù–´–ô –ë–ê–ó–û–í–´–ô –ú–ê–°–®–¢–ê–ë –¢–ï–ö–°–¢–ê
    const baseSize = 0.15; 
    sprite.scale.set(baseSize * w / 10, baseSize * canvas.height / 10, 1);
    
    return sprite;
}

function createStarSprite(color, size) {
    const canvas = document.createElement('canvas');
    canvas.width = 32; canvas.height = 32;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
    grad.addColorStop(0, 'white');
    grad.addColorStop(0.3, color);
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,32,32);
    
    const mat = new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), blending: THREE.AdditiveBlending });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(size, size, 1);
    return sprite;
}

function buildGrid() {
    const r = SPHERE_RADIUS;
    const mat = new THREE.LineBasicMaterial({ color: 0x004466, transparent: true, opacity: 0.25 });
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª–∏
    for(let alt=-80; alt<=80; alt+=20) {
        const pts = [];
        for(let az=0; az<=360; az+=5) pts.push(sphericalToCartesian(r, az, alt));
        groups.grid.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), mat));
    }
    // –ú–µ—Ä–∏–¥–∏–∞–Ω—ã
    for(let az=0; az<360; az+=30) {
        const pts = [];
        for(let alt=-90; alt<=90; alt+=5) pts.push(sphericalToCartesian(r, az, alt));
        groups.grid.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), mat));
    }
    
    // –°–¢–û–†–û–ù–´ –°–í–ï–¢–ê (–†–£–°–°–ö–ò–ï)
    const dirs = [
        {t:'–°', a:0, c:'#ff3333'}, {t:'–í', a:90, c:'#ffff33'}, 
        {t:'–Æ', a:180, c:'#33ff33'}, {t:'–ó', a:270, c:'#33ffff'}
    ];
    dirs.forEach(d => {
        const s = createTextSprite(d.t, d.c, 4); // –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ –¥–ª—è —Å—Ç–æ—Ä–æ–Ω —Å–≤–µ—Ç–∞
        s.position.copy(sphericalToCartesian(r+2, d.a, 0));
        groups.grid.add(s);
    });
}

function buildGround() {
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç (–¥–∏—Å–∫)
    const geo = new THREE.CircleGeometry(SPHERE_RADIUS, 64);
    const mat = new THREE.MeshBasicMaterial({ color: 0x0a1520, transparent: true, opacity: 0.5, side: THREE.DoubleSide });
    const disk = new THREE.Mesh(geo, mat);
    disk.rotation.x = Math.PI/2;
    groups.ground.add(disk);
    
    // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
    const ringGeo = new THREE.RingGeometry(SPHERE_RADIUS-0.3, SPHERE_RADIUS+0.3, 128);
    const ringMat = new THREE.MeshBasicMaterial({ color: 0x00e5ff, side: THREE.DoubleSide });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.rotation.x = Math.PI/2;
    groups.ground.add(ring);
    
    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å
    const center = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color:0x00e5ff}));
    groups.ground.add(center);
}

// --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

function updateSky() {
    const now = new Date();
    document.getElementById('loc-data').innerText = `LAT: ${observerLat.toFixed(3)} LON: ${observerLon.toFixed(3)}`;
    document.getElementById('time-data').innerText = now.toLocaleTimeString();

    const observer = new Astronomy.Observer(observerLat, observerLon, 0);

    // –û—á–∏—Å—Ç–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –≥—Ä—É–ø–ø
    ['stars','constellations','planets','trajectories','sunMoon'].forEach(k => {
        const g = groups[k];
        while(g.children.length) {
            const o = g.children[0];
            g.remove(o);
            if(o.geometry) o.geometry.dispose();
            if(o.material) o.material.dispose();
        }
    });

    // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã —Å—Å—ã–ª–æ–∫
    for (const key in constellationMap) delete constellationMap[key];

    // 1. –°–û–ó–í–ï–ó–î–ò–Ø –ò –ó–í–ï–ó–î–´ –ò–ó –§–ê–ô–õ–ê
    const starPosCache = {}; // RA/Dec(key) -> Vector3

    Object.keys(CONSTELLATIONS).forEach(cName => {
        const cData = CONSTELLATIONS[cName];
        const cGroupLines = new THREE.Group();
        const cGroupLabels = new THREE.Group();
        
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø—Ä–∞–π—Ç–æ–≤ –∑–≤–µ–∑–¥ —ç—Ç–æ–≥–æ —Å–æ–∑–≤–µ–∑–¥–∏—è (—á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –∏—Ö —è—Ä–∫–æ—Å—Ç—å –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏)
        const cStarSprites = []; 
        const cCenter = new THREE.Vector3();
        let starCount = 0;

        // –†–∏—Å—É–µ–º –∑–≤–µ–∑–¥—ã
        cData.stars.forEach(star => {
            const hor = Astronomy.Horizon(now, observer, star.ra, star.dec, 'normal');
            const pos = sphericalToCartesian(SPHERE_RADIUS, hor.azimuth, hor.altitude);
            
            // –ö—ç—à –¥–ª—è –ª–∏–Ω–∏–π
            starPosCache[star.name] = pos; 
            
            const size = Math.max(0.6, 2.5 - star.mag * 0.6); 
            const sSprite = createStarSprite('#ffffff', size);
            sSprite.position.copy(pos);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â—É—é –≥—Ä—É–ø–ø—É —Å—Ü–µ–Ω—ã, –Ω–æ —Ö—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫—É
            groups.stars.add(sSprite);
            cStarSprites.push(sSprite);

            // –ú–µ—Ç–∫–∞ –∑–≤–µ–∑–¥—ã (–µ—Å–ª–∏ —è—Ä–∫–∞—è)
            if(star.mag < 1.8 && hor.altitude > 0) {
                const l = createTextSprite(star.name, '#aaaaaa', 0.6);
                l.position.copy(pos).multiplyScalar(1.03);
                groups.stars.add(l);
                cStarSprites.push(l); // –¢–æ–∂–µ –±—É–¥–µ–º —Ç—É—à–∏—Ç—å –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            }

            cCenter.add(pos);
            starCount++;
        });

        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏
        if(cData.lines) {
            const points = [];
            cData.lines.forEach(pair => {
                const p1 = starPosCache[pair[0]];
                const p2 = starPosCache[pair[1]];
                if(p1 && p2) points.push(p1, p2);
            });
            if(points.length > 0) {
                const geo = new THREE.BufferGeometry().setFromPoints(points);
                const mat = new THREE.LineBasicMaterial({ color: 0xaa44ff, opacity: 0.5, transparent: true });
                const line = new THREE.LineSegments(geo, mat);
                cGroupLines.add(line);
            }
        }

        // –ú–µ—Ç–∫–∞ —Å–æ–∑–≤–µ–∑–¥–∏—è
        if(starCount > 0) {
            cCenter.divideScalar(starCount).normalize().multiplyScalar(SPHERE_RADIUS * 1.05);
            if(cCenter.y > -20) { // –ï—Å–ª–∏ –Ω–µ –≥–ª—É–±–æ–∫–æ –ø–æ–¥ –∑–µ–º–ª–µ–π
                const cl = createTextSprite(cName, '#d699ff', 1.5);
                cl.position.copy(cCenter);
                cGroupLabels.add(cl);
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã –≤ –≥–ª–∞–≤–Ω—É—é –≥—Ä—É–ø–ø—É –∫–æ–Ω—Å—Ç–µ–ª–ª—è—Ü–∏–π
        groups.constellations.add(cGroupLines);
        groups.constellations.add(cGroupLabels);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        constellationMap[cName] = {
            lines: cGroupLines,
            label: cGroupLabels,
            stars: cStarSprites,
            center: cCenter // –î–ª—è –Ω–∞–≤–µ–¥–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        };
    });

    // –ï—Å–ª–∏ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ —Å–æ–∑–≤–µ–∑–¥–∏–µ, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
    if(activeConstellation) highlightConstellation(activeConstellation);

    // 2. –ü–õ–ê–ù–ï–¢–´
    PLANETS.forEach(p => {
        const eq = Astronomy.Equator(p, now, observer, false, true);
        const hor = Astronomy.Horizon(now, observer, eq.ra, eq.dec, 'normal');
        const pos = sphericalToCartesian(SPHERE_RADIUS, hor.azimuth, hor.altitude);
        
        let col = '#ddd';
        if(p==='Mars') col='#ff5555'; if(p==='Jupiter') col='#ffcc99'; 
        if(p==='Venus') col='#fff'; if(p==='Saturn') col='#eedd88';
        
        const sp = createStarSprite(col, 2.8);
        sp.position.copy(pos);
        groups.planets.add(sp);
        
        if(hor.altitude > -5) {
            const lb = createTextSprite(p, col, 1.2);
            lb.position.copy(pos).multiplyScalar(1.08);
            groups.planets.add(lb);
        }
    });

    // 3. –°–û–õ–ù–¶–ï –ò –õ–£–ù–ê
    const sunEq = Astronomy.Equator('Sun', now, observer, false, true);
    const sunHor = Astronomy.Horizon(now, observer, sunEq.ra, sunEq.dec, 'normal');
    const sunPos = sphericalToCartesian(SPHERE_RADIUS, sunHor.azimuth, sunHor.altitude);
    groups.sunMoon.add(createStarSprite('#ffaa00', 6).copy({position: sunPos}));
    groups.sunMoon.add(createTextSprite('–°–æ–ª–Ω—Ü–µ', '#ffaa00', 1.5).copy({position: sunPos.clone().multiplyScalar(1.1)}));

    const moonEq = Astronomy.Equator('Moon', now, observer, false, true);
    const moonHor = Astronomy.Horizon(now, observer, moonEq.ra, moonEq.dec, 'normal');
    const moonPos = sphericalToCartesian(SPHERE_RADIUS, moonHor.azimuth, moonHor.altitude);
    groups.sunMoon.add(createStarSprite('#eeeeee', 4).copy({position: moonPos}));
    groups.sunMoon.add(createTextSprite('–õ—É–Ω–∞', '#ffffff', 1.2).copy({position: moonPos.clone().multiplyScalar(1.1)}));

    // 4. –¢–†–ê–ï–ö–¢–û–†–ò–ò
    drawTrajectory('Sun', 0xffaa00, now, observer);
    drawTrajectory('Moon', 0xffffff, now, observer);
}

function drawTrajectory(body, color, date, obs) {
    const pts = [];
    const d = new Date(date); d.setHours(0,0,0,0);
    for(let i=0; i<=24; i+=0.5) {
        const t = new Date(d.getTime() + i*3600000);
        const eq = Astronomy.Equator(body, t, obs, false, true);
        const h = Astronomy.Horizon(t, obs, eq.ra, eq.dec, 'normal');
        if(h.altitude > -10) pts.push(sphericalToCartesian(SPHERE_RADIUS, h.azimuth, h.altitude));
    }
    if(pts.length) {
        groups.trajectories.add(new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(pts),
            new THREE.LineBasicMaterial({ color: color, opacity: 0.5, transparent: true })
        ));
    }
}

// --- –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–°–¢–¨: –°–ü–ò–°–û–ö –ò –ü–û–î–°–í–ï–¢–ö–ê ---

function buildConstellationList() {
    const list = document.getElementById('const-list');
    const names = Object.keys(CONSTELLATIONS).sort();
    
    list.innerHTML = '';
    
    names.forEach(name => {
        const data = CONSTELLATIONS[name];
        const div = document.createElement('div');
        div.className = 'const-item';
        div.dataset.name = name;
        div.innerHTML = `<span>${name}</span><span class="latin-name">${data.latin}</span>`;
        div.onclick = () => selectConstellation(name);
        list.appendChild(div);
    });
}

function selectConstellation(name) {
    activeConstellation = name;
    
    // UI Update
    document.querySelectorAll('.const-item').forEach(el => {
        el.classList.toggle('active', el.dataset.name === name);
    });

    highlightConstellation(name);
}

function highlightConstellation(name) {
    const target = constellationMap[name];
    
    // –ó–∞—Ç–µ–º–Ω—è–µ–º –≤—Å–µ —Å–æ–∑–≤–µ–∑–¥–∏—è
    Object.values(constellationMap).forEach(obj => {
        // –õ–∏–Ω–∏–∏
        obj.lines.children.forEach(l => {
            l.material.opacity = 0.1; 
            l.material.color.setHex(0xaa44ff);
        });
        // –ù–∞–∑–≤–∞–Ω–∏—è
        obj.label.visible = false;
        // –ó–≤–µ–∑–¥—ã
        obj.stars.forEach(s => s.material.opacity = 0.2);
    });

    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
    if(target) {
        // –õ–∏–Ω–∏–∏
        target.lines.children.forEach(l => {
            l.material.opacity = 1.0; 
            l.material.color.setHex(0x00e5ff); // Cyan highlight
        });
        // –ù–∞–∑–≤–∞–Ω–∏–µ
        target.label.visible = true;
        // –ó–≤–µ–∑–¥—ã
        target.stars.forEach(s => s.material.opacity = 1.0);
    }
}

function resetView() {
    activeConstellation = null;
    document.querySelectorAll('.const-item').forEach(el => el.classList.remove('active'));
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç
    Object.values(constellationMap).forEach(obj => {
        obj.lines.children.forEach(l => {
            l.material.opacity = 0.5;
            l.material.color.setHex(0xaa44ff);
        });
        obj.label.visible = true;
        obj.stars.forEach(s => s.material.opacity = 1.0);
    });
}

// –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É
document.getElementById('search-const').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.const-item').forEach(el => {
        const txt = el.innerText.toLowerCase();
        el.style.display = txt.includes(term) ? 'flex' : 'none';
    });
});

document.getElementById('btn-reset-view').addEventListener('click', resetView);

// --- –û–ë–©–ò–ô UI ---
function setupUI() {
    const link = (id, grp) => document.getElementById(id).addEventListener('change', e => grp.visible = e.target.checked);
    link('chk-grid', groups.grid);
    link('chk-lines', groups.constellations.children[0] ? groups.constellations : groups.constellations); // Trick: toggle parent
    // –î–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø —Å–æ–∑–≤–µ–∑–¥–∏–π (–ª–∏–Ω–∏–∏ vs –Ω–∞–∑–≤–∞–Ω–∏—è) —Å–ª–æ–∂–Ω–µ–µ, 
    // –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –≥—Ä—É–ø–ø—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –∏–ª–∏ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º children
    document.getElementById('chk-lines').addEventListener('change', e => {
        Object.values(constellationMap).forEach(c => c.lines.visible = e.target.checked);
    });
    document.getElementById('chk-const-names').addEventListener('change', e => {
        Object.values(constellationMap).forEach(c => c.label.visible = e.target.checked);
    });
    
    link('chk-planets', groups.planets);
    link('chk-traj', groups.trajectories);
    link('chk-ground', groups.ground);
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

init();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0" />
  <title>Планеты</title>
    <link rel="icon" href="solar-system.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Jura:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Dark Theme (Default) */
      --bg-color: #030305;
      --panel-bg: rgba(15, 15, 25, 0.75);
      --panel-border: rgba(255, 255, 255, 0.12);
      --text-main: #ffffff;
      --text-sec: #94a3b8;
      --accent: #f59e0b; /* Gold/Sun color accent */
      --accent-glow: rgba(245, 158, 11, 0.4);
      --btn-bg: rgba(255, 255, 255, 0.07);
      --btn-hover: rgba(255, 255, 255, 0.18);
      --font-display: 'Jura', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    [data-theme="light"] {
      --bg-color: #f8fafc;
      --panel-bg: rgba(255, 255, 255, 0.85);
      --panel-border: rgba(0, 0, 0, 0.08);
      --text-main: #0f172a;
      --text-sec: #64748b;
      --accent: #ea580c;
      --accent-glow: rgba(234, 88, 12, 0.2);
      --btn-bg: rgba(0, 0, 0, 0.04);
      --btn-hover: rgba(0, 0, 0, 0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: var(--bg-color);
      font-family: var(--font-body);
      color: var(--text-main);
      transition: background 0.5s ease, color 0.5s ease;
    }

    canvas { display: block; outline: none; z-index: 1; }

    /* UI Layer */
    #ui-layer {
      position: absolute; inset: 0; z-index: 10; pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 24px;
    }

    /* Top Bar */
    .top-bar {
      pointer-events: auto;
      display: flex; justify-content: space-between; align-items: flex-start;
    }

    .app-title h1 {
      font-family: var(--font-display); font-weight: 700; font-size: 28px;
      letter-spacing: 2px; text-transform: uppercase;
      background: linear-gradient(135deg, var(--text-main), var(--text-sec));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .app-title span { font-size: 11px; color: var(--accent); letter-spacing: 4px; text-transform: uppercase; font-weight: 700; }

    /* Controls Container */
    .controls-right {
        display: flex; gap: 12px; align-items: center;
    }

    /* Generic Round Button Style */
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--panel-bg); border: 1px solid var(--panel-border);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-main);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--btn-hover); color: var(--accent); }
    .icon-btn svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; }

    /* Delete specific hover */
    .delete-btn:hover { 
      color: #ff4444; 
      border-color: rgba(255, 68, 68, 0.3);
      box-shadow: 0 4px 20px rgba(255, 68, 68, 0.2);
    }

    /* Milky Way Toggle Button */
    .mw-toggle {
        height: 44px; padding: 0 20px; border-radius: 22px;
        background: var(--panel-bg); border: 1px solid var(--panel-border);
        color: var(--text-sec); font-family: var(--font-display);
        font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
        cursor: pointer; display: flex; align-items: center; gap: 8px;
        backdrop-filter: blur(12px); transition: all 0.3s;
    }
    .mw-toggle:hover { background: var(--btn-hover); color: var(--text-main); }
    .mw-toggle.active { 
        border-color: var(--accent); 
        color: var(--accent); 
        background: rgba(245, 158, 11, 0.1);
        box-shadow: 0 0 15px var(--accent-glow);
    }
    .mw-indicator {
        width: 8px; height: 8px; border-radius: 50%; background: currentColor;
        box-shadow: 0 0 8px currentColor;
    }

    /* Bottom Dock */
    .dock-wrapper {
      pointer-events: auto;
      align-self: center; width: 100%; max-width: 950px;
      display: flex; justify-content: center;
    }

    .dock {
      background: var(--panel-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--panel-border);
      padding: 12px 20px; border-radius: 28px;
      display: flex; gap: 16px; align-items: center;
      box-shadow: 0 20px 50px -10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }

    .reset-btn {
      width: 48px; height: 48px; flex-shrink: 0;
      border-radius: 16px; background: var(--btn-bg);
      border: 1px solid var(--panel-border); color: var(--text-sec);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s;
    }
    .reset-btn:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706); 
      color: white; border-color: transparent;
      box-shadow: 0 0 25px rgba(245, 158, 11, 0.5);
      transform: translateY(-2px) rotate(90deg);
    }
    .reset-btn svg { width: 26px; height: 26px; stroke-width: 1.5; }

    .divider { width: 1px; height: 32px; background: var(--panel-border); margin: 0 4px; }

    .planet-scroll {
      display: flex; gap: 8px; overflow-x: auto; padding: 4px;
      -ms-overflow-style: none; scrollbar-width: none; 
      mask-image: linear-gradient(90deg, transparent, black 15px, black calc(100% - 15px), transparent);
      -webkit-mask-image: linear-gradient(90deg, transparent, black 15px, black calc(100% - 15px), transparent);
    }
    .planet-scroll::-webkit-scrollbar { display: none; }

    .chip {
      padding: 10px 20px; border-radius: 14px;
      background: var(--btn-bg); color: var(--text-sec);
      font-family: var(--font-display); font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap; border: 1px solid transparent;
      transition: all 0.2s; user-select: none; letter-spacing: 0.5px;
    }
    .chip:hover { background: var(--btn-hover); color: var(--text-main); transform: translateY(-2px); }
    .chip.active {
      background: rgba(245, 158, 11, 0.15); color: var(--accent);
      border-color: rgba(245, 158, 11, 0.4);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    /* Info Modal */
    .modal {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,0.1); backdrop-filter: blur(8px);
      opacity: 0; visibility: hidden; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal.visible { opacity: 1; visibility: visible; }

    .card {
      width: 90%; max-width: 440px;
      background: var(--bg-color); color: var(--text-main);
      border: 1px solid var(--panel-border);
      border-radius: 32px; padding: 36px;
      box-shadow: 0 40px 80px -20px rgba(0,0,0,0.5);
      transform: translateY(30px) scale(0.95); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    }
    .modal.visible .card { transform: translateY(0) scale(1); }

    .card h2 { font-family: var(--font-display); font-size: 42px; margin-bottom: 4px; line-height: 1; font-weight: 400; }
    .card .type { color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 3px; font-weight: 700; margin-bottom: 30px; }
    
    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .stat h4 { font-size: 10px; text-transform: uppercase; color: var(--text-sec); margin-bottom: 6px; letter-spacing: 1px; }
    .stat p { font-family: var(--font-display); font-size: 18px; font-weight: 500; }
    
    .fact { font-size: 14px; line-height: 1.7; color: var(--text-sec); padding-top: 24px; border-top: 1px solid var(--panel-border); }
    .close-modal {
      position: absolute; top: 24px; right: 24px; width: 36px; height: 36px;
      background: var(--btn-bg); border: none; border-radius: 50%; color: var(--text-sec);
      cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .close-modal:hover { background: var(--btn-hover); color: var(--text-main); }

    @media (max-width: 768px) {
      .dock { flex-direction: column-reverse; padding: 16px; width: 100%; border-radius: 24px; gap: 16px; }
      .dock-wrapper { max-width: 100%; }
      .planet-scroll { width: 100%; justify-content: flex-start; mask-image: none; -webkit-mask-image: none; }
      .divider { display: none; }
      .reset-btn { width: 100%; height: 50px; border-radius: 14px; }
      .top-bar { margin-bottom: 20px; }
      #ui-layer { padding: 16px; }
      .card h2 { font-size: 32px; }
    }
  </style>
</head>
<body data-theme="dark">

  <div id="ui-layer">
    <div class="top-bar">
      <div class="app-title">
        <h1>Планеты</h1>
        <span>Солнечной системы</span>
      </div>
      
      <div class="controls-right">
        <!-- Milky Way Toggle -->
        <button class="mw-toggle active" id="btnMW" onclick="toggleMilkyWay()" title="Вкл/Выкл Галактику">
          <div class="mw-indicator"></div>
         
        </button>

        <!-- Theme Toggle -->
        <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Сменить тему">
          <svg class="icon-moon" viewBox="0 0 24 24" style="display:block"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" style="display:none"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        </button>

        <!-- Delete Data Button (Moved to RIGHT) -->
        <button class="icon-btn delete-btn" onclick="clearTextureCache()" title="Удалить кэшированные данные">
          <!-- Иконка "Database Remove" - более красивая и технологичная -->
          <svg viewBox="0 0 24 24">
             <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
             <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
             <path d="M3 5v14c0 1.66 4 3 9 3 1.2 0 2.33-.08 3.39-.23"></path>
             <line x1="21" y1="21" x2="17" y2="17" stroke-width="2.5"></line>
             <line x1="17" y1="21" x2="21" y2="17" stroke-width="2.5"></line>
          </svg>
        </button>
      </div>
    </div>

    <div class="dock-wrapper">
      <div class="dock">
        <button class="reset-btn" onclick="clearAll()" title="Сбросить систему">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path><path d="M12 20v2"></path>
            <path d="M4.93 4.93l1.41 1.41"></path><path d="M17.66 17.66l1.41 1.41"></path>
            <path d="M2 12h2"></path><path d="M20 12h2"></path>
            <path d="M6.34 17.66l-1.41 1.41"></path><path d="M19.07 4.93l-1.41 1.41"></path>
          </svg>
        </button>
        <div class="divider"></div>
        <div class="planet-scroll" id="planetBtns"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <button class="close-modal" onclick="closeModal()">×</button>
      <h2 id="mTitle">Планета</h2>
      <div class="type" id="mType">Тип</div>
      <div class="stats" id="mStats"></div>
      <p class="fact" id="mFact">...</p>
    </div>
  </div>

 <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";

    const DB_NAME = 'SolarisDB';
    const STORE_NAME = 'textures';
    
    const dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            e.target.result.createObjectStore(STORE_NAME);
        };
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(e);
    });

    const internalLoader = new THREE.TextureLoader();

    function loadTextureWithCache(url) {
        const tex = new THREE.Texture();
        const image = new Image();
        image.crossOrigin = "Anonymous";
        
        image.onload = () => {
            tex.image = image;
            tex.needsUpdate = true;
        };

        dbPromise.then(db => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(url);

            request.onsuccess = () => {
                if (request.result) {
                    image.src = URL.createObjectURL(request.result);
                } else {
                    fetch(url)
                        .then(res => res.blob())
                        .then(blob => {
                            const txWrite = db.transaction(STORE_NAME, 'readwrite');
                            txWrite.objectStore(STORE_NAME).put(blob, url);
                            image.src = URL.createObjectURL(blob);
                        })
                        .catch(() => {
                            internalLoader.load(url, (t) => {
                                tex.image = t.image;
                                tex.needsUpdate = true;
                            });
                        });
                }
            };
        }).catch(() => {
            internalLoader.load(url, (t) => {
                tex.image = t.image;
                tex.needsUpdate = true;
            });
        });

        return tex;
    }

    window.clearTextureCache = () => {
        const req = indexedDB.deleteDatabase(DB_NAME);
        req.onsuccess = () => {
            alert('Кэш успешно очищен!');
            location.reload();
        };
        req.onerror = () => alert('Ошибка очистки кэша');
    };

    const PLANETS = {
      Солнце: { order: 0, radius: 25000, type: 'Звезда', info: { mass: '1.98 × 10³⁰ кг', temp: '5500°C', dist: '0 км' }, fact: 'Звезда главной последовательности класса G2V. Содержит 99.86% массы всей Солнечной системы.', isSun: true },
      Меркурий: { order: 1, radius: 2439, tex: 'textures/mercury2.jpg', bump: 'textures/mercury2.jpg', distAU: 0.39, info: { mass: '3.3 × 10²³ кг', temp: '427°C', dist: '58 млн км' }, fact: 'Самая быстрая планета: год длится 88 дней.', type: 'Земная группа' },
      Венера: { order: 2, radius: 6051, tex: 'textures/venus.jpg', bump: 'textures/venus.jpg', glow: 0xffaa55, distAU: 0.72, info: { mass: '4.9 × 10²⁴ кг', temp: '462°C', dist: '108 млн км' }, fact: 'Вращается в обратную сторону. Самая горячая планета.', type: 'Земная группа' },
      Земля: { order: 3, radius: 6371, tex: 'textures/earth-blue-marble.jpg', spec: 'textures/earth2.jpg', glow: 0x4488ff, distAU: 1.0, info: { mass: '5.9 × 10²⁴ кг', temp: '15°C', dist: '150 млн км' }, fact: 'Единственная планета с жидкой водой на поверхности.', type: 'Земная группа' },
      Марс: { order: 4, radius: 3389, tex: 'textures/mars.jpg', bump: 'textures/mars2.jpg', glow: 0xff4422, distAU: 1.52, info: { mass: '6.4 × 10²³ кг', temp: '-60°C', dist: '228 млн км' }, fact: 'Имеет самую высокую гору в системе — Олимп (21 км).', type: 'Земная группа' },
      Юпитер: { order: 5, radius: 69911, tex: 'textures/jupiter.jpg', glow: 0xeebb99, distAU: 5.2, info: { mass: '1.9 × 10²⁷ кг', temp: '-108°C', dist: '778 млн км' }, fact: 'Газовый гигант. Больше всех планет вместе взятых.', type: 'Газовый гигант' },
      Сатурн: { order: 6, radius: 58232, tex: 'textures/saturn.jpg', glow: 0xeeddcc, ring: { tex: 'textures/saturn2.png', inner: 1.3, outer: 2.3 }, distAU: 9.58, info: { mass: '5.7 × 10²⁶ кг', temp: '-139°C', dist: '1.4 млрд км' }, fact: 'Имеет самые яркие и сложные кольца.', type: 'Газовый гигант' },
      Уран: { order: 7, radius: 25362, tex: 'textures/uranus.jpg', glow: 0x88ffff, distAU: 19.22, info: { mass: '8.7 × 10²⁵ кг', temp: '-197°C', dist: '2.9 млрд км' }, fact: 'Вращается лежа на боку (наклон оси 98°).', type: 'Ледяной гигант' },
      Нептун: { order: 8, radius: 24622, tex: 'textures/neptune.jpg', glow: 0x3355ff, distAU: 30.05, info: { mass: '1.0 × 10²⁶ кг', temp: '-201°C', dist: '4.5 млрд км' }, fact: 'Ветры здесь дуют со скоростью 2100 км/ч.', type: 'Ледяной гигант' },
      Плутон: { order: 9, radius: 1188, tex: 'textures/pluto.jpg', bump: 'textures/pluto.jpg', distAU: 39.48, info: { mass: '1.3 × 10²² кг', temp: '-223°C', dist: '5.9 млрд км' }, fact: 'Карликовая планета с сердцем из азотного льда.', type: 'Карликовая планета' }
    };
    
    const BASE_SCALE = 1 / 4000;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.4;
    document.body.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85);
    composer.addPass(bloomPass);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 20;
    controls.maxDistance = 60000;
    controls.enableZoom = true;
    controls.zoomSpeed = 0.3;
    controls.rotateSpeed = 0.5; 
    controls.enablePan = false;

    const ambLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambLight);

    const hemiLight = new THREE.HemisphereLight(0xddeeff, 0x0f0e0d, 0.6);
    scene.add(hemiLight);

    const sunLight = new THREE.PointLight(0xffffff, 3.5, 0, 1);
    sunLight.position.set(100, 30, 80); 
    scene.add(sunLight);

    const bgGeo = new THREE.SphereGeometry(60000, 64, 64);
    const bgMat = new THREE.MeshBasicMaterial({
        map: loadTextureWithCache('textures/milkyway.jpg'),
        side: THREE.BackSide,
        transparent: true,
        opacity: 0.8,
        depthWrite: false
    });
    const skyboxMilkyWay = new THREE.Mesh(bgGeo, bgMat);
    skyboxMilkyWay.renderOrder = -1;
    scene.add(skyboxMilkyWay);

    function createStarfield() {
      const count = 6000;
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array(count * 3);
      const sizes = new Float32Array(count);
      const colors = new Float32Array(count * 3);
      for (let i=0; i<count; i++) {
        const r = 5000 + Math.random() * 5000;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        pos[i*3] = r * Math.sin(phi) * Math.cos(theta);
        pos[i*3+1] = r * Math.cos(phi);
        pos[i*3+2] = r * Math.sin(phi) * Math.sin(theta);
        sizes[i] = 1.0 + Math.random() * 2.0;
        const c = new THREE.Color().setHSL(0.6, 0.2, 0.8 + Math.random()*0.2);
        colors[i*3] = c.r; colors[i*3+1] = c.g; colors[i*3+2] = c.b;
      }
      geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
      geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      
      const canvas = document.createElement('canvas'); canvas.width=32; canvas.height=32;
      const ctx = canvas.getContext('2d');
      const grad = ctx.createRadialGradient(16,16,0,16,16,16);
      grad.addColorStop(0, 'white'); grad.addColorStop(1, 'transparent');
      ctx.fillStyle = grad; ctx.fillRect(0,0,32,32);
      const tex = new THREE.Texture(canvas); tex.needsUpdate = true;
      const mat = new THREE.PointsMaterial({ size: 1, map: tex, vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending, depthWrite: false });
      return new THREE.Points(geo, mat);
    }
    const stars = createStarfield();
    scene.add(stars);

    function createMilkyWay() {
      const count = 20000;
      const geo = new THREE.BufferGeometry();
      const pos = new Float32Array(count * 3);
      const colors = new Float32Array(count * 3);
      for(let i=0; i<count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const radius = 6000 + Math.random() * 1000;
        const height = (Math.random() - 0.5) * 1500;
        const x = radius * Math.cos(angle);
        const y = height;
        const z = radius * Math.sin(angle);
        const tilt = Math.PI / 4;
        const x2 = x * Math.cos(tilt) - y * Math.sin(tilt);
        const y2 = x * Math.sin(tilt) + y * Math.cos(tilt);
        pos[i*3] = x2; pos[i*3+1] = y2; pos[i*3+2] = z;
        const c = new THREE.Color().setHSL(0.65 + Math.random()*0.1, 0.6, 0.1 + Math.random()*0.1);
        colors[i*3] = c.r; colors[i*3+1] = c.g; colors[i*3+2] = c.b;
      }
      geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      const mat = new THREE.PointsMaterial({ size: 40, vertexColors: true, transparent: true, opacity: 0.2, blending: THREE.AdditiveBlending, depthWrite: false });
      return new THREE.Points(geo, mat);
    }
    const milkyWay = createMilkyWay();
    scene.add(milkyWay);

    class ShootingStar {
      constructor() {
        this.group = new THREE.Group();
        this.head = new THREE.Mesh(new THREE.SphereGeometry(1, 8, 8), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        this.group.add(this.head);
        this.tail = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]), new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 }));
        this.group.add(this.tail);
        scene.add(this.group); this.group.visible = false; this.active = false;
      }
      spawn() {
        if(this.active) return;
        const r = 1000; const theta = Math.random()*Math.PI*2; const phi = Math.random()*Math.PI;
        this.group.position.set(r*Math.sin(phi)*Math.cos(theta), r*Math.cos(phi), r*Math.sin(phi)*Math.sin(theta));
        const target = new THREE.Vector3((Math.random()-0.5)*300, (Math.random()-0.5)*300, (Math.random()-0.5)*300);
        this.vel = new THREE.Vector3().subVectors(target, this.group.position).normalize().multiplyScalar(6+Math.random()*6);
        this.active = true; this.life = 1.0; this.group.visible = true;
      }
      update() {
        if(!this.active) return;
        this.group.position.add(this.vel);
        const trail = this.vel.clone().normalize().multiplyScalar(-30);
        const attr = this.tail.geometry.attributes.position;
        attr.setXYZ(1, trail.x, trail.y, trail.z); attr.needsUpdate = true;
        this.life -= 0.015; this.tail.material.opacity = this.life;
        if(this.life<=0) { this.active=false; this.group.visible=false; }
      }
    }
    const meteors = Array.from({length:4}, ()=>new ShootingStar());

    const sunVertexShader = `
      varying vec2 vUv;
      varying vec3 vNormal;
      void main() {
        vUv = uv;
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `;

    const sunFragmentShader = `
      uniform float time;
      varying vec2 vUv;
      float noise(vec3 p) {
        vec3 i = floor(p); vec3 f = fract(p); f = f * f * (3.0 - 2.0 * f);
        return mix(mix(mix(fract(sin(dot(i, vec3(12.9898, 78.233, 45.543))) * 43758.5453), fract(sin(dot(i + vec3(1, 0, 0), vec3(12.9898, 78.233, 45.543))) * 43758.5453), f.x), mix(fract(sin(dot(i + vec3(0, 1, 0), vec3(12.9898, 78.233, 45.543))) * 43758.5453), fract(sin(dot(i + vec3(1, 1, 0), vec3(12.9898, 78.233, 45.543))) * 43758.5453), f.x), f.y), mix(mix(fract(sin(dot(i + vec3(0, 0, 1), vec3(12.9898, 78.233, 45.543))) * 43758.5453), fract(sin(dot(i + vec3(1, 0, 1), vec3(12.9898, 78.233, 45.543))) * 43758.5453), f.x), mix(fract(sin(dot(i + vec3(0, 1, 1), vec3(12.9898, 78.233, 45.543))) * 43758.5453), fract(sin(dot(i + vec3(1, 1, 1), vec3(12.9898, 78.233, 45.543))) * 43758.5453), f.x), f.y), f.z);
      }
      void main() {
        float n = noise(vec3(vUv * 8.0, time * 0.5)) * 0.5 + noise(vec3(vUv * 16.0, time * 1.0)) * 0.25;
        vec3 color = mix(vec3(1.0, 0.3, 0.0), vec3(1.0, 0.9, 0.2), n + 0.2);
        gl_FragColor = vec4(color * 1.5, 1.0);
      }
    `;

    const planetsGroup = new THREE.Group();
    scene.add(planetsGroup);
    let activePlanets = [];
    const addedKeys = new Set();

    function createPlanet(key) {
      const d = PLANETS[key];
      let r = d.radius * BASE_SCALE;
      if (d.isSun) r = 4.0;

      const group = new THREE.Group();

      if (d.isSun) {
        const sunMat = new THREE.ShaderMaterial({
          uniforms: { time: { value: 0 } },
          vertexShader: sunVertexShader,
          fragmentShader: sunFragmentShader
        });
        const mesh = new THREE.Mesh(new THREE.SphereGeometry(r, 64, 64), sunMat);
        group.add(mesh);
        
        const glowMat = new THREE.SpriteMaterial({ 
            map: new THREE.CanvasTexture(generateSunGlowTexture()), 
            color: 0xffaa00, transparent: true, blending: THREE.AdditiveBlending 
        });
        const glowSprite = new THREE.Sprite(glowMat);
        glowSprite.scale.set(r*5, r*5, 1);
        group.add(glowSprite);
        group.userData = { isSun: true };
      } else {
        const mat = new THREE.MeshPhongMaterial({ map: loadTextureWithCache(d.tex), shininess: 15 });
        if(d.bump) { mat.bumpMap = loadTextureWithCache(d.bump); mat.bumpScale = 0.02; }
        
        const mesh = new THREE.Mesh(new THREE.SphereGeometry(r, 64, 64), mat);
        group.add(mesh);

        if(d.glow) {
          const glowMat = new THREE.ShaderMaterial({
            uniforms: {
              c: { value: 0.2 }, 
              p: { value: 4.5 }, 
              glowColor: { value: new THREE.Color(d.glow) },
              viewVector: { value: camera.position }
            },
            vertexShader: `uniform vec3 viewVector; uniform float c; uniform float p; varying float intensity; void main() { vec3 vNormal = normalize( normalMatrix * normal ); vec3 vNormel = normalize( normalMatrix * viewVector ); intensity = pow( max(0.0, c - dot(vNormal, vNormel)), p ); gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`,
            fragmentShader: `uniform vec3 glowColor; varying float intensity; void main() { gl_FragColor = vec4( glowColor, intensity * 0.6 ); }`,
            side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false
          });
          const glow = new THREE.Mesh(new THREE.SphereGeometry(r*1.12, 64, 64), glowMat);
          group.add(glow);
          group.userData.glowMesh = glow;
        }

        if(d.ring) {
          const rg = new THREE.RingGeometry(r*d.ring.inner, r*d.ring.outer, 128);
          const pos = rg.attributes.position; const v3 = new THREE.Vector3();
          const max = r*d.ring.outer;
          for(let i=0; i<pos.count; i++){
            v3.fromBufferAttribute(pos, i);
            rg.attributes.uv.setXY(i, 0.5+v3.x/(max*2), 0.5+v3.y/(max*2));
          }
          const rm = new THREE.MeshStandardMaterial({ map: loadTextureWithCache(d.ring.tex), side: THREE.DoubleSide, transparent: true, opacity: 0.8 });
          const ring = new THREE.Mesh(rg, rm);
          ring.rotation.x = -Math.PI/2;
          group.add(ring);
        }
      }

      group.userData = { ...group.userData, name: key, ...d };
      return group;
    }

    function generateSunGlowTexture() {
      const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
      const ctx = canvas.getContext('2d');
      const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
      gradient.addColorStop(0, 'rgba(255, 200, 100, 1)');
      gradient.addColorStop(0.4, 'rgba(255, 100, 0, 0.2)');
      gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
      ctx.fillStyle = gradient; ctx.fillRect(0,0,64,64);
      return canvas;
    }

    let camTarget = new THREE.Vector3(0, 30, 80);
    let viewTarget = new THREE.Vector3(0, 0, 0);
    let interacting = false;

    function updateLayout() {
      if(!activePlanets.length) return;
      const hasSun = activePlanets.some(p => p.userData.isSun);

      if (hasSun) {
        sunLight.position.set(0, 0, 0);

        const AU_SCALE = 100; 

        let maxDist = 0;

        activePlanets.forEach(p => {
            if (p.userData.isSun) {
                p.userData.tx = 0;
                p.scale.setScalar(3.0); 
            } else {
                p.userData.tx = p.userData.distAU * AU_SCALE;
                const currentGeoRadius = p.userData.radius * BASE_SCALE;
                const scaleFactor = 4.0 / currentGeoRadius;
                p.scale.setScalar(scaleFactor);
            }
            
            if (p.userData.tx > maxDist) maxDist = p.userData.tx;
        });

        viewTarget.set(maxDist * 0.5, 0, 0);
        camTarget.set(maxDist * 0.5, maxDist * 0.2, maxDist * 0.9 + 200);

      } else {
        sunLight.position.set(100, 30, 80);
        activePlanets.sort((a,b) => PLANETS[a.userData.name].order - PLANETS[b.userData.name].order);
        let x = 0;
        activePlanets.forEach((p,i)=>{
            p.scale.setScalar(1); 
            if(i>0) {
                const prev = activePlanets[i-1];
                let pr = prev.userData.isSun ? 4.0 : prev.userData.radius * BASE_SCALE;
                if (!prev.userData.isSun && PLANETS[prev.userData.name].ring) pr *= 1.5;
                let cr = p.userData.isSun ? 4.0 : p.userData.radius * BASE_SCALE;
                if (!p.userData.isSun && PLANETS[p.userData.name].ring) cr *= 1.5;
                x += (pr+cr)*1.2 + 8; 
            }
            p.userData.tx = x;
        });
        const tot = activePlanets[activePlanets.length-1].userData.tx;
        activePlanets.forEach(p=>p.userData.tx -= tot/2);
        
        viewTarget.set(0, 0, 0);
        camTarget.set(0, Math.max(tot, 30)*0.35, Math.max(tot, 30)*1.1);
      }
      interacting = false;
    }

    window.addPlanet = (k) => {
      if(addedKeys.has(k)) return;
      const p = createPlanet(k); p.scale.set(0,0,0);
      planetsGroup.add(p); activePlanets.push(p); addedKeys.add(k);
      updateLayout(); updateUI();
      let t=0; function a(){ t+=0.04; 
          if(p.userData.isSun) {
            p.scale.setScalar(Math.min(t, 3.0));
          } else {
             const currentGeoRadius = p.userData.radius * BASE_SCALE;
             const targetScale = activePlanets.some(x => x.userData.isSun) ? 4.0 / currentGeoRadius : 1.0;
             p.scale.setScalar(Math.min(t * targetScale, targetScale));
          }
          if(t<1) requestAnimationFrame(a); 
      } a();
    };
    
    window.removePlanet = (k) => {
      const p = activePlanets.find(x=>x.userData.name===k);
      if(!p) return;
      let t=1; function a(){ t-=0.06; p.scale.setScalar(Math.max(t,0)); if(t>0) requestAnimationFrame(a); else { planetsGroup.remove(p); activePlanets=activePlanets.filter(x=>x!==p); addedKeys.delete(k); updateLayout(); updateUI(); } } a();
    };
    
    window.clearAll = () => [...activePlanets].forEach(p=>window.removePlanet(p.userData.name));

    const box = document.getElementById('planetBtns');
    const keys = Object.keys(PLANETS).sort((a,b) => PLANETS[a].order - PLANETS[b].order);
    keys.forEach(k=>{
      const b = document.createElement('div'); b.className='chip'; b.textContent=k; b.dataset.p=k;
      b.onclick=()=>addedKeys.has(k)?window.removePlanet(k):window.addPlanet(k);
      box.appendChild(b);
    });
    
    function updateUI(){ document.querySelectorAll('.chip').forEach(c=>addedKeys.has(c.dataset.p)?c.classList.add('active'):c.classList.remove('active')); }

    let isDark = true;
    let isMWActive = true; 

    window.toggleMilkyWay = () => {
        isMWActive = !isMWActive;
        const btn = document.getElementById('btnMW');
        if(isMWActive) {
            btn.classList.add('active');
            if(isDark) skyboxMilkyWay.visible = true; 
        } else {
            btn.classList.remove('active');
            skyboxMilkyWay.visible = false;
        }
    };

    window.toggleTheme = () => {
     isDark = !isDark;
     document.body.dataset.theme = isDark ? 'dark' : 'light';
     
     const tBtn = document.querySelector('.theme-btn');
     tBtn.querySelector('.icon-moon').style.display = isDark ? 'block' : 'none';
     tBtn.querySelector('.icon-sun').style.display = isDark ? 'none' : 'block';

     if(isDark) {
        scene.background = null; 
        stars.visible = true; 
        milkyWay.visible = true; 
        if(isMWActive) skyboxMilkyWay.visible = true;
        meteors.forEach(m=>m.group.visible=m.active);
        bloomPass.strength = 1.0; 
        ambLight.intensity = 0.7; 
        hemiLight.intensity = 0.6; 
    } else {
        scene.background = new THREE.Color(0xf8fafc);
        stars.visible = false; 
        milkyWay.visible = false; 
        skyboxMilkyWay.visible = false; 
        meteors.forEach(m=>m.group.visible=false);
        bloomPass.strength = 0; 
        ambLight.intensity = 1.2;
        hemiLight.intensity = 0.8; 
    }
    };

    window.addPlanet('Земля'); window.addPlanet('Марс');

    renderer.domElement.addEventListener('wheel',()=>interacting=true);
    controls.addEventListener('start',()=>interacting=true);

    function animate(time) {
      requestAnimationFrame(animate);
      const t = time * 0.001; 
      
      if(!interacting) { 
          camera.position.lerp(camTarget, 0.04); 
          controls.target.lerp(viewTarget, 0.04); 
      }

      skyboxMilkyWay.rotation.y = t * 0.005;
      activePlanets.forEach(p=>{
        p.position.x += (p.userData.tx - p.position.x)*0.1;
        if (p.userData.isSun) {
           p.children[0].material.uniforms.time.value = t;
           p.children[0].rotation.y = t * 0.05;
        } else {
           p.children[0].rotation.y += 0.002;
           if(p.userData.glowMesh && p.userData.glowMesh.material.uniforms) {
              p.userData.glowMesh.material.uniforms.viewVector.value = camera.position;
           }
        }
      });
      if(isDark) {
        meteors.forEach(m=>m.update());
        if(Math.random()<0.005) { const m=meteors.find(x=>!x.active); if(m) m.spawn(); }
      }
      controls.update(); 
      composer.render();
    }
    
    window.addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); composer.setSize(innerWidth,innerHeight); });
    
    animate(0);

    const ray = new THREE.Raycaster(); const m = new THREE.Vector2();
    window.addEventListener('dblclick', e=>{
      m.x=(e.clientX/innerWidth)*2-1; m.y=-(e.clientY/innerHeight)*2+1;
      ray.setFromCamera(m, camera);
      const hits = ray.intersectObjects(planetsGroup.children, true);
      if(hits.length) {
        let o = hits[0].object; while(o.parent && o.parent!==planetsGroup) o=o.parent;
        const d = o.userData;
        document.getElementById('mTitle').textContent=d.name; document.getElementById('mType').textContent=d.type;
        document.getElementById('mStats').innerHTML=`<div class="stat"><h4>Масса</h4><p>${d.info.mass}</p></div><div class="stat"><h4>t°</h4><p>${d.info.temp}</p></div><div class="stat"><h4>От Солнца</h4><p>${d.info.dist}</p></div>`;
        document.getElementById('mFact').textContent=d.fact;
        document.getElementById('modal').classList.add('visible');
      }
    });
    window.closeModal = () => document.getElementById('modal').classList.remove('visible');
  </script>
</body>
</html>
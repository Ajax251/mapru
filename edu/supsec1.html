<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Security Audit</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #222; color: #eee; }
        .card { background: #333; padding: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #444; }
        h2 { margin-top: 0; color: #ffa500; }
        pre { background: #111; padding: 10px; overflow-x: auto; border: 1px solid #555; color: #0f0; max-height: 300px; }
        button { padding: 10px 20px; background: #0067c0; color: white; border: none; cursor: pointer; font-size: 16px; margin-bottom: 20px; }
        button:hover { background: #005a9e; }
        .status-ok { color: lightgreen; }
        .status-warn { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Supabase Access Check (Anon Key)</h1>
    <p>Этот инструмент проверяет, что видно пользователю без регистрации (Public/Anon).</p>
    
    <button onclick="runAudit()">Запустить проверку</button>

    <div class="card">
        <h2>1. Таблица 'files' (Database)</h2>
        <div id="db-status">Ожидание...</div>
        <pre id="db-result">...</pre>
    </div>

    <div class="card">
        <h2>2. Бакет 'user_files' (Storage)</h2>
        <div id="storage-status">Ожидание...</div>
        <pre id="storage-result">...</pre>
    </div>

    <script>
        // ВСТАВЬТЕ СЮДА ВАШИ КЛЮЧИ
             const SUPABASE_URL = '';
        const SUPABASE_KEY = '';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function runAudit() {
            document.getElementById('db-result').innerText = 'Загрузка...';
            document.getElementById('storage-result').innerText = 'Загрузка...';

            // 1. Проверка базы данных
            // Пытаемся скачать ВСЕ записи без фильтров
            const { data: dbData, error: dbError } = await sb
                .from('files')
                .select('*');

            const dbOutput = document.getElementById('db-result');
            const dbStatus = document.getElementById('db-status');

            if (dbError) {
                dbStatus.innerHTML = `<span class="status-ok">БЕЗОПАСНО:</span> Ошибка доступа (${dbError.message})`;
                dbOutput.innerText = JSON.stringify(dbError, null, 2);
            } else {
                if (dbData.length === 0) {
                    dbStatus.innerHTML = `<span class="status-ok">БЕЗОПАСНО:</span> Данных нет (RLS скрывает их).`;
                } else {
                    dbStatus.innerHTML = `<span class="status-warn">УЯЗВИМОСТЬ:</span> Получено ${dbData.length} записей! RLS выключен или настроен неверно.`;
                }
                dbOutput.innerText = JSON.stringify(dbData, null, 2);
            }

            // 2. Проверка Storage
            // Пытаемся получить список файлов в корне бакета
            const { data: stData, error: stError } = await sb.storage
                .from('user_files')
                .list();

            const stOutput = document.getElementById('storage-result');
            const stStatus = document.getElementById('storage-status');

            if (stError) {
                stStatus.innerHTML = `<span class="status-ok">БЕЗОПАСНО:</span> Ошибка доступа (${stError.message})`;
                stOutput.innerText = JSON.stringify(stError, null, 2);
            } else {
                // Если список пуст, это хорошо (или файлов нет, или папки скрыты)
                // Если мы видим папки чужих пользователей (UUID), это может быть утечкой структуры
                stStatus.innerHTML = `Результат запроса (Найдено объектов: ${stData.length})`;
                stOutput.innerText = JSON.stringify(stData, null, 2);
                
                if (stData.length > 0) {
                     stStatus.innerHTML += " <br><span style='color:orange'>ВНИМАНИЕ:</span> Если вы видите здесь папки/файлы, а вы не авторизованы, проверьте политики Storage.";
                }
            }
        }
    </script>
</body>
</html>
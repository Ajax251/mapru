<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Интерактивная диаграмма</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="img/diag.png" type="image/png">
<style>
:root {
    --bg-color: #f0f9ff;
    --card-bg: #ffffff;
    --text-color: #1e3a5f;
    --light-text: #64748b;
    --border-color: #c8e3f5;
    --accent-color: #4facfe;
    --accent-hover: #00c6fb;
    --accent-light: #e0f4ff;
    --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --button-color: white;
    --input-bg: #f5faff;
    --shadow: 0 8px 32px rgba(79, 172, 254, 0.15);
    --shadow-hover: 0 12px 40px rgba(79, 172, 254, 0.25);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --control-panel-height: 70px;
    --btn-color-type: #4facfe;
    --btn-color-display: #f97316;
    --btn-color-appearance: #22d3ee;
    --btn-color-send: #4facfe;
    --btn-color-wiki: #8b5cf6;
    --option-hover: #e0f4ff;
    --option-selected: #bae6fd;
    --option-selected-border: #4facfe;
    --modal-bg: #ffffff;
    --modal-border: #c8e3f5;
    --modal-shadow: rgba(79, 172, 254, 0.2);
    --success-color: #22c997;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
}

body.dark-theme {
    --bg-color: #0f172a;
    --card-bg: #1e293b;
    --text-color: #e2e8f0;
    --light-text: #94a3b8;
    --border-color: #334155;
    --accent-color: #60a5fa;
    --accent-hover: #38bdf8;
    --accent-light: #1e3a5f;
    --input-bg: #1e293b;
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --option-hover: #334155;
    --option-selected: #1e3a5f;
    --modal-bg: #1e293b;
    --modal-border: #334155;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body, html {
    height: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #e6f2ff 100%);
    color: var(--text-color);
    overflow: hidden;
}

body.dark-theme {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.app-container {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    width: 100vw;
    max-width: 1400px;
    margin: 0 auto;
}

#chartContainer {
    flex: 1;
    background: var(--card-bg);
    margin: 12px;
    margin-bottom: 0;
    padding: 20px;
    border-radius: var(--border-radius);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 15px;
    flex-shrink: 0;
}

.chart-title {
    font-size: 20px;
    font-weight: 600;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
}

.chart-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.chart-action-btn {
    border: none;
    background: var(--accent-light);
    color: var(--accent-color);
    cursor: pointer;
    font-size: 16px;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.chart-action-btn:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
}

.chart-wrapper {
    flex: 1;
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#chart-placeholder {
    text-align: center;
    color: var(--light-text);
    display: none;
    animation: fadeIn 0.5s ease;
}

#chart-placeholder i {
    font-size: 64px;
    margin-bottom: 20px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

#chart-placeholder p {
    font-size: 16px;
    line-height: 1.6;
}

/* Chart Switcher */
.chart-switcher {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px;
    background: var(--accent-light);
    border-radius: 12px;
    margin-bottom: 15px;
}

.chart-switcher.show {
    display: flex;
}

.chart-switcher-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--card-bg);
    color: var(--accent-color);
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-switcher-btn:hover:not(:disabled) {
    background: var(--accent-color);
    color: white;
}

.chart-switcher-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.chart-switcher-info {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    min-width: 100px;
    text-align: center;
}

.chart-switcher-dots {
    display: flex;
    gap: 6px;
}

.chart-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border-color);
    cursor: pointer;
    transition: var(--transition);
}

.chart-dot.active {
    background: var(--accent-color);
    transform: scale(1.2);
}

.chart-dot:hover:not(.active) {
    background: var(--light-text);
}

/* Control Panel */
.control-panel {
    height: var(--control-panel-height);
    flex-shrink: 0;
    background: var(--card-bg);
    margin: 12px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 10px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.control-panel .btn {
    padding: 0;
    width: 46px;
    height: 46px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    color: white;
    font-size: 18px;
    transition: var(--transition);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.control-panel .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.btn.btn-type { background: var(--accent-gradient); }
.btn.btn-display { background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); }
.btn.btn-appearance { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
#sendAiRequestBtn { background: var(--accent-gradient); }
#wikiBtn { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); }

#aiQueryInput {
    flex-grow: 1;
    height: 46px;
    padding: 0 20px;
    border: 2px solid var(--border-color);
    border-radius: 23px;
    font-family: inherit;
    font-size: 15px;
    background: var(--input-bg);
    transition: var(--transition);
    color: var(--text-color);
}

#aiQueryInput:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2);
}

#aiQueryInput:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Popups */
.popup-menu {
    position: absolute;
    bottom: calc(var(--control-panel-height) + 25px);
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    z-index: 1000;
    padding: 20px;
    width: 300px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
    display: none;
    border: 1px solid var(--border-color);
}

.popup-menu.show {
    display: block;
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.popup-menu h4 {
    margin: 0 0 15px 0;
    font-weight: 600;
    font-size: 16px;
    color: var(--text-color);
}

#chartTypePopup { left: 12px; }
#displayOptionsPopup { left: 75px; }
#appearancePopup { left: 138px; }
#dataTablePopup { top: 70px; right: 15px; width: auto; max-width: 90vw; }

.select-wrapper {
    position: relative;
}

.select-wrapper:after {
    content: '\f078';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: var(--accent-color);
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    appearance: none;
    background: var(--card-bg);
    color: var(--text-color);
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
}

select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.switch-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding: 8px 0;
}

.switch {
    position: relative;
    width: 50px;
    height: 26px;
}

.switch input { opacity: 0; width: 0; height: 0; }

.slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--border-color);
    transition: 0.3s;
    border-radius: 26px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

input:checked + .slider {
    background: var(--accent-gradient);
}

input:checked + .slider:before {
    transform: translateX(24px);
}

.range-slider {
    width: 100%;
    -webkit-appearance: none;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    outline: none;
    margin: 10px 0;
}

.range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent-color);
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(79, 172, 254, 0.4);
}

.color-picker {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.color-option {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s;
    border: 3px solid transparent;
}

.color-option.active, .color-option:hover {
    transform: scale(1.15);
    border-color: var(--card-bg);
    box-shadow: 0 0 0 2px var(--accent-color);
}

/* AI Comment */
#aiCommentOverlay {
    position: absolute;
    bottom: 15px;
    left: 15px;
    right: 15px;
    max-width: 500px;
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,249,255,0.95));
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    padding: 0;
    border-radius: var(--border-radius);
    z-index: 5;
    max-height: 40%;
    overflow: hidden;
    box-shadow: var(--shadow);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    cursor: pointer;
    transition: var(--transition);
}

body.dark-theme #aiCommentOverlay {
    background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(15,23,42,0.95));
}

#aiCommentOverlay.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.ai-comment-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    font-weight: 600;
    border-bottom: 1px solid var(--border-color);
}

.ai-comment-header i {
    margin-right: 10px;
    color: var(--accent-color);
}

.ai-comment-body {
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.7;
    max-height: 25dvh;
    overflow-y: auto;
}

#aiCommentToggleBtn {
    position: absolute;
    bottom: 15px;
    left: 15px;
    z-index: 6;
    padding: 10px 18px;
    background: var(--card-bg);
    border-radius: 25px;
    box-shadow: var(--shadow);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid var(--border-color);
    display: none;
    transition: var(--transition);
    color: var(--text-color);
}

#aiCommentToggleBtn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

#aiCommentToggleBtn i {
    margin-right: 8px;
    color: var(--accent-color);
}

/* Loading */
.lds-ring {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
}

.lds-ring div {
    box-sizing: border-box;
    display: block;
    position: absolute;
    width: 64px;
    height: 64px;
    margin: 8px;
    border: 6px solid var(--accent-color);
    border-radius: 50%;
    animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    border-color: var(--accent-color) transparent transparent transparent;
}

.lds-ring div:nth-child(1) { animation-delay: -0.45s; }
.lds-ring div:nth-child(2) { animation-delay: -0.3s; }
.lds-ring div:nth-child(3) { animation-delay: -0.15s; }

@keyframes lds-ring {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

/* Modals */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30, 58, 95, 0.4);
    backdrop-filter: blur(8px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    padding: 20px;
}

.modal-content {
    background: var(--modal-bg);
    padding: 28px;
    border-radius: 20px;
    box-shadow: 0 25px 50px var(--modal-shadow);
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--modal-border);
    overflow: hidden;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.modal-header h2.wiki-title {
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.modal-header h2 i {
    font-size: 22px;
}

.modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-light);
    border: none;
    border-radius: 10px;
    color: var(--light-text);
    cursor: pointer;
    font-size: 16px;
    transition: var(--transition);
}

.modal-close:hover {
    background: var(--error-color);
    color: white;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
}

/* Wiki Modal */
.wiki-search-info {
    text-align: center;
    padding: 20px;
    background: var(--accent-light);
    border-radius: 12px;
    margin-bottom: 16px;
    color: var(--light-text);
    font-size: 14px;
}

.wiki-results-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 350px;
    overflow-y: auto;
}

.wiki-article-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--input-bg);
    border: 2px solid var(--border-color);
    border-radius: 14px;
    cursor: pointer;
    transition: var(--transition);
}

.wiki-article-item:hover {
    border-color: #8b5cf6;
    background: #f5f3ff;
    transform: translateX(4px);
}

body.dark-theme .wiki-article-item:hover {
    background: #2e1065;
}

.wiki-article-item i {
    font-size: 20px;
    color: #8b5cf6;
    flex-shrink: 0;
}

.wiki-article-info {
    flex: 1;
    min-width: 0;
}

.wiki-title {
    font-weight: 600;
    color: var(--text-color);
    font-size: 15px;
    margin-bottom: 4px;
}

.wiki-snippet {
    font-size: 12px;
    color: var(--light-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.wiki-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 40px;
}

.wiki-no-results {
    text-align: center;
    padding: 40px;
    color: var(--light-text);
}

.wiki-no-results i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

/* Wiki Source Badge */
.wiki-source-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    border: 1px solid #c4b5fd;
    border-radius: 20px;
    font-size: 12px;
    color: #7c3aed;
    margin-bottom: 15px;
}

body.dark-theme .wiki-source-badge {
    background: linear-gradient(135deg, #2e1065 0%, #1e1b4b 100%);
    border-color: #7c3aed;
}

.wiki-source-badge i { font-size: 14px; }

.wiki-source-badge a {
    color: #7c3aed;
    text-decoration: none;
    font-weight: 600;
}

.wiki-source-badge a:hover { text-decoration: underline; }

/* Settings Modal */
#settings-modal-overlay .modal-content {
    max-width: 360px;
    gap: 20px;
}

.settings-group {
    margin-bottom: 16px;
}

.settings-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--light-text);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#model-selector-container, #api-mode-selector-container {
    position: relative;
    width: 100%;
}

#model-selector-button, #api-mode-selector-button {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: var(--card-bg);
    cursor: pointer;
    font-size: 14px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
    transition: var(--transition);
}

#model-selector-button:hover, #api-mode-selector-button:hover {
    border-color: var(--accent-color);
}

#model-selector-button::after, #api-mode-selector-button::after {
    content: '';
    width: 8px;
    height: 8px;
    border-right: 2px solid var(--light-text);
    border-bottom: 2px solid var(--light-text);
    transform: rotate(45deg);
}

#model-options, #api-mode-options {
    position: absolute;
    bottom: 100%;
    margin-bottom: 8px;
    right: 0;
    left: 0;
    background: var(--modal-bg);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 8px 0;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
    z-index: 1002;
    border: 1px solid var(--border-color);
    max-height: 300px;
    overflow-y: auto;
}

#model-options.show, #api-mode-options.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.model-option, .api-mode-option {
    padding: 12px 16px;
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.model-option:hover, .api-mode-option:hover {
    background: var(--option-hover);
}

.model-option.selected, .api-mode-option.selected {
    background: var(--option-selected);
    border-left: 3px solid var(--accent-color);
    font-weight: 600;
}

.api-mode-option .icon {
    width: 18px;
    height: 18px;
    fill: var(--accent-color);
}

#change-key-btn {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid var(--border-color);
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 14px;
    color: var(--text-color);
    transition: var(--transition);
}

#change-key-btn:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
}

#change-key-btn.hidden { display: none; }

#close-settings-modal-btn, #save-api-key-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent-gradient);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

#close-settings-modal-btn:hover, #save-api-key-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
}

#settings-btn-mobile {
    display: flex;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: var(--accent-light);
    border: none;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    color: var(--accent-color);
    transition: var(--transition);
}

#settings-btn-mobile:hover {
    background: var(--accent-color);
    color: white;
}

/* API Key Modal */
#api-key-modal-overlay .modal-content {
    text-align: center;
}

#api-key-input {
    width: 100%;
    padding: 14px 16px;
    margin: 16px 0;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: var(--input-bg);
    color: var(--text-color);
    font-family: 'Consolas', monospace;
    font-size: 14px;
}

#api-key-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* Data Table */
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.data-table th, .data-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    font-weight: 600;
    background: var(--accent-light);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--accent-color);
    color: var(--accent-color);
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
}

.btn-outline:hover {
    background: var(--accent-color);
    color: white;
}

/* Notifications */
.notification-bar {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    padding: 14px 24px;
    border-radius: 14px;
    box-shadow: var(--shadow);
    color: white;
    font-size: 14px;
    font-weight: 500;
    z-index: 10000;
    transition: bottom 0.4s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-bar.show { bottom: 25px; }
.notification-bar.success { background: linear-gradient(135deg, #22c997 0%, #10b981 100%); }
.notification-bar.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.notification-bar.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.notification-bar.info { background: var(--accent-gradient); }

/* Theme Toggle */
.theme-toggle svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

:root .theme-toggle svg.sun-icon { display: block; }
:root .theme-toggle svg.moon-icon { display: none; }
body.dark-theme .theme-toggle svg.sun-icon { display: none; }
body.dark-theme .theme-toggle svg.moon-icon { display: block; }

/* Hidden controls */
.header-controls { display: none !important; }

@media (max-width: 768px) {
    .control-panel {
        padding: 0 10px;
        gap: 8px;
        height: 60px;
    }
    .control-panel .btn {
        width: 42px;
        height: 42px;
        font-size: 16px;
    }
    #aiQueryInput {
        height: 42px;
        font-size: 14px;
    }
    .popup-menu {
        width: calc(100vw - 24px);
        left: 12px !important;
    }
    :root { --control-panel-height: 60px; }
    #chartContainer {
        margin: 8px;
        padding: 15px;
    }
    .control-panel { margin: 8px; }
}
</style>
</head>
<body>
<div class="app-container">
    <div id="chartContainer">
        <div class="chart-header">
            <h2 class="chart-title" id="chartTitle">Визуализация данных</h2>
            <div class="chart-actions">
                <button class="chart-action-btn" id="table-view-btn" title="Таблица данных"><i class="fas fa-table"></i></button>
                <button class="chart-action-btn" onclick="toggleFullscreen()" title="Полный экран"><i class="fas fa-expand"></i></button>
                <button class="chart-action-btn" onclick="saveAsPNG()" title="Сохранить как PNG"><i class="fas fa-download"></i></button>
                <button id="settings-btn-mobile" class="chart-action-btn" title="Настройки">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- Chart Switcher -->
        <div class="chart-switcher" id="chartSwitcher">
            <button class="chart-switcher-btn" id="prevChartBtn" title="Предыдущая"><i class="fas fa-chevron-left"></i></button>
            <div class="chart-switcher-info">
                <span id="chartIndexInfo">1 / 1</span>
            </div>
            <div class="chart-switcher-dots" id="chartDots"></div>
            <button class="chart-switcher-btn" id="nextChartBtn" title="Следующая"><i class="fas fa-chevron-right"></i></button>
        </div>
        
        <div class="chart-wrapper">
            <canvas id="myChart"></canvas>
            <div id="chart-placeholder">
                <i class="fas fa-chart-pie"></i>
                <p>Введите запрос или выберите статью Wikipedia<br>для создания диаграммы</p>
            </div>
            <div id="aiCommentOverlay">
                <div class="ai-comment-header"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Анализ ИИ</span></div>
                <div class="ai-comment-body"><p id="aiCommentText"></p></div>
            </div>
            <button id="aiCommentToggleBtn"><i class="fas fa-comment-dots"></i> Показать анализ</button>
        </div>
    </div>
    
    <div class="control-panel">
        <button class="btn btn-type" id="chart-type-btn" title="Тип диаграммы"><i class="fas fa-chart-pie"></i></button>
        <button class="btn btn-display" id="display-options-btn" title="Отображение"><i class="fas fa-sliders-h"></i></button>
        <button class="btn btn-appearance" id="appearance-btn" title="Внешний вид"><i class="fas fa-palette"></i></button>
        <textarea id="aiQueryInput" placeholder="Опишите диаграмму или введите тему для Wikipedia..." rows="1"></textarea>
        <button class="btn" id="sendAiRequestBtn" title="Отправить запрос"><i class="fas fa-paper-plane"></i></button>
        <button class="btn" id="wikiBtn" title="Поиск в Wikipedia"><i class="fab fa-wikipedia-w"></i></button>
    </div>
</div>

<!-- Popups -->
<div id="chartTypePopup" class="popup-menu">
    <h4>Тип диаграммы</h4>
    <div class="select-wrapper">
        <select id="chartType">
            <optgroup label="Основные">
                <option value="pie">Круговая</option>
                <option value="bar">Столбчатая</option>
                <option value="line">Линейная</option>
                <option value="doughnut">Кольцевая</option>
            </optgroup>
            <optgroup label="Дополнительные">
                <option value="polarArea">Полярная</option>
                <option value="radar">Радарная</option>
                <option value="horizontalBar">Горизонтальная</option>
            </optgroup>
        </select>
    </div>
</div>

<div id="displayOptionsPopup" class="popup-menu">
    <h4>Отображение</h4>
    <div class="switch-container"><span>Подписи</span><label class="switch"><input type="checkbox" id="showDataSwitch"><span class="slider"></span></label></div>
    <div class="switch-container"><span>Проценты</span><label class="switch"><input type="checkbox" id="showPercentSwitch"><span class="slider"></span></label></div>
    <div class="switch-container"><span>Значения</span><label class="switch"><input type="checkbox" id="showValuesSwitch"><span class="slider"></span></label></div>
    <div class="switch-container"><span>Легенда</span><label class="switch"><input type="checkbox" id="showLegendSwitch"><span class="slider"></span></label></div>
</div>

<div id="appearancePopup" class="popup-menu">
    <h4>Внешний вид</h4>
    <div class="slider-control">
        <label>Толщина границ: <span id="borderWidthValue">1</span>px</label>
        <input type="range" id="borderWidth" class="range-slider" min="0" max="5" step="0.5" value="1">
    </div>
    <div class="slider-control">
        <label>Размер шрифта: <span id="fontSizeValue">12</span>px</label>
        <input type="range" id="fontSize" class="range-slider" min="8" max="20" step="1" value="12">
    </div>
    <div class="option-title" style="margin-top: 15px; font-weight: 500; color: var(--light-text);">Цветовая схема:</div>
    <div class="color-picker">
        <div class="color-option active" style="background:#4e79a7" data-scheme="default"></div>
        <div class="color-option" style="background:#ff6b6b" data-scheme="warm"></div>
        <div class="color-option" style="background:#48bfe3" data-scheme="cool"></div>
        <div class="color-option" style="background:#06d6a0" data-scheme="pastel"></div>
        <div class="color-option" style="background:#118ab2" data-scheme="monochrome"></div>
    </div>
</div>

<div id="dataTablePopup" class="popup-menu">
    <h4>Таблица данных</h4>
    <div id="dataTableContainer" style="max-height: 40dvh; overflow-y: auto;"><div id="dataTable"></div></div>
    <button class="btn-outline" style="margin-top: 15px; width:100%;" onclick="addTableRow()"><i class="fas fa-plus"></i> Добавить строку</button>
</div>

<!-- Wiki Modal -->
<div id="wiki-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="wiki-title"><i class="fab fa-wikipedia-w"></i> Wikipedia</h2>
            <button class="modal-close" id="close-wiki-modal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="wiki-modal-body">
            <div class="wiki-search-info">Введите тему в поле ввода и нажмите кнопку Wikipedia</div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-cog"></i> Настройки</h2>
            <button class="modal-close" id="close-settings-x"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="settings-group">
                <label>Модель ИИ</label>
                <div id="model-selector-container">
                    <button id="model-selector-button">Выберите модель</button>
                    <ul id="model-options"></ul>
                </div>
            </div>
            <div class="settings-group">
                <label>Режим подключения</label>
                <div id="api-mode-selector-container">
                    <button id="api-mode-selector-button"></button>
                    <ul id="api-mode-options"></ul>
                </div>
            </div>
            <div class="settings-group">
                <button id="change-key-btn" class="hidden">
                    <i class="fas fa-key"></i> Изменить API ключ
                </button>
            </div>
            <div class="settings-group">
                <div class="switch-container">
                    <span>Тёмная тема</span>
                    <label class="switch">
                        <input type="checkbox" id="darkThemeSwitch">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <button id="close-settings-modal-btn">Закрыть</button>
    </div>
</div>

<!-- API Key Modal -->
<div class="modal-overlay" id="api-key-modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> API ключ</h2>
            <button class="modal-close" id="close-api-key-modal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p style="color: var(--light-text); margin-bottom: 10px;">Введите API ключ Google Gemini для прямого режима</p>
            <p><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent-color);">Получить ключ в Google AI Studio</a></p>
            <input type="password" id="api-key-input" placeholder="Введите ваш API ключ...">
        </div>
        <button id="save-api-key-btn">Сохранить</button>
    </div>
</div>

<div id="notification-placeholder"></div>

<script>
Chart.register(ChartDataLabels);

// --- Configuration ---
const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
const WIKI_API_URL = "https://ru.wikipedia.org/w/api.php";

const MODELS = [
    { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
    { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini", tier: 'standard' },
    { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini", tier: 'standard' },
    { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini", tier: 'standard' },
];

const API_MODES = {
    'mapruapp': {
        uiName: 'Прокси (MapRuApp)',
        url: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`,
        icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>'
    },
    'vercel': {
        uiName: 'Прокси (Vercel)',
        url: (modelId) => `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`,
        icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M24 22.525H0l12-21.05 12 21.05z"/></svg>'
    },
    'direct': {
        uiName: 'Прямой (Gemini)',
        url: (modelId, key) => `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`,
        icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>'
    }
};

const colorSchemes = {
    default: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'],
    warm: ['#ff6b6b', '#f9844a', '#fee440', '#f9c74f', '#90be6d', '#43aa8b', '#577590', '#277da1', '#f94144', '#f3722c'],
    cool: ['#48bfe3', '#56cfe1', '#64dfdf', '#72efdd', '#80ffdb', '#a5a58d', '#b7b7a4', '#6b705c', '#023e8a', '#0077b6'],
    pastel: ['#ffd6ff', '#e7c6ff', '#c8b6ff', '#b8c0ff', '#bbd0ff', '#06d6a0', '#1b9aaa', '#ef476f', '#ffc43d', '#f15bb5'],
    monochrome: ['#118ab2', '#0096c7', '#00b4d8', '#48cae4', '#90e0ef', '#ade8f4', '#caf0f8', '#03045e', '#023e8a', '#0077b6']
};

// --- State ---
let chartData = { labels: [], values: [] };
let allCharts = []; // Array to store multiple charts
let currentChartIndex = 0;
let currentColorScheme = 'default';
let currentAiRequestController = null;
let apiKey = localStorage.getItem('gemini_api_key_chart') || '';
let currentApiMode = localStorage.getItem('chart_api_mode') || 'mapruapp';
let currentSelectedModelId = localStorage.getItem('selectedModelId_chart') || 'gemini-3-flash-preview';
let lastWikiTitle = null;

// --- DOM Elements ---
const $ = id => document.getElementById(id);
const chartCanvas = $('myChart');
const placeholder = $('chart-placeholder');
const chartSwitcher = $('chartSwitcher');
const chartDots = $('chartDots');

// --- Initialization ---
window.onload = () => {
    setupEventListeners();
    loadSettings();
    populateModelOptions();
    populateApiModeOptions();
    updateUI();
    drawChart();
};

function setupEventListeners() {
    $('sendAiRequestBtn').addEventListener('click', handleAiRequest);
    $('wikiBtn').addEventListener('click', handleWikiSearch);
    $('aiQueryInput').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAiRequest(); }
    });

    // Popups
    const popups = {
        'chart-type-btn': 'chartTypePopup',
        'display-options-btn': 'displayOptionsPopup',
        'appearance-btn': 'appearancePopup',
        'table-view-btn': 'dataTablePopup'
    };
    Object.entries(popups).forEach(([btn, popup]) => {
        $(btn).addEventListener('click', e => { e.stopPropagation(); togglePopup(popup); });
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('.popup-menu')) closeAllPopups();
        if (!e.target.closest('#model-options') && !e.target.closest('#model-selector-button')) $('model-options').classList.remove('show');
        if (!e.target.closest('#api-mode-options') && !e.target.closest('#api-mode-selector-button')) $('api-mode-options').classList.remove('show');
    });

    // Chart controls
    $('chartType').addEventListener('change', () => { saveAndRedraw('chartType', $('chartType').value); });
    ['showDataSwitch', 'showPercentSwitch', 'showValuesSwitch', 'showLegendSwitch'].forEach(id => {
        $(id).addEventListener('change', e => saveAndRedraw(id, e.target.checked));
    });
    $('borderWidth').addEventListener('input', e => { $('borderWidthValue').textContent = e.target.value; drawChart(); });
    $('fontSize').addEventListener('input', e => { $('fontSizeValue').textContent = e.target.value; drawChart(); });
    document.querySelectorAll('.color-option').forEach(el => {
        el.addEventListener('click', () => setColorScheme(el, el.dataset.scheme));
    });

    // Chart switcher
    $('prevChartBtn').addEventListener('click', () => switchChart(-1));
    $('nextChartBtn').addEventListener('click', () => switchChart(1));

    // AI Comment
    $('aiCommentOverlay').addEventListener('click', toggleAiComment);
    $('aiCommentToggleBtn').addEventListener('click', toggleAiComment);

    // Modals
    $('settings-btn-mobile').addEventListener('click', () => $('settings-modal-overlay').style.display = 'flex');
    $('close-settings-modal-btn').addEventListener('click', () => $('settings-modal-overlay').style.display = 'none');
    $('close-settings-x').addEventListener('click', () => $('settings-modal-overlay').style.display = 'none');
    $('settings-modal-overlay').addEventListener('click', e => { if (e.target === $('settings-modal-overlay')) $('settings-modal-overlay').style.display = 'none'; });

    $('close-wiki-modal').addEventListener('click', () => $('wiki-modal').style.display = 'none');
    $('wiki-modal').addEventListener('click', e => { if (e.target === $('wiki-modal')) $('wiki-modal').style.display = 'none'; });

    $('change-key-btn').addEventListener('click', () => { $('settings-modal-overlay').style.display = 'none'; $('api-key-modal-overlay').style.display = 'flex'; });
    $('save-api-key-btn').addEventListener('click', saveApiKey);
    $('close-api-key-modal').addEventListener('click', () => $('api-key-modal-overlay').style.display = 'none');
    $('api-key-modal-overlay').addEventListener('click', e => { if (e.target === $('api-key-modal-overlay')) $('api-key-modal-overlay').style.display = 'none'; });

    $('model-selector-button').addEventListener('click', e => { e.stopPropagation(); $('model-options').classList.toggle('show'); });
    $('api-mode-selector-button').addEventListener('click', e => { e.stopPropagation(); $('api-mode-options').classList.toggle('show'); });

    // Theme
    $('darkThemeSwitch').addEventListener('change', e => {
        document.body.classList.toggle('dark-theme', e.target.checked);
        localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
        drawChart();
    });

    // Escape key
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            if (currentAiRequestController) currentAiRequestController.abort();
            closeAllPopups();
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }
    });
}

function loadSettings() {
    const savedType = localStorage.getItem('chartType');
    if (savedType) $('chartType').value = savedType;

    ['showDataSwitch', 'showPercentSwitch', 'showValuesSwitch', 'showLegendSwitch'].forEach(id => {
        const saved = localStorage.getItem(id);
        const defaults = ['showDataSwitch', 'showPercentSwitch', 'showLegendSwitch'];
        $(id).checked = saved === null ? defaults.includes(id) : saved === 'true';
    });

    const theme = localStorage.getItem('theme');
    const isDark = theme ? theme === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.body.classList.toggle('dark-theme', isDark);
    $('darkThemeSwitch').checked = isDark;

    $('api-key-input').value = apiKey;
}

function updateUI() {
    updateModelSelectorUI();
    updateApiModeUI();
}

// --- Model & API Mode ---
function populateModelOptions() {
    const list = $('model-options');
    list.innerHTML = '';
    MODELS.forEach(model => {
        const li = document.createElement('li');
        li.className = 'model-option' + (model.id === currentSelectedModelId ? ' selected' : '');
        li.dataset.modelId = model.id;
        li.textContent = model.uiName;
        li.addEventListener('click', () => {
            currentSelectedModelId = model.id;
            localStorage.setItem('selectedModelId_chart', model.id);
            updateModelSelectorUI();
            $('model-options').classList.remove('show');
        });
        list.appendChild(li);
    });
}

function populateApiModeOptions() {
    const list = $('api-mode-options');
    list.innerHTML = '';
    Object.entries(API_MODES).forEach(([id, mode]) => {
        const li = document.createElement('li');
        li.className = 'api-mode-option' + (id === currentApiMode ? ' selected' : '');
        li.dataset.apiMode = id;
        li.innerHTML = `${mode.icon} <span>${mode.uiName}</span>`;
        li.addEventListener('click', () => {
            currentApiMode = id;
            localStorage.setItem('chart_api_mode', id);
            updateApiModeUI();
            $('api-mode-options').classList.remove('show');
            if (id === 'direct' && !apiKey) $('api-key-modal-overlay').style.display = 'flex';
        });
        list.appendChild(li);
    });
}

function updateModelSelectorUI() {
    const model = MODELS.find(m => m.id === currentSelectedModelId) || MODELS[0];
    $('model-selector-button').textContent = model.uiName;
    document.querySelectorAll('.model-option').forEach(o => o.classList.toggle('selected', o.dataset.modelId === currentSelectedModelId));
}

function updateApiModeUI() {
    const mode = API_MODES[currentApiMode];
    $('api-mode-selector-button').innerHTML = `${mode.icon}<span>${mode.uiName}</span>`;
    $('change-key-btn').classList.toggle('hidden', currentApiMode !== 'direct');
    document.querySelectorAll('.api-mode-option').forEach(o => o.classList.toggle('selected', o.dataset.apiMode === currentApiMode));
}

function saveApiKey() {
    const key = $('api-key-input').value.trim();
    if (key) {
        apiKey = key;
        localStorage.setItem('gemini_api_key_chart', key);
        showNotification('API ключ сохранён', 'success');
        $('api-key-modal-overlay').style.display = 'none';
    } else {
        showNotification('Введите ключ', 'error');
    }
}

// --- Wikipedia ---
async function searchWikipedia(query) {
    const url = `${WIKI_API_URL}?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=10`;
    const response = await fetch(url);
    if (!response.ok) throw new Error('Ошибка поиска');
    const data = await response.json();
    return data.query.search.map(item => ({
        title: item.title,
        snippet: item.snippet.replace(/<[^>]*>/g, '')
    }));
}

async function getWikipediaContent(title) {
    const url = `${WIKI_API_URL}?action=query&prop=extracts&explaintext=1&titles=${encodeURIComponent(title)}&format=json&origin=*`;
    const response = await fetch(url);
    if (!response.ok) throw new Error('Ошибка загрузки статьи');
    const data = await response.json();
    const pages = data.query.pages;
    const pageId = Object.keys(pages)[0];
    if (pageId === '-1') throw new Error('Статья не найдена');
    return pages[pageId].extract;
}

function cleanWikiText(text) {
    const stops = ['Примечания', 'Литература', 'Ссылки', 'См. также', 'Источники'];
    let cut = text.length;
    stops.forEach(s => {
        const match = text.match(new RegExp(`\\n\\s*==+\\s*${s}\\s*==+`, 'i'));
        if (match && match.index < cut) cut = match.index;
    });
    return text.substring(0, cut).trim();
}

async function handleWikiSearch() {
    const query = $('aiQueryInput').value.trim();
    if (!query) { showNotification('Введите тему для поиска', 'warning'); return; }

    $('wikiBtn').disabled = true;
    $('wiki-modal').style.display = 'flex';
    $('wiki-modal-body').innerHTML = `<div class="wiki-loading"><div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>Поиск статей...</p></div>`;

    try {
        const results = await searchWikipedia(query);
        if (results.length === 0) {
            $('wiki-modal-body').innerHTML = `<div class="wiki-no-results"><i class="fas fa-search"></i><p>Статьи не найдены</p></div>`;
        } else {
            $('wiki-modal-body').innerHTML = `
                <div class="wiki-search-info">Найдено: ${results.length}. Выберите статью:</div>
                <div class="wiki-results-list" id="wiki-results"></div>`;
            results.forEach(r => {
                const item = document.createElement('div');
                item.className = 'wiki-article-item';
                item.innerHTML = `<i class="fas fa-file-alt"></i><div class="wiki-article-info"><div class="wiki-title">${r.title}</div><div class="wiki-snippet">${r.snippet}</div></div>`;
                item.onclick = () => selectWikiArticle(r.title);
                $('wiki-results').appendChild(item);
            });
        }
    } catch (error) {
        $('wiki-modal-body').innerHTML = `<div class="wiki-no-results"><i class="fas fa-exclamation-triangle"></i><p>${error.message}</p></div>`;
    } finally {
        $('wikiBtn').disabled = false;
    }
}

async function selectWikiArticle(title) {
    $('wiki-modal').style.display = 'none';
    lastWikiTitle = title;

    setLoading(true, `Загружаю статью "${title}"...`);

    try {
        const rawText = await getWikipediaContent(title);
        const cleanedText = cleanWikiText(rawText).substring(0, 40000);

        setLoading(true, 'Анализирую и создаю диаграммы...');

        const prompt = `Проанализируй статью из Wikipedia "${title}" и создай от 1 до 5 информативных диаграмм на основе данных из статьи.

Текст статьи:
${cleanedText}

Верни JSON с массивом диаграмм:
{
  "charts": [
    {
      "title": "Название диаграммы",
      "chartType": "pie|bar|line|doughnut|polarArea|radar|horizontalBar",
      "data": [{"label": "Название", "value": число}, ...],
      "comment": "Краткий комментарий к диаграмме"
    }
  ],
  "summary": "Общий анализ статьи (2-3 предложения)"
}`;

        const response = await sendAiRequest(prompt);
        processMultiChartResponse(response, title);

    } catch (error) {
        showNotification(`Ошибка: ${error.message}`, 'error');
        setLoading(false);
    }
}

// --- AI Request ---
async function handleAiRequest() {
    const query = $('aiQueryInput').value.trim();
    if (!query) { showNotification('Введите запрос', 'warning'); return; }

    if (currentApiMode === 'direct' && !apiKey) {
        $('api-key-modal-overlay').style.display = 'flex';
        return;
    }

    setLoading(true, 'Создаю диаграмму...');
    lastWikiTitle = null;

    const prompt = `Создай данные для диаграммы по запросу: "${query}"

Верни JSON:
{
  "charts": [
    {
      "title": "Название",
      "chartType": "pie|bar|line|doughnut|polarArea|radar|horizontalBar",
      "data": [{"label": "Категория", "value": число}, ...],
      "comment": "Комментарий к данным"
    }
  ],
  "summary": "Краткое описание"
}`;

    try {
        const response = await sendAiRequest(prompt);
        processMultiChartResponse(response);
    } catch (error) {
        if (error.name !== 'AbortError') {
            showNotification(`Ошибка: ${error.message}`, 'error');
        }
        setLoading(false);
    }
}

async function sendAiRequest(prompt) {
    currentAiRequestController = new AbortController();
    
    let apiUrl, requestBody;
    const model = MODELS.find(m => m.id === currentSelectedModelId) || MODELS[0];

    if (currentApiMode === 'mapruapp') {
        apiUrl = API_MODES.mapruapp.url();
        requestBody = {
            model: model.id,
            messages: [
                { role: 'system', content: 'Ты генератор данных для диаграмм. Всегда возвращай только валидный JSON.' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 8192
        };
    } else {
        apiUrl = currentApiMode === 'direct' 
            ? API_MODES.direct.url(model.id, apiKey)
            : API_MODES.vercel.url(model.id);
        requestBody = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: 'Ты генератор данных для диаграмм. Всегда возвращай только валидный JSON.' }] }
        };
    }

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody),
        signal: currentAiRequestController.signal
    });

    if (!response.ok) {
        const error = await response.text();
        throw new Error(error.substring(0, 200));
    }

    const data = await response.json();
    let text;
    
    if (currentApiMode === 'mapruapp') {
        text = data.choices?.[0]?.message?.content;
    } else {
        text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    }

    if (!text) throw new Error('Пустой ответ от ИИ');
    
    return JSON.parse(text.replace(/^```json\s*|\s*```$/g, ''));
}

function processMultiChartResponse(response, wikiTitle = null) {
    allCharts = response.charts || [];
    
    if (allCharts.length === 0) {
        showNotification('ИИ не смог создать диаграммы', 'warning');
        setLoading(false);
        return;
    }

    currentChartIndex = 0;
    
    // Update switcher
    updateChartSwitcher();
    
    // Display first chart
    displayChart(0, wikiTitle);
    
    // Show summary
    displayAiComment(response.summary || allCharts[0].comment);
    
    setLoading(false);
}

function updateChartSwitcher() {
    if (allCharts.length > 1) {
        chartSwitcher.classList.add('show');
        
        // Update dots
        chartDots.innerHTML = '';
        allCharts.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = 'chart-dot' + (i === currentChartIndex ? ' active' : '');
            dot.onclick = () => { currentChartIndex = i; displayChart(i); updateChartSwitcher(); };
            chartDots.appendChild(dot);
        });
        
        // Update info
        $('chartIndexInfo').textContent = `${currentChartIndex + 1} / ${allCharts.length}`;
        
        // Update buttons
        $('prevChartBtn').disabled = currentChartIndex === 0;
        $('nextChartBtn').disabled = currentChartIndex === allCharts.length - 1;
    } else {
        chartSwitcher.classList.remove('show');
    }
}

function switchChart(direction) {
    const newIndex = currentChartIndex + direction;
    if (newIndex >= 0 && newIndex < allCharts.length) {
        currentChartIndex = newIndex;
        displayChart(newIndex);
        updateChartSwitcher();
    }
}

function displayChart(index, wikiTitle = null) {
    const chart = allCharts[index];
    if (!chart) return;

    // Update chart type selector
    const validTypes = ['pie', 'bar', 'line', 'doughnut', 'polarArea', 'radar', 'horizontalBar'];
    if (validTypes.includes(chart.chartType)) {
        $('chartType').value = chart.chartType;
    }

    // Update data
    chartData.labels = chart.data.map(d => String(d.label || ''));
    chartData.values = chart.data.map(d => Number(d.value || 0));

    // Update title
    let titleHtml = chart.title || 'Диаграмма';
    $('chartTitle').innerHTML = titleHtml;

    // Add wiki badge if needed
    if (wikiTitle && index === 0) {
        const badge = document.createElement('div');
        badge.className = 'wiki-source-badge';
        badge.innerHTML = `<i class="fab fa-wikipedia-w"></i> <a href="https://ru.wikipedia.org/wiki/${encodeURIComponent(wikiTitle)}" target="_blank">${wikiTitle}</a>`;
        
        const existing = document.querySelector('.wiki-source-badge');
        if (existing) existing.remove();
        
        $('chartContainer').querySelector('.chart-header').after(badge);
    }

    // Update comment
    if (chart.comment) {
        displayAiComment(chart.comment);
    }

    drawChart();
}

// --- Chart Drawing ---
function drawChart() {
    if (window.myChart instanceof Chart) {
        window.myChart.destroy();
        window.myChart = null;
    }

    if (chartData.values.length === 0) {
        placeholder.style.display = 'block';
        chartCanvas.style.display = 'none';
        return;
    }

    placeholder.style.display = 'none';
    chartCanvas.style.display = 'block';

    const chartType = $('chartType').value;
    const isDark = document.body.classList.contains('dark-theme');
    const fontSize = parseFloat($('fontSize').value);
    const total = chartData.values.reduce((a, b) => a + b, 0);

    window.myChart = new Chart(chartCanvas.getContext('2d'), {
        type: chartType === 'horizontalBar' ? 'bar' : chartType,
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.values,
                backgroundColor: colorSchemes[currentColorScheme].map(c => chartType === 'line' ? c + '30' : c),
                borderColor: chartType === 'line' ? colorSchemes[currentColorScheme][0] : (isDark ? '#1e293b' : 'white'),
                borderWidth: parseFloat($('borderWidth').value),
                tension: 0.4,
                fill: chartType === 'line'
            }]
        },
        options: {
            indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 600 },
            scales: ['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType) ? {} : {
                y: { beginAtZero: true, ticks: { font: { size: fontSize }, color: isDark ? '#e2e8f0' : '#333' }, grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } },
                x: { ticks: { font: { size: fontSize }, color: isDark ? '#e2e8f0' : '#333' }, grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } }
            },
            plugins: {
                legend: { display: $('showLegendSwitch').checked, position: 'bottom', labels: { usePointStyle: true, font: { size: fontSize }, color: isDark ? '#e2e8f0' : '#333' } },
                datalabels: {
                    display: $('showDataSwitch').checked || $('showPercentSwitch').checked || $('showValuesSwitch').checked,
                    color: isDark ? '#fff' : '#000',
                    font: { weight: 'bold', size: fontSize },
                    formatter: (value, ctx) => {
                        const parts = [];
                        if ($('showDataSwitch').checked) parts.push(ctx.chart.data.labels[ctx.dataIndex]);
                        if ($('showPercentSwitch').checked) parts.push(total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%');
                        if ($('showValuesSwitch').checked) parts.push(value.toLocaleString());
                        return parts.join('\n');
                    },
                    anchor: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'end',
                    align: ['pie', 'doughnut'].includes(chartType) ? 'center' : 'start',
                    textStrokeColor: isDark ? '#1e293b' : '#fff',
                    textStrokeWidth: 4
                }
            }
        }
    });
}

// --- Utilities ---
function setLoading(loading, text = '') {
    const input = $('aiQueryInput');
    const sendBtn = $('sendAiRequestBtn');
    const wikiBtn = $('wikiBtn');

    input.disabled = loading;
    sendBtn.disabled = loading;
    wikiBtn.disabled = loading;

    if (loading) {
        placeholder.innerHTML = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>${text}</p>`;
        placeholder.style.display = 'block';
        chartCanvas.style.display = 'none';
        chartSwitcher.classList.remove('show');
    }
}

function displayAiComment(comment) {
    const overlay = $('aiCommentOverlay');
    const btn = $('aiCommentToggleBtn');
    const text = $('aiCommentText');

    if (comment && comment.trim()) {
        text.innerHTML = comment.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        overlay.classList.add('show');
        btn.style.display = 'none';
        gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.4 });
    } else {
        overlay.classList.remove('show');
        btn.style.display = 'none';
    }
}

function toggleAiComment() {
    const overlay = $('aiCommentOverlay');
    const btn = $('aiCommentToggleBtn');

    if (overlay.classList.contains('show')) {
        gsap.to(overlay, { opacity: 0, y: 20, duration: 0.3, onComplete: () => {
            overlay.classList.remove('show');
            btn.style.display = 'flex';
            gsap.fromTo(btn, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3 });
        }});
    } else {
        gsap.to(btn, { opacity: 0, y: 10, duration: 0.3, onComplete: () => {
            btn.style.display = 'none';
            overlay.classList.add('show');
            gsap.fromTo(overlay, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 });
        }});
    }
}

function togglePopup(id) {
    const popup = $(id);
    const isOpen = popup.classList.contains('show');
    closeAllPopups();
    if (!isOpen) {
        if (id === 'dataTablePopup') renderDataTable();
        popup.classList.add('show');
    }
}

function closeAllPopups() {
    document.querySelectorAll('.popup-menu.show').forEach(p => p.classList.remove('show'));
}

function saveAndRedraw(key, value) {
    localStorage.setItem(key, value);
    drawChart();
}

function setColorScheme(el, scheme) {
    currentColorScheme = scheme;
    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    drawChart();
}

function saveAsPNG() {
    const canvas = chartCanvas;
    const temp = document.createElement('canvas');
    temp.width = canvas.offsetWidth;
    temp.height = canvas.offsetHeight;
    const ctx = temp.getContext('2d');
    ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#1e293b' : '#ffffff';
    ctx.fillRect(0, 0, temp.width, temp.height);
    if (chartData.values.length > 0) ctx.drawImage(canvas, 0, 0);
    const link = document.createElement('a');
    link.download = `chart_${Date.now()}.png`;
    link.href = temp.toDataURL('image/png');
    link.click();
    showNotification('Диаграмма сохранена', 'success');
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        $('chartContainer').requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function renderDataTable() {
    const div = $('dataTable');
    if (chartData.labels.length === 0) {
        div.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--light-text);">Нет данных</p>';
        return;
    }
    let html = `<table class="data-table"><thead><tr><th>#</th><th>Категория</th><th>Значение</th><th></th></tr></thead><tbody>`;
    chartData.labels.forEach((label, i) => {
        html += `<tr><td>${i + 1}</td><td contenteditable="true" onblur="updateTableData(${i}, 'label', this.innerText)">${label}</td><td contenteditable="true" onblur="updateTableData(${i}, 'value', this.innerText)">${chartData.values[i]}</td><td><button class="chart-action-btn" style="width:30px;height:30px;color:var(--error-color);" onclick="removeTableRow(${i})"><i class="fas fa-times"></i></button></td></tr>`;
    });
    html += '</tbody></table>';
    div.innerHTML = html;
}

function addTableRow() {
    chartData.labels.push('Новая категория');
    chartData.values.push(0);
    renderDataTable();
    drawChart();
}

function removeTableRow(index) {
    chartData.labels.splice(index, 1);
    chartData.values.splice(index, 1);
    renderDataTable();
    drawChart();
}

function updateTableData(index, type, value) {
    if (type === 'label') chartData.labels[index] = value;
    else {
        const num = parseFloat(value.replace(',', '.'));
        if (!isNaN(num)) chartData.values[index] = num;
    }
    drawChart();
}

function showNotification(message, type = 'info', duration = 3000) {
    const n = document.createElement('div');
    n.className = `notification-bar ${type}`;
    const icons = { error: 'times-circle', warning: 'exclamation-triangle', info: 'info-circle', success: 'check-circle' };
    n.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${message}`;
    $('notification-placeholder').appendChild(n);
    setTimeout(() => n.classList.add('show'), 10);
    setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 400); }, duration);
}

window.addEventListener('resize', () => { if (window.myChart) window.myChart.resize(); });
</script>
</body>
</html>
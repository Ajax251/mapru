<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–∞—Ä—Ç—ã –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    
    <!-- –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplify-js/1.2.4/simplify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
        }
        
        #map { width: 100%; height: 100%; }
        
        /* ===== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== */
        .control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            max-width: calc(100% - 30px);
        }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ */
        .mode-switch {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #dee2e6;
        }
        
        .mode-switch input { display: none; }
        
        .mode-switch label {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #495057;
        }
        
        .mode-switch input:checked + label {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        
        .mode-switch label:hover:not(:has(+ input:checked)) {
            background: #dee2e6;
        }
        
        /* –°—á—ë—Ç—á–∏–∫ —Ä–∞–π–æ–Ω–æ–≤ */
        .counter {
            background: linear-gradient(135deg, #28a745 0%, #20883a 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .counter i { font-size: 12px; }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .settings-group label {
            font-size: 13px;
            color: #495057;
            white-space: nowrap;
        }
        
        .settings-group input[type="number"] {
            width: 70px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }
        
        .settings-group input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        
        .btn-icon {
            width: 38px;
            height: 38px;
            padding: 0;
            justify-content: center;
        }
        
        /* ===== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ ===== */
        #context-menu {
            position: absolute;
            display: none;
            z-index: 2000;
            background: white;
            min-width: 280px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px 0;
            overflow: hidden;
        }
        
        #context-menu ul { list-style: none; }
        
        #context-menu li {
            padding: 12px 18px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
            color: #333;
        }
        
        #context-menu li:hover { background: #f8f9fa; }
        #context-menu li.disabled { color: #adb5bd; cursor: not-allowed; }
        #context-menu li.disabled:hover { background: transparent; }
        
        #context-menu .separator {
            height: 1px;
            background: #e9ecef;
            margin: 6px 0;
            padding: 0;
            cursor: default;
        }
        
        #context-menu i { width: 20px; text-align: center; font-size: 15px; }
        
        .menu-icon-add { color: #28a745; }
        .menu-icon-delete { color: #dc3545; }
        .menu-icon-export { color: #6f42c1; }
        .menu-icon-file { color: #17a2b8; }
        .menu-icon-html { color: #fd7e14; }
        
        /* –ü–æ–¥–º–µ–Ω—é */
        .submenu { position: relative; }
        
        .submenu::after {
            content: '\f054';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 10px;
            margin-left: auto;
            color: #adb5bd;
        }
        
        .submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            min-width: 240px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px 0;
            margin-left: 4px;
        }
        
        .submenu:hover > .submenu-content { display: block; }
        
        /* ===== –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            max-width: 350px;
            display: none;
        }
        
        .info-panel h3 {
            font-size: 16px;
            color: #212529;
            margin-bottom: 5px;
        }
        
        .info-panel p {
            font-size: 13px;
            color: #6c757d;
        }
        
        /* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
        #notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .notification.error { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .notification.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .notification.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        
        /* ===== –ó–ê–ì–†–£–ó–ß–ò–ö ===== */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loader-content {
            text-align: center;
            color: white;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loader-text {
            font-size: 16px;
            font-weight: 500;
        }
        
        /* ===== –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´ ===== */
        .hidden { display: none !important; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="control-panel">
    <div class="mode-switch">
        <input type="radio" name="mode" id="mode-build" checked>
        <label for="mode-build"><i class="fas fa-hammer"></i> –°–±–æ—Ä–∫–∞</label>
        <input type="radio" name="mode" id="mode-view">
        <label for="mode-view"><i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä</label>
    </div>
    
    <div class="counter" id="counter">
        <i class="fas fa-map"></i>
        <span id="counter-text">0 —Ä–∞–π–æ–Ω–æ–≤</span>
    </div>
    
    <div class="settings-group">
        <label for="tolerance">–£–ø—Ä–æ—â–µ–Ω–∏–µ (–º):</label>
        <input type="number" id="tolerance" value="100" min="10" max="1000" step="10">
    </div>
    
    <button class="btn btn-success" id="btn-load-project">
        <i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
    </button>
    <input type="file" id="file-input" accept=".json">
    
    <button class="btn btn-danger btn-icon" id="btn-clear" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">
        <i class="fas fa-trash-alt"></i>
    </button>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) -->
<div class="info-panel" id="info-panel">
    <h3 id="info-name">‚Äî</h3>
    <p id="info-details">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ä–∞–π–æ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="context-menu">
    <ul>
        <li id="ctx-add">
            <i class="fas fa-plus-circle menu-icon-add"></i>
            –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞
        </li>
        <li id="ctx-delete" class="disabled">
            <i class="fas fa-trash-alt menu-icon-delete"></i>
            –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–π–æ–Ω
        </li>
        <li class="separator"></li>
        <li class="submenu">
            <i class="fas fa-download menu-icon-export"></i>
            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            <ul class="submenu-content">
                <li id="ctx-export-project">
                    <i class="fas fa-save menu-icon-file"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç (.json)
                </li>
                <li class="separator"></li>
                <li id="ctx-export-full">
                    <i class="fas fa-file-code menu-icon-file"></i>
                    GeoJSON (–ø–æ–ª–Ω—ã–π)
                </li>
                <li id="ctx-export-simple">
                    <i class="fas fa-file-contract menu-icon-file"></i>
                    GeoJSON (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
                </li>
                <li class="separator"></li>
                <li id="ctx-export-html">
                    <i class="fas fa-globe menu-icon-html"></i>
                    HTML-–∫–∞—Ä—Ç–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è)
                </li>
            </ul>
        </li>
    </ul>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications"></div>

<!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
<div class="loader-overlay" id="loader">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script>
// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const CONFIG = {
    map: {
        center: [55.35, 50.75],
        zoom: 7,
        apiKey: 'dde71a0e-b612-44b7-b53b-82533420240f'
    },
    db: {
        name: 'TatarstanMapDB',
        version: 1,
        storeName: 'districts'
    },
    api: {
        nspdLayer: 36278,
        baseUrl: 'https://nspd.gov.ru/api/aeggis/v3'
    },
    styles: {
        default: {
            fillColor: 'rgba(0, 123, 255, 0.25)',
            strokeColor: '#0056b3',
            strokeWidth: 2
        },
        hover: {
            fillColor: 'rgba(40, 167, 69, 0.4)',
            strokeColor: '#28a745',
            strokeWidth: 3
        },
        selected: {
            fillColor: 'rgba(255, 193, 7, 0.5)',
            strokeColor: '#ffc107',
            strokeWidth: 3
        }
    }
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ü–∏–π
proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs');
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

// ============================================================
// –ú–û–î–£–õ–¨: –ë–ê–ó–ê –î–ê–ù–ù–´–• (IndexedDB)
// ============================================================
const DB = {
    db: null,
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.db.name, CONFIG.db.version);
            
            request.onerror = () => reject(request.error);
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(CONFIG.db.storeName)) {
                    db.createObjectStore(CONFIG.db.storeName, { keyPath: 'id' });
                }
            };
            
            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve();
            };
        });
    },
    
    async save(district) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            const store = tx.objectStore(CONFIG.db.storeName);
            const request = store.put(district);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async remove(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            const store = tx.objectStore(CONFIG.db.storeName);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async getAll() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readonly');
            const store = tx.objectStore(CONFIG.db.storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async clear() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            const store = tx.objectStore(CONFIG.db.storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async importBulk(districts) {
        await this.clear();
        const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
        const store = tx.objectStore(CONFIG.db.storeName);
        districts.forEach(d => store.put(d));
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–û–†–î–ò–ù–ê–¢–ê–ú–ò
// ============================================================
const GeoUtils = {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ EPSG:3857 –≤ EPSG:4326 (lat, lon)
    toLatLon(coords) {
        const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', coords);
        return [lat, lon];
    },
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ lat,lon –≤ EPSG:3857
    toMercator(latLon) {
        return proj4('EPSG:4326', 'EPSG:3857', [latLon[1], latLon[0]]);
    },
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–ª—å—Ü–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    convertRing(ring) {
        return ring.map(coord => this.toLatLon(coord));
    },
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –∏–∑ –ù–°–ü–î
    convertGeometry(geometry) {
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => this.convertRing(ring))
            };
        } else if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(polygon => 
                    polygon.map(ring => this.convertRing(ring))
                )
            };
        }
        return geometry;
    },
    
    // –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    simplifyRing(ring, tolerance) {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–µ—Ç—Ä—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —É–ø—Ä–æ—â–µ–Ω–∏—è
        const points = ring.map(([lat, lon]) => {
            const [x, y] = proj4('EPSG:4326', 'EPSG:3857', [lon, lat]);
            return { x, y };
        });
        
        const simplified = simplify(points, tolerance, true);
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        return simplified.map(p => {
            const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', [p.x, p.y]);
            return [lat, lon];
        });
    },
    
    simplifyGeometry(geometry, tolerance) {
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => this.simplifyRing(ring, tolerance))
            };
        } else if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(polygon =>
                    polygon.map(ring => this.simplifyRing(ring, tolerance))
                )
            };
        }
        return geometry;
    },
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
    generateId(name) {
        return name
            .toLowerCase()
            .replace(/[^a-z–∞-—è—ë0-9]/gi, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: API –ù–°–ü–î
// ============================================================
const NSPD = {
    async fetchBoundaries(latLon) {
        const [x, y] = GeoUtils.toMercator(latLon);
        
        const delta = 0.075;
        const bbox = `${x - delta},${y - delta},${x + delta},${y + delta}`;
        
        const params = new URLSearchParams({
            REQUEST: 'GetFeatureInfo',
            SERVICE: 'WMS',
            VERSION: '1.3.0',
            QUERY_LAYERS: CONFIG.api.nspdLayer,
            LAYERS: CONFIG.api.nspdLayer,
            FORMAT: 'image/png',
            STYLES: '',
            TRANSPARENT: 'true',
            INFO_FORMAT: 'application/json',
            FEATURE_COUNT: '10',
            I: '256',
            J: '256',
            WIDTH: '512',
            HEIGHT: '512',
            CRS: 'EPSG:3857',
            BBOX: bbox,
            RANDOM: Math.random()
        });
        
        const url = `${CONFIG.api.baseUrl}/${CONFIG.api.nspdLayer}/wms?${params.toString()}`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
        
        const data = await response.json();
        if (!data.features || data.features.length === 0) {
            throw new Error('–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }
        
        return data.features;
    },
    
    parseFeature(feature) {
        const name = feature.properties?.options?.name || 
                     feature.properties?.name || 
                     '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        
        const geometry = GeoUtils.convertGeometry(feature.geometry);
        
        return {
            id: GeoUtils.generateId(name),
            name: name,
            geometry: geometry,
            addedAt: new Date().toISOString()
        };
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: –ö–ê–†–¢–ê
// ============================================================
const MapModule = {
    map: null,
    objectsCollection: null,
    selectedPolygon: null,
    
    async init() {
        return new Promise((resolve) => {
            this.map = new ymaps.Map('map', {
                center: CONFIG.map.center,
                zoom: CONFIG.map.zoom,
                controls: ['zoomControl', 'fullscreenControl', 'typeSelector', 'rulerControl']
            });
            
            this.objectsCollection = new ymaps.GeoObjectCollection();
            this.map.geoObjects.add(this.objectsCollection);
            
            // –°–æ–±—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
            this.map.events.add('contextmenu', (e) => App.showContextMenu(e));
            this.map.events.add('click', () => App.hideContextMenu());
            
            resolve();
        });
    },
    
    addDistrict(district, simplified = false) {
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        const geometry = simplified 
            ? GeoUtils.simplifyGeometry(district.geometry, tolerance)
            : district.geometry;
        
        const polygon = new ymaps.GeoObject({
            geometry: geometry,
            properties: {
                hintContent: district.name,
                districtId: district.id,
                districtData: district
            }
        }, {
            ...CONFIG.styles.default,
            interactivityModel: 'default#transparent'
        });
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        polygon.events.add('mouseenter', () => {
            if (App.currentMode === 'view') {
                polygon.options.set(CONFIG.styles.hover);
            }
        });
        
        polygon.events.add('mouseleave', () => {
            if (App.currentMode === 'view' && polygon !== this.selectedPolygon) {
                polygon.options.set(CONFIG.styles.default);
            }
        });
        
        polygon.events.add('click', (e) => {
            if (App.currentMode === 'view') {
                this.selectPolygon(polygon);
            }
        });
        
        polygon.events.add('contextmenu', (e) => {
            if (App.currentMode === 'build') {
                App.clickedPolygon = polygon;
            }
        });
        
        this.objectsCollection.add(polygon);
    },
    
    selectPolygon(polygon) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        if (this.selectedPolygon) {
            this.selectedPolygon.options.set(CONFIG.styles.default);
        }
        
        // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π
        this.selectedPolygon = polygon;
        polygon.options.set(CONFIG.styles.selected);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const data = polygon.properties.get('districtData');
        document.getElementById('info-name').textContent = data.name;
        document.getElementById('info-details').textContent = 
            `–î–æ–±–∞–≤–ª–µ–Ω: ${new Date(data.addedAt).toLocaleDateString('ru-RU')}`;
    },
    
    removePolygon(polygon) {
        this.objectsCollection.remove(polygon);
        if (this.selectedPolygon === polygon) {
            this.selectedPolygon = null;
        }
    },
    
    clear() {
        this.objectsCollection.removeAll();
        this.selectedPolygon = null;
    },
    
    fitBounds() {
        if (this.objectsCollection.getLength() > 0) {
            this.map.setBounds(this.objectsCollection.getBounds(), {
                checkZoomRange: true,
                duration: 500
            });
        }
    },
    
    findPolygonById(id) {
        let found = null;
        this.objectsCollection.each((obj) => {
            if (obj.properties.get('districtId') === id) {
                found = obj;
            }
        });
        return found;
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: –≠–ö–°–ü–û–†–¢
// ============================================================
const Exporter = {
    async exportProject() {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        const data = {
            type: 'TatarstanMapProject',
            version: '2.0',
            createdAt: new Date().toISOString(),
            districts: districts
        };
        
        this.download(data, 'tatarstan_project.json');
        UI.notify('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    },
    
    async exportGeoJSON(simplified = false) {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        
        const features = districts.map(d => {
            const geometry = simplified 
                ? GeoUtils.simplifyGeometry(d.geometry, tolerance)
                : d.geometry;
            
            return {
                type: 'Feature',
                properties: { name: d.name },
                geometry: geometry
            };
        });
        
        const data = {
            type: 'FeatureCollection',
            meta: {
                created: new Date().toISOString(),
                simplified: simplified,
                tolerance: simplified ? tolerance : null
            },
            features: features
        };
        
        const filename = simplified ? 'tatarstan_simplified.json' : 'tatarstan_full.json';
        this.download(data, filename);
        UI.notify(`GeoJSON (${simplified ? '—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π' : '–ø–æ–ª–Ω—ã–π'}) —Å–æ—Ö—Ä–∞–Ω—ë–Ω`, 'success');
    },
    
    async exportHTML() {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        UI.showLoader('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML-–∫–∞—Ä—Ç—ã...');
        
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        
        // –£–ø—Ä–æ—â–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –¥–ª—è HTML
        const simplifiedDistricts = districts.map(d => ({
            name: d.name,
            geometry: GeoUtils.simplifyGeometry(d.geometry, tolerance)
        }));
        
        const html = this.generateHTMLTemplate(simplifiedDistricts);
        
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tatarstan_map.html';
        a.click();
        URL.revokeObjectURL(url);
        
        UI.hideLoader();
        UI.notify('HTML-–∫–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    },
    
    generateHTMLTemplate(districts) {
        const dataJSON = JSON.stringify(districts);
        
        return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=${CONFIG.map.apiKey}&lang=ru_RU"><\/script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { width: 100%; height: 100%; }
        
        .info-card {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
        }
        
        .info-card h1 {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card h2 {
            font-size: 20px;
            color: #212529;
            font-weight: 600;
        }
        
        .title-bar {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="title-bar">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</div>
    <div class="info-card">
        <h1>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–π–æ–Ω</h1>
        <h2 id="district-name">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ä–∞–π–æ–Ω</h2>
    </div>

<script>
const DISTRICTS = ${dataJSON};

const STYLES = {
    default: { fillColor: 'rgba(0, 123, 255, 0.3)', strokeColor: '#0056b3', strokeWidth: 2 },
    hover: { fillColor: 'rgba(40, 167, 69, 0.45)', strokeColor: '#28a745', strokeWidth: 3 },
    selected: { fillColor: 'rgba(255, 193, 7, 0.5)', strokeColor: '#e6a800', strokeWidth: 3 }
};

let selectedPolygon = null;

ymaps.ready(() => {
    const map = new ymaps.Map('map', {
        center: [55.35, 50.75],
        zoom: 7,
        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
    });
    
    const collection = new ymaps.GeoObjectCollection();
    map.geoObjects.add(collection);
    
    DISTRICTS.forEach(district => {
        const polygon = new ymaps.GeoObject({
            geometry: district.geometry,
            properties: { name: district.name }
        }, { ...STYLES.default });
        
        polygon.events.add('mouseenter', () => {
            if (polygon !== selectedPolygon) {
                polygon.options.set(STYLES.hover);
            }
        });
        
        polygon.events.add('mouseleave', () => {
            if (polygon !== selectedPolygon) {
                polygon.options.set(STYLES.default);
            }
        });
        
        polygon.events.add('click', () => {
            if (selectedPolygon) {
                selectedPolygon.options.set(STYLES.default);
            }
            selectedPolygon = polygon;
            polygon.options.set(STYLES.selected);
            document.getElementById('district-name').textContent = district.name;
        });
        
        collection.add(polygon);
    });
    
    // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –≥—Ä–∞–Ω–∏—Ü—ã
    if (collection.getLength() > 0) {
        map.setBounds(collection.getBounds(), { checkZoomRange: true });
    }
});
<\/script>
</body>
</html>`;
    },
    
    download(data, filename) {
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: –ò–ú–ü–û–†–¢
// ============================================================
const Importer = {
    async handleFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    await this.processData(data);
                    resolve();
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = () => reject(reader.error);
            reader.readAsText(file);
        });
    },
    
    async processData(data) {
        let districts = [];
        
        // –§–æ—Ä–º–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞
        if (data.type === 'TatarstanMapProject' && data.districts) {
            districts = data.districts;
        }
        // –§–æ—Ä–º–∞—Ç GeoJSON
        else if (data.type === 'FeatureCollection' && data.features) {
            districts = data.features.map(f => ({
                id: GeoUtils.generateId(f.properties?.name || 'unknown'),
                name: f.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                geometry: f.geometry,
                addedAt: new Date().toISOString()
            }));
        }
        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
        else if (data.features) {
            districts = data.features.map(f => ({
                id: f.id || GeoUtils.generateId(f.name || f.properties?.name || 'unknown'),
                name: f.name || f.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                geometry: f.geometry || { type: f.type, coordinates: f.coords || f.coordinates },
                addedAt: f.addedAt || new Date().toISOString()
            }));
        }
        else {
            throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }
        
        await DB.importBulk(districts);
    }
};

// ============================================================
// –ú–û–î–£–õ–¨: UI
// ============================================================
const UI = {
    notify(message, type = 'info') {
        const container = document.getElementById('notifications');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<i class="fas fa-${this.getIcon(type)}"></i> ${message}`;
        container.appendChild(notification);
        
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    },
    
    getIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    },
    
    showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        document.getElementById('loader-text').textContent = text;
        document.getElementById('loader').style.display = 'flex';
    },
    
    hideLoader() {
        document.getElementById('loader').style.display = 'none';
    },
    
    updateCounter(count) {
        const text = count === 0 ? '0 —Ä–∞–π–æ–Ω–æ–≤' :
                     count === 1 ? '1 —Ä–∞–π–æ–Ω' :
                     count < 5 ? `${count} —Ä–∞–π–æ–Ω–∞` : `${count} —Ä–∞–π–æ–Ω–æ–≤`;
        document.getElementById('counter-text').textContent = text;
    }
};

// ============================================================
// –ì–õ–ê–í–ù–´–ô –ú–û–î–£–õ–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
// ============================================================
const App = {
    currentMode: 'build',
    clickedCoords: null,
    clickedPolygon: null,
    
    async init() {
        UI.showLoader('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        try {
            await DB.init();
            await MapModule.init();
            await this.loadFromDB();
            this.setupEventListeners();
            this.updateModeUI();
            
            UI.hideLoader();
            UI.notify('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        } catch (err) {
            UI.hideLoader();
            UI.notify('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + err.message, 'error');
            console.error(err);
        }
    },
    
    async loadFromDB() {
        const districts = await DB.getAll();
        MapModule.clear();
        
        const simplified = this.currentMode === 'view';
        districts.forEach(d => MapModule.addDistrict(d, simplified));
        
        UI.updateCounter(districts.length);
        
        if (districts.length > 0) {
            MapModule.fitBounds();
        }
    },
    
    setupEventListeners() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
        document.getElementById('mode-build').addEventListener('change', () => this.setMode('build'));
        document.getElementById('mode-view').addEventListener('change', () => this.setMode('view'));
        
        // –ö–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª–∏
        document.getElementById('btn-load-project').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            
            UI.showLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...');
            try {
                await Importer.handleFile(e.target.files[0]);
                await this.loadFromDB();
                UI.notify('–ü—Ä–æ–µ–∫—Ç –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            } catch (err) {
                UI.notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message, 'error');
            }
            UI.hideLoader();
            e.target.value = '';
        });
        
        document.getElementById('btn-clear').addEventListener('click', async () => {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞–π–æ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?')) return;
            
            await DB.clear();
            MapModule.clear();
            UI.updateCounter(0);
            UI.notify('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞', 'info');
        });
        
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        document.getElementById('ctx-add').addEventListener('click', () => this.addDistrict());
        document.getElementById('ctx-delete').addEventListener('click', () => this.deleteDistrict());
        document.getElementById('ctx-export-project').addEventListener('click', () => Exporter.exportProject());
        document.getElementById('ctx-export-full').addEventListener('click', () => Exporter.exportGeoJSON(false));
        document.getElementById('ctx-export-simple').addEventListener('click', () => Exporter.exportGeoJSON(true));
        document.getElementById('ctx-export-html').addEventListener('click', () => Exporter.exportHTML());
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É
        document.addEventListener('click', () => this.hideContextMenu());
    },
    
    setMode(mode) {
        if (this.currentMode === mode) return;
        this.currentMode = mode;
        this.updateModeUI();
        this.loadFromDB(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω—É–∂–Ω—ã–º —É–ø—Ä–æ—â–µ–Ω–∏–µ–º
    },
    
    updateModeUI() {
        const infoPanel = document.getElementById('info-panel');
        const ctxAdd = document.getElementById('ctx-add');
        const ctxExport = document.querySelector('.submenu');
        
        if (this.currentMode === 'view') {
            infoPanel.style.display = 'block';
            ctxAdd.classList.add('hidden');
            ctxExport.classList.add('hidden');
        } else {
            infoPanel.style.display = 'none';
            ctxAdd.classList.remove('hidden');
            ctxExport.classList.remove('hidden');
        }
    },
    
    showContextMenu(e) {
        e.preventDefault();
        
        this.clickedCoords = e.get('coords');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –ø–æ–ª–∏–≥–æ–Ω—É
        const target = e.get('target');
        this.clickedPolygon = (target !== MapModule.map) ? target : null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ "–£–¥–∞–ª–∏—Ç—å"
        const deleteItem = document.getElementById('ctx-delete');
        if (this.clickedPolygon && this.currentMode === 'build') {
            deleteItem.classList.remove('disabled');
        } else {
            deleteItem.classList.add('disabled');
        }
        
        // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        if (this.currentMode === 'view') return;
        
        const menu = document.getElementById('context-menu');
        const pos = e.get('position');
        menu.style.left = pos[0] + 'px';
        menu.style.top = pos[1] + 'px';
        menu.style.display = 'block';
    },
    
    hideContextMenu() {
        document.getElementById('context-menu').style.display = 'none';
    },
    
   async addDistrict() {
    this.hideContextMenu();
    if (!this.clickedCoords) return;
    
    UI.showLoader('–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü...');
    
    try {
        const features = await NSPD.fetchBoundaries(this.clickedCoords);
        const existing = await DB.getAll();
        const existingIds = new Set(existing.map(d => d.id));
        
        // –ü–∞—Ä—Å–∏–º –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
        const newDistricts = features
            .map(f => NSPD.parseFeature(f))
            .filter(d => !existingIds.has(d.id));
        
        if (newDistricts.length === 0) {
            throw new Error('–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ
        for (const district of newDistricts) {
            await DB.save(district);
            MapModule.addDistrict(district, false);
        }
        
        UI.updateCounter(existing.length + newDistricts.length);
        MapModule.fitBounds();
        
        UI.notify(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${newDistricts.length} —à—Ç.`, 'success');
        
    } catch (err) {
        UI.notify(err.message, 'error');
    }
    
    UI.hideLoader();
},
    
    async deleteDistrict() {
        this.hideContextMenu();
        if (!this.clickedPolygon) return;
        
        const id = this.clickedPolygon.properties.get('districtId');
        const data = this.clickedPolygon.properties.get('districtData');
        
        await DB.remove(id);
        MapModule.removePolygon(this.clickedPolygon);
        
        const remaining = await DB.getAll();
        UI.updateCounter(remaining.length);
        
        UI.notify(`–£–¥–∞–ª—ë–Ω: ${data.name}`, 'info');
        this.clickedPolygon = null;
    }
};

// ============================================================
// –ó–ê–ü–£–°–ö
// ============================================================
ymaps.ready(() => App.init());
</script>

</body>
</html>
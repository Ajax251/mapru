<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления поиском по документам</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1, h2 { color: #343a40; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 5px; }
        .upload-label { cursor: pointer; background-color: #007bff; color: #fff; padding: 12px 20px; border-radius: 5px; font-weight: bold; display: inline-block; transition: background-color 0.2s; }
        input[type="file"] { display: none; }
        button { background-color: #28a745; color: #fff; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #dee2e6; text-align: left; }
        th { background-color: #e9ecef; }
        #upload-queue { margin-top: 20px; border: 1px solid #ccc; border-radius: 5px; max-height: 300px; overflow-y: auto; display: none; background-color: #fff; }
        .queue-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .queue-item:last-child { border-bottom: none; }
        .queue-status { font-size: 1.5em; width: 40px; text-align: center; }
        .queue-filename { flex-grow: 1; margin-left: 10px; font-family: "Courier New", monospace; }
        .queue-message { font-size: 0.9em; color: #d9534f; margin-left: auto; padding-left: 10px; }
        .search-form { display: flex; gap: 10px; }
        .search-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .search-options { margin-top: 10px; display: flex; align-items: center; gap: 5px; color: #555; }
        #searchResults { margin-top: 20px; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; }
        .search-result-item a { text-decoration: none; color: #0056b3; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Панель управления поиском по документам</h1>
        <div class="section">
            <h2>Поиск по документам</h2>
            <form id="searchForm">
                <div class="search-form">
                    <input type="text" id="searchInput" placeholder="Введите текст для поиска..." required>
                    <button type="submit">Найти</button>
                </div>
                <div class="search-options">
                    <input type="checkbox" id="exactMatchCheckbox">
                    <label for="exactMatchCheckbox">Искать точную фразу</label>
                </div>
            </form>
            <div id="searchResults"></div>
        </div>
        <div class="section">
            <h2>Загрузка новых файлов</h2>
            <form id="uploadForm">
                <label for="fileInput" class="upload-label">Выберите PDF файлы</label>
                <input type="file" id="fileInput" name="files" multiple accept=".pdf">
                <p id="file-list">Файлы не выбраны</p>
                <button type="submit" id="submitBtn" disabled>Загрузить и обработать</button>
            </form>
            <div id="upload-queue"></div>
            <div id="final-message" style="margin-top: 15px; font-weight: bold;"></div>
        </div>
        <div class="section">
            <h2>Обработанные файлы в базе данных</h2>
            <table>
                <thead><tr><th>Имя файла</th><th>Размер (КБ)</th><th>Страниц</th><th>Дата обработки</th></tr></thead>
                <tbody id="files-table-body">
                    <!-- Данные будут загружены сюда с помощью JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // === КОНФИГУРАЦИЯ API ===
        const API_BASE_URL = "https://mapruapp.ru/doc-search-api";

        document.addEventListener('DOMContentLoaded', () => {
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const submitBtn = document.getElementById('submitBtn');
            const fileListDisplay = document.getElementById('file-list');
            const uploadQueueDiv = document.getElementById('upload-queue');
            const finalMessageDiv = document.getElementById('final-message');
            const filesTableBody = document.getElementById('files-table-body');
            
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const searchResultsDiv = document.getElementById('searchResults');
            const exactMatchCheckbox = document.getElementById('exactMatchCheckbox');

            // Функция для загрузки и отображения списка файлов
            async function loadFilesList() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/files`);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const files = await response.json();
                    filesTableBody.innerHTML = ''; // Очищаем таблицу
                    if (files.length === 0) {
                        filesTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">База данных пуста.</td></tr>';
                    } else {
                        files.forEach(file => {
                            const row = document.createElement('tr');
                            const fileSizeKB = (file.filesize / 1024).toFixed(2);
                            const processedDate = file.processed_at ? new Date(file.processed_at).toLocaleString('ru-RU') : 'N/A';
                            row.innerHTML = `
                                <td><a href="${API_BASE_URL}/view/${file.id}" target="_blank">${file.filename}</a></td>
                                <td>${fileSizeKB}</td>
                                <td>${file.page_count}</td>
                                <td>${processedDate}</td>
                            `;
                            filesTableBody.appendChild(row);
                        });
                    }
                } catch (error) {
                    filesTableBody.innerHTML = `<tr><td colspan="4" style="color: red;">Ошибка загрузки списка файлов: ${error.message}</td></tr>`;
                    console.error("Failed to load files list:", error);
                }
            }

            // Логика выбора файлов
            fileInput.addEventListener('change', () => {
                submitBtn.disabled = fileInput.files.length === 0;
                fileListDisplay.textContent = fileInput.files.length > 0 ? `Выбрано файлов: ${fileInput.files.length}` : 'Файлы не выбраны';
            });

            // Логика загрузки (очередь)
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const filesToUpload = Array.from(fileInput.files);
                if (filesToUpload.length === 0) return;
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Идет обработка...';
                fileInput.disabled = true;
                finalMessageDiv.textContent = '';
                uploadQueueDiv.style.display = 'block';
                uploadQueueDiv.innerHTML = '';

                filesToUpload.forEach((file, index) => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    queueItem.id = `file-item-${index}`;
                    queueItem.innerHTML = `<div class="queue-status">⏳</div><div class="queue-filename">${file.name}</div>`;
                    uploadQueueDiv.appendChild(queueItem);
                });
                
                for (let i = 0; i < filesToUpload.length; i++) {
                    const file = filesToUpload[i];
                    const itemDiv = document.getElementById(`file-item-${i}`);
                    const statusDiv = itemDiv.querySelector('.queue-status');
                    statusDiv.textContent = '⚙️';
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch(`${API_BASE_URL}/upload`, { method: 'POST', body: formData });
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            statusDiv.textContent = '✅';
                        } else if (result.status === 'skipped_duplicate') {
                            statusDiv.textContent = '⏩';
                        } else {
                            statusDiv.textContent = '❌';
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'queue-message';
                            errorDiv.textContent = result.message || 'Неизвестная ошибка';
                            itemDiv.appendChild(errorDiv);
                        }
                    } catch (error) {
                        statusDiv.textContent = '❌';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'queue-message';
                        errorDiv.textContent = 'Ошибка сети или сбой сервера';
                        itemDiv.appendChild(errorDiv);
                    }
                }
                
                submitBtn.textContent = 'Загрузить и обработать';
                fileInput.disabled = false;
                finalMessageDiv.innerHTML = 'Обработка всех файлов завершена! <a href="#" onclick="loadFilesList(); return false;" style="color: #0056b3;">Обновить таблицу с файлами</a>.';
            });
            
            // Логика поиска
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) return;
                const matchType = exactMatchCheckbox.checked ? 'phrase' : 'all_words';
                searchResultsDiv.innerHTML = '<p>Идет поиск...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/search?query=${encodeURIComponent(query)}&match_type=${matchType}`);
                    const results = await response.json();
                    if (response.ok) {
                        if (results.length > 0) {
                            searchResultsDiv.innerHTML = `<strong>Найдено совпадений: ${results.length}</strong>`;
                            results.forEach(res => {
                                const resultEl = document.createElement('div');
                                resultEl.className = 'search-result-item';
                                resultEl.innerHTML = `<a href="${API_BASE_URL}/view/${res.file_id}#page=${res.page_number}" target="_blank">${res.filename}</a> <span>(страница ${res.page_number})</span>`;
                                searchResultsDiv.appendChild(resultEl);
                            });
                        } else { 
                            searchResultsDiv.innerHTML = '<p>Ничего не найдено.</p>'; 
                        }
                    } else { 
                        searchResultsDiv.innerHTML = `<p style="color: red;">Ошибка: ${results.error || 'Неизвестная ошибка'}</p>`; 
                    }
                } catch (error) { 
                    searchResultsDiv.innerHTML = `<p style="color: red;">Ошибка сети.</p>`; 
                }
            });

            // Загружаем список файлов при первой загрузке страницы
            loadFilesList();
        });
    </script>
</body>
</html>
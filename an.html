<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитик</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="icon" href="img/analysis.png" type="image/png">
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-color: #333;
        --primary-color: #007bff;
        --primary-color-dark: #0056b3;
        --secondary-text-color: #555;
        --border-color: #e0e6ec;
        --danger-color: #dc3545;
        --danger-bg-color: #f8d7da;
        --print-color: #28a745;
        --print-dark-color: #218838;
        --new-chat-color: #FFA500;
        --new-chat-dark-color: #E86100;
        --settings-color-proxy-lite: #007bff;
        --settings-color-proxy-standard: #0056b3;
        --settings-color-direct-lite: #FFA500;
        --settings-color-direct-standard: #dc3545;
        --settings-color-claude: #28a745;
        --source-code-color: #6f42c1;
        --table-mode-color: #17a2b8;
        --table-mode-inactive-color: #6c757d;
        --export-xlsx-color: #198754;
        --export-docx-color: #fd7e14;
        --export-csv-color: #6610f2;
        --warning-bg-color: #fff3cd;
        --warning-border-color: #ffeeba;
        --warning-text-color: #856404;
    }
    html, body {
        height: 100%; margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    .app-container {
        display: flex; flex-direction: column;
        height: 100dvh;
        background-color: var(--card-bg-color);
    }
    .app-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 25px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .app-header h1 {
        grid-column: 2 / 3;
        margin: 0; font-size: 24px; font-weight: 500;
        color: var(--primary-color);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .header-right-controls {
        grid-column: 3 / 4;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative;
        gap: 10px;
    }
    .app-header h1 i { margin-right: 12px; }

    #settings-btn, #table-mode-btn {
        background: transparent;
        border: 1px solid transparent;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--primary-color);
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    
    #settings-btn:hover, #table-mode-btn:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }

    #table-mode-btn {
        color: var(--table-mode-inactive-color);
    }

    #table-mode-btn.active {
        color: var(--table-mode-color);
        background-color: rgba(23, 162, 184, 0.1);
        border-color: rgba(23, 162, 184, 0.3);
    }

    .header-right-controls-movable { display: none; }
    
    .api-mode-selector-container { position: relative; width: 100%; }
    #api-mode-selector-button {
        width: 100%;
        padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; background-color: white;
        cursor: pointer; transition: all 0.2s ease; font-size: 16px;
        color: var(--text-color); display: flex; align-items: center; gap: 10px;
        text-align: left;
    }
    #api-mode-selector-button:hover { border-color: var(--primary-color); }
    #api-mode-selector-button .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    #api-mode-selector-button .text { flex-grow: 1; }
    #api-mode-selector-button::after {
        content: ''; width: 8px; height: 8px;
        border-right: 2px solid var(--secondary-text-color);
        border-bottom: 2px solid var(--secondary-text-color);
        transform: rotate(45deg); margin-left: auto;
    }
    #api-mode-options {
        position: absolute; list-style: none; padding: 0; margin: 5px 0 0 0;
        background-color: white; border: 1px solid var(--border-color);
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%; z-index: 1011; display: none;
    }
    .api-mode-option {
        padding: 12px 15px; cursor: pointer; display: flex;
        align-items: center; gap: 10px; font-size: 16px;
    }
    .api-mode-option:hover { background-color: var(--bg-color); }
    .api-mode-option .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    .api-mode-option.selected { font-weight: 500; background-color: #eaf4ff; }
    
    .response-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .response-actions {
        padding: 10px 25px; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color);
        display: none; gap: 10px; flex-shrink: 0; align-items: center; flex-wrap: wrap;
    }
    .action-btn {
        padding: 8px 15px; border-radius: 5px; cursor: pointer;
        font-size: 14px; font-weight: 500; color: white; transition: all 0.2s ease; border: none;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn i { margin-right: 8px; }
    #copy-btn { background-color: var(--primary-color); }
    #copy-btn:hover { background-color: var(--primary-color-dark); }
    #print-btn { background-color: var(--print-color); }
    #print-btn:hover { background-color: var(--print-dark-color); }
    #new-chat-btn { background-color: var(--new-chat-color); margin-left: auto; }
    #new-chat-btn:hover { background-color: var(--new-chat-dark-color); }

    .export-buttons {
        display: none;
        gap: 10px;
        margin-left: 10px;
        padding-left: 10px;
        border-left: 2px solid var(--border-color);
    }
    .export-buttons.show { display: flex; }
    #export-xlsx-btn { background-color: var(--export-xlsx-color); }
    #export-xlsx-btn:hover { background-color: #146c43; }
    #export-docx-btn { background-color: var(--export-docx-color); }
    #export-docx-btn:hover { background-color: #dc6002; }
    #export-csv-btn { background-color: var(--export-csv-color); }
    #export-csv-btn:hover { background-color: #520dc2; }
    
    .response-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .welcome-message { text-align: center; color: var(--secondary-text-color); padding-top: 15vh; animation: fadeInUp 0.5s ease forwards; }
    .welcome-message i { font-size: 48px; margin-bottom: 20px; color: var(--primary-color); opacity: 0.8; }
    .welcome-message h2 { font-weight: 500; font-size: 22px; color: var(--text-color); margin-bottom: 10px; }
    .welcome-message p { font-size: 16px; line-height: 1.6; }
    
    #ai-response { line-height: 1.7; font-size: 16px; }
    #ai-response h1, #ai-response h2, #ai-response h3 {
        font-weight: 500; color: var(--text-color); margin-top: 30px; margin-bottom: 15px;
        padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    #ai-response h1 { font-size: 22px; text-align: center; border-bottom: 2px solid var(--primary-color); }
    #ai-response h2 { font-size: 20px; }
    #ai-response h3 { font-size: 18px; }
    #ai-response ul, #ai-response ol { padding-left: 25px; }
    #ai-response li { margin-bottom: 8px; }
    #ai-response strong { color: var(--primary-color-dark); font-weight: 500; }
    #ai-response hr { border: none; border-top: 3px dotted #ced4da; margin: 40px 20%; }
    #ai-response table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    #ai-response th, #ai-response td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
    #ai-response th { background-color: #f8f9fa; font-weight: 500; }
    #ai-response .disclaimer {
        display: block; background-color: #fffbe6; border: 1px solid #ffe58f; color: #d46b08;
        padding: 15px; border-radius: 8px; font-size: 15px; line-height: 1.6; margin-top: 30px;
        text-align: left; font-weight: 500 !important;
    }
     .failed-urls-warning {
        margin-top: 25px; padding: 15px; border-radius: 8px;
        background-color: var(--warning-bg-color); border: 1px solid var(--warning-border-color);
        color: var(--warning-text-color); font-size: 15px;
    }
    .failed-urls-warning h4 { margin-top: 0; margin-bottom: 10px; }
    .failed-urls-warning ul { list-style-type: none; padding-left: 0; margin-bottom: 0; }
    .failed-urls-warning li { margin-bottom: 5px; word-break: break-all; }

    .loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
    .loader p { margin-top: 20px; color: var(--secondary-text-color); font-size: 16px; }
    #cancel-btn { margin-top: 15px; background-color: var(--new-chat-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    #cancel-btn:hover { background-color: var(--new-chat-dark-color); }
    .loader .loader-icon { font-size: 64px; color: var(--primary-color); opacity: 0.8; margin-bottom: 10px; animation: pulse-loader 2s ease-in-out infinite;}
    @keyframes pulse-loader { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    .input-panel { display: flex; padding: 15px 25px; gap: 15px; border-top: 1px solid var(--border-color); background-color: #f8f9fa; flex-shrink: 0; align-items: center; }
    #user-query {
        flex-grow: 1; padding: 12px 15px; font-size: 16px; font-family: 'Roboto', sans-serif; border-radius: 22px;
        border: 1px solid var(--border-color); resize: none; height: 24px; line-height: 24px; transition: all 0.2s ease; max-height: 200px;
    }
    #user-query:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    #send-btn {
        flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: none; background-color: var(--primary-color);
        color: white; font-size: 20px; cursor: pointer; transition: all 0.2s ease;
        display: flex; align-items: center; justify-content: center;
    }
    #send-btn:hover { background-color: var(--primary-color-dark); }
    #user-query:disabled, #send-btn:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px;
        display: flex; flex-direction: column;
    }
    .modal-content h2 { margin-top: 0; color: var(--primary-color); text-align: center;}
    .modal-content p { color: var(--secondary-text-color); line-height: 1.6; text-align: center;}
    .modal-content a { color: var(--primary-color-dark); text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }

    .settings-controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .settings-control-group { text-align: left; }
    .settings-control-group label { display: block; margin-bottom: 8px; color: var(--secondary-text-color); font-size: 14px; }
    .settings-control-group select, .settings-control-group input[type="password"] {
        width: 100%; padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; font-size: 16px; box-sizing: border-box;
    }
    #api-key-input-group { display: none; }
    #save-settings-btn {
        margin-top: 25px; width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s;
    }
    #save-settings-btn:hover { background-color: var(--primary-color-dark); }
    
    .source-code-modal {
        max-width: 90vw;
        width: 1200px;
        max-height: 85vh;
    }
    .source-code-wrapper {
        background-color: #2e3440;
        color: #d8dee9;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        overflow: auto;
        flex-grow: 1;
    }
    .source-code-wrapper pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .source-code-wrapper code {
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
    }
    #close-source-modal-btn, #show-source-btn {
        background-color: var(--source-code-color);
    }
    #close-source-modal-btn:hover, #show-source-btn:hover {
        background-color: #5a379b;
    }
    #source-code-button-container {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
    }

@media print {
    .app-header, .input-panel, .response-actions, #settings-btn, #table-mode-btn, #source-code-button-container, .failed-urls-warning {
        display: none !important;
    }
    body, .app-container {
        background-color: #ffffff !important; box-shadow: none !important;
        height: auto !important; overflow: visible !important; color: #000000 !important;
    }
    .response-area, .response-wrapper {
        height: auto !important; overflow: visible !important; display: block !important;
        padding: 0 !important; flex-grow: 0 !important;
    }
    #ai-response { line-height: 1.4; font-size: 12pt; }
    #ai-response table { box-shadow: none !important; page-break-inside: auto; }
    #ai-response tr { page-break-inside: avoid; }
}

@media (max-width: 768px) {
    .app-header { grid-template-columns: auto 1fr auto; gap: 10px; padding: 10px 15px; }
    .app-header h1 { grid-column: 2 / 3; font-size: 20px; }
    .header-right-controls { grid-column: 3 / 4; }
    .response-wrapper, .input-panel, .response-actions { padding: 15px; }
    .welcome-message { padding-top: 10vh; }
    #ai-response { font-size: 15px; }
    .export-buttons { margin-left: 5px; padding-left: 5px; }
}

.extracted-links-container { margin-top: 40px; border-top: 2px solid var(--border-color); padding-top: 20px; }
.extracted-links-container summary { cursor: pointer; font-weight: 500; font-size: 18px; color: var(--primary-color); transition: color 0.2s ease; }
.extracted-links-container summary:hover { color: var(--primary-color-dark); }
.extracted-links-container ul { margin-top: 15px; padding-left: 0; list-style-type: none; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: #fdfdfd; }
.extracted-links-container li { margin-bottom: 8px; font-size: 14px; word-break: break-all; }
.extracted-links-container li a { color: var(--secondary-text-color); text-decoration: none; }
.extracted-links-container li a:hover { text-decoration: underline; color: var(--primary-color); }
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left"></div>
            <h1><i class="fa-solid fa-magnifying-glass-chart"></i>Аналитик</h1>
            <div class="header-right-controls">
                <button id="table-mode-btn" title="Табличный режим">
                    <i class="fas fa-table"></i>
                </button>
                <button id="settings-btn" title="Настройки">
                    <i class="fas fa-cog"></i>
                    <i class="fas fa-key" style="display: none;"></i>
                </button>
            </div>
        </header>

        <div class="header-right-controls-movable">
             <div class="api-mode-selector-container">
                <button id="api-mode-selector-button"></button>
                <ul id="api-mode-options"></ul>
            </div>
        </div>

        <main class="response-area">
            <div class="response-actions" id="response-actions">
                <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i>Копировать</button>
                <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i>Печать</button>
                <div class="export-buttons" id="export-buttons">
                    <button class="action-btn" id="export-xlsx-btn"><i class="fa-solid fa-file-excel"></i>XLSX</button>
                    <button class="action-btn" id="export-docx-btn"><i class="fa-solid fa-file-word"></i>DOCX</button>
                    <button class="action-btn" id="export-csv-btn"><i class="fa-solid fa-file-csv"></i>CSV</button>
                </div>
                <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus-circle"></i>Новый анализ</button>
            </div>
            <div class="response-wrapper" id="response-wrapper">
                <div id="ai-response"></div>
            </div>
        </main>

        <div class="input-panel">
            <textarea id="user-query" placeholder="Введите URL, текст или несколько URL и ваш запрос (каждый URL с новой строки)" rows="1"></textarea>
            <button id="send-btn" title="Отправить на анализ"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Настройки подключения</h2>
            <p>Здесь вы можете выбрать модель и режим подключения. Для прямого режима "Gemini" требуется API-ключ.</p>
            <div class="settings-controls-wrapper">
                <div class="settings-control-group">
                    <label for="model-selector">1. Выберите модель</label>
                    <select id="model-selector">
                        <option value="gemini-2.5-flash" data-api-type="gemini">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-flash-lite-preview-06-17" data-api-type="gemini" selected>Gemini 2.5 Flash Lite</option>
                        <option value="claude-3-7-sonnet-20250219" data-api-type="anthropic">Claude 3.7 Sonnet</option>
                    </select>
                </div>
                <div class="settings-control-group">
                    <label>2. Выберите режим подключения ИИ</label>
                    <div id="modal-api-controls-placeholder"></div>
                </div>
                <div class="settings-control-group">
                    <label for="page-scraper-selector">3. Выберите сервис для извлечения кода</label>
                 <select id="page-scraper-selector">
                    <option value="vercel" selected>Vercel</option>
                    <option value="mapruapp">MapRuApp</option>
                </select>
                </div>
                <div class="settings-control-group" id="api-key-input-group">
                    <label for="api-key-input">4. Введите ваш API ключ Gemini</label>
                    <input type="password" id="api-key-input" placeholder="Ваш ключ...">
                     <small style="display: block; margin-top: 5px; color: #777;">Ключ можно получить в <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a></small>
                </div>
            </div>
            <button id="save-settings-btn">Закрыть</button>
        </div>
    </div>

    <div id="source-code-modal-overlay" class="modal-overlay">
        <div class="modal-content source-code-modal">
            <h2>Исходный HTML-код страницы</h2>
            <div class="source-code-wrapper">
                <pre><code id="source-code-content"></code></pre>
            </div>
            <button id="close-source-modal-btn">Закрыть</button>
        </div>
    </div>
    
<script>
window.addEventListener('load', () => {
    // --- CONFIGURATION ---
    const VERCEL_LINK_EXTRACTOR_API = "https://linkextractor.vercel.app/extract-from-url/";
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
    const MAPRUAPP_SCRAPER_API = `${MAPRUAPP_PROXY_BASE_URL}/page-scraper/get-source`;
    const DEFAULT_MODEL_ID = "gemini-2.5-flash-lite-preview-06-17";

    // --- SYSTEM PROMPTS ---
    const AI_SYSTEM_PROMPT_ANALYST = `Ты — "Аналитик", ИИ-эксперт по извлечению, анализу и структурированию информации из веб-страниц и текстов. Твоя задача — преобразовать потенциально хаотичные данные в четкий, структурированный и полезный отчет.

### **АЛГОРИТМ РАБОТЫ:**

1.  **Определи тип входных данных.**

2.  **ЕСЛИ на вход подан HTML-код ОДНОЙ веб-страницы:**
    *   **Шаг 1. Анализ структуры:** Определи тип страницы (например: новостная статья, главная страница компании, запись в блоге, карточка товара, форум и т.д.).
    *   **Шаг 2. Извлечение сути:** Найди и извлеки основной смысловой контент (текст статьи, описание продукта, содержание поста), **полностью игнорируя** навигационные меню, рекламные блоки, боковые панели, подвалы сайта (футеры) и прочий служебный "шум".
    *   **Шаг 3. Формирование досье:** На основе ИСКЛЮЧИТЕЛЬНО извлеченного чистого контента создай подробное досье страницы. Если какой-то информации нет в тексте, честно указывай "Не найдено".
    *   **Структура ответа для HTML:**
        # 📜 Анализ страницы: [Извлеки и вставь заголовок из тега <title> или <h1>]
        ### 🎯 Краткое резюме
        *   **Тип страницы:** [Твой вывод о типе страницы]
        *   **Основная мысль:** [В 1-2 предложениях, о чем эта страница]
        ### 🔑 Ключевые тезисы
        [Представь основные идеи, факты, выводы или этапы из основного текста в виде маркированного списка. Каждый пункт должен быть емким и по существу.]
        ### 👤 Автор и дата публикации
        *   **Автор:** [Имя автора, если найдено]
        *   **Дата:** [Дата публикации, если найдена]
        *(Если в тексте есть таблицы или важные списки, сохрани их структуру в своем ответе)*

3.  **ЕСЛИ на вход подан обычный большой текст:**
    *   **Шаг 1. Глубокое чтение:** Внимательно проанализируй весь текст, чтобы понять его основную тему, аргументы и структуру.
    *   **Шаг 2. Структурированное саммари:** Создай подробное изложение текста, **обязательно используя таблицу** для максимальной наглядности.
    *   **Структура ответа для ТЕКСТА:**
        # 📊 Структурный анализ текста
        ### 📝 Краткое резюме
        [В 2-3 предложениях изложи главную суть всего текста.]
        ---
        ### 📋 Детальный разбор
        | Основная тема / Раздел | Ключевые тезисы и аргументы | Главные выводы по разделу |
        |---|---|---|
        | **[Определи и назови первую тему]** | [Выдели 2-3 главных аргумента или факта] | [Сформулируй краткий вывод] |
        | *(Продолжай, пока не разберешь все ключевые части текста)* | | |
        ### 🏁 Общий вывод
        [Сформулируй итоговый вывод по всему тексту.]

4. **ЕСЛИ на вход подан контент с НЕСКОЛЬКИХ страниц и есть запрос пользователя:**
    *   **Главная задача:** Выполнить запрос пользователя (например: сравнить, объединить, найти различия), используя информацию из ВСЕХ предоставленных источников.
    *   **Структура ответа:** Должна соответствовать запросу. Если это сравнение, используй сравнительную таблицу. Если это синтез информации, создай единый структурированный документ.
    *   **Точность:** Основывай свой ответ ИСКЛЮЧИТЕЛЬНО на данных из предоставленных HTML-кодов.
    *   **Ссылки:** В ответе можно ссылаться на источники как "Источник 1", "Источник 2", но не используй сами URL-адреса.

---

**ОБЩИЕ ПРАВИЛА, КОТОРЫЕ НЕЛЬЗЯ НАРУШАТЬ:**
*   **АБСОЛЮТНАЯ ТОЧНОСТЬ:** Не додумывай, не предполагай и не выдумывай информацию. Если данных нет — пиши "Не найдено" или "Не указано".
*   **ЯЗЫК:** Ответ всегда должен быть на русском языке.
*   **БЕЗ ССЫЛОК:** Никогда не используй URL или веб-ссылки в своем ответе, если это не оговорено отдельно.
*   **ФОКУС НА КОНТЕНТЕ:** При анализе HTML игнорируй сам код (теги, скрипты) и фокусируйся только на тексте, который видит пользователь.`;

    const AI_SYSTEM_PROMPT_TABLE_MODE = `Ты — "Аналитик", ИИ-эксперт по извлечению, анализу и структурированию информации из веб-страниц и текстов. Сейчас ты работаешь в ТАБЛИЧНОМ РЕЖИМЕ. Твоя задача — представить ВСЮ ИНФОРМАЦИЮ исключительно в виде хорошо структурированных таблиц.

**АЛГОРИТМ РАБОТЫ В ТАБЛИЧНОМ РЕЖИМЕ:**

1.  **ЕСЛИ на вход подан HTML-код ОДНОЙ веб-страницы:**
    *   Извлеки основной смысловой контент и представь его в табличном формате с четкой структурой.

2.  **ЕСЛИ на вход подан обычный текст:**
    *   Проанализируй текст, выдели ключевые данные и структурируй всю информацию в виде таблиц.

3.  **ЕСЛИ на вход подан контент с НЕСКОЛЬКИХ страниц и/или запрос пользователя:**
    *   Выполни запрос пользователя (например, сравнительный анализ) и представь результат ИСКЛЮЧИТЕЛЬНО в виде одной или нескольких сравнительных таблиц.
    *   Каждый источник должен быть четко обозначен (например, в отдельном столбце "Источник").

**ОБЯЗАТЕЛЬНАЯ СТРУКТУРА ОТВЕТА В ТАБЛИЧНОМ РЕЖИМЕ (ДЛЯ ОДНОГО ИСТОЧНИКА):**

# 📊 Табличный анализ данных

## 🔍 Основная информация
| Параметр | Значение |
|---|---|
| Тип контента | [HTML-страница/Текстовый документ] |
| Основная тема | [Краткое описание темы] |

## 📋 Детальная структура данных
[Здесь должна быть основная таблица с извлеченной информацией.]

**ВАЖНЫЕ ПРАВИЛА:**
- ВСЯ информация должна быть в таблицах.
- Никаких списков или абзацев вне таблиц.
- Четкая структура с заголовками столбцов.
- Если данных нет — пиши "Не указано" в соответствующей ячейке таблицы.`;

    const MODELS = [
        { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini", tier: 'standard' },
        { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
        { id: "claude-3-7-sonnet-20250219", uiName: "Claude 3.7 Sonnet", apiType: "anthropic", tier: 'standard' },
    ];

    // --- DOM ELEMENTS ---
    const queryInput = document.getElementById('user-query');
    const sendButton = document.getElementById('send-btn');
    const responseContainer = document.getElementById('ai-response');
    const responseWrapper = document.getElementById('response-wrapper');
    const responseActions = document.getElementById('response-actions');
    const copyButton = document.getElementById('copy-btn');
    const printButton = document.getElementById('print-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const tableModeBtn = document.getElementById('table-mode-btn');
    const settingsModalOverlay = document.getElementById('settings-modal-overlay');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    const apiKeyInputGroup = document.getElementById('api-key-input-group');
    const modelSelector = document.getElementById('model-selector');
    const apiModeSelectorButton = document.getElementById('api-mode-selector-button');
    const apiModeOptions = document.getElementById('api-mode-options');
    const modalApiControlsPlaceholder = document.getElementById('modal-api-controls-placeholder');
    const originalApiControlsParent = document.querySelector('.header-right-controls-movable');
    const pageScraperSelector = document.getElementById('page-scraper-selector');
    const sourceCodeModalOverlay = document.getElementById('source-code-modal-overlay');
    const closeSourceModalBtn = document.getElementById('close-source-modal-btn');
    const sourceCodeContent = document.getElementById('source-code-content');
    const exportButtons = document.getElementById('export-buttons');
    const exportXlsxBtn = document.getElementById('export-xlsx-btn');
    const exportDocxBtn = document.getElementById('export-docx-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');

    // --- STATE VARIABLES ---
    let apiKey = null;
    let currentApiMode = 'mapruapp';
    let currentModelId = DEFAULT_MODEL_ID;
    let currentApiType = "gemini";
    let currentPageScraperService = 'vercel';
    let isLoading = false;
    let controller = null;
    let conversationHistory = [];
    let lastExtractedLinks = [];
    let lastRawHtml = null;
    let isTableMode = false;
    let lastTableData = null;
    
    const welcomeMessageHTML = `<div class="welcome-message"><i class="fa-solid fa-file-import"></i><h2>Готов к анализу</h2><p>Вставьте URL-адрес для получения досье, большой фрагмент текста для структурирования<br>или несколько URL и ваш запрос для сравнительного анализа.</p></div>`;
    
    // --- CORE FUNCTIONS ---
    const initializeApp = () => {
        const renderer = new marked.Renderer();
        renderer.link = (href, title, text) => `<a href="${href}" title="${title}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        marked.setOptions({ renderer, sanitize: false, gfm: true });

        loadSettings();
        startNewAnalysis();

        sendButton.addEventListener('click', handleRequest);
        queryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } });
        copyButton.addEventListener('click', copyResponse);
        printButton.addEventListener('click', printResponse);
        newChatBtn.addEventListener('click', startNewAnalysis);
        
        settingsBtn.addEventListener('click', openSettingsModal);
        tableModeBtn.addEventListener('click', toggleTableMode);
        saveSettingsBtn.addEventListener('click', saveSettings);
        settingsModalOverlay.addEventListener('click', (e) => { if (e.target === settingsModalOverlay) closeSettingsModal(); });

        sourceCodeModalOverlay.addEventListener('click', (e) => { if (e.target === sourceCodeModalOverlay) sourceCodeModalOverlay.style.display = 'none'; });
        closeSourceModalBtn.addEventListener('click', () => { sourceCodeModalOverlay.style.display = 'none'; });

        // Export buttons event listeners
        exportXlsxBtn.addEventListener('click', exportToXlsx);
        exportDocxBtn.addEventListener('click', exportToDocx);
        exportCsvBtn.addEventListener('click', exportToCsv);

        populateApiModeOptions();
        modelSelector.addEventListener('change', () => {
            const selectedOption = modelSelector.options[modelSelector.selectedIndex];
            currentModelId = selectedOption.value;
            currentApiType = selectedOption.dataset.apiType;
            updateSettingsUI();
        });
        
        apiModeSelectorButton.addEventListener('click', (e) => {
             e.stopPropagation();
             apiModeOptions.style.display = apiModeOptions.style.display === 'block' ? 'none' : 'block';
        });
        
        document.addEventListener('click', (event) => {
            if (!apiModeSelectorButton.contains(event.target) && !apiModeOptions.contains(event.target)) {
                apiModeOptions.style.display = 'none';
            }
        });

        queryInput.addEventListener('input', () => {
            queryInput.style.height = 'auto';
            const newHeight = Math.min(queryInput.scrollHeight, 200);
            queryInput.style.height = `${newHeight}px`;
        });

        isTableMode = localStorage.getItem('analystTableMode') === 'true';
        updateTableModeUI();
    };
    
    const extractUrlsAndText = (text) => {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const urls = text.match(urlRegex) || [];
        const remainingText = text.replace(urlRegex, '').replace(/\n/g, ' ').trim();
        return { urls, remainingText };
    };
    
    const handleRequest = async () => {
        const userQuery = queryInput.value.trim();
        if (!userQuery || isLoading) return;

        if (currentApiType === 'gemini' && currentApiMode === 'direct' && !apiKey) {
            openSettingsModal();
            return;
        }

        isLoading = true;
        controller = new AbortController();
        lastExtractedLinks = [];
        lastRawHtml = null;
        lastTableData = null;
        updateUIOnRequestStart();
        
        const { urls, remainingText } = extractUrlsAndText(userQuery);

        try {
            if (urls.length > 1) {
                // Scenario: Multiple URLs for comparative analysis
                await handleMultiUrlRequest(urls, remainingText);
            } else if (urls.length === 1) {
                // Scenario: Single URL for standard analysis
                responseContainer.innerHTML = getLoaderHTML('Извлекаю содержимое страницы...');
                const pageData = await fetchPageSource(urls[0]);
                lastExtractedLinks = pageData.links;
                lastRawHtml = pageData.sourceHtml;

                let finalContentForAI = `
${remainingText ? `ЗАПРОС ПОЛЬЗОВАТЕЛЯ: ${remainingText}\n\n` : ''}
Проанализируй **строго и только** предоставленный ниже HTML-код. Вся информация для отчета должна быть взята ИСКЛЮЧИТЕЛЬНО из этого кода.

--- НАЧАЛО HTML-КОДА ---
${pageData.sourceHtml}
--- КОНЕЦ HTML-КОДА ---

Теперь, основываясь **только на приведенном выше HTML**, составь отчет согласно системным инструкциям.`;
                
                await processAndDisplayAIResponse(finalContentForAI);
                displayExtractedLinks(lastExtractedLinks);
                displaySourceCodeButton();

            } else {
                // Scenario: Text-only analysis
                await processAndDisplayAIResponse(userQuery);
            }
        } catch (error) {
            handleError(error);
        } finally {
            isLoading = false;
            controller = null;
            sendButton.disabled = false;
            queryInput.disabled = false;
        }
    };

    const handleMultiUrlRequest = async (urls, remainingText) => {
        responseContainer.innerHTML = getLoaderHTML(`Обнаружено ${urls.length} ссылок. Начинаю сбор данных...`);
        
        const fetchPromises = urls.map(url => fetchPageSource(url));
        const results = await Promise.allSettled(fetchPromises);
        
        let combinedHtmlContent = '';
        let failedUrls = [];
        let successfulUrls = [];
        
        results.forEach((result, index) => {
            const url = urls[index];
            if (result.status === 'fulfilled') {
                combinedHtmlContent += `\n\n--- НАЧАЛО КОНТЕНТА ИЗ ИСТОЧНИКА ${index + 1} (URL: ${url}) ---\n`;
                combinedHtmlContent += result.value.sourceHtml;
                combinedHtmlContent += `\n--- КОНЕЦ КОНТЕНТА ИЗ ИСТОЧНИКА ${index + 1} ---\n\n`;
                successfulUrls.push(url);
            } else {
                failedUrls.push({ url, reason: result.reason.message });
            }
        });

        if (successfulUrls.length === 0) {
            throw new Error(`Не удалось загрузить контент ни с одной из ${urls.length} указанных страниц.`);
        }

        const userPrompt = remainingText || "Проанализируй и сравни информацию из предоставленных источников.";
        let finalContentForAI = `
ЗАПРОС ПОЛЬЗОВАТЕЛЯ: ${userPrompt}

ПРЕДОСТАВЛЕННЫЕ ДАННЫЕ:
${combinedHtmlContent}

ИНСТРУКЦИЯ:
Выполни запрос пользователя, основываясь на предоставленном выше контенте с нескольких веб-страниц. Твой ответ должен быть основан ИСКЛЮЧИТЕЛЬНО на этом контенте.`;
        
        await processAndDisplayAIResponse(finalContentForAI);

        if (failedUrls.length > 0) {
            displayFailedUrlsWarning(failedUrls);
        }
    };

    const processAndDisplayAIResponse = async (contentForAI) => {
        responseContainer.innerHTML = getLoaderHTML('Анализирую данные...');
        conversationHistory.push({ role: 'user', content: contentForAI });
        
        const aiResponseText = await getAIResponse();
        conversationHistory.push({ role: 'model', content: aiResponseText });

        const finalHtml = marked.parse(aiResponseText);
        responseContainer.innerHTML = finalHtml;

        const tables = responseContainer.querySelectorAll('table');
        if (tables.length > 0) {
            lastTableData = extractTableData();
            exportButtons.classList.add('show');
        } else {
            exportButtons.classList.remove('show');
        }
        responseActions.style.display = 'flex';
    };

    const handleError = (error) => {
        conversationHistory.pop(); // Remove the failed user message
        if (error.name !== 'AbortError') {
            responseContainer.innerHTML = getFriendlyErrorHTML(error.message, error.cause?.isKeyError);
        } else {
            responseContainer.innerHTML = getFriendlyErrorHTML("Запрос был отменен.");
        }
        responseActions.style.display = 'none';
        exportButtons.classList.remove('show');
    };

    // --- UTILITY & HELPER FUNCTIONS ---

    const toggleTableMode = () => {
        isTableMode = !isTableMode;
        localStorage.setItem('analystTableMode', isTableMode.toString());
        updateTableModeUI();
    };

    const updateTableModeUI = () => {
        if (isTableMode) {
            tableModeBtn.classList.add('active');
            tableModeBtn.title = 'Табличный режим (включен)';
        } else {
            tableModeBtn.classList.remove('active');
            tableModeBtn.title = 'Табличный режим (выключен)';
        }
    };
    
    const extractTableData = () => {
        const tables = responseContainer.querySelectorAll('table');
        const tablesData = [];
        tables.forEach((table, index) => {
            const tableData = { title: `Таблица ${index + 1}`, headers: [], rows: [] };
            const headerCells = table.querySelectorAll('thead th, tr:first-child th');
            headerCells.forEach(th => tableData.headers.push(th.textContent.trim()));
            const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td, th');
                const rowData = [];
                cells.forEach(cell => rowData.push(cell.textContent.trim()));
                if (rowData.length > 0) tableData.rows.push(rowData);
            });
            tablesData.push(tableData);
        });
        return tablesData;
    };

    const exportToXlsx = () => {
        if (!lastTableData || lastTableData.length === 0) return alert('Нет данных для экспорта');
        try {
            const wb = XLSX.utils.book_new();
            lastTableData.forEach((tableData, i) => {
                const ws = XLSX.utils.aoa_to_sheet([tableData.headers, ...tableData.rows]);
                const range = XLSX.utils.decode_range(ws['!ref']);
                const colWidths = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let max = 0;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
                        if (cell && cell.v) {
                            const len = cell.v.toString().length;
                            if (len > max) max = len;
                        }
                    }
                    colWidths.push({ width: Math.min(max + 2, 50) });
                }
                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, `Лист${i + 1}`);
            });
            XLSX.writeFile(wb, 'analyst_data.xlsx');
        } catch (e) { alert('Ошибка экспорта в XLSX: ' + e.message); console.error(e); }
    };

    const exportToDocx = () => {
        if (!lastTableData || lastTableData.length === 0) return alert('Нет данных для экспорта');
        try {
            const tables = lastTableData.map(d => new docx.Table({
                rows: [
                    new docx.TableRow({ children: d.headers.map(h => new docx.TableCell({ children: [new docx.Paragraph(h)], shading: { fill: "f0f0f0" } })) }),
                    ...d.rows.map(r => new docx.TableRow({ children: r.map(c => new docx.TableCell({ children: [new docx.Paragraph(c)] })) }))
                ],
                width: { size: 100, type: docx.WidthType.PERCENTAGE }
            }));

            const docChildren = [new docx.Paragraph({ text: "Данные анализа", heading: docx.HeadingLevel.HEADING_1 })];
            tables.forEach((table, index) => {
                docChildren.push(new docx.Paragraph({ text: `Таблица ${index + 1}`, heading: docx.HeadingLevel.HEADING_2 }), table, new docx.Paragraph(""));
            });

            const doc = new docx.Document({ sections: [{ children: docChildren }] });
            docx.Packer.toBlob(doc).then(blob => saveAs(blob, "analyst_data.docx"));
        } catch (e) { alert('Ошибка экспорта в DOCX: ' + e.message); console.error(e); }
    };

    const exportToCsv = () => {
        if (!lastTableData || lastTableData.length === 0) return alert('Нет данных для экспорта');
        try {
            let csv = '';
            lastTableData.forEach((tableData, i) => {
                if (i > 0) csv += '\n\n';
                csv += `"=== Таблица ${i + 1} ===\n"`;
                const escape = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;
                csv += tableData.headers.map(escape).join(',') + '\n';
                tableData.rows.forEach(row => { csv += row.map(escape).join(',') + '\n'; });
            });
            saveAs(new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }), 'analyst_data.csv');
        } catch (e) { alert('Ошибка экспорта в CSV: ' + e.message); console.error(e); }
    };
    
    async function fetchPageSource(url) {
        let fullUrl = url.startsWith('http://') || url.startsWith('https://') ? url : `https://${url}`;
        let response;
        try {
            if (currentPageScraperService === 'mapruapp') {
                response = await fetch(MAPRUAPP_SCRAPER_API, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: fullUrl }), signal: controller?.signal
                });
            } else {
                const formData = new FormData();
                formData.append('url_input', fullUrl);
                response = await fetch(VERCEL_LINK_EXTRACTOR_API, {
                    method: 'POST', body: formData, signal: controller?.signal
                });
            }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || errorData.error || `Не удалось загрузить страницу. Статус: ${response.status}`);
            }
            const data = await response.json();
            if (currentPageScraperService === 'mapruapp') {
                if (!data.content) { throw new Error('Сервис MapRuApp не смог извлечь исходный код.'); }
                return { sourceHtml: data.content, links: [] };
            } else {
                if (!data.source_html) { throw new Error('Сервис Vercel не смог извлечь исходный код.'); }
                return { sourceHtml: data.source_html, links: data.links || [] };
            }
        } catch (error) {
            throw new Error(`Ошибка при извлечении "${url}": ${error.message}`);
        }
    }

    function displayFailedUrlsWarning(failedUrls) {
        const listItems = failedUrls.map(item => `<li><strong>${item.url}</strong>: ${item.reason}</li>`).join('');
        const warningHtml = `
            <div class="failed-urls-warning">
                <h4><i class="fas fa-exclamation-triangle"></i> Внимание!</h4>
                <p>Не удалось загрузить контент со следующих страниц. Анализ был выполнен на основе доступных данных.</p>
                <ul>${listItems}</ul>
            </div>`;
        responseContainer.insertAdjacentHTML('beforeend', warningHtml);
    }

    function displayExtractedLinks(links) {
        if (!links || links.length === 0) return;
        const listItems = links.map(link => {
            const safeLink = link.replace(/"/g, '"');
            return `<li><a href="${safeLink}" target="_blank" rel="noopener noreferrer">${safeLink}</a></li>`;
        }).join('');
        const linksHtml = `<div class="extracted-links-container"><details><summary>🔍 Найдено ссылок на странице (${links.length})</summary><ul>${listItems}</ul></details></div>`;
        responseContainer.insertAdjacentHTML('beforeend', linksHtml);
    }

    function displaySourceCodeButton() {
        if (!lastRawHtml) return;
        const container = document.createElement('div');
        container.id = 'source-code-button-container';
        container.innerHTML = `<button id="show-source-btn" class="action-btn"><i class="fa-solid fa-code"></i> Показать исходный код</button>`;
        responseWrapper.appendChild(container);
        document.getElementById('show-source-btn').addEventListener('click', showSourceCodeModal);
    }
    
    function showSourceCodeModal() {
        if (!lastRawHtml) return;
        sourceCodeContent.textContent = lastRawHtml;
        sourceCodeModalOverlay.style.display = 'flex';
    }
    
    async function getAIResponse() {
        let apiUrl, requestBody;
        const fetchOptions = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal
        };
        
        const systemPrompt = isTableMode ? AI_SYSTEM_PROMPT_TABLE_MODE : AI_SYSTEM_PROMPT_ANALYST;
        const isMapruappProxy = currentApiMode === 'mapruapp';

        if (isMapruappProxy) {
            apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
            const messages = [
                { role: 'system', content: systemPrompt },
                ...conversationHistory.map(msg => ({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content }))
            ];
            requestBody = { model: currentModelId, messages: messages, max_tokens: 4096 };
        } else {
            if (currentApiType === 'gemini') {
                apiUrl = currentApiMode === 'direct' 
                    ? `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`
                    : `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                requestBody = {
                    contents: conversationHistory.map(msg => ({ role: msg.role, parts: [{ text: msg.content }] })),
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
            } else if (currentApiType === 'anthropic') {
                apiUrl = `${VERCEL_PROXY_BASE_URL}/proxy/langdock/anthropic/eu/v1/messages`;
                requestBody = {
                    model: currentModelId,
                    messages: conversationHistory.map(msg => ({ role: msg.role, content: msg.content })),
                    system: systemPrompt,
                    max_tokens: 4096
                };
            }
        }
        
        fetchOptions.body = JSON.stringify(requestBody);
        const response = await fetch(apiUrl, fetchOptions);

        if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            let errorMessage = errorBody.error?.message || JSON.stringify(errorBody) || `HTTP ошибка! Статус: ${response.status}`;
            const isKeyError = response.status === 400 && /API_KEY|INVALID_ARGUMENT/i.test(errorMessage.toUpperCase());
            throw new Error(errorMessage, { cause: { isKeyError } });
        }
        
        const data = await response.json();
        let aiResponseText = "";
        if (isMapruappProxy) aiResponseText = data.choices?.[0]?.message?.content;
        else if (currentApiType === 'gemini') aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        else if (currentApiType === 'anthropic') aiResponseText = data.content?.[0]?.text;

        if (!aiResponseText) {
            throw new Error(`Не удалось сгенерировать ответ. Причина: ${data.promptFeedback?.blockReason || 'Ответ был заблокирован или пуст.'}`);
        }
        return aiResponseText;
    }

    // --- UI & STATE MANAGEMENT ---
    const startNewAnalysis = () => {
        if (isLoading && controller) controller.abort();
        isLoading = false;
        controller = null;
        conversationHistory = [];
        lastExtractedLinks = [];
        lastRawHtml = null;
        lastTableData = null;
        
        responseContainer.innerHTML = welcomeMessageHTML;
        responseActions.style.display = 'none';
        exportButtons.classList.remove('show');
        queryInput.value = '';
        queryInput.style.height = 'auto';
        queryInput.disabled = false;
        sendButton.disabled = false;
    };

    const updateUIOnRequestStart = () => {
        const oldBtnContainer = document.getElementById('source-code-button-container');
        if (oldBtnContainer) oldBtnContainer.remove();
        
        queryInput.value = '';
        queryInput.style.height = 'auto';
        queryInput.disabled = true;
        sendButton.disabled = true;
        responseActions.style.display = 'none';
        exportButtons.classList.remove('show');
    };

    const getLoaderHTML = (text) => {
        const html = `<div class="loader"><i class="fa-solid fa-flask-vial loader-icon"></i><p>${text}</p><button id="cancel-btn">Отменить</button></div>`;
        setTimeout(() => {
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => { if(controller) controller.abort(); });
        }, 0);
        return html;
    };
  
    const getFriendlyErrorHTML = (errorMsg, isKeyError = false) => {
        let keyInfo = isKeyError ? `<p style="margin-top:10px;"><small>Похоже, проблема в API-ключе.</small></p>` : '';
        let buttonHTML = isKeyError
            ? `<button class="action-btn" id="check-settings-btn" style="background-color: var(--new-chat-color); margin-top: 20px;"><i class="fa-solid fa-key"></i> Проверить настройки</button>`
            : `<button class="action-btn" id="retry-btn" style="background-color: var(--primary-color); margin-top: 20px;"><i class="fa-solid fa-rotate-right"></i> Начать заново</button>`;
        setTimeout(() => {
            const checkSettingsBtn = document.getElementById('check-settings-btn');
            const retryBtn = document.getElementById('retry-btn');
            if (checkSettingsBtn) checkSettingsBtn.addEventListener('click', openSettingsModal);
            if (retryBtn) retryBtn.addEventListener('click', startNewAnalysis);
        }, 0);
        return `<div class="welcome-message" style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation fa-2x"></i><h3 style="color: var(--danger-color); border: none; margin-top:15px;">Ошибка анализа</h3><p>${errorMsg}</p>${keyInfo}${buttonHTML}</div>`;
    };
    
    const API_MODES = { 
        'mapruapp': { uiName: 'Прокси (MapRuApp)', icon: '<i class="fa-solid fa-server icon"></i>' }, 
        'proxy': { uiName: 'Прокси (Vercel)', icon: '<i class="fa-solid fa-cloud icon"></i>' }, 
        'direct': { uiName: 'Прямой (Gemini)', icon: '<i class="fa-solid fa-key icon"></i>' } 
    };
    
    const openSettingsModal = () => { 
        const apiModeSelector = originalApiControlsParent.querySelector('.api-mode-selector-container'); 
        if (apiModeSelector) modalApiControlsPlaceholder.appendChild(apiModeSelector); 
        settingsModalOverlay.style.display = 'flex'; 
    };
    
    const closeSettingsModal = () => { 
        const apiModeSelector = modalApiControlsPlaceholder.querySelector('.api-mode-selector-container'); 
        if (apiModeSelector) originalApiControlsParent.appendChild(apiModeSelector);
        settingsModalOverlay.style.display = 'none'; 
    };
    
    const updateApiKeyInputVisibility = () => { 
        apiKeyInputGroup.style.display = (currentApiMode === 'direct' && currentApiType === 'gemini') ? 'block' : 'none'; 
    };
    
    const updateSettingsUI = () => {
        const settingsBtn = document.getElementById('settings-btn');
        if (!settingsBtn) return;
        const cogIcon = settingsBtn.querySelector('.fa-cog');
        const keyIcon = settingsBtn.querySelector('.fa-key');
        const isDirect = currentApiMode === 'direct';
        const selectedModel = MODELS.find(m => m.id === currentModelId) || MODELS[0];
        let colorVar;
        if(currentApiType === 'anthropic') { colorVar = '--settings-color-claude'; } 
        else if (isDirect) { colorVar = selectedModel.tier === 'standard' ? '--settings-color-direct-standard' : '--settings-color-direct-lite'; } 
        else { colorVar = selectedModel.tier === 'standard' ? '--settings-color-proxy-standard' : '--settings-color-proxy-lite'; }
        settingsBtn.style.color = `var(${colorVar})`;
        if (cogIcon && keyIcon) { 
            cogIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'none' : 'inline-block'; 
            keyIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'inline-block' : 'none'; 
        }
        const modelName = selectedModel.uiName.split('(')[0].trim();
        const modeName = API_MODES[currentApiMode]?.uiName || 'Неизвестно';
        settingsBtn.title = `Настройки (${modelName}, ${modeName})`;
        const mode = API_MODES[currentApiMode];
        if (mode && apiModeSelectorButton) apiModeSelectorButton.innerHTML = `${mode.icon}<span class="text">${mode.uiName}</span>`; 
        document.querySelectorAll('.api-mode-option').forEach(option => { 
            option.style.display = (option.dataset.apiMode === 'direct' && currentApiType !== 'gemini') ? 'none' : 'flex'; 
        });
        if (currentApiType !== 'gemini' && currentApiMode === 'direct') { 
            currentApiMode = 'proxy'; 
            localStorage.setItem('analystApiMode', currentApiMode); 
            updateSettingsUI(); 
        }
        updateApiKeyInputVisibility();
    };
    
    const saveSettings = () => {
        const key = apiKeyInput.value.trim();
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];
        currentModelId = selectedOption.value;
        currentApiType = selectedOption.dataset.apiType;
        currentPageScraperService = pageScraperSelector.value;
        localStorage.setItem('analystPageScraperService', currentPageScraperService);
        if (currentApiType === 'gemini' && currentApiMode === 'direct' && !key) {
            return alert('Для режима "Прямой (Gemini)" необходимо ввести API ключ.');
        }
        apiKey = key;
        localStorage.setItem('analystApiKey', key);
        localStorage.setItem('analystModelId', currentModelId);
        localStorage.setItem('analystApiMode', currentApiMode);
        closeSettingsModal();
        updateSettingsUI();
    };
    
    const loadSettings = () => {
        apiKey = localStorage.getItem('analystApiKey') || '';
        apiKeyInput.value = apiKey;
        const savedModelId = localStorage.getItem('analystModelId') || DEFAULT_MODEL_ID;
        currentModelId = modelSelector.querySelector(`option[value="${savedModelId}"]`) ? savedModelId : DEFAULT_MODEL_ID;
        modelSelector.value = currentModelId;
        const savedApiMode = localStorage.getItem('analystApiMode');
        currentApiMode = API_MODES[savedApiMode] ? savedApiMode : 'mapruapp';
        currentPageScraperService = localStorage.getItem('analystPageScraperService') || 'vercel';
        pageScraperSelector.value = currentPageScraperService;
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];
        if(selectedOption) currentApiType = selectedOption.dataset.apiType;
        updateSettingsUI();
    };
    
    const populateApiModeOptions = () => {
        apiModeOptions.innerHTML = '';
        Object.keys(API_MODES).forEach(modeId => {
            const mode = API_MODES[modeId];
            const option = document.createElement('li');
            option.className = 'api-mode-option';
            option.dataset.apiMode = modeId;
            option.innerHTML = `${mode.icon} <span>${mode.uiName}</span>`;
            option.addEventListener('click', () => {
                currentApiMode = modeId;
                document.querySelectorAll('.api-mode-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                apiModeOptions.style.display = 'none';
                updateSettingsUI();
            });
            apiModeOptions.appendChild(option);
        });
    };
    
    const copyResponse = () => { 
        navigator.clipboard.writeText(responseContainer.innerText)
            .then(() => alert('Текст скопирован.'))
            .catch(err => console.error('Ошибка копирования: ', err)); 
    };
    
    const printResponse = () => window.print();
    
    initializeApp();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä XML</title>
    <link rel="icon" href="img/kpt11.png" type="image/png">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #0078d4;
            --primary-hover: #106ebe;
            --primary-light: #deecf9;
            --primary-bg: #f3f9fd;
            --success-color: #107c10;
            --success-bg: #dff6dd;
            --danger-color: #d13438;
            --danger-bg: #fde7e9;
            --light-bg: #faf9f8;
            --text-color: #323130;
            --text-light: #605e5c;
            --border-color: #edebe9;
            --border-light: #e1dfdd;
            --border-radius: 8px;
            --box-shadow: 0 1.6px 3.6px 0 rgba(0,0,0,.132), 0 0.3px 0.9px 0 rgba(0,0,0,.108);
            --box-shadow-hover: 0 6.4px 14.4px 0 rgba(0,0,0,.132), 0 1.2px 3.6px 0 rgba(0,0,0,.108);
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            text-align: center;
            margin: 20px;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 600;
        }

        .subtitle {
            color: var(--text-light);
            margin-bottom: 40px;
            font-size: 16px;
        }

        .stage {
            display: none;
            margin-top: 25px;
        }

        .stage.active {
            display: block;
        }

        .upload-area {
            position: relative;
            border: 2px dashed var(--border-light);
            border-radius: var(--border-radius);
            padding: 60px 40px;
            background: var(--light-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--primary-bg);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--primary-light);
            transform: scale(1.02);
            box-shadow: var(--box-shadow-hover);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 24px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon,
        .upload-area.dragover .upload-icon {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .upload-icon svg {
            width: 32px;
            height: 32px;
            fill: var(--primary-color);
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon svg,
        .upload-area.dragover .upload-icon svg {
            fill: #ffffff;
        }

        .upload-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .upload-text .highlight {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .upload-hint {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .file-types {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }

        .file-type {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-type::before {
            content: "üìÑ";
            font-size: 14px;
        }

        .encoding-selector {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: var(--light-bg);
            border-radius: var(--border-radius);
        }

        .encoding-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .encoding-selector select {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            min-width: 200px;
            transition: border-color 0.2s ease;
        }

        .encoding-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        input[type="file"] {
            display: none;
        }

        #options-stage h2 {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: left;
            color: var(--text-color);
            font-weight: 600;
        }

        .file-info {
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .file-info .file-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .file-info .file-details {
            font-size: 14px;
            color: var(--text-light);
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        .options-list li {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .options-list li:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
            transform: translateX(4px);
        }
        
        #conversion-info {
            text-align: left;
            margin-bottom: 24px;
            font-size: 16px;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }

        .custom-checkbox input {
            display: none;
        }

        .custom-checkbox .checkmark {
            min-width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 16px;
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .custom-checkbox .checkmark::after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .custom-checkbox input:checked ~ .checkmark::after {
            display: block;
        }

        .custom-checkbox .label-text {
            font-weight: 500;
            flex: 1;
        }

        .custom-checkbox .count {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.4);
        }

        .btn-secondary {
            background-color: #ffffff;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--light-bg);
            border-color: var(--primary-color);
        }

        #result-content {
            padding: 24px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
        }

        #result-content.success {
            background-color: var(--success-bg);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        #result-content.error {
            background-color: var(--danger-bg);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        #result-content p {
            margin: 0 0 16px;
            font-weight: 600;
            font-size: 16px;
        }

        #result-content .success-icon,
        #result-content .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        #loader {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border-light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            .upload-area { padding: 40px 20px; }
            .actions { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä XML</h1>
        <p class="subtitle">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ 7/8/9/10 –∏ 11</p>
        
        <div id="upload-stage" class="stage active">
            <input type="file" id="fileInput" accept=".xml,.zip">
            <label for="fileInput" class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                </div>
                <div class="upload-text">
                    <span class="highlight">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span> –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ
                </div>
                <div class="file-types">
                    <div class="file-type">XML –∏–ª–∏ ZIP —Ñ–∞–π–ª—ã (–≤—ã–ø–∏—Å–∫–∏ –∏ –ö–ü–¢)</div>
                </div>
            </label>
            
            <div class="encoding-selector">
                <label for="encodingSelector">–ö–æ–¥–∏—Ä–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:</label>
                <select id="encodingSelector">
                    <option value="UTF-8">UTF-8</option>
                    <option value="windows-1251">Windows-1251</option>
                </select>
            </div>
        </div>

        <div id="options-stage" class="stage">
            <h2 id="options-title">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h2>
            <div class="file-info">
                <div class="file-name" id="fileName"></div>
                <div class="file-details" id="fileDetails"></div>
            </div>
            <div id="conversion-info"></div>
            <ul id="optionsList" class="options-list"></ul>
            <div class="actions">
                <button id="resetButton" class="btn btn-secondary">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                <button id="convertButton" class="btn btn-primary">üöÄ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div id="result-stage" class="stage">
            <div id="loader">
                <div class="spinner"></div>
                <div class="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
            </div>
            <div id="result-content"></div>
            <div class="actions" style="justify-content: center; margin-top: 30px;">
                <button id="backToOptionsButton" class="btn btn-secondary" style="display: none;">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É</button>
                <button id="startOverButton" class="btn btn-primary">üìÅ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</button>
            </div>
        </div>
    </div>
  <script src="cb.js"></script> 
<script>
let currentXmlDoc = null;
let currentFileName = '';
let conversionDirection = null;
let sourceVersion = null;

const stages = {
    upload: document.getElementById('upload-stage'),
    options: document.getElementById('options-stage'),
    result: document.getElementById('result-stage')
};

const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');
const optionsList = document.getElementById('optionsList');
const fileName = document.getElementById('fileName');
const fileDetails = document.getElementById('fileDetails');
const convertButton = document.getElementById('convertButton');
const resetButton = document.getElementById('resetButton');
const startOverButton = document.getElementById('startOverButton');
const loader = document.getElementById('loader');
const resultContent = document.getElementById('result-content');
const encodingSelector = document.getElementById('encodingSelector');
const optionsTitle = document.getElementById('options-title');
const conversionInfo = document.getElementById('conversion-info');
const backToOptionsButton = document.getElementById('backToOptionsButton');

const OBJECT_TYPES = {
    parcels: { label: '–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏', selector: 'land_record', prefix: 'zu' },
    buildings: { label: '–ó–¥–∞–Ω–∏—è', selector: 'build_record', prefix: 'oks' },
    constructions: { label: '–°–æ–æ—Ä—É–∂–µ–Ω–∏—è', selector: 'construction_record', prefix: 'cons' },
    bounds: { label: '–ì—Ä–∞–Ω–∏—Ü—ã (–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–µ, –Ω.–ø.)', selector: 'municipal_boundary_record, inhabited_locality_boundary_record', prefix: 'bounds' },
    zones: { label: '–ó–æ–Ω—ã –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', selector: 'zones_and_territories_record', prefix: 'zones' }
};

fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
uploadArea.addEventListener('drop', handleFileDrop, false);
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, preventDefaults, false));
['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false));
['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false));
convertButton.addEventListener('click', handleConversion);
resetButton.addEventListener('click', resetApp);
startOverButton.addEventListener('click', resetApp);
backToOptionsButton.addEventListener('click', () => updateUIState('options'));

function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
function updateUIState(activeStage) {
    Object.values(stages).forEach(stage => stage.classList.remove('active'));
    if (stages[activeStage]) stages[activeStage].classList.add('active');
}

function resetApp() {
    currentXmlDoc = null;
    currentFileName = '';
    conversionDirection = null;
    sourceVersion = null; 
    fileInput.value = '';
    resultContent.innerHTML = '';
    resultContent.className = '';
    backToOptionsButton.style.display = 'none'; 
    updateUIState('upload');
}

function handleFileDrop(e) { fileInput.files = e.dataTransfer.files; handleFileSelect(e.dataTransfer.files); }
function handleFileSelect(files) {
    if (files.length === 0) return;
    if (currentFileName === files[0].name && currentXmlDoc) return;
    const file = files[0]; currentFileName = file.name;
    showLoaderWithMessage(`–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: ${file.name}`);
    if (file.name.toLowerCase().endsWith('.zip')) { handleZipFile(file); } else { handleXmlFile(file); }
}
function handleZipFile(file) {
    const encoding = encodingSelector.value;
    JSZip.loadAsync(file).then(zip => {
        const xmlFile = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith('.xml'));
        if (xmlFile) return xmlFile.async("blob");
        throw new Error("XML-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ZIP-–∞—Ä—Ö–∏–≤–µ.");
    }).then(blob => {
        const reader = new FileReader();
        reader.onload = e => processXmlString(e.target.result);
        reader.onerror = () => showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å XML –∏–∑ ZIP.');
        reader.readAsText(blob, encoding);
    }).catch(error => showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ZIP: ${error.message}`));
}
function handleXmlFile(file) {
    const encoding = encodingSelector.value;
    const reader = new FileReader();
    reader.onload = (event) => processXmlString(event.target.result);
    reader.onerror = () => showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å XML-—Ñ–∞–π–ª.');
    reader.readAsText(file, encoding);
}

function processXmlString(xmlString) {
    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
        const parserError = xmlDoc.querySelector("parsererror");
        
        if (parserError) {
            throw new Error(`–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ XML: ${parserError.textContent}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É.`);
        }
        
        currentXmlDoc = xmlDoc;
        const root = xmlDoc.documentElement;
        const rootNS = root.namespaceURI || '';

        if (root.tagName.startsWith('extract_')) {
            conversionDirection = '11to10';
            sourceVersion = 11;
            setupOptionsFor11to10(xmlDoc);
        } 
        else if (root.tagName === 'KPT' && rootNS.includes('kpt/10')) {
            conversionDirection = '10to11';
            sourceVersion = 10;
            setupOptionsFor10to11(xmlDoc);
        }
        else if (root.tagName === 'KPT' && rootNS.includes('kpt/9')) {
            conversionDirection = '10to11';
            sourceVersion = 9;
            setupOptionsFor10to11(xmlDoc);
        }
        else if (root.tagName === 'Region_Cadastr' && root.getAttribute('Version') === '08') {
             conversionDirection = '10to11';
             sourceVersion = 8;
             setupOptionsFor10to11(xmlDoc);
        }
        // –ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è 7-–π –≤–µ—Ä—Å–∏–∏
        else if (root.tagName === 'Region_Cadastr' && root.querySelector('eDocument')?.getAttribute('Version') === '07') {
             conversionDirection = '10to11';
             sourceVersion = 7;
             setupOptionsFor10to11(xmlDoc);
        }
        else {
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é XML —Ñ–∞–π–ª–∞. –ö–æ—Ä–Ω–µ–≤–æ–π —Ç–µ–≥ "${root.tagName}" –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º —Ñ–æ—Ä–º–∞—Ç–∞–º (–ö–ü–¢ v.7/8/9/10 –∏–ª–∏ –≤—ã–ø–∏—Å–∫–∏ v.11).`);
        }

    } catch (error) {
        showError(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

function setupOptionsFor11to10(xmlDoc) {
    optionsTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏';
    conversionInfo.innerHTML = `<strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> XML v.11 ‚ûî XML v.10`;
    optionsList.style.display = 'block';
    analyzeAndDisplayOptions(xmlDoc);
}


function setupOptionsFor10to11(xmlDoc) {
    optionsTitle.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏';
    conversionInfo.innerHTML = `<strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> XML –ö–ü–¢ v.${sourceVersion} ‚ûî XML v.11`;
    optionsList.innerHTML = '';
    optionsList.style.display = 'none';
    const totalObjects = xmlDoc.querySelectorAll('Parcel, Building, Construction, Bound, Zone').length;
    fileName.textContent = currentFileName;
    fileDetails.textContent = `–ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${totalObjects}`;
    backToOptionsButton.style.display = 'none';
    updateUIState('options');
}

function analyzeAndDisplayOptions(xmlDoc) {
    optionsList.innerHTML = '';
    let hasObjects = false; let totalObjects = 0;
    Object.entries(OBJECT_TYPES).forEach(([key, config]) => {
        const count = xmlDoc.querySelectorAll(config.selector).length;
        totalObjects += count;
        if (count > 0) {
            hasObjects = true;
            const listItem = document.createElement('li');
            listItem.innerHTML = `<label class="custom-checkbox"><input type="checkbox" data-type="${key}" checked><span class="checkmark"></span><span class="label-text">${config.label}</span><span class="count">${count}</span></label>`;
            optionsList.appendChild(listItem);
        }
    });
    if (!hasObjects) { showError('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.'); return; }
    fileName.textContent = currentFileName;
    fileDetails.textContent = `–ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${totalObjects}`;
    const isKptFile = xmlDoc.querySelectorAll('cadastral_block').length > 0;
    backToOptionsButton.style.display = isKptFile ? 'inline-flex' : 'none';
    updateUIState('options');
}

function handleConversion() {
    if (!currentXmlDoc) { showError('XML –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.'); return; }
    updateUIState('result');
    loader.style.display = 'block';
    resultContent.style.display = 'none';
    
    setTimeout(() => {
        try {
            let newXmlString, downloadFileName;

            if (conversionDirection === '11to10') {
                const selection = {};
                optionsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => { selection[checkbox.dataset.type] = checkbox.checked; });
                newXmlString = convertXml11to10(currentXmlDoc, selection);
                const isKptFile = currentXmlDoc.querySelectorAll('cadastral_block').length > 0;
                let numForFileName;
                if (isKptFile) {
                    numForFileName = currentXmlDoc.querySelector('cadastral_block > cadastral_number')?.textContent || 'unknown';
                } else {
                    numForFileName = currentXmlDoc.querySelector('object common_data cad_number')?.textContent || currentXmlDoc.querySelector('quarter_cad_number')?.textContent || 'unknown';
                }
                downloadFileName = generateFileName11to10(numForFileName, selection, isKptFile);
                 showSuccess(downloadFileName, 11, 10); // –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Ä—Å–∏–∏
              } else if (conversionDirection === '10to11') {
                newXmlString = convertXml10to11(currentXmlDoc);
                const cadNum = currentXmlDoc.querySelector('Cadastral_Block, CadastralBlock')?.getAttribute('CadastralNumber') || 'unknown';
                downloadFileName = `KPT_${cadNum.replace(/:/g, '_')}_v11 (–∏–∑ v${sourceVersion}).xml`;
                showSuccess(downloadFileName, sourceVersion, 11);
            }  else {
                throw new Error("–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.");
            }

            const blob = new Blob([newXmlString], { type: 'application/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = downloadFileName; document.body.appendChild(a);
            a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            
        } catch (error) {
            console.error(error);
            showError(`–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }, 100);
}

function generateFileName11to10(cadNum, selection, isKptFile) {
    const cleanedCadNum = cadNum.replace(/:/g, '_');
    if (isKptFile) {
        const baseName = `KPT_${cleanedCadNum}`;
        const selectedTypes = Object.entries(selection).filter(([key, isSelected]) => isSelected && OBJECT_TYPES[key]).map(([key]) => OBJECT_TYPES[key].prefix);
        const allSelected = Object.keys(selection).every(type => selection[type] !== false);
        if (!allSelected && selectedTypes.length > 0) return `${baseName}_${selectedTypes.join('_')}_v10.xml`;
        return `${baseName}_v10.xml`;
    } else {
        const selectedTypes = Object.entries(selection).filter(([key, isSelected]) => isSelected && OBJECT_TYPES[key]).map(([key]) => OBJECT_TYPES[key].prefix);
        const prefix = (selectedTypes.length > 0 ? selectedTypes[0] : 'EXTRACT').toUpperCase();
        return `${prefix}_${cleanedCadNum}_v10.xml`;
    }
}
function showLoaderWithMessage(message) {
    updateUIState('result'); loader.style.display = 'block';
    loader.querySelector('.loading-text').textContent = message;
    resultContent.style.display = 'none';
}
function showSuccess(fileName, fromVersion, toVersion) {
    let message = '–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'; 
    if (fromVersion && toVersion) {
        message = `–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ ${fromVersion} –≤–µ—Ä—Å–∏–∏ –≤ ${toVersion} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!`;
    }
    
    resultContent.className = 'success';
    resultContent.innerHTML = `
        <span class="success-icon">‚úÖ</span>
        <p>${message}</p>
        <p>–§–∞–π–ª <strong>${fileName}</strong> —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...</p>
    `;
    resultContent.style.display = 'block';
}
function showError(message) {
    updateUIState('result'); loader.style.display = 'none';
    resultContent.className = 'error';
    resultContent.innerHTML = `<span class="error-icon">‚ùå</span><p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!</p><p>${message}</p>`;
    resultContent.style.display = 'block';
}

// =======================================================================
// ==================== CONVERSION LOGIC 11 -> 10 ========================
// =======================================================================
const NS_V10 = { KPT: "urn://x-artefacts-rosreestr-ru/outgoing/kpt/10.0.1", ADR: "urn://x-artefacts-rosreestr-ru/commons/complex-types/address-output/4.0.1", SPATIAL: "urn://x-artefacts-rosreestr-ru/commons/complex-types/entity-spatial/5.0.1", OKS: "urn://x-artefacts-rosreestr-ru/commons/complex-types/parameters-oks/2.0.1", CERT: "urn://x-artefacts-rosreestr-ru/commons/complex-types/certification-doc/1.0", DOC: "urn://x-artefacts-rosreestr-ru/commons/complex-types/document-output/4.0.1", SMEV: "urn://x-artefacts-smev-gov-ru/supplementary/commons/1.0.1" };
const getNodeValue = (parent, selector) => parent.querySelector(selector)?.textContent.trim() || '';
function convertXml11to10(oldDoc, selection) { const newDoc = document.implementation.createDocument(NS_V10.KPT, 'KPT', null); const root = newDoc.documentElement; root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns', NS_V10.KPT); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:adrOut4', NS_V10.ADR); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns3', NS_V10.SPATIAL); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns4', NS_V10.OKS); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns5', NS_V10.DOC); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns6', NS_V10.CERT); root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ns7', NS_V10.SMEV); const coordSystems = new Map(); const csCounter = { value: 1 }; const cadastralBlocks = createElement(newDoc, NS_V10.KPT, 'CadastralBlocks'); const oldBlocks = oldDoc.querySelectorAll('cadastral_block'); if (oldBlocks.length > 0) { oldBlocks.forEach(oldBlock => { const newBlock = createElement(newDoc, NS_V10.KPT, 'CadastralBlock'); newBlock.setAttribute('CadastralNumber', getNodeValue(oldBlock, 'cadastral_number')); const area = createElement(newDoc, NS_V10.KPT, 'Area'); area.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Total', getNodeValue(oldBlock, 'area_quarter area'))); area.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Unit', getNodeValue(oldBlock, 'area_quarter unit'))); newBlock.appendChild(area); if (selection.parcels) appendChildIfNotEmpty(newBlock, convertParcels11to10(oldBlock, newDoc, coordSystems, csCounter)); if (selection.buildings || selection.constructions) appendChildIfNotEmpty(newBlock, convertObjectsRealty11to10(oldBlock, newDoc, coordSystems, csCounter, selection)); if (selection.bounds) appendChildIfNotEmpty(newBlock, convertBounds11to10(oldBlock, newDoc, coordSystems, csCounter)); if (selection.zones) appendChildIfNotEmpty(newBlock, convertZones11to10(oldBlock, newDoc, coordSystems, csCounter)); appendChildIfNotEmpty(newBlock, convertSpatialData11to10(oldBlock, newDoc, coordSystems, csCounter)); cadastralBlocks.appendChild(newBlock); }); } else { const quarterNum = getNodeValue(oldDoc, 'quarter_cad_number'); if (!quarterNum) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞ –≤ –≤—ã–ø–∏—Å–∫–µ (—Ç–µ–≥ quarter_cad_number –Ω–µ –Ω–∞–π–¥–µ–Ω).'); const newBlock = createElement(newDoc, NS_V10.KPT, 'CadastralBlock'); newBlock.setAttribute('CadastralNumber', quarterNum); if (selection.parcels) appendChildIfNotEmpty(newBlock, convertParcels11to10(oldDoc, newDoc, coordSystems, csCounter)); if (selection.buildings || selection.constructions) appendChildIfNotEmpty(newBlock, convertObjectsRealty11to10(oldDoc, newDoc, coordSystems, csCounter, selection)); if (selection.bounds) appendChildIfNotEmpty(newBlock, convertBounds11to10(oldDoc, newDoc, coordSystems, csCounter)); if (selection.zones) appendChildIfNotEmpty(newBlock, convertZones11to10(oldDoc, newDoc, coordSystems, csCounter)); appendChildIfNotEmpty(newBlock, convertSpatialData11to10(oldDoc, newDoc, coordSystems, csCounter)); cadastralBlocks.appendChild(newBlock); } root.appendChild(cadastralBlocks); root.appendChild(createCoordSystemsNode11to10(newDoc, coordSystems)); root.appendChild(createCertificationDocNode11to10(oldDoc, newDoc)); const serializer = new XMLSerializer(); let xmlString = serializer.serializeToString(newDoc); const styleSheet = '<?xml-stylesheet type="text/xsl" href="https://portal.rosreestr.ru/xsl/GKN/KPT_b/10/common.xsl"?>'; return `<?xml version="1.0" encoding="UTF-8"?>\n${styleSheet}\n` + xmlString; }
function appendChildIfNotEmpty(parent, child) { if (child && child.hasChildNodes()) parent.appendChild(child); }
function createElement(doc, ns, qualifiedName) { return doc.createElementNS(ns, qualifiedName); }
function createElementWithText(doc, ns, qualifiedName, text) { const el = createElement(doc, ns, qualifiedName); if (text) el.textContent = text; return el; }
function createCertificationDocNode11to10(oldDoc, newDoc) { const certDoc = createElement(newDoc, NS_V10.KPT, 'CertificationDoc'); const statement = oldDoc.querySelector('details_statement'); if (!statement) return certDoc; certDoc.appendChild(createElementWithText(newDoc, NS_V10.CERT, 'ns6:Organization', getNodeValue(statement, 'organ_registr_rights'))); certDoc.appendChild(createElementWithText(newDoc, NS_V10.CERT, 'ns6:Date', getNodeValue(statement, 'date_formation'))); certDoc.appendChild(createElementWithText(newDoc, NS_V10.CERT, 'ns6:Number', getNodeValue(statement, 'registration_number'))); return certDoc; }
function createAddressNode11to10(oldAddress, newDoc) {
    const locationNode = createElement(newDoc, NS_V10.KPT, 'Location');
    if (!oldAddress) return locationNode;
    
    const address = createElement(newDoc, NS_V10.KPT, 'Address');
    locationNode.appendChild(address);

    const addressTypeCode = getNodeValue(oldAddress, 'address_type code');
    if (addressTypeCode === '01') { // –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π
        address.setAttribute('adrOut4:AddressOrLocation', '1');
    } else if (addressTypeCode === '02') { // –û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π
        address.setAttribute('adrOut4:AddressOrLocation', '0');
    }

    const addrSource = oldAddress.querySelector('address, location');
    if (!addrSource) return locationNode;

    const createAdrEl = (name, val) => !val ? null : createElementWithText(newDoc, NS_V10.ADR, `adrOut4:${name}`, val);
    const createAdrElWithAttr = (name, attrs) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –Ω–µ–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö
        if (!Object.values(attrs).some(v => v)) return null;
        const el = createElement(newDoc, NS_V10.ADR, `adrOut4:${name}`);
        Object.entries(attrs).forEach(([key, value]) => value && el.setAttribute(key, value));
        return el;
    };
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º "—Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ" –≤ "—Å/—Å" –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    let sovietVillageType = getNodeValue(addrSource, 'soviet_village type_soviet_village');
    if (sovietVillageType && sovietVillageType.toLowerCase() === '—Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ') {
        sovietVillageType = '—Å/—Å';
    }

    const elements = [
        createAdrEl('OKATO', getNodeValue(addrSource, 'okato')),
        createAdrEl('KLADR', getNodeValue(addrSource, 'kladr')),
        createAdrEl('OKTMO', getNodeValue(addrSource, 'oktmo')), // –î–æ–±–∞–≤–ª–µ–Ω –û–ö–¢–ú–û
        createAdrEl('PostalCode', getNodeValue(addrSource, 'postal_code')),
        createAdrEl('Region', getNodeValue(addrSource, 'region code')),
        createAdrElWithAttr('District', { Type: getNodeValue(addrSource, 'district type_district'), Name: getNodeValue(addrSource, 'district name_district') }),
        createAdrElWithAttr('City', { Type: getNodeValue(addrSource, 'city type_city'), Name: getNodeValue(addrSource, 'city name_city') }),
        // –î–æ–±–∞–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–µ–ª—å—Å–∫–æ–≥–æ –ø–æ—Å–µ–ª–µ–Ω–∏—è/—Å–µ–ª—å—Å–æ–≤–µ—Ç–∞
        createAdrElWithAttr('SovietVillage', { Type: sovietVillageType, Name: getNodeValue(addrSource, 'soviet_village name__soviet_village') }),
        createAdrElWithAttr('Street', { Type: getNodeValue(addrSource, 'street type_street'), Name: getNodeValue(addrSource, 'street name_street') }),
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
        // –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ 'type_level1' –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ Type
        createAdrElWithAttr('Level1', { Type: getNodeValue(addrSource, 'level1 type_level1'), Value: getNodeValue(addrSource, 'level1 name_level1') }),
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
        createAdrEl('Note', getNodeValue(oldAddress, 'readable_address'))
    ];

    elements.forEach(el => el && address.appendChild(el));
    return locationNode;
}


function createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter) {const entSpatial = createElement(newDoc, NS_V10.KPT, 'EntitySpatial');if (!oldSpatial) return entSpatial;const csId = getNodeValue(oldSpatial, 'sk_id') || 'UNKNOWN_CS';let sysId = coordSystems.get(csId);if (!sysId) { sysId = `ID${csCounter.value++}`; coordSystems.set(csId, sysId); }entSpatial.setAttribute('EntSys', sysId);const spatialElements = oldSpatial.querySelectorAll('contour > entity_spatial > spatials_elements > spatial_element, spatials_elements > spatial_element');spatialElements.forEach(oldElement => {const spatialElementNode = createElement(newDoc, NS_V10.SPATIAL, 'ns3:SpatialElement');oldElement.querySelectorAll(':scope > ordinates > ordinate').forEach(ord => {const suNmb = getNodeValue(ord, 'ord_nmb') || getNodeValue(ord, 'number_pp');const spelementUnit = createElement(newDoc, NS_V10.SPATIAL, 'ns3:SpelementUnit');spelementUnit.setAttribute('TypeUnit', '–¢–æ—á–∫–∞');if (suNmb) spelementUnit.setAttribute('SuNmb', suNmb);const ordinate = createElement(newDoc, NS_V10.SPATIAL, 'ns3:Ordinate');ordinate.setAttribute('X', getNodeValue(ord, 'x'));ordinate.setAttribute('Y', getNodeValue(ord, 'y'));ordinate.setAttribute('OrdNmb', '1');const numGeopoint = getNodeValue(ord, 'num_geopoint');if (numGeopoint) ordinate.setAttribute('NumGeopoint', numGeopoint);const delta = getNodeValue(ord, 'delta_geopoint');if (delta) ordinate.setAttribute('DeltaGeopoint', delta);const zacrep = getNodeValue(ord, 'geopoint_zacrep');if (zacrep && zacrep !== "-") { ordinate.setAttribute('GeopointZacrep', zacrep); } else if (!numGeopoint) { ordinate.setAttribute('GeopointZacrep', '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); }spelementUnit.appendChild(ordinate);spatialElementNode.appendChild(spelementUnit);});if (spatialElementNode.hasChildNodes()) entSpatial.appendChild(spatialElementNode);});return entSpatial;}
function createCoordSystemsNode11to10(newDoc, coordSystems) {const csNode = createElement(newDoc, NS_V10.KPT, 'CoordSystems');for (const [name, id] of coordSystems.entries()) {const system = createElement(newDoc, NS_V10.SPATIAL, 'ns3:CoordSystem');system.setAttribute('Name', name);system.setAttribute('CsId', id);csNode.appendChild(system);}return csNode;}
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è 11 -> 10 (–∏—Å–∫–ª—é—á–∞–µ–º —á–∞—Å—Ç–∏/sub_parcels) ---

function convertParcels11to10(dataSource, newDoc, coordSystems, csCounter) {
    const parcelsNode = createElement(newDoc, NS_V10.KPT, 'Parcels');
    
    dataSource.querySelectorAll('land_record').forEach(oldParcel => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ï–¥–∏–Ω–æ–µ –ó–µ–º–ª–µ–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–ï–ó–ü)
        const isUnifiedLandUseExtract = oldParcel.querySelector('object subtype code')?.textContent.trim() === '02' && oldParcel.querySelector('contours_location > contours > contour > cad_number');

        if (isUnifiedLandUseExtract) {
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –ï–ó–ü –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è
            const parentUnifiedCadNum = getNodeValue(oldParcel, 'object common_data cad_number');
            oldParcel.querySelectorAll('contours_location > contours > contour').forEach(contour => {
                const contourCadNumber = getNodeValue(contour, 'cad_number');
                if (!contourCadNumber) return;

                const newParcel = createElement(newDoc, NS_V10.KPT, 'Parcel');
                newParcel.setAttribute('CadastralNumber', contourCadNumber);
                newParcel.setAttribute('State', '01');
                newParcel.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Name', '03'));

                if (parentUnifiedCadNum) {
                    const parentNumbersNode = createElement(newDoc, NS_V10.KPT, 'ParentCadastralNumbers');
                    parentNumbersNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'CadastralNumber', parentUnifiedCadNum));
                    newParcel.appendChild(parentNumbersNode);
                }

                newParcel.appendChild(createAddressNode11to10(oldParcel.querySelector('address_location'), newDoc));
                newParcel.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Category', getNodeValue(oldParcel, 'params category type code')));
                
                const utilNode = createElement(newDoc, NS_V10.KPT, 'Utilization');
                utilNode.setAttribute('ByDoc', getNodeValue(oldParcel, 'params permitted_use by_document, params permitted_use permitted_use_established by_document'));
                newParcel.appendChild(utilNode);

                const costVal = getNodeValue(oldParcel, 'cost value');
                if (costVal) {
                    const costNode = createElement(newDoc, NS_V10.KPT, 'CadastralCost');
                    costNode.setAttribute('Value', costVal);
                    costNode.setAttribute('Unit', '383');
                    newParcel.appendChild(costNode);
                }

                const areaNode = createElement(newDoc, NS_V10.KPT, 'Area');
                areaNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Area', '0'));
                areaNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Unit', '055'));
                newParcel.appendChild(areaNode);

                const oldSpatial = contour.querySelector('entity_spatial');
                if (oldSpatial) {
                    newParcel.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));
                }
                parcelsNode.appendChild(newParcel);
            });

        } else {
            // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–ë–´–ß–ù–´–• –£–ß–ê–°–¢–ö–û–í ---
            const newParcel = createElement(newDoc, NS_V10.KPT, 'Parcel');
            newParcel.setAttribute('CadastralNumber', getNodeValue(oldParcel, 'object common_data cad_number'));
            newParcel.setAttribute('State', '01');
            
            const areaNode = createElement(newDoc, NS_V10.KPT, 'Area');
            areaNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Area', getNodeValue(oldParcel, 'params area value')));
            areaNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Unit', '055'));
            const inaccuracy = getNodeValue(oldParcel, 'params area inaccuracy');
            if (inaccuracy) areaNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Inaccuracy', inaccuracy));
            newParcel.appendChild(areaNode);

            const subtypeCode = getNodeValue(oldParcel, 'object subtype code');
            if (subtypeCode === '03') { 
                newParcel.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Name', subtypeCode));
                const parentCadNum = getNodeValue(oldParcel, 'cad_links common_land common_land_cad_number cad_number');
                if (parentCadNum) {
                    const parentNumbersNode = createElement(newDoc, NS_V10.KPT, 'ParentCadastralNumbers');
                    parentNumbersNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'CadastralNumber', parentCadNum));
                    newParcel.appendChild(parentNumbersNode);
                }
            } 
            else if (subtypeCode === '02' || getNodeValue(oldParcel, 'object subtype value').toLowerCase().includes('–∑–µ–º–ª–µ–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ')) {
                newParcel.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Name', '01'));
            }

            newParcel.appendChild(createAddressNode11to10(oldParcel.querySelector('address_location'), newDoc));
            newParcel.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Category', getNodeValue(oldParcel, 'params category type code')));
            
            const utilNode = createElement(newDoc, NS_V10.KPT, 'Utilization');
            utilNode.setAttribute('ByDoc', getNodeValue(oldParcel, 'params permitted_use by_document, params permitted_use permitted_use_established by_document'));
            newParcel.appendChild(utilNode);
            
            const costVal = getNodeValue(oldParcel, 'cost value');
            if (costVal) {
                const costNode = createElement(newDoc, NS_V10.KPT, 'CadastralCost');
                costNode.setAttribute('Value', costVal);
                costNode.setAttribute('Unit', '383');
                newParcel.appendChild(costNode);
            }
            
            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            // –ò—â–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –¢–û–õ–¨–ö–û —Å—Ä–µ–¥–∏ –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π, —á—Ç–æ–±—ã –Ω–µ –≤–∑—è—Ç—å entity_spatial –∏–∑ sub_parcels (—á–∞—Å—Ç–µ–π)
            let oldSpatial = null;
            
            // 1. –ò—â–µ–º contours_location (–æ–±—ã—á–Ω–æ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è)
            for (let i = 0; i < oldParcel.children.length; i++) {
                if (oldParcel.children[i].localName === 'contours_location') {
                    oldSpatial = oldParcel.children[i];
                    break;
                }
            }
            
            // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ contours, –∏—â–µ–º entity_spatial –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
            if (!oldSpatial) {
                for (let i = 0; i < oldParcel.children.length; i++) {
                    if (oldParcel.children[i].localName === 'entity_spatial') {
                        oldSpatial = oldParcel.children[i];
                        break;
                    }
                }
            }
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

            if (oldSpatial) newParcel.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));
            parcelsNode.appendChild(newParcel);
        }
    });
    return parcelsNode;
}

function convertObjectsRealty11to10(dataSource, newDoc, coordSystems, csCounter, selection) {
    const objectsNode = createElement(newDoc, NS_V10.KPT, 'ObjectsRealty');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
    const findDirectSpatial = (node) => {
        let spatial = null;
        for (let i = 0; i < node.children.length; i++) {
            if (node.children[i].localName === 'contours') {
                spatial = node.children[i]; 
                break;
            }
        }
        if (!spatial) {
            for (let i = 0; i < node.children.length; i++) {
                if (node.children[i].localName === 'entity_spatial') {
                    spatial = node.children[i]; 
                    break;
                }
            }
        }
        return spatial;
    };

    if (selection.buildings) {
        dataSource.querySelectorAll('build_record').forEach(oldBuild => {
            const objectRealty = createElement(newDoc, NS_V10.KPT, 'ObjectRealty');
            const building = createElement(newDoc, NS_V10.KPT, 'Building');
            building.setAttribute('CadastralNumber', getNodeValue(oldBuild, 'object common_data cad_number'));
            building.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'ObjectType', getNodeValue(oldBuild, 'object common_data type code')));
            building.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'AssignationBuilding', getNodeValue(oldBuild, 'params purpose code')));
            building.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Area', getNodeValue(oldBuild, 'params area')));
            
            const locationNode = createAddressNode11to10(oldBuild.querySelector('address_location'), newDoc);
            const addressNode = locationNode.querySelector('Address');
            if (addressNode) building.appendChild(addressNode);

            const cost = getNodeValue(oldBuild, 'cost value');
            if(cost) {
                const costNode = createElement(newDoc, NS_V10.KPT, 'CadastralCost');
                costNode.setAttribute('Value', cost); 
                costNode.setAttribute('Unit', '383');
                building.appendChild(costNode);
            }
            
            const oldSpatial = findDirectSpatial(oldBuild);
            if (oldSpatial) building.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));
            
            objectRealty.appendChild(building);
            objectsNode.appendChild(objectRealty);
        });
    }

    if (selection.constructions) {
        dataSource.querySelectorAll('construction_record').forEach(oldConstr => {
            const objectRealty = createElement(newDoc, NS_V10.KPT, 'ObjectRealty');
            const constr = createElement(newDoc, NS_V10.KPT, 'Construction');
            constr.setAttribute('CadastralNumber', getNodeValue(oldConstr, 'object common_data cad_number'));
            constr.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'ObjectType', getNodeValue(oldConstr, 'object common_data type code')));
            constr.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'AssignationName', getNodeValue(oldConstr, 'params purpose')));
            
            const extension = getNodeValue(oldConstr, 'base_parameters extension, params base_parameters base_parameter extension');
            if (extension) {
                const keyParams = createElement(newDoc, NS_V10.KPT, 'KeyParameters');
                const keyParam = createElement(newDoc, NS_V10.OKS, 'ns4:KeyParameter');
                keyParam.setAttribute('Type', '01');
                keyParam.setAttribute('Value', extension);
                keyParams.appendChild(keyParam);
                constr.appendChild(keyParams);
            }

            const locationNode = createAddressNode11to10(oldConstr.querySelector('address_location'), newDoc);
            const addressNode = locationNode.querySelector('Address');
            if (addressNode) constr.appendChild(addressNode);

            const cost = getNodeValue(oldConstr, 'cost value');
            if(cost) {
                const costNode = createElement(newDoc, NS_V10.KPT, 'CadastralCost');
                costNode.setAttribute('Value', cost); 
                costNode.setAttribute('Unit', '383');
                constr.appendChild(costNode);
            }
            
            const oldSpatial = findDirectSpatial(oldConstr);
            if (oldSpatial) constr.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));
            
            objectRealty.appendChild(constr);
            objectsNode.appendChild(objectRealty);
        });
    }
    return objectsNode;
}

function convertSpatialData11to10(dataSource, newDoc, coordSystems, csCounter) {const spatialNode = createElement(newDoc, NS_V10.KPT, 'SpatialData');const oldSpatial = dataSource.querySelector(':scope > spatial_data > entity_spatial');if (oldSpatial) spatialNode.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));return spatialNode;}
function convertBounds11to10(dataSource, newDoc, coordSystems, csCounter) {const boundsNode = createElement(newDoc, NS_V10.KPT, 'Bounds');dataSource.querySelectorAll('municipal_boundary_record, inhabited_locality_boundary_record').forEach(oldBoundRec => {const boundNode = createElement(newDoc, NS_V10.KPT, 'Bound');const bObject = oldBoundRec.querySelector('b_object');boundNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Description', getNodeValue(bObject, 'type_boundary value')));boundNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'AccountNumber', getNodeValue(bObject, 'reg_numb_border')));const boundaries = createElement(newDoc, NS_V10.KPT, 'Boundaries');const oldSpatial = oldBoundRec.querySelector('b_contours_location');if (oldSpatial) {const boundary = createElement(newDoc, NS_V10.KPT, 'Boundary');boundary.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));boundaries.appendChild(boundary);}appendChildIfNotEmpty(boundNode, boundaries);boundsNode.appendChild(boundNode);});return boundsNode;}
function convertZones11to10(dataSource, newDoc, coordSystems, csCounter) {const zonesNode = createElement(newDoc, NS_V10.KPT, 'Zones');dataSource.querySelectorAll('zones_and_territories_record').forEach(oldZoneRec => {const zoneNode = createElement(newDoc, NS_V10.KPT, 'Zone');const bObject = oldZoneRec.querySelector('b_object_zones_and_territories');zoneNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'Description', getNodeValue(bObject, 'type_boundary value')));zoneNode.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'AccountNumber', getNodeValue(bObject, 'b_object reg_numb_border')));const oldSpatial = oldZoneRec.querySelector('b_contours_location');if(oldSpatial) zoneNode.appendChild(createEntitySpatialNode11to10(oldSpatial, newDoc, coordSystems, csCounter));const specialZone = createElement(newDoc, NS_V10.KPT, 'SpecialZone');const content = `${getNodeValue(bObject, 'type_zone code')} ${getNodeValue(bObject, 'type_zone value')}`;specialZone.appendChild(createElementWithText(newDoc, NS_V10.KPT, 'ContentRestrictions', content.trim()));zoneNode.appendChild(specialZone);zonesNode.appendChild(zoneNode);});return zonesNode;}

// =======================================================================
// ==================== CONVERSION LOGIC 8/9/10 -> 11 ====================
// =======================================================================
const NS_V11 = { KPT: "urn://x-artefacts-rosreestr-ru/outgoing/kpt/11.1.0", EXTRACT_BASE: "urn://x-artefacts-rosreestr-ru/commons/extract-base/5.0.1", ADDRESS: "urn://x-artefacts-rosreestr-ru/commons/complex-types/address/2.0.1", SPATIAL: "urn://x-artefacts-rosreestr-ru/commons/complex-types/entity-spatial/2.0.1" };

// –î–æ–±–∞–≤–ª—è–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–µ–º–µ–ª—å
const CATEGORY_MAP = {
    '003001000000': '–ó–µ–º–ª–∏ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
    '003002000000': '–ó–µ–º–ª–∏ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤',
    '003003000000': '–ó–µ–º–ª–∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏, —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, —Å–≤—è–∑–∏, —Ä–∞–¥–∏–æ–≤–µ—â–∞–Ω–∏—è, —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏, –∑–µ–º–ª–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∑–µ–º–ª–∏ –æ–±–æ—Ä–æ–Ω—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∑–µ–º–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è',
    '003004000000': '–ó–µ–º–ª–∏ –æ—Å–æ–±–æ –æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤',
    '003005000000': '–ó–µ–º–ª–∏ –ª–µ—Å–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞',
    '003006000000': '–ó–µ–º–ª–∏ –≤–æ–¥–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞',
    '003007000000': '–ó–µ–º–ª–∏ –∑–∞–ø–∞—Å–∞',
    '003008000000': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'
};


function convertXml10to11(oldDoc) {
    const newDoc = document.implementation.createDocument(null, 'extract_cadastral_plan_territory', null);
    const root = newDoc.documentElement;
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns', NS_V11.KPT);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:base_e', NS_V11.EXTRACT_BASE);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:ad', NS_V11.ADDRESS);
    root.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:es', NS_V11.SPATIAL);

    const detailsStatement = newDoc.createElement('details_statement');
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π
    const certDoc = oldDoc.querySelector('Certification_Doc, CertificationDoc');
    const sender = oldDoc.querySelector('eDocument > Sender');
    const statement = oldDoc.querySelector('details_statement');

    if (certDoc) {
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'date_formation', getNodeValue(certDoc, 'Date')));
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'registration_number', getNodeValue(certDoc, 'Number')));
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'organ_registr_rights', getNodeValue(certDoc, 'Organization')));
    } else if (sender) {
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'date_formation', sender.getAttribute('Date_Upload')));
        // –í v7 –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ <eDocument>
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'organ_registr_rights', sender.getAttribute('Name')));
    } else if (statement) {
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'date_formation', getNodeValue(statement, 'date_formation')));
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'registration_number', getNodeValue(statement, 'registration_number')));
        detailsStatement.appendChild(createElementWithText(newDoc, null, 'organ_registr_rights', getNodeValue(statement, 'organ_registr_rights')));
    }
    
    if(detailsStatement.hasChildNodes()){
         root.appendChild(detailsStatement);
    }

    const cadastralBlocks = newDoc.createElement('cadastral_blocks');
    root.appendChild(cadastralBlocks);
    
    const coordSystemsMap = new Map();
    oldDoc.querySelectorAll('Coord_System, CoordSystems > *|CoordSystem').forEach(cs => {
        coordSystemsMap.set(cs.getAttribute('CsId') || cs.getAttribute('Cs_Id'), cs.getAttribute('Name'));
    });
    
    oldDoc.querySelectorAll('Cadastral_Block, CadastralBlock').forEach(oldBlock => {
        const newBlock = newDoc.createElement('cadastral_block');
        newBlock.appendChild(createElementWithText(newDoc, null, 'cadastral_number', oldBlock.getAttribute('CadastralNumber')));
        appendChildIfNotEmpty(newBlock, convertParcels10to11(oldBlock, newDoc, coordSystemsMap));
        appendChildIfNotEmpty(newBlock, convertObjectsRealty10to11(oldBlock, newDoc, coordSystemsMap));
        cadastralBlocks.appendChild(newBlock);
    });

    const serializer = new XMLSerializer();
    let xmlString = serializer.serializeToString(newDoc);
    return `<?xml version="1.0" encoding="UTF-8"?>\n` + xmlString;
}


function convertParcels10to11(oldBlock, newDoc, coordSystemsMap) {
    const recordContainer = newDoc.createElement('record_data');
    
    oldBlock.querySelectorAll('Parcel').forEach(oldParcel => {
        const landRecord = newDoc.createElement('land_record');
        const object = newDoc.createElement('object');
        const commonData = newDoc.createElement('common_data');
        
        const type = newDoc.createElement('type');
        type.appendChild(createElementWithText(newDoc, null, 'code', '002001001000'));
        type.appendChild(createElementWithText(newDoc, null, 'value', '–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫'));
        commonData.appendChild(type);

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–∞–¥–µ–∂–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π ---
        let parcelCadNum = oldParcel.getAttribute('CadastralNumber');
        if (parcelCadNum.startsWith(':')) {
            // –ò—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
            const block = oldParcel.closest('Cadastral_Block, CadastralBlock');
            const district = oldParcel.closest('Cadastral_District, CadastralDistrict');
            const region = oldParcel.closest('Cadastral_Region, CadastralRegion');
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            const prefix = block?.getAttribute('CadastralNumber') || 
                           district?.getAttribute('CadastralNumber') ||
                           region?.getAttribute('CadastralNumber') || 
                           '';
            parcelCadNum = prefix + parcelCadNum;
        }
        commonData.appendChild(createElementWithText(newDoc, null, 'cad_number', parcelCadNum));
        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        
        object.appendChild(commonData);
        landRecord.appendChild(object);

        const params = newDoc.createElement('params');
        const areaNode = oldParcel.querySelector('Area > Area, Areas > Area > Area');
        if (areaNode) {
            const area = newDoc.createElement('area');
            area.appendChild(createElementWithText(newDoc, null, 'value', areaNode.textContent.trim()));
            const inaccuracy = getNodeValue(oldParcel, 'Area > Inaccuracy, Area > Innccuracy, Areas > Area > Inaccuracy, Areas > Area > Innccuracy');
            if (inaccuracy) area.appendChild(createElementWithText(newDoc, null, 'inaccuracy', inaccuracy));
            params.appendChild(area);
        }
        
        const categoryNode = oldParcel.querySelector('Category');
        const categoryCode = categoryNode?.textContent.trim() || categoryNode?.getAttribute('Category') || '';
        if(categoryCode) {
             const category = newDoc.createElement('category');
             const typeCategory = newDoc.createElement('type');
             typeCategory.appendChild(createElementWithText(newDoc, null, 'code', categoryCode));
             if (CATEGORY_MAP[categoryCode]) {
                 typeCategory.appendChild(createElementWithText(newDoc, null, 'value', CATEGORY_MAP[categoryCode]));
             }
             category.appendChild(typeCategory);
             params.appendChild(category);
        }
       
        const utilizationNode = oldParcel.querySelector('Utilization');
        const byDoc = utilizationNode?.getAttribute('ByDoc') || '';
        if (byDoc) {
             const permittedUse = newDoc.createElement('permitted_use');
             const permittedUseEstablished = newDoc.createElement('permitted_use_established');
             permittedUseEstablished.appendChild(createElementWithText(newDoc, null, 'by_document', byDoc));
             permittedUse.appendChild(permittedUseEstablished);
             params.appendChild(permittedUse);
        }
        landRecord.appendChild(params);

        const cost = oldParcel.querySelector('CadastralCost, Ground_Payments > Ground_Payment');
        if (cost) {
            const costNode = newDoc.createElement('cost');
            costNode.appendChild(createElementWithText(newDoc, null, 'value', cost.getAttribute('Value')));
            landRecord.appendChild(costNode);
        }

        landRecord.appendChild(convertAddress10to11(oldParcel.querySelector('Location > Address'), newDoc));
        
        const oldSpatial = oldParcel.querySelector('Entity_Spatial, EntitySpatial');
        if (oldSpatial) {
            const contoursLocation = newDoc.createElement('contours_location');
            contoursLocation.appendChild(convertSpatial10to11(oldSpatial, newDoc, coordSystemsMap));
            landRecord.appendChild(contoursLocation);
        }

        recordContainer.appendChild(landRecord);
    });
    return recordContainer;
}


function convertObjectsRealty10to11(oldBlock, newDoc, coordSystemsMap) {
    const recordContainer = newDoc.createElement('record_data');
    oldBlock.querySelectorAll('ObjectRealty').forEach(oldObj => {
        const oldBuilding = oldObj.querySelector('Building');
        if (oldBuilding) {
            const buildRecord = newDoc.createElement('build_record');
            const object = newDoc.createElement('object');
            const commonData = newDoc.createElement('common_data');
            
            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ ---
            const type = newDoc.createElement('type');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥ –∏–∑ —Å—Ç–∞—Ä–æ–π —Å—Ö–µ–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const typeCode = getNodeValue(oldBuilding, 'ObjectType') || '002001002000';
            type.appendChild(createElementWithText(newDoc, null, 'code', typeCode));
            type.appendChild(createElementWithText(newDoc, null, 'value', '–ó–¥–∞–Ω–∏–µ')); // –ó–Ω–∞—á–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ "–ó–¥–∞–Ω–∏–µ"
            commonData.appendChild(type);
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

            commonData.appendChild(createElementWithText(newDoc, null, 'cad_number', oldBuilding.getAttribute('CadastralNumber')));
            object.appendChild(commonData);
            buildRecord.appendChild(object);
            const params = newDoc.createElement('params');
            const purpose = newDoc.createElement('purpose');
            purpose.appendChild(createElementWithText(newDoc, null, 'code', getNodeValue(oldBuilding, 'AssignationBuilding')));
            params.appendChild(purpose);
            params.appendChild(createElementWithText(newDoc, null, 'area', getNodeValue(oldBuilding, 'Area')));
            buildRecord.appendChild(params);
            buildRecord.appendChild(convertAddress10to11(oldBuilding.querySelector('Location > Address'), newDoc));
            const oldSpatial = oldBuilding.querySelector('Entity_Spatial, EntitySpatial');
            if(oldSpatial) {
                const contours = newDoc.createElement('contours');
                contours.appendChild(convertSpatial10to11(oldSpatial, newDoc, coordSystemsMap));
                buildRecord.appendChild(contours);
            }
            recordContainer.appendChild(buildRecord);
        }
    });
    return recordContainer;
}

function convertAddress10to11(oldAddress, newDoc) {
    const addressLocation = newDoc.createElement('address_location');
    if (!oldAddress) return addressLocation;

    const address = newDoc.createElement('address');

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–†–ò–û–†–ò–¢–ï–¢ –î–õ–Ø <Note> ---
    // 1. –°–Ω–∞—á–∞–ª–∞ –∏–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –∏–∑ —Ç–µ–≥–∞ Note
    const readableAddressText = getNodeValue(oldAddress, '*|Note, Note');
    if (readableAddressText) {
        address.appendChild(createElementWithText(newDoc, null, 'readable_address', readableAddressText));
    }

    // 2. –ó–∞—Ç–µ–º, –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –§–ò–ê–°
    const addressFias = newDoc.createElement('address_fias');
    const levelSettlement = newDoc.createElement('level_settlement');
    
    const okato = getNodeValue(oldAddress, '*|OKATO, Code_OKATO');
    if (okato) levelSettlement.appendChild(createElementWithText(newDoc, null, 'okato', okato));
    
 const kladr = getNodeValue(oldAddress, '*|KLADR, Code_KLADR');
    if (kladr) levelSettlement.appendChild(createElementWithText(newDoc, null, 'kladr', kladr));

    // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
    const postalCode = getNodeValue(oldAddress, '*|PostalCode, Postal_Code');
    if (postalCode) {
        // –í v11 –ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é level_settlement
        // –ù–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–æ–±–∞–≤–∏–º –µ–≥–æ —Å—é–¥–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const postalCodeNode = newDoc.createElement('postal_code');
        postalCodeNode.textContent = postalCode;
        levelSettlement.appendChild(postalCodeNode);
    }
    
    const regionCode = getNodeValue(oldAddress, '*|Region, Region');
    if (regionCode) {
        const region = newDoc.createElement('region');
        region.appendChild(createElementWithText(newDoc, null, 'code', regionCode));
        levelSettlement.appendChild(region);
    }
    
    const district = oldAddress.querySelector('*|District, District');
    if(district) {
        const districtNode = newDoc.createElement('district');
        districtNode.appendChild(createElementWithText(newDoc, null, 'type_district', district.getAttribute('Type')));
        districtNode.appendChild(createElementWithText(newDoc, null, 'name_district', district.getAttribute('Name')));
        levelSettlement.appendChild(districtNode);
    }

      const city = oldAddress.querySelector('*|City, City');
    if(city) {
        const cityNode = newDoc.createElement('city');
        cityNode.appendChild(createElementWithText(newDoc, null, 'type_city', city.getAttribute('Type')));
        cityNode.appendChild(createElementWithText(newDoc, null, 'name_city', city.getAttribute('Name')));
        levelSettlement.appendChild(cityNode);
    }
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–¥–ª—è —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏)
    const locality = oldAddress.querySelector('Locality');
    if(locality) {
        const localityNode = newDoc.createElement('locality'); // –í v11 —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å urban_district –∏–ª–∏ settlement
        localityNode.appendChild(createElementWithText(newDoc, null, 'type_locality', locality.getAttribute('Type')));
        localityNode.appendChild(createElementWithText(newDoc, null, 'name_locality', locality.getAttribute('Name')));
        levelSettlement.appendChild(localityNode);
    }

    if (levelSettlement.hasChildNodes()) {
        addressFias.appendChild(levelSettlement);
    }

    const detailedLevel = newDoc.createElement('detailed_level');
    const street = oldAddress.querySelector('*|Street, Street');
    if (street) {
        const streetNode = newDoc.createElement('street');
        streetNode.appendChild(createElementWithText(newDoc, null, 'type_street', street.getAttribute('Type')));
        streetNode.appendChild(createElementWithText(newDoc, null, 'name_street', street.getAttribute('Name')));
        detailedLevel.appendChild(streetNode);
    }

    const level1 = oldAddress.querySelector('*|Level1, Level1');
    if (level1) {
        const level1Node = newDoc.createElement('level1');
        level1Node.appendChild(createElementWithText(newDoc, null, 'type_level1', level1.getAttribute('Type')));
        level1Node.appendChild(createElementWithText(newDoc, null, 'name_level1', level1.getAttribute('Value')));
        detailedLevel.appendChild(level1Node);
    }
    
    if (detailedLevel.hasChildNodes()) {
        addressFias.appendChild(detailedLevel);
    }

    if (addressFias.hasChildNodes()) {
        address.appendChild(addressFias);
    }
    
    // 3. –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –±–ª–æ–∫ <address> –≤ <address_location>, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π
    if (address.hasChildNodes()) {
        addressLocation.appendChild(address);
    }
    
    return addressLocation;
}

function convertSpatial10to11(oldSpatial, newDoc, coordSystemsMap) {
    const newSpatial = newDoc.createElement('entity_spatial');
    const entSys = oldSpatial.getAttribute('EntSys') || oldSpatial.getAttribute('Ent_Sys');
    // –î–ª—è v7 –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å Coord_System, –∏—Å–ø–æ–ª—å–∑—É–µ–º Ent_Sys –Ω–∞–ø—Ä—è–º—É—é
    const skId = coordSystemsMap.get(entSys) || (entSys ? `ID${entSys}` : 'UNKNOWN');
    newSpatial.appendChild(createElementWithText(newDoc, null, 'sk_id', skId));

    const spatialsElements = newDoc.createElement('spatials_elements');
    
    oldSpatial.querySelectorAll('Spatial_Element, *|SpatialElement').forEach(oldElement => {
        const spatialElement = newDoc.createElement('spatial_element');
        const ordinates = newDoc.createElement('ordinates');
        
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–º—ã–∫–∞–Ω–∏—è –∫–æ–Ω—Ç—É—Ä–∞ ---

        // 1. –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç—É—Ä–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
        const pointsArray = [];
        oldElement.querySelectorAll('Spelement_Unit, *|SpelementUnit').forEach(oldUnit => {
            const oldOrd = oldUnit.querySelector('Ordinate, *|Ordinate');
            if (oldOrd) {
                pointsArray.push({
                    x: oldOrd.getAttribute('X'),
                    y: oldOrd.getAttribute('Y'),
                    ord_nmb: oldUnit.getAttribute('SuNmb') || oldUnit.getAttribute('Su_Nmb'),
                    num_geopoint: oldOrd.getAttribute('NumGeopoint') || oldOrd.getAttribute('Num_Geopoint'),
                    delta_geopoint: oldOrd.getAttribute('DeltaGeopoint') || oldOrd.getAttribute('Delta_Geopoint'),
                    zacrep: oldOrd.getAttribute('GeopointZacrep')
                });
            }
        });

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–º—ã–∫–∞—Ç—å –∫–æ–Ω—Ç—É—Ä
        if (pointsArray.length > 2) {
            const firstPoint = pointsArray[0];
            const lastPoint = pointsArray[pointsArray.length - 1];
            if (firstPoint.x !== lastPoint.x || firstPoint.y !== lastPoint.y) {
                // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –≤ –∫–æ–Ω–µ—Ü
                pointsArray.push(firstPoint);
            }
        }

        // 3. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º (—É–∂–µ –∑–∞–º–∫–Ω—É—Ç—ã–π) –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ –≤ –Ω–æ–≤—ã–π XML
        pointsArray.forEach(point => {
            const ordinate = newDoc.createElement('ordinate');
            ordinate.appendChild(createElementWithText(newDoc, null, 'x', point.x));
            ordinate.appendChild(createElementWithText(newDoc, null, 'y', point.y));
            
            if(point.ord_nmb) ordinate.appendChild(createElementWithText(newDoc, null, 'ord_nmb', point.ord_nmb));
            if (point.num_geopoint) ordinate.appendChild(createElementWithText(newDoc, null, 'num_geopoint', point.num_geopoint));
            if (point.delta_geopoint) ordinate.appendChild(createElementWithText(newDoc, null, 'delta_geopoint', point.delta_geopoint));
            if(point.zacrep) ordinate.appendChild(createElementWithText(newDoc, null, 'geopoint_zacrep', point.zacrep));
            
            ordinates.appendChild(ordinate);
        });

        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        spatialElement.appendChild(ordinates);
        spatialsElements.appendChild(spatialElement);
    });

    newSpatial.appendChild(spatialsElements);
    return newSpatial;
}

</script>
</body>
</html>
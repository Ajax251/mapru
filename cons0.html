<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Консультант</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="img/service.png" type="image/png">
<style>
:root {
    --bg-gradient: linear-gradient(145deg, #ffffff 0%, #f0f7ff 50%, #e8f2ff 100%);
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f7ff;
    --bg-frost: rgba(255, 255, 255, 0.98);
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #94a3b8;
    --accent-color: #2563eb;
    --accent-hover: #1d4ed8;
    --accent-light: #e0eaff;
    --accent-gradient: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
    --border-color: #c7d9f1;
    --border-light: #a8c5e8;
    --shadow-soft: 0 2px 8px rgba(37, 99, 235, 0.06);
    --shadow-card: 0 4px 16px rgba(37, 99, 235, 0.08);
    --shadow-hover: 0 8px 24px rgba(37, 99, 235, 0.12);
    --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);
    --cat-home: #3b82f6;
    --cat-care: #22c55e;
    --cat-knowledge: #8b5cf6;
    --cat-culture: #ec4899;
    --danger-color: #ef4444;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    height: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

.app-container {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    height: 100dvh;
    margin: 0 auto;
    background: var(--bg-frost);
    box-shadow: var(--shadow-card);
}

.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: #ffffff;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    gap: 12px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-color);
}

.header-logo i { font-size: 20px; }

.role-selector-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
    min-width: 180px;
}

.role-selector-btn:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
    box-shadow: var(--shadow-hover);
}

.role-selector-btn .role-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
}

.role-selector-btn .role-name {
    flex: 1;
    text-align: left;
}

.role-selector-btn .chevron {
    color: var(--text-muted);
    font-size: 12px;
    transition: transform 0.2s;
}

.role-selector-btn:hover .chevron { color: var(--accent-color); }

.header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 40px;
    padding: 0 14px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    gap: 8px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.header-btn:hover {
    background: var(--accent-light);
    color: var(--accent-color);
    border-color: var(--accent-color);
}

.header-btn.icon-only { width: 40px; padding: 0; }
.header-btn i { font-size: 14px; }

.response-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.response-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    flex-shrink: 0;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    color: white;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.action-btn:hover { box-shadow: var(--shadow-hover); }
.action-btn i { font-size: 13px; }

#copy-btn { background: var(--accent-gradient); }
#print-btn { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
#export-html-btn { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
#new-chat-btn { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); margin-left: auto; }

.response-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: var(--bg-secondary);
}

.response-wrapper::-webkit-scrollbar { width: 6px; }
.response-wrapper::-webkit-scrollbar-track { background: var(--bg-tertiary); }
.response-wrapper::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
.response-wrapper::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

.welcome-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
}

.welcome-icon {
    width: 88px;
    height: 88px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-card);
}

.welcome-icon i { font-size: 38px; color: white; }

.welcome-message h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
}

.welcome-message p {
    font-size: 15px;
    max-width: 480px;
    line-height: 1.7;
    color: var(--text-secondary);
}

#ai-response { 
    font-size: 15px; 
    line-height: 1.8; 
    color: var(--text-primary); 
}

#ai-response h2, #ai-response h3 { 
    color: var(--text-primary); 
    font-weight: 700; 
    margin: 28px 0 16px 0; 
    padding-bottom: 10px; 
    border-bottom: 2px solid var(--border-color); 
}

#ai-response h2 { 
    font-size: 20px; 
    text-align: center; 
    border-color: var(--accent-color); 
}

#ai-response h3 { font-size: 17px; }
#ai-response p { margin: 14px 0; color: var(--text-primary); }
#ai-response ul, #ai-response ol { padding-left: 24px; margin: 14px 0; }
#ai-response li { margin: 8px 0; color: var(--text-primary); }
#ai-response strong { color: var(--accent-hover); font-weight: 600; }
#ai-response hr { border: none; height: 1px; background: var(--border-color); margin: 28px 0; }

#ai-response table {
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0; 
    margin: 20px 0;
    background: var(--bg-secondary); 
    border-radius: 10px; 
    overflow: hidden;
    box-shadow: var(--shadow-soft); 
    border: 1px solid var(--border-color);
}

#ai-response thead { background: var(--accent-gradient); }
#ai-response th { 
    padding: 12px 16px; 
    text-align: left; 
    font-weight: 600; 
    color: white; 
    font-size: 13px; 
}

#ai-response td { 
    padding: 12px 16px; 
    border-bottom: 1px solid var(--border-color); 
    color: var(--text-primary);
}

#ai-response tbody tr:last-child td { border-bottom: none; }
#ai-response tbody tr:nth-child(even) { background: var(--bg-tertiary); }
#ai-response tbody tr:hover { background: var(--accent-light); }

#ai-response .disclaimer, #ai-response .crisis-protocol {
    display: block;
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 14px 18px;
    border-radius: 10px;
    margin-top: 24px;
    font-weight: 500;
    font-size: 14px;
    line-height: 1.6;
}

#ai-response .flowchart-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--accent-gradient);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

#ai-response .flowchart-btn:hover { box-shadow: var(--shadow-hover); }

.loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    gap: 16px;
}

.loader-icon { font-size: 56px; color: var(--accent-color); margin-bottom: 8px; }
.loader p { color: var(--text-secondary); font-size: 15px; line-height: 1.6; }

#cancel-btn {
    padding: 10px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

#cancel-btn:hover { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color); 
}

.input-panel {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    background: #ffffff;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

#user-query {
    flex: 1;
    padding: 14px 18px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: inherit;
    resize: none;
    min-height: 48px;
    max-height: 150px;
    line-height: 1.5;
    transition: all 0.2s ease;
}

#user-query:focus { 
    outline: none; 
    border-color: var(--accent-color); 
    background: var(--bg-secondary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

#user-query::placeholder { color: var(--text-muted); }

#send-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    background: var(--accent-gradient);
    color: white;
    font-size: 18px;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
}

#send-btn:hover { 
    transform: scale(1.05); 
    box-shadow: var(--shadow-hover); 
}

#send-btn:disabled, #user-query:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

.status-bar {
    padding: 8px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    text-align: center;
    flex-shrink: 0;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.15);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
    margin: 0;
}

.modal-header h2 i { color: var(--accent-color); }

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.modal-close:hover { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color); 
}

.modal-body { padding: 20px; overflow-y: auto; flex: 1; }

.role-modal { max-width: 700px; }

.role-category {
    margin-bottom: 20px;
}

.role-category:last-child { margin-bottom: 0; }

.role-category-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 8px;
}

.role-category[data-cat="home"] .role-category-title { background: #dbeafe; color: var(--cat-home); }
.role-category[data-cat="care"] .role-category-title { background: #dcfce7; color: var(--cat-care); }
.role-category[data-cat="knowledge"] .role-category-title { background: #ede9fe; color: var(--cat-knowledge); }
.role-category[data-cat="culture"] .role-category-title { background: #fce7f3; color: var(--cat-culture); }
.role-category[data-cat="misc"] .role-category-title { background: #ffedd5; }

.role-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
}

.role-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 14px 10px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.role-option:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
}

.role-option.selected {
    border-color: var(--accent-color);
    border-width: 2px;
    background: var(--accent-light);
}

.role-option .role-opt-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-size: 18px;
    color: white;
}

.role-option .role-opt-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
}

.role-option[data-cat="home"] .role-opt-icon { background: linear-gradient(135deg, var(--cat-home) 0%, #60a5fa 100%); }
.role-option[data-cat="care"] .role-opt-icon { background: linear-gradient(135deg, var(--cat-care) 0%, #4ade80 100%); }
.role-option[data-cat="knowledge"] .role-opt-icon { background: linear-gradient(135deg, var(--cat-knowledge) 0%, #a78bfa 100%); }
.role-option[data-cat="culture"] .role-opt-icon { background: linear-gradient(135deg, var(--cat-culture) 0%, #f472b6 100%); }
.role-option[data-cat="misc"] .role-opt-icon { background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); }

.role-option[data-cat="home"]:hover { border-color: var(--cat-home); }
.role-option[data-cat="care"]:hover { border-color: var(--cat-care); }
.role-option[data-cat="knowledge"]:hover { border-color: var(--cat-knowledge); }
.role-option[data-cat="culture"]:hover { border-color: var(--cat-culture); }

.settings-group { margin-bottom: 20px; }

.settings-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.settings-group select,
.settings-group input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.settings-group select:focus,
.settings-group input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.settings-group small { 
    display: block; 
    margin-top: 8px; 
    font-size: 12px; 
    color: var(--text-muted); 
}

.settings-group small a { 
    color: var(--accent-color); 
    text-decoration: none; 
    font-weight: 500; 
}

.api-mode-options { display: flex; flex-direction: column; gap: 8px; }

.api-mode-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.api-mode-option:hover { 
    border-color: var(--accent-color); 
    background: var(--accent-light); 
}

.api-mode-option.selected { 
    border-color: var(--accent-color); 
    border-width: 2px;
    background: var(--accent-light); 
}

.api-mode-option i { 
    font-size: 16px; 
    color: var(--accent-color); 
    width: 20px; 
    text-align: center; 
}

.api-mode-option span { 
    font-size: 14px; 
    font-weight: 500; 
    color: var(--text-primary); 
}

.save-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent-gradient);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.save-btn:hover { 
    box-shadow: var(--shadow-hover); 
}

.history-list { 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
    max-height: 400px; 
    overflow-y: auto; 
}

.history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover { 
    background: var(--accent-light); 
    border-color: var(--accent-color); 
}

.history-item-text { 
    font-size: 14px; 
    color: var(--text-primary); 
    flex: 1; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
}

.history-item-delete {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.history-item-delete:hover { 
    background: var(--danger-color); 
    color: white; 
}

.history-empty { 
    text-align: center; 
    padding: 40px 20px; 
    color: var(--text-muted); 
}

.history-empty i { 
    font-size: 36px; 
    margin-bottom: 12px; 
    display: block;
}

.flowchart-modal { max-width: 95vw; max-height: 95vh; width: 100%; height: 100%; }
.flowchart-modal .modal-body { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; background: white; }
#mermaid-container { width: 100%; min-height: 100%; display: flex; justify-content: center; align-items: center; }
#mermaid-container svg { max-width: none; }
.flowchart-actions { display: flex; gap: 8px; }

@keyframes balance { 0%, 100% { transform: rotate(8deg); } 50% { transform: rotate(-8deg); } }
@keyframes turn-key { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
@keyframes pulse-paw { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
@keyframes spin-wrench { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
@keyframes steam { 0% { opacity: 0.3; transform: translateY(10px); } 50% { opacity: 1; transform: translateY(-10px); } 100% { opacity: 0.3; transform: translateY(-20px); } }
@keyframes grow-plant { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
@keyframes float-bubble { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes flip-hourglass { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
@keyframes spin-atlas { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
@keyframes focus-on { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.15); opacity: 1; } }
@keyframes float-atom { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(180deg); } 100% { transform: translateY(0) rotate(360deg); } }
@keyframes float-up-down { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
@keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
@keyframes point-down { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes turn-page { 0%, 100% { transform: perspective(800px) rotateY(0deg); } 50% { transform: perspective(800px) rotateY(180deg); } }
@keyframes spin-globe { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes spin { to { transform: rotate(360deg); } }

.loader-icon-lawyer { animation: balance 2s ease-in-out infinite; transform-origin: 50% 90%; }
.loader-icon-realty { animation: turn-key 2s ease-in-out infinite; }
.loader-icon-auto { animation: spin 2s linear infinite; }
.loader-icon-techsupport { animation: blink 1s step-end infinite; }
.loader-icon-vet { animation: pulse-paw 1.5s ease-in-out infinite; }
.loader-icon-diy { animation: spin-wrench 3s ease-in-out infinite; }
.loader-icon-chef { animation: steam 2s ease-out infinite; }
.loader-icon-gardener { animation: grow-plant 2.5s ease-in-out infinite; transform-origin: bottom center; }
.loader-icon-psychologist { animation: float-bubble 2.5s ease-in-out infinite; }
.loader-icon-historian { animation: flip-hourglass 2.5s ease-in-out infinite; }
.loader-icon-encyclopedist { animation: spin-atlas 4s linear infinite; }
.loader-icon-dossier { animation: focus-on 2s ease-in-out infinite; }
.loader-icon-biographer { animation: pulse-paw 1.5s ease-in-out infinite; }
.loader-icon-philosopher { animation: float-atom 4s ease-in-out infinite; }
.loader-icon-scientist { animation: float-up-down 3s ease-in-out infinite; }
.loader-icon-kino { animation: flicker 1.5s infinite alternate; }
.loader-icon-instructor { animation: point-down 2s ease-in-out infinite; }
.loader-icon-book-expert { animation: turn-page 2.5s ease-in-out infinite; }
.loader-icon-geographer { animation: spin-globe 4s linear infinite; }
.loader-icon-fact-checker { animation: pulse-paw 1.5s ease-in-out infinite; }

@media print {
    .app-header, .input-panel, .response-actions, .status-bar { display: none !important; }
    body, .app-container { background: white !important; height: auto !important; }
    .response-area, .response-wrapper { overflow: visible !important; height: auto !important; }
}

@media (max-width: 768px) {
    .app-header { padding: 10px 14px; flex-wrap: wrap; }
    .header-logo span { display: none; }
    .role-selector-btn { min-width: auto; padding: 8px 12px; }
    .role-selector-btn .role-name { display: none; }
    .role-selector-btn .role-icon { width: 28px; height: 28px; font-size: 12px; }
    .header-btn span { display: none; }
    .response-wrapper { padding: 16px; }
    .response-actions { gap: 6px; padding: 10px 14px; }
    .action-btn { padding: 6px 10px; font-size: 12px; }
    .action-btn span { display: none; }
    .input-panel { padding: 12px 14px; }
    #user-query { padding: 12px 16px; font-size: 14px; }
    #send-btn { width: 44px; height: 44px; }
    .role-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    .role-option { padding: 10px 8px; }
    .role-option .role-opt-icon { width: 36px; height: 36px; font-size: 14px; }
    .role-option .role-opt-name { font-size: 11px; }
    .modal-content { max-width: 100%; }
}
</style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="header-left">
            <div class="header-logo">
                <i class="fa-solid fa-comments"></i>
                <span>Консультант</span>
            </div>
            <button class="role-selector-btn" id="role-selector-btn">
                <div class="role-icon" id="current-role-icon"><i class="fa-solid fa-list-check"></i></div>
                <span class="role-name" id="current-role-name">Инструктор</span>
                <i class="fa-solid fa-chevron-down chevron"></i>
            </button>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="history-btn" title="История">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <span>История</span>
            </button>
            <button class="header-btn icon-only" id="settings-btn" title="Настройки">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <main class="response-area">
        <div class="response-actions" id="response-actions">
            <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i><span>Копировать</span></button>
            <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i><span>Печать</span></button>
            <button class="action-btn" id="export-html-btn"><i class="fa-solid fa-file-code"></i><span>HTML</span></button>
            <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus"></i><span>Новый</span></button>
        </div>
        <div class="response-wrapper" id="response-wrapper">
            <div id="ai-response"></div>
        </div>
    </main>

    <div class="input-panel">
        <textarea id="user-query" placeholder="Задайте ваш вопрос..." rows="1"></textarea>
        <button id="send-btn" title="Отправить"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div class="status-bar" id="status-bar">Gemini 3 Flash • Прокси MapRuApp</div>
</div>

<div id="role-modal" class="modal-overlay">
    <div class="modal-content role-modal">
        <div class="modal-header">
            <h2><i class="fa-solid fa-user-tie"></i> Выбор эксперта</h2>
            <button class="modal-close" id="close-role-modal"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body" id="role-modal-body"></div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-cog"></i> Настройки</h2>
            <button class="modal-close" id="close-settings"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="settings-group">
                <label>Модель ИИ</label>
                <select id="model-selector"></select>
            </div>
            <div class="settings-group">
                <label>Режим подключения</label>
                <div class="api-mode-options" id="api-mode-options"></div>
            </div>
            <div class="settings-group" id="api-key-group" style="display:none;">
                <label>API ключ</label>
                <input type="password" id="api-key-input" placeholder="Введите ключ...">
                <small>Получить: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> | <a href="https://console.mistral.ai/api-keys/" target="_blank">Mistral</a></small>
            </div>
            <button class="save-btn" id="save-settings">Сохранить</button>
        </div>
    </div>
</div>

<div id="history-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> История запросов</h2>
            <button class="modal-close" id="close-history"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="history-list" id="history-list"></div>
        </div>
    </div>
</div>

<div id="flowchart-modal" class="modal-overlay">
    <div class="modal-content flowchart-modal">
        <div class="modal-header">
            <h2><i class="fa-solid fa-diagram-project"></i> Блок-схема</h2>
            <div class="flowchart-actions">
                <button class="header-btn" id="save-flowchart" title="Сохранить SVG"><i class="fa-solid fa-download"></i></button>
                <button class="modal-close" id="close-flowchart"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div id="mermaid-container"></div>
        </div>
    </div>
</div>

<script src="cons.js"></script>
<script>
mermaid.initialize({ startOnLoad: false, flowchart: { nodeSpacing: 50, rankSpacing: 50 }, themeVariables: { fontSize: '16px' } });

window.addEventListener('load', () => {
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
    const DEFAULT_MODEL = "gemini-3-flash-preview";

    const MODELS = [
        { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini" },
        { id: "gemini-2.5-flash-lite-preview-09-25", uiName: "Gemini 2.5 Flash Lite Preview", apiType: "gemini" },
        { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini" },
        { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini" },
        { id: "gemini-3-pro-preview", uiName: "Gemini 3 Pro Preview", apiType: "gemini" },
        { id: "nvidia/nemotron-3-nano-30b-a3b:free", uiName: "NVIDIA Nemotron 3 Nano 30B", apiType: "openrouter" },
        { id: "gpt-oss-20b-free", uiName: "OpenAI GPT-OSS 20B", apiType: "openrouter" },
        { id: "mistral-large-2512", uiName: "Mistral Large", apiType: "mistral" },
        { id: "mistral-medium-2508", uiName: "Mistral Medium", apiType: "mistral" },
    ];

    const API_MODES = {
        'mapruapp': { uiName: 'Прокси (MapRuApp)', icon: 'fa-solid fa-server' },
        'vercel': { uiName: 'Прокси (Vercel)', icon: 'fa-solid fa-cloud' },
        'direct': { uiName: 'Прямой (Gemini)', icon: 'fa-solid fa-key' },
        'direct_mistral': { uiName: 'Прямой (Mistral)', icon: 'fa-solid fa-bolt' }
    };

 const CATEGORIES = {
    home: { name: 'Сервис', icon: 'fa-solid fa-briefcase', color: '#3b82f6', modes: ['lawyer', 'realty', 'auto', 'techsupport', 'instructor'] },
    care: { name: 'Дом', icon: 'fa-solid fa-house-heart', color: '#22c55e', modes: ['vet', 'gardener', 'chef', 'psychologist', 'diy'] },
    knowledge: { name: 'Знания', icon: 'fa-solid fa-atom', color: '#8b5cf6', modes: ['historian', 'geographer', 'encyclopedist', 'scientist', 'fact_checker', 'philosopher', 'dossier'] },
    culture: { name: 'Культура', icon: 'fa-solid fa-masks-theater', color: '#ec4899', modes: ['kino', 'book_expert', 'biographer'] }
};

    const MODE_CONFIGS = {
        instructor: { prompt: typeof AI_SYSTEM_PROMPT_INSTRUCTOR !== 'undefined' ? AI_SYSTEM_PROMPT_INSTRUCTOR : '', name: 'Инструктор', icon: 'fa-solid fa-list-check', placeholder: 'Как что-либо сделать...', welcome: 'Опишите задачу — составлю пошаговую инструкцию', loaderIcon: 'fa-solid fa-list-check loader-icon-instructor', loadingText: 'Разрабатываю план...' },
        lawyer: { prompt: typeof AI_SYSTEM_PROMPT_LAWYER !== 'undefined' ? AI_SYSTEM_PROMPT_LAWYER : '', name: 'Юрист', icon: 'fa-solid fa-scale-balanced', placeholder: 'Правовая ситуация...', welcome: 'Задайте вопрос по праву РФ', loaderIcon: 'fa-solid fa-scale-balanced loader-icon-lawyer', loadingText: 'Изучаю законодательство...' },
        realty: { prompt: typeof AI_SYSTEM_PROMPT_REALTY !== 'undefined' ? AI_SYSTEM_PROMPT_REALTY : '', name: 'Недвижимость', icon: 'fa-solid fa-house-chimney-user', placeholder: 'Вопрос о недвижимости...', welcome: 'Помогу с покупкой, продажей или арендой', loaderIcon: 'fa-solid fa-house-chimney-user loader-icon-realty', loadingText: 'Проверяю документы...' },
        auto: { prompt: typeof AI_SYSTEM_PROMPT_AUTO !== 'undefined' ? AI_SYSTEM_PROMPT_AUTO : '', name: 'АвтоЭксперт', icon: 'fa-solid fa-car-burst', placeholder: 'Симптомы неисправности...', welcome: 'Опишите проблему с автомобилем', loaderIcon: 'fa-solid fa-car-burst loader-icon-auto', loadingText: 'Провожу диагностику...' },
        techsupport: { prompt: typeof AI_SYSTEM_PROMPT_TECHSUPPORT !== 'undefined' ? AI_SYSTEM_PROMPT_TECHSUPPORT : '', name: 'Техподдержка', icon: 'fa-solid fa-laptop-code', placeholder: 'Проблема с ПК или телефоном...', welcome: 'Помогу решить технические проблемы', loaderIcon: 'fa-solid fa-laptop-code loader-icon-techsupport', loadingText: 'Запускаю диагностику...' },
        vet: { prompt: typeof AI_SYSTEM_PROMPT_VET !== 'undefined' ? AI_SYSTEM_PROMPT_VET : '', name: 'Ветеринар', icon: 'fa-solid fa-paw', placeholder: 'Что случилось с питомцем?', welcome: 'Опишите симптомы питомца', loaderIcon: 'fa-solid fa-paw loader-icon-vet', loadingText: 'Собираю анамнез...' },
        diy: { prompt: typeof AI_SYSTEM_PROMPT_DIY !== 'undefined' ? AI_SYSTEM_PROMPT_DIY : '', name: 'ДомМастер', icon: 'fa-solid fa-paint-roller', placeholder: 'Какой ремонт затеяли?', welcome: 'Инструкции по бытовому ремонту', loaderIcon: 'fa-solid fa-paint-roller loader-icon-diy', loadingText: 'Раскладываю инструменты...' },
        chef: { prompt: typeof AI_SYSTEM_PROMPT_CHEF !== 'undefined' ? AI_SYSTEM_PROMPT_CHEF : '', name: 'Шеф-повар', icon: 'fa-solid fa-kitchen-set', placeholder: 'Что будем готовить?', welcome: 'Помогу с рецептом или идеей для ужина', loaderIcon: 'fa-solid fa-kitchen-set loader-icon-chef', loadingText: 'Подбираю специи...' },
        gardener: { prompt: typeof AI_SYSTEM_PROMPT_GARDENER !== 'undefined' ? AI_SYSTEM_PROMPT_GARDENER : '', name: 'Садовод', icon: 'fa-solid fa-seedling', placeholder: 'Вопрос о растениях...', welcome: 'Консультирую по уходу за растениями', loaderIcon: 'fa-solid fa-seedling loader-icon-gardener', loadingText: 'Изучаю состав почвы...' },
        psychologist: { prompt: typeof AI_SYSTEM_PROMPT_PSYCHOLOGIST !== 'undefined' ? AI_SYSTEM_PROMPT_PSYCHOLOGIST : '', name: 'Психолог', icon: 'fa-solid fa-hand-holding-heart', placeholder: 'Что вас беспокоит?', welcome: 'Готов выслушать и поддержать', loaderIcon: 'fa-solid fa-hand-holding-heart loader-icon-psychologist', loadingText: 'Создаю безопасное пространство...' },
        kino: { prompt: typeof AI_SYSTEM_PROMPT_KINO !== 'undefined' ? AI_SYSTEM_PROMPT_KINO : '', name: 'КиноЭксперт', icon: 'fa-solid fa-film', placeholder: 'Фильм, сериал, актёр...', welcome: 'Посоветую фильм или сделаю подборку', loaderIcon: 'fa-solid fa-film loader-icon-kino', loadingText: 'Перематываю плёнку...' },
        book_expert: { prompt: typeof AI_SYSTEM_PROMPT_BOOK_EXPERT !== 'undefined' ? AI_SYSTEM_PROMPT_BOOK_EXPERT : '', name: 'Библиотекарь', icon: 'fa-solid fa-book-open-reader', placeholder: 'Какую книгу ищете?', welcome: 'Посоветую книгу или сделаю подборку', loaderIcon: 'fa-solid fa-book-open-reader loader-icon-book-expert', loadingText: 'Ищу на полках...' },
        biographer: { prompt: typeof AI_SYSTEM_PROMPT_BIOGRAPHER !== 'undefined' ? AI_SYSTEM_PROMPT_BIOGRAPHER : '', name: 'Биограф', icon: 'fa-solid fa-book-open', placeholder: 'Введите имя...', welcome: 'Исследуйте биографии известных людей', loaderIcon: 'fa-solid fa-book-open loader-icon-biographer', loadingText: 'Листаю архивы...' },
        historian: { prompt: typeof AI_SYSTEM_PROMPT_HISTORIAN !== 'undefined' ? AI_SYSTEM_PROMPT_HISTORIAN : '', name: 'Историк', icon: 'fa-solid fa-scroll', placeholder: 'Исторический вопрос...', welcome: 'Найду исторические корни и параллели', loaderIcon: 'fa-solid fa-scroll loader-icon-historian', loadingText: 'Расшифровываю манускрипты...' },
        geographer: { prompt: typeof AI_SYSTEM_PROMPT_GEOGRAPHER !== 'undefined' ? AI_SYSTEM_PROMPT_GEOGRAPHER : '', name: 'Географ', icon: 'fa-solid fa-globe-americas', placeholder: 'Что свяжем с картой?', welcome: 'Найду место на карте мира', loaderIcon: 'fa-solid fa-globe-americas loader-icon-geographer', loadingText: 'Вращаю глобус...' },
        encyclopedist: { prompt: typeof AI_SYSTEM_PROMPT_ENCYCLOPEDIST !== 'undefined' ? AI_SYSTEM_PROMPT_ENCYCLOPEDIST : '', name: 'Энциклопедия', icon: 'fa-solid fa-atlas', placeholder: 'Что хотите узнать?', welcome: 'Введите термин, событие или имя', loaderIcon: 'fa-solid fa-atlas loader-icon-encyclopedist', loadingText: 'Систематизирую знания...' },
        fact_checker: { prompt: typeof AI_SYSTEM_PROMPT_FACT_CHECKER !== 'undefined' ? AI_SYSTEM_PROMPT_FACT_CHECKER : '', name: '100 Фактов', icon: 'fa-solid fa-stamp', placeholder: 'Введите тему...', welcome: 'Найду до 100 фактов по любой теме', loaderIcon: 'fa-solid fa-stamp loader-icon-fact-checker', loadingText: 'Проверяю источники...' },
        scientist: { prompt: typeof AI_SYSTEM_PROMPT_SCIENTIST !== 'undefined' ? AI_SYSTEM_PROMPT_SCIENTIST : '', name: 'Учёный', icon: 'fa-solid fa-microscope', placeholder: 'Научная тема...', welcome: 'Научно-популярный обзор по любой теме', loaderIcon: 'fa-solid fa-microscope loader-icon-scientist', loadingText: 'Ставлю эксперимент...' },
        dossier: { prompt: typeof AI_SYSTEM_PROMPT_DOSSIER !== 'undefined' ? AI_SYSTEM_PROMPT_DOSSIER : '', name: 'Досье', icon: 'fa-solid fa-address-card', placeholder: 'Укажите объект...', welcome: 'Соберу характеристики в таблицу', loaderIcon: 'fa-solid fa-magnifying-glass-chart loader-icon-dossier', loadingText: 'Анализирую характеристики...' },
        philosopher: { prompt: typeof AI_SYSTEM_PROMPT_PHILOSOPHER !== 'undefined' ? AI_SYSTEM_PROMPT_PHILOSOPHER : '', name: 'Мудрец', icon: 'fa-solid fa-atom', placeholder: 'Что хотите постичь?', welcome: 'Соберу мудрость веков и научные данные', loaderIcon: 'fa-solid fa-atom loader-icon-philosopher', loadingText: 'Погружаюсь в размышления...' }
    };

    let currentModelId = DEFAULT_MODEL;
    let currentApiMode = 'mapruapp';
    let currentApiType = 'gemini';
    let apiKey = '';
    let currentMode = 'instructor';
    let modeStates = {};
    let requestHistory = [];

    const $ = id => document.getElementById(id);
    const queryInput = $('user-query');
    const sendButton = $('send-btn');
    const responseContainer = $('ai-response');
    const responseActions = $('response-actions');
    const roleModal = $('role-modal');
    const roleModalBody = $('role-modal-body');
    const settingsModal = $('settings-modal');
    const historyModal = $('history-modal');
    const flowchartModal = $('flowchart-modal');
    const modelSelector = $('model-selector');
    const apiModeOptions = $('api-mode-options');
    const apiKeyGroup = $('api-key-group');
    const apiKeyInput = $('api-key-input');
    const historyList = $('history-list');
    const statusBar = $('status-bar');
    const mermaidContainer = $('mermaid-container');
    const roleSelectorBtn = $('role-selector-btn');
    const currentRoleIcon = $('current-role-icon');
    const currentRoleName = $('current-role-name');

    function init() {
        marked.setOptions({ gfm: true, breaks: true });
        initializeStates();
        loadSettings();
        renderModels();
        renderApiModes();
        renderRoleModal();
        renderHistory();
        bindEvents();
        switchMode(currentMode);
        updateStatusBar();
    }

    function initializeStates() {
        for (const modeId in MODE_CONFIGS) {
            modeStates[modeId] = {
                conversationHistory: [],
                responseHTML: getWelcomeHTML(modeId),
                isLoading: false,
                controller: null,
                lastFailedQuery: null
            };
        }
    }

    function getCategoryForMode(modeId) {
        for (const catId in CATEGORIES) {
            if (CATEGORIES[catId].modes.includes(modeId)) return catId;
        }
        return 'misc';
    }

    function getCategoryColor(catId) {
        return CATEGORIES[catId]?.color || '#2563eb';
    }

    function getWelcomeHTML(modeId) {
        const config = MODE_CONFIGS[modeId];
        const catId = getCategoryForMode(modeId);
        const color = getCategoryColor(catId);
        return `
            <div class="welcome-message">
                <div class="welcome-icon" style="background: linear-gradient(135deg, ${color} 0%, ${color}99 100%);">
                    <i class="${config.icon}"></i>
                </div>
                <h2>${config.name}</h2>
                <p>${config.welcome}</p>
            </div>`;
    }

    function renderRoleModal() {
        let html = '';
        for (const catId in CATEGORIES) {
            const cat = CATEGORIES[catId];
            html += `
                <div class="role-category" data-cat="${catId}">
                    <div class="role-category-title">
                        <i class="${cat.icon}"></i>
                        ${cat.name}
                    </div>
                    <div class="role-grid">`;
            
            cat.modes.forEach(modeId => {
                const config = MODE_CONFIGS[modeId];
                html += `
                    <div class="role-option ${modeId === currentMode ? 'selected' : ''}" data-mode="${modeId}" data-cat="${catId}">
                        <div class="role-opt-icon"><i class="${config.icon}"></i></div>
                        <div class="role-opt-name">${config.name}</div>
                    </div>`;
            });
            
            html += `</div></div>`;
        }
        roleModalBody.innerHTML = html;

        roleModalBody.querySelectorAll('.role-option').forEach(el => {
            el.onclick = () => {
                const modeId = el.dataset.mode;
                switchMode(modeId);
                roleModal.style.display = 'none';
            };
        });
    }

    function updateRoleSelectorBtn() {
        const config = MODE_CONFIGS[currentMode];
        const catId = getCategoryForMode(currentMode);
        const color = getCategoryColor(catId);
        
        currentRoleIcon.style.background = `linear-gradient(135deg, ${color} 0%, ${color}99 100%)`;
        currentRoleIcon.innerHTML = `<i class="${config.icon}"></i>`;
        currentRoleName.textContent = config.name;

        roleModalBody.querySelectorAll('.role-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.mode === currentMode);
        });
    }

    function bindEvents() {
        sendButton.onclick = () => handleRequest();
        queryInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } };
        queryInput.oninput = () => {
            queryInput.style.height = 'auto';
            queryInput.style.height = Math.min(queryInput.scrollHeight, 150) + 'px';
        };

        $('copy-btn').onclick = copyResponse;
        $('print-btn').onclick = () => window.print();
        $('export-html-btn').onclick = exportToHtml;
        $('new-chat-btn').onclick = startNewChat;

        roleSelectorBtn.onclick = () => { roleModal.style.display = 'flex'; };
        $('close-role-modal').onclick = () => { roleModal.style.display = 'none'; };
        roleModal.onclick = e => { if (e.target === roleModal) roleModal.style.display = 'none'; };

        $('settings-btn').onclick = () => { settingsModal.style.display = 'flex'; };
        $('close-settings').onclick = () => { settingsModal.style.display = 'none'; };
        settingsModal.onclick = e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; };
        $('save-settings').onclick = saveSettings;

        $('history-btn').onclick = () => { renderHistory(); historyModal.style.display = 'flex'; };
        $('close-history').onclick = () => { historyModal.style.display = 'none'; };
        historyModal.onclick = e => { if (e.target === historyModal) historyModal.style.display = 'none'; };

        $('close-flowchart').onclick = () => { flowchartModal.style.display = 'none'; };
        $('save-flowchart').onclick = saveFlowchartSVG;
        flowchartModal.onclick = e => { if (e.target === flowchartModal) flowchartModal.style.display = 'none'; };

        modelSelector.onchange = updateApiModeVisibility;

        $('response-wrapper').onclick = e => {
            const retryBtn = e.target.closest('[data-action="retry"]');
            if (retryBtn) retryRequest(retryBtn.dataset.mode);
            const flowchartBtn = e.target.closest('.flowchart-btn');
            if (flowchartBtn) {
                const dataEl = flowchartBtn.previousElementSibling;
                if (dataEl?.classList.contains('mermaid-data')) openFlowchart(dataEl.innerText);
            }
        };
    }

    function renderModels() {
        modelSelector.innerHTML = MODELS.map(m =>
            `<option value="${m.id}" data-api="${m.apiType}">${m.uiName}</option>`
        ).join('');
        modelSelector.value = currentModelId;
    }

    function renderApiModes() {
        apiModeOptions.innerHTML = Object.entries(API_MODES).map(([key, mode]) => `
            <div class="api-mode-option ${key === currentApiMode ? 'selected' : ''}" data-mode="${key}">
                <i class="${mode.icon}"></i>
                <span>${mode.uiName}</span>
            </div>
        `).join('');

        apiModeOptions.querySelectorAll('.api-mode-option').forEach(el => {
            el.onclick = () => {
                currentApiMode = el.dataset.mode;
                apiModeOptions.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
                el.classList.add('selected');
                updateApiKeyVisibility();
            };
        });
        updateApiModeVisibility();
    }

    function updateApiModeVisibility() {
        const model = MODELS.find(m => m.id === modelSelector.value);
        if (model) currentApiType = model.apiType;

        const options = apiModeOptions.querySelectorAll('.api-mode-option');
        options.forEach(opt => {
            const mode = opt.dataset.mode;
            if (currentApiType === 'gemini') {
                opt.style.display = (mode === 'direct_mistral') ? 'none' : 'flex';
            } else if (currentApiType === 'mistral') {
                opt.style.display = (mode === 'direct' || mode === 'vercel') ? 'none' : 'flex';
            } else if (currentApiType === 'openrouter') {
                opt.style.display = (mode === 'mapruapp') ? 'flex' : 'none';
            }
        });

        const currentOpt = apiModeOptions.querySelector(`[data-mode="${currentApiMode}"]`);
        if (currentOpt && currentOpt.style.display === 'none') {
            currentApiMode = 'mapruapp';
            apiModeOptions.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
            apiModeOptions.querySelector('[data-mode="mapruapp"]').classList.add('selected');
        }
        updateApiKeyVisibility();
    }

    function updateApiKeyVisibility() {
        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') ||
                         (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
        apiKeyGroup.style.display = needsKey ? 'block' : 'none';
    }

    function loadSettings() {
        currentModelId = localStorage.getItem('cons_modelId') || DEFAULT_MODEL;
        currentApiMode = localStorage.getItem('cons_apiMode') || 'mapruapp';
        apiKey = localStorage.getItem('cons_apiKey') || '';
        currentMode = localStorage.getItem('cons_currentMode') || 'instructor';
        requestHistory = JSON.parse(localStorage.getItem('cons_history') || '[]');

        const model = MODELS.find(m => m.id === currentModelId);
        if (model) currentApiType = model.apiType;
        else { currentModelId = DEFAULT_MODEL; currentApiType = 'gemini'; }

        apiKeyInput.value = apiKey;
        if (modelSelector.querySelector(`option[value="${currentModelId}"]`)) {
            modelSelector.value = currentModelId;
        }
    }

    function saveSettings() {
        currentModelId = modelSelector.value;
        const model = MODELS.find(m => m.id === currentModelId);
        if (model) currentApiType = model.apiType;

        currentApiMode = apiModeOptions.querySelector('.api-mode-option.selected')?.dataset.mode || 'mapruapp';
        apiKey = apiKeyInput.value.trim();

        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') ||
                         (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
        if (needsKey && !apiKey) {
            alert('Введите API ключ для прямого режима');
            return;
        }

        localStorage.setItem('cons_modelId', currentModelId);
        localStorage.setItem('cons_apiMode', currentApiMode);
        localStorage.setItem('cons_apiKey', apiKey);

        settingsModal.style.display = 'none';
        updateStatusBar();
    }

    function updateStatusBar() {
        const model = MODELS.find(m => m.id === currentModelId);
        const modeName = API_MODES[currentApiMode]?.uiName || 'Прокси';
        statusBar.textContent = `${model?.uiName || 'Gemini'} • ${modeName}`;
    }

    function addToHistory(query) {
        requestHistory = requestHistory.filter(h => h !== query);
        requestHistory.unshift(query);
        if (requestHistory.length > 10) requestHistory.pop();
        localStorage.setItem('cons_history', JSON.stringify(requestHistory));
    }

    function renderHistory() {
        if (requestHistory.length === 0) {
            historyList.innerHTML = `<div class="history-empty"><i class="fa-solid fa-clock-rotate-left"></i><p>История пуста</p></div>`;
            return;
        }
        historyList.innerHTML = requestHistory.map((item, i) => `
            <div class="history-item" data-query="${item.replace(/"/g, '&quot;')}">
                <span class="history-item-text">${item}</span>
                <button class="history-item-delete" data-index="${i}"><i class="fa-solid fa-times"></i></button>
            </div>
        `).join('');

        historyList.querySelectorAll('.history-item').forEach(el => {
            el.onclick = e => {
                if (e.target.closest('.history-item-delete')) {
                    const idx = e.target.closest('.history-item-delete').dataset.index;
                    requestHistory.splice(idx, 1);
                    localStorage.setItem('cons_history', JSON.stringify(requestHistory));
                    renderHistory();
                } else {
                    queryInput.value = el.dataset.query;
                    historyModal.style.display = 'none';
                    queryInput.focus();
                }
            };
        });
    }

    function switchMode(modeId) {
        if (!modeId || !modeStates[modeId]) return;
        currentMode = modeId;
        localStorage.setItem('cons_currentMode', modeId);

        const state = modeStates[modeId];
        const config = MODE_CONFIGS[modeId];

        responseContainer.innerHTML = state.responseHTML;
        $('response-wrapper').scrollTop = 0;
        responseActions.style.display = (!state.isLoading && state.conversationHistory.length > 0) ? 'flex' : 'none';
        queryInput.placeholder = config.placeholder;

        updateRoleSelectorBtn();

        const cancelBtn = $('cancel-btn');
        if (cancelBtn) cancelBtn.onclick = () => cancelRequest(modeId);
    }

    function getLoaderHTML(modeId) {
        const config = MODE_CONFIGS[modeId];
        const catId = getCategoryForMode(modeId);
        const color = getCategoryColor(catId);
        return `
            <div class="loader">
                <i class="${config.loaderIcon} loader-icon" style="color: ${color};"></i>
                <p>${config.loadingText}</p>
                <button id="cancel-btn">Отменить</button>
            </div>`;
    }

    function getErrorHTML(message, modeId, isKeyError = false) {
        return `
            <div class="welcome-message">
                <div class="welcome-icon" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h2 style="color: #dc2626;">Ошибка</h2>
                <p>${message}</p>
                ${isKeyError ?
                    `<button class="action-btn" onclick="document.getElementById('settings-btn').click()" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); margin-top: 16px;">
                        <i class="fa-solid fa-key"></i> Проверить настройки
                    </button>` :
                    `<button class="action-btn" data-action="retry" data-mode="${modeId}" style="background: var(--accent-gradient); margin-top: 16px;">
                        <i class="fa-solid fa-rotate-right"></i> Повторить
                    </button>`}
            </div>`;
    }

    async function handleRequest(queryOverride = null, modeOverride = null) {
        const modeId = modeOverride || currentMode;
        if (!modeId) return;

        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini') ||
                         (currentApiMode === 'direct_mistral' && currentApiType === 'mistral');
        if (needsKey && !apiKey) {
            settingsModal.style.display = 'flex';
            return;
        }

        const query = queryOverride || queryInput.value.trim();
        if (!query) return;

        const state = modeStates[modeId];
        if (state.isLoading) return;

        if (!queryOverride) {
            addToHistory(query);
            queryInput.value = '';
            queryInput.style.height = 'auto';
        }

        state.lastFailedQuery = null;
        state.isLoading = true;
        state.controller = new AbortController();
        state.conversationHistory.push({ role: 'user', content: query });

        if (currentMode === modeId) {
            state.responseHTML = getLoaderHTML(modeId);
            responseContainer.innerHTML = state.responseHTML;
            responseActions.style.display = 'none';
            const cancelBtn = $('cancel-btn');
            if (cancelBtn) cancelBtn.onclick = () => cancelRequest(modeId);
        }

        try {
            const config = MODE_CONFIGS[modeId];
            const systemPrompt = config.prompt || `Ты — ${config.name}. Помогай пользователю.`;

            let apiUrl, body;
            const headers = { 'Content-Type': 'application/json' };

            const messages = [
                { role: 'system', content: systemPrompt },
                ...state.conversationHistory.map(m => ({
                    role: m.role === 'model' ? 'assistant' : 'user',
                    content: m.content
                }))
            ];

            if (currentApiMode === 'mapruapp') {
                apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                body = { model: currentModelId, messages, max_tokens: 8192 };
            } else if (currentApiMode === 'direct_mistral') {
                apiUrl = 'https://api.mistral.ai/v1/chat/completions';
                headers['Authorization'] = `Bearer ${apiKey}`;
                body = { model: currentModelId, messages, max_tokens: 8192 };
            } else if (currentApiType === 'gemini') {
                const geminiContents = state.conversationHistory.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.content }]
                }));
                apiUrl = currentApiMode === 'direct'
                    ? `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`
                    : `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                body = {
                    contents: geminiContents,
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
            } else if (currentApiType === 'openrouter') {
                apiUrl = `${VERCEL_PROXY_BASE_URL}/proxy/openrouter/chat/completions`;
                body = { model: currentModelId, messages, max_tokens: 8192 };
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers,
                body: JSON.stringify(body),
                signal: state.controller.signal
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                const msg = err.error?.message || `HTTP ${response.status}`;
                const isKeyError = response.status === 400 && msg.toLowerCase().includes('api key');
                throw new Error(msg, { cause: { isKeyError } });
            }

            const data = await response.json();
            let aiText;

            if (currentApiMode === 'mapruapp' || currentApiMode === 'direct_mistral' || currentApiType === 'openrouter') {
                aiText = data.choices?.[0]?.message?.content;
            } else {
                aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            }

            if (!aiText) throw new Error('Пустой ответ от ИИ');

            state.conversationHistory.push({ role: 'model', content: aiText });
            state.responseHTML = marked.parse(aiText);

        } catch (error) {
            state.conversationHistory.pop();
            state.lastFailedQuery = query;
            if (error.name === 'AbortError') {
                state.responseHTML = getErrorHTML('Запрос отменён', modeId);
            } else {
                state.responseHTML = getErrorHTML(error.message, modeId, error.cause?.isKeyError);
            }
        } finally {
            state.isLoading = false;
            state.controller = null;
            if (currentMode === modeId) {
                responseContainer.innerHTML = state.responseHTML;
                responseActions.style.display = state.conversationHistory.length > 0 ? 'flex' : 'none';
            }
        }
    }

    function cancelRequest(modeId) {
        const state = modeStates[modeId];
        if (state?.controller) state.controller.abort();
    }

    function retryRequest(modeId) {
        const state = modeStates[modeId];
        if (state?.lastFailedQuery) handleRequest(state.lastFailedQuery, modeId);
    }

    function startNewChat() {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (state.isLoading && state.controller) state.controller.abort();

        state.conversationHistory = [];
        state.responseHTML = getWelcomeHTML(currentMode);
        state.isLoading = false;

        responseContainer.innerHTML = state.responseHTML;
        responseActions.style.display = 'none';
    }

    function copyResponse() {
        navigator.clipboard.writeText(responseContainer.innerText).then(() => {
            const btn = $('copy-btn');
            btn.innerHTML = '<i class="fa-solid fa-check"></i><span>Скопировано!</span>';
            setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-copy"></i><span>Копировать</span>'; }, 2000);
        });
    }

    function exportToHtml() {
        const config = MODE_CONFIGS[currentMode];
        const catId = getCategoryForMode(currentMode);
        const color = getCategoryColor(catId);
        const date = new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${config.name} - Консультация</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px 20px; background: #f8fafc; color: #0f172a; line-height: 1.7; }
        .container { background: #ffffff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; }
        .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e2e8f0; }
        .header h1 { color: ${color}; font-size: 24px; margin-bottom: 8px; }
        .header .meta { color: #64748b; font-size: 14px; }
        .content { font-size: 15px; line-height: 1.8; }
        .content h2, .content h3 { color: #0f172a; margin: 28px 0 16px 0; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .content h2 { font-size: 20px; text-align: center; border-color: ${color}; }
        .content h3 { font-size: 17px; }
        .content p { margin: 14px 0; }
        .content ul, .content ol { padding-left: 24px; margin: 14px 0; }
        .content li { margin: 8px 0; }
        .content strong { color: #1d4ed8; }
        .content hr { border: none; height: 1px; background: #e2e8f0; margin: 28px 0; }
        .content table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .content th { background: ${color}; color: white; padding: 12px 16px; text-align: left; font-weight: 600; }
        .content td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; }
        .content tbody tr:nth-child(even) { background: #f8fafc; }
        .content a { color: #2563eb; }
        .footer { margin-top: 32px; padding-top: 24px; border-top: 1px solid #e2e8f0; text-align: center; color: #94a3b8; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💬 ${config.name}</h1>
            <div class="meta">Дата: ${date}</div>
        </div>
        <div class="content">${responseContainer.innerHTML}</div>
        <div class="footer">Документ создан с помощью Консультант AI</div>
    </div>
</body>
</html>`;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${config.name}_${Date.now()}.html`;
        a.click();
        URL.revokeObjectURL(url);

        const btn = $('export-html-btn');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>Сохранено!</span>';
        setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-file-code"></i><span>HTML</span>'; }, 2000);
    }

    async function openFlowchart(mermaidCode) {
        mermaidContainer.innerHTML = '';
        flowchartModal.style.display = 'flex';
        try {
            const id = 'mermaid-' + Date.now();
            const { svg } = await mermaid.render(id, mermaidCode);
            mermaidContainer.innerHTML = svg;
        } catch (e) {
            mermaidContainer.innerHTML = `<p style="color: #ef4444;">Ошибка: ${e.message}</p>`;
        }
    }

    function saveFlowchartSVG() {
        const svg = mermaidContainer.querySelector('svg');
        if (!svg) return;
        const data = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `flowchart_${Date.now()}.svg`;
        a.click();
        URL.revokeObjectURL(url);
    }

    init();
});
</script>
</body>
</html>
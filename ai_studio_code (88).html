<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid-график v6 (Про-навигация)</title>
    <!-- Подключаем библиотеку для графиков Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Подключаем плагин для зума и панорамирования -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container {
            display: flex; gap: 20px; width: 100%; max-width: 1400px;
        }
        .panel {
            background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .settings-panel {
            flex: 0 0 300px;
        }
        .chart-panel {
            flex-grow: 1; height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        h1, h2 {
            color: #1a237e; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block; margin-bottom: 8px; font-weight: 600; color: #555;
        }
        textarea, input {
            width: calc(100% - 22px); padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px;
        }
        input[type="file"] { padding: 3px; }
        textarea { height: 150px; resize: vertical; font-family: "Courier New", Courier, monospace; }
        button {
            background-color: #3949ab; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s, transform 0.1s; margin-top: 10px;
        }
        button:hover { background-color: #1a237e; }
        button:active { transform: scale(0.98); }
        #chart-placeholder { color: #999; font-size: 1.2em; text-align: center; }
        .info-text {
            color: #4a5568; background-color: #edf2f7; border-radius: 6px; padding: 10px;
            font-size: 0.9em; margin-top: 15px; text-align: center; border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>

    <h1>Grid-график с профессиональной навигацией</h1>

    <div class="container">
        <div class="panel settings-panel">
            <h2>Настройки</h2>
            <div class="control-group">
                <label for="gridStepPips">Шаг сетки (в пунктах):</label>
                <input type="number" id="gridStepPips" value="50">
            </div>
            <div class="control-group">
                <label for="csvFile">1. Загрузите CSV файл...</label>
                <input type="file" id="csvFile" accept=".csv,.txt">
            </div>
            <div class="control-group">
                <label for="priceData">2. ...или вставьте данные сюда:</label>
                <textarea id="priceData" placeholder="Данные сохранятся после первой загрузки. Для перестроения графика просто измените шаг и нажмите кнопку."></textarea>
            </div>
            <button id="buildChartBtn">Построить / Перестроить график</button>
        </div>

        <div class="panel chart-panel">
            <canvas id="gridChart" style="display: none;"></canvas>
            <div id="chart-placeholder">Здесь появится ваш график.</div>
            <div class="info-text">
                <b>Навигация:</b><br>
                <b>Мышь:</b> Колесо - зум | Зажать ЛКМ и тащить - прокрутка<br>
                <b>Клавиатура:</b> Клавиши `+` / `-` - зум | `←` / `→` - прокрутка
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let g_parsedData = null; // Глобальная переменная для кеширования данных

        // --- Обработчик загрузки файла ---
        const fileInput = document.getElementById('csvFile');
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('priceData').value = e.target.result;
                g_parsedData = null; // Сбрасываем кеш при загрузке нового файла
            };
            reader.readAsText(file);
        });

        // --- Главный обработчик кнопки ---
        document.getElementById('buildChartBtn').addEventListener('click', () => {
            const rawDataFromInput = document.getElementById('priceData').value.trim();

            // Если есть новые данные в текстовом поле или кеш пуст, парсим их
            if (rawDataFromInput && !g_parsedData) {
                g_parsedData = parseData(rawDataFromInput);
                if (!g_parsedData) {
                    alert('Не удалось обработать данные. Проверьте формат.');
                    return;
                }
            } else if (!g_parsedData) {
                alert('Нет данных для обработки. Загрузите файл или вставьте текст.');
                return;
            }

            // Используем кешированные данные для построения
            const gridStepPips = parseInt(document.getElementById('gridStepPips').value);
            if (!gridStepPips || gridStepPips <= 0) { alert('Введите корректный шаг сетки.'); return; }
            
            const gridChartResult = generateGridData(g_parsedData, gridStepPips);
            logSummary(g_parsedData, gridChartResult, gridStepPips);
            drawChart(gridChartResult, gridStepPips);
        });
        
        // --- Обработчик нажатий клавиш ---
        window.addEventListener('keydown', (event) => {
            if (!myChart) return; // Ничего не делаем, если графика нет

            const panAmount = 50; // На сколько пикселей смещать
            const zoomFactor = 1.1; // 10% зум

            switch(event.key) {
                case 'ArrowLeft':
                    myChart.pan({ x: -panAmount }, 'default');
                    event.preventDefault();
                    break;
                case 'ArrowRight':
                    myChart.pan({ x: panAmount }, 'default');
                    event.preventDefault();
                    break;
                case '+':
                case '=': // Для '+' без Shift и на Numpad
                    myChart.zoom(zoomFactor);
                    event.preventDefault();
                    break;
                case '-':
                    myChart.zoom(1 / zoomFactor); // Zoom out
                    event.preventDefault();
                    break;
            }
        });
        
        function parseData(rawData) { /* ... функция без изменений ... */
            const lines = rawData.trim().split('\n');
            const firstLineParts = lines[0].trim().split(/[\s,]+/);
            if (firstLineParts.length >= 6) {
                return lines.map(line => {
                    const parts = line.trim().split(',');
                    if (parts.length < 6) return null;
                    const p = (v) => parseFloat(v.replace(',', '.'));
                    return { date: parts[0], open: p(parts[2]), high: p(parts[3]), low: p(parts[4]), close: p(parts[5]) };
                }).filter(i => i && !isNaN(i.close));
            } else {
                return lines.map(line => {
                    const parts = line.trim().split(/\s+/);
                    if (parts.length < 2) return null;
                    const price = parseFloat(parts[1].replace(',', '.'));
                    if (isNaN(price)) return null;
                    return { date: parts[0], open: price, high: price, low: price, close: price };
                }).filter(Boolean);
            }
        }
        
        function logSummary(parsedData, gridResult, gridStepPips) { /* ... функция без изменений ... */
             console.clear();
             console.log("--- Сводка по обработке данных ---");
             console.log(`Шаг сетки: ${gridStepPips} пипсов.`);
             console.log(`Всего входных строк: ${parsedData.length}`);
             console.log(`Первая запись:`, parsedData[0]);
             console.log(`Последняя запись:`, parsedData[parsedData.length - 1]);
             console.log(`Сгенерировано событий: ${gridResult.dataPoints.length}`);
             console.log("------------------------------------");
        }

        function generateGridData(priceData, gridStepPips) { /* ... функция без изменений ... */
            const firstPrice = priceData[0].close;
            const decimals = Math.max(...priceData.map(p => (p.close.toString().split('.')[1] || '').length));
            const pointMultiplier = (decimals === 5 || decimals === 3) ? 10 : 1;
            const gridStepPrice = gridStepPips * pointMultiplier * (1 / Math.pow(10, decimals));

            const labels = [];
            const dataPoints = [];
            let currentLevel = Math.round(firstPrice / gridStepPrice) * gridStepPrice;
            
            labels.push(`Старт: ${priceData[0].date}`);
            dataPoints.push(currentLevel);

            for (const candle of priceData) {
                const candleDirection = candle.close >= candle.open ? 'up' : 'down';
                const processMoves = (primaryMove, secondaryMove) => {
                    while (primaryMove(candle, currentLevel, gridStepPrice)) {
                        currentLevel = primaryMove === checkUp ? currentLevel + gridStepPrice : currentLevel - gridStepPrice;
                        labels.push(candle.date);
                        dataPoints.push(currentLevel);
                    }
                    while (secondaryMove(candle, currentLevel, gridStepPrice)) {
                        currentLevel = secondaryMove === checkUp ? currentLevel + gridStepPrice : currentLevel - gridStepPrice;
                        labels.push(candle.date);
                        dataPoints.push(currentLevel);
                    }
                };
                const checkUp = (c, level, step) => c.high >= level + step;
                const checkDown = (c, level, step) => c.low <= level - step;
                if (candleDirection === 'up') processMoves(checkUp, checkDown);
                else processMoves(checkDown, checkUp);
            }
            return { labels, dataPoints };
        }

        function drawChart(result, gridStepPips) {
            document.getElementById('chart-placeholder').style.display = 'none';
            const chartCanvas = document.getElementById('gridChart');
            chartCanvas.style.display = 'block';

            if (myChart) myChart.destroy();

            myChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: result.labels,
                    datasets: [{
                        label: `Grid-график (Шаг ${gridStepPips} пипсов)`,
                        data: result.dataPoints,
                        borderColor: '#3949ab',
                        backgroundColor: 'rgba(57, 73, 171, 0.1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#ffab00',
                        pointBorderColor: '#ffffff',
                        pointHoverRadius: 7,
                        fill: true,
                        tension: 0 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', title: { display: true, text: 'Дата события' }, grid: { color: '#e9e9e9' } },
                        y: { title: { display: true, text: 'Цена' }, grid: { color: '#e0e0e0' } }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index', intersect: false, backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                title: (items) => `Событие #${items[0].dataIndex} | Дата: ${items[0].label}`
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                threshold: 5,
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
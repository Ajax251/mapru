<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Извлечение и Загрузка HTTP-ссылок</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="webfonts/all.min.css" rel="stylesheet">
    <link rel="icon" href="https://img.icons8.com/?size=100&id=IhjVlIwcAgzS&format=png&color=000000" type="image/png">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
        }
        .container {
            width: 100%;
            max-width: 900px;
        }
        h1 {
            margin-bottom: 30px;
            width: 100%;
            text-align: center;
            color: #2c3e50;
            font-size: 2.2em;
            font-weight: 700;
            animation: fadeIn 1s ease-out;
        }
        h1 .icon {
            margin-right: 10px;
            color: #3498db;
        }

        .input-section, .direct-download-section, .results-section {
            border: 1px solid #dfe6e9;
            padding: 25px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .input-section:hover, .direct-download-section:hover, .results-section:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .input-section h2, .direct-download-section h2, .results-section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.5em;
            font-weight: 500;
        }
        .input-section h2 .icon, .direct-download-section h2 .icon, .results-section h2 .icon {
            margin-right: 10px;
            color: #3498db;
        }


        textarea, input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
            font-size: 16px;
            font-family: 'Roboto', Arial, sans-serif;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        textarea {
            height: 150px;
            resize: vertical;
        }
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        input:disabled, textarea:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }


        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .buttons button {
            text-decoration: none;
            color: white;
            background-color: #3498db;
            padding: 12px 25px;
            border-radius: 25px;
            text-align: center;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            min-width: 180px;
        }
        .buttons button:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .buttons button:disabled {
            background-color: #a5b1c2;
            cursor: not-allowed;
        }
        .buttons button .icon {
            margin-right: 10px;
        }
        
        .info-note {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        #status {
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500; 
            transition: all 0.3s ease;
        }
        .loading { background-color: #3498db; color: white; }
        .success { background-color: #2ecc71; color: white; }
        .error { background-color: #e74c3c; color: white; }
        .spinner {
            display: inline-block;
            width: 18px; height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #output ul {
            list-style-type: none;
            padding: 0;
            margin-top: 20px; 
        }
        #output li {
            background-color: #f8f9fa; 
            margin-bottom: 10px;
            padding: 12px 15px; 
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.4s ease-out;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .link {
            color: #2980b9;
            text-decoration: none;
            cursor: pointer;
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-all;
            font-size: 0.95em;
        }
        .link:hover { text-decoration: underline; color: #1f638f; }

        .copy-btn, .download-btn {
            background-color: transparent;
            color: #576574; 
            border: none;
            border-radius: 50%; 
            width: 32px; height: 32px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em; 
            margin-left: 5px;
        }
        .copy-btn:hover { background-color: #e8f5e9; color: #2ecc71; } 
        .download-btn:hover { background-color: #e3f2fd; color: #2980b9; } 
        
        .copy-all-btn, .download-all-btn, .load-images-btn, .show-thumbnails-btn {
            text-decoration: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
        }
        .copy-all-btn { background-color: #f39c12; }
        .copy-all-btn:hover:not(:disabled) { background-color: #e67e22; }
        .download-all-btn { background-color: #2980b9; }
        .download-all-btn:hover:not(:disabled) { background-color: #2c3e50; }
        .load-images-btn { background-color: #8e44ad; }
        .load-images-btn:hover:not(:disabled) { background-color: #732d91; }
        .show-thumbnails-btn { background-color: #16a085; } /* New button color */
        .show-thumbnails-btn:hover:not(:disabled) { background-color: #117a65; }


        .copy-all-btn:disabled, .download-all-btn:disabled, .load-images-btn:disabled, .show-thumbnails-btn:disabled {
            background-color: #a5b1c2;
            cursor: not-allowed;
        }

        .batch-actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .action-icon { margin-right: 8px; } 
        @keyframes copyAnimation {
            0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); }
        }
        .copy-animation { animation: copyAnimation 0.3s ease-in-out; }

        .link-count {
            margin-bottom: 15px;
            font-weight: 500;
            color: #34495e;
            text-align: center;
        }

        .preview-icon {
            width: 36px; 
            height: 36px;
            margin-left: 5px;
            border: 1px solid #ced6e0; 
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden; 
        }
        .preview-icon:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .preview-icon img, .preview-icon video {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 3px;
        }
        .preview-icon .fas { 
            font-size: 1.2em;
            color: #a4b0be;
        }
        
        .filter-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center; 
        }
        .filter-btn { 
            background-color: #5dade2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .filter-btn:hover { background-color: #3498db; }
        .filter-btn.active {
            background-color: #2980b9;
            box-shadow: 0 0 8px rgba(41, 128, 185, 0.5);
        }
        .filter-btn .icon { margin-right: 6px; }

        /* Modal for single image/video preview */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeInModal 0.3s ease;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%; max-height: 90%;
        }
        .modal-content img, .modal-content video {
            width: 100%; height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
        .close {
            position: absolute; top: 20px; right: 35px;
            color: #f1f1f1; font-size: 40px; font-weight: bold;
            transition: 0.3s;
            line-height: 1; 
            z-index: 1001; 
        }
        .close:hover, .close:focus { color: #bbb; text-decoration: none; cursor: pointer; }

        /* Thumbnails Modal Styles */
        .thumbnails-modal {
            display: none; position: fixed; z-index: 1050; /* Higher z-index */
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .thumbnails-modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .thumbnails-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .thumbnails-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }
        .thumbnails-close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #777;
            background: none;
            border: none;
            cursor: pointer;
        }
        .thumbnails-close-btn:hover { color: #333; }

        .thumbnail-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .thumbnail-controls label { font-weight: 500; color: #555; }
        .thumbnail-controls input[type="range"] {
            width: 200px;
            cursor: pointer;
        }
        .thumbnail-size-value { font-weight: bold; color: #3498db; }

        .thumbnails-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Gap between thumbnails */
            justify-content: center; /* Center items if they don't fill the row */
        }
        .thumbnail-item {
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: #3498db;
        }
        .thumbnail-item img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail-item .loading-placeholder, .thumbnail-item .error-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 1.5em;
        }
        .thumbnail-item .error-placeholder { color: #e74c3c; }


    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-sitemap icon"></i>Извлечение и Загрузка HTTP-ссылок</h1>

        <div class="input-section">
            <h2><i class="fas fa-sign-in-alt icon"></i>Источники ссылок</h2>
            <div class="buttons">
                <button id="uploadFileBtn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-upload icon"></i>Из файла</button>
                <button id="extractUrlBtn" onclick="extractLinksFromUrlWithUI()"><i class="fas fa-globe-americas icon"></i>Из URL</button>
            </div>
            <input type="file" id="fileInput" style="display: none;">
            <input type="text" id="urlInput" placeholder="Введите URL (например, example.com/page)">
            <p class="info-note"></p>
            <textarea id="textInput" placeholder="Или вставьте текст с HTTP-ссылками сюда"></textarea>
            <div class="buttons">
                <button id="extractTextBtn" onclick="extractLinksFromTextWithUI()"><i class="fas fa-paragraph icon"></i>Из текста</button>
            </div>
        </div>

        <div class="direct-download-section">
            <h2><i class="fas fa-list-ol icon"></i>Прямая загрузка по списку</h2>
            <textarea id="directLinksInput" placeholder="Вставьте сюда список URL для загрузки (каждый URL с новой строки)"></textarea>
            <div class="buttons">
                <button onclick="downloadDirectLinks()"><i class="fas fa-cloud-download-alt icon"></i>Загрузить из списка</button>
            </div>
        </div>

        <div class="results-section">
            <h2><i class="fas fa-poll icon"></i>Результаты извлечения</h2>
            <input type="text" id="filterInput" placeholder="Фильтр по ключевым словам (например, image pdf)">
            <div id="status"></div>
            <div id="output">
                <!-- Результаты будут здесь -->
            </div>
        </div>
    </div>
    
    <!-- Modal for single image/video preview -->
    <div id="previewModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Превью изображения">
            <video id="modalVideo" controls preload="metadata">
                <source src="" type="video/mp4">
                Ваш браузер не поддерживает тег video.
            </video>
        </div>
    </div>

    <!-- Thumbnails Modal -->
    <div id="thumbnailsModal" class="thumbnails-modal">
        <div class="thumbnails-modal-content">
            <div class="thumbnails-header">
                <h3>Эскизы изображений</h3>
                <button class="thumbnails-close-btn" onclick="closeThumbnailsModal()">&times;</button>
            </div>
            <div class="thumbnail-controls">
                <label for="thumbnailSizeSlider">Размер эскиза:</label>
                <input type="range" id="thumbnailSizeSlider" min="50" max="300" value="150">
                <span id="thumbnailSizeValue" class="thumbnail-size-value">150px</span>
            </div>
            <div id="thumbnailsGrid" class="thumbnails-grid">
                <!-- Thumbnails will be injected here -->
            </div>
        </div>
    </div>


    <script>
            const API_BASE_URL = "https://linkextractor.vercel.app"; 
        let allLinks = [];
        let filteredLinks = [];

        const fileInputEl = document.getElementById('fileInput');
        const textInputEl = document.getElementById('textInput');
        const urlInputEl = document.getElementById('urlInput');
        const filterInputEl = document.getElementById('filterInput');
        const outputEl = document.getElementById('output');
        const statusEl = document.getElementById('status');
        
        const directLinksInputEl = document.getElementById('directLinksInput');

        const modalEl = document.getElementById('previewModal');
        const modalImgEl = document.getElementById('modalImage');
        const modalVideoEl = document.getElementById('modalVideo');

        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const extractUrlBtn = document.getElementById('extractUrlBtn');
        const extractTextBtn = document.getElementById('extractTextBtn');

        // Thumbnails Modal Elements
        const thumbnailsModalEl = document.getElementById('thumbnailsModal');
        const thumbnailsGridEl = document.getElementById('thumbnailsGrid');
        const thumbnailSizeSliderEl = document.getElementById('thumbnailSizeSlider');
        const thumbnailSizeValueEl = document.getElementById('thumbnailSizeValue');
        
        fileInputEl.addEventListener('change', extractLinksFromFileWithUI);
        filterInputEl.addEventListener('input', debounce(() => filterLinks(getActiveFilterType()), 300));
        thumbnailSizeSliderEl.addEventListener('input', updateThumbnailSize);


        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function getActiveFilterType() {
            const activeButton = outputEl.querySelector('.filter-btn.active');
            return activeButton ? activeButton.dataset.type : 'all';
        }

        function setStatus(message, type, isLoading = false) {
            statusEl.textContent = message;
            statusEl.className = ''; 
            statusEl.classList.add(type); 
            if (isLoading) {
                statusEl.innerHTML = `<span class="spinner"></span> ${message}`;
                statusEl.classList.add('loading');
            }
            if ((type === 'success' || type === 'error') && !isLoading) {
                setTimeout(() => {
                    if (statusEl.textContent === message && (statusEl.classList.contains('success') || statusEl.classList.contains('error'))) {
                        statusEl.textContent = '';
                        statusEl.className = '';
                    }
                }, 7000); 
            }
        }
        
        function setExtractionInputsDisabled(disabled) {
            urlInputEl.disabled = disabled;
            textInputEl.disabled = disabled;
            fileInputEl.disabled = disabled; 
            uploadFileBtn.disabled = disabled;
            extractUrlBtn.disabled = disabled;
            extractTextBtn.disabled = disabled;
        }

        function processBackendResponse(data) {
            allLinks = data.links || [];
             if (allLinks.length > 0) {
                filterInputEl.value = ''; 
                filterLinks('all'); 
                setStatus(data.message || `Найдено ${allLinks.length} уникальных ссылок.`, 'success');
            } else {
                displayLinks([], 'all'); 
                setStatus(data.message || 'Ссылки не найдены в предоставленных данных.', 'info');
            }
            if (data.effective_url && urlInputEl.value !== data.effective_url) {
                urlInputEl.value = data.effective_url;
            }
        }

        async function extractLinksFromFileWithUI() {
            const file = fileInputEl.files[0];
            if (!file) return;

            setStatus('Загрузка и обработка файла на сервере...', 'loading', true);
            setExtractionInputsDisabled(true);

            const formData = new FormData();
            formData.append('file', file);

            try {
            // Новый код
const response = await fetch(`${API_BASE_URL}/extract-from-file/`, {
    method: 'POST',
    body: formData,
});
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || `Ошибка сервера: ${response.status}`);
                }
                processBackendResponse(data);
            } catch (error) {
                console.error('Ошибка при извлечении из файла:', error);
                setStatus(`Ошибка: ${error.message}`, 'error');
                allLinks = []; filteredLinks = []; displayLinks([], 'all');
            } finally {
                setExtractionInputsDisabled(false);
                fileInputEl.value = ''; 
            }
        }
        
        async function extractLinksFromTextWithUI() {
            const text = textInputEl.value.trim();
            if (!text) {
                setStatus('Пожалуйста, введите текст.', 'info');
                allLinks = []; filteredLinks = []; displayLinks([], 'all');
                return;
            }
            setStatus('Обработка текста на сервере...', 'loading', true);
            setExtractionInputsDisabled(true);

            const formData = new FormData();
            formData.append('text_input', text);
            
            try {
         
const response = await fetch(`${API_BASE_URL}/extract-from-text/`, {
    method: 'POST',
    body: formData,
});
                const data = await response.json();
                if (!response.ok) {
                     throw new Error(data.detail || `Ошибка сервера: ${response.status}`);
                }
                processBackendResponse(data);
            } catch (error) {
                console.error('Ошибка при извлечении из текста:', error);
                setStatus(`Ошибка: ${error.message}`, 'error');
                allLinks = []; filteredLinks = []; displayLinks([], 'all');
            } finally {
                setExtractionInputsDisabled(false);
            }
        }

        async function extractLinksFromUrlWithUI() {
            const urlVal = urlInputEl.value.trim();
            if (!urlVal) {
                setStatus('Пожалуйста, введите URL.', 'error');
                return;
            }
            setStatus('Запрос к URL через сервер...', 'loading', true);
            setExtractionInputsDisabled(true);

            const formData = new FormData();
            formData.append('url_input', urlVal);

            try {
            const response = await fetch(`${API_BASE_URL}/extract-from-url/`, {
    method: 'POST',
    body: formData,
});
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || `Ошибка сервера: ${response.status}`);
                }
                processBackendResponse(data);
            } catch (error) {
                console.error('Ошибка при извлечении из URL:', error);
                setStatus(`Ошибка: ${error.message}`, 'error');
                allLinks = []; filteredLinks = []; displayLinks([], 'all');
            } finally {
                setExtractionInputsDisabled(false);
            }
        }
        
        function filterLinks(type = 'all') {
            const filterText = filterInputEl.value.toLowerCase().trim();
            const keywords = filterText.split(' ').filter(word => word.length > 0);

            let baseFilteredLinks = allLinks;
            if (type === 'images') {
                baseFilteredLinks = allLinks.filter(link => isImageUrl(link));
            } else if (type === 'videos') {
                baseFilteredLinks = allLinks.filter(link => isVideoUrl(link));
            }

            if (keywords.length === 0) {
                filteredLinks = baseFilteredLinks;
            } else {
                filteredLinks = baseFilteredLinks.filter(link => 
                    keywords.every(keyword => link.toLowerCase().includes(keyword))
                );
            }
            displayLinks(filteredLinks, type); 
        }


        function displayLinks(linksToDisplay, activeFilterType = 'all') {
            outputEl.innerHTML = ''; 

            const noLinksMessage = allLinks.length === 0 
                ? '<p style="text-align:center; color:#7f8c8d;">Извлеките или введите ссылки для отображения.</p>'
                : '<p style="text-align:center; color:#7f8c8d;">Нет ссылок, соответствующих текущим фильтрам.</p>';

            const listHtml = linksToDisplay.map((link) => {
                const safeLink = link.replace(/'/g, "\\'");
                return `
                <li>
                    <a href="${link}" target="_blank" rel="noopener noreferrer" class="link" title="${link}">${link}</a>
                    <button class="copy-btn" onclick="copyToClipboard('${safeLink}', this)" title="Копировать ссылку">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="download-btn" onclick="downloadSingleLink('${safeLink}')" title="Скачать файл">
                        <i class="fas fa-download"></i>
                    </button>
                    <span class="preview-icon" onclick="openModalWithPreview('${safeLink}', this)" title="Предпросмотр (клик для увеличения)">
                        ${isImageUrl(link) ? '<i class="fas fa-image"></i>' : isVideoUrl(link) ? '<i class="fas fa-video"></i>' : '<i class="fas fa-file-alt"></i>'}
                    </span>
                </li>`;
            }).join('');
            
            const mediaLinksForPreview = linksToDisplay.filter(l => isImageUrl(l) || isVideoUrl(l));
            const imageLinksForThumbnails = linksToDisplay.filter(l => isImageUrl(l));


            outputEl.innerHTML = `
                <p class="link-count">Отображаемых ссылок: ${linksToDisplay.length} (из ${allLinks.length} всего)</p>
                
                <div class="filter-buttons-container">
                    <button class="filter-btn ${activeFilterType === 'all' ? 'active' : ''}" data-type="all" onclick="filterLinks('all')"><i class="fas fa-list icon"></i>Все</button>
                    <button class="filter-btn ${activeFilterType === 'images' ? 'active' : ''}" data-type="images" onclick="filterLinks('images')"><i class="fas fa-image icon"></i>Картинки</button>
                    <button class="filter-btn ${activeFilterType === 'videos' ? 'active' : ''}" data-type="videos" onclick="filterLinks('videos')"><i class="fas fa-video icon"></i>Видео</button>
                    <button class="load-images-btn" onclick="loadAllPreviewsUI()" title="Загрузить превью для текущего списка" ${mediaLinksForPreview.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-images action-icon"></i>Все превью
                    </button>
                    <button class="show-thumbnails-btn" onclick="openThumbnailsModalUI()" title="Показать эскизы изображений" ${imageLinksForThumbnails.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-th action-icon"></i>Эскизы
                    </button>
                </div>

                ${linksToDisplay.length > 0 ? `<ul>${listHtml}</ul>` : noLinksMessage}

                <div class="batch-actions-container">
                    <button class="copy-all-btn" onclick="copyAllFilteredLinks()" ${linksToDisplay.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-copy action-icon"></i>Копировать (${linksToDisplay.length})
                    </button>
                    <button class="download-all-btn" onclick="downloadAllFilteredLinksUI()" ${linksToDisplay.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-download action-icon"></i>Загрузить (${linksToDisplay.length})
                    </button>
                </div>
            `;
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                if (button) {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.classList.add('copy-animation');
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.classList.remove('copy-animation');
                    }, 1000);
                }
                setStatus('Ссылка скопирована!', 'success');
            }).catch(err => {
                console.error('Ошибка копирования: ', err);
                setStatus('Ошибка копирования.', 'error');
            });
        }

        function copyAllFilteredLinks() {
            if (filteredLinks.length === 0) {
                setStatus('Нет ссылок для копирования.', 'info');
                return;
            }
            const allLinksText = filteredLinks.join('\n');
            navigator.clipboard.writeText(allLinksText).then(() => {
                const button = outputEl.querySelector('.copy-all-btn');
                if (button) { 
                    button.classList.add('copy-animation');
                    setTimeout(() => button.classList.remove('copy-animation'), 300);
                }
                setStatus(`Скопировано ${filteredLinks.length} ссылок.`, 'success');
            }).catch(err => {
                console.error('Ошибка копирования всех ссылок: ', err);
                setStatus('Ошибка копирования ссылок.', 'error');
            });
        }
        
        async function downloadFile(url, defaultFilename = 'download') {
            try {
                const response = await fetch(url, { mode: 'cors' }); 
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                const blob = await response.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                
                let filename = defaultFilename;
                const contentDisposition = response.headers.get('content-disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename\*?=['"]?(?:UTF-\d['"]*)?([^;\r\n"']+)/i);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = decodeURIComponent(filenameMatch[1]);
                    }
                }
                if (filename === defaultFilename || !filename.includes('.')) { 
                    const pathPart = new URL(url).pathname;
                    const lastSegment = pathPart.substring(pathPart.lastIndexOf('/') + 1);
                    if (lastSegment && lastSegment.includes('.')) filename = lastSegment.split(/[?#]/)[0];
                }
                 if (!filename.includes('.') && blob.type && blob.type.includes('/') && blob.type !== 'application/octet-stream') {
                    const ext = blob.type.split('/')[1].split('+')[0]; 
                    if (ext && !['plain', 'html', 'xml'].includes(ext)) filename += `.${ext}`;
                }
                filename = filename || defaultFilename; 

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                return { success: true, filename, url };
            } catch (error) {
                console.error(`Ошибка загрузки ${url}:`, error);
                return { success: false, url, error: error.message };
            }
        }

        function downloadSingleLink(url) {
            const filenameFromUrl = url.substring(url.lastIndexOf('/') + 1).split(/[?#]/)[0] || "файл";
            setStatus(`Загрузка файла: ${filenameFromUrl}...`, 'loading', true);
            downloadFile(url, filenameFromUrl).then(result => {
                if (result.success) {
                    setStatus(`Файл ${result.filename} успешно загружен.`, 'success');
                } else {
                    setStatus(`Ошибка загрузки ${filenameFromUrl}: ${result.error}`, 'error');
                }
            });
        }

        async function processBatchDownloads(urls, operationName) {
            if (urls.length === 0) {
                setStatus(`Нет файлов для операции "${operationName}".`, 'info');
                return;
            }
            setStatus(`Начинаю "${operationName}" для ${urls.length} файлов...`, 'loading', true);
            let successCount = 0;
            let failCount = 0;
            const failedUrls = [];

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                const filenameFromUrl = url.substring(url.lastIndexOf('/') + 1).split(/[?#]/)[0] || "файл";
                setStatus(`"${operationName}" (${i+1}/${urls.length}): ${filenameFromUrl.substring(0,30)}...`, 'loading', true);
                const result = await downloadFile(url, filenameFromUrl);
                if (result.success) {
                    successCount++;
                } else {
                    failCount++;
                    failedUrls.push({url: result.url, error: result.error});
                }
                if (i < urls.length - 1) await new Promise(resolve => setTimeout(resolve, 300)); 
            }

            let finalMessage = `Операция "${operationName}" завершена. Успешно: ${successCount}. Ошибок: ${failCount}.`;
            setStatus(finalMessage, failCount > 0 ? 'error' : 'success');
            if (failCount > 0) {
                console.warn(`Не удалось загрузить ${failCount} файлов во время "${operationName}":`, failedUrls);
            }
        }
        
        function downloadAllFilteredLinksUI() {
            processBatchDownloads(filteredLinks, "Загрузка отфильтрованных");
        }
        
        function downloadDirectLinks() {
            const text = directLinksInputEl.value;
            const urls = text.split('\n')
                             .map(line => line.trim())
                             .filter(line => (line.startsWith('http://') || line.startsWith('https://')) && line.length > 10);
            if (urls.length === 0) {
                setStatus("В списке нет действительных URL для загрузки.", 'error');
                return;
            }
            processBatchDownloads(urls, "Загрузка из списка");
        }

        function isImageUrl(url) {
            try { const u = new URL(url); return /\.(jpg|jpeg|png|gif|bmp|webp|svg|ico)(\?.*)?$/i.test(u.pathname); } catch { return false; }
        }

        function isVideoUrl(url) {
            try { const u = new URL(url); return /\.(mp4|webm|ogg|ogv|mov|avi|wmv|flv|mkv|m4v|3gp)(\?.*)?$/i.test(u.pathname); } catch { return false; }
        }   

        function loadIndividualPreview(url, iconElement) {
            iconElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            if (isImageUrl(url)) {
                const img = new Image();
                img.onload = () => { iconElement.innerHTML = ''; iconElement.appendChild(img); };
                img.onerror = () => { iconElement.innerHTML = '<i class="fas fa-exclamation-circle" title="Ошибка загрузки превью"></i>'; console.warn("Не удалось загрузить превью изображения:", url); };
                img.crossOrigin = "anonymous"; 
                img.src = url;
            } else if (isVideoUrl(url)) {
                iconElement.innerHTML = '<i class="fas fa-video" title="Видео (клик для просмотра)"></i>'; 
            } else {
                iconElement.innerHTML = '<i class="fas fa-file-alt" title="Файл"></i>'; 
            }
        }
        
        function openModalWithPreview(url, iconElement) {
            openModal(url, isVideoUrl(url) ? 'video' : 'image');
        }

        function openModal(url, type) {
            modalEl.style.display = "block";
            document.body.style.overflow = 'hidden'; 
            
            if (type === 'image') {
                modalImgEl.style.display = "block";
                modalVideoEl.style.display = "none";
                modalImgEl.src = url;
                modalImgEl.alt = `Превью для ${url}`;
            } else if (type === 'video') {
                modalImgEl.style.display = "none";
                modalVideoEl.style.display = "block";
                const sourceEl = modalVideoEl.querySelector('source') || document.createElement('source');
                sourceEl.src = url;
                
                let videoType = "video/mp4"; 
                const extMatch = url.match(/\.([^.?#]+)(?:[?#]|$)/);
                if (extMatch && extMatch[1]) {
                    const ext = extMatch[1].toLowerCase();
                    if (['webm', 'ogv', 'ogg'].includes(ext)) videoType = `video/${ext}`;
                }
                sourceEl.type = videoType;

                if (!modalVideoEl.contains(sourceEl)) modalVideoEl.appendChild(sourceEl);
                modalVideoEl.load();
                modalVideoEl.play().catch(e => console.warn("Автовоспроизведение видео предотвращено/ошибка:", e));
                
                modalVideoEl.onerror = (e) => {
                    console.error("Ошибка загрузки видео в модальном окне:", e, modalVideoEl.error);
                    setStatus('Не удалось загрузить видео. Проверьте URL, формат или CORS.', 'error');
                    closeModal(); 
                };
            }
        }
        
        function closeModal() {
            modalEl.style.display = "none";
            document.body.style.overflow = 'auto'; 
            modalVideoEl.pause();
            modalImgEl.src = "about:blank"; 
            const videoSource = modalVideoEl.querySelector('source');
            if (videoSource) videoSource.src = ""; 
            modalVideoEl.load(); 
        }
        
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modalEl.style.display === "block") {
                closeModal();
            }
            if (event.key === 'Escape' && thumbnailsModalEl.style.display === "block") {
                closeThumbnailsModal();
            }
        });

        modalEl.addEventListener('click', function(event) { 
            if (event.target === modalEl) {
                closeModal();
            }
        });
        thumbnailsModalEl.addEventListener('click', function(event) { 
            if (event.target === thumbnailsModalEl) { // Click on backdrop
                closeThumbnailsModal();
            }
        });


        async function loadAllPreviewsUI() {
            const previewIconsToLoadQuery = '.preview-icon:not(:has(img)):not(:has(video))'; 
            const allIconElements = Array.from(outputEl.querySelectorAll(previewIconsToLoadQuery));
            
            const iconsForMedia = allIconElements.filter(iconEl => {
                const link = iconEl.closest('li')?.querySelector('.link')?.href;
                return link && (isImageUrl(link) || isVideoUrl(link));
            });


            if (iconsForMedia.length === 0) {
                setStatus("Все доступные превью уже загружены или нет медиа-ссылок для превью.", "info");
                return;
            }
            setStatus(`Загрузка превью для ${iconsForMedia.length} элементов...`, 'loading', true);
            let loadedCount = 0;
            const batchSize = 5;

            for (let i = 0; i < iconsForMedia.length; i += batchSize) {
                const batch = iconsForMedia.slice(i, i + batchSize);
                const promises = batch.map(icon => {
                    const link = icon.closest('li').querySelector('.link').href;
                    return new Promise(resolve => {
                        loadIndividualPreview(link, icon);
                        if (isImageUrl(link)) {
                            const imgObserver = new MutationObserver((mutationsList, observer) => {
                                for(const mutation of mutationsList) {
                                    if (mutation.type === 'childList' && (icon.querySelector('img') || icon.querySelector('.fa-exclamation-circle'))) {
                                        observer.disconnect();
                                        resolve();
                                        break;
                                    }
                                }
                            });
                            imgObserver.observe(icon, { childList: true });
                        } else {
                            resolve(); 
                        }
                    });
                });
                
                await Promise.all(promises);
                loadedCount += batch.length;
                setStatus(`Загрузка превью... (${loadedCount}/${iconsForMedia.length})`, 'loading', true);
                await new Promise(r => setTimeout(r, 50)); 
            }
            setStatus(`Загрузка ${loadedCount} превью завершена.`, 'success');
        }

        // --- Thumbnail Modal Functions ---
        function openThumbnailsModalUI() {
            const imageLinks = filteredLinks.filter(link => isImageUrl(link));
            if (imageLinks.length === 0) {
                setStatus("Нет изображений для отображения в эскизах.", "info");
                return;
            }
            
            thumbnailsGridEl.innerHTML = ''; // Clear previous thumbnails
            const initialSize = parseInt(thumbnailSizeSliderEl.value, 10);

            imageLinks.forEach(link => {
                const item = document.createElement('div');
                item.classList.add('thumbnail-item');
                item.style.width = `${initialSize}px`;
                item.style.height = `${initialSize}px`;
                item.dataset.src = link;

                const placeholder = document.createElement('div');
                placeholder.classList.add('loading-placeholder');
                placeholder.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                item.appendChild(placeholder);
                
                const img = new Image();
                img.onload = () => {
                    item.innerHTML = ''; // Remove placeholder
                    item.appendChild(img);
                };
                img.onerror = () => {
                    item.innerHTML = '<div class="error-placeholder" title="Ошибка загрузки"><i class="fas fa-exclamation-triangle"></i></div>';
                };
                img.crossOrigin = "anonymous";
                img.src = link;
                
                item.addEventListener('click', () => {
                    openModal(link, 'image'); // Use existing modal for full preview
                });
                thumbnailsGridEl.appendChild(item);
            });

            thumbnailsModalEl.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeThumbnailsModal() {
            thumbnailsModalEl.style.display = 'none';
            document.body.style.overflow = 'auto';
            // No need to clear grid here, openThumbnailsModalUI does it
        }

        function updateThumbnailSize() {
            const newSize = parseInt(thumbnailSizeSliderEl.value, 10);
            thumbnailSizeValueEl.textContent = `${newSize}px`;
            
            const thumbnailItems = thumbnailsGridEl.querySelectorAll('.thumbnail-item');
            thumbnailItems.forEach(item => {
                item.style.width = `${newSize}px`;
                item.style.height = `${newSize}px`;
            });
        }


        displayLinks([], 'all'); 
        setStatus("Готов к работе. Загрузите файл, введите текст или URL.", "success");

    </script>
</body>
</html>
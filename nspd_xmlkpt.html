<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Конвертер НСПД в XML с преобразованием СК</title>
    <!-- 1. ПОДКЛЮЧАЕМ БИБЛИОТЕКИ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>
    <!-- 2. ПОДКЛЮЧАЕМ ВАШ ФАЙЛ С СИСТЕМАМИ КООРДИНАТ -->
    <script src="sk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; }
        .container { background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 900px; width: 100%; }
        h1 { text-align: center; color: #0d2c4e; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; margin-top: 0; }
        .controls, .conversion-settings { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .conversion-settings { flex-wrap: wrap; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        .settings-group { display: flex; flex-direction: column; gap: 5px; }
        .settings-group label { font-size: 0.9em; font-weight: 500; color: #333; }
        .settings-group input, .settings-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .settings-group input[type="checkbox"] { transform: scale(1.3); margin-right: 5px; cursor: pointer; }
        input, select { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #quarterInput { flex-grow: 1; font-family: monospace; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: background-color 0.3s ease, transform 0.1s ease; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed; }
        #fetchButton { background-color: #007bff; }
        #convertButton { background-color: #28a745; }
        #downloadButton { background-color: #17a2b8; }
        #status { padding: 10px; border-radius: 4px; margin-bottom: 20px; text-align: center; font-weight: 500; }
        .log-info { background-color: #e7f3fe; color: #0056b3; }
        .log-success { background-color: #eaf7ec; color: #27ae60; }
        .log-error { background-color: #fceded; color: #c03b2b; }
        #output { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 6px; height: 400px; overflow: auto; white-space: pre; font-family: 'Fira Code', 'Courier New', monospace; font-size: 14px; border: 1px solid #3a4049; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Конвертер НСПД в XML с преобразованием СК</h1>
        <div class="controls">
            <input type="text" id="quarterInput" placeholder="Введите номер квартала">
            <button id="fetchButton">1. Получить JSON</button>
        </div>
        <fieldset class="conversion-settings">
            <legend>Настройки конвертации</legend>
            <div class="settings-group">
                <label for="convertCoordsCheckbox" style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="convertCoordsCheckbox" checked>Преобразовать СК</label>
            </div>
            <div class="settings-group">
                <label for="destScSelect">Целевая СК:</label><select id="destScSelect"></select>
            </div>
            <div class="settings-group">
                <label for="offsetXInput">Смещение X (м):</label><input type="number" id="offsetXInput" value="0" step="0.001">
            </div>
            <div class="settings-group">
                <label for="offsetYInput">Смещение Y (м):</label><input type="number" id="offsetYInput" value="0" step="0.001">
            </div>
            <div class="settings-group">
                 <label for="swapXmlCoordsCheckbox" style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="swapXmlCoordsCheckbox" checked>Поменять X/Y в XML</label>
            </div>
            <div class="settings-group">
                 <label for="reverseDirectionCheckbox" style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="reverseDirectionCheckbox" checked>Менять направление</label>
            </div>
        </fieldset>
        <div class="controls">
            <button id="convertButton" disabled>2. Преобразовать в XML</button>
            <button id="downloadButton" disabled>3. Скачать XML</button>
        </div>
        <div id="status" style="display: none;"></div>
        <pre id="output"><code>Здесь появится результат...</code></pre>
    </div>
    <script>
        // --- DOM Elements ---
        const quarterInput = document.getElementById('quarterInput');
        const fetchButton = document.getElementById('fetchButton');
        const convertButton = document.getElementById('convertButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusDiv = document.getElementById('status');
        const outputCode = document.querySelector('#output code');
        const convertCoordsCheckbox = document.getElementById('convertCoordsCheckbox');
        const destScSelect = document.getElementById('destScSelect');
        const offsetXInput = document.getElementById('offsetXInput');
        const offsetYInput = document.getElementById('offsetYInput');
        const swapXmlCoordsCheckbox = document.getElementById('swapXmlCoordsCheckbox');
        const reverseDirectionCheckbox = document.getElementById('reverseDirectionCheckbox');

        let lastFetchedJson = null;
        let generatedXml = null;
        const sevenDigitsRegions = ['24', '50', '63', '66', '77', '78', '91'];

        // --- Helper Functions ---
        function formatQuarterNumber(input) {
            let value = input.value.replace(/[^\d]/g, '');
            let formatted = '';
            const originalLength = value.length;
            if (originalLength > 0) formatted += value.substring(0, Math.min(2, originalLength));
            if (originalLength > 2) formatted += ':' + value.substring(2, Math.min(4, originalLength));
            const firstTwoDigits = value.substring(0, 2);
            const isSevenDigitQ = sevenDigitsRegions.includes(firstTwoDigits);
            const quarterMaxLength = isSevenDigitQ ? 7 : 6;
            if (originalLength > 4) formatted += ':' + value.substring(4, Math.min(4 + quarterMaxLength, originalLength));
            input.value = formatted;
        }

        async function fetchData() {
            const quarterNumber = quarterInput.value.trim();
            if (!/^\d{2}:\d{2}:\d{6,7}$/.test(quarterNumber)) {
                showStatus('Ошибка: неверный формат кадастрового квартала.', 'error'); return;
            }
            fetchButton.disabled = true; fetchButton.textContent = 'Загрузка...';
            convertButton.disabled = true; downloadButton.disabled = true;
            lastFetchedJson = null; generatedXml = null; outputCode.textContent = '';
            showStatus(`Запрашиваем данные для квартала ${quarterNumber}...`, 'info');
            try {
                const quarterGeomUrl = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=2&query=${quarterNumber}`;
                const quarterResponse = await fetch(quarterGeomUrl);
                if (!quarterResponse.ok) throw new Error(`Ошибка сети (геометрия): ${quarterResponse.status}`);
                const quarterData = await quarterResponse.json();
                if (!quarterData?.data?.features?.[0]?.geometry) throw new Error('Не удалось получить геометрию квартала.');
                const quarterGeometry = quarterData.data.features[0].geometry;
                const parcelsUrl = 'https://nspd.gov.ru/api/geoportal/v1/intersects?typeIntersect=fullObject';
                const parcelsResponse = await fetch(parcelsUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "geom": { "type": "FeatureCollection", "features": [{ "type": "Feature", "geometry": quarterGeometry, "properties": {} }] }, "categories": [{ "id": 36368 }] })
                });
                if (!parcelsResponse.ok) throw new Error(`Ошибка сети (участки): ${parcelsResponse.status}`);
                const parcelsData = await parcelsResponse.json();
                lastFetchedJson = parcelsData;
                const numFeatures = parcelsData?.features?.length || 0;
                showStatus(`Успешно! Найдено ${numFeatures} объектов. Теперь можно преобразовать в XML.`, 'success');
                outputCode.textContent = JSON.stringify(parcelsData, null, 2);
                if (numFeatures > 0) convertButton.disabled = false;
            } catch (error)
            {
                console.error("Ошибка при получении данных:", error);
                showStatus(`Ошибка: ${error.message}`, 'error');
            } finally {
                fetchButton.disabled = false; fetchButton.textContent = '1. Получить JSON';
            }
        }

        function convertJsonToXml() {
            if (!lastFetchedJson) { showStatus('Сначала нужно получить JSON данные.', 'error'); return; }
            if (typeof COORDINATE_SYSTEMS === 'undefined') { showStatus("Ошибка: Список СК не загружен.", "error"); return; }

            const performConversion = convertCoordsCheckbox.checked;
            const swapXmlCoords = swapXmlCoordsCheckbox.checked;
            const reverseDirection = reverseDirectionCheckbox.checked;
            const targetCS_value = destScSelect.value;
            const targetCS_text = destScSelect.options[destScSelect.selectedIndex].text;
            const offsetX = parseFloat(offsetXInput.value) || 0;
            const offsetY = parseFloat(offsetYInput.value) || 0;
            const sourceCS_value = 'EPSG:3857';

            if (performConversion) {
                try {
                    const sourceDef = COORDINATE_SYSTEMS.find(s => s.value === sourceCS_value)?.def;
                    const destDef = COORDINATE_SYSTEMS.find(s => s.value === targetCS_value)?.def;
                    if (!sourceDef || !destDef) throw new Error(`Определение для ${sourceCS_value} или ${targetCS_value} не найдено в sk.js`);
                    proj4.defs(sourceCS_value, sourceDef); proj4.defs(targetCS_value, destDef);
                } catch (e) { showStatus(`Ошибка определения СК: ${e.message}`, 'error'); return; }
            }
            
            const quarterNumber = quarterInput.value.trim();
            const today = new Date().toISOString().split('T')[0];
            const features = lastFetchedJson.features;
            const escapeXml = (unsafe) => unsafe ? String(unsafe).replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'}[c])) : '-';

            const landRecordsXml = features.map(feature => {
                const props = feature.properties.options || {};
                const geometry = feature.geometry;
                let finalSkId = 'EPSG:3857';

                const contoursXml = (geometry && geometry.coordinates) ? geometry.coordinates.map((ring) => {
                    let points = geometry.type === 'MultiPolygon' ? ring[0] : ring;
                    if (reverseDirection) {
                        points = points.slice().reverse();
                    }
                    const ordinatesXml = points.map((point, i) => {
                        let projectedX = point[0];
                        let projectedY = point[1];
                        
                        if (performConversion && targetCS_value !== sourceCS_value) {
                            try {
                                const convertedPoint = proj4(sourceCS_value, targetCS_value, [projectedX, projectedY]);
                                projectedX = convertedPoint[0];
                                projectedY = convertedPoint[1];
                                finalSkId = targetCS_text.split('(')[0].trim();
                            } catch(e) { 
                                console.error(`Ошибка конвертации точки: ${e.message}`);
                                return `<ordinate><error>CONVERSION_FAILED</error></ordinate>`;
                            }
                        }
                        
                        const decimalPlaces = targetCS_value === 'EPSG:4326' ? 8 : 2;
                        
                        let finalXmlX, finalXmlY;
                        if (swapXmlCoords) {
                            finalXmlX = (projectedY + offsetX).toFixed(decimalPlaces);
                            finalXmlY = (projectedX + offsetY).toFixed(decimalPlaces);
                        } else {
                            finalXmlX = (projectedX + offsetX).toFixed(decimalPlaces);
                            finalXmlY = (projectedY + offsetY).toFixed(decimalPlaces);
                        }

                        return `
                            <ordinate>
                                <x>${finalXmlX}</x>
                                <y>${finalXmlY}</y>
                                <ord_nmb>${i + 1}</ord_nmb>
                                <num_geopoint>${i + 1}</num_geopoint>
                                <delta_geopoint>0.1</delta_geopoint>
                            </ordinate>`;
                    }).join('');
                    return `
                    <contour><entity_spatial><sk_id>${escapeXml(finalSkId)}</sk_id><spatials_elements><spatial_element><ordinates>${ordinatesXml}</ordinates></spatial_element></spatials_elements></entity_spatial></contour>`;
                }).join('') : '';
                
                // --- ИСПРАВЛЕННАЯ ЛОГИКА ОПРЕДЕЛЕНИЯ ПЛОЩАДИ ---
                const isAreaSpecified = props.specified_area || props.land_record_area_verified;
                const areaValue = isAreaSpecified || props.declared_area || props.land_record_area_declaration || props.land_record_area;
                const areaXmlBlock = isAreaSpecified ?
                    `<area><value>${escapeXml(areaValue)}</value><inaccuracy>0</inaccuracy></area>` :
                    `<area><value>${escapeXml(areaValue)}</value></area>`;
                // --- КОНЕЦ ИСПРАВЛЕННОЙ ЛОГИКИ ---

                return `
        <land_record>
          <object>
            <common_data>
              <type>
                <code>002001001000</code>
                <value>${escapeXml(props.land_record_type || 'Земельный участок')}</value>
              </type>
              <cad_number>${escapeXml(props.cad_num)}</cad_number>
            </common_data>
          </object>
          <params>
            <category>
              <type>
                <code>003002000000</code>
                <value>${escapeXml(props.land_record_category_type)}</value>
              </type>
            </category>
            <permitted_use>
              <permitted_use_established>
                <by_document>${escapeXml(props.permitted_use_established_by_document)}</by_document>
              </permitted_use_established>
            </permitted_use>
            ${areaXmlBlock}
          </params>
          <address_location>
            <address>
              <readable_address>${escapeXml(props.readable_address)}</readable_address>
            </address>
          </address_location>
          <cost>
            <value>${escapeXml(props.cost_value)}</value>
          </cost>
          <contours_location>
            <contours>${contoursXml}</contours>
          </contours_location>
        </land_record>`;
            }).join('');
            
            const fullXml = `<?xml version="1.0" encoding="UTF-8"?>
<extract_cadastral_plan_territory>
  <details_statement>
    <group_top_requisites>
      <organ_registr_rights>Филиал ППК "Роскадастр" (данные из НСПД)</organ_registr_rights>
      <date_formation>${today}</date_formation>
      <registration_number>НСПД-КОНВЕРТЕР</registration_number>
    </group_top_requisites>
  </details_statement>
  <cadastral_blocks>
    <cadastral_block>
      <cadastral_number>${escapeXml(quarterNumber)}</cadastral_number>
      <record_data>
        <base_data>
          <land_records>${landRecordsXml}</land_records>
        </base_data>
      </record_data>
    </cadastral_block>
  </cadastral_blocks>
</extract_cadastral_plan_territory>`;
            
            generatedXml = fullXml; 
            outputCode.textContent = generatedXml;
            downloadButton.disabled = false;
            showStatus('XML успешно сформирован. Теперь его можно скачать.', 'success');
        }

        function initializeApp() {
            if (typeof COORDINATE_SYSTEMS === 'undefined' || !Array.isArray(COORDINATE_SYSTEMS)) { showStatus("Ошибка: Не удалось загрузить список СК из sk.js.", "error"); destScSelect.disabled = true; return; }
            COORDINATE_SYSTEMS.forEach(system => { const option = document.createElement('option'); option.value = system.value; option.textContent = system.text; destScSelect.appendChild(option); });
            destScSelect.addEventListener('change', (e) => { const selectedSystem = COORDINATE_SYSTEMS.find(s => s.value === e.target.value); if (selectedSystem) { offsetXInput.value = selectedSystem.offsetX || 0; offsetYInput.value = selectedSystem.offsetY || 0; } });
            destScSelect.dispatchEvent(new Event('change'));
            quarterInput.addEventListener('input', () => formatQuarterNumber(quarterInput));
        }

        function showStatus(message, type = 'info') { statusDiv.textContent = message; statusDiv.className = `log-${type}`; statusDiv.style.display = 'block'; }
        
        function downloadXml() {
            if (!generatedXml) { showStatus('Нет данных для скачивания.', 'error'); return; }
            const quarterNumber = quarterInput.value.trim().replace(/:/g, '_'); const filename = `kpt_${quarterNumber}.xml`;
            const blob = new Blob([generatedXml], { type: 'application/xml;charset=utf-8' }); const link = document.createElement('a');
            link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link);
            link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            showStatus(`Файл ${filename} начал скачиваться.`, 'info');
        }

        fetchButton.addEventListener('click', fetchData); 
        convertButton.addEventListener('click', convertJsonToXml); 
        downloadButton.addEventListener('click', downloadXml);
        quarterInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') fetchData(); });
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
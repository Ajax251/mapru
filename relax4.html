<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Центр Релаксации и Творчества</title>
    
    <!-- Подключение шрифтов и иконок -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Подключение 3D библиотеки -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Подключение библиотек для AI чата -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- ГЛОБАЛЬНЫЕ СТИЛИ RELAX APP --- */
        :root {
            --bg-color: #0d0f12;
            --card-bg: #1b1e25;
            --text-color: #e0e1e6;
            --text-muted: #8a8f98;
            --accent-color: #58a6ff;
            --accent-glow: rgba(88, 166, 255, 0.5);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: var(--font-main); background-color: var(--bg-color);
            color: var(--text-color); overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- СТИЛИ МЕНЮ RELAX APP --- */
        #main-menu {
            position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 20px; box-sizing: border-box; animation: fadeIn 1s ease-in-out;
        }
        #main-menu h1 {
            font-size: 3rem; font-weight: 300; margin-bottom: 50px; text-align: center; letter-spacing: 1px;
        }
        .card-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; width: 100%; max-width: 1600px;
        }
        .card {
            position: relative; aspect-ratio: 16 / 10; border-radius: 18px; overflow: hidden;
            cursor: pointer; background-size: cover; background-position: center;
            border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-12px) scale(1.04);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 25px var(--accent-glow);
            border-color: var(--accent-color);
        }
        .card-content {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 10%, transparent);
            transform: translateY(30%); opacity: 0; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover .card-content { transform: translateY(0); opacity: 1; }
        .card h2 { margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 500; }
        .card p { margin: 0; font-size: 1rem; color: var(--text-muted); line-height: 1.4; }

        #card-nature { background-image: url('https://mapruapp.ru/files/relax/forest01card.jpg'); }
        #card-space { background-image: url('https://mapruapp.ru/files/relax/space01card.jpg'); }
        #card-abstract { background-image: url('https://mapruapp.ru/files/relax/abstract01card.jpg'); }
        #card-stereo { background-image: url('https://mapruapp.ru/files/relax/stereo/stereo-kartinki-01.jpg'); }
        #card-ai { background-image: url('https://mapruapp.ru/files/relax/ai.jpg'); }
        #card-svg { background-image: url('https://mapruapp.ru/files/relax/svg-card.jpg'); }
        
        /* --- СТИЛИ СЦЕН RELAX APP --- */
        #relax-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background-color: #000;
            opacity: 0; pointer-events: none; transition: opacity 0.7s ease;
        }
        #relax-overlay.visible { opacity: 1; pointer-events: auto; }
        #exit-button {
            position: fixed; top: 25px; right: 25px; width: 44px; height: 44px;
            background: rgba(0, 0, 0, 0.4); color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 1050;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); transition: all 0.3s ease;
        }
        #exit-button:hover { background: rgba(0, 0, 0, 0.7); transform: scale(1.1) rotate(90deg); }
        .scene-content { width: 100%; height: 100%; position: absolute; overflow: auto; }

        /* Сцена "Природа" */
        .nature-scene { width: 100%; height: 100%; background-size: cover; background-position: center; animation: gentleSway 40s infinite alternate ease-in-out; transition: background-image 1.5s ease-in-out; }
        #nature-controls { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 1; display: flex; gap: 15px; background: rgba(0, 0, 0, 0.4); padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); }
        #nature-controls button { padding: 10px 20px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        #nature-controls button:hover { background: rgba(255,255,255,0.2); }
        #nature-controls button.active { background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); }
        #toggle-audio-btn { width: 44px; height: 44px; padding: 0; display: flex; justify-content: center; align-items: center; border-radius: 50%; }

        /* Сцена "Абстракция" (Гипносфера) */
        #scene-abstract { background: white; filter: blur(30px) contrast(40); width: 100%; height: 100%; }
        .blob { position: absolute; border-radius: 50%; background: #000; animation: move linear infinite; }
        @keyframes move { from { transform: rotate(0deg) translateX(25vmin) rotate(0deg); } to { transform: rotate(360deg) translateX(25vmin) rotate(-360deg); } }

        /* --- СТИЛИ СТЕРЕОКАРТИНКИ --- */
        #scene-stereo { display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; background-color: var(--bg-color); }
        #stereo-main-view { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; padding-bottom: 20px; }
        #main-stereo-img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #stereo-main-view p { margin-top: 20px; font-size: 1.2rem; text-align: center; max-width: 600px; text-shadow: 0 1px 5px black; color: var(--text-muted); line-height: 1.6; }
        #stereo-previews { flex-shrink: 0; display: flex; gap: 15px; overflow-x: auto; padding: 15px; background: rgba(27, 30, 37, 0.5); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .stereo-preview-thumb { height: 100px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
        .stereo-preview-thumb:hover { transform: scale(1.05); border-color: var(--accent-color); }
        .stereo-preview-thumb.active { border-color: var(--accent-color); box-shadow: 0 0 15px var(--accent-glow); }

        /* --- СТИЛИ ДЛЯ AI ЧАТА --- */
        #three-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #scene-ai { display: flex; flex-direction: column; height: 100%; width: 100%; font-family: 'Roboto', Arial, sans-serif; color: #f3f9fb; z-index: 2; position: relative; }
        #scene-ai .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 70px 12px 20px; box-sizing: border-box; background-color: rgba(13, 15, 18, 0.8); border-bottom: 1px solid rgba(61, 90, 140, 0.7); flex-shrink: 0; z-index: 10; }
        #scene-ai .header-title { display: flex; align-items: center; font-size: 20px; font-weight: 500; color: #e0eafe; }
        #scene-ai .header-logo { width: 24px; height: 24px; margin-right: 12px; border-radius: 4px; }
        #scene-ai #chat-container { flex: 1; overflow-y: auto; scroll-behavior: smooth; padding: 16px 20px; background-color: rgba(13, 15, 18, 0.3); z-index: 5; position: relative; }
        #scene-ai #input-area { padding: 12px 20px; background-color: rgba(13, 15, 18, 0.8); flex-shrink: 0; z-index: 10; position: relative; }
        #scene-ai #prompt-templates { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        #scene-ai .template-btn { padding: 6px 12px; font-size: 13px; border: 1px solid rgba(61, 90, 140, 0.7); background: rgba(28, 40, 66, 0.9); color: #e0e1e6; border-radius: 15px; cursor: pointer; pointer-events: auto; }
        #scene-ai .template-btn:hover { background-color: var(--accent-color); color: #fff; }
        #scene-ai #input-container { display: flex; align-items: flex-end; gap: 10px; }
        #scene-ai #message-input { flex-grow: 1; padding: 10px 16px; border: 1px solid rgba(61, 90, 140, 0.7); border-radius: 20px; font-size: 14px; background-color: rgba(28, 40, 66, 0.9); color: #e4f0f4; resize: none; min-height: 42px; max-height: 150px; overflow-y: auto; line-height: 1.4; pointer-events: auto; z-index: 20; position: relative; }
        #scene-ai #message-input:focus { outline: none; border-color: var(--accent-color); }
        #scene-ai #send-button { width: 38px; height: 38px; border-radius: 50%; background-color: var(--accent-color); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border: none; flex-shrink: 0; margin-bottom: 2px; pointer-events: auto; z-index: 20; position: relative; }
        #scene-ai #send-button:hover { background-color: #79bbff; }
        #scene-ai .message { margin-bottom: 16px; max-width: 90%; clear: both; float: left; }
        #scene-ai .user-message { float: right; }
        #scene-ai .message-content { padding: 10px 14px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; font-size: 14px; }
        #scene-ai .user-message .message-content { background-color: rgba(44, 58, 90, 0.9); border: 1px solid #69a7df; }
        #scene-ai .bot-message .message-content { background-color: rgba(27, 37, 59, 0.9); border: 1px solid #314262; }

        /* --- СТИЛИ ДЛЯ SVG ГЕНЕРАТОРА --- */
        #scene-svg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 20px;
            box-sizing: border-box;
            text-align: center;
            gap: 20px;
            background: radial-gradient(circle, #1a1d24, var(--bg-color));
        }
        .svg-generator-wrapper {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #scene-svg h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0px;
            color: var(--text-color);
        }
        .svg-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .svg-input-area {
            display: flex;
            width: 100%;
            gap: 10px;
        }
        #svg-prompt-input {
            flex-grow: 1;
            padding: 12px 18px;
            font-size: 1rem;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: var(--text-color);
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #svg-prompt-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        #generate-svg-btn, #download-svg-btn {
            padding: 12px 25px;
            font-size: 1rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            flex-shrink: 0;
        }
        #generate-svg-btn:hover, #download-svg-btn:hover {
            background-color: #79bbff;
            transform: scale(1.05);
        }
        #generate-svg-btn:disabled {
            background-color: #8a8f98;
            cursor: not-allowed;
            transform: none;
        }
        #download-svg-btn {
            align-self: center;
            margin-top: 10px;
        }
        #svg-display-area {
            width: 100%;
            max-width: 700px;
            aspect-ratio: 1 / 1;
            background: var(--card-bg);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-muted);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #svg-display-area.loading {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-glow);
            animation: pulse 2s infinite;
        }
        #svg-display-area svg {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        /* --- СТИЛИ НАСТРОЕК В ГЛАВНОМ МЕНЮ --- */
        #ai-settings-btn {
            position: absolute; top: 30px; right: 30px;
            width: 44px; height: 44px; border-radius: 50%;
            background-color: rgba(27, 30, 37, 0.5); color: var(--text-muted);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer;
            z-index: 10; transition: all 0.3s ease;
        }
        #ai-settings-btn:hover { color: var(--accent-color); transform: scale(1.1) rotate(60deg); }
        #ai-settings-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 20;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #ai-settings-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        #ai-settings-modal-overlay .modal-content {
            background-color: var(--card-bg); padding: 25px; border-radius: 10px;
            width: 90%; max-width: 450px; display: flex; flex-direction: column;
            border: 1px solid var(--accent-color); gap: 20px;
        }
        #ai-settings-modal-overlay h2 { margin: 0; text-align: center; font-weight: 500;}
        #ai-settings-modal-overlay .setting-group { display: flex; flex-direction: column; gap: 8px; }
        #ai-settings-modal-overlay label { font-size: 14px; color: var(--text-muted); }
        #ai-settings-modal-overlay select, #ai-settings-modal-overlay input {
            width: 100%; padding: 10px; box-sizing: border-box;
            background: var(--bg-color); border: 1px solid var(--accent-color);
            border-radius: 6px; color: #e4f0f4; font-size: 14px;
        }
        #ai-settings-modal-overlay button {
            padding: 10px 20px; background-color: var(--accent-color); color: white;
            border: none; border-radius: 6px; cursor: pointer; align-self: center;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes gentleSway { from { transform: scale(1.0); } to { transform: scale(1.08); } }
    </style>
</head>
<body>

    <!-- === ГЛАВНОЕ МЕНЮ С НАСТРОЙКАМИ === -->
    <main id="main-menu">
        <button id="ai-settings-btn" title="Настройки AI"><i class="fas fa-cog"></i></button>

        <h1>Центр Релаксации и Творчества</h1>
        <div class="card-container">
            <div class="card" id="card-nature" data-scene="nature">
                <div class="card-content"><h2>Живая Природа</h2><p>Погрузитесь в умиротворяющие пейзажи под звуки дождя или моря.</p></div>
            </div>
            <div class="card" id="card-space" data-scene="space">
                <div class="card-content"><h2>Бесконечный Космос</h2><p>Расслабьте фокус, наблюдая за полетом сквозь звезды.</p></div>
            </div>
            <div class="card" id="card-abstract" data-scene="abstract">
                <div class="card-content"><h2>Гипно-сфера</h2><p>Наблюдайте за гипнотическим перетеканием форм и цветов.</p></div>
            </div>
            <div class="card" id="card-stereo" data-scene="stereo">
                <div class="card-content"><h2>Стереограммы</h2><p>Расфокусируйте зрение, чтобы увидеть скрытые 3D-изображения.</p></div>
            </div>
            <div class="card" id="card-ai" data-scene="ai">
                <div class="card-content"><h2>AI Генератор Сцен</h2><p>Создайте собственную визуальную 3D сцену с помощью текстового запроса.</p></div>
            </div>
            <div class="card" id="card-svg" data-scene="svg">
                <div class="card-content"><h2>SVG Генератор</h2><p>Создайте уникальные векторные иллюстрации по текстовому описанию.</p></div>
            </div>
        </div>

        <!-- Модальное окно настроек AI -->
        <div id="ai-settings-modal-overlay">
            <div class="modal-content">
                <h2>Настройки AI</h2>
                <div class="setting-group">
                    <label for="ai-model-select">Модель:</label>
                    <select id="ai-model-select">
                        <!-- Опции будут заполнены из JS -->
                    </select>
                </div>
                <div class="setting-group">
                    <label for="api-mode-select">Режим API:</label>
                    <select id="api-mode-select">
                        <option value="mapruapp" selected>Прокси (mapruapp)</option>
                        <option value="vercel">Прокси (vercel)</option>
                        <option value="direct">Прямой (gemini)</option>
                    </select>
                </div>
                 <div class="setting-group" id="api-key-group" style="display: none;">
                    <label for="api-key-input">API Ключ (для прямого режима):</label>
                    <input type="password" id="api-key-input" placeholder="Введите ваш API ключ...">
                </div>
                <button id="save-settings-btn">Закрыть</button>
            </div>
        </div>
    </main>

    <!-- === ПОЛНОЭКРАННЫЙ КОНТЕЙНЕР ДЛЯ СЦЕН === -->
    <div id="relax-overlay">
        <button id="exit-button" title="Выход (Esc)">&times;</button>
        
        <!-- Сцена 1: Природа -->
        <div id="scene-nature" class="scene-content hidden">
            <audio id="nature-audio" src="" loop></audio>
            <div id="nature-background" class="nature-scene"></div>
            <div id="nature-controls">
                <button id="toggle-audio-btn" title="Воспроизвести/Пауза"><i class="fas fa-play"></i></button>
            </div>
        </div>

        <!-- Сцена 2: Космос -->
        <div id="scene-space" class="scene-content hidden"><canvas id="space-canvas"></canvas></div>

        <!-- Сцена 3: Абстракция -->
        <div id="scene-abstract" class="scene-content hidden"></div>

        <!-- Сцена 4: Стереокартинка -->
        <div id="scene-stereo" class="scene-content hidden">
            <div id="stereo-main-view">
                <img id="main-stereo-img" src="" alt="Стереокартинка">
                <p>Расслабьте зрение и посмотрите "сквозь" экран, чтобы увидеть объемную фигуру.</p>
            </div>
            <div id="stereo-previews"></div>
        </div>
        
        <!-- Сцена 5: AI Генератор -->
        <div id="scene-ai" class="scene-content hidden">
            <canvas id="three-canvas"></canvas>
             <header class="header">
                <div class="header-title">
                    <img src="https://mapruapp.ru/files/relax/ai.jpg" alt="Logo" class="header-logo">
                    <span>AI Генератор Сцен</span>
                </div>
            </header>
            <div id="chat-container"></div>
            <div id="input-area">
                <div id="prompt-templates">
                    <button class="template-btn">движение сквозь звезды на околосветовой скорости</button>
                    <button class="template-btn">лабиринт из неоновых линий</button>
                    <button class="template-btn">волны в океане в сумерках</button>
                </div>
                <div id="input-container">
                    <textarea id="message-input" placeholder="Опишите сцену, которую хотите увидеть..." rows="1"></textarea>
                    <button id="send-button" title="Отправить"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- Сцена 6: SVG Генератор -->
        <div id="scene-svg" class="scene-content hidden">
            <div class="svg-generator-wrapper">
                <h1>AI Генератор SVG</h1>
                <p class="svg-subtitle">Опишите, что вы хотите увидеть, и AI нарисует это в векторном формате.</p>
                <div class="svg-input-area">
                    <input type="text" id="svg-prompt-input" placeholder="например, логотип для кофейни, котик в космосе...">
                    <button id="generate-svg-btn">Создать</button>
                </div>
                <div id="svg-display-area">
                    <div class="placeholder-text">Здесь появится ваше изображение...</div>
                </div>
                <button id="download-svg-btn" class="hidden">Скачать SVG</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И DOM-ЭЛЕМЕНТЫ ---
        const mainMenu = document.getElementById('main-menu');
        const relaxOverlay = document.getElementById('relax-overlay');
        const exitButton = document.getElementById('exit-button');
        const cards = document.querySelectorAll('.card');
        const sceneContents = document.querySelectorAll('.scene-content');
        
        let activeScene = null;
        let animationFrameId = null;

        // Настройки
        const aiSettingsBtn = document.getElementById('ai-settings-btn');
        const aiSettingsModal = document.getElementById('ai-settings-modal-overlay');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const aiModelSelect = document.getElementById('ai-model-select');
        const apiModeSelect = document.getElementById('api-mode-select');
        const apiKeyInput = document.getElementById('api-key-input');
        const apiKeyGroup = document.getElementById('api-key-group');
        
        // ВАШ СПИСОК МОДЕЛЕЙ
        const MODELS = [
            { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini", tier: 'lite' },
            { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini", tier: 'standard' },
            { id: "claude-sonnet-4-20250514", uiName: "Claude 4 Sonnet", apiType: "anthropic", tier: 'standard' },
            { id: "cypher-alpha", uiName: "Cypher Alpha", apiType: "openrouter", tier: 'standard' },
        ];
        
        let selectedModelId = localStorage.getItem('selectedAiModel') || MODELS[0].id;

        // Сцена "Природа"
        const natureAudio = document.getElementById('nature-audio');
        const natureBackground = document.getElementById('nature-background');
        const natureControls = document.getElementById('nature-controls');
        const toggleAudioBtn = document.getElementById('toggle-audio-btn');
        const baseUrl = 'https://mapruapp.ru/files/relax/';
        const natureScenesData = [
            { name: 'Лес', bg: `${baseUrl}forest01.jpg`, audio: `${baseUrl}rain01.mp3` },
            { name: 'Море 1', bg: `${baseUrl}sea01.jpg`, audio: `${baseUrl}ocean01.mp3` },
            { name: 'Море 2', bg: `${baseUrl}sea02.jpg`, audio: `${baseUrl}ocean02.mp3` },
            { name: 'Море 3', bg: `${baseUrl}sea03.jpg`, audio: `${baseUrl}ocean01.mp3` },
        ];

        // Сцена "Стереокартинка"
        const mainStereoImg = document.getElementById('main-stereo-img');
        const stereoPreviewsContainer = document.getElementById('stereo-previews');
        const stereoImageFiles = [ 'stereo-kartinki-10.jpg', 'stereo-kartinki-09.jpg', 'stereo-kartinki-06.jpg', 'stereo-kartinki-04.jpg', 'stereo-kartinki-01.jpg', 'Stereo-9.jpg', 'Stereo-8.jpg', 'Stereo-7.jpg', 'Stereo-6.jpg', 'Stereo-5.jpg', 'Stereo-4.jpg', 'Stereo-3.jpg', 'Stereo-2.jpg', 'Stereo-1.jpg', 'Stereo-12.jpg', 'Stereo-11.jpg', 'Stereo-10.jpg' ];

        // Сцена "AI Генератор Сцен"
        const aiScene = document.getElementById('scene-ai');
        const messageInput = aiScene.querySelector('#message-input');
        const sendButton = aiScene.querySelector('#send-button');
        const chatContainer = aiScene.querySelector('#chat-container');
        const templateButtons = aiScene.querySelectorAll('.template-btn');
        let threeScene, camera, renderer, animatedObjects = [];

        // Сцена "SVG Генератор"
        const svgPromptInput = document.getElementById('svg-prompt-input');
        const generateSvgBtn = document.getElementById('generate-svg-btn');
        const svgDisplayArea = document.getElementById('svg-display-area');
        const downloadSvgBtn = document.getElementById('download-svg-btn');
        let lastGeneratedSvgCode = '';

        // --- ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ---
        function init() {
            cards.forEach(card => card.addEventListener('click', () => showScene(card.dataset.scene)));
            exitButton.addEventListener('click', hideAllScenes);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && relaxOverlay.classList.contains('visible')) { hideAllScenes(); } });
            
            initSettings();
            initNatureScene(); 
            initStereoScene();
            initAiChat();
            initSvgGenerator();
        }

        // --- УПРАВЛЕНИЕ СЦЕНАМИ ---
        function showScene(sceneName) {
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            activeScene = sceneName;
            mainMenu.classList.add('hidden');
            relaxOverlay.classList.add('visible');
            sceneContents.forEach(content => content.classList.add('hidden'));
            const currentScene = document.getElementById(`scene-${sceneName}`);
            currentScene.classList.remove('hidden');

            switch (sceneName) {
                case 'nature': if (natureAudio.paused) { toggleAudioBtn.click(); } break;
                case 'abstract': initAbstractScene(); break;
                case 'space': initSpaceScene(); break;
                case 'ai': 
                    if (!renderer) initThreeJsScene(); 
                    else { renderer.setAnimationLoop(animateThreeJs); onWindowResize(); }
                    break;
            }
        }

        function hideAllScenes() {
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            if (natureAudio && !natureAudio.paused) { natureAudio.pause(); toggleAudioBtn.innerHTML = '<i class="fas fa-play"></i>'; }
            if (renderer) renderer.setAnimationLoop(null);
            activeScene = null;
            mainMenu.classList.remove('hidden');
            relaxOverlay.classList.remove('visible');
        }
        
        // --- ИНИЦИАЛИЗАЦИЯ НАСТРОЕК ---
        function populateModelSelector() {
            aiModelSelect.innerHTML = '';
            MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.uiName;
                if (model.id === selectedModelId) {
                    option.selected = true;
                }
                aiModelSelect.appendChild(option);
            });
        }

        function initSettings() {
            populateModelSelector();

            aiSettingsBtn.addEventListener('click', () => { aiSettingsModal.classList.add('visible'); });
            
            const closeModal = () => {
                localStorage.setItem('ai_api_key', apiKeyInput.value);
                aiSettingsModal.classList.remove('visible');
            };

            saveSettingsBtn.addEventListener('click', closeModal);
            aiSettingsModal.addEventListener('click', (e) => { if (e.target === aiSettingsModal) closeModal(); });

            apiModeSelect.addEventListener('change', (e) => {
                apiKeyGroup.style.display = e.target.value === 'direct' ? 'flex' : 'none';
            });
            
            aiModelSelect.addEventListener('change', (e) => {
                selectedModelId = e.target.value;
                localStorage.setItem('selectedAiModel', selectedModelId);
            });
            
            apiKeyInput.value = localStorage.getItem('ai_api_key') || '';
        }

        // --- ЛОГИКА КОНКРЕТНЫХ СЦЕН ---
        function initNatureScene() {
            natureScenesData.forEach((sceneData, index) => {
                const button = document.createElement('button');
                button.textContent = sceneData.name;
                button.dataset.index = index;
                if (index === 0) button.classList.add('active');
                natureControls.insertBefore(button, toggleAudioBtn);
                button.addEventListener('click', () => {
                    document.querySelectorAll('#nature-controls button:not(#toggle-audio-btn)').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    natureBackground.style.backgroundImage = `url('${sceneData.bg}')`;
                    const wasPlaying = !natureAudio.paused;
                    natureAudio.src = sceneData.audio;
                    if (wasPlaying) natureAudio.play();
                });
            });
            natureBackground.style.backgroundImage = `url('${natureScenesData[0].bg}')`;
            natureAudio.src = natureScenesData[0].audio;
            toggleAudioBtn.addEventListener('click', () => {
                if (natureAudio.paused) { natureAudio.play(); toggleAudioBtn.innerHTML = '<i class="fas fa-pause"></i>'; } 
                else { natureAudio.pause(); toggleAudioBtn.innerHTML = '<i class="fas fa-play"></i>'; }
            });
        }
        
        function initAbstractScene() {
            const container = document.getElementById('scene-abstract');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const blob = document.createElement('div');
                blob.className = 'blob';
                const size = Math.random() * 180 + 60;
                blob.style.width = blob.style.height = `${size}px`;
                blob.style.left = `${Math.random() * 100}%`;
                blob.style.top = `${Math.random() * 100}%`;
                blob.style.animationDuration = `${Math.random() * 25 + 25}s`;
                blob.style.animationDelay = `-${Math.random() * 10}s`;
                blob.style.animationDirection = i % 2 === 0 ? 'alternate' : 'alternate-reverse';
                container.appendChild(blob);
            }
        }

        function initStereoScene() {
            const stereoBaseUrl = 'https://mapruapp.ru/files/relax/stereo/';
            stereoPreviewsContainer.innerHTML = '';
            stereoImageFiles.forEach((file) => {
                const img = document.createElement('img');
                img.src = stereoBaseUrl + file;
                img.className = 'stereo-preview-thumb';
                img.addEventListener('click', () => {
                    mainStereoImg.src = img.src;
                    document.querySelectorAll('.stereo-preview-thumb').forEach(thumb => thumb.classList.remove('active'));
                    img.classList.add('active');
                });
                stereoPreviewsContainer.appendChild(img);
            });
            if (stereoImageFiles.length > 0) {
                const firstThumb = stereoPreviewsContainer.querySelector('.stereo-preview-thumb');
                mainStereoImg.src = firstThumb.src;
                firstThumb.classList.add('active');
            }
        }

function initSpaceScene() {
    const canvas = document.getElementById('space-canvas');
    const ctx = canvas.getContext('2d');
    const NUM_STARS = window.innerWidth > 768 ? 2000 : 1000;
    let STAR_SPEED = 0.03;
    const STAR_SIZE = 4, FOV = 250;
    let stars = [];
    let mouse = { x: 0, y: 0 };
    let targetSpeed = STAR_SPEED;
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        stars = [];
        for(let i = 0; i < NUM_STARS; i++) { 
            stars.push({ 
                x: (Math.random() - 0.5) * canvas.width * 4, 
                y: (Math.random() - 0.5) * canvas.height * 4, 
                z: Math.random() * canvas.width * 2,
                brightness: Math.random()
            }); 
        }
    }
    
    function handleMouseMove(e) {
        const rect = canvas.getBoundingClientRect();
        mouse.x = (e.clientX - rect.left) / canvas.width - 0.5;
        mouse.y = (e.clientY - rect.top) / canvas.height - 0.5;
        targetSpeed = STAR_SPEED + (Math.abs(mouse.x) + Math.abs(mouse.y)) * 0.1;
    }
    
    resizeCanvas();
    canvas.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('resize', resizeCanvas);
    
    function animateSpace() {
        if (activeScene !== 'space') { 
            canvas.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('resize', resizeCanvas); 
            return; 
        }
        
        // Плавное изменение скорости
        STAR_SPEED += (targetSpeed - STAR_SPEED) * 0.05;
        
        const halfW = canvas.width / 2, halfH = canvas.height / 2;
        
        // Создаем градиентный фон
        const gradient = ctx.createRadialGradient(halfW, halfH, 0, halfW, halfH, Math.max(halfW, halfH));
        gradient.addColorStop(0, '#000011');
        gradient.addColorStop(1, '#000000');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        stars.forEach(star => {
            // Влияние мыши на движение
            const mouseInfluence = 0.2;
            star.x += mouse.x * mouseInfluence;
            star.y += mouse.y * mouseInfluence;
            
            star.z -= STAR_SPEED;
            if (star.z <= 0) { 
                star.x = (Math.random() - 0.5) * canvas.width * 4; 
                star.y = (Math.random() - 0.5) * canvas.height * 4; 
                star.z = canvas.width * 2;
                star.brightness = Math.random();
            }
            
            const k = FOV / star.z;
            const px = star.x * k + halfW;
            const py = star.y * k + halfH;
            
            if (px >= 0 && px < canvas.width && py >= 0 && py < canvas.height) {
                const size = (1 - star.z / (canvas.width * 2)) * STAR_SIZE;
                const alpha = (1 - star.z / (canvas.width * 2)) * star.brightness;
                const shade = parseInt(alpha * 255);
                
                // Добавляем свечение для ярких звезд
                if (alpha > 0.7) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = `rgba(${shade}, ${shade}, ${Math.min(shade + 50, 255)}, ${alpha})`;
                } else {
                    ctx.shadowBlur = 0;
                }
                
                ctx.fillStyle = `rgba(${shade}, ${shade}, ${Math.min(shade + 30, 255)}, ${alpha})`;
                ctx.fillRect(px - size/2, py - size/2, size, size);
                
                // Добавляем след для быстро движущихся звезд
                if (STAR_SPEED > 0.05) {
                    const trailLength = (STAR_SPEED - 0.05) * 20;
                    ctx.strokeStyle = `rgba(${shade}, ${shade}, ${Math.min(shade + 30, 255)}, ${alpha * 0.3})`;
                    ctx.lineWidth = size * 0.5;
                    ctx.beginPath();
                    ctx.moveTo(px, py);
                    ctx.lineTo(px + trailLength, py);
                    ctx.stroke();
                }
            }
        });
        
        animationFrameId = requestAnimationFrame(animateSpace);
    }
    animateSpace();
}


        // --- ЛОГИКА AI ЧАТА ---
        function initAiChat() {
            templateButtons.forEach(btn => { btn.addEventListener('click', () => { messageInput.value = btn.textContent; messageInput.focus(); handleAiSend(); }); });
            sendButton.addEventListener('click', handleAiSend);
            messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAiSend(); } });
        }
        

async function handleAiSend() {
    const userPrompt = messageInput.value.trim();
    if (!userPrompt || sendButton.disabled) return;
    
    addMessageToChat('user', userPrompt);
    messageInput.value = '';
    sendButton.disabled = true;
    
    try {
        addMessageToChat('bot', 'Генерирую сцену...');
        const responseJson = await callAI(userPrompt);
        const genMsg = Array.from(chatContainer.querySelectorAll('.bot-message')).pop();
        if(genMsg && genMsg.textContent.includes('Генерирую')) genMsg.remove();
        
        while(threeScene.children.length > 0){ 
            const obj = threeScene.children[0]; 
            threeScene.remove(obj); 
            if (obj.geometry) obj.geometry.dispose(); 
            if (obj.material) obj.material.dispose(); 
        }
        animatedObjects = [];
        parseAndRenderScene(responseJson);
        addMessageToChat('bot', 'Сцена успешно сгенерирована.');
    } catch (error) { 
        addMessageToChat('bot', `Произошла ошибка: ${error.message}`); 
    } 
    finally { 
        sendButton.disabled = false; 
    }
}

        function addMessageToChat(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- ЛОГИКА SVG ГЕНЕРАТОРА ---
        function initSvgGenerator() {
            generateSvgBtn.addEventListener('click', handleGenerateSvg);
            downloadSvgBtn.addEventListener('click', handleDownloadSvg);
            svgPromptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleGenerateSvg(); } });
        }

        async function handleGenerateSvg() {
            const prompt = svgPromptInput.value.trim();
            if (!prompt || generateSvgBtn.disabled) return;

            generateSvgBtn.disabled = true;
            generateSvgBtn.textContent = 'Создание...';
            downloadSvgBtn.classList.add('hidden');
            svgDisplayArea.classList.add('loading');
            svgDisplayArea.innerHTML = '<div class="placeholder-text">AI думает...</div>';

            try {
                const svgCode = await callSvgAI(prompt);
                lastGeneratedSvgCode = svgCode;
                svgDisplayArea.innerHTML = svgCode;
                downloadSvgBtn.classList.remove('hidden');
            } catch (error) {
                svgDisplayArea.innerHTML = `<div class="placeholder-text" style="color: #ff8a8a;">Ошибка: ${error.message}</div>`;
            } finally {
                generateSvgBtn.disabled = false;
                generateSvgBtn.textContent = 'Создать';
                svgDisplayArea.classList.remove('loading');
            }
        }

        function handleDownloadSvg() {
            if (!lastGeneratedSvgCode) return;
            const blob = new Blob([lastGeneratedSvgCode], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_generated_${Date.now()}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function callApi(systemPrompt, userPrompt) {
            const modelId = aiModelSelect.value;
            const apiMode = apiModeSelect.value;
            const apiKey = apiKeyInput.value;
            const selectedModel = MODELS.find(m => m.id === modelId);

            if (!selectedModel) {
                throw new Error("Выбранная модель не найдена.");
            }

            let apiUrl = '';
            let requestBody = {};
            const headers = { 'Content-Type': 'application/json' };

            // Логика для прокси mapruapp (формат OpenRouter)
            if (apiMode === 'mapruapp') {
                apiUrl = 'https://mapruapp.ru/ai/api/v1/chat/completions';
                requestBody = {
                    model: modelId,
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }],
                };
            } 
            // Логика для прямого режима
            else if (apiMode === 'direct') {
                if (selectedModel.apiType !== 'gemini') {
                    throw new Error("Прямой режим доступен только для моделей Gemini.");
                }
                if (!apiKey) {
                    throw new Error('API ключ не указан для прямого режима.');
                }
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
                requestBody = {
                    contents: [
                        { role: 'user', parts: [{ text: systemPrompt }] },
                        { role: 'model', parts: [{ text: "OK, I understand." }] },
                        { role: 'user', parts: [{ text: userPrompt }] }
                    ],
                };
                 // Для 3D сцен просим JSON, для SVG - не нужно
                if (systemPrompt.includes('JSON format for a Three.js')) {
                    requestBody.generationConfig = { responseMimeType: "application/json" };
                }
            } 
            // Логика для прокси Vercel
            else { 
                 apiUrl = 'https://gemini-proxy-steel.vercel.app/api/genai';
                 requestBody = {
                    model: modelId,
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }],
                 };
            }

            const response = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(requestBody) });
            if (!response.ok) {
                throw new Error(`Ошибка API: ${response.status} ${await response.text()}`);
            }
            
            const data = await response.json();
            
            // Обработка ответа
            let content = '';
            if (apiMode === 'mapruapp' || apiMode === 'vercel') {
                content = data.choices?.[0]?.message?.content;
            } else if (apiMode === 'direct') {
                content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            }
            
            if (!content) {
                throw new Error('AI вернул пустой ответ.');
            }
            return content;
        }

        async function callSvgAI(prompt) {
             const systemPrompt = `You are an expert SVG designer. Your task is to generate a clean, single-file SVG code based on the user's prompt. RULES: 1. Respond ONLY with the SVG code. Do not include any extra text, explanations, or markdown like \`\`\`xml or \`\`\`svg. 2. The SVG must be self-contained. No external links or scripts. 3. The SVG must have a viewBox attribute (e.g., viewBox="0 0 100 100"). 4. Keep the design clean and modern. 5. Use a fill color of 'white' or a light color for better visibility on a dark background unless specified.`;
             const svgCode = await callApi(systemPrompt, prompt);
             if (!svgCode.trim().startsWith('<svg')) {
                 throw new Error('AI не вернул корректный SVG код.');
             }
             return svgCode.replace(/```(svg|xml)?/g, '').trim();
        }


async function handleAiSend() {
    const userPrompt = messageInput.value.trim();
    if (!userPrompt || sendButton.disabled) return;
    
    addMessageToChat('user', userPrompt);
    messageInput.value = '';
    sendButton.disabled = true;
    
    try {
        addMessageToChat('bot', 'Генерирую сцену...');
        const responseJson = await callAI(userPrompt);
        const genMsg = Array.from(chatContainer.querySelectorAll('.bot-message')).pop();
        if(genMsg && genMsg.textContent.includes('Генерирую')) genMsg.remove();
        
        while(threeScene.children.length > 0){ 
            const obj = threeScene.children[0]; 
            threeScene.remove(obj); 
            if (obj.geometry) obj.geometry.dispose(); 
            if (obj.material) obj.material.dispose(); 
        }
        animatedObjects = [];
        parseAndRenderScene(responseJson);
        addMessageToChat('bot', 'Сцена успешно сгенерирована.');
    } catch (error) { 
        addMessageToChat('bot', `Произошла ошибка: ${error.message}`); 
    } 
    finally { 
        sendButton.disabled = false; 
    }
}

// Заменить функцию callAI:
async function callAI(prompt) {
    const systemPrompt = `You are a creative assistant that generates detailed 3D scene descriptions in JSON format for a Three.js application. Analyze the user's request and create a rich, immersive scene. Respond ONLY with valid JSON, no extra text or markdown.

Scene types and examples:
- Space scenes: Use particle_system with stars, nebulae, moving objects
- Ocean/water: Use grid_plane with wave_motion for water surface
- Forest/nature: Use multiple particle_systems for leaves, fireflies, rain
- Abstract: Use geometric shapes with various animations
- Cityscape: Use box geometries with different heights and colors

JSON structure:
{
  "scene": {
    "backgroundColor": "#000000",
    "fog": { "color": "#444444", "near": 100, "far": 1000 }
  },
  "objects": [
    {
      "type": "particle_system" | "grid_plane" | "box" | "sphere",
      "count": 5000-20000,
      "segments": 50-200,
      "size": 100-2000,
      "position": [x, y, z],
      "material": {
        "color": "#ffffff",
        "size": { "min": 0.5, "max": 3.0 },
        "opacity": 0.8
      },
      "animator": {
        "type": "linear_motion" | "wave_motion" | "rotation" | "float",
        "speed": 0.5-2.0,
        "amplitude": 5-50,
        "frequency": 0.01-0.1,
        "direction": [x, y, z]
      }
    }
  ]
}

Create rich scenes with 3-5 objects, varied colors, and appropriate animations.`;
    
    const jsonString = await callApi(systemPrompt, prompt);
    try {
        // ИЗМЕНЕНИЕ: Очищаем строку от markdown-оберток ```json ... ``` и лишних пробелов
        const cleanedJsonString = jsonString.replace(/```(json)?/g, '').trim();
        return JSON.parse(cleanedJsonString);
    } catch (e) {
        console.error("Failed to parse JSON:", jsonString); // Логируем исходную строку для отладки
        throw new Error('AI вернул невалидный JSON.');
    }
}
        // --- ЛОГИКА THREE.JS ---
        function initThreeJsScene() {
            const canvas = document.getElementById('three-canvas');
            threeScene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            window.addEventListener('resize', onWindowResize, false);
            renderer.setAnimationLoop(animateThreeJs);
        }
        
        function onWindowResize() { if (!renderer || !camera) return; camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

   // Заменить функцию animateThreeJs:
function animateThreeJs() {
    if (!threeScene || !camera) return;
    const time = Date.now() * 0.001;
    
    animatedObjects.forEach(obj => {
        const animator = obj.userData.animator;
        if (!animator) return;
        
        switch(animator.type) {
            case 'linear_motion':
                // Добавляем значения по умолчанию
                const dir = animator.direction || [0, 0, -1];
                const speedLinear = animator.speed || 0.1;
                obj.position.x += dir[0] * speedLinear * 0.1;
                obj.position.y += dir[1] * speedLinear * 0.1;
                obj.position.z += dir[2] * speedLinear * 0.1;
                if (obj.position.z < -1000) obj.position.z = 1000;
                break;
                
            case 'wave_motion':
                const vertices = obj.geometry.attributes.position.array;
                // --- ИЗМЕНЕНИЕ НАЧАЛО: Добавляем значения по умолчанию ---
                const speedWave = animator.speed || 1.0;
                const amplitude = animator.amplitude || 10;
                const frequency = animator.frequency || 0.02;
                // --- ИЗМЕНЕНИЕ КОНЕЦ ---

                for (let i = 0; i < vertices.length; i += 3) {
                    const x = vertices[i];
                    const y = vertices[i+1];
                    // Используем переменные со значениями по умолчанию
                    vertices[i+2] = Math.sin(
                        Math.sqrt(x*x + y*y) * frequency - 
                        time * speedWave
                    ) * amplitude; 
                }
                obj.geometry.attributes.position.needsUpdate = true;
                break;
                
            case 'rotation':
                const speedRotation = animator.speed || 0.1;
                obj.rotation.x += speedRotation * 0.01;
                obj.rotation.y += speedRotation * 0.01;
                obj.rotation.z += speedRotation * 0.01;
                break;
                
            case 'float':
                 // Добавляем значения по умолчанию
                const speedFloat = animator.speed || 1.0;
                const amplitudeFloat = animator.amplitude || 0.1;
                obj.position.y += Math.sin(time * speedFloat) * amplitudeFloat * 0.1;
                break;
        }
    });
    
    renderer.render(threeScene, camera);
}

function parseAndRenderScene(data) {
    if (!data || !data.scene || !data.objects) { 
        addMessageToChat('bot', 'AI вернул некорректный формат JSON.'); 
        return; 
    }
    
    threeScene.background = new THREE.Color(data.scene.backgroundColor || '#000000');
    threeScene.fog = data.scene.fog ? new THREE.Fog(data.scene.fog.color, data.scene.fog.near, data.scene.fog.far) : null;
    
    data.objects.forEach(objData => {
        let mesh;
        const position = objData.position || [0, 0, 0];
        
        switch(objData.type) {
            case 'particle_system':
                camera.position.set(0, 0, 5); 
                camera.lookAt(0, 0, 0);
                const geometry = new THREE.BufferGeometry(); 
                const vertices = [];
                const colors = [];
                const baseColor = new THREE.Color(objData.material.color || '#ffffff');
                
                for (let i = 0; i < (objData.count || 10000); i++) {
                    vertices.push(
                        (Math.random() - 0.5) * 2000,
                        (Math.random() - 0.5) * 2000,
                        (Math.random() - 0.5) * 2000
                    );
                    
                    // Добавляем вариации цвета
                    const colorVariant = baseColor.clone();
                    colorVariant.r += (Math.random() - 0.5) * 0.2;
                    colorVariant.g += (Math.random() - 0.5) * 0.2;
                    colorVariant.b += (Math.random() - 0.5) * 0.2;
                    colors.push(colorVariant.r, colorVariant.g, colorVariant.b);
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                const matSize = objData.material.size ? 
                    (objData.material.size.min + objData.material.size.max) / 2 : 1.0;
                
                mesh = new THREE.Points(geometry, new THREE.PointsMaterial({ 
                    size: matSize,
                    sizeAttenuation: true,
                    vertexColors: true,
                    opacity: objData.material.opacity || 0.8,
                    transparent: true
                }));
                break;
                
            case 'grid_plane':
                camera.position.set(0, 80, 150); 
                camera.lookAt(0, 0, 0);
                const planeGeom = new THREE.PlaneGeometry(
                    objData.size || 1000, 
                    objData.size || 1000, 
                    objData.segments || 100, 
                    objData.segments || 100
                );
                mesh = new THREE.Mesh(planeGeom, new THREE.MeshBasicMaterial({ 
                    color: new THREE.Color(objData.material.color || '#ffffff'),
                    wireframe: true,
                    opacity: objData.material.opacity || 0.8,
                    transparent: true
                }));
                mesh.rotation.x = -Math.PI / 2;
                break;
                
            case 'box':
                const boxGeom = new THREE.BoxGeometry(
                    objData.size || 10,
                    objData.size || 10,
                    objData.size || 10
                );
                mesh = new THREE.Mesh(boxGeom, new THREE.MeshBasicMaterial({
                    color: new THREE.Color(objData.material.color || '#ffffff'),
                    opacity: objData.material.opacity || 0.8,
                    transparent: true
                }));
                break;
                
            case 'sphere':
                const sphereGeom = new THREE.SphereGeometry(objData.size || 5, 32, 32);
                mesh = new THREE.Mesh(sphereGeom, new THREE.MeshBasicMaterial({
                    color: new THREE.Color(objData.material.color || '#ffffff'),
                    opacity: objData.material.opacity || 0.8,
                    transparent: true
                }));
                break;
        }
        
        if (mesh) { 
            mesh.position.set(position[0], position[1], position[2]);
            mesh.userData.animator = objData.animator; 
            threeScene.add(mesh); 
            if (objData.animator) animatedObjects.push(mesh); 
        }
    });
    onWindowResize();
}
        
        // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
        init();
    });
    </script>
</body>
</html>
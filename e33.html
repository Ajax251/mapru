<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Star Data Miner v6 (Debug Mode)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --success: #22c55e; --error: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #334155; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .layout { display: grid; grid-template-columns: 350px 1fr 400px; gap: 20px; flex: 1; min-height: 0; }
        
        .panel { background: var(--panel); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; border: 1px solid #334155; }
        .panel h2 { margin-top: 0; font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;}
        
        textarea#simple-input { background: #020617; color: #94a3b8; border: 1px solid #334155; border-radius: 4px; padding: 10px; font-family: 'Inter', sans-serif; font-size: 12px; resize: none; flex: 1; margin-bottom: 10px;}
        
        .settings-group { background: #0f172a; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #334155; }
        .settings-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 5px; }
        select, input { width: 100%; background: #1e293b; border: 1px solid #475569; color: white; padding: 5px; border-radius: 4px; box-sizing: border-box; }

        #logs { flex: 1; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; display: flex; flex-direction: column; gap: 5px; background: #000; padding: 10px; border-radius: 4px; }
        .log-item { padding: 5px 8px; border-radius: 4px; border-left: 3px solid transparent; background: rgba(255,255,255,0.05); margin-bottom: 2px; }
        .log-info { border-left-color: var(--accent); }
        .log-success { border-left-color: var(--success); color: #86efac; }
        .log-error { border-left-color: var(--error); color: #fca5a5; background: rgba(239, 68, 68, 0.1); }
        .log-warn { border-left-color: #f59e0b; color: #fcd34d; }

        #json-preview { background: #020617; padding: 10px; border-radius: 4px; overflow: auto; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #a5b4fc; white-space: pre-wrap; flex: 1; }

        .controls { display: flex; gap: 10px; margin-top: auto; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-stop { background: var(--error); color: white; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: var(--panel); padding: 25px; border-radius: 12px; width: 500px; border: 1px solid #475569; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .wiki-list { max-height: 300px; overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 5px; }
        .wiki-item { padding: 10px; background: #334155; border-radius: 4px; cursor: pointer; border: 1px solid transparent; }
        .wiki-item:hover { border-color: var(--accent); background: #475569; }
        .progress-bar { height: 4px; background: #334155; width: 100%; border-radius: 2px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

        /* –ú–æ–¥–∞–ª–∫–∞ –æ—Ç—á—ë—Ç–∞ */
        .report-modal { width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
        .report-list { flex: 1; overflow-y: auto; margin: 15px 0; }
        .report-item { padding: 10px; background: #0f172a; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--error); }
        .report-item .star-name { font-weight: 600; color: var(--accent); }
        .report-item .reason { font-size: 12px; color: #94a3b8; margin-top: 5px; }
        
        .btn-skip-all { background: #7c3aed; color: white; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <h1>‚≠ê Star Data Miner v6</h1>
            <span style="font-size: 12px; background: #334155; padding: 2px 8px; border-radius: 4px;">Smart Parse</span>
        </div>
        <div id="stats" style="font-size: 12px; color: #94a3b8;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </header>

    <div class="layout">
        <div class="panel">
            <h2>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="settings-group">
                <label>API –ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                <select id="api-provider">
                    <option value="google" selected>Google Direct</option>
                    <option value="proxy">MapRuApp Proxy</option>
                </select>
            </div>
            <div class="settings-group">
                <label>API –ö–ª—é—á (Google)</label>
                <input type="password" id="google-key" value="">
            </div>
            <p style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">–°–ø–∏—Å–æ–∫ –∑–≤–µ–∑–¥ (—á–µ—Ä–µ–∑ ;):</p>
            <textarea id="simple-input" placeholder="–î—É–±—Ö–µ; –ú–µ—Ä–∞–∫...">–î–µ–Ω–µ–±</textarea>
            <div class="controls">
                <button id="btn-parse" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
        </div>

        <div class="panel">
            <h2>2. –ü—Ä–æ—Ü–µ—Å—Å</h2>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <div id="logs"></div>
            <div class="controls">
                <button id="btn-start" class="btn-primary" disabled>üöÄ –ó–∞–ø—É—Å–∫</button>
                <button id="btn-stop" class="btn-stop" disabled>‚õî –°—Ç–æ–ø</button>
            </div>
        </div>

        <div class="panel">
            <h2>3. –û—Ç–≤–µ—Ç –ò–ò</h2>
            <div id="json-preview">// JSON...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ Wiki -->
    <div class="modal-overlay" id="wiki-modal">
        <div class="modal">
            <h3 style="margin-top:0">–£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h3>
            <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ: <b id="modal-star-name" style="color:var(--accent)"></b></p>
            <div class="wiki-list" id="modal-list"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="manual-wiki-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏..." style="flex:1; padding:8px; background:#0f172a; border:1px solid #475569; color:white;">
                <button id="btn-modal-ok" class="btn-primary" style="flex:0 0 80px;">–û–ö</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="btn-modal-skip" style="flex:1; background:transparent; border:1px solid #475569; color:#94a3b8;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                <button id="btn-modal-skip-all" class="btn-skip-all" style="flex:1;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ç—á—ë—Ç–∞ -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal report-modal">
            <h3 style="margin-top:0">üìã –û—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–∞—Ö</h3>
            <p style="color:#94a3b8; font-size:13px;">–°–ª–µ–¥—É—é—â–∏–µ –∑–≤—ë–∑–¥—ã –Ω–µ –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ë–î:</p>
            <div class="report-list" id="report-list"></div>
            <button id="btn-report-close" class="btn-primary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ –û–®–ò–ë–û–ö ---
    window.onerror = function(msg, url, line, col, error) {
        console.error('GLOBAL ERROR:', msg, 'Line:', line);
        const logBox = document.getElementById('logs');
        if (logBox) {
            log(`CRITICAL ERROR: ${msg} (Line: ${line})`, 'error');
        } else {
            alert(`CRITICAL ERROR: ${msg}`);
        }
        return false;
    };

    function log(msg, type = 'info') {
        const el = document.getElementById('logs');
        if (!el) {
            console.log('[LOG]', msg);
            return;
        }
        const item = document.createElement('div');
        item.className = `log-item log-${type}`;
        item.innerHTML = `<span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        el.appendChild(item);
        el.scrollTop = el.scrollHeight;
        if(type === 'error') console.error(msg);
        else console.log(msg);
    }

    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const SUPABASE_URL = 'https://qgycxcmxlbyrjpdikyyz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneWN4Y214bGJ5cmpwZGlreXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTAxNTgsImV4cCI6MjA3OTk2NjE1OH0.UtamcsWCKPpMJwH1cWJhRhh8TL7Jb_NPA0-xLpyk_YU';
    
    const PROXY_URL = 'https://mapruapp.ru/ai/api/v1/chat/completions';
    const PROXY_MODEL = 'gemini-3-flash-preview';
    const GOOGLE_MODEL = 'gemini-3-flash-preview'; 

    const greekMap = {
        'Œ±': '–ê–ª—å—Ñ–∞', 'Œ≤': '–ë–µ—Ç–∞', 'Œ≥': '–ì–∞–º–º–∞', 'Œ¥': '–î–µ–ª—å—Ç–∞', 'Œµ': '–≠–ø—Å–∏–ª–æ–Ω',
        'Œ∂': '–î–∑–µ—Ç–∞', 'Œ∑': '–≠—Ç–∞', 'Œ∏': '–¢–µ—Ç–∞', 'Œπ': '–ô–æ—Ç–∞', 'Œ∫': '–ö–∞–ø–ø–∞',
        'Œª': '–õ—è–º–±–¥–∞', 'Œº': '–ú—é', 'ŒΩ': '–ù—é', 'Œæ': '–ö—Å–∏', 'Œø': '–û–º–∏–∫—Ä–æ–Ω',
        'œÄ': '–ü–∏', 'œÅ': '–†–æ', 'œÉ': '–°–∏–≥–º–∞', 'œÑ': '–¢–∞—É', 'œÖ': '–ò–ø—Å–∏–ª–æ–Ω',
        'œÜ': '–§–∏', 'œá': '–•–∏', 'œà': '–ü—Å–∏', 'œâ': '–û–º–µ–≥–∞'
    };

    let supabaseClient = null;
    let starsQueue = [];
    let shouldStop = false;
    let modalResolver = null;
    let skipAllWikiPrompts = false;  // –§–ª–∞–≥ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ"
    let failedStars = [];  // –°–ø–∏—Å–æ–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–≤—ë–∑–¥

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò DOM ---
    document.addEventListener('DOMContentLoaded', function() {
        log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞...", "info");
        
        try {
            if (typeof supabase === 'undefined' || !supabase.createClient) {
                throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ VPN.");
            }
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            log("Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω", "success");
        } catch (e) {
            log(e.message, 'error');
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('btn-parse').addEventListener('click', async () => {
            document.getElementById('btn-parse').disabled = true;
            document.getElementById('btn-parse').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î...';
            await parseInput();
            document.getElementById('btn-parse').disabled = false;
            document.getElementById('btn-parse').textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫';
        });
        document.getElementById('btn-start').addEventListener('click', startProcess);
        document.getElementById('btn-stop').addEventListener('click', stopProcess);
        document.getElementById('btn-modal-ok').addEventListener('click', resolveModalManual);
        document.getElementById('btn-modal-skip').addEventListener('click', skipModal);
        document.getElementById('btn-modal-skip-all').addEventListener('click', skipAllModal);
        document.getElementById('btn-report-close').addEventListener('click', closeReport);

        log("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!", "success");
    });

    function fixStarName(rawName) {
        let name = rawName.trim();
        const regex = /(.+?)\s+([Œ±-œâ])([¬π¬≤¬≥]?)/;
        const match = name.match(regex);

        if (match) {
            const constellation = match[1]; 
            const greekChar = match[2];     
            const index = match[3] || "";   
            
            if (greekMap[greekChar]) {
                return `${greekMap[greekChar]}${index} ${constellation}`;
            }
        }
        return name;
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ü–ê–†–°–ò–ù–ì–ê –° –ü–†–û–í–ï–†–ö–û–ô –ë–î ---
async function parseInput() {
    log("–ù–∞—á–∏–Ω–∞—é –ø–∞—Ä—Å–∏–Ω–≥...", "info");
    
    const inputEl = document.getElementById('simple-input');
    if (!inputEl) {
        log("–≠–ª–µ–º–µ–Ω—Ç simple-input –Ω–µ –Ω–∞–π–¥–µ–Ω!", "error");
        return;
    }
    
    const raw = inputEl.value;
    if (!raw || !raw.trim()) {
        log("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ!", "error");
        return;
    }

    const cleanRaw = raw.replace(/[\r\n]+/g, ' '); 
    const names = cleanRaw.split(';').map(s => s.trim()).filter(s => s.length > 0);
    
    if (names.length === 0) {
        log("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∑–≤–µ–∑–¥—ã", "error");
        return;
    }

    let allStars = names.map(name => {
        const wikiName = fixStarName(name);
        if (name !== wikiName) {
            log(`–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: ${name} -> ${wikiName}`, "info");
        }
        return { originalName: name, name: wikiName };
    });

    log(`–ù–∞–π–¥–µ–Ω–æ ${allStars.length} –∑–≤—ë–∑–¥. –ü—Ä–æ–≤–µ—Ä—è—é –ë–î...`, "info");

    // --- –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–î (—Å —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ —á–∞—Å—Ç–∏) ---
    if (supabaseClient) {
        const allNames = [...new Set(allStars.flatMap(s => [s.name, s.originalName]))];
        const existingNames = new Set();
        
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 50 –∏–º—ë–Ω
        const chunkSize = 50;
        const chunks = [];
        for (let i = 0; i < allNames.length; i += chunkSize) {
            chunks.push(allNames.slice(i, i + chunkSize));
        }
        
        log(`–ü—Ä–æ–≤–µ—Ä—è—é –ë–î: ${chunks.length} –∑–∞–ø—Ä–æ—Å–æ–≤...`, "info");
        
        for (let i = 0; i < chunks.length; i++) {
            const chunk = chunks[i];
            const { data: existing, error } = await supabaseClient
                .from('stars')
                .select('name')
                .in('name', chunk);

            if (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î (—á–∞—Å—Ç—å ${i+1}): ${error.message}`, "error");
            } else if (existing) {
                existing.forEach(e => existingNames.add(e.name));
            }
        }
        
        if (existingNames.size > 0) {
            const before = allStars.length;
            
            allStars = allStars.filter(s => 
                !existingNames.has(s.name) && !existingNames.has(s.originalName)
            );
            
            const skipped = before - allStars.length;
            log(`‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–æ ${skipped} –∑–≤—ë–∑–¥ (—É–∂–µ –≤ –ë–î)`, "warn");
        }
    }

    starsQueue = allStars;
    
    if (starsQueue.length === 0) {
        log("–í—Å–µ –∑–≤—ë–∑–¥—ã —É–∂–µ –µ—Å—Ç—å –≤ –ë–î!", "warn");
        document.getElementById('btn-start').disabled = true;
        return;
    }

    log(`‚úÖ –í –æ—á–µ—Ä–µ–¥–∏: ${starsQueue.length} –Ω–æ–≤—ã—Ö –∑–≤—ë–∑–¥`, 'success');
    document.getElementById('btn-start').disabled = false;
    document.getElementById('stats').textContent = `–í –æ—á–µ—Ä–µ–¥–∏: ${starsQueue.length}`;
}

    // --- –ü–†–û–¶–ï–°–° ---
    async function startProcess() {
        if (!supabaseClient) {
            log("–ù–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å: Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω.", "error");
            return;
        }
        if (starsQueue.length === 0) {
            log("–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞!", "error");
            return;
        }
        
        shouldStop = false;
        skipAllWikiPrompts = false;  // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞
        failedStars = [];  // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –Ω–µ—É–¥–∞—á
        
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-stop').disabled = false;
        
        log("üöÄ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏...", "info");

        for (let i = 0; i < starsQueue.length; i++) {
            if (shouldStop) {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ failedStars
                for (let j = i; j < starsQueue.length; j++) {
                    failedStars.push({
                        name: starsQueue[j].name,
                        reason: "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                    });
                }
                break;
            }
            
            const star = starsQueue[i];
            const progress = ((i + 1) / starsQueue.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('stats').textContent = `${i+1}/${starsQueue.length}: ${star.name}`;

            try {
                await processStar(star);
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –Ω–∞ ${star.name}: ${e.message}`, 'error');
                failedStars.push({
                    name: star.name,
                    reason: `–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}`
                });
            }
            
            if (i < starsQueue.length - 1 && !shouldStop) {
                log('‚è≥ –ñ–¥—É 10 —Å–µ–∫...', 'info');
                await new Promise(r => setTimeout(r, 10000));
            }
        }
        
        document.getElementById('btn-start').disabled = false;
        document.getElementById('btn-stop').disabled = true;
        log('üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á—ë—Ç –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        if (failedStars.length > 0) {
            showReport();
        }
    }

    function stopProcess() { 
        shouldStop = true; 
        log('‚õî –û—Å—Ç–∞–Ω–æ–≤–∫–∞...', 'warn'); 
    }

    async function processStar(star) {
        log(`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${star.name}`, 'info');

        let wikiData = await getWikiData(star.name);
        
        if (!wikiData && star.name !== star.originalName) {
             wikiData = await getWikiData(star.originalName);
        }

        if (!wikiData || wikiData.isDisambiguation) {
            const autoTitle = star.name + " (–∑–≤–µ–∑–¥–∞)";
            const autoWikiData = await getWikiData(autoTitle);
            
            if (autoWikiData && !autoWikiData.isDisambiguation) {
                wikiData = autoWikiData;
                log(`–ê–≤—Ç–æ-–≤—ã–±–æ—Ä: ${wikiData.title}`, 'info');
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ"
                if (skipAllWikiPrompts) {
                    log(`‚è≠ –ê–≤—Ç–æ-–ø—Ä–æ–ø—É—Å–∫: ${star.name} (—Ä–µ–∂–∏–º "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ")`, 'warn');
                    failedStars.push({
                        name: star.name,
                        reason: "–°—Ç–∞—Ç—å—è Wiki –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–∞–≤—Ç–æ-–ø—Ä–æ–ø—É—Å–∫)"
                    });
                    return;
                }
                
                const userChoice = await askUserForArticle(star.name);
                if (!userChoice) { 
                    log(`‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${star.name}`, 'error'); 
                    failedStars.push({
                        name: star.name,
                        reason: "–°—Ç–∞—Ç—å—è Wiki –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ / –ø—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                    });
                    return; 
                }
                wikiData = await getWikiData(userChoice);
            }
        }

        if (!wikiData || !wikiData.wikitext) {
            log(`–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ Wiki: ${star.name}`, 'error');
            failedStars.push({
                name: star.name,
                reason: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏ Wikipedia"
            });
            return;
        }

        log(`üìö Wiki OK (${wikiData.title}). –ê–Ω–∞–ª–∏–∑ AI...`, 'info');
        const aiData = await askAI(star, wikiData);
        
        if (!aiData) {
            failedStars.push({
                name: star.name,
                reason: "–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –æ—Ç–∫–∞–∑)"
            });
            return;
        }

        document.getElementById('json-preview').textContent = JSON.stringify(aiData, null, 2);

        const { error } = await supabaseClient.from('stars').insert({
            name: star.name, 
            constellation: aiData.constellation,
            constellation_latin: aiData.constellation_latin,
            stats: aiData.stats,
            facts: aiData.facts,
            wiki_url: `https://ru.wikipedia.org/wiki/${encodeURIComponent(wikiData.title)}`,
            raw_ai_response: aiData
        });

        if (error) {
            log(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`, 'error');
            failedStars.push({
                name: star.name,
                reason: `–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ë–î: ${error.message}`
            });
        } else {
            log(`‚úÖ ${star.name} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`, 'success');
        }
    }

    async function getWikiData(title) {
        const url = `https://ru.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&format=json&prop=wikitext&origin=*&redirects=1`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.error) return null;
            const wikitext = data.parse.wikitext['*'];
            const isDisambig = wikitext.includes('{{–Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å}}') || wikitext.includes('{{disambig}}');
            return { title: data.parse.title, wikitext, isDisambiguation: isDisambig };
        } catch { return null; }
    }

    async function searchWiki(query) {
        const url = `https://ru.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&format=json&origin=*`;
        const res = await fetch(url);
        const data = await res.json();
        return data[1];
    }

    async function askAI(star, wikiData) {
        const provider = document.getElementById('api-provider').value;
        const textToAnalyze = wikiData.wikitext.substring(0, 40000); 

        const systemPrompt = `Role: Astronomer. 
        Task: Extract data for star "${star.name}" from the provided Wikitext.
        Important: Identify the Constellation (Russian and Latin) from text.
        
        Output: JSON only. No markdown.
        Format:
        {
            "constellation": "String (Russian Name, e.g. –õ–µ–±–µ–¥—å)",
            "constellation_latin": "String (Latin Name, e.g. Cygnus)",
            "stats": {
                "mass_solar": Number/null,
                "radius_solar": Number/null,
                "dist_ly": Number/null,
                "temp_k": Number/null,
                "lum_solar": Number/null,
                "spectral_class": "String",
                "age_my": Number/null (million years),
                "mag_app": Number
            },
            "facts": ["Fact1", "Fact2", "Fact3"] (in Russian, interesting)
        }`;

        try {
            let jsonResponse = "";
            if (provider === 'google') {
                const apiKey = document.getElementById('google-key').value;
                if (!apiKey) {
                    log("API –∫–ª—é—á Google –Ω–µ —É–∫–∞–∑–∞–Ω!", "error");
                    return null;
                }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GOOGLE_MODEL}:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nWIKITEXT:\n" + textToAnalyze }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                jsonResponse = data.candidates[0].content.parts[0].text;
            } else {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: PROXY_MODEL,
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: textToAnalyze }],
                        temperature: 0.1
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                jsonResponse = data.choices[0].message.content;
            }
            return JSON.parse(jsonResponse.replace(/```json/g, '').replace(/```/g, '').trim());
        } catch (e) {
            log(`AI Error: ${e.message}`, 'error');
            return null;
        }
    }

    async function askUserForArticle(query) {
        const modal = document.getElementById('wiki-modal');
        const listEl = document.getElementById('modal-list');
        document.getElementById('modal-star-name').textContent = query;
        document.getElementById('manual-wiki-input').value = '';
        listEl.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        modal.style.display = 'flex';
        
        const suggestions = await searchWiki(query);
        const moreSuggestions = await searchWiki(query + " (–∑–≤–µ–∑–¥–∞)");
        const opts = [...new Set([...suggestions, ...moreSuggestions])];
        
        listEl.innerHTML = '';
        if(opts.length === 0) listEl.innerHTML = '<p style="color:#94a3b8; text-align:center;">–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</p>';
        
        opts.forEach(opt => {
            const d = document.createElement('div');
            d.className = 'wiki-item';
            d.innerHTML = `<strong>${opt}</strong>`;
            d.onclick = () => { modal.style.display='none'; if(modalResolver) modalResolver(opt); };
            listEl.appendChild(d);
        });
        return new Promise(r => modalResolver = r);
    }

    function resolveModalManual() {
        const val = document.getElementById('manual-wiki-input').value;
        if(val) { 
            document.getElementById('wiki-modal').style.display='none'; 
            modalResolver(val); 
        }
    }
    
    function skipModal() {
        document.getElementById('wiki-modal').style.display='none'; 
        modalResolver(null);
    }

    function skipAllModal() {
        skipAllWikiPrompts = true;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
        document.getElementById('wiki-modal').style.display='none'; 
        modalResolver(null);
        log("üö´ –†–µ–∂–∏–º '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω", "warn");
    }

    // --- –û–¢–ß–Å–¢ –û–ë –û–®–ò–ë–ö–ê–• ---
    function showReport() {
        const modal = document.getElementById('report-modal');
        const listEl = document.getElementById('report-list');
        
        listEl.innerHTML = '';
        
        failedStars.forEach(item => {
            const div = document.createElement('div');
            div.className = 'report-item';
            div.innerHTML = `
                <div class="star-name">‚≠ê ${item.name}</div>
                <div class="reason">üìå ${item.reason}</div>
            `;
            listEl.appendChild(div);
        });
        
        log(`üìã –ù–µ –∑–∞–ø–∏—Å–∞–Ω–æ –∑–≤—ë–∑–¥: ${failedStars.length}`, 'error');
        modal.style.display = 'flex';
    }

    function closeReport() {
        document.getElementById('report-modal').style.display = 'none';
    }
</script>
</body>
</html>
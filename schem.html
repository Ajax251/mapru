<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchemaParcels - СРЗУ на КПТ</title>
    <link rel="icon" href="img/des.png" type="image/png">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <script src="webfonts/jszip.min.js"></script>
    <script src="webfonts/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --success: #10b981;
            --success-bg: #ecfdf5;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            height: 95vh;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        /* HEADER */
        .header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background-color: var(--primary); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .logo h1 { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
        .logo span { display: block; font-size: 0.75rem; color: var(--text-light); font-weight: 400; }
        
        .toolbar { display: flex; gap: 8px; }
        .tool-btn { background: white; border: 1px solid var(--border); color: var(--text-light); width: 38px; height: 38px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        .tool-btn.danger { color: var(--danger); border-color: #fecaca; }
        .tool-btn.danger:hover { background: var(--danger-bg); border-color: var(--danger); color: #dc2626; }
        .divider { width: 1px; background: var(--border); height: 24px; margin: auto 4px; }

        /* GRID LAYOUT */
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr 1.3fr; gap: 0; flex: 1; overflow: hidden; }
        .column { padding: 20px 25px; overflow-y: auto; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; background: #fff; }
        .column:last-child { border-right: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        h2 { font-size: 0.85rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; color: var(--primary); margin: 0 0 5px 0; padding-bottom: 8px; border-bottom: 2px solid #f1f5f9; display: flex; align-items: center; gap: 8px; }

        /* FORMS */
        .form-group { margin-bottom: 8px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; color: var(--text); transition: all 0.2s; font-family: inherit; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        textarea { resize: none; line-height: 1.4; }
        input::placeholder, textarea::placeholder { color: #cbd5e1; }
        .input-with-btn { display: flex; gap: 8px; }
        .icon-btn { padding: 0 12px; border: 1px solid var(--border); background: #f8fafc; border-radius: 8px; cursor: pointer; color: var(--text-light); transition: 0.2s; flex-shrink: 0; }
        .icon-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .calc-badge { display: inline-block; font-size: 0.7em; background: var(--success-bg); color: var(--success); padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 600; border: 1px solid #bbf7d0; }
        .calc-highlight { animation: highlight 0.5s ease-out; }
        @keyframes highlight { 0% { border-color: var(--success); background-color: var(--success-bg); } 100% { border-color: var(--border); background-color: #fff; } }

        /* LISTS */
        .cad-list { list-style: none; padding: 0; margin: 0; border: 1px solid var(--border); border-radius: 8px; max-height: 120px; overflow-y: auto; background: #f8fafc; }
        .cad-list:empty::before { content: "Список пуст"; display: block; padding: 10px; text-align: center; color: #94a3b8; font-size: 0.85rem; }
        .cad-list li { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-family: monospace; background: white; }
        .cad-list li:last-child { border-bottom: none; }
        .del-item { color: #94a3b8; cursor: pointer; font-size: 1.1rem; transition: color 0.2s; }
        .del-item:hover { color: var(--danger); }

        .action-area { margin-top: auto; background: #f8fafc; border: 1px dashed #cbd5e1; padding: 15px; border-radius: 10px; }
        .file-upload-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .file-upload-wrapper input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-custom-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; background: #fff; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: 500; font-size: 0.9rem; transition: all 0.2s; }
        .file-upload-wrapper:hover .file-custom-btn { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        .file-custom-btn.has-file { background: var(--success-bg); border-color: var(--success); color: #059669; }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; width: 700px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); animation: modalFadeIn 0.2s ease-out; display: flex; flex-direction: column; max-height: 80vh; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-header h3 { margin: 0; font-size: 1.1rem; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .close-modal { color: #94a3b8; font-size: 24px; cursor: pointer; transition: color 0.2s; }
        .close-modal:hover { color: var(--danger); }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 15px; }
        .modal-btn:hover { background: var(--primary-hover); }

        /* HISTORY STYLES */
        #historyListContainer { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr; 
            gap: 15px;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }
        .history-item:hover { background: #f8fafc; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .history-item:last-child { border-bottom: none; }
        
        .h-col-1 { display: flex; flex-direction: column; gap: 4px; }
        .h-title { font-weight: 700; font-size: 0.95rem; color: var(--text); }
        .h-date { font-size: 0.75rem; color: var(--text-light); }
        
        .h-col-2 { display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; color: var(--text-light); }
        .h-method { font-weight: 600; color: var(--primary); }
        .h-util { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        
        .h-col-3 { text-align: right; display: flex; flex-direction: column; gap: 4px; }
        .h-block { font-family: monospace; font-size: 0.85rem; color: var(--primary); font-weight: 500; }
        .h-area { font-size: 0.8rem; color: var(--success); font-weight: 600; }

        /* Dialog Styles */
        .dialog-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .d-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .d-btn-ok { background: var(--primary); color: white; }
        .d-btn-ok:hover { background: var(--primary-hover); }
        .d-btn-danger { background: var(--danger); color: white; }
        .d-btn-danger:hover { background: #dc2626; }
        .d-btn-cancel { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
        .d-btn-cancel:hover { background: #e2e8f0; }

        /* Hidden inputs */
        #fileJson { display: none; }
        .coords-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .coords-wrapper textarea { flex: 1; font-family: 'Consolas', monospace; font-size: 0.75rem; line-height: 1.4; }
        
        /* Modal specific widths */
        #csModal .modal-content { width: 420px; }
        #dialogModal .modal-content { width: 400px; text-align: center; padding-top: 30px; }
        .dialog-icon { font-size: 3rem; margin-bottom: 15px; color: var(--text-light); }
        .dialog-icon.error { color: var(--danger); }
        .dialog-icon.question { color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-drafting-compass"></i></div>
            <div>
                <h1>SchemaParcels</h1>
                <span>Генератор схемы расположения земельных участков на КПТ</span>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="tool-btn" id="historyBtn" title="История проектов"><i class="fas fa-history"></i></button>
            <div class="divider"></div>
            <button class="tool-btn" onclick="saveJsonProject()" title="Сохранить проект (SCH)"><i class="fas fa-save"></i></button>
            <button class="tool-btn" onclick="document.getElementById('fileJson').click()" title="Загрузить проект (SCH)"><i class="fas fa-folder-open"></i></button>
            <button class="tool-btn danger" onclick="resetForm()" title="Очистить и сбросить"><i class="fas fa-times"></i></button>
            <input type="file" id="fileJson" accept=".sch" onchange="loadJsonProject(this)">
        </div>
    </div>

    <div class="grid-layout">
        <!-- КОЛОНКА 1 -->
        <div class="column">
            <h2><i class="far fa-file-alt"></i> Документ-основание</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Номер</label>
                    <input type="text" id="docNumber">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Дата</label>
                    <input type="date" id="docDate">
                </div>
            </div>
            <div class="form-group">
                <label>Уполномоченный орган</label>
                <textarea id="issueOrgan" rows="3"></textarea>
            </div>
            
            <div style="margin-top: 15px;"></div>
            <h2><i class="fas fa-layer-group"></i> Исходные участки</h2>
            <div class="form-group">
                <div class="input-with-btn">
                    <input type="text" id="prevCadInput" class="cad-mask">
                    <button class="icon-btn" onclick="addPrevCadastral()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <ul id="prevCadList" class="cad-list"></ul>
        </div>

        <!-- КОЛОНКА 2 -->
        <div class="column">
            <h2><i class="fas fa-map-marker-alt"></i> Новый участок</h2>
            <div class="form-group">
                <label>Кадастровый квартал</label>
                <input type="text" id="cadBlock" class="cad-mask">
            </div>
            
            <div class="form-group">
                <label>Площадь <span class="calc-badge">авто</span></label>
                <input type="number" id="area" placeholder="0">
            </div>

            <div class="form-group">
                <label>Категория земель</label>
                <select id="categorySelect">
                    <option value="003001000000">Земли сельскохозяйственного назначения</option>
                    <option value="003002000000">Земли населенных пунктов</option>
                    <option value="003003000000">Земли промышленности и иного назначения</option>
                    <option value="003004000000">Земли особо охраняемых территорий</option>
                    <option value="003005000000">Земли лесного фонда</option>
                    <option value="003006000000">Земли водного фонда</option>
                    <option value="003007000000">Земли запаса</option>
                    <option value="003008000000">Категория не установлена</option>
                </select>
            </div>

            <div class="form-group">
                <label>Способ образования</label>
                <select id="formingMethod">
                    <option value="1">Выдел</option>
                    <option value="2">Раздел</option>
                    <option value="3">Раздел с измененным участком</option>
                    <option value="4">Перераспределение</option>
                    <option value="5">Образование из земель</option>
                    <option value="6">Объединение</option>
                </select>
            </div>

            <div class="form-group">
                <label>Разрешенное использование</label>
                <textarea id="utilization" rows="2"></textarea>
            </div>
        </div>

        <!-- КОЛОНКА 3 -->
        <div class="column">
            <h2><i class="fas fa-globe"></i> Координаты и Файл</h2>
            
            <div class="form-group">
                <label>Система координат</label>
                <select id="csSelect" onchange="checkCustomCs(this)">
                    <option value="16.1">МСК-16, зона 1</option>
                    <option value="16.2">МСК-16, зона 2</option>
                                   <option disabled>──────────</option>
                    <option value="custom_add">+ Добавить свою...</option>
                </select>
            </div>

            <div class="coords-wrapper">
                <label>Координаты (X Y)</label>
                <textarea id="coordsInput" oninput="handleCoordsChange()"></textarea>
            </div>
            
            <div class="form-group">
                <label>Местоположение (адрес)</label>
                <textarea id="note" rows="2"></textarea>
            </div>

            <div class="action-area">
                <div class="file-upload-wrapper">
                    <input type="file" id="pdfFile" accept="application/pdf" onchange="updateFileButton(this)">
                    <div class="file-custom-btn" id="fileBtnText">
                        <i class="fas fa-file-pdf"></i> Выбрать PDF файл
                    </div>
                </div>
                <button class="btn-main" onclick="generateZip()">
                    <i class="fas fa-file-archive"></i> Сформировать ZIP-архив
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно истории -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-history"></i> История проектов</h3>
            <span class="close-modal" onclick="closeModal('historyModal')">&times;</span>
        </div>
        <div id="historyListContainer"></div>
    </div>
</div>

<!-- Модальное окно добавления МСК -->
<div id="csModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-globe"></i> Новая система координат</h3>
            <span class="close-modal" onclick="closeModal('csModal')">&times;</span>
        </div>
        <div class="form-group">
            <label>Название</label>
            <input type="text" id="newCsName">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Код региона</label>
                <input type="number" id="newCsRegion">
            </div>
            <div class="form-group">
                <label>Номер зоны</label>
                <input type="number" id="newCsZone">
            </div>
        </div>
        <button class="modal-btn" onclick="saveCustomCs()"><i class="fas fa-plus"></i> Добавить</button>
    </div>
</div>

<!-- Универсальное диалоговое окно (Alert/Confirm) -->
<div id="dialogModal" class="modal">
    <div class="modal-content">
        <div id="dialogIcon" class="dialog-icon"></div>
        <div class="modal-header" style="justify-content: center; border-bottom: none; padding-bottom: 5px;">
            <h3 id="dialogTitle" style="font-size: 1.25rem;"></h3>
        </div>
        <p id="dialogMessage" style="color: var(--text-light); margin: 0 0 25px 0; font-size: 0.95rem; line-height: 1.5;"></p>
        <div id="dialogButtons" class="dialog-btn-group"></div>
    </div>
</div>

<script>
const STORAGE_KEY = 'SchemaParcels_History';
const CURRENT_STATE_KEY = 'SchemaParcels_State';
const CUSTOM_CS_KEY = 'SchemaParcels_CS';
const MAX_HISTORY = 15;
let prevCadastralNumbers = [];

// Методы образования (для отображения в истории)
const formingMethods = {
    '1': 'Выдел',
    '2': 'Раздел',
    '3': 'Раздел с измененным ЗУ',
    '4': 'Перераспределение',
    '5': 'Образование из земель',
    '6': 'Объединение'
};

window.onload = function() {
    setupCadastralMasks();
    loadCustomCs();
    restoreCurrentState();
    document.getElementById('prevCadInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); addPrevCadastral(); }
    });
    document.getElementById('historyBtn').addEventListener('click', showHistory);
    document.querySelectorAll('input, select, textarea').forEach(input => {
        if (input.type !== 'file') {
            input.addEventListener('input', saveCurrentState);
            input.addEventListener('change', saveCurrentState);
        }
    });
};

/* --- НОВЫЕ ФУНКЦИИ ДИАЛОГОВЫХ ОКОН --- */
function showAlert(title, message, isError = false) {
    const modal = document.getElementById('dialogModal');
    const icon = document.getElementById('dialogIcon');
    const btnContainer = document.getElementById('dialogButtons');
    
    document.getElementById('dialogTitle').innerText = title;
    document.getElementById('dialogMessage').innerText = message;
    
    icon.innerHTML = isError ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>';
    icon.className = 'dialog-icon ' + (isError ? 'error' : 'question');
    
    btnContainer.innerHTML = `<button class="d-btn d-btn-ok" onclick="closeModal('dialogModal')">Понятно</button>`;
    
    modal.style.display = 'flex';
}

function showConfirm(title, message, onYes) {
    const modal = document.getElementById('dialogModal');
    const icon = document.getElementById('dialogIcon');
    const btnContainer = document.getElementById('dialogButtons');
    
    document.getElementById('dialogTitle').innerText = title;
    document.getElementById('dialogMessage').innerText = message;
    
    icon.innerHTML = '<i class="fas fa-question-circle"></i>';
    icon.className = 'dialog-icon question';
    
    // Создаем кнопки программно, чтобы привязать callback
    btnContainer.innerHTML = '';
    
    const btnCancel = document.createElement('button');
    btnCancel.className = 'd-btn d-btn-cancel';
    btnCancel.innerText = 'Отмена';
    btnCancel.onclick = () => closeModal('dialogModal');
    
    const btnYes = document.createElement('button');
    btnYes.className = 'd-btn d-btn-danger';
    btnYes.innerText = 'Подтвердить';
    btnYes.onclick = () => {
        onYes();
        closeModal('dialogModal');
    };
    
    btnContainer.appendChild(btnCancel);
    btnContainer.appendChild(btnYes);
    
    modal.style.display = 'flex';
}
/* ------------------------------------- */

function updateFileButton(input) {
    const btnText = document.getElementById('fileBtnText');
    if (input.files && input.files[0]) {
        btnText.innerHTML = `<i class="fas fa-check-circle"></i> ${input.files[0].name}`;
        btnText.classList.add('has-file');
    } else {
        btnText.innerHTML = `<i class="fas fa-file-pdf"></i> Выбрать PDF файл`;
        btnText.classList.remove('has-file');
    }
}

function saveCurrentState() {
    localStorage.setItem(CURRENT_STATE_KEY, JSON.stringify(collectData()));
}

function restoreCurrentState() {
    const raw = localStorage.getItem(CURRENT_STATE_KEY);
    if (raw) {
        try { fillForm(JSON.parse(raw)); } catch (e) {}
    }
}

function checkCustomCs(select) {
    if (select.value === 'custom_add') {
        document.getElementById('csModal').style.display = 'flex';
        select.value = '16.2';
    } else {
        saveCurrentState();
    }
}

function saveCustomCs() {
    const name = document.getElementById('newCsName').value;
    const region = document.getElementById('newCsRegion').value;
    const zone = document.getElementById('newCsZone').value;
    
    // Замена alert на showAlert
    if (!name || !region || !zone) { 
        showAlert('Ошибка', 'Заполните все поля для создания системы координат.', true);
        return; 
    }
    
    const csData = { name, value: `${region}.${zone}` };
    let customList = JSON.parse(localStorage.getItem(CUSTOM_CS_KEY) || '[]');
    customList.push(csData);
    localStorage.setItem(CUSTOM_CS_KEY, JSON.stringify(customList));
    addCsOption(csData, true);
    closeModal('csModal');
    document.getElementById('newCsName').value = '';
    document.getElementById('newCsRegion').value = '';
    document.getElementById('newCsZone').value = '';
}

function loadCustomCs() {
    JSON.parse(localStorage.getItem(CUSTOM_CS_KEY) || '[]').forEach(cs => addCsOption(cs));
}

function addCsOption(csData, selectIt = false) {
    const select = document.getElementById('csSelect');
    const separator = select.options[select.options.length - 2];
    const option = document.createElement('option');
    option.text = csData.name;
    option.value = csData.value;
    select.insertBefore(option, separator);
    if (selectIt) {
        select.value = csData.value;
        saveCurrentState();
    }
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function setupCadastralMasks() {
    document.querySelectorAll('.cad-mask').forEach(input => {
        input.addEventListener('input', function(e) { formatCadastralNumber(e.target); });
    });
}

function formatCadastralNumber(input) {
    let val = input.value.replace(/[^0-9:]/g, '').replace(/:/g, '');
    if (!val) { input.value = ''; return; }
    let fmt = val.slice(0, 2);
    const region = val.slice(0, 2);
    const sixDigits = ['02','03','04','05','08','15','16','18','19','21','22','25','26','28','30','33','34','37','38','39','40','43','44','45','46','54','55','73','75','76','91','92'];
    const qDigits = sixDigits.includes(region) ? 6 : 7;
    if (val.length > 2) fmt += ':' + val.slice(2, 4);
    if (val.length > 4) fmt += ':' + val.slice(4, 4 + qDigits);
    if (val.length > (4 + qDigits)) fmt += ':' + val.slice(4 + qDigits);
    input.value = fmt;
}

function handleCoordsChange() {
    const text = document.getElementById('coordsInput').value;
    saveCurrentState();
    const points = parseCoordinates(text);
    if (points.length < 3) return;
    let area = 0;
    for (let i = 0; i < points.length; i++) {
        const j = (i + 1) % points.length;
        area += (points[i].x * points[j].y) - (points[i].y * points[j].x);
    }
    const areaVal = Math.round(Math.abs(area) / 2);
    const input = document.getElementById('area');
    input.value = areaVal;
    input.classList.remove('calc-highlight');
    void input.offsetWidth;
    input.classList.add('calc-highlight');
    saveCurrentState();
}

function parseCoordinates(text) {
    const lines = text.trim().split('\n');
    const points = [];
    for (let line of lines) {
        let parts = line.trim().split(/[\t\s,]+/);
        let coords = parts.filter(p => !isNaN(parseFloat(p.replace(',', '.'))));
        if (coords.length >= 2) {
            points.push({
                x: parseFloat(coords[0].replace(',', '.')),
                y: parseFloat(coords[1].replace(',', '.'))
            });
        }
    }
    if (points.length > 2) {
        const first = points[0];
        const last = points[points.length - 1];
        if (first.x !== last.x || first.y !== last.y) points.push(first);
    }
    return points;
}

function addPrevCadastral() {
    const input = document.getElementById('prevCadInput');
    const val = input.value.trim();
    if (val.length > 5 && !prevCadastralNumbers.includes(val)) {
        prevCadastralNumbers.push(val);
        renderCadList();
        saveCurrentState();
    }
    input.value = '';
    input.focus();
}

function removePrev(idx) {
    prevCadastralNumbers.splice(idx, 1);
    renderCadList();
    saveCurrentState();
}

function renderCadList() {
    const list = document.getElementById('prevCadList');
    list.innerHTML = '';
    prevCadastralNumbers.forEach((num, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${num}</span><span class="del-item" onclick="removePrev(${idx})">&times;</span>`;
        list.appendChild(li);
    });
}

function saveJsonProject() {
    const data = collectData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    saveAs(blob, `Schema_${data.docNumber || 'project'}.sch`);
}

function loadJsonProject(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            fillForm(JSON.parse(e.target.result));
            saveCurrentState();
        } catch (err) { 
            // Замена alert на showAlert
            showAlert('Ошибка', 'Не удалось прочитать файл проекта. Возможно, файл поврежден.', true);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function showHistory() {
    const modal = document.getElementById('historyModal');
    const list = document.getElementById('historyListContainer');
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    list.innerHTML = '';
    if (history.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-light)">История пуста</div>';
    }
    history.forEach(item => {
        const date = new Date(item.timestamp).toLocaleString('ru-RU');
        const method = formingMethods[item.formingMethod] || 'Не указано';
        const util = item.utilization || '—';
        
        const el = document.createElement('div');
        el.className = 'history-item';
        el.innerHTML = `
            <div class="h-col-1">
                <span class="h-title">№${item.docNumber || '—'}</span>
                <span class="h-date">${date}</span>
            </div>
            <div class="h-col-2">
                <span class="h-method">${method}</span>
                <span class="h-util" title="${util}">${util}</span>
            </div>
            <div class="h-col-3">
                <span class="h-block">${item.cadBlock || '—'}</span>
                <span class="h-area">${item.area || 0} м²</span>
            </div>
        `;
        el.onclick = () => { fillForm(item); saveCurrentState(); closeModal('historyModal'); };
        list.appendChild(el);
    });
    modal.style.display = 'flex';
}

function addToHistory(data) {
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    history.unshift(data);
    if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
}

function collectData() {
    return {
        timestamp: Date.now(),
        docNumber: document.getElementById('docNumber').value,
        docDate: document.getElementById('docDate').value,
        issueOrgan: document.getElementById('issueOrgan').value,
        prevCadastralNumbers: prevCadastralNumbers,
        cadBlock: document.getElementById('cadBlock').value,
        area: document.getElementById('area').value,
        category: document.getElementById('categorySelect').value,
        formingMethod: document.getElementById('formingMethod').value,
        utilization: document.getElementById('utilization').value,
        csValue: document.getElementById('csSelect').value,
        coords: document.getElementById('coordsInput').value,
        note: document.getElementById('note').value
    };
}

function fillForm(data) {
    document.getElementById('docNumber').value = data.docNumber || '';
    document.getElementById('docDate').value = data.docDate || '';
    document.getElementById('issueOrgan').value = data.issueOrgan || '';
    prevCadastralNumbers = data.prevCadastralNumbers || [];
    renderCadList();
    document.getElementById('cadBlock').value = data.cadBlock || '';
    document.getElementById('area').value = data.area || '';
    document.getElementById('categorySelect').value = data.category || '003002000000';
    document.getElementById('formingMethod').value = data.formingMethod || '3';
    document.getElementById('utilization').value = data.utilization || '';
    document.getElementById('csSelect').value = data.csValue || '16.2';
    document.getElementById('coordsInput').value = data.coords || '';
    document.getElementById('note').value = data.note || '';
}

function resetForm() {
    // Замена confirm на showConfirm
    showConfirm('Сброс данных', 'Вы действительно хотите очистить все поля формы?', function() {
        document.querySelectorAll('input, textarea').forEach(i => { if (i.type !== 'file') i.value = ''; });
        prevCadastralNumbers = [];
        renderCadList();
        localStorage.removeItem(CURRENT_STATE_KEY);
        const btnText = document.getElementById('fileBtnText');
        btnText.innerHTML = `<i class="fas fa-file-pdf"></i> Выбрать PDF файл`;
        btnText.classList.remove('has-file');
    });
}

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function generateCsId(region, zone) {
    return `Id${generateUUID()}.${region}.${zone}`;
}

async function generateZip() {
    const pdfInput = document.getElementById('pdfFile');
    // Замена alert на showAlert
    if (pdfInput.files.length === 0) { 
        showAlert('Отсутствует файл', 'Выберите PDF файл документа-основания для формирования архива.', true); 
        return; 
    }
    const data = collectData();
    addToHistory(data);
    const points = parseCoordinates(data.coords);
    // Замена alert на showAlert
    if (points.length < 3) { 
        showAlert('Ошибка координат', 'Недостаточно координат для формирования контура. Требуется минимум 3 точки.', true); 
        return; 
    }
    let spatialContent = '';
    const totalPoints = points.length;
    points.forEach((pt, idx) => {
        const xFixed = pt.x.toFixed(2);
        const yFixed = pt.y.toFixed(2);
        let numGeopoint = idx + 1;
        if (idx === totalPoints - 1) numGeopoint = 1;
        spatialContent += `          <Spelement_Unit Type_Unit="Точка">\n            <NewOrdinate Num_Geopoint="${numGeopoint}" X="${xFixed}" Y="${yFixed}" />\n          </Spelement_Unit>\n`;
    });
    let prevCadXml = '<Prev_CadastralNumbers />';
    if (prevCadastralNumbers.length > 0) {
        prevCadXml = '      <Prev_CadastralNumbers>\n';
        prevCadastralNumbers.forEach(num => prevCadXml += `        <CadastralNumber>${num}</CadastralNumber>\n`);
        prevCadXml += '      </Prev_CadastralNumbers>';
    }
    const csSelect = document.getElementById('csSelect');
    const csText = csSelect.options[csSelect.selectedIndex].text;
    const [region, zone] = data.csValue.split('.');
    const csId = generateCsId(region, zone);
    const mainGuid = generateUUID();
    const folderGuid = generateUUID();
    const rawDate = data.docDate;
    let formattedDate = rawDate;
    if (rawDate) {
        const [y, m, d] = rawDate.split('-');
        formattedDate = `${d}.${m}.${y}`;
    }
    const pdfFile = pdfInput.files[0];
    const newPdfName = `Постановление №${data.docNumber} от ${formattedDate}.pdf`;
    const relativePdfPath = `${folderGuid}\\${newPdfName}`;
    const xml = `<?xml version="1.0" encoding="utf-8"?>
<SchemaParcels>
  <eDocument Version="01" GUID="${mainGuid}" />
  <FormingMethod FormingMethod="${data.formingMethod}" />
  <Document>
    <Name>Постановление "Об утверждении схемы расположения земельного участка"</Name>
    <Number>${data.docNumber}</Number>
    <Date>${data.docDate}</Date>
    <IssueOrgans>
      <IssueOrgan>${data.issueOrgan}</IssueOrgan>
    </IssueOrgans>
  </Document>
  <NewParcels>
    <NewParcel>
      <CadastralBlock>${data.cadBlock}</CadastralBlock>
      <Area>
        <Area>${data.area}</Area>
        <Unit>055</Unit>
      </Area>
      <Entity_Spatial Ent_Sys="${csId}">
        <Spatial_Element>
${spatialContent}        </Spatial_Element>
      </Entity_Spatial>
${prevCadXml}
      <Note>${data.note}</Note>
      <Utilization ByDoc="${data.utilization}" />
      <Category Category="${data.category}" />
    </NewParcel>
  </NewParcels>
  <Coord_Systems>
    <Coord_System Name="${csText}" Cs_Id="${csId}" />
  </Coord_Systems>
  <ParcelSchema_In_Block>
    <AppliedFile Name="${relativePdfPath}" />
  </ParcelSchema_In_Block>
</SchemaParcels>`;
    const zip = new JSZip();
    zip.file(`SchemaParcels_${mainGuid}.xml`, xml);
    zip.folder(folderGuid).file(newPdfName, pdfFile);
    zip.generateAsync({ type: 'blob' }).then(c => saveAs(c, `SchemaParcels_${mainGuid}.zip`));
}
</script>

</body>
</html>
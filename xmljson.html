<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XML/JSON</title>
    <link rel="icon" href="img/query.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/idea.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neo.min.css">

    <style>
:root {
    --bg-gradient: linear-gradient(145deg, #ffffff 0%, #f0f7ff 50%, #e8f2ff 100%);
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f7ff;
    --bg-frost: rgba(255, 255, 255, 0.98);
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #94a3b8;
    --accent-color: #2563eb;
    --accent-hover: #1d4ed8;
    --accent-light: #e0eaff;
    --accent-gradient: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
    --border-color: #c7d9f1;
    --border-light: #e2e8f0;
    --shadow-soft: 0 2px 8px rgba(37, 99, 235, 0.06);
    --shadow-card: 0 4px 16px rgba(37, 99, 235, 0.08);
    --shadow-hover: 0 8px 24px rgba(37, 99, 235, 0.12);
    --danger-color: #ef4444;
    --success-color: #22c55e;
    --warning-color: #f59e0b;
}

.theme-dark {
    --bg-gradient: linear-gradient(145deg, #1e1e2e 0%, #282a36 50%, #1a1a2e 100%);
    --bg-primary: #1e1e2e;
    --bg-secondary: #282a36;
    --bg-tertiary: #343746;
    --bg-frost: rgba(40, 42, 54, 0.98);
    --text-primary: #f8f8f2;
    --text-secondary: #bd93f9;
    --text-muted: #6272a4;
    --border-color: #44475a;
    --border-light: #44475a;
    --accent-light: #44475a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    height: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
    overflow: hidden;
}

.app-container {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    background: var(--bg-frost);
}

.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    gap: 12px;
    flex-shrink: 0;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-color);
}

.header-logo i { font-size: 22px; }

.header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 38px;
    padding: 0 14px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    gap: 8px;
    transition: all 0.2s ease;
}

.header-btn:hover {
    background: var(--accent-light);
    color: var(--accent-color);
    border-color: var(--accent-color);
}

.header-btn.primary {
    background: var(--accent-gradient);
    color: white;
    border: none;
}

.header-btn.primary:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-1px);
}

.header-btn.success { background: var(--success-color); color: white; border: none; }
.header-btn.icon-only { width: 38px; padding: 0; }
.header-btn i { font-size: 14px; }

.editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-secondary);
    min-height: 0;
}

.editor-tabs {
    display: flex;
    gap: 2px;
    padding: 8px 20px 0;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    overflow-x: auto;
    flex-shrink: 0;
}

.editor-tab {
    padding: 10px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.editor-tab:hover { color: var(--text-primary); }

.editor-tab.active {
    background: var(--bg-secondary);
    color: var(--accent-color);
    border-color: var(--accent-color);
    border-bottom: 2px solid var(--bg-secondary);
    margin-bottom: -1px;
}

.tab-content {
    flex: 1;
    display: none;
    overflow: hidden;
    min-height: 0;
}

.tab-content.active { display: flex; flex-direction: column; }

.editor-wrapper {
    flex: 1;
    overflow: hidden;
    position: relative;
    min-height: 0;
}

.CodeMirror {
    position: absolute !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100% !important;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
}

.CodeMirror-scroll {
    overflow: auto !important;
}

.structure-wrapper, .summary-wrapper {
    flex: 1;
    overflow: auto;
    padding: 20px;
    background: var(--bg-secondary);
}

.tree-item {
    margin-left: 0;
}

.tree-item-header {
    display: flex;
    align-items: flex-start;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    gap: 6px;
    min-height: 28px;
}

.tree-item-header:hover {
    background: var(--accent-light);
}

.tree-toggle {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--text-muted);
    transition: transform 0.2s;
    flex-shrink: 0;
    margin-top: 2px;
}

.tree-toggle.collapsed {
    transform: rotate(-90deg);
}

.tree-toggle.empty {
    visibility: hidden;
}

.tree-icon {
    font-size: 12px;
    color: var(--accent-color);
    flex-shrink: 0;
    margin-top: 2px;
}

.tree-icon.attr { color: var(--warning-color); }
.tree-icon.text { color: var(--success-color); }

.tree-name {
    font-weight: 600;
    color: var(--accent-color);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
}

.tree-value {
    color: var(--success-color);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    word-break: break-word;
    white-space: normal;
    max-width: 600px;
}
.tree-type {
    color: var(--text-muted);
    font-size: 11px;
    padding: 1px 6px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    flex-shrink: 0;
}

.tree-count {
    color: var(--warning-color);
    font-size: 11px;
    flex-shrink: 0;
}

.tree-children {
    margin-left: 20px;
    border-left: 1px dashed var(--border-color);
    padding-left: 8px;
}

.tree-children.hidden {
    display: none;
}

.tree-root-info {
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    margin-bottom: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.table-wrapper {
    flex: 1;
    overflow: auto;
    padding: 20px;
}

.table-selector {
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.table-selector label {
    font-weight: 600;
    color: var(--text-secondary);
}

.table-selector select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 14px;
    min-width: 200px;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: var(--bg-secondary);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-color);
}

.data-table thead { background: var(--accent-gradient); }

.data-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: white;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.data-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 13px;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.data-table tbody tr:last-child td { border-bottom: none; }
.data-table tbody tr:nth-child(even) { background: var(--bg-tertiary); }
.data-table tbody tr:hover { background: var(--accent-light); }

.table-empty, .summary-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.table-empty i, .summary-empty i { font-size: 48px; margin-bottom: 16px; display: block; }

.control-panel {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    flex-wrap: wrap;
    flex-shrink: 0;
}

.search-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 200px;
}

.search-input {
    flex: 1;
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.search-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 50%;
    background: var(--accent-gradient);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.search-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-hover); }

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-select {
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
}

.control-select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.toggle-group {
    display: flex;
    align-items: center;
    gap: 6px;
}

.toggle-group input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent-color);
}

.toggle-group label {
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    white-space: nowrap;
}

.status-bar {
    padding: 6px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    flex-shrink: 0;
}

.status-item { display: flex; align-items: center; gap: 6px; }
.status-item i { color: var(--accent-color); }

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 100%;
    max-width: 600px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
}

.modal-header h2 i { color: var(--accent-color); }

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
}

.modal-close:hover { background: var(--danger-color); color: white; }

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.modal-actions {
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.modal-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.modal-btn.primary { background: var(--accent-gradient); color: white; }
.modal-btn:hover { box-shadow: var(--shadow-hover); transform: translateY(-1px); }

.export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
}

.export-option {
    padding: 20px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.export-option:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
}

.export-option i { font-size: 32px; margin-bottom: 10px; display: block; }
.export-option.csv i { color: #22c55e; }
.export-option.xlsx i { color: #16a34a; }
.export-option.docx i { color: #2563eb; }
.export-option.json i { color: #f59e0b; }
.export-option span { font-weight: 600; font-size: 14px; }

.db-list { display: flex; flex-direction: column; gap: 8px; }

.db-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.db-item:hover { border-color: var(--accent-color); background: var(--accent-light); }
.db-item-name { font-weight: 500; flex: 1; }
.db-item-actions { display: flex; gap: 6px; }

.db-item-btn {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
}

.db-item-btn.load { background: var(--accent-color); color: white; }
.db-item-btn.delete { background: var(--danger-color); color: white; }

.summary-section {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
}

.summary-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--accent-gradient);
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
}

.summary-section-header i { margin-right: 10px; }
.summary-section-header .toggle-icon { transition: transform 0.2s; }
.summary-section.collapsed .toggle-icon { transform: rotate(-90deg); }
.summary-section.collapsed .summary-section-body { display: none; }
.summary-section-body { padding: 16px 18px; }

.summary-row {
    display: flex;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
    flex-wrap: wrap;
    gap: 8px;
}

.summary-row:last-child { border-bottom: none; }

.summary-label {
    flex: 0 0 200px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
    word-break: break-all;
}

.summary-value {
    flex: 1;
    color: var(--text-primary);
    font-size: 13px;
    word-break: break-word;
    min-width: 150px;
}

.summary-value.copyable {
    cursor: pointer;
    padding: 2px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    transition: all 0.2s;
}

.summary-value.copyable:hover { background: var(--accent-light); }

.summary-badge {
    display: inline-block;
    padding: 4px 10px;
    background: var(--accent-light);
    color: var(--accent-color);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

.summary-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 16px;
}

.summary-card-title {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.summary-card-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
}

.summary-card-value.large {
    font-size: 24px;
    color: var(--accent-color);
}

.toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text-primary);
    color: var(--bg-secondary);
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s;
}

.toast.show { opacity: 1; }

@media (max-width: 768px) {
    .app-header { padding: 8px 12px; flex-wrap: wrap; }
    .header-logo span { display: none; }
    .header-btn span { display: none; }
    .header-btn { padding: 0 10px; }
    .editor-tabs { padding: 6px 12px 0; }
    .editor-tab { padding: 8px 12px; font-size: 12px; }
    .control-panel { padding: 10px 12px; }
    .search-group { min-width: 150px; }
    .status-bar { padding: 6px 12px; font-size: 11px; }
    .summary-label { flex: 0 0 100%; }
}

@media print {
    .app-header, .control-panel, .status-bar, .editor-tabs { display: none !important; }
    .app-container { height: auto; }
    .editor-area, .tab-content { overflow: visible; height: auto; }
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <i class="fa-solid fa-code"></i>
                    <span>XML/JSON</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn primary" id="btn-open-file" title="Открыть файл">
                    <i class="fa-solid fa-folder-open"></i>
                    <span>Открыть</span>
                </button>
                <button class="header-btn" id="btn-paste" title="Вставить из буфера">
                    <i class="fa-solid fa-paste"></i>
                    <span>Вставить</span>
                </button>
                <button class="header-btn" id="btn-format" title="Форматировать">
                    <i class="fa-solid fa-indent"></i>
                    <span>Формат</span>
                </button>
                <button class="header-btn" id="btn-minify" title="Сжать">
                    <i class="fa-solid fa-compress"></i>
                </button>
                <button class="header-btn success" id="btn-save" title="Сохранить">
                    <i class="fa-solid fa-download"></i>
                    <span>Сохранить</span>
                </button>
                <button class="header-btn" id="btn-export" title="Экспорт">
                    <i class="fa-solid fa-file-export"></i>
                    <span>Экспорт</span>
                </button>
                <button class="header-btn" id="btn-db" title="База данных">
                    <i class="fa-solid fa-database"></i>
                </button>
                <button class="header-btn icon-only" id="btn-settings" title="Настройки">
                    <i class="fa-solid fa-cog"></i>
                </button>
            </div>
            <input type="file" id="file-input" accept=".xml,.json,.txt,.log,.csv,.zip" style="display:none;">
        </header>

        <main class="editor-area">
            <div class="editor-tabs">
                <div class="editor-tab active" data-tab="editor">
                    <i class="fa-solid fa-code"></i>
                    Редактор
                </div>
                <div class="editor-tab" data-tab="structure">
                    <i class="fa-solid fa-sitemap"></i>
                    Структура
                </div>
                <div class="editor-tab" data-tab="table">
                    <i class="fa-solid fa-table"></i>
                    Таблица
                </div>
                <div class="editor-tab" data-tab="summary">
                    <i class="fa-solid fa-clipboard-list"></i>
                    Обзор
                </div>
            </div>

            <div class="tab-content active" id="tab-editor">
                <div class="editor-wrapper">
                    <div id="code-editor"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-structure">
                <div class="structure-wrapper">
                    <div id="structure-tree"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-table">
                <div class="table-wrapper">
                    <div class="table-selector">
                        <label>Выберите данные:</label>
                        <select id="table-data-select"></select>
                    </div>
                    <div id="table-view"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-summary">
                <div class="summary-wrapper">
                    <div id="summary-view"></div>
                </div>
            </div>
        </main>

        <div class="control-panel">
            <div class="search-group">
                <input type="text" class="search-input" id="search-input" placeholder="Поиск...">
                <button class="search-btn" id="btn-search-prev" title="Предыдущий">
                    <i class="fa-solid fa-chevron-up"></i>
                </button>
                <button class="search-btn" id="btn-search-next" title="Следующий">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <button class="search-btn" id="btn-filter" title="Фильтр" style="background: var(--warning-color);">
                    <i class="fa-solid fa-filter"></i>
                </button>
            </div>
            
            <div class="control-group">
                <div class="toggle-group">
                    <input type="checkbox" id="toggle-wrap">
                    <label for="toggle-wrap">Перенос</label>
                </div>
            </div>

            <div class="control-group">
                <select class="control-select" id="select-font-size" title="Размер шрифта">
                    <option value="11">11px</option>
                    <option value="12">12px</option>
                    <option value="13">13px</option>
                    <option value="14" selected>14px</option>
                    <option value="15">15px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                </select>
                <select class="control-select" id="select-theme">
                    <option value="eclipse">Eclipse</option>
                    <option value="idea">IDEA</option>
                    <option value="neo">Neo</option>
                    <option value="dracula">Dracula</option>
                    <option value="monokai">Monokai</option>
                    <option value="material">Material</option>
                </select>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <i class="fa-solid fa-file"></i>
                <span id="status-file">Нет файла</span>
            </div>
            <div class="status-item">
                <i class="fa-solid fa-weight-hanging"></i>
                <span id="status-size">0 КБ</span>
            </div>
            <div class="status-item">
                <i class="fa-solid fa-text-width"></i>
                <span id="status-chars">0 символов</span>
            </div>
            <div class="status-item">
                <i class="fa-solid fa-list-ol"></i>
                <span id="status-lines">0 строк</span>
            </div>
            <div class="status-item">
                <i class="fa-solid fa-code"></i>
                <span id="status-type">-</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-settings">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-cog"></i> Настройки</h2>
                <button class="modal-close" data-close="modal-settings"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="toggle-group">
                    <input type="checkbox" id="setting-dark-mode">
                    <label for="setting-dark-mode">Тёмная тема интерфейса</label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn primary" id="btn-save-settings"><i class="fa-solid fa-check"></i> Сохранить</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-export">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-file-export"></i> Экспорт данных</h2>
                <button class="modal-close" data-close="modal-export"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Выберите формат:</p>
                <div class="export-options">
                    <div class="export-option csv" data-format="csv"><i class="fa-solid fa-file-csv"></i><span>CSV</span></div>
                    <div class="export-option xlsx" data-format="xlsx"><i class="fa-solid fa-file-excel"></i><span>XLSX</span></div>
                    <div class="export-option docx" data-format="docx"><i class="fa-solid fa-file-word"></i><span>DOC</span></div>
                    <div class="export-option json" data-format="json"><i class="fa-solid fa-file-code"></i><span>JSON</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-db">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-database"></i> База данных</h2>
                <button class="modal-close" data-close="modal-db"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <button class="modal-btn primary" id="btn-db-save" style="margin-bottom: 20px;"><i class="fa-solid fa-plus"></i> Сохранить текущий файл</button>
                <h3 style="margin-bottom: 12px; font-size: 14px; color: var(--text-secondary);">Сохранённые:</h3>
                <div class="db-list" id="db-list"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
let editor;
let originalContent = '';
let allLines = [];
let currentFileName = 'document';
let detectedType = 'text';
let allTableData = {};
let currentTableKey = '';
let searchCursor = null;
let lastSearchQuery = '';
let isFiltered = false;
let db;
let parsedXMLDoc = null;
let parsedJSONObj = null;

document.addEventListener('DOMContentLoaded', function() {
    initEditor();
    initIndexedDB();
    loadSettings();
    initEventListeners();
    pasteFromClipboard();
});

// Добавь эту функцию после processContent
function reprocessContent(content) {
    console.log('=== reprocessContent ===');
    
    originalContent = content;
    allLines = content.split('\n');
    parsedXMLDoc = null;
    parsedJSONObj = null;
    
    var cleaned = cleanXMLContent(content);
    console.log('Cleaned first 200 chars:', cleaned.substring(0, 200));
    
    detectedType = detectContentType(content);
    document.getElementById('status-type').textContent = detectedType.toUpperCase();
    console.log('Detected type:', detectedType);
    
    if (detectedType === 'xml') {
        try {
            var parser = new DOMParser();
            parsedXMLDoc = parser.parseFromString(cleaned, 'text/xml');
            var errorNode = parsedXMLDoc.querySelector('parsererror');
            if (errorNode) {
                console.error('XML Parse Error');
                parsedXMLDoc = null;
            } else {
                console.log('XML parsed! Root:', parsedXMLDoc.documentElement.nodeName);
            }
        } catch (e) {
            parsedXMLDoc = null;
        }
    } else if (detectedType === 'json') {
        try {
            parsedJSONObj = JSON.parse(cleaned);
        } catch (e) {
            parsedJSONObj = null;
        }
    }
    
    // Обновляем статус
    updateStatusBar(null, 'Вставлено', content.length);
}

function initEditor() {
    var savedFontSize = localStorage.getItem('editorFontSize') || '14';
    var savedTheme = localStorage.getItem('theme') || 'eclipse';
    var savedWrap = localStorage.getItem('wrap') === 'true';
    
    editor = CodeMirror(document.getElementById('code-editor'), {
        lineNumbers: true,
        mode: 'xml',
        theme: savedTheme,
        lineWrapping: savedWrap,
        matchBrackets: true,
        indentUnit: 4,
        tabSize: 4,
        scrollbarStyle: 'native'
    });
    
    document.getElementById('select-theme').value = savedTheme;
    document.getElementById('toggle-wrap').checked = savedWrap;
    document.getElementById('select-font-size').value = savedFontSize;
    
    setTimeout(function() {
        var cmElement = document.querySelector('.CodeMirror');
        if (cmElement) {
            cmElement.style.fontSize = savedFontSize + 'px';
            editor.refresh();
        }
    }, 100);
    
    editor.on('change', function() { updateStatusBar(); });
    
  
    editor.getWrapperElement().addEventListener('paste', function(e) {
        setTimeout(function() {
            var content = editor.getValue();
            if (content && content.trim()) {
                console.log('=== Paste detected in editor ===');
                reprocessContent(content);
            }
        }, 100);
    });
}

function initIndexedDB() {
    var request = indexedDB.open('XMLViewerDB', 1);
    request.onerror = function() { console.error('IndexedDB error'); };
    request.onupgradeneeded = function(e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains('files')) {
            db.createObjectStore('files', { keyPath: 'id' });
        }
    };
    request.onsuccess = function(e) { db = e.target.result; };
}

function loadSettings() {
    var darkMode = localStorage.getItem('darkMode') === 'true';
    document.getElementById('setting-dark-mode').checked = darkMode;
    if (darkMode) document.body.classList.add('theme-dark');
}

function initEventListeners() {
    document.querySelectorAll('.editor-tab').forEach(function(tab) {
        tab.addEventListener('click', function() { switchTab(tab.dataset.tab); });
    });
    
    document.getElementById('btn-open-file').addEventListener('click', function() {
        document.getElementById('file-input').click();
    });
    
    document.getElementById('file-input').addEventListener('change', handleFileOpen);
    document.getElementById('btn-paste').addEventListener('click', pasteFromClipboard);
    document.getElementById('btn-format').addEventListener('click', formatContent);
    document.getElementById('btn-minify').addEventListener('click', minifyContent);
    document.getElementById('btn-save').addEventListener('click', saveToFile);
    document.getElementById('btn-export').addEventListener('click', function() { openModal('modal-export'); });
    document.getElementById('btn-db').addEventListener('click', function() { loadDBList(); openModal('modal-db'); });
    document.getElementById('btn-settings').addEventListener('click', function() { openModal('modal-settings'); });
    
    document.getElementById('btn-search-next').addEventListener('click', function() { searchText(true); });
    document.getElementById('btn-search-prev').addEventListener('click', function() { searchText(false); });
    document.getElementById('btn-filter').addEventListener('click', toggleFilter);
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') toggleFilter();
    });
    
    document.getElementById('select-theme').addEventListener('change', function(e) {
        editor.setOption('theme', e.target.value);
        localStorage.setItem('theme', e.target.value);
        updateThemeColors(e.target.value);
    });
    
    document.getElementById('select-font-size').addEventListener('change', function(e) {
        var size = e.target.value;
        var cmElement = document.querySelector('.CodeMirror');
        if (cmElement) {
            cmElement.style.fontSize = size + 'px';
            editor.refresh();
        }
        localStorage.setItem('editorFontSize', size);
    });
    
    document.getElementById('toggle-wrap').addEventListener('change', function(e) {
        editor.setOption('lineWrapping', e.target.checked);
        localStorage.setItem('wrap', e.target.checked);
    });
    
    document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
    
    document.querySelectorAll('.export-option').forEach(function(opt) {
        opt.addEventListener('click', function() { exportData(opt.dataset.format); });
    });
    
    document.getElementById('btn-db-save').addEventListener('click', saveToIndexedDB);
    
    document.querySelectorAll('.modal-close').forEach(function(btn) {
        btn.addEventListener('click', function() { closeModal(btn.dataset.close); });
    });
    
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) closeModal(overlay.id);
        });
    });
    
    document.getElementById('table-data-select').addEventListener('change', function(e) {
        currentTableKey = e.target.value;
        renderCurrentTable();
    });
}

function handleFileOpen(e) {
    var file = e.target.files[0];
    if (!file) return;
    currentFileName = file.name.replace(/\.[^/.]+$/, '');
    if (file.name.endsWith('.zip')) {
        handleZipFile(file);
    } else {
        readFile(file);
    }
    e.target.value = '';
}

function readFile(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
        processContent(e.target.result, file.name);
        updateStatusBar(file);
    };
    reader.readAsText(file);
}

function handleZipFile(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
        JSZip.loadAsync(e.target.result).then(function(zip) {
            var files = Object.keys(zip.files).filter(function(f) { 
                return /\.(xml|json|txt|log|csv)$/i.test(f) && !f.startsWith('__MACOSX');
            });
            if (files.length === 0) {
                showToast('ZIP не содержит поддерживаемых файлов');
                return;
            }
            zip.file(files[0]).async('string').then(function(content) {
                currentFileName = files[0].replace(/\.[^/.]+$/, '');
                processContent(content, files[0]);
                updateStatusBar(file, files[0]);
            });
        }).catch(function(err) {
            showToast('Ошибка чтения ZIP');
        });
    };
    reader.readAsArrayBuffer(file);
}

function pasteFromClipboard() {
    navigator.clipboard.readText().then(function(text) {
        if (text && text.trim()) {
            processContent(text, 'clipboard');
            updateStatusBar(null, 'Буфер обмена', text.length);
        }
    }).catch(function(err) {});
}

// ВАЖНО: Исправленная функция очистки XML
// Замени cleanXMLContent
function cleanXMLContent(content) {
    if (!content) return '';
    
    // Удаляем BOM
    var cleaned = content.replace(/^\uFEFF/, '');
    
    // Простой подход: удаляем - или + которые стоят перед <
    // Это покрывает случаи типа "- <tag>" или "-<tag>"
    cleaned = cleaned.replace(/[-+]\s*</g, '<');
    
    // Удаляем строки которые содержат только - или +
    var lines = cleaned.split('\n');
    var result = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var trimmed = line.trim();
        // Пропускаем строки которые только - или +
        if (trimmed === '-' || trimmed === '+') continue;
        result.push(line);
    }
    
    return result.join('\n').trim();
}

// Замени detectContentType
function detectContentType(content) {
    if (!content) return 'text';
    
    var cleaned = cleanXMLContent(content);
    
    console.log('=== detectContentType ===');
    console.log('First 200 chars after clean:', cleaned.substring(0, 200));
    
    // Ищем XML декларацию или теги
    if (cleaned.indexOf('<?xml') !== -1) {
        console.log('Found <?xml');
        return 'xml';
    }
    
    // Ищем паттерн тегов <Name ...> или <Name>
    if (/<[A-Za-z_][A-Za-z0-9_-]*[\s>]/.test(cleaned)) {
        console.log('Found XML tags pattern');
        return 'xml';
    }
    
    // Проверяем JSON
    var trimmed = cleaned.trim();
    var firstChar = trimmed.charAt(0);
    if (firstChar === '{' || firstChar === '[') {
        try {
            JSON.parse(trimmed);
            console.log('Valid JSON');
            return 'json';
        } catch (e) {
            console.log('JSON parse failed:', e.message);
        }
    }
    
    console.log('Detected as text');
    return 'text';
}


function processContent(content, filename) {
    console.log('=== processContent ===');
    console.log('Original content length:', content ? content.length : 0);
    
    originalContent = content;
    allLines = content.split('\n');
    parsedXMLDoc = null;
    parsedJSONObj = null;
    
    // Очищаем
    var cleaned = cleanXMLContent(content);
    console.log('Cleaned content length:', cleaned.length);
    console.log('Cleaned first 300 chars:', cleaned.substring(0, 300));
    
    // Определяем тип
    detectedType = detectContentType(content);
    document.getElementById('status-type').textContent = detectedType.toUpperCase();
    console.log('Detected type:', detectedType);
    
    if (detectedType === 'xml') {
        try {
            var parser = new DOMParser();
            parsedXMLDoc = parser.parseFromString(cleaned, 'text/xml');
            var errorNode = parsedXMLDoc.querySelector('parsererror');
            if (errorNode) {
                console.error('XML Parse Error:', errorNode.textContent.substring(0, 200));
                parsedXMLDoc = null;
            } else {
                console.log('XML parsed successfully! Root:', parsedXMLDoc.documentElement.nodeName);
            }
        } catch (e) {
            console.error('XML parsing exception:', e);
            parsedXMLDoc = null;
        }
    } else if (detectedType === 'json') {
        try {
            parsedJSONObj = JSON.parse(cleaned);
            console.log('JSON parsed successfully');
        } catch (e) {
            console.error('JSON parse error:', e);
            parsedJSONObj = null;
        }
    }
    
    var formatted = autoFormat(cleaned, detectedType);
    editor.setValue(formatted);
    
    var mode = detectedType === 'json' ? 'javascript' : detectedType === 'xml' ? 'xml' : 'text';
    editor.setOption('mode', mode);
    
    setTimeout(function() { editor.refresh(); }, 50);
}

function detectContentType(content) {
    // Сначала очищаем от артефактов
    var cleaned = cleanXMLContent(content);
    var trimmed = cleaned.trim();
    
    console.log('detectContentType - first 100 chars:', trimmed.substring(0, 100));
    
    // Проверяем JSON
    var firstChar = trimmed.charAt(0);
    if (firstChar === '{' || firstChar === '[') {
        try { 
            JSON.parse(trimmed); 
            return 'json'; 
        } catch (e) {}
    }
    
    // Проверяем XML - ищем XML декларацию
    if (trimmed.indexOf('<?xml') === 0) {
        return 'xml';
    }
    
    // Проверяем XML - ищем открывающий тег в начале
    if (firstChar === '<') {
        return 'xml';
    }
    
    // Проверяем наличие XML тегов где угодно
    if (/<[a-zA-Z][^>]*>/.test(trimmed) && /<\/[a-zA-Z]/.test(trimmed)) {
        return 'xml';
    }
    
    return 'text';
}




function autoFormat(content, type) {
    if (type === 'json') return formatJSON(content);
    if (type === 'xml') return formatXML(content);
    return content;
}

function formatJSON(content) {
    try { return JSON.stringify(JSON.parse(content), null, 4); } 
    catch (e) { return content; }
}

function formatXML(content) {
    try {
        var formatted = content.replace(/>\s*</g, '><').replace(/(>)(<)(\/*)/g, '$1\n$2$3');
        var lines = formatted.split('\n');
        var result = [];
        var indent = 0;
        
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line) continue;
            
            if (/^<\/\w/.test(line)) indent = Math.max(0, indent - 1);
            
            var padding = '';
            for (var j = 0; j < indent; j++) padding += '    ';
            result.push(padding + line);
            
            if (/^<\w[^>]*[^\/]>$/.test(line) && !/<\/\w/.test(line)) indent++;
        }
        return result.join('\n');
    } catch (e) { return content; }
}

function formatContent() {
    var content = editor.getValue();
    var cleaned = cleanXMLContent(content);
    var type = detectContentType(cleaned);
    editor.setValue(autoFormat(cleaned, type));
    editor.refresh();
    showToast('Отформатировано');
}

function minifyContent() {
    var content = editor.getValue();
    var type = detectContentType(content);
    if (type === 'json') {
        try { editor.setValue(JSON.stringify(JSON.parse(content))); showToast('Сжато'); } catch (e) {}
    } else if (type === 'xml') {
        editor.setValue(content.replace(/>\s+</g, '><').replace(/\n\s*/g, ''));
        showToast('Сжато');
    }
    editor.refresh();
}

// =============== STRUCTURE TREE ===============

function updateStructureTree() {
    var container = document.getElementById('structure-tree');
    
    console.log('updateStructureTree called, detectedType:', detectedType, 'parsedXMLDoc:', !!parsedXMLDoc);
    
    if (detectedType === 'json' && parsedJSONObj) {
        container.innerHTML = '<div class="tree-root-info"><i class="fa-solid fa-folder-tree"></i> JSON структура</div>' + 
            buildJSONTreeHTML(parsedJSONObj, 'root', 0);
        attachTreeListeners(container);
    } else if (detectedType === 'xml' && parsedXMLDoc) {
        var rootName = parsedXMLDoc.documentElement.nodeName;
        container.innerHTML = '<div class="tree-root-info"><i class="fa-solid fa-folder-tree"></i> XML: ' + rootName + '</div>' + 
            buildXMLTreeHTML(parsedXMLDoc.documentElement, 0);
        attachTreeListeners(container);
    } else {
        container.innerHTML = '<div class="table-empty"><i class="fa-solid fa-exclamation-triangle"></i><p>Структура недоступна.<br>Тип: ' + detectedType + '<br>XML Doc: ' + (parsedXMLDoc ? 'да' : 'нет') + '</p></div>';
    }
}

function attachTreeListeners(container) {
    var headers = container.querySelectorAll('.tree-item-header');
    for (var i = 0; i < headers.length; i++) {
        headers[i].addEventListener('click', function(e) {
            var item = this.parentElement;
            var children = item.querySelector('.tree-children');
            var toggle = this.querySelector('.tree-toggle');
            if (children && toggle && !toggle.classList.contains('empty')) {
                children.classList.toggle('hidden');
                toggle.classList.toggle('collapsed');
            }
        });
    }
}

function buildXMLTreeHTML(node, depth) {
    if (!node || node.nodeType !== 1) return '';
    if (depth > 30) return '<div class="tree-item"><div class="tree-item-header"><span class="tree-name">... (глубина)</span></div></div>';
    
    var hasAttr = node.attributes && node.attributes.length > 0;
    var hasChildren = node.children && node.children.length > 0;
    var hasContent = hasAttr || hasChildren;
    
    var textContent = '';
    for (var i = 0; i < node.childNodes.length; i++) {
        if (node.childNodes[i].nodeType === 3) {
            textContent += node.childNodes[i].textContent;
        }
    }
    textContent = textContent.trim();
    
    var html = '<div class="tree-item">';
    html += '<div class="tree-item-header">';
    html += '<span class="tree-toggle ' + (hasContent ? '' : 'empty') + '"><i class="fa-solid fa-chevron-down"></i></span>';
    html += '<i class="fa-solid fa-tag tree-icon"></i>';
    html += '<span class="tree-name">' + escapeHtml(node.nodeName) + '</span>';
    
 if (textContent && !hasChildren) {
    html += '<span class="tree-value" title="Клик для копирования" style="cursor:pointer;" onclick="copyToClipboard(this.dataset.value)" data-value="' + escapeHtml(textContent).replace(/"/g, '&quot;') + '">"' + escapeHtml(textContent) + '"</span>';
}
    
    if (hasChildren) {
        html += '<span class="tree-count">[' + node.children.length + ']</span>';
    }
    
    html += '</div>';
    
    if (hasContent) {
        html += '<div class="tree-children">';
        
        // Атрибуты
        if (hasAttr) {
            for (var j = 0; j < node.attributes.length; j++) {
                var attr = node.attributes[j];
                html += '<div class="tree-item">';
                html += '<div class="tree-item-header">';
                html += '<span class="tree-toggle empty"></span>';
                html += '<i class="fa-solid fa-at tree-icon attr"></i>';
                html += '<span class="tree-name">@' + escapeHtml(attr.name) + '</span>';
                html += '<span class="tree-value">"' + escapeHtml(attr.value) + '"</span>';
                html += '</div></div>';
            }
        }
        
        // Дочерние элементы
        for (var k = 0; k < node.children.length; k++) {
            html += buildXMLTreeHTML(node.children[k], depth + 1);
        }
        
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function buildJSONTreeHTML(obj, key, depth) {
    if (depth > 30) return '<div class="tree-item"><div class="tree-item-header"><span class="tree-name">...</span></div></div>';
    
    var isArray = Array.isArray(obj);
    var isObject = typeof obj === 'object' && obj !== null;
    var hasChildren = isObject && Object.keys(obj).length > 0;
    
    var html = '<div class="tree-item">';
    html += '<div class="tree-item-header">';
    html += '<span class="tree-toggle ' + (hasChildren ? '' : 'empty') + '"><i class="fa-solid fa-chevron-down"></i></span>';
    
    if (isArray) {
        html += '<i class="fa-solid fa-list tree-icon"></i>';
        html += '<span class="tree-name">' + escapeHtml(key) + '</span>';
        html += '<span class="tree-type">Array</span>';
        html += '<span class="tree-count">[' + obj.length + ']</span>';
    } else if (isObject) {
        html += '<i class="fa-solid fa-cube tree-icon"></i>';
        html += '<span class="tree-name">' + escapeHtml(key) + '</span>';
        html += '<span class="tree-type">Object</span>';
        html += '<span class="tree-count">{' + Object.keys(obj).length + '}</span>';
    } else {
        html += '<i class="fa-solid fa-font tree-icon text"></i>';
        html += '<span class="tree-name">' + escapeHtml(key) + '</span>';
        var val = obj === null ? 'null' : '"' + escapeHtml(String(obj).substring(0, 80)) + '"';
        html += '<span class="tree-value">' + val + '</span>';
        html += '<span class="tree-type">' + (typeof obj) + '</span>';
    }
    
    html += '</div>';
    
    if (hasChildren) {
        html += '<div class="tree-children">';
        var keys = Object.keys(obj);
        for (var i = 0; i < keys.length; i++) {
            var k = keys[i];
            html += buildJSONTreeHTML(obj[k], isArray ? '[' + k + ']' : k, depth + 1);
        }
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

// =============== TABLE VIEW ===============

function updateTableView() {
    allTableData = {};
    var select = document.getElementById('table-data-select');
    select.innerHTML = '';
    
    console.log('updateTableView called');
    
    if (detectedType === 'xml' && parsedXMLDoc) {
        extractAllXMLTables(parsedXMLDoc.documentElement);
    } else if (detectedType === 'json' && parsedJSONObj) {
        extractAllJSONTables(parsedJSONObj, 'root');
    }
    
    var keys = Object.keys(allTableData);
    console.log('Table keys found:', keys);
    
    if (keys.length === 0) {
        document.getElementById('table-view').innerHTML = '<div class="table-empty"><i class="fa-solid fa-table"></i><p>Нет табличных данных</p></div>';
        return;
    }
    
    for (var i = 0; i < keys.length; i++) {
        var opt = document.createElement('option');
        opt.value = keys[i];
        opt.textContent = keys[i] + ' (' + allTableData[keys[i]].length + ' записей)';
        select.appendChild(opt);
    }
    
    currentTableKey = keys[0];
    renderCurrentTable();
}

function extractAllXMLTables(root) {
    var tagCounts = {};
    
    function countTags(node) {
        if (node.nodeType !== 1) return;
        tagCounts[node.nodeName] = (tagCounts[node.nodeName] || 0) + 1;
        for (var i = 0; i < node.children.length; i++) {
            countTags(node.children[i]);
        }
    }
    countTags(root);
    
    console.log('Tag counts:', tagCounts);
    
    var repeatingTags = [];
    for (var tag in tagCounts) {
        if (tagCounts[tag] >= 2) {
            repeatingTags.push(tag);
        }
    }
    
    console.log('Repeating tags:', repeatingTags);
    
    for (var t = 0; t < repeatingTags.length; t++) {
        var tagName = repeatingTags[t];
        var elements = root.querySelectorAll(tagName);
        if (elements.length < 2) continue;
        
        var rows = [];
        var allHeaders = {};
        
        for (var i = 0; i < elements.length; i++) {
            var row = extractElementData(elements[i]);
            for (var h in row) {
                allHeaders[h] = true;
            }
            rows.push(row);
        }
        
        var headers = Object.keys(allHeaders);
        if (headers.length === 0) continue;
        
        // Нормализуем
        var normalizedRows = [];
        for (var j = 0; j < rows.length; j++) {
            var normalized = {};
            for (var k = 0; k < headers.length; k++) {
                normalized[headers[k]] = rows[j][headers[k]] || '';
            }
            normalizedRows.push(normalized);
        }
        
        if (normalizedRows.length > 0) {
            allTableData[tagName] = normalizedRows;
        }
    }
}

function extractElementData(el) {
    var data = {};
    
    // Атрибуты элемента
    for (var i = 0; i < el.attributes.length; i++) {
        var attr = el.attributes[i];
        data['@' + attr.name] = attr.value;
    }
    
    // Дочерние элементы
    for (var j = 0; j < el.children.length; j++) {
        var child = el.children[j];
        
        // Получаем текстовое содержимое
        var text = '';
        for (var k = 0; k < child.childNodes.length; k++) {
            if (child.childNodes[k].nodeType === 3) {
                text += child.childNodes[k].textContent;
            }
        }
        text = text.trim();
        
        if (text) {
            data[child.nodeName] = text;
        }
        
        // Атрибуты дочернего элемента
        for (var m = 0; m < child.attributes.length; m++) {
            var childAttr = child.attributes[m];
            data[child.nodeName + '/@' + childAttr.name] = childAttr.value;
        }
    }
    
    // Прямой текст элемента
    var directText = '';
    for (var n = 0; n < el.childNodes.length; n++) {
        if (el.childNodes[n].nodeType === 3) {
            directText += el.childNodes[n].textContent;
        }
    }
    directText = directText.trim();
    
    if (directText && Object.keys(data).length === 0) {
        data['#text'] = directText;
    }
    
    return data;
}

function extractAllJSONTables(obj, path) {
    if (Array.isArray(obj) && obj.length >= 2 && typeof obj[0] === 'object' && obj[0] !== null) {
        var allHeaders = {};
        for (var i = 0; i < obj.length; i++) {
            var item = obj[i];
            if (typeof item === 'object' && item !== null) {
                for (var k in item) {
                    if (typeof item[k] !== 'object') {
                        allHeaders[k] = true;
                    }
                }
            }
        }
        
        var headers = Object.keys(allHeaders);
        if (headers.length > 0) {
            var rows = [];
            for (var j = 0; j < obj.length; j++) {
                var row = {};
                for (var h = 0; h < headers.length; h++) {
                    var key = headers[h];
                    var val = obj[j] && obj[j][key];
                    row[key] = val !== undefined ? (typeof val === 'object' ? JSON.stringify(val) : String(val)) : '';
                }
                rows.push(row);
            }
            allTableData[path] = rows;
        }
    }
    
    if (typeof obj === 'object' && obj !== null) {
        for (var key in obj) {
            var newPath = path === 'root' ? key : path + '.' + key;
            extractAllJSONTables(obj[key], newPath);
        }
    }
}

function renderCurrentTable() {
    var container = document.getElementById('table-view');
    var data = allTableData[currentTableKey];
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="table-empty"><i class="fa-solid fa-table"></i><p>Нет данных</p></div>';
        return;
    }
    
    var headers = Object.keys(data[0]);
    var html = '<table class="data-table"><thead><tr>';
    for (var i = 0; i < headers.length; i++) {
        html += '<th>' + escapeHtml(headers[i]) + '</th>';
    }
    html += '</tr></thead><tbody>';
    
    for (var j = 0; j < data.length; j++) {
        html += '<tr>';
        for (var k = 0; k < headers.length; k++) {
            var val = String(data[j][headers[k]] || '');
            html += '<td title="' + escapeHtml(val) + '">' + escapeHtml(val) + '</td>';
        }
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// =============== SUMMARY VIEW ===============

function updateSummaryView() {
    var container = document.getElementById('summary-view');
    
    if (detectedType === 'xml' && parsedXMLDoc) {
        container.innerHTML = buildXMLSummary(parsedXMLDoc.documentElement);
        attachSummaryListeners(container);
    } else if (detectedType === 'json' && parsedJSONObj) {
        container.innerHTML = buildJSONSummary(parsedJSONObj);
        attachSummaryListeners(container);
    } else {
        container.innerHTML = '<div class="summary-empty"><i class="fa-solid fa-file-lines"></i><p>Обзор недоступен</p></div>';
    }
}

function attachSummaryListeners(container) {
    var headers = container.querySelectorAll('.summary-section-header');
    for (var i = 0; i < headers.length; i++) {
        headers[i].addEventListener('click', function() {
            this.parentElement.classList.toggle('collapsed');
        });
    }
    
    var copyables = container.querySelectorAll('.summary-value.copyable');
    for (var j = 0; j < copyables.length; j++) {
        copyables[j].addEventListener('click', function() {
            copyToClipboard(this.textContent);
        });
    }
}

function buildXMLSummary(root) {
    var stats = { elements: 0, attributes: 0, textNodes: 0 };
    
    function countStats(node) {
        if (node.nodeType === 1) {
            stats.elements++;
            stats.attributes += node.attributes.length;
            for (var i = 0; i < node.childNodes.length; i++) {
                var child = node.childNodes[i];
                if (child.nodeType === 3 && child.textContent.trim()) stats.textNodes++;
                countStats(child);
            }
        }
    }
    countStats(root);
    
    var html = '<div class="summary-section">';
    html += '<div class="summary-section-header"><span><i class="fa-solid fa-chart-simple"></i>Статистика</span><i class="fa-solid fa-chevron-down toggle-icon"></i></div>';
    html += '<div class="summary-section-body"><div class="summary-grid">';
    html += '<div class="summary-card"><div class="summary-card-title">Корень</div><div class="summary-card-value">' + root.nodeName + '</div></div>';
    html += '<div class="summary-card"><div class="summary-card-title">Элементов</div><div class="summary-card-value large">' + stats.elements + '</div></div>';
    html += '<div class="summary-card"><div class="summary-card-title">Атрибутов</div><div class="summary-card-value">' + stats.attributes + '</div></div>';
    html += '<div class="summary-card"><div class="summary-card-title">Текстовых</div><div class="summary-card-value">' + stats.textNodes + '</div></div>';
    html += '</div></div></div>';
    
    // Извлечённые данные
    var extractors = {
        'Участки': function() {
            var parcels = root.querySelectorAll('ExistParcel, Parcel');
            var result = [];
            for (var i = 0; i < parcels.length; i++) {
                var p = parcels[i];
                result.push({
                    'КН': p.getAttribute('CadastralNumber') || getText(p, 'CadastralNumber'),
                    'Площадь': getText(p, 'Area > Area') || getText(p, 'Area'),
                    'Квартал': getText(p, 'CadastralBlock')
                });
            }
            return result.filter(function(r) { return r['КН']; });
        },
        'Координаты': function() {
            var coords = root.querySelectorAll('NewOrdinate');
            var result = [];
            var max = Math.min(coords.length, 100);
            for (var i = 0; i < max; i++) {
                var c = coords[i];
                result.push({
                    '№': c.getAttribute('NumGeopoint') || '',
                    'X': c.getAttribute('X') || '',
                    'Y': c.getAttribute('Y') || '',
                    'Δ': c.getAttribute('DeltaGeopoint') || ''
                });
            }
            return result.filter(function(r) { return r['X']; });
        },
        'Документы': function() {
            var docs = root.querySelectorAll('Document');
            var result = [];
            for (var i = 0; i < docs.length; i++) {
                var d = docs[i];
                result.push({
                    'Название': getText(d, 'Name'),
                    'Номер': getText(d, 'Number'),
                    'Дата': getText(d, 'Date')
                });
            }
            return result.filter(function(r) { return r['Название']; });
        },
        'Границы': function() {
            var borders = root.querySelectorAll('Border');
            var result = [];
            var max = Math.min(borders.length, 50);
            for (var i = 0; i < max; i++) {
                var b = borders[i];
                result.push({
                    'Т1': b.getAttribute('Point1') || '',
                    'Т2': b.getAttribute('Point2') || '',
                    'Длина': getText(b, 'Length') || getText(b, 'Edge > Length')
                });
            }
            return result.filter(function(r) { return r['Т1']; });
        },
        'Исполнитель': function() {
            var c = root.querySelector('Contractor');
            if (!c) return [];
            var fio = [getText(c, 'FamilyName'), getText(c, 'FirstName'), getText(c, 'Patronymic')].filter(Boolean).join(' ');
            return fio ? [{ 'ФИО': fio, 'Тел': getText(c, 'Telephone'), 'Email': getText(c, 'Email') }] : [];
        }
    };
    
    for (var name in extractors) {
        var data = extractors[name]();
        if (data.length === 0) continue;
        
        html += '<div class="summary-section">';
        html += '<div class="summary-section-header"><span><i class="fa-solid fa-folder-open"></i>' + name + ' (' + data.length + ')</span><i class="fa-solid fa-chevron-down toggle-icon"></i></div>';
        html += '<div class="summary-section-body" style="overflow-x:auto;">' + renderMiniTable(data) + '</div>';
        html += '</div>';
    }
    
    // Все значения
    var allValues = [];
    function extractValues(node, path) {
        if (node.nodeType !== 1) return;
        var p = path ? path + '/' + node.nodeName : node.nodeName;
        
        for (var i = 0; i < node.attributes.length; i++) {
            allValues.push({ path: p + '/@' + node.attributes[i].name, value: node.attributes[i].value });
        }
        
        var text = '';
        for (var j = 0; j < node.childNodes.length; j++) {
            if (node.childNodes[j].nodeType === 3) text += node.childNodes[j].textContent;
        }
        text = text.trim();
        if (text) allValues.push({ path: p, value: text });
        
        for (var k = 0; k < node.children.length; k++) {
            extractValues(node.children[k], p);
        }
    }
    extractValues(root, '');
    
    if (allValues.length > 0) {
        html += '<div class="summary-section collapsed">';
        html += '<div class="summary-section-header"><span><i class="fa-solid fa-key"></i>Все значения (' + allValues.length + ')</span><i class="fa-solid fa-chevron-down toggle-icon"></i></div>';
        html += '<div class="summary-section-body" style="max-height:400px;overflow-y:auto;">';
        
        var max = Math.min(allValues.length, 500);
        for (var v = 0; v < max; v++) {
            var item = allValues[v];
            var displayValue = item.value.length > 150 ? item.value.substring(0, 150) + '...' : item.value;
            html += '<div class="summary-row">';
            html += '<div class="summary-label">' + escapeHtml(item.path) + '</div>';
            html += '<div class="summary-value copyable">' + escapeHtml(displayValue) + '</div>';
            html += '</div>';
        }
        
        html += '</div></div>';
    }
    
    return html;
}

function getText(parent, selector) {
    var el = parent.querySelector(selector);
    return el ? el.textContent.trim() : '';
}

function buildJSONSummary(obj) {
    var isArr = Array.isArray(obj);
    var keys = isArr ? obj.length : Object.keys(obj).length;
    
    var html = '<div class="summary-section">';
    html += '<div class="summary-section-header"><span><i class="fa-solid fa-chart-simple"></i>Статистика</span><i class="fa-solid fa-chevron-down toggle-icon"></i></div>';
    html += '<div class="summary-section-body"><div class="summary-grid">';
    html += '<div class="summary-card"><div class="summary-card-title">Тип</div><div class="summary-card-value">' + (isArr ? 'Массив' : 'Объект') + '</div></div>';
    html += '<div class="summary-card"><div class="summary-card-title">Элементов</div><div class="summary-card-value large">' + keys + '</div></div>';
    html += '</div></div></div>';
    
    if (!isArr) {
        html += '<div class="summary-section">';
        html += '<div class="summary-section-header"><span><i class="fa-solid fa-key"></i>Ключи (' + Object.keys(obj).length + ')</span><i class="fa-solid fa-chevron-down toggle-icon"></i></div>';
        html += '<div class="summary-section-body">';
        
        for (var k in obj) {
            var val = obj[k];
            var type = Array.isArray(val) ? 'Array[' + val.length + ']' : typeof val;
            var preview = typeof val === 'string' ? val.substring(0, 80) : (typeof val === 'object' ? '{...}' : String(val));
            
            html += '<div class="summary-row">';
            html += '<div class="summary-label">' + escapeHtml(k) + ' <span class="summary-badge">' + type + '</span></div>';
            html += '<div class="summary-value copyable">' + escapeHtml(preview) + '</div>';
            html += '</div>';
        }
        
        html += '</div></div>';
    }
    
    return html;
}

function renderMiniTable(data) {
    if (!data || data.length === 0) return '';
    var headers = Object.keys(data[0]);
    
    var html = '<table class="data-table" style="font-size:12px;"><thead><tr>';
    for (var i = 0; i < headers.length; i++) {
        html += '<th>' + escapeHtml(headers[i]) + '</th>';
    }
    html += '</tr></thead><tbody>';
    
    for (var j = 0; j < data.length; j++) {
        html += '<tr>';
        for (var k = 0; k < headers.length; k++) {
            var val = String(data[j][headers[k]] || '');
            var display = val.length > 40 ? val.substring(0, 40) + '...' : val;
            html += '<td title="' + escapeHtml(val) + '">' + escapeHtml(display) + '</td>';
        }
        html += '</tr>';
    }
    
    return html + '</tbody></table>';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() { showToast('Скопировано'); });
}

// =============== EXPORT ===============

function exportData(format) {
    var data = allTableData[currentTableKey];
    if (!data || data.length === 0) {
        showToast('Выберите данные в таблице');
        return;
    }
    closeModal('modal-export');
    
    if (format === 'csv') exportCSV(data);
    else if (format === 'xlsx') exportXLSX(data);
    else if (format === 'docx') exportDOCX(data);
    else if (format === 'json') exportJSON(data);
}

function exportCSV(data) {
    var headers = Object.keys(data[0]);
    var csv = headers.map(function(h) { return '"' + h.replace(/"/g, '""') + '"'; }).join(',') + '\n';
    for (var i = 0; i < data.length; i++) {
        var row = headers.map(function(h) { return '"' + String(data[i][h] || '').replace(/"/g, '""') + '"'; });
        csv += row.join(',') + '\n';
    }
    downloadFile(csv, currentFileName + '_' + currentTableKey + '.csv', 'text/csv;charset=utf-8');
    showToast('CSV экспортирован');
}

function exportXLSX(data) {
    var ws = XLSX.utils.json_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, currentTableKey.substring(0, 31));
    XLSX.writeFile(wb, currentFileName + '_' + currentTableKey + '.xlsx');
    showToast('XLSX экспортирован');
}

function exportDOCX(data) {
    var headers = Object.keys(data[0]);
    var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word"><head><meta charset="utf-8"></head><body>';
    html += '<h1>' + currentFileName + ' - ' + currentTableKey + '</h1>';
    html += '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;">';
    html += '<thead style="background-color:#2563eb;color:white;"><tr>';
    for (var i = 0; i < headers.length; i++) {
        html += '<th>' + escapeHtml(headers[i]) + '</th>';
    }
    html += '</tr></thead><tbody>';
    for (var j = 0; j < data.length; j++) {
        html += '<tr style="background-color:' + (j % 2 === 0 ? '#fff' : '#f0f7ff') + '">';
        for (var k = 0; k < headers.length; k++) {
            html += '<td>' + escapeHtml(String(data[j][headers[k]] || '')) + '</td>';
        }
        html += '</tr>';
    }
    html += '</tbody></table></body></html>';
    downloadFile(new Blob([html], { type: 'application/msword' }), currentFileName + '_' + currentTableKey + '.doc', 'application/msword');
    showToast('DOC экспортирован');
}

function exportJSON(data) {
    downloadFile(JSON.stringify(data, null, 2), currentFileName + '_' + currentTableKey + '.json', 'application/json');
    showToast('JSON экспортирован');
}

function downloadFile(content, filename, mimeType) {
    var blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function saveToFile() {
    var content = editor.getValue();
    var ext = detectedType === 'json' ? 'json' : detectedType === 'xml' ? 'xml' : 'txt';
    downloadFile(content, currentFileName + '.' + ext, 'text/plain;charset=utf-8');
    showToast('Файл сохранён');
}

// =============== IndexedDB ===============

function saveToIndexedDB() {
    var name = prompt('Имя файла:', currentFileName);
    if (!name) return;
    var transaction = db.transaction(['files'], 'readwrite');
    transaction.objectStore('files').put({ id: name, content: editor.getValue(), type: detectedType, date: new Date().toISOString() });
    transaction.oncomplete = function() { showToast('Сохранено: ' + name); loadDBList(); };
}

function loadDBList() {
    var container = document.getElementById('db-list');
    if (!db) { container.innerHTML = '<p>БД не инициализирована</p>'; return; }
    var request = db.transaction(['files'], 'readonly').objectStore('files').getAll();
    request.onsuccess = function() {
        var files = request.result;
        if (files.length === 0) { container.innerHTML = '<p style="color:var(--text-muted);text-align:center;">Нет файлов</p>'; return; }
        var html = '';
        for (var i = 0; i < files.length; i++) {
            var f = files[i];
            html += '<div class="db-item"><span class="db-item-name">' + escapeHtml(f.id) + '</span>';
            html += '<div class="db-item-actions">';
            html += '<button class="db-item-btn load" data-id="' + escapeHtml(f.id) + '"><i class="fa-solid fa-download"></i></button>';
            html += '<button class="db-item-btn delete" data-id="' + escapeHtml(f.id) + '"><i class="fa-solid fa-trash"></i></button>';
            html += '</div></div>';
        }
        container.innerHTML = html;
        
        container.querySelectorAll('.db-item-btn.load').forEach(function(btn) {
            btn.addEventListener('click', function() { loadFromDB(this.dataset.id); });
        });
        container.querySelectorAll('.db-item-btn.delete').forEach(function(btn) {
            btn.addEventListener('click', function() { deleteFromDB(this.dataset.id); });
        });
    };
}

function loadFromDB(id) {
    var request = db.transaction(['files'], 'readonly').objectStore('files').get(id);
    request.onsuccess = function() {
        if (request.result) {
            currentFileName = id;
            processContent(request.result.content);
            closeModal('modal-db');
            showToast('Загружено');
        }
    };
}

function deleteFromDB(id) {
    if (!confirm('Удалить "' + id + '"?')) return;
    var transaction = db.transaction(['files'], 'readwrite');
    transaction.objectStore('files').delete(id);
    transaction.oncomplete = function() { showToast('Удалено'); loadDBList(); };
}

// =============== Search & Filter ===============

function searchText(forward) {
    var query = document.getElementById('search-input').value;
    if (!query) return;
    if (!searchCursor || lastSearchQuery !== query) {
        searchCursor = editor.getSearchCursor(query, null, { caseFold: true });
        lastSearchQuery = query;
    }
    var found = forward ? searchCursor.findNext() : searchCursor.findPrevious();
    if (!found) {
        searchCursor = editor.getSearchCursor(query, null, { caseFold: true });
        forward ? searchCursor.findNext() : searchCursor.findPrevious();
    }
    if (searchCursor.from()) {
        editor.setSelection(searchCursor.from(), searchCursor.to());
        editor.scrollIntoView({ from: searchCursor.from(), to: searchCursor.to() }, 100);
    }
}

function toggleFilter() {
    var btn = document.getElementById('btn-filter');
    var query = document.getElementById('search-input').value.trim().toLowerCase();
    if (isFiltered || !query) {
        editor.setValue(allLines.join('\n'));
        btn.style.background = 'var(--warning-color)';
        isFiltered = false;
        return;
    }
    var terms = query.split(/\s+/);
    var filtered = allLines.filter(function(line) {
        var lower = line.toLowerCase();
        for (var i = 0; i < terms.length; i++) {
            if (lower.indexOf(terms[i]) === -1) return false;
        }
        return true;
    });
    if (filtered.length === 0) { showToast('Не найдено'); return; }
    editor.setValue(filtered.join('\n'));
    btn.style.background = 'var(--danger-color)';
    isFiltered = true;
    showToast('Найдено: ' + filtered.length);
}

// =============== UI ===============

function switchTab(tabId) {
    document.querySelectorAll('.editor-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.querySelector('.editor-tab[data-tab="' + tabId + '"]').classList.add('active');
    document.getElementById('tab-' + tabId).classList.add('active');
    
    if (tabId === 'structure') updateStructureTree();
    if (tabId === 'table') updateTableView();
    if (tabId === 'summary') updateSummaryView();
    if (tabId === 'editor') setTimeout(function() { editor.refresh(); }, 10);
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function updateStatusBar(file, name, size) {
    var content = editor.getValue();
    document.getElementById('status-file').textContent = name || (file && file.name) || currentFileName || 'Нет файла';
    var sizeKB = size ? size / 1024 : (file ? file.size / 1024 : new Blob([content]).size / 1024);
    document.getElementById('status-size').textContent = sizeKB.toFixed(2) + ' КБ';
    document.getElementById('status-chars').textContent = content.length + ' симв.';
    document.getElementById('status-lines').textContent = content.split('\n').length + ' строк';
}

function updateThemeColors(theme) {
    var dark = theme === 'dracula' || theme === 'monokai' || theme === 'material';
    if (dark) document.body.classList.add('theme-dark');
    else document.body.classList.remove('theme-dark');
}

function saveSettings() {
    var darkMode = document.getElementById('setting-dark-mode').checked;
    localStorage.setItem('darkMode', darkMode);
    if (darkMode) document.body.classList.add('theme-dark');
    else document.body.classList.remove('theme-dark');
    closeModal('modal-settings');
    showToast('Сохранено');
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message) {
    var toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(function() { toast.classList.remove('show'); }, 2000);
}
    </script>
</body>
</html>
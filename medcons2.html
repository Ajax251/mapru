<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–¥–ü–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="https://vsemap.ru/img/med.png" type="image/png">
<style>
:root {
    --bg-gradient: linear-gradient(145deg, #ffffff 0%, #f0f7ff 50%, #e8f2ff 100%);
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f7ff;
    --bg-frost: rgba(255, 255, 255, 0.98);
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #94a3b8;
    --accent-color: #2563eb;
    --accent-hover: #1d4ed8;
    --accent-light: #e0eaff;
    --accent-gradient: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
    --border-color: #c7d9f1;
    --border-light: #a8c5e8;
    --shadow-soft: 0 2px 8px rgba(37, 99, 235, 0.06);
    --shadow-card: 0 4px 16px rgba(37, 99, 235, 0.08);
    --shadow-hover: 0 8px 24px rgba(37, 99, 235, 0.12);
    --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);
    --success-color: #059669;
    --warning-color: #d97706;
    --danger-color: #dc2626;
    --info-color: #2563eb;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    height: 100%;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.6;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

.app-container {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    height: 100dvh;
    margin: 0 auto;
    background: var(--bg-frost);
    box-shadow: var(--shadow-card);
}

.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: #ffffff;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    gap: 12px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-color);
}

.header-logo i { font-size: 22px; }

.mode-selector-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
    min-width: 180px;
}

.mode-selector-btn:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
    box-shadow: var(--shadow-hover);
}

.mode-selector-btn .mode-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
}

.mode-selector-btn .mode-name {
    flex: 1;
    text-align: left;
}

.mode-selector-btn .chevron {
    color: var(--text-muted);
    font-size: 12px;
    transition: transform 0.2s;
}

.mode-selector-btn:hover .chevron { color: var(--accent-color); }

.mode-selector-btn.is-loading .mode-icon::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    background: var(--warning-color);
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse 1.5s infinite;
}

.mode-selector-btn .mode-icon { position: relative; }

@keyframes pulse { 
    0%, 100% { transform: scale(0.9); opacity: 0.9; } 
    50% { transform: scale(1.2); opacity: 1; } 
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 40px;
    padding: 0 14px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    gap: 8px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.header-btn:hover {
    background: var(--accent-light);
    color: var(--accent-color);
    border-color: var(--accent-color);
}

.header-btn.icon-only { width: 40px; padding: 0; }
.header-btn i { font-size: 14px; }

.response-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.response-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    flex-shrink: 0;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    color: white;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.action-btn:hover { box-shadow: var(--shadow-hover); }
.action-btn i { font-size: 13px; }

#copy-btn { background: var(--accent-gradient); }
#export-btn { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
#print-btn { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
#new-chat-btn { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); margin-left: auto; }

.response-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: var(--bg-secondary);
}

.response-wrapper::-webkit-scrollbar { width: 6px; }
.response-wrapper::-webkit-scrollbar-track { background: var(--bg-tertiary); }
.response-wrapper::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
.response-wrapper::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

.welcome-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
}

.welcome-icon {
    width: 88px;
    height: 88px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-card);
}

.welcome-icon i { font-size: 38px; color: white; }

.welcome-message h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
}

.welcome-message p {
    font-size: 15px;
    max-width: 480px;
    line-height: 1.7;
    color: var(--text-secondary);
}

.welcome-message p em {
    color: var(--text-muted);
    font-size: 14px;
    font-style: normal;
    display: block;
    margin-top: 12px;
}

#ai-response { 
    font-size: 15px; 
    line-height: 1.8; 
    color: var(--text-primary); 
}

#ai-response h2, #ai-response h3 { 
    color: var(--text-primary); 
    font-weight: 700; 
    margin: 28px 0 16px 0; 
    padding-bottom: 10px; 
    border-bottom: 2px solid var(--border-color); 
}

#ai-response h2 { 
    font-size: 20px; 
    text-align: center; 
    border-color: var(--accent-color); 
}

#ai-response h3 { font-size: 17px; }
#ai-response h3 i { margin-right: 10px; color: var(--accent-color); }
#ai-response p { margin: 14px 0; color: var(--text-primary); }
#ai-response ul, #ai-response ol { padding-left: 24px; margin: 14px 0; }
#ai-response li { margin: 8px 0; color: var(--text-primary); }
#ai-response strong { color: var(--accent-hover); font-weight: 600; }
#ai-response hr { border: none; height: 1px; background: var(--border-color); margin: 28px 0; }

#ai-response table {
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0; 
    margin: 20px 0;
    background: var(--bg-secondary); 
    border-radius: 10px; 
    overflow: hidden;
    box-shadow: var(--shadow-soft); 
    border: 1px solid var(--border-color);
}

#ai-response thead { background: var(--accent-gradient); }
#ai-response th { 
    padding: 12px 16px; 
    text-align: left; 
    font-weight: 600; 
    color: white; 
    font-size: 13px; 
}

#ai-response td { 
    padding: 12px 16px; 
    border-bottom: 1px solid var(--border-color); 
    color: var(--text-primary);
}

#ai-response tbody tr:last-child td { border-bottom: none; }
#ai-response tbody tr:nth-child(even) { background: var(--bg-tertiary); }
#ai-response tbody tr:hover { background: var(--accent-light); }

#ai-response .disclaimer {
    display: block;
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 14px 18px;
    border-radius: 10px;
    margin-top: 24px;
    font-weight: 500;
    font-size: 14px;
    line-height: 1.6;
}

#ai-response .disclaimer i { margin-right: 10px; }

#ai-response a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 500;
}

#ai-response a:hover { text-decoration: underline; }

.loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    gap: 16px;
}

.lds-heart {
    display: inline-block;
    position: relative;
    width: 72px;
    height: 72px;
    transform: rotate(45deg);
    transform-origin: 36px 36px;
}

.lds-heart div {
    top: 28px;
    left: 28px;
    position: absolute;
    width: 28px;
    height: 28px;
    background: var(--accent-color);
    animation: lds-heart 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
}

.lds-heart div:after,
.lds-heart div:before {
    content: " ";
    position: absolute;
    display: block;
    width: 28px;
    height: 28px;
    background: var(--accent-color);
}

.lds-heart div:before { left: -21px; border-radius: 50% 0 0 50%; }
.lds-heart div:after { top: -21px; border-radius: 50% 50% 0 0; }

@keyframes lds-heart {
    0% { transform: scale(0.95); }
    5% { transform: scale(1.1); }
    39% { transform: scale(0.85); }
    45% { transform: scale(1); }
    60% { transform: scale(0.95); }
    100% { transform: scale(0.9); }
}

.loader p { color: var(--text-secondary); font-size: 15px; line-height: 1.6; }

#cancel-btn {
    padding: 10px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

#cancel-btn:hover { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color); 
}

.input-panel {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    background: #ffffff;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

#user-query {
    flex: 1;
    padding: 14px 18px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: inherit;
    resize: none;
    min-height: 48px;
    max-height: 150px;
    line-height: 1.5;
    transition: all 0.2s ease;
}

#user-query:focus { 
    outline: none; 
    border-color: var(--accent-color); 
    background: var(--bg-secondary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

#user-query::placeholder { color: var(--text-muted); }

#send-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    background: var(--accent-gradient);
    color: white;
    font-size: 18px;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
}

#send-btn:hover { 
    transform: scale(1.05); 
    box-shadow: var(--shadow-hover); 
}

#send-btn:disabled, #user-query:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

.status-bar {
    padding: 8px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    text-align: center;
    flex-shrink: 0;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.15);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}

.modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
    margin: 0;
}

.modal-header h2 i { color: var(--accent-color); }

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.modal-close:hover { 
    background: var(--danger-color); 
    color: white; 
    border-color: var(--danger-color); 
}

.modal-body { padding: 20px; overflow-y: auto; flex: 1; }

.mode-modal { max-width: 580px; }

.mode-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.mode-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.mode-option:hover {
    border-color: var(--accent-color);
    background: var(--accent-light);
}

.mode-option.selected {
    border-color: var(--accent-color);
    border-width: 2px;
    background: var(--accent-light);
}

.mode-option .mode-opt-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-size: 18px;
    color: white;
    flex-shrink: 0;
}

.mode-option .mode-opt-info { flex: 1; }

.mode-option .mode-opt-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.mode-option .mode-opt-desc {
    font-size: 12px;
    color: var(--text-secondary);
}

.settings-group { margin-bottom: 20px; }

.settings-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.settings-group select,
.settings-group input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
}

.settings-group select:focus,
.settings-group input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.settings-group small { 
    display: block; 
    margin-top: 8px; 
    font-size: 12px; 
    color: var(--text-muted); 
}

.settings-group small a { 
    color: var(--accent-color); 
    text-decoration: none; 
    font-weight: 500; 
}

.api-mode-options { display: flex; flex-direction: column; gap: 8px; }

.api-mode-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.api-mode-option:hover { 
    border-color: var(--accent-color); 
    background: var(--accent-light); 
}

.api-mode-option.selected { 
    border-color: var(--accent-color); 
    border-width: 2px;
    background: var(--accent-light); 
}

.api-mode-option i { 
    font-size: 16px; 
    color: var(--accent-color); 
    width: 20px; 
    text-align: center; 
}

.api-mode-option span { 
    font-size: 14px; 
    font-weight: 500; 
    color: var(--text-primary); 
}

.save-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent-gradient);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: var(--shadow-soft);
    transition: all 0.2s ease;
}

.save-btn:hover { 
    box-shadow: var(--shadow-hover); 
}

.history-list { 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
    max-height: 400px; 
    overflow-y: auto; 
}

.history-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover { 
    background: var(--accent-light); 
    border-color: var(--accent-color); 
}

.history-item-text { 
    font-size: 14px; 
    color: var(--text-primary); 
    flex: 1; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
}

.history-item-delete {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.history-item-delete:hover { 
    background: var(--danger-color); 
    color: white; 
}

.history-empty { 
    text-align: center; 
    padding: 40px 20px; 
    color: var(--text-muted); 
}

.history-empty i { 
    font-size: 36px; 
    margin-bottom: 12px; 
    display: block;
}

@media print {
    .app-header, .input-panel, .response-actions, .status-bar { display: none !important; }
    body, .app-container { background: white !important; height: auto !important; }
    .response-area, .response-wrapper { overflow: visible !important; height: auto !important; }
}

@media (max-width: 768px) {
    .app-header { padding: 10px 14px; flex-wrap: wrap; }
    .header-logo span { display: none; }
    .mode-selector-btn { min-width: auto; padding: 8px 12px; }
    .mode-selector-btn .mode-name { display: none; }
    .mode-selector-btn .mode-icon { width: 28px; height: 28px; font-size: 12px; }
    .header-btn span { display: none; }
    .response-wrapper { padding: 16px; }
    .response-actions { gap: 6px; padding: 10px 14px; }
    .action-btn { padding: 6px 10px; font-size: 12px; }
    .action-btn span { display: none; }
    .input-panel { padding: 12px 14px; }
    #user-query { padding: 12px 16px; font-size: 14px; }
    #send-btn { width: 44px; height: 44px; }
    .mode-grid { grid-template-columns: 1fr; }
    .modal-content { max-width: 100%; }
}
</style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="header-left">
            <div class="header-logo">
                <i class="fa-solid fa-heart-pulse"></i>
                <span>–ú–µ–¥–ü–æ–º–æ—â–Ω–∏–∫</span>
            </div>
            <button class="mode-selector-btn" id="mode-selector-btn">
                <div class="mode-icon" id="current-mode-icon"><i class="fa-solid fa-stethoscope"></i></div>
                <span class="mode-name" id="current-mode-name">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</span>
                <i class="fa-solid fa-chevron-down chevron"></i>
            </button>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="history-btn" title="–ò—Å—Ç–æ—Ä–∏—è">
                <i class="fa-solid fa-clock-rotate-left"></i>
                <span>–ò—Å—Ç–æ—Ä–∏—è</span>
            </button>
            <button class="header-btn icon-only" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <main class="response-area">
        <div class="response-actions" id="response-actions">
            <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i><span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span></button>
            <button class="action-btn" id="export-btn"><i class="fa-solid fa-file-export"></i><span>–≠–∫—Å–ø–æ—Ä—Ç HTML</span></button>
            <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i><span>–ü–µ—á–∞—Ç—å</span></button>
            <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus"></i><span>–ù–æ–≤—ã–π —á–∞—Ç</span></button>
        </div>
        <div class="response-wrapper" id="response-wrapper">
            <div id="ai-response"></div>
        </div>
    </main>

    <div class="input-panel">
        <textarea id="user-query" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." rows="1"></textarea>
        <button id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div class="status-bar" id="status-bar">Gemini 3 Flash ‚Ä¢ –ü—Ä–æ–∫—Å–∏ MapRuApp</div>
</div>

<div id="mode-modal" class="modal-overlay">
    <div class="modal-content mode-modal">
        <div class="modal-header">
            <h2><i class="fa-solid fa-grid-2"></i> –í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞</h2>
            <button class="modal-close" id="close-mode-modal"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="mode-grid" id="mode-grid"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="modal-close" id="close-settings"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="settings-group">
                <label>–ú–æ–¥–µ–ª—å –ò–ò</label>
                <select id="model-selector"></select>
            </div>
            <div class="settings-group">
                <label>–†–µ–∂–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                <div class="api-mode-options" id="api-mode-options"></div>
            </div>
            <div class="settings-group" id="api-key-group" style="display:none;">
                <label>API –∫–ª—é—á Gemini</label>
                <input type="password" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á...">
                <small>–ü–æ–ª—É—á–∏—Ç—å: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
            </div>
            <button class="save-btn" id="save-settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="history-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
            <button class="modal-close" id="close-history"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="history-list" id="history-list"></div>
        </div>
    </div>
</div>

<script>
const AI_SYSTEM_PROMPT_SYMPTOMS = `–¢—ã ‚Äî "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ó–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∑–∞–ø—Ä–æ—Å–∞–º, –ø–æ–º–æ–≥–∞—è –ø–æ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –≤—Ä–∞—á—É.

### –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. **–ù–ï –°–¢–ê–í–¨ –î–ò–ê–ì–ù–û–ó** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π "–≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã", "–º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞"
2. **–ù–ï –ù–ê–ó–ù–ê–ß–ê–ô –õ–ï–ö–ê–†–°–¢–í–ê** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –∏ –¥–æ–∑–∏—Ä–æ–≤–æ–∫
3. **–≠–ö–°–¢–†–ï–ù–ù–´–ï –°–õ–£–ß–ê–ò** ‚Äî –ø—Ä–∏ —É–≥—Ä–æ–∑–µ –∂–∏–∑–Ω–∏ (–∏–Ω—Ñ–∞—Ä–∫—Ç, –∏–Ω—Å—É–ª—å—Ç, –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ) –°–†–ê–ó–£ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –≤—ã–∑–≤–∞—Ç—å 103/112
4. **–¢–æ–ª—å–∫–æ –º–µ–¥–∏—Ü–∏–Ω–∞** ‚Äî –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∑—ã–≤–∞–π
5. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞** ‚Äî —É—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

### üîç 1. –ê–Ω–∞–ª–∏–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤
–ö—Ä–∞—Ç–∫–æ –∏–∑–ª–æ–∂–∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –ü—Ä–∏ –Ω–µ—è—Å–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞–π 2-3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞.

---

### ü©∫ 2. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

| –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–∏–º–ø—Ç–æ–º–∞–º |
|-------------------|----------|------------------------|
| [–°–æ—Å—Ç–æ—è–Ω–∏–µ] | [–ö–∞–∫ —Å–æ–æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Å —Å–∏–º–ø—Ç–æ–º–∞–º–∏] | –í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è |

*–≠—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –¥–∏–∞–≥–Ω–æ–∑.*

---

### üíä 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
* **–û–±—â–∏–µ:** —Ä–µ–∂–∏–º, –ø–∏—Ç—å—ë, –¥–∏–µ—Ç–∞
* **–°–∞–º–æ–ø–æ–º–æ—â—å:** –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ä—ã –¥–æ –≤—Ä–∞—á–∞
* **–ö –∫–∞–∫–æ–º—É –≤—Ä–∞—á—É:** –ø—Ä–æ—Ñ–∏–ª—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞

---

### üö® 4. –ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏
–°–∏–º–ø—Ç–æ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô –ø–æ–º–æ—â–∏.

---

### üìö 5. –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞
–°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é.

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ò–ò –≤ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö. –î–ª—è –¥–∏–∞–≥–Ω–æ–∑–∞ –∏ –ª–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.`;

const AI_SYSTEM_PROMPT_MEDS = `–¢—ã ‚Äî "–§–∞—Ä–º—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫", —Ç–æ—á–Ω—ã–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º. –ó–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞—Ö.

### –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. **–¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã** ‚Äî –±–µ–∑ —Å–æ–≤–µ—Ç–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
2. **–ù–ï –ù–ê–ó–ù–ê–ß–ê–ô –õ–ï–ß–ï–ù–ò–ï** ‚Äî —Ç—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫, –Ω–µ –≤—Ä–∞—á
3. **–î–æ–∑–∏—Ä–æ–≤–∫–∏** ‚Äî –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π "—Å—Ç—Ä–æ–≥–æ –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é –≤—Ä–∞—á–∞"

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –°–ø—Ä–∞–≤–∫–∞: [–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞]

### üìã 1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è |
|----------|------------|
| **–î–µ–π—Å—Ç–≤—É—é—â–µ–µ –≤–µ—â–µ—Å—Ç–≤–æ** | [–ù–∞–∑–≤–∞–Ω–∏–µ] |
| **–§–∞—Ä–º–≥—Ä—É–ø–ø–∞** | [–ì—Ä—É–ø–ø–∞] |
| **–§–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞** | [–¢–∞–±–ª–µ—Ç–∫–∏, —Ä–∞—Å—Ç–≤–æ—Ä –∏ —Ç.–¥.] |
| **–ú–µ—Ö–∞–Ω–∏–∑–º –¥–µ–π—Å—Ç–≤–∏—è** | [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç] |

---

### ‚úÖ 2. –ü–æ–∫–∞–∑–∞–Ω–∏—è
* [–ü–æ–∫–∞–∑–∞–Ω–∏–µ 1]
* [–ü–æ–∫–∞–∑–∞–Ω–∏–µ 2]

---

### üíâ 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–æ—Å–æ–±–µ –ø—Ä–∏—ë–º–∞.
**–î–æ–∑–∏—Ä–æ–≤–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤—Ä–∞—á–æ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ!**

---

### ‚ö†Ô∏è 4. –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è –∏ –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
* **–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è:** [—Å–ø–∏—Å–æ–∫]
* **–ß–∞—Å—Ç—ã–µ –ø–æ–±–æ—á–Ω—ã–µ:** [—Å–ø–∏—Å–æ–∫]

---

### üîÑ 5. –ê–Ω–∞–ª–æ–≥–∏

| –¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å |
|-------------------|---------------|
| [–ê–Ω–∞–ª–æ–≥ 1] | [–°—Ç—Ä–∞–Ω–∞] |
| [–ê–Ω–∞–ª–æ–≥ 2] | [–°—Ç—Ä–∞–Ω–∞] |

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è. –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤—Ä–∞—á–∞. –°–∞–º–æ–ª–µ—á–µ–Ω–∏–µ –æ–ø–∞—Å–Ω–æ!`;

const AI_SYSTEM_PROMPT_SUBSTANCES = `–¢—ã ‚Äî "–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥", –Ω–∞—É—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –≤–∏—Ç–∞–º–∏–Ω–∞–º, –º–∏–Ω–µ—Ä–∞–ª–∞–º –∏ –±–∏–æ–∞–∫—Ç–∏–≤–Ω—ã–º –≤–µ—â–µ—Å—Ç–≤–∞–º.

### –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. **–ù–∞—É—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. **–ù–ï –õ–ï–ß–ï–ù–ò–ï** ‚Äî –æ–ø–∏—Å—ã–≤–∞–µ—à—å —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é —Ä–æ–ª—å, –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—à—å
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–æ–º –ë–ê–î

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –ê–Ω–∞–ª–∏–∑: [–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞]

### üß¨ 1. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| **–¢–∏–ø** | [–í–∏—Ç–∞–º–∏–Ω/–º–∏–Ω–µ—Ä–∞–ª/–∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–∞] |
| **–§–æ—Ä–º—É–ª–∞** | [–•–∏–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞] |
| **–†–æ–ª—å –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ** | [–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è] |

---

### üí™ 2. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è
* **–§—É–Ω–∫—Ü–∏—è 1:** [–æ–ø–∏—Å–∞–Ω–∏–µ]
* **–§—É–Ω–∫—Ü–∏—è 2:** [–æ–ø–∏—Å–∞–Ω–∏–µ]

---

### üìä 3. –°—É—Ç–æ—á–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ù–æ—Ä–º–∞ |
|-----------|-------|
| –í–∑—Ä–æ—Å–ª—ã–µ –º—É–∂—á–∏–Ω—ã | [–∑–Ω–∞—á–µ–Ω–∏–µ] |
| –í–∑—Ä–æ—Å–ª—ã–µ –∂–µ–Ω—â–∏–Ω—ã | [–∑–Ω–∞—á–µ–Ω–∏–µ] |
| –ë–µ—Ä–µ–º–µ–Ω–Ω—ã–µ | [–∑–Ω–∞—á–µ–Ω–∏–µ] |

*–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.*

**–ü–∏—â–µ–≤—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:**
* [–ü—Ä–æ–¥—É–∫—Ç 1]
* [–ü—Ä–æ–¥—É–∫—Ç 2]

---

### ‚öñÔ∏è 4. –î–µ—Ñ–∏—Ü–∏—Ç –∏ –∏–∑–±—ã—Ç–æ–∫

| | –°–∏–º–ø—Ç–æ–º—ã | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è |
|---|----------|-------------|
| **–î–µ—Ñ–∏—Ü–∏—Ç** | [—Å–ø–∏—Å–æ–∫] | [—Å–ø–∏—Å–æ–∫] |
| **–ò–∑–±—ã—Ç–æ–∫** | [—Å–ø–∏—Å–æ–∫] | [—Å–ø–∏—Å–æ–∫] |

---

### üíä 5. –ü—Ä–∏—ë–º –≤ –≤–∏–¥–µ –ë–ê–î
* **–ö–æ–≥–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–∂–µ–Ω:** [—Å–∏—Ç—É–∞—Ü–∏–∏]
* **–†–∏—Å–∫–∏:** [–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è]
* **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:** [—Å —á–µ–º –Ω–µ —Å–æ—á–µ—Ç–∞–µ—Ç—Å—è]

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è. –ü–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–æ–º –ë–ê–î –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.`;

const AI_SYSTEM_PROMPT_LIFESTYLE = `–¢—ã ‚Äî "Wellness-–∫–æ—É—á", –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Å–æ–≤–µ—Ç–Ω–∏–∫ –ø–æ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏, –ø–∏—Ç–∞–Ω–∏—é –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

### –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. **–ù–ï –í–†–ê–ß** ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë—à—å –ª–µ—á–µ–±–Ω—ã–µ –¥–∏–µ—Ç—ã, –Ω–µ —Ä–µ–∞–±–∏–ª–∏—Ç–∏—Ä—É–µ—à—å –ø–æ—Å–ª–µ —Ç—Ä–∞–≤–º
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø—Ä–æ–≥—Ä–∞–º–º
3. **–ü—Ä–∏–Ω—Ü–∏–ø –ø—Ä–∏–º–µ—Ä–∞** ‚Äî –ø–ª–∞–Ω—ã –ø–æ–¥–∞—é—Ç—Å—è –∫–∞–∫ —à–∞–±–ª–æ–Ω—ã, –Ω–µ —Å—Ç—Ä–æ–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
4. **–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: [–¶–µ–ª—å]

### üéØ 1. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
* **–ü—Ä–∏–Ω—Ü–∏–ø 1:** [–æ–ø–∏—Å–∞–Ω–∏–µ]
* **–ü—Ä–∏–Ω—Ü–∏–ø 2:** [–æ–ø–∏—Å–∞–Ω–∏–µ]

---

### üìã 2. –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ø–ª–∞–Ω

**–ï—Å–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî –º–µ–Ω—é –Ω–∞ –¥–µ–Ω—å:**

| –ü—Ä–∏—ë–º –ø–∏—â–∏ | –ü—Ä–∏–º–µ—Ä –±–ª—é–¥–∞ | –ü–æ–ª—å–∑–∞ |
|------------|--------------|--------|
| –ó–∞–≤—Ç—Ä–∞–∫ | [–±–ª—é–¥–æ] | [–ø–æ—á–µ–º—É –ø–æ–ª–µ–∑–Ω–æ] |
| –û–±–µ–¥ | [–±–ª—é–¥–æ] | [–ø–æ—á–µ–º—É –ø–æ–ª–µ–∑–Ω–æ] |
| –£–∂–∏–Ω | [–±–ª—é–¥–æ] | [–ø–æ—á–µ–º—É –ø–æ–ª–µ–∑–Ω–æ] |

**–ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:**
1. **[–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ]:** —Ü–µ–ª—å, —Ç–µ—Ö–Ω–∏–∫–∞, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

---

### ‚ùå 3. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
* [–û—à–∏–±–∫–∞ 1] ‚Äî –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å
* [–û—à–∏–±–∫–∞ 2] ‚Äî –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å

---

### üí° 4. –õ–∞–π—Ñ—Ö–∞–∫–∏
* [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç 1]
* [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç 2]

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–µ. –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –¥–∏–µ—Ç–µ –∏–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º.`;

const AI_SYSTEM_PROMPT_ATLAS = `–¢—ã ‚Äî "–ê–Ω–∞—Ç–æ–º", —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –≥–∏–¥ –ø–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º—É —Ç–µ–ª—É. –ó–∞–¥–∞—á–∞ ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ —Å—Ç—Ä–æ–µ–Ω–∏–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è—Ö –æ—Ä–≥–∞–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.

### –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. **–¢–æ–ª—å–∫–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ** ‚Äî –Ω–µ —Å–≤—è–∑—ã–≤–∞–π —Å —Å–∏–º–ø—Ç–æ–º–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ ("–ø–æ—á–∫–∏ ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã", "–º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏–∏ ‚Äî —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏–∏")
3. **–ë–µ–∑ –ª–µ—á–µ–Ω–∏—è** ‚Äî –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –±–æ–ª–µ–∑–Ω–µ–π –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –≤—Ä–∞—á—É

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –ê–Ω–∞—Ç–æ–º–∏—è: [–û—Ä–≥–∞–Ω/—Å–∏—Å—Ç–µ–º–∞]

### üìç 1. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–ª–µ.

---

### üî¨ 2. –°—Ç—Ä–æ–µ–Ω–∏–µ
* **–ß–∞—Å—Ç—å 1:** [–æ–ø–∏—Å–∞–Ω–∏–µ]
* **–ß–∞—Å—Ç—å 2:** [–æ–ø–∏—Å–∞–Ω–∏–µ]

---

### ‚öôÔ∏è 3. –§—É–Ω–∫—Ü–∏–∏
1. **–§—É–Ω–∫—Ü–∏—è 1:** [–æ–ø–∏—Å–∞–Ω–∏–µ —Å –∞–Ω–∞–ª–æ–≥–∏–µ–π]
2. **–§—É–Ω–∫—Ü–∏—è 2:** [–æ–ø–∏—Å–∞–Ω–∏–µ]

---

### üîó 4. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
–ö–∞–∫ —Å–≤—è–∑–∞–Ω —Å –¥—Ä—É–≥–∏–º–∏ –æ—Ä–≥–∞–Ω–∞–º–∏.

---

### üß† –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç
–£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.

---

### üè• –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
–û–±—â–∏–µ –≥—Ä—É–ø–ø—ã –±–æ–ª–µ–∑–Ω–µ–π (–±–µ–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤).
*–î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.*

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è, –Ω–µ –¥–ª—è —Å–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.`;

const AI_SYSTEM_PROMPT_FIRST_AID = `–¢—ã ‚Äî "–°–ø–∞—Å–∞—Ç–µ–ª—å", —á—ë—Ç–∫–∏–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏. –ó–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å —è—Å–Ω—É—é –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.

### –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ù–¶–ò–ü–´:
1. **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨** ‚Äî —Å–Ω–∞—á–∞–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–ø–∞—Å–∞—Ç–µ–ª—è –∏ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ
2. **–°–ö–û–†–ê–Ø –í –ü–ï–†–í–£–Æ –û–ß–ï–†–ï–î–¨** ‚Äî –ø—Ä–∏ —É–≥—Ä–æ–∑–µ –∂–∏–∑–Ω–∏ —Å—Ä–∞–∑—É: "–í–´–ó–û–í–ò–¢–ï 103 –∏–ª–∏ 112"
3. **–ù–∏–∫–∞–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ –ª–µ–∫–∞—Ä—Å—Ç–≤** ‚Äî —Ç–æ–ª—å–∫–æ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏
4. **–ß—ë—Ç–∫–æ—Å—Ç—å** ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏

### –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

## –ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å: [–°–∏—Ç—É–∞—Ü–∏—è]

### üö® 1. –ù–ï–ú–ï–î–õ–ï–ù–ù–û –í–´–ó–û–í–ò–¢–ï 103/112, –ï–°–õ–ò:
* –ß–µ–ª–æ–≤–µ–∫ –±–µ–∑ —Å–æ–∑–Ω–∞–Ω–∏—è –∏–ª–∏ –Ω–µ –¥—ã—à–∏—Ç
* –°–∏–ª—å–Ω–æ–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ
* –ü—Ä–∏–∑–Ω–∞–∫–∏ –∏–Ω—Ñ–∞—Ä–∫—Ç–∞/–∏–Ω—Å—É–ª—å—Ç–∞
* –¢—è–∂—ë–ª—ã–µ –æ–∂–æ–≥–∏
* –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–ª–æ–º –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞

**–£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!**

---

### üìã 2. –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
1. **[–®–∞–≥ 1]:** [—è—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
2. **[–®–∞–≥ 2]:** [—è—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
3. **[–®–∞–≥ 3]:** [—è—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]

---

### ‚õî 3. –ß—Ç–æ –ù–ï–õ–¨–ó–Ø –¥–µ–ª–∞—Ç—å
* [–ó–∞–ø—Ä–µ—Ç 1] ‚Äî –ø–æ—á–µ–º—É –æ–ø–∞—Å–Ω–æ
* [–ó–∞–ø—Ä–µ—Ç 2] ‚Äî –ø–æ—á–µ–º—É –æ–ø–∞—Å–Ω–æ

---

### üè• 4. –ö–æ–≥–¥–∞ –∫ –≤—Ä–∞—á—É (–¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞–ª–æ –ª—É—á—à–µ)
* [–°–∏—Ç—É–∞—Ü–∏—è 1]
* [–°–∏—Ç—É–∞—Ü–∏—è 2]

---

**–î–ò–°–ö–õ–ï–ô–ú–ï–†:** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ. –í —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –≤—ã–∑–æ–≤ —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏!`;

window.addEventListener('load', () => {
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
    const DEFAULT_MODEL = "gemini-3-flash-preview";

    const MODELS = [
        { id: "gemini-2.5-flash-lite", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini" },
        { id: "gemini-2.5-flash-lite-preview-06-25", uiName: "Gemini 2.5 Flash Lite Preview", apiType: "gemini" },
        { id: "gemini-3-flash-preview", uiName: "Gemini 3 Flash", apiType: "gemini" },
        { id: "gemini-2.5-pro", uiName: "Gemini 2.5 Pro", apiType: "gemini" },
        { id: "gemini-3-pro-preview", uiName: "Gemini 3 Pro Preview", apiType: "gemini" },
        { id: "nvidia/nemotron-3-nano-30b-a3b:free", uiName: "NVIDIA Nemotron 3 Nano 30B", apiType: "openrouter" },
        { id: "gpt-oss-20b-free", uiName: "OpenAI GPT-OSS 20B", apiType: "openrouter" },
        { id: "mistral-large-2512", uiName: "Mistral Large", apiType: "mistral" },
        { id: "mistral-medium-2508", uiName: "Mistral Medium", apiType: "mistral" },
    ];

    const API_MODES = {
        'mapruapp': { uiName: '–ü—Ä–æ–∫—Å–∏ (MapRuApp)', icon: 'fa-solid fa-server' },
        'vercel': { uiName: '–ü—Ä–æ–∫—Å–∏ (Vercel)', icon: 'fa-solid fa-cloud' },
        'direct': { uiName: '–ü—Ä—è–º–æ–π (Gemini)', icon: 'fa-solid fa-key' }
    };

    const modeConfigs = {
        'symptoms': { 
            prompt: AI_SYSTEM_PROMPT_SYMPTOMS, 
            placeholder: "–û–ø–∏—à–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å...", 
            name: "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
            desc: "–ê–Ω–∞–ª–∏–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
            icon: "fa-solid fa-stethoscope",
            color: "#2563eb",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);"><i class="fa-solid fa-stethoscope"></i></div><h2>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</h2><p>–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∏–º–ø—Ç–æ–º—ã –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 38¬∞C"</em></p></div>` 
        },
        'medications': { 
            prompt: AI_SYSTEM_PROMPT_MEDS, 
            placeholder: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞...", 
            name: "–õ–µ–∫–∞—Ä—Å—Ç–≤–∞",
            desc: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤",
            icon: "fa-solid fa-pills",
            color: "#7c3aed",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);"><i class="fa-solid fa-pills"></i></div><h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–µ–∫–∞—Ä—Å—Ç–≤</h2><p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª" –∏–ª–∏ "–ò–±—É–ø—Ä–æ—Ñ–µ–Ω"</em></p></div>` 
        },
        'substances': { 
            prompt: AI_SYSTEM_PROMPT_SUBSTANCES, 
            placeholder: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞...", 
            name: "–í–µ—â–µ—Å—Ç–≤–∞",
            desc: "–í–∏—Ç–∞–º–∏–Ω—ã, –º–∏–Ω–µ—Ä–∞–ª—ã, –ë–ê–î—ã",
            icon: "fa-solid fa-flask-vial",
            color: "#0891b2",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);"><i class="fa-solid fa-flask-vial"></i></div><h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≤–µ—â–µ—Å—Ç–≤</h2><p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω–∞, –º–∏–Ω–µ—Ä–∞–ª–∞ –∏–ª–∏ –≤–µ—â–µ—Å—Ç–≤–∞</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–í–∏—Ç–∞–º–∏–Ω D" –∏–ª–∏ "–ú–∞–≥–Ω–∏–π"</em></p></div>` 
        },
        'lifestyle': { 
            prompt: AI_SYSTEM_PROMPT_LIFESTYLE, 
            placeholder: "–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–∏—Ç–∞–Ω–∏–µ –∏–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è...", 
            name: "–ó–û–ñ –∏ –ü–∏—Ç–∞–Ω–∏–µ",
            desc: "–ó–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏",
            icon: "fa-solid fa-apple-whole",
            color: "#059669",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);"><i class="fa-solid fa-apple-whole"></i></div><h2>–ó–û–ñ –∏ –ü–∏—Ç–∞–Ω–∏–µ</h2><p>–°–ø—Ä–æ—Å–∏—Ç–µ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–∏–¥–µ–∏ –¥–ª—è –∑–¥–æ—Ä–æ–≤–æ–≥–æ –∑–∞–≤—Ç—Ä–∞–∫–∞"</em></p></div>` 
        },
        'atlas': { 
            prompt: AI_SYSTEM_PROMPT_ATLAS, 
            placeholder: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∞ –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã...", 
            name: "–ê–Ω–∞—Ç–æ–º–∏—è",
            desc: "–°—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–ª–∞ —á–µ–ª–æ–≤–µ–∫–∞",
            icon: "fa-solid fa-lungs",
            color: "#d97706",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);"><i class="fa-solid fa-lungs"></i></div><h2>–ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–π –∞—Ç–ª–∞—Å</h2><p>–£–∑–Ω–∞–π—Ç–µ –æ —Å—Ç—Ä–æ–µ–Ω–∏–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è—Ö –æ—Ä–≥–∞–Ω–æ–≤</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Ä–¥—Ü–µ"</em></p></div>` 
        },
        'first-aid': { 
            prompt: AI_SYSTEM_PROMPT_FIRST_AID, 
            placeholder: "–û–ø–∏—à–∏—Ç–µ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é...", 
            name: "–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å",
            desc: "–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏",
            icon: "fa-solid fa-kit-medical",
            color: "#dc2626",
            welcomeHTML: `<div class="welcome-message"><div class="welcome-icon" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);"><i class="fa-solid fa-kit-medical"></i></div><h2>–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å</h2><p>–ü–æ–ª—É—á–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏</p><p><em>–ù–∞–ø—Ä–∏–º–µ—Ä: "–æ–∂–æ–≥ –∫–∏–ø—è—Ç–∫–æ–º" –∏–ª–∏ "–ø–æ—Ä–µ–∑"</em></p></div>` 
        }
    };

    let currentModelId = DEFAULT_MODEL;
    let currentApiMode = 'mapruapp';
    let currentApiType = 'gemini';
    let apiKey = '';
    let currentMode = 'symptoms';
    let modeStates = {};
    let requestHistory = [];

    const $ = id => document.getElementById(id);
    const queryInput = $('user-query');
    const sendButton = $('send-btn');
    const responseContainer = $('ai-response');
    const responseActions = $('response-actions');
    const modeModal = $('mode-modal');
    const modeGrid = $('mode-grid');
    const settingsModal = $('settings-modal');
    const historyModal = $('history-modal');
    const modelSelector = $('model-selector');
    const apiModeOptions = $('api-mode-options');
    const apiKeyGroup = $('api-key-group');
    const apiKeyInput = $('api-key-input');
    const historyList = $('history-list');
    const statusBar = $('status-bar');
    const modeSelectorBtn = $('mode-selector-btn');
    const currentModeIcon = $('current-mode-icon');
    const currentModeName = $('current-mode-name');

    function init() {
        marked.setOptions({ gfm: true, breaks: true });
        initializeStates();
        loadSettings();
        renderModels();
        renderApiModes();
        renderModeGrid();
        renderHistory();
        bindEvents();
        switchMode(currentMode);
        updateStatusBar();
    }

    function initializeStates() {
        for (const modeId in modeConfigs) {
            modeStates[modeId] = {
                conversationHistory: [],
                responseHTML: modeConfigs[modeId].welcomeHTML,
                isLoading: false,
                controller: null,
                hasNewResponse: false,
                lastFailedQuery: null,
                responseTime: null
            };
        }
    }

    function renderModeGrid() {
        modeGrid.innerHTML = '';
        for (const modeId in modeConfigs) {
            const config = modeConfigs[modeId];
            const div = document.createElement('div');
            div.className = `mode-option ${modeId === currentMode ? 'selected' : ''}`;
            div.dataset.mode = modeId;
            div.innerHTML = `
                <div class="mode-opt-icon" style="background: linear-gradient(135deg, ${config.color} 0%, ${config.color}cc 100%);">
                    <i class="${config.icon}"></i>
                </div>
                <div class="mode-opt-info">
                    <div class="mode-opt-name">${config.name}</div>
                    <div class="mode-opt-desc">${config.desc}</div>
                </div>
            `;
            div.onclick = () => {
                switchMode(modeId);
                modeModal.style.display = 'none';
            };
            modeGrid.appendChild(div);
        }
    }

    function updateModeSelectorBtn() {
        const config = modeConfigs[currentMode];
        currentModeIcon.style.background = `linear-gradient(135deg, ${config.color} 0%, ${config.color}cc 100%)`;
        currentModeIcon.innerHTML = `<i class="${config.icon}"></i>`;
        currentModeName.textContent = config.name;
        modeSelectorBtn.classList.toggle('is-loading', modeStates[currentMode]?.isLoading);
        modeGrid.querySelectorAll('.mode-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.mode === currentMode);
        });
    }

    function bindEvents() {
        sendButton.onclick = () => handleRequest();
        queryInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } };
        queryInput.oninput = () => {
            queryInput.style.height = 'auto';
            queryInput.style.height = Math.min(queryInput.scrollHeight, 150) + 'px';
        };

        $('copy-btn').onclick = copyResponse;
        $('export-btn').onclick = exportToHTML;
        $('print-btn').onclick = () => window.print();
        $('new-chat-btn').onclick = startNewChat;

        modeSelectorBtn.onclick = () => { modeModal.style.display = 'flex'; };
        $('close-mode-modal').onclick = () => { modeModal.style.display = 'none'; };
        modeModal.onclick = e => { if (e.target === modeModal) modeModal.style.display = 'none'; };

        $('settings-btn').onclick = () => { settingsModal.style.display = 'flex'; };
        $('close-settings').onclick = () => { settingsModal.style.display = 'none'; };
        settingsModal.onclick = e => { if (e.target === settingsModal) settingsModal.style.display = 'none'; };
        $('save-settings').onclick = saveSettings;

        $('history-btn').onclick = () => { renderHistory(); historyModal.style.display = 'flex'; };
        $('close-history').onclick = () => { historyModal.style.display = 'none'; };
        historyModal.onclick = e => { if (e.target === historyModal) historyModal.style.display = 'none'; };

        modelSelector.onchange = updateApiModeVisibility;

        $('response-wrapper').onclick = e => {
            const retryBtn = e.target.closest('[data-action="retry"]');
            if (retryBtn) retryRequest(retryBtn.dataset.mode);
        };
    }

    function renderModels() {
        modelSelector.innerHTML = MODELS.map(m =>
            `<option value="${m.id}" data-api="${m.apiType}">${m.uiName}</option>`
        ).join('');
        modelSelector.value = currentModelId;
    }

    function renderApiModes() {
        apiModeOptions.innerHTML = Object.entries(API_MODES).map(([key, mode]) => `
            <div class="api-mode-option ${key === currentApiMode ? 'selected' : ''}" data-mode="${key}">
                <i class="${mode.icon}"></i>
                <span>${mode.uiName}</span>
            </div>
        `).join('');

        apiModeOptions.querySelectorAll('.api-mode-option').forEach(el => {
            el.onclick = () => {
                currentApiMode = el.dataset.mode;
                apiModeOptions.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
                el.classList.add('selected');
                updateApiKeyVisibility();
            };
        });
        updateApiModeVisibility();
    }

    function updateApiModeVisibility() {
        const model = MODELS.find(m => m.id === modelSelector.value);
        if (model) currentApiType = model.apiType;

        const options = apiModeOptions.querySelectorAll('.api-mode-option');
        options.forEach(opt => {
            const mode = opt.dataset.mode;
            if (currentApiType === 'gemini') {
                opt.style.display = 'flex';
            } else {
                opt.style.display = (mode === 'direct') ? 'none' : 'flex';
            }
        });

        const currentOpt = apiModeOptions.querySelector(`[data-mode="${currentApiMode}"]`);
        if (currentOpt && currentOpt.style.display === 'none') {
            currentApiMode = 'mapruapp';
            apiModeOptions.querySelectorAll('.api-mode-option').forEach(o => o.classList.remove('selected'));
            apiModeOptions.querySelector('[data-mode="mapruapp"]').classList.add('selected');
        }
        updateApiKeyVisibility();
    }

    function updateApiKeyVisibility() {
        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini');
        apiKeyGroup.style.display = needsKey ? 'block' : 'none';
    }

    function loadSettings() {
        currentModelId = localStorage.getItem('med_modelId') || DEFAULT_MODEL;
        currentApiMode = localStorage.getItem('med_apiMode') || 'mapruapp';
        apiKey = localStorage.getItem('med_apiKey') || '';
        currentMode = localStorage.getItem('med_currentMode') || 'symptoms';
        requestHistory = JSON.parse(localStorage.getItem('med_history') || '[]');

        const model = MODELS.find(m => m.id === currentModelId);
        if (model) currentApiType = model.apiType;
        else { currentModelId = DEFAULT_MODEL; currentApiType = 'gemini'; }

        apiKeyInput.value = apiKey;
        if (modelSelector.querySelector(`option[value="${currentModelId}"]`)) {
            modelSelector.value = currentModelId;
        }
    }

    function saveSettings() {
        currentModelId = modelSelector.value;
        const model = MODELS.find(m => m.id === currentModelId);
        if (model) currentApiType = model.apiType;

        currentApiMode = apiModeOptions.querySelector('.api-mode-option.selected')?.dataset.mode || 'mapruapp';
        apiKey = apiKeyInput.value.trim();

        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini');
        if (needsKey && !apiKey) {
            alert('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞');
            return;
        }

        localStorage.setItem('med_modelId', currentModelId);
        localStorage.setItem('med_apiMode', currentApiMode);
        localStorage.setItem('med_apiKey', apiKey);

        settingsModal.style.display = 'none';
        updateStatusBar();
    }

    function updateStatusBar() {
        const model = MODELS.find(m => m.id === currentModelId);
        const modeName = API_MODES[currentApiMode]?.uiName || '–ü—Ä–æ–∫—Å–∏';
        statusBar.textContent = `${model?.uiName || 'Gemini'} ‚Ä¢ ${modeName}`;
    }

    function addToHistory(query) {
        requestHistory = requestHistory.filter(h => h !== query);
        requestHistory.unshift(query);
        if (requestHistory.length > 15) requestHistory.pop();
        localStorage.setItem('med_history', JSON.stringify(requestHistory));
    }

    function renderHistory() {
        if (requestHistory.length === 0) {
            historyList.innerHTML = `<div class="history-empty"><i class="fa-solid fa-clock-rotate-left"></i><p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p></div>`;
            return;
        }
        historyList.innerHTML = requestHistory.map((item, i) => `
            <div class="history-item" data-query="${item.replace(/"/g, '&quot;')}">
                <span class="history-item-text">${item}</span>
                <button class="history-item-delete" data-index="${i}"><i class="fa-solid fa-times"></i></button>
            </div>
        `).join('');

        historyList.querySelectorAll('.history-item').forEach(el => {
            el.onclick = e => {
                if (e.target.closest('.history-item-delete')) {
                    const idx = e.target.closest('.history-item-delete').dataset.index;
                    requestHistory.splice(idx, 1);
                    localStorage.setItem('med_history', JSON.stringify(requestHistory));
                    renderHistory();
                } else {
                    queryInput.value = el.dataset.query;
                    historyModal.style.display = 'none';
                    queryInput.focus();
                }
            };
        });
    }

    function switchMode(modeId) {
        if (!modeId || !modeStates[modeId]) return;
        currentMode = modeId;
        localStorage.setItem('med_currentMode', modeId);

        const state = modeStates[modeId];
        const config = modeConfigs[modeId];

        responseContainer.innerHTML = state.responseHTML;
        $('response-wrapper').scrollTop = 0;
        responseActions.style.display = (!state.isLoading && state.conversationHistory.length > 0) ? 'flex' : 'none';
        queryInput.placeholder = config.placeholder;

        state.hasNewResponse = false;
        updateModeSelectorBtn();

        const cancelBtn = $('cancel-btn');
        if (cancelBtn) cancelBtn.onclick = () => cancelRequest(modeId);
    }

    function formatTime(ms) {
        if (!ms || ms < 1000) return '~1—Å';
        const sec = Math.round(ms / 1000);
        if (sec < 60) return `${sec}—Å`;
        return `${Math.floor(sec / 60)}–º ${sec % 60}—Å`;
    }

    function getLoaderHTML() {
        return `<div class="loader"><div class="lds-heart"><div></div></div><p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...<br>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.</p><button id="cancel-btn">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>`;
    }

    function getErrorHTML(message, modeId, isKeyError = false) {
        return `
            <div class="welcome-message">
                <div class="welcome-icon" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h2 style="color: #dc2626;">–û—à–∏–±–∫–∞</h2>
                <p>${message}</p>
                ${isKeyError ?
                    `<button class="action-btn" onclick="document.getElementById('settings-btn').click()" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); margin-top: 16px;">
                        <i class="fa-solid fa-key"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>` :
                    `<button class="action-btn" data-action="retry" data-mode="${modeId}" style="background: var(--accent-gradient); margin-top: 16px;">
                        <i class="fa-solid fa-rotate-right"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>`}
            </div>`;
    }

    function transliterate(text) {
        const map = { 'q':'–π','w':'—Ü','e':'—É','r':'–∫','t':'–µ','y':'–Ω','u':'–≥','i':'—à','o':'—â','p':'–∑','[':'—Ö',']':'—ä','a':'—Ñ','s':'—ã','d':'–≤','f':'–∞','g':'–ø','h':'—Ä','j':'–æ','k':'–ª','l':'–¥',';':'–∂',"'":'—ç','z':'—è','x':'—á','c':'—Å','v':'–º','b':'–∏','n':'—Ç','m':'—å',',':'–±','.':'—é','Q':'–ô','W':'–¶','E':'–£','R':'–ö','T':'–ï','Y':'–ù','U':'–ì','I':'–®','O':'–©','P':'–ó','{':'–•','}':'–™','A':'–§','S':'–´','D':'–í','F':'–ê','G':'–ü','H':'–†','J':'–û','K':'–õ','L':'–î',':':'–ñ','"':'–≠','Z':'–Ø','X':'–ß','C':'–°','V':'–ú','B':'–ò','N':'–¢','M':'–¨','<':'–ë','>':'–Æ' };
        return text.split('').map(c => map[c] || c).join('');
    }

    function exportToHTML() {
        const content = responseContainer.innerHTML;
        const config = modeConfigs[currentMode];
        const date = new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        const htmlTemplate = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–¥–ü–æ–º–æ—â–Ω–∏–∫ - ${config.name}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #0f172a;
            line-height: 1.6;
            padding: 40px 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }
        .header h1 {
            color: #2563eb;
            font-size: 24px;
            margin-bottom: 8px;
        }
        .header .meta {
            color: #64748b;
            font-size: 14px;
        }
        .content { font-size: 15px; line-height: 1.8; }
        .content h2, .content h3 {
            color: #0f172a;
            margin: 28px 0 16px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .content h2 { font-size: 20px; text-align: center; border-color: #2563eb; }
        .content h3 { font-size: 17px; }
        .content p { margin: 14px 0; }
        .content ul, .content ol { padding-left: 24px; margin: 14px 0; }
        .content li { margin: 8px 0; }
        .content strong { color: #1d4ed8; }
        .content hr { border: none; height: 1px; background: #e2e8f0; margin: 28px 0; }
        .content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .content th {
            background: #2563eb;
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
        }
        .content td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .content tbody tr:nth-child(even) { background: #f8fafc; }
        .content a { color: #2563eb; }
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 14px 18px;
            border-radius: 10px;
            margin-top: 24px;
            font-size: 14px;
        }
        .footer {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            color: #94a3b8;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü©∫ –ú–µ–¥–ü–æ–º–æ—â–Ω–∏–∫</h1>
            <div class="meta">–†–∞–∑–¥–µ–ª: ${config.name} ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${date}</div>
        </div>
        <div class="content">${content}</div>
        <div class="footer">
            –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é –ú–µ–¥–ü–æ–º–æ—â–Ω–∏–∫ AI<br>
            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞
        </div>
    </div>
</body>
</html>`;

        const blob = new Blob([htmlTemplate], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `medhelper_${currentMode}_${Date.now()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const btn = $('export-btn');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>';
        setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-file-export"></i><span>–≠–∫—Å–ø–æ—Ä—Ç HTML</span>'; }, 2000);
    }

    async function handleRequest(queryOverride = null, modeOverride = null) {
        const modeId = modeOverride || currentMode;
        if (!modeId) return;

        const needsKey = (currentApiMode === 'direct' && currentApiType === 'gemini');
        if (needsKey && !apiKey) {
            settingsModal.style.display = 'flex';
            return;
        }

        let query = queryOverride || queryInput.value.trim();
        if (!query) return;

        const state = modeStates[modeId];
        if (state.isLoading) return;

        let systemPrompt = modeConfigs[modeId].prompt;
        let wasCorrected = false;
        const hasRussian = /[–∞-—è–ê-–Ø—ë–Å]/.test(query);
        if (!hasRussian) {
            const corrected = transliterate(query);
            if (/[–∞-—è–ê-–Ø—ë–Å]/.test(corrected)) {
                systemPrompt += `\n\n–ó–∞–ø—Ä–æ—Å "${query}" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ "${corrected}". –û—Ç–≤–µ—á–∞–π –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π.`;
                query = corrected;
                wasCorrected = true;
            }
        }

        if (!queryOverride) {
            addToHistory(query);
            queryInput.value = '';
            queryInput.style.height = 'auto';
        }

        state.lastFailedQuery = null;
        const startTime = performance.now();
        state.isLoading = true;
        state.controller = new AbortController();
        state.conversationHistory.push({ role: 'user', content: query });

        if (currentMode === modeId) {
            state.responseHTML = getLoaderHTML();
            responseContainer.innerHTML = state.responseHTML;
            responseActions.style.display = 'none';
            const cancelBtn = $('cancel-btn');
            if (cancelBtn) cancelBtn.onclick = () => cancelRequest(modeId);
        }
        updateModeSelectorBtn();

        try {
            let apiUrl, body;
            const headers = { 'Content-Type': 'application/json' };

            const messages = [
                { role: 'system', content: systemPrompt },
                ...state.conversationHistory.map(m => ({
                    role: m.role === 'model' ? 'assistant' : 'user',
                    content: m.content
                }))
            ];

            if (currentApiMode === 'mapruapp') {
                apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                body = { model: currentModelId, messages, max_tokens: 8192 };
            } else if (currentApiMode === 'direct') {
                const geminiContents = state.conversationHistory.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.content }]
                }));
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModelId}:generateContent?key=${apiKey}`;
                body = {
                    contents: geminiContents,
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
            } else if (currentApiMode === 'vercel') {
                if (currentApiType === 'gemini') {
                    apiUrl = `${VERCEL_PROXY_BASE_URL}/v1beta/models/${currentModelId}:generateContent`;
                    const geminiContents = state.conversationHistory.map(m => ({
                        role: m.role === 'user' ? 'user' : 'model',
                        parts: [{ text: m.content }]
                    }));
                    body = {
                        contents: geminiContents,
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                } else {
                    apiUrl = `${VERCEL_PROXY_BASE_URL}/proxy/openrouter/chat/completions`;
                    body = { model: currentModelId, messages, max_tokens: 8192 };
                }
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers,
                body: JSON.stringify(body),
                signal: state.controller.signal
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                const msg = err.error?.message || `HTTP ${response.status}`;
                const isKeyError = response.status === 400 && msg.toLowerCase().includes('api key');
                throw new Error(msg, { cause: { isKeyError } });
            }

            const data = await response.json();
            let aiText;

            if (currentApiMode === 'mapruapp' || (currentApiMode === 'vercel' && currentApiType !== 'gemini')) {
                aiText = data.choices?.[0]?.message?.content;
            } else {
                aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            }

            if (!aiText) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò');

            if (wasCorrected) {
                aiText += `\n\n---\n*–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—É.*`;
            }

            const endTime = performance.now();
            state.responseTime = endTime - startTime;
            state.conversationHistory.push({ role: 'model', content: aiText });
            state.responseHTML = marked.parse(aiText);
            if (currentMode !== modeId) state.hasNewResponse = true;

        } catch (error) {
            state.conversationHistory.pop();
            state.lastFailedQuery = query;
            if (error.name === 'AbortError') {
                state.responseHTML = getErrorHTML('–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω', modeId);
            } else {
                state.responseHTML = getErrorHTML(error.message, modeId, error.cause?.isKeyError);
            }
        } finally {
            state.isLoading = false;
            state.controller = null;
            if (currentMode === modeId) {
                responseContainer.innerHTML = state.responseHTML;
                responseActions.style.display = state.conversationHistory.length > 0 ? 'flex' : 'none';
            }
            updateModeSelectorBtn();
        }
    }

    function cancelRequest(modeId) {
        const state = modeStates[modeId];
        if (state?.controller) state.controller.abort();
    }

    function retryRequest(modeId) {
        const state = modeStates[modeId];
        if (state?.lastFailedQuery) handleRequest(state.lastFailedQuery, modeId);
    }

    function startNewChat() {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (state.isLoading && state.controller) state.controller.abort();

        state.conversationHistory = [];
        state.responseHTML = modeConfigs[currentMode].welcomeHTML;
        state.isLoading = false;
        state.hasNewResponse = false;
        state.responseTime = null;

        responseContainer.innerHTML = state.responseHTML;
        responseActions.style.display = 'none';
        updateModeSelectorBtn();
    }

    function copyResponse() {
        navigator.clipboard.writeText(responseContainer.innerText).then(() => {
            const btn = $('copy-btn');
            btn.innerHTML = '<i class="fa-solid fa-check"></i><span>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>';
            setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-copy"></i><span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>'; }, 2000);
        });
    }

    init();
});
</script>
</body>
</html>
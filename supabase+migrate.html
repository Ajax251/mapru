<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Admin Panel</title>
    <link id="favicon" rel="icon" href="img/supabase.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { width: 320px; transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.5rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #exportProgressContainer { margin-top: 20px; background-color: rgba(0,0,0,0.75); padding: 20px; border-radius: 8px; color: white; text-align: center; min-width: 320px; }
        #sqlScriptContent, #migrationLog { max-height: 200px; overflow-y: auto; background-color: #111827; color: #d1d5db; font-family: monospace; }
        .drop-zone-active { border: 2px dashed #3b82f6 !important; background-color: rgba(59, 130, 246, 0.1) !important; }
        #tableViewContent table { table-layout: fixed; width: 100%; }
        #tableViewContent th, #tableViewContent td { padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
        #tableViewContent th { background-color: #f9fafb; font-weight: 600; }
        #tableViewContent td { max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #tableViewContent td:hover { overflow: visible; white-space: normal; word-break: break-all; }
        #bucketFilesModal th .sort-indicator { margin-left: 4px; }
        #bucketFilesTableBody tr.selected-row td { background-color: #ef4444 !important; color: white !important; }
        #bucketFilesTableBody tr.selected-row:hover td { background-color: #dc2626 !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div id="loadingSpinnerSection">
            <div class="spinner"></div>
            <span id="loadingMessage" class="ml-3 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div id="exportProgressContainer" class="hidden">
            <p id="exportProgressMessage">–û–ø–µ—Ä–∞—Ü–∏—è...</p>
            <progress id="exportProgressBar" value="0" max="100"></progress>
            <div class="flex justify-center mt-2 space-x-2">
                <button id="pauseExportBtn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-2 px-4 rounded text-sm">–ü–∞—É–∑–∞</button>
                <button id="cancelExportBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="migrationModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[10002] hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold">–ú–∏–≥—Ä–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö</h3>
                <button id="closeMigrationModalBtn" class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-1.5 px-3 rounded text-sm">&times; –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="text-lg font-bold border-b pb-2">1. –ò—Å—Ç–æ—á–Ω–∏–∫ (–û—Ç–∫—É–¥–∞)</h4>
                    <p>–¢–µ–∫—É—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: <strong id="migrationSourceConnection" class="text-indigo-600">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</strong></p>

                    <h4 class="text-lg font-bold border-b pb-2 mt-6">2. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–ö—É–¥–∞)</h4>
                    <div class="space-y-3">
                        <input type="url" id="destConnUrl" placeholder="Supabase URL –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" class="w-full p-2 rounded border border-gray-300">
                        <input type="password" id="destConnKey" placeholder="Service Role Secret –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" class="w-full p-2 rounded border border-gray-300">
                        <button id="testDestConnectionBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é</button>
                        <p id="destConnectionStatus" class="text-sm text-center"></p>
                    </div>

                    <h4 class="text-lg font-bold border-b pb-2 mt-6">3. –û–±—ä–µ–∫—Ç—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="migrateSchemaCheckbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="migrateSchemaCheckbox" class="ml-2 block text-sm text-gray-900">
                                <strong>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Å—Ö–µ–º—É</strong> (—Ç–∞–±–ª–∏—Ü—ã, —Ñ—É–Ω–∫—Ü–∏–∏, view, –∏–Ω–¥–µ–∫—Å—ã)
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Å—Ç–∞–≤–∏—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º. –°–Ω–∞—á–∞–ª–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∑–∞—Ç–µ–º –¥–∞–Ω–Ω—ã–µ.</p>
                        <hr class="my-2">
                        <p class="font-semibold">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö:</p>
                        <div id="migrationTablesList" class="max-h-48 overflow-y-auto border p-2 rounded space-y-1">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-bold border-b pb-2">4. –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
                    <pre id="migrationLog" class="w-full h-[calc(100%-80px)] p-2 border rounded text-xs whitespace-pre-wrap break-all"></pre>
                </div>
            </div>
            <div class="p-4 border-t text-right">
                <button id="startMigrationBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
                </button>
            </div>
        </div>
    </div>

    <div id="bucketFilesModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[10000] hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-[90vw] h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="bucketFilesModalTitle" class="text-xl font-semibold">Files in Bucket</h3>
                <div>
                    <button id="deleteSelectedModalFilesBtn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-1.5 px-3 rounded text-sm mr-2">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                    <button id="downloadSelectedModalFilesBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1.5 px-3 rounded text-sm mr-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                    <button id="exportFileListTxtBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-3 rounded text-sm mr-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ (TXT)</button>
                    <button id="closeBucketFilesModalBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded text-sm">&times; –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
            <div id="modalDropZone" class="overflow-auto flex-grow p-4 border-2 border-transparent">
                <table id="bucketFilesTable" class="min-w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="w-2/6 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="name">–ò–º—è<span class="sort-indicator"></span></th>
                            <th scope="col" class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="size">–†–∞–∑–º–µ—Ä<span class="sort-indicator"></span></th>
                            <th scope="col" class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="last_modified">–ò–∑–º–µ–Ω–µ–Ω<span class="sort-indicator"></span></th>
                            <th scope="col" class="w-2/6 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–ª–Ω—ã–π –ø—É—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="bucketFilesTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tableViewModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[10001] hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-[95vw] h-[95vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="tableViewModalTitle" class="text-xl font-semibold">Table Data</h3>
                <button id="closeTableViewModalBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-3 rounded text-sm">&times; –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="tableViewContent" class="overflow-auto flex-grow p-4">
            </div>
            <div class="p-3 border-t space-y-3">
                <div class="w-full">
                     <input type="text" id="tableViewSearchInput" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–º –∏ JSON –∫–æ–ª–æ–Ω–∫–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—Ç–µ–∫—Å—Ç1 —Ç–µ–∫—Å—Ç2')..." class="w-full p-2 rounded border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="tableViewPagination" class="flex justify-between items-center text-sm">
                    <button id="prevPageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-4 rounded disabled:bg-gray-400 disabled:cursor-not-allowed">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                    <span id="pageInfo" class="font-medium text-gray-700"></span>
                    <button id="nextPageBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1.5 px-4 rounded disabled:bg-gray-400 disabled:cursor-not-allowed">–°–ª–µ–¥—É—é—â–∞—è</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <aside id="sidebar" class="sidebar bg-gray-800 text-white p-6 space-y-6 fixed top-0 left-0 h-full overflow-y-auto">
            <h1 class="text-2xl font-semibold">Supabase Admin</h1>
            <div>
                <h2 class="text-lg font-medium mb-2">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
                <form id="connectionForm" class="space-y-3">
                    <input type="text" id="connName" placeholder="–ò–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–∏–º—è —Ñ–∞–π–ª–∞)" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required>
                    <input type="url" id="connUrl" placeholder="Supabase URL (https://xyz.supabase.co)" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required>
                    <input type="password" id="connKey" placeholder="Service Role Secret" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required autocomplete="current-password">
                    <button type="submit" id="connectButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </form>
                <div class="mt-3 flex space-x-2">
                    <button id="saveConnectionFileButton" class="w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="loadConnectionFileButton" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
            <hr class="border-gray-700 my-6">
                   <div id="sqlSetupSection" class="p-1 bg-gray-700 rounded-lg">
                <h3 class="text-md font-semibold mb-2 text-center">SQL –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (v4)</h3>
                <p class="text-xs mb-2 px-2">–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞–Ω–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL —Å–∫—Ä–∏–ø—Ç –≤ **–û–ë–û–ò–•** –ø—Ä–æ–µ–∫—Ç–∞—Ö (SQL Editor):</p>
                <div class="relative bg-gray-900 p-3 rounded m-2">
                    <button id="copySqlButton" class="absolute top-2 right-2 bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 text-xs rounded z-10">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
                    <pre><code id="sqlScriptContent" class="text-xs language-sql whitespace-pre-wrap break-all">
-- SQL-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è Supabase Admin Panel (v4)
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –ò–°–•–û–î–ù–û–ú –∏ –¶–ï–õ–ï–í–û–ú –ø—Ä–æ–µ–∫—Ç–∞—Ö.

-- ======== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–ê–ù–ï–õ–ò ========

-- 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
DROP FUNCTION IF EXISTS public.test_connection_schema();
CREATE OR REPLACE FUNCTION test_connection_schema() RETURNS TABLE (schema_name information_schema.sql_identifier) AS $$ BEGIN RETURN QUERY SELECT s.schema_name FROM information_schema.schemata s LIMIT 1; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.test_connection_schema() TO service_role;

-- 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
DROP FUNCTION IF EXISTS public.get_public_user_tables();
CREATE OR REPLACE FUNCTION get_public_user_tables() RETURNS TABLE (table_name information_schema.sql_identifier) AS $$ BEGIN RETURN QUERY SELECT t.table_name FROM information_schema.tables t WHERE t.table_schema = 'public' AND t.table_type = 'BASE TABLE' AND t.table_name NOT LIKE 'pg_%' AND t.table_name NOT LIKE 'sql_%' AND t.table_name NOT IN ('supabase_migrations', 'pg_stat_statements', 'pg_stat_statements_info', 'spatial_ref_sys') ORDER BY t.table_name; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.get_public_user_tables() TO service_role;

-- 3. –ü–æ–∏—Å–∫ –∏ –ø–æ–¥—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
DROP FUNCTION IF EXISTS public.search_table_data(TEXT, TEXT, INT, INT);
CREATE OR REPLACE FUNCTION search_table_data(p_table_name TEXT, p_search_text TEXT, p_limit INT, p_offset INT) RETURNS SETOF JSON AS $$ DECLARE searchable_cols TEXT[]; where_clause TEXT := '1=1'; search_word TEXT; query TEXT; order_by_col TEXT; BEGIN SELECT array_agg(column_name::TEXT) INTO searchable_cols FROM information_schema.columns WHERE table_schema = 'public' AND table_name = p_table_name AND (data_type IN ('character varying', 'text', 'character') OR udt_name IN ('json', 'jsonb')); IF p_search_text IS NOT NULL AND p_search_text != '' AND array_length(searchable_cols, 1) > 0 THEN where_clause := ''; FOREACH search_word IN ARRAY string_to_array(p_search_text, ' ') LOOP IF search_word != '' THEN IF where_clause != '' THEN where_clause := where_clause || ' AND '; END IF; where_clause := where_clause || '(' || array_to_string(ARRAY(SELECT format('%I::text ILIKE %L', col_name, '%' || search_word || '%') FROM unnest(searchable_cols) AS col_name), ' OR ') || ')'; END IF; END LOOP; END IF; SELECT kcu.column_name INTO order_by_col FROM information_schema.table_constraints AS tc JOIN information_schema.key_column_usage AS kcu ON tc.constraint_name = kcu.constraint_name AND tc.table_schema = kcu.table_schema WHERE tc.constraint_type = 'PRIMARY KEY' AND tc.table_schema = 'public' AND tc.table_name = p_table_name LIMIT 1; IF order_by_col IS NULL THEN SELECT column_name INTO order_by_col FROM information_schema.columns WHERE table_schema = 'public' AND table_name = p_table_name ORDER BY ordinal_position LIMIT 1; END IF; query := format('SELECT to_json(t.*) FROM public.%I AS t WHERE %s ORDER BY t.%I LIMIT %s OFFSET %s', p_table_name, where_clause, order_by_col, p_limit, p_offset); RETURN QUERY EXECUTE query; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.search_table_data(TEXT, TEXT, INT, INT) TO service_role;

DROP FUNCTION IF EXISTS public.search_table_count(TEXT, TEXT);
CREATE OR REPLACE FUNCTION search_table_count(p_table_name TEXT, p_search_text TEXT) RETURNS INT AS $$ DECLARE searchable_cols TEXT[]; where_clause TEXT := '1=1'; search_word TEXT; query TEXT; row_count INT; BEGIN SELECT array_agg(column_name::TEXT) INTO searchable_cols FROM information_schema.columns WHERE table_schema = 'public' AND table_name = p_table_name AND (data_type IN ('character varying', 'text', 'character') OR udt_name IN ('json', 'jsonb')); IF p_search_text IS NOT NULL AND p_search_text != '' AND array_length(searchable_cols, 1) > 0 THEN where_clause := ''; FOREACH search_word IN ARRAY string_to_array(p_search_text, ' ') LOOP IF search_word != '' THEN IF where_clause != '' THEN where_clause := where_clause || ' AND '; END IF; where_clause := where_clause || '(' || array_to_string(ARRAY(SELECT format('%I::text ILIKE %L', col_name, '%' || search_word || '%') FROM unnest(searchable_cols) AS col_name), ' OR ') || ')'; END IF; END LOOP; END IF; query := format('SELECT count(*) FROM public.%I WHERE %s', p_table_name, where_clause); EXECUTE query INTO row_count; RETURN row_count; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.search_table_count(TEXT, TEXT) TO service_role;


-- ======== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–ò–ì–†–ê–¶–ò–ò ========

-- 4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ SQL –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
DROP FUNCTION IF EXISTS public.execute_arbitrary_sql(TEXT);
CREATE OR REPLACE FUNCTION execute_arbitrary_sql(sql_text TEXT) RETURNS TEXT AS $$ BEGIN EXECUTE sql_text; RETURN 'OK'; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.execute_arbitrary_sql(TEXT) TO service_role;

-- 5. –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã (—Ç–∞–±–ª–∏—Ü, view, —Ñ—É–Ω–∫—Ü–∏–π, –∏–Ω–¥–µ–∫—Å–æ–≤) —Å –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
DROP FUNCTION IF EXISTS public.get_full_schema_sql();
CREATE OR REPLACE FUNCTION get_full_schema_sql()
RETURNS text AS $$
DECLARE
    schema_sql text := '';
    rec record;
BEGIN
    -- 1. Tables
    schema_sql := schema_sql || '-- 1. Tables' || E'\n';
    FOR rec IN SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' AND table_name NOT LIKE 'pg_%' AND table_name NOT LIKE 'sql_%' AND table_name NOT IN ('supabase_migrations') LOOP
        schema_sql := schema_sql || (SELECT 'CREATE TABLE ' || quote_ident(rec.table_name) || E' (\n' || string_agg('    ' || quote_ident(column_name) || ' ' || udt_name || CASE WHEN character_maximum_length IS NOT NULL THEN '(' || character_maximum_length || ')' ELSE '' END || CASE WHEN is_nullable = 'NO' THEN ' NOT NULL' ELSE '' END || CASE WHEN column_default IS NOT NULL THEN ' DEFAULT ' || column_default ELSE '' END, E',\n') || E'\n);\n\n' FROM information_schema.columns WHERE table_name = rec.table_name AND table_schema = 'public');
    END LOOP;

    -- 2. Views
    schema_sql := schema_sql || '-- 2. Views' || E'\n';
    FOR rec IN SELECT table_name, view_definition FROM information_schema.views WHERE table_schema = 'public' LOOP
        schema_sql := schema_sql || 'CREATE OR REPLACE VIEW ' || quote_ident(rec.table_name) || ' AS ' || E'\n' || rec.view_definition || E';\n\n';
    END LOOP;

    -- 3. Functions and Procedures
    schema_sql := schema_sql || '-- 3. Functions and Procedures' || E'\n';
    FOR rec IN
        SELECT pg_get_functiondef(p.oid) AS function_definition
        FROM pg_proc p
        JOIN pg_namespace n ON p.pronamespace = n.oid
        LEFT JOIN pg_depend d ON d.objid = p.oid AND d.deptype = 'e'
        WHERE n.nspname = 'public'
          AND p.prokind IN ('f', 'p')
          AND d.objid IS NULL -- –ò—Å–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º
    LOOP
        schema_sql := schema_sql || rec.function_definition || E';\n\n';
    END LOOP;

    -- 4. Indexes
    schema_sql := schema_sql || '-- 4. Indexes' || E'\n';
    FOR rec IN SELECT indexdef FROM pg_indexes WHERE schemaname = 'public' LOOP
        IF rec.indexdef NOT LIKE '%_pkey%' THEN
           schema_sql := schema_sql || rec.indexdef || E';\n\n';
        END IF;
    END LOOP;

    RETURN schema_sql;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
GRANT EXECUTE ON FUNCTION public.get_full_schema_sql() TO service_role;
                    </code></pre>
                </div>
            </div>
        </aside>

        <main id="mainContent" class="main-content flex-1 p-8 overflow-y-auto ml-[320px]">
            <button id="toggleSidebarButton" class="fixed top-4 left-4 z-20 bg-gray-700 text-white p-2 rounded md:hidden">‚ò∞</button>
            <div id="welcomeMessage" class="text-center">
            </div>
            <div id="dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold">–ü–∞–Ω–µ–ª—å: <span id="currentConnectionName" class="text-indigo-600"></span></h2>
                        <button id="openMigrationModalBtn" class="mt-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1.5 px-4 rounded text-sm shadow">
                            üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
                        </button>
                    </div>
                    <button id="disconnectButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <section>
                        <div class="flex justify-between items-center mb-2">
                             <h3 class="text-2xl font-semibold">–¢–∞–±–ª–∏—Ü—ã (—Å—Ö–µ–º–∞: public)</h3>
                             <div id="globalExportButtons" class="hidden space-x-2">
                                <button id="exportAllSqlBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ SQL (ZIP)">–í—Å–µ SQL</button>
                                <button id="exportAllCsvBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ CSV (ZIP)">–í—Å–µ CSV</button>
                                <button id="exportAllXlsxBtn" class="text-xs bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded shadow" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ XLSX (ZIP)">–í—Å–µ XLSX</button>
                            </div>
                        </div>
                        <div id="tablesList" class="space-y-3 bg-white p-4 rounded-lg shadow"></div>
                    </section>
                    <section>
                        <h3 class="text-2xl font-semibold mb-4">Buckets (–•—Ä–∞–Ω–∏–ª–∏—â–µ)</h3>
                        <div id="bucketsList" class="space-y-3 bg-white p-4 rounded-lg shadow"></div>
                    </section>
                </div>
            </div>
            <div id="statusMessages" class="mt-4 p-3 rounded fixed bottom-4 right-4 z-[9998] max-w-md"></div>
        </main>
    </div>
<script>
 
    const { createClient } = supabase;
    let supabaseClient = null;
    let currentConnectionDetails = null;
    let currentExportAbortController = null;
    let isExportProcessActive = false;
    let isExportPaused = false;
    let pauseResolver = null;
    let currentlyListedTables = [];
    let currentBucketFilesData = [];
    let currentViewBucketName = '';
    let currentSortKey = 'name';
    let currentSortOrder = 'asc';
    let bucketViewAbortController = null;
    let selectedFilePathsInModal = new Set();
    let currentViewTableName = '';
    let currentPage = 1;
    const PAGE_SIZE = 50;
    let totalRows = 0;

    const el = (id) => document.getElementById(id);
    const connectionForm = el('connectionForm');
    const connNameInput = el('connName');
    const connUrlInput = el('connUrl');
    const connKeyInput = el('connKey');
    const saveConnectionFileButton = el('saveConnectionFileButton');
    const loadConnectionFileButton = el('loadConnectionFileButton');
    const dashboardEl = el('dashboard');
    const welcomeMessageEl = el('welcomeMessage');
    const currentConnectionNameEl = el('currentConnectionName');
    const disconnectButton = el('disconnectButton');
    const tablesListEl = el('tablesList');
    const bucketsListEl = el('bucketsList');
    const statusMessagesEl = el('statusMessages');
    const loadingOverlay = el('loadingOverlay');
    const loadingMessageEl = el('loadingMessage');
    const loadingSpinnerSection = el('loadingSpinnerSection');
    const exportProgressContainer = el('exportProgressContainer');
    const exportProgressMessage = el('exportProgressMessage');
    const exportProgressBar = el('exportProgressBar');
    const cancelExportBtn = el('cancelExportBtn');
    const pauseExportBtn = el('pauseExportBtn');
    const sidebar = el('sidebar');
    const mainContent = el('mainContent');
    const toggleSidebarButton = el('toggleSidebarButton');
    const copySqlButton = el('copySqlButton');
    const sqlScriptContentEl = el('sqlScriptContent');
    const globalExportButtons = el('globalExportButtons');
    const exportAllSqlBtn = el('exportAllSqlBtn');
    const exportAllCsvBtn = el('exportAllCsvBtn');
    const exportAllXlsxBtn = el('exportAllXlsxBtn');
    const bucketFilesModal = el('bucketFilesModal');
    const bucketFilesModalTitle = el('bucketFilesModalTitle');
    const closeBucketFilesModalBtn = el('closeBucketFilesModalBtn');
    const exportFileListTxtBtn = el('exportFileListTxtBtn');
    const bucketFilesTableBody = el('bucketFilesTableBody');
    const downloadSelectedModalFilesBtn = el('downloadSelectedModalFilesBtn');
    const deleteSelectedModalFilesBtn = el('deleteSelectedModalFilesBtn');
    const modalDropZone = el('modalDropZone');
    const tableViewModal = el('tableViewModal');
    const tableViewModalTitle = el('tableViewModalTitle');
    const closeTableViewModalBtn = el('closeTableViewModalBtn');
    const tableViewContent = el('tableViewContent');
    const tableViewPagination = el('tableViewPagination');
    const prevPageBtn = el('prevPageBtn');
    const nextPageBtn = el('nextPageBtn');
    const pageInfo = el('pageInfo');
    const tableViewSearchInput = el('tableViewSearchInput');
    const migrationModal = el('migrationModal');
    const openMigrationModalBtn = el('openMigrationModalBtn');
    const closeMigrationModalBtn = el('closeMigrationModalBtn');
    const migrationSourceConnection = el('migrationSourceConnection');
    const destConnUrl = el('destConnUrl');
    const destConnKey = el('destConnKey');
    const testDestConnectionBtn = el('testDestConnectionBtn');
    const destConnectionStatus = el('destConnectionStatus');
    const migrateSchemaCheckbox = el('migrateSchemaCheckbox');
    const migrationTablesList = el('migrationTablesList');
    const startMigrationBtn = el('startMigrationBtn');
    const migrationLog = el('migrationLog');

    exportAllSqlBtn.addEventListener('click', () => exportAllTables('sql'));
    exportAllCsvBtn.addEventListener('click', () => exportAllTables('csv'));
    exportAllXlsxBtn.addEventListener('click', () => exportAllTables('xlsx'));

    function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞...', showSpinner = true, showProgress = false) {
        loadingMessageEl.textContent = message;
        loadingSpinnerSection.style.display = showSpinner ? 'flex' : 'none';
        exportProgressContainer.style.display = showProgress ? 'block' : 'none';
        loadingOverlay.classList.remove('hidden');
        if (showProgress) {
            pauseExportBtn.textContent = isExportPaused ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '–ü–∞—É–∑–∞';
            pauseExportBtn.style.display = 'inline-block';
            cancelExportBtn.style.display = 'inline-block';
        } else {
            pauseExportBtn.style.display = 'none';
            cancelExportBtn.style.display = 'none';
        }
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
        isExportProcessActive = false; isExportPaused = false;
        if (pauseResolver) { pauseResolver(); pauseResolver = null; }
        pauseExportBtn.style.display = 'none'; cancelExportBtn.style.display = 'none';
    }

    function displayStatus(message, type = 'info') {
        statusMessagesEl.textContent = message;
        statusMessagesEl.className = 'mt-4 p-3 rounded fixed bottom-4 right-4 z-[9998] max-w-md shadow-lg ';
        const types = { error: ['bg-red-100', 'text-red-700', 'border', 'border-red-400'], success: ['bg-green-100', 'text-green-700', 'border', 'border-green-400'], warning: ['bg-yellow-100', 'text-yellow-700', 'border', 'border-yellow-400'], info: ['bg-blue-100', 'text-blue-700', 'border', 'border-blue-400'] };
        statusMessagesEl.classList.add(...(types[type] || types.info));
        setTimeout(() => { statusMessagesEl.textContent = ''; statusMessagesEl.className = 'mt-4 p-3 rounded fixed bottom-4 right-4 z-[9998] max-w-md'; }, 7000);
    }

    function downloadFile(filename, content, contentType) {
        const blob = (content instanceof Blob) ? content : new Blob([content], { type: contentType });
        saveAs(blob, filename);
    }

    toggleSidebarButton.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        requestAnimationFrame(() => {
            const sidebarWidth = sidebar.classList.contains('-translate-x-full') ? '0px' : `${sidebar.offsetWidth}px`;
            mainContent.style.marginLeft = sidebarWidth;
        });
    });

    function adjustMainContentMargin() {
        if (window.innerWidth < 768) { sidebar.classList.add('-translate-x-full'); mainContent.style.marginLeft = '0'; }
        else { sidebar.classList.remove('-translate-x-full'); mainContent.style.marginLeft = `${sidebar.offsetWidth}px`; }
    }
    window.addEventListener('resize', adjustMainContentMargin);

    copySqlButton.addEventListener('click', () => {
        const textToCopy = sqlScriptContentEl.textContent || sqlScriptContentEl.innerText;
        if (navigator.clipboard?.writeText) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => displayStatus('SQL —Å–∫—Ä–∏–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success'))
                .catch(err => { displayStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.', 'error'); });
        } else {
            const selection = window.getSelection(); const range = document.createRange();
            range.selectNodeContents(sqlScriptContentEl); selection.removeAllRanges(); selection.addRange(range);
            try { document.execCommand('copy'); displayStatus('SQL —Å–∫—Ä–∏–ø—Ç –≤—ã–¥–µ–ª–µ–Ω (–Ω–∞–∂–º–∏—Ç–µ Ctrl+C).', 'info'); }
            catch (err) { displayStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.', 'error'); }
            selection.removeAllRanges();
        }
    });

    function obfuscateData(data) {
        try {
            const stringifiedData = JSON.stringify(data);
            if (typeof TextEncoder === "undefined") { return btoa(unescape(encodeURIComponent(stringifiedData))); }
            const utf8Bytes = new TextEncoder().encode(stringifiedData);
            let binaryString = '';
            utf8Bytes.forEach((byte) => { binaryString += String.fromCharCode(byte); });
            return btoa(binaryString);
        } catch (e) { console.error("Obfuscation failed:", e); throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è."); }
    }

    function deobfuscateData(obfuscatedString) {
        try {
            let decodedString;
            if (typeof TextDecoder === "undefined") { decodedString = decodeURIComponent(escape(atob(obfuscatedString))); }
            else {
                const binaryString = atob(obfuscatedString);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
                decodedString = new TextDecoder().decode(bytes);
            }
            return JSON.parse(decodedString);
        } catch (e) { console.error("Deobfuscation failed:", e); throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç."); }
    }

    connectionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = connNameInput.value.trim();
        const url = connUrlInput.value.trim();
        const key = connKeyInput.value.trim();
        if (!name || !url || !key) { displayStatus('–í—Å–µ –ø–æ–ª—è (–ò–º—è, URL, –ö–ª—é—á) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'warning'); return; }
        try { new URL(url); } catch (_) { displayStatus('–ù–µ–≤–µ—Ä–Ω—ã–π URL.', 'error'); return; }
        connectToSupabase({ name, url, key });
    });

    saveConnectionFileButton.addEventListener('click', () => {
        const name = connNameInput.value.trim();
        const url = connUrlInput.value.trim();
        const key = connKeyInput.value.trim();
        if (!name || !url || !key) { displayStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è, URL –∏ –ö–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'warning'); return; }
        try { new URL(url); } catch (_) { displayStatus('–ù–µ–≤–µ—Ä–Ω—ã–π URL –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'error'); return; }
        const connectionData = { url, key };
        try {
            const obfuscatedContent = obfuscateData(connectionData);
            const fileName = name.replace(/[^a-z0-9_\-.]/gi, '_') + '.spb';
            downloadFile(fileName, obfuscatedContent, 'application/octet-stream');
            displayStatus(`–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: ${fileName}`, 'success');
        } catch (error) { displayStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${error.message}`, 'error'); }
    });

     loadConnectionFileButton.addEventListener('click', async () => {
        try {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.spb';
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const obfuscatedContent = e.target.result;
                            const connectionData = deobfuscateData(obfuscatedContent);
                            if (connectionData && connectionData.url && connectionData.key) {
                                const connectionName = file.name.replace(/\.spb$/i, '');
                                connNameInput.value = connectionName;
                                connUrlInput.value = connectionData.url;
                                connKeyInput.value = connectionData.key;
                                await connectToSupabase({
                                    name: connectionName,
                                    url: connectionData.url,
                                    key: connectionData.key
                                });
                            } else {
                                throw new Error("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö URL –∏ –ö–ª—é—á–∞.");
                            }
                        } catch (loadErr) {
                            displayStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –∞–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${loadErr.message}`, 'error');
                            showDisconnectedState();
                        }
                    };
                    reader.onerror = () => {
                        displayStatus(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${reader.error}`, 'error');
                        showDisconnectedState();
                    }
                    reader.readAsText(file);
                }
            };
            input.click();
        } catch (err) {
            displayStatus(`–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞: ${err.message}`, 'error');
            showDisconnectedState();
        }
    });

    async function connectToSupabase(connection) {
        showLoading('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
        try {
            if (supabaseClient?.removeAllChannels) supabaseClient.removeAllChannels();
            supabaseClient = createClient(connection.url, connection.key, { auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false } });
            const { error: testErrorRpc } = await supabaseClient.rpc('test_connection_schema');
            if (testErrorRpc) {
                let rpcErrorMsg = `–û—à–∏–±–∫–∞ RPC 'test_connection_schema': ${testErrorRpc.message}.`;
                if (testErrorRpc.code === '42883' || testErrorRpc.message?.toLowerCase().includes("does not exist")) rpcErrorMsg += ` –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (—Å–º. 'SQL –ù–∞—Å—Ç—Ä–æ–π–∫–∞').`;
                throw new Error(rpcErrorMsg);
            }
            currentConnectionDetails = connection;
            currentConnectionNameEl.textContent = connection.name;
            welcomeMessageEl.classList.add('hidden');
            dashboardEl.classList.remove('hidden');
            displayStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${connection.name}`, 'success');
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) { toggleSidebarButton.click(); }
            await loadDashboardData();
        } catch (err) {
            supabaseClient = null; currentConnectionDetails = null;
            let errMsg = `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
            if (err.message?.toLowerCase().includes("failed to fetch")) errMsg = `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π URL: ${connection.url}.`;
            else if (err.message?.includes("JWT") || err.status === 401) errMsg = `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Service Role Secret.`;
            displayStatus(errMsg, 'error'); showDisconnectedState();
        } finally { hideLoading(); }
    }

    disconnectButton.addEventListener('click', () => {
        if (supabaseClient?.removeAllChannels) supabaseClient.removeAllChannels();
        supabaseClient = null; currentConnectionDetails = null; showDisconnectedState(); displayStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ.', 'info');
    });

    function showDisconnectedState() {
        dashboardEl.classList.add('hidden'); welcomeMessageEl.classList.remove('hidden');
        tablesListEl.innerHTML = ''; bucketsListEl.innerHTML = ''; currentConnectionNameEl.textContent = '';
        currentlyListedTables = []; globalExportButtons.classList.add('hidden');
    }

    async function loadDashboardData() {
        if (!supabaseClient) return; showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
        try { await Promise.all([loadTables(), loadBuckets()]); }
        catch (err) { displayStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, 'error'); }
        finally { hideLoading(); }
    }

    async function loadTables() {
        tablesListEl.innerHTML = '<p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü...</p>';
        currentlyListedTables = []; globalExportButtons.classList.add('hidden');
        try {
            const { data: tables, error } = await supabaseClient.rpc('get_public_user_tables');
            if (error) {
                let rpcErrorMsg = `–û—à–∏–±–∫–∞ RPC 'get_public_user_tables': ${error.message}.`;
                if (error.code === '42883' || error.message?.toLowerCase().includes("does not exist")) rpcErrorMsg += ` –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (—Å–º. 'SQL –ù–∞—Å—Ç—Ä–æ–π–∫–∞').`;
                throw new Error(rpcErrorMsg);
            }
            if (!tables || tables.length === 0) { tablesListEl.innerHTML = '<p class="text-gray-500">–¢–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>'; return; }
            tablesListEl.innerHTML = '';
            currentlyListedTables = tables.map(t => t.table_name);
            globalExportButtons.classList.remove('hidden');
            tables.forEach(table => {
                const tableName = table.table_name;
                const item = document.createElement('div');
                item.className = 'border p-3 rounded-md bg-gray-50 shadow-sm flex justify-between items-center';
                const titleElem = document.createElement('h4');
                titleElem.className = 'text-lg font-medium text-indigo-700'; titleElem.textContent = tableName;
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-1';
                const createButton = (text, bgColor, handler) => {
                    const btn = document.createElement('button');
                    btn.className = `text-xs ${bgColor} hover:${bgColor.replace('500', '600')} text-white px-2 py-1 rounded`;
                    btn.textContent = text; btn.addEventListener('click', handler); return btn;
                };
                buttonContainer.appendChild(createButton('–ü—Ä–æ—Å–º–æ—Ç—Ä', 'bg-sky-500', () => viewTableData(tableName)));
                buttonContainer.appendChild(createButton('SQL', 'bg-blue-500', () => exportTable(tableName, 'sql')));
                buttonContainer.appendChild(createButton('CSV', 'bg-green-500', () => exportTable(tableName, 'csv')));
                buttonContainer.appendChild(createButton('XLSX', 'bg-teal-500', () => exportTable(tableName, 'xlsx')));
                item.appendChild(titleElem); item.appendChild(buttonContainer); tablesListEl.appendChild(item);
            });
        } catch (err) { tablesListEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü: ${err.message}</p>`; }
    }

    async function loadBuckets() {
        bucketsListEl.innerHTML = '<p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ buckets...</p>';
        try {
            const { data: buckets, error } = await supabaseClient.storage.listBuckets();
            if (error) throw error;
            if (buckets.length === 0) { bucketsListEl.innerHTML = '<p class="text-gray-500">Buckets –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>'; return; }
            bucketsListEl.innerHTML = '';
            buckets.forEach(bucket => {
                const item = document.createElement('div');
                item.className = 'border p-3 rounded-md bg-gray-50 shadow-sm flex justify-between items-center';
                const titleElem = document.createElement('h4');
                titleElem.className = 'text-lg font-medium text-purple-700'; titleElem.textContent = bucket.name;
                const buttonContainer = document.createElement('div'); buttonContainer.className = 'flex space-x-1';
                const createButton = (text, bgColor, handler, title = '') => {
                    const btn = document.createElement('button');
                    btn.className = `text-xs ${bgColor} hover:${bgColor.replace('500', '600').replace('600', '700')} text-white px-2 py-1 rounded`;
                    if (bgColor.includes('yellow') || bgColor.includes('lime')) btn.classList.add('text-black');
                    btn.textContent = text; btn.title = title; btn.addEventListener('click', handler); return btn;
                };
                buttonContainer.appendChild(createButton('–û–±–∑–æ—Ä', 'bg-lime-500', () => viewBucketFiles(bucket.name), '–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –≤ bucket'));
                buttonContainer.appendChild(createButton('–ó–∞–≥—Ä—É–∑–∏—Ç—å', 'bg-purple-500', () => uploadFileToBucket(bucket.name), '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª(—ã) –≤ —ç—Ç–æ—Ç bucket'));
                buttonContainer.appendChild(createButton('–§–∞–π–ª—ã', 'bg-yellow-500', () => exportBucket(bucket.name, 'files'), '–§–∞–π–ª—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–ø–∫—É'));
                buttonContainer.appendChild(createButton('–°–∏–Ω—Ö—Ä.', 'bg-cyan-500', () => syncBucket(bucket.name), '–°–∫–∞—á–∞—Ç—å –∏–∑ bucket —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ)'));
                buttonContainer.appendChild(createButton('ZIP', 'bg-orange-500', () => exportBucket(bucket.name, 'zip'), '–í–µ—Å—å bucket –≤ ZIP'));
                item.appendChild(titleElem); item.appendChild(buttonContainer); bucketsListEl.appendChild(item);
            });
        } catch (err) { bucketsListEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ buckets: ${err.message}</p>`; }
    }

    async function uploadFileToBucket(bucketName, filesToUploadFromDrop = null, dropTargetBucket = null) {
        if (!supabaseClient || !currentConnectionDetails) {
            displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error');
            return;
        }

        const effectiveBucketName = dropTargetBucket || bucketName;
        let filesToProcess = filesToUploadFromDrop;

        if (!filesToProcess) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.style.display = 'none';

            const files = await new Promise(resolve => {
                fileInput.onchange = (event) => {
                    document.body.removeChild(fileInput);
                    resolve(event.target.files);
                };
                fileInput.oncancel = () => {
                    document.body.removeChild(fileInput);
                    resolve(null);
                };
                document.body.appendChild(fileInput);
                fileInput.click();
            });

            if (!files || files.length === 0) {
                displayStatus('–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –∏–ª–∏ –≤—ã–±–æ—Ä –æ—Ç–º–µ–Ω–µ–Ω.', 'info');
                return;
            }
            filesToProcess = Array.from(files);
        }

        if (!filesToProcess || filesToProcess.length === 0) return;

        let basePathInBucket = "";
        if (filesToProcess.length > 1 && !filesToUploadFromDrop) {
            basePathInBucket = prompt(`–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –≤ bucket "${effectiveBucketName}" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ ${filesToProcess.length} —Ñ–∞–π–ª–æ–≤ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∫–æ—Ä–Ω—è bucket):`, "");
            if (basePathInBucket === null) {
                displayStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.', 'info');
                return;
            }
            basePathInBucket = basePathInBucket.trim().replace(/\\/g, '/').replace(/^\/+|\/+$/g, '');
            if (basePathInBucket) {
                basePathInBucket += '/';
            }
        }

        let successfulUploads = 0;
        let failedUploads = 0;
        const totalFiles = filesToProcess.length;

        currentExportAbortController = new AbortController();
        isExportProcessActive = true;
        showLoading(`–ó–∞–≥—Ä—É–∑–∫–∞ ${totalFiles} —Ñ–∞–π–ª(–æ–≤) –≤ bucket "${effectiveBucketName}"...`, false, true);
        exportProgressBar.value = 0;
        exportProgressBar.max = totalFiles;

        for (let i = 0; i < totalFiles; i++) {
            if (currentExportAbortController.signal.aborted) {
                failedUploads += (totalFiles - i);
                break;
            }
            const file = filesToProcess[i];
            exportProgressMessage.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${file.name} (${i + 1}/${totalFiles})...`;

            let filePathInBucket;
            if (filesToUploadFromDrop) {
                filePathInBucket = file.name;
            } else if (totalFiles > 1) {
                filePathInBucket = basePathInBucket + file.name;
            } else {
                const singleFilePath = prompt(`–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∏ –∏–º—è —Ñ–∞–π–ª–∞ –≤ bucket "${effectiveBucketName}" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "folder/image.png" –∏–ª–∏ "image.png"):`, file.name);
                if (singleFilePath === null) {
                    displayStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ${file.name} –æ—Ç–º–µ–Ω–µ–Ω–∞.`, 'info');
                    failedUploads++;
                    exportProgressBar.value = i + 1;
                    continue;
                }
                filePathInBucket = singleFilePath.trim().replace(/\\/g, '/').replace(/^\/+|\/+$/g, '');
                if (!filePathInBucket) {
                    displayStatus(`–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É ${file.name} –≤ bucket –Ω–µ —É–∫–∞–∑–∞–Ω. –ü—Ä–æ–ø—É—Å–∫.`, 'warning');
                    failedUploads++;
                    exportProgressBar.value = i + 1;
                    continue;
                }
            }
            filePathInBucket = filePathInBucket.replace(/^\/+|\/+$/g, '');

            try {
                const { error: initialUploadError } = await supabaseClient.storage
                    .from(effectiveBucketName)
                    .upload(filePathInBucket, file, { upsert: false, signal: currentExportAbortController.signal });

                if (initialUploadError) {
                    if (initialUploadError.name === 'AbortError') throw initialUploadError;
                    if (initialUploadError.message && (initialUploadError.message.includes("The resource already exists") || initialUploadError.statusCode === '409' || initialUploadError.error === 'Duplicate')) {
                        const overwrite = confirm(`–§–∞–π–ª "${filePathInBucket}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ bucket "${effectiveBucketName}". –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?`);
                        if (overwrite) {
                            exportProgressMessage.textContent = `–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å ${file.name}...`;
                            const { error: upsertError } = await supabaseClient.storage
                                .from(effectiveBucketName)
                                .upload(filePathInBucket, file, { upsert: true, signal: currentExportAbortController.signal });
                            if (upsertError) { if (upsertError.name === 'AbortError') throw upsertError; throw upsertError; }
                            successfulUploads++;
                        } else {
                            failedUploads++;
                        }
                    } else {
                        throw initialUploadError;
                    }
                } else {
                    successfulUploads++;
                }
            } catch (uploadError) {
                if (uploadError.name === 'AbortError') {
                    failedUploads += (totalFiles - i);
                    break;
                }
                displayStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${uploadError.message}`, 'error');
                failedUploads++;
            }
            exportProgressBar.value = i + 1;
            await new Promise(r => setTimeout(r, 10));
        }

        hideLoading();
        isExportProcessActive = false;
        currentExportAbortController = null;
        let summaryMessage = "";
        if (successfulUploads > 0) summaryMessage += `–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${successfulUploads}. `;
        if (failedUploads > 0) summaryMessage += `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ${failedUploads}.`;
         if (currentExportAbortController && currentExportAbortController.signal.aborted && (totalFiles - successfulUploads - failedUploads > 0)) {
            summaryMessage += ` –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ–Ω–µ–Ω—ã.`;
        }

        if (summaryMessage) {
            displayStatus(summaryMessage, failedUploads > 0 && successfulUploads === 0 ? 'error' : (failedUploads > 0 ? 'warning' : 'success'));
        }

        if (filesToUploadFromDrop && successfulUploads > 0) {
            await viewBucketFiles(effectiveBucketName);
        }
    }


    pauseExportBtn.addEventListener('click', () => {
        isExportPaused = !isExportPaused;
        pauseExportBtn.textContent = isExportPaused ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '–ü–∞—É–∑–∞';
        if (!isExportPaused && pauseResolver) { pauseResolver(); pauseResolver = null; }
        if (isExportPaused && isExportProcessActive) { loadingMessageEl.textContent = `(–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) ${exportProgressMessage.textContent}`; }
        else if (!isExportPaused && isExportProcessActive) { loadingMessageEl.textContent = exportProgressMessage.textContent; }
    });

    cancelExportBtn.addEventListener('click', () => {
        if (currentExportAbortController) { currentExportAbortController.abort(); }
        isExportProcessActive = false; isExportPaused = false;
        if (pauseResolver) { pauseResolver(); pauseResolver = null; }
        hideLoading(); displayStatus('–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.', 'warning');
    });

    async function checkPauseAndAbort(progressMsgUpdateFn) {
        if (currentExportAbortController && currentExportAbortController.signal.aborted) { throw { name: 'AbortError', message: 'cancelled' }; }
        if (isExportPaused) {
            const originalMessage = exportProgressMessage.textContent;
            const loadingOverlayVisible = !loadingOverlay.classList.contains('hidden');
            if (loadingOverlayVisible) loadingMessageEl.textContent = `(–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) ${originalMessage}`;
            exportProgressMessage.textContent = `(–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) ${originalMessage}`;
            await new Promise(resolve => { pauseResolver = resolve; });
            if (currentExportAbortController && currentExportAbortController.signal.aborted) { throw { name: 'AbortError', message: 'cancelled_during_pause' }; }
            exportProgressMessage.textContent = originalMessage;
            if (loadingOverlayVisible) loadingMessageEl.textContent = originalMessage;
            if (progressMsgUpdateFn) progressMsgUpdateFn();
        }
    }

    async function saveFileToDirectory(baseDirHandle, fullPathInBucket, blob) {
        const pathParts = fullPathInBucket.split('/').filter(part => part.length > 0);
        const fileName = pathParts.pop();
        let currentDirHandle = baseDirHandle;
        for (const part of pathParts) { currentDirHandle = await currentDirHandle.getDirectoryHandle(part, { create: true }); }
        const fileHandle = await currentDirHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob); await writable.close();
    }

    async function exportTable(tableName, format, returnContentOnly = false) {
        if (!supabaseClient || !currentConnectionDetails) { if (!returnContentOnly) displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error'); return null; }
        let localAbortController;
        if (!returnContentOnly) {
            isExportProcessActive = true; isExportPaused = false;
            localAbortController = new AbortController(); currentExportAbortController = localAbortController;
            showLoading(`–≠–∫—Å–ø–æ—Ä—Ç ${tableName} –≤ ${format.toUpperCase()}...`, false, true);
            exportProgressMessage.textContent = `–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É ${tableName}...`;
            exportProgressBar.removeAttribute('value'); exportProgressBar.removeAttribute('max');
        } else { localAbortController = currentExportAbortController; }
        try {
            let allData = []; let offset = 0; const pageSize = 1000; let hasMore = true; let pageCount = 0; let totalRowsFetched = 0;
            const updateProgressMsg = () => { if (!returnContentOnly) exportProgressMessage.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${tableName}: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageCount + 1}, –ø–æ–ª—É—á–µ–Ω–æ ${totalRowsFetched} —Å—Ç—Ä–æ–∫...`; };
            updateProgressMsg();
            while (hasMore) {
                if (!returnContentOnly) await checkPauseAndAbort(updateProgressMsg);
                else if (isExportPaused && pauseResolver) await new Promise(r => {pauseResolver = r});
                const { data: chunk, error } = await supabaseClient.from(tableName).select('*', { head: false, count: 'none' })
                    .range(offset, offset + pageSize - 1).abortSignal(localAbortController?.signal);
                if (error) { if (error.name === 'AbortError') throw error; throw error; }
                if (chunk && chunk.length > 0) {
                    allData.push(...chunk); totalRowsFetched += chunk.length; offset += pageSize; pageCount++;
                    if (chunk.length < pageSize) hasMore = false;
                } else { hasMore = false; }
                updateProgressMsg();
                if (hasMore && !returnContentOnly) await new Promise(resolve => setTimeout(resolve, 30));
            }
            const data = allData;
            if (data === null || data.length === 0) {
                if (!returnContentOnly) displayStatus(`–¢–∞–±–ª–∏—Ü–∞ "${tableName}" –ø—É—Å—Ç–∞.`, 'info');
                return returnContentOnly ? { name: tableName, content: null, format: format } : null;
            }
            if (!returnContentOnly) { exportProgressMessage.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ ${data.length} —Å—Ç—Ä–æ–∫ –¥–ª—è ${tableName} –≤ ${format.toUpperCase()}...`; exportProgressBar.removeAttribute('value'); }
            let fileContent, contentType, arrayBufferContent;
            const connNameSafe = currentConnectionDetails.name.replace(/[^a-z0-9]/gi, '_');
            let baseFileName = `${connNameSafe}_${tableName}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}`;
            let actualFileName;
            switch (format) {
                case 'csv':
                    const headers = Object.keys(data[0]);
                    const csvRows = [headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',')];
                    data.forEach(row => csvRows.push(headers.map(header => {
                        let val = row[header];
                        if (val === null || typeof val === 'undefined') return '';
                        if (typeof val === 'object') val = JSON.stringify(val);
                        return `"${(''+val).replace(/"/g, '""')}"`;
                    }).join(',')));
                    fileContent = csvRows.join('\n'); actualFileName = `${baseFileName}.csv`; contentType = 'text/csv;charset=utf-8;';
                    break;
                case 'sql':
                    let sql = `TRUNCATE TABLE "public"."${tableName}" RESTART IDENTITY CASCADE;\n\n`;
                    const BATCH_SIZE_SQL = 500;
                    for (let i = 0; i < data.length; i += BATCH_SIZE_SQL) {
                        if (!returnContentOnly) await checkPauseAndAbort(() => { exportProgressMessage.textContent = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –¥–ª—è ${tableName}: ${i}/${data.length} —Å—Ç—Ä–æ–∫...`; });
                        else if (isExportPaused && pauseResolver) await new Promise(r => {pauseResolver = r});
                        const batch = data.slice(i, i + BATCH_SIZE_SQL);
                        batch.forEach(row => {
                            const columns = Object.keys(row).map(col => `"${col}"`).join(', ');
                            const values = Object.values(row).map(val => {
                                if (val === null) return 'NULL';
                                if (typeof val === 'string') return `'${val.replace(/'/g, "''")}'`;
                                if (typeof val === 'boolean') return val ? 'TRUE' : 'FALSE';
                                if (val instanceof Date) return `'${val.toISOString()}'`;
                                if (typeof val === 'object') return `'${JSON.stringify(val).replace(/'/g, "''")}'`;
                                return val;
                            }).join(', ');
                            sql += `INSERT INTO "public"."${tableName}" (${columns}) VALUES (${values});\n`;
                        });
                        if (!returnContentOnly) await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    fileContent = sql; actualFileName = `${baseFileName}.sql`; contentType = 'application/sql;charset=utf-8;';
                    break;
                case 'xlsx':
                    const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, tableName.substring(0,30).replace(/[\\/?*\[\]:]/g, '_'));
                    arrayBufferContent = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    actualFileName = `${baseFileName}.xlsx`; contentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                    break;
                default: if (!returnContentOnly) displayStatus(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: ${format}`, 'error'); return null;
            }
            if (returnContentOnly) { return { name: tableName, fileName: actualFileName, content: format === 'xlsx' ? arrayBufferContent : fileContent, format: format, contentType: contentType }; }
            else { downloadFile(actualFileName, format === 'xlsx' ? arrayBufferContent : fileContent, contentType); displayStatus(`–¢–∞–±–ª–∏—Ü–∞ ${tableName} (${data.length} —Å—Ç—Ä–æ–∫) —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞.`, 'success'); }
        } catch (err) {
            if (err.name === 'AbortError' || err.message?.startsWith('cancelled')) { if (!returnContentOnly) displayStatus(`–≠–∫—Å–ø–æ—Ä—Ç ${tableName} –æ—Ç–º–µ–Ω–µ–Ω.`, 'warning'); }
            else if (!returnContentOnly) { displayStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ ${tableName}: ${err.message}`, 'error'); }
            return null;
        } finally { if (!returnContentOnly) { hideLoading(); currentExportAbortController = null; } }
    }

    async function exportAllTables(format) {
        if (currentlyListedTables.length === 0) { displayStatus('–ù–µ—Ç —Ç–∞–±–ª–∏—Ü –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.', 'info'); return; }
        if (!supabaseClient || !currentConnectionDetails) { displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error'); return; }
        isExportProcessActive = true; isExportPaused = false; currentExportAbortController = new AbortController();
        showLoading(`–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ ${format.toUpperCase()}...`, false, true);
        exportProgressMessage.textContent = `–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É ${currentlyListedTables.length} —Ç–∞–±–ª–∏—Ü...`;
        exportProgressBar.value = 0; exportProgressBar.max = currentlyListedTables.length;
        const zip = new JSZip(); let exportedCount = 0;
        try {
            for (const tableName of currentlyListedTables) {
                await checkPauseAndAbort(() => { exportProgressMessage.textContent = `–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã: ${tableName} (${currentlyListedTables.indexOf(tableName) + 1}/${currentlyListedTables.length})`; });
                exportProgressMessage.textContent = `–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã: ${tableName} (${currentlyListedTables.indexOf(tableName) + 1}/${currentlyListedTables.length})`;
                const exportResult = await exportTable(tableName, format, true);
                if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_batch_table' };
                if (exportResult && exportResult.content) { zip.file(exportResult.fileName, exportResult.content); exportedCount++; }
                exportProgressBar.value = currentlyListedTables.indexOf(tableName) + 1;
                await new Promise(resolve => setTimeout(resolve, 30));
            }
            if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_before_zip' };
            if (exportedCount === 0 && !currentExportAbortController.signal.aborted) { displayStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.', 'warning'); hideLoading(); return; }
            exportProgressMessage.textContent = `–°–æ–∑–¥–∞–Ω–∏–µ ZIP (${exportedCount} —Ñ–∞–π–ª–æ–≤)...`; exportProgressBar.removeAttribute('value');
            const zipBlob = await zip.generateAsync(
                { type: "blob", compression: "DEFLATE", compressionOptions: { level: 6 } },
                (metadata) => {
                    if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_during_zip_generation' };
                    exportProgressMessage.textContent = `–°–∂–∞—Ç–∏–µ ZIP: ${metadata.percent.toFixed(0)}%`;
                    if (exportProgressBar.max !== 100) exportProgressBar.max = 100; exportProgressBar.value = metadata.percent;
                }
            );
            if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_after_zip_generation' };
            const connNameSafe = currentConnectionDetails.name.replace(/[^a-z0-9]/gi, '_');
            const zipFileName = `${connNameSafe}_all_tables_${format}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.zip`;
            saveAs(zipBlob, zipFileName); displayStatus(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportedCount} —Ç–∞–±–ª–∏—Ü –≤ ${zipFileName}.`, 'success');
        } catch (err) {
            if (err.name === 'AbortError' || err.message?.startsWith('cancelled')) { displayStatus('–ü–∞–∫–µ—Ç–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω–µ–Ω.', 'warning'); }
            else { displayStatus(`–û—à–∏–±–∫–∞ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${err.message}`, 'error'); }
        } finally { hideLoading(); currentExportAbortController = null; }
    }

    async function exportBucket(bucketName, mode) {
        if (!supabaseClient || !currentConnectionDetails) { displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error'); return; }
        isExportProcessActive = true; isExportPaused = false; currentExportAbortController = new AbortController();
        showLoading(`–≠–∫—Å–ø–æ—Ä—Ç bucket ${bucketName}...`, false, true);
        exportProgressMessage.textContent = `–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑ ${bucketName}...`;
        exportProgressBar.value = 0; exportProgressBar.removeAttribute('max');
        try {
            let allFiles = [];
            const updateListProgress = () => { exportProgressMessage.textContent = `–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑ ${bucketName}: –Ω–∞–π–¥–µ–Ω–æ ${allFiles.length}...`; };
            async function listAllFilesRecursive(currentPath = '') {
                if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                await checkPauseAndAbort(updateListProgress);
                let localOffset = 0; const limit = 100; let localHasMore = true;
                while(localHasMore) {
                    if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                    await checkPauseAndAbort(updateListProgress);
                    const { data: listedFiles, error: listError } = await supabaseClient.storage.from(bucketName)
                        .list(currentPath, { limit, offset: localOffset, sortBy: { column: 'name', order: 'asc' }, signal: currentExportAbortController.signal });
                    if (listError) { if (listError.name === 'AbortError') throw listError; throw listError; }
                    for (const file of listedFiles) {
                        if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                        await checkPauseAndAbort(updateListProgress);
                        const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        if (file.id === null) await listAllFilesRecursive(filePath); else allFiles.push({ ...file, fullPath: filePath });
                        updateListProgress();
                    }
                    localHasMore = listedFiles.length >= limit; localOffset += limit;
                     if (localHasMore) await new Promise(r => setTimeout(r, 10));
                }
            }
            await listAllFilesRecursive();
            if (allFiles.length === 0 && !currentExportAbortController.signal.aborted) { displayStatus(`Bucket "${bucketName}" –ø—É—Å—Ç.`, 'info'); hideLoading(); return; }
            if (currentExportAbortController.signal.aborted) throw {name: 'AbortError', message: 'cancelled_listing_bucket'};
            exportProgressBar.max = allFiles.length;
            if (mode === 'files') {
                let chosenDirectoryHandle;
                let writePermissionInitiallyGranted = false;

                try {
                    if (!window.showDirectoryPicker) {
                        displayStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ –æ–¥–Ω–æ–º—É.', 'warning');
                    } else {
                        const handle = await window.showDirectoryPicker();
                        if (handle) {
                            chosenDirectoryHandle = handle;
                            if (await handle.queryPermission({ mode: 'readwrite' }) === 'granted') {
                                writePermissionInitiallyGranted = true;
                            } else {
                                if (await handle.requestPermission({ mode: 'readwrite' }) === 'granted') {
                                    writePermissionInitiallyGranted = true;
                                } else {
                                    displayStatus('–ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã. –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ –æ–¥–Ω–æ–º—É (saveAs).', 'warning');
                                }
                            }
                        }
                    }
                } catch (err) {
                    if (err.name === 'AbortError' || err.message.toLowerCase().includes('user aborted') || err.message.toLowerCase().includes('user cancel')) {
                        displayStatus('–í—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω.', 'info'); hideLoading(); return;
                    }
                    displayStatus(`–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–ª–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∞–≤: ${err.message}. –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ –æ–¥–Ω–æ–º—É.`, 'warning');
                    chosenDirectoryHandle = null;
                    writePermissionInitiallyGranted = false;
                }

                let downloadedCount = 0;
                const updateDownloadProgress = () => { exportProgressMessage.textContent = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${allFiles[downloadedCount]?.name || ''} (${downloadedCount + 1}/${allFiles.length})`; };
                for (const file of allFiles) {
                    await checkPauseAndAbort(updateDownloadProgress); updateDownloadProgress();
                    try {
                        const { data: blob, error: downloadError } = await supabaseClient.storage.from(bucketName)
                            .download(file.fullPath, { signal: currentExportAbortController.signal });
                        if (downloadError) { if (downloadError.name === 'AbortError') throw downloadError; console.warn(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ${file.fullPath}: ${downloadError.message}`); continue; }
                        if (chosenDirectoryHandle && writePermissionInitiallyGranted) {
                            try { await saveFileToDirectory(chosenDirectoryHandle, file.fullPath, blob); }
                            catch (saveError) { displayStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä. ${file.name} –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${saveError.message}. –ü–æ–ø—ã—Ç–∫–∞ saveAs.`, 'warning'); saveAs(blob, file.fullPath.split('/').pop()); }
                        } else { saveAs(blob, file.fullPath.split('/').pop()); }
                        downloadedCount++; exportProgressBar.value = downloadedCount;
                    } catch (err) { if (err.name === 'AbortError') throw err; console.warn(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.fullPath}: ${err.message}`); }
                    await new Promise(r => setTimeout(r, 50));
                }
                if (!currentExportAbortController.signal.aborted) displayStatus(`–°–∫–∞—á–∞–Ω–æ ${downloadedCount} —Ñ–∞–π–ª–æ–≤.`, 'success');
            } else if (mode === 'zip') {
                const zip = new JSZip(); let filesAddedToZip = 0;
                const updateZipAddProgress = () => { exportProgressMessage.textContent = `–í ZIP: ${allFiles[filesAddedToZip]?.name || ''} (${filesAddedToZip + 1}/${allFiles.length})`; };
                for (const file of allFiles) {
                    await checkPauseAndAbort(updateZipAddProgress); updateZipAddProgress();
                    try {
                        const { data: blob, error: downloadError } = await supabaseClient.storage.from(bucketName)
                            .download(file.fullPath, { signal: currentExportAbortController.signal });
                        if (downloadError) { if (downloadError.name === 'AbortError') throw downloadError; console.warn(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ${file.fullPath} –¥–ª—è ZIP: ${downloadError.message}`); continue; }
                        zip.file(file.fullPath, blob, { binary: true }); filesAddedToZip++; exportProgressBar.value = filesAddedToZip;
                    } catch (err) { if (err.name === 'AbortError') throw err; console.warn(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ${file.fullPath} –≤ ZIP: ${err.message}`); }
                     await new Promise(r => setTimeout(r, 10));
                }
                if (filesAddedToZip === 0 && !currentExportAbortController.signal.aborted) { displayStatus(`–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è ZIP.`, 'info'); hideLoading(); return; }
                if (currentExportAbortController.signal.aborted) throw {name: 'AbortError', message: 'cancelled_before_bucket_zip'};
                exportProgressMessage.textContent = `–°–æ–∑–¥–∞–Ω–∏–µ ZIP (${filesAddedToZip} —Ñ–∞–π–ª–æ–≤)...`; exportProgressBar.removeAttribute('value');
                const content = await zip.generateAsync(
                    { type: "blob", compression: "DEFLATE", compressionOptions: { level: 6 } },
                    (metadata) => {
                        if (currentExportAbortController.signal.aborted) throw {name: 'AbortError', message: 'cancelled_during_bucket_zip_generation'};
                        exportProgressMessage.textContent = `–°–∂–∞—Ç–∏–µ ZIP: ${metadata.percent.toFixed(0)}%`;
                        if (exportProgressBar.max !== 100) exportProgressBar.max = 100; exportProgressBar.value = metadata.percent;
                    }
                );
                if (currentExportAbortController.signal.aborted) throw {name: 'AbortError', message: 'cancelled_after_bucket_zip_generation'};
                const connNameSafe = currentConnectionDetails.name.replace(/[^a-z0-9]/gi, '_');
                const zipFileName = `${connNameSafe}_${bucketName}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.zip`;
                saveAs(content, zipFileName); displayStatus(`Bucket ${bucketName} —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ ZIP.`, 'success');
            }
        } catch (err) {
             if (err.name === 'AbortError' || err.message?.startsWith('cancelled')) { displayStatus('–≠–∫—Å–ø–æ—Ä—Ç bucket –æ—Ç–º–µ–Ω–µ–Ω.', 'warning'); }
             else { displayStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ bucket: ${err.message}`, 'error'); }
        } finally { hideLoading(); currentExportAbortController = null; }
    }

    async function syncBucket(bucketName) {
        if (!supabaseClient || !currentConnectionDetails) {
            displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error');
            return;
        }

        let localFileRelativePaths = [];
        let chosenDirectoryHandle = null;
        const tempInputId = 'syncBucketDirectoryInput';

        try {
            displayStatus("1/2: –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å—é–¥–∞ –∂–µ.", "info");

            if (!window.showDirectoryPicker) {
                const selectedFiles = await new Promise((resolve) => {
                    let fileInput = document.getElementById(tempInputId);
                    if (fileInput) fileInput.remove();

                    fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.webkitdirectory = true;
                    fileInput.mozdirectory = true;
                    fileInput.directory = true;
                    fileInput.style.display = 'none';
                    fileInput.id = tempInputId;
                    document.body.appendChild(fileInput);

                    let filesSelectedProcessed = false;
                    const cleanupAndResolve = (value) => {
                        if (filesSelectedProcessed) return;
                        filesSelectedProcessed = true;
                        if (document.getElementById(tempInputId)) document.getElementById(tempInputId).remove();
                        window.removeEventListener('focus', focusHandler);
                        resolve(value);
                    };
                    fileInput.onchange = (event) => {
                        cleanupAndResolve(Array.from(event.target.files));
                        event.target.value = null;
                    };
                    fileInput.oncancel = () => cleanupAndResolve([]);
                    const focusHandler = () => {
                        setTimeout(() => { if (!filesSelectedProcessed) cleanupAndResolve([]); }, 500);
                    };
                    window.addEventListener('focus', focusHandler, { once: true });
                    fileInput.click();
                });

                if (selectedFiles.length === 0) {
                    displayStatus('–ü–∞–ø–∫–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∏–ª–∏ –≤—ã–±–æ—Ä –æ—Ç–º–µ–Ω–µ–Ω. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∞.', 'info');
                    return;
                }
                localFileRelativePaths = selectedFiles.map(f => f.webkitRelativePath || f.name);
                 displayStatus(`–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${localFileRelativePaths.length} —Ñ–∞–π–ª–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ (—á–µ—Ä–µ–∑ input[type=file]).`, 'success');

            } else {
                const handle = await window.showDirectoryPicker();
                if (!handle) {
                    displayStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ö—ç–Ω–¥–ª –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∞.', 'error');
                    return;
                }
                chosenDirectoryHandle = handle;

                let canWriteToHandle = false;
                if (await chosenDirectoryHandle.queryPermission({ mode: 'readwrite' }) === 'granted') {
                    canWriteToHandle = true;
                } else {
                    if (await chosenDirectoryHandle.requestPermission({ mode: 'readwrite' }) === 'granted') {
                        canWriteToHandle = true;
                    }
                }
                window.syncCanWriteToHandle = canWriteToHandle;

                if (!window.syncCanWriteToHandle) {
                    displayStatus('–ü—Ä–∞–≤–∞ –Ω–∞ –ó–ê–ü–ò–°–¨ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω—ã, –Ω–æ –ù–û–í–´–ï —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–∫–∞—á–∞–Ω—ã —á–µ—Ä–µ–∑ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫".', 'warning');
                }

                async function getFilesInDirectory(dirHandle, currentPath = "") {
                    const files = [];
                    for await (const entry of dirHandle.values()) {
                        const entryPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;
                        if (entry.kind === 'file') {
                            files.push(entryPath);
                        } else if (entry.kind === 'directory') {
                            const subDirHandle = await dirHandle.getDirectoryHandle(entry.name);
                            files.push(...await getFilesInDirectory(subDirHandle, entryPath));
                        }
                    }
                    return files;
                }
                try {
                    localFileRelativePaths = await getFilesInDirectory(chosenDirectoryHandle);
                    displayStatus(`–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${localFileRelativePaths.length} —Ñ–∞–π–ª–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ "${chosenDirectoryHandle.name}".`, 'success');
                } catch (readDirError) {
                    displayStatus(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏: ${readDirError.message}. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞.`, 'error');
                    return;
                }
            }

        } catch (err) {
            if (err.name === 'AbortError' || err.message.toLowerCase().includes('user aborted') || err.message.toLowerCase().includes('user cancel')) {
                displayStatus('–í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∞.', 'info');
            } else {
                displayStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–∞–ø–∫–∏: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∞.`, 'error');
            }
            if (document.getElementById(tempInputId)) document.getElementById(tempInputId).remove();
            return;
        }

        const proceed = confirm(`2/2: –ó–∞–ø–æ–º–Ω–µ–Ω–æ ${localFileRelativePaths.length} –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è.\n–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑ bucket "${bucketName}" –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —ç—Ç—É –∂–µ –ø–∞–ø–∫—É.\n\n–ù–∞—á–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é?`);

        if (!proceed) {
            displayStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.', 'info');
            return;
        }

        isExportProcessActive = true;
        isExportPaused = false;
        currentExportAbortController = new AbortController();
        showLoading(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è bucket ${bucketName}...`, false, true);
        exportProgressMessage.textContent = `–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ bucket "${bucketName}"...`;
        exportProgressBar.value = 0;
        exportProgressBar.removeAttribute('max');

        try {
            let allBucketFilesInfo = [];
            const updateSyncListProgress = () => {
                exportProgressMessage.textContent = `–ê–Ω–∞–ª–∏–∑ bucket "${bucketName}": –Ω–∞–π–¥–µ–Ω–æ ${allBucketFilesInfo.length} —Ñ–∞–π–ª–æ–≤...`;
            };

            async function listAllFilesRecursiveInner(currentPath = '') {
                if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                await checkPauseAndAbort(updateSyncListProgress);
                let localOffset = 0; const limit = 100; let localHasMore = true;
                while (localHasMore) {
                    if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                    await checkPauseAndAbort(updateSyncListProgress);
                    const { data: listedFiles, error: listError } = await supabaseClient.storage.from(bucketName)
                        .list(currentPath, { limit, offset: localOffset, sortBy: { column: 'name', order: 'asc' }, signal: currentExportAbortController.signal });
                    if (listError) { if (listError.name === 'AbortError') throw listError; throw listError; }
                    for (const file of listedFiles) {
                        if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled' };
                        await checkPauseAndAbort(updateSyncListProgress);
                        const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        if (file.id === null) {
                            await listAllFilesRecursiveInner(filePath);
                        } else {
                            allBucketFilesInfo.push({ name: file.name, fullPath: filePath, id: file.id });
                        }
                        updateSyncListProgress();
                    }
                    localHasMore = listedFiles.length >= limit; localOffset += limit;
                    if (localHasMore) await new Promise(r => setTimeout(r, 10));
                }
            }
            await listAllFilesRecursiveInner();
            if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_sync_list' };

            const filesToDownload = allBucketFilesInfo.filter(bucketFile =>
                !localFileRelativePaths.includes(bucketFile.fullPath)
            );

            if (filesToDownload.length === 0 && !currentExportAbortController.signal.aborted) {
                displayStatus(`–í—Å–µ —Ñ–∞–π–ª—ã –∏–∑ bucket "${bucketName}" —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ –∏–ª–∏ bucket –ø—É—Å—Ç.`, 'success');
                hideLoading(); return;
            }
            if (currentExportAbortController.signal.aborted) throw { name: 'AbortError', message: 'cancelled_sync_analysis' };

            exportProgressBar.max = filesToDownload.length;
            let downloadedCount = 0;

            const updateSyncOpProgress = (fileName) => {
                exportProgressMessage.textContent = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞: ${fileName} (${downloadedCount + 1}/${filesToDownload.length})`;
            };

            for (const fileToDownloadInfo of filesToDownload) {
                await checkPauseAndAbort(() => updateSyncOpProgress(fileToDownloadInfo.name));
                updateSyncOpProgress(fileToDownloadInfo.name);
                try {
                    const { data: blob, error: downloadError } = await supabaseClient.storage.from(bucketName)
                        .download(fileToDownloadInfo.fullPath, { signal: currentExportAbortController.signal });

                    if (downloadError) {
                        if (downloadError.name === 'AbortError') throw downloadError;
                        console.warn(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ${fileToDownloadInfo.fullPath}: ${downloadError.message}`);
                        continue;
                    }

                    if (chosenDirectoryHandle && window.syncCanWriteToHandle) {
                        try {
                            await saveFileToDirectory(chosenDirectoryHandle, fileToDownloadInfo.fullPath, blob);
                        }
                        catch (saveError) {
                            displayStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä. ${fileToDownloadInfo.name} –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${saveError.message}. –ü–æ–ø—ã—Ç–∫–∞ saveAs.`, 'warning');
                            saveAs(blob, fileToDownloadInfo.name);
                        }
                    } else {
                        saveAs(blob, fileToDownloadInfo.name);
                    }
                    downloadedCount++; exportProgressBar.value = downloadedCount;
                } catch (err) {
                    if (err.name === 'AbortError') throw err;
                    console.warn(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${fileToDownloadInfo.fullPath}: ${err.message}`);
                }
                await new Promise(r => setTimeout(r, 50));
            }

            if (!currentExportAbortController.signal.aborted) {
                displayStatus(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–∫–∞—á–∞–Ω–æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: ${downloadedCount}.`, 'success');
            }

        } catch (err) {
            if (err.name === 'AbortError' || err.message?.startsWith('cancelled')) {
                displayStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.', 'warning');
            } else {
                displayStatus(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${err.message}`, 'error');
            }
        } finally {
            hideLoading(); currentExportAbortController = null;
            let tempInputElem = document.getElementById(tempInputId);
            if (tempInputElem) tempInputElem.remove();
            delete window.syncCanWriteToHandle;
        }
    }

    function formatFileSize(bytes, decimals = 2) {
        if (bytes === 0 || bytes === null || typeof bytes === 'undefined') return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function formatDate(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            return date.toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            return 'Invalid Date';
        }
    }

    async function fetchAllFilesForView(bucketName, abortSignal) {
        let filesMetadata = [];
        const updateProgress = (count) => {
            if (!loadingOverlay.classList.contains('hidden')) {
                 loadingMessageEl.textContent = `–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ ${bucketName}: –Ω–∞–π–¥–µ–Ω–æ ${count}...`;
            }
        };

        async function listRecursive(currentPath = '') {
            if (abortSignal?.aborted) throw { name: 'AbortError', message: 'cancelled_listing_for_view' };
            let localOffset = 0;
            const limit = 500;
            let localHasMore = true;

            while (localHasMore) {
                if (abortSignal?.aborted) throw { name: 'AbortError', message: 'cancelled_listing_for_view' };
                const { data: listedFiles, error: listError } = await supabaseClient.storage
                    .from(bucketName)
                    .list(currentPath, {
                        limit,
                        offset: localOffset,
                        sortBy: { column: 'name', order: 'asc' },
                        signal: abortSignal
                    });

                if (listError) throw listError;

                for (const file of listedFiles) {
                    if (abortSignal?.aborted) throw { name: 'AbortError', message: 'cancelled_listing_for_view' };
                    const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                    if (file.id === null) {
                        await listRecursive(filePath);
                    } else {
                        filesMetadata.push({
                            name: file.name,
                            fullPath: filePath,
                            size: file.metadata?.size || 0,
                            last_modified: file.metadata?.lastModified || file.updated_at || file.created_at,
                        });
                        updateProgress(filesMetadata.length);
                    }
                }
                localHasMore = listedFiles.length >= limit;
                localOffset += limit;
                if (localHasMore) await new Promise(r => setTimeout(r, 20));
            }
        }
        await listRecursive();
        return filesMetadata;
    }

    function renderBucketFilesTable() {
        bucketFilesTableBody.innerHTML = '';
        updateSortIndicators();

        const sortedData = [...currentBucketFilesData].sort((a, b) => {
            let valA, valB;
            if (currentSortKey === 'name') {
                valA = a.name?.toLowerCase() || '';
                valB = b.name?.toLowerCase() || '';
            } else if (currentSortKey === 'size') {
                valA = a.size;
                valB = b.size;
            } else if (currentSortKey === 'last_modified') {
                valA = new Date(a.last_modified || 0).getTime();
                valB = new Date(b.last_modified || 0).getTime();
            } else {
                return 0;
            }

            if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        sortedData.forEach(file => {
            const row = bucketFilesTableBody.insertRow();
            row.dataset.filePath = file.fullPath;
            if (selectedFilePathsInModal.has(file.fullPath)) {
                row.classList.add('selected-row');
            }

            row.addEventListener('contextmenu', (event) => {
                event.preventDefault();
                const filePath = row.dataset.filePath;
                if (selectedFilePathsInModal.has(filePath)) {
                    selectedFilePathsInModal.delete(filePath);
                    row.classList.remove('selected-row');
                } else {
                    selectedFilePathsInModal.add(filePath);
                    row.classList.add('selected-row');
                }
            });

            row.insertCell().textContent = file.name;
            row.insertCell().textContent = formatFileSize(file.size);
            row.insertCell().textContent = formatDate(file.last_modified);
            const pathCell = row.insertCell();
            pathCell.textContent = file.fullPath;
            pathCell.title = file.fullPath;
            pathCell.classList.add('truncate');
        });
    }

    function updateSortIndicators() {
        document.querySelectorAll('#bucketFilesTable thead th .sort-indicator').forEach(span => span.textContent = '');
        const activeTh = document.querySelector(`#bucketFilesTable thead th[data-sort-key="${currentSortKey}"]`);
        if (activeTh) {
            activeTh.querySelector('.sort-indicator').textContent = currentSortOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
    }

    async function viewBucketFiles(bucketName) {
        if (!supabaseClient) {
            displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error');
            return;
        }
        currentBucketFilesData = [];
        selectedFilePathsInModal.clear();
        currentViewBucketName = bucketName;
        currentSortKey = 'name';
        currentSortOrder = 'asc';

        if(bucketViewAbortController) bucketViewAbortController.abort();
        bucketViewAbortController = new AbortController();
        showLoading(`–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ ${bucketName}...`, true, false);

        try {
            currentBucketFilesData = await fetchAllFilesForView(bucketName, bucketViewAbortController.signal);
            if (bucketViewAbortController.signal.aborted) {
                displayStatus(`–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è ${bucketName} –æ—Ç–º–µ–Ω–µ–Ω.`, 'info');
                return;
            }
            bucketFilesModalTitle.textContent = `–§–∞–π–ª—ã –≤ bucket: ${bucketName} (${currentBucketFilesData.length})`;
            renderBucketFilesTable();
            bucketFilesModal.classList.remove('hidden');
        } catch (err) {
            if (err.name === 'AbortError' || err.message?.includes('cancelled')) {
                displayStatus(`–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è ${bucketName} –æ—Ç–º–µ–Ω–µ–Ω.`, 'info');
            } else {
                displayStatus(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è ${bucketName}: ${err.message}`, 'error');
            }
        } finally {
            hideLoading();
        }
    }

    function exportFileListToTxt() {
        if (currentBucketFilesData.length === 0) {
            displayStatus('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.', 'info');
            return;
        }
        const header = `–°–ø–∏—Å–æ–∫ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤ –∏–∑ bucket: ${currentViewBucketName}\n\n`;
        const content = currentBucketFilesData.map(file => file.name).join('\n');

        const fullContent = header + content;
        const connNameSafe = currentConnectionDetails?.name.replace(/[^a-z0-9]/gi, '_') || 'connection';
        const fileName = `${connNameSafe}_${currentViewBucketName}_filenames_list_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.txt`;
        downloadFile(fileName, fullContent, 'text/plain;charset=utf-8;');
        displayStatus('–°–ø–∏—Å–æ–∫ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.', 'success');
    }

    async function downloadSelectedModalFiles() {
        if (selectedFilePathsInModal.size === 0) {
            displayStatus('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.', 'info');
            return;
        }
        if (!supabaseClient || !currentViewBucketName) {
            displayStatus('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ bucket –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.', 'error');
            return;
        }

        currentExportAbortController = new AbortController();
        isExportProcessActive = true;
        showLoading(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...`, false, true);
        exportProgressBar.value = 0;
        exportProgressBar.max = selectedFilePathsInModal.size;

        let downloadedCount = 0;
        let failedCount = 0;

        for (const filePath of selectedFilePathsInModal) {
            if (currentExportAbortController.signal.aborted) {
                failedCount += (selectedFilePathsInModal.size - downloadedCount - failedCount);
                break;
            }
            exportProgressMessage.textContent = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${filePath.split('/').pop()} (${downloadedCount + failedCount + 1}/${selectedFilePathsInModal.size})`;
            try {
                const { data: blob, error: downloadError } = await supabaseClient.storage
                    .from(currentViewBucketName)
                    .download(filePath, { signal: currentExportAbortController.signal });

                if (downloadError) {
                    if (downloadError.name === 'AbortError') throw downloadError;
                    console.warn(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ${filePath}: ${downloadError.message}`);
                    failedCount++;
                } else {
                    saveAs(blob, filePath.split('/').pop());
                    downloadedCount++;
                }
            } catch (err) {
                 if (err.name === 'AbortError') {
                    failedCount += (selectedFilePathsInModal.size - downloadedCount - failedCount);
                    break;
                }
                console.warn(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${filePath}: ${err.message}`);
                failedCount++;
            }
            exportProgressBar.value = downloadedCount + failedCount;
            await new Promise(r => setTimeout(r, 50));
        }

        hideLoading();
        isExportProcessActive = false;
        currentExportAbortController = null;

        let summaryMsg = "";
        if (downloadedCount > 0) summaryMsg += `–£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ: ${downloadedCount}. `;
        if (failedCount > 0) summaryMsg += `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å: ${failedCount}.`;
        if (selectedFilePathsInModal.size > 0 && (downloadedCount + failedCount) < selectedFilePathsInModal.size && currentExportAbortController?.signal.aborted ) {
             summaryMsg += ` –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ–Ω–µ–Ω—ã.`;
        }


        if (summaryMsg) {
            displayStatus(summaryMsg, failedCount > 0 && downloadedCount === 0 ? 'error' : (failedCount > 0 ? 'warning' : 'success'));
        }
        selectedFilePathsInModal.clear();
        renderBucketFilesTable();
    }

    async function deleteSelectedModalFiles() {
        if (selectedFilePathsInModal.size === 0) {
            displayStatus('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.', 'info');
            return;
        }
        if (!supabaseClient || !currentViewBucketName) {
            displayStatus('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ bucket –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤.', 'error');
            return;
        }

        const confirmation = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedFilePathsInModal.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª(–æ–≤) –∏–∑ bucket "${currentViewBucketName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`);
        if (!confirmation) {
            displayStatus('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.', 'info');
            return;
        }

        currentExportAbortController = new AbortController();
        isExportProcessActive = true;
        showLoading(`–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...`, false, true);
        exportProgressBar.value = 0;
        exportProgressBar.max = selectedFilePathsInModal.size;

        let deletedCount = 0;
        let failedCount = 0;
        const filesToDelete = Array.from(selectedFilePathsInModal);

        for (const filePath of filesToDelete) {
            if (currentExportAbortController.signal.aborted) {
                 failedCount += (filesToDelete.length - deletedCount - failedCount);
                break;
            }
            exportProgressMessage.textContent = `–£–¥–∞–ª–µ–Ω–∏–µ: ${filePath.split('/').pop()} (${deletedCount + failedCount + 1}/${filesToDelete.length})`;
            try {
                const { error } = await supabaseClient.storage
                    .from(currentViewBucketName)
                    .remove([filePath], { signal: currentExportAbortController.signal });

                if (error) {
                    if (error.name === 'AbortError') throw error;
                    console.warn(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${filePath}: ${error.message}`);
                    failedCount++;
                } else {
                    deletedCount++;
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    failedCount += (filesToDelete.length - deletedCount - failedCount);
                    break;
                }
                console.warn(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è ${filePath}: ${err.message}`);
                failedCount++;
            }
            exportProgressBar.value = deletedCount + failedCount;
            await new Promise(r => setTimeout(r, 50));
        }

        hideLoading();
        isExportProcessActive = false;
        currentExportAbortController = null;

        let summaryMsg = "";
        if (deletedCount > 0) summaryMsg += `–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ: ${deletedCount}. `;
        if (failedCount > 0) summaryMsg += `–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ${failedCount}.`;

        if (filesToDelete.length > 0 && (deletedCount + failedCount) < filesToDelete.length && currentExportAbortController?.signal.aborted ) {
             summaryMsg += ` –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ–Ω–µ–Ω—ã.`;
        }

        if (summaryMsg) {
            displayStatus(summaryMsg, failedCount > 0 && deletedCount === 0 ? 'error' : (failedCount > 0 ? 'warning' : 'success'));
        }

        selectedFilePathsInModal.clear();
        if (deletedCount > 0) {
            await viewBucketFiles(currentViewBucketName);
        } else {
            renderBucketFilesTable();
        }
    }

    downloadSelectedModalFilesBtn.addEventListener('click', downloadSelectedModalFiles);
    deleteSelectedModalFilesBtn.addEventListener('click', deleteSelectedModalFiles);
    closeBucketFilesModalBtn.addEventListener('click', () => {
        if (bucketViewAbortController) { bucketViewAbortController.abort(); bucketViewAbortController = null; }
        bucketFilesModal.classList.add('hidden');
        currentBucketFilesData = []; selectedFilePathsInModal.clear();
    });
    exportFileListTxtBtn.addEventListener('click', exportFileListToTxt);
    document.querySelectorAll('#bucketFilesTable thead th[data-sort-key]').forEach(th => {
        th.addEventListener('click', () => {
            const sortKey = th.dataset.sortKey;
            if (currentSortKey === sortKey) { currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc'; }
            else { currentSortKey = sortKey; currentSortOrder = 'asc'; }
            renderBucketFilesTable();
        });
    });
    modalDropZone.addEventListener('dragover', (event) => {
        event.preventDefault(); modalDropZone.classList.add('drop-zone-active');
    });
    modalDropZone.addEventListener('dragleave', () => { modalDropZone.classList.remove('drop-zone-active'); });
    modalDropZone.addEventListener('drop', async (event) => {
        event.preventDefault(); modalDropZone.classList.remove('drop-zone-active');
        const files = event.dataTransfer.files;
        if (files.length > 0) { await uploadFileToBucket(null, Array.from(files), currentViewBucketName); }
    });

    async function viewTableData(tableName) {
        if (!supabaseClient) {
            displayStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'error');
            return;
        }
        currentViewTableName = tableName;
        currentPage = 1;
        totalRows = 0;
        tableViewSearchInput.value = '';

        tableViewModalTitle.textContent = `–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã: ${tableName}`;
        tableViewModal.classList.remove('hidden');
        tableViewContent.innerHTML = `<div class="text-center p-8 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>`;
        tableViewPagination.classList.add('hidden');

        await fetchAndRenderTablePage();
    }
    
    async function fetchAndRenderTablePage() {
        if (!currentViewTableName) return;
        
        tableViewContent.innerHTML = `<div class="text-center p-8 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${currentPage}...</div>`;

        const offset = (currentPage - 1) * PAGE_SIZE;
        const searchText = tableViewSearchInput.value.trim();
        
        let data, error, count;

        try {
            const { data: rpcData, error: rpcError } = await supabaseClient.rpc('search_table_data', {
                p_table_name: currentViewTableName,
                p_search_text: searchText,
                p_limit: PAGE_SIZE,
                p_offset: offset
            });
            const { data: countData, error: countError } = await supabaseClient.rpc('search_table_count', {
                p_table_name: currentViewTableName,
                p_search_text: searchText
            });

            if (rpcError || countError) throw rpcError || countError;
            
            data = rpcData;
            count = countData;

            if (count !== null) {
                totalRows = count;
            }

            if (!data || data.length === 0) {
                tableViewContent.innerHTML = `<div class="text-center p-8 text-gray-500">${searchText ? '–ó–∞–ø–∏—Å–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—É, –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.' : '–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.'}</div>`;
                updatePaginationControls();
                return;
            }

            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = Object.keys(data[0]);
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            data.forEach(rowData => {
                const row = tbody.insertRow();
                headers.forEach(header => {
                    const cell = row.insertCell();
                    let cellValue = rowData[header];
                    
                    if (cellValue === null) {
                        cell.textContent = 'NULL';
                        cell.className = 'italic text-gray-400';
                    } else if (typeof cellValue === 'object') {
                        cell.textContent = JSON.stringify(cellValue);
                    } else {
                        cell.textContent = cellValue;
                    }
                    cell.title = cell.textContent;
                });
            });

            tableViewContent.innerHTML = '';
            tableViewContent.appendChild(table);
            updatePaginationControls();

        } catch (err) {
            let errMsg = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`;
            if (err.code === '42883') {
                 errMsg += `. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π SQL —Å–∫—Ä–∏–ø—Ç –∏–∑ —Å–µ–∫—Ü–∏–∏ "SQL –ù–∞—Å—Ç—Ä–æ–π–∫–∞".`;
            }
            tableViewContent.innerHTML = `<div class="text-center p-8 text-red-500">${errMsg}</div>`;
            tableViewPagination.classList.add('hidden');
        }
    }

    function updatePaginationControls() {
        if (totalRows === 0 && !tableViewSearchInput.value.trim()) {
            tableViewPagination.classList.add('hidden');
            return;
        }

        const totalPages = Math.ceil(totalRows / PAGE_SIZE);
        
        prevPageBtn.disabled = (currentPage <= 1);
        nextPageBtn.disabled = (currentPage >= totalPages);

        const startRow = (currentPage - 1) * PAGE_SIZE + 1;
        const endRow = Math.min(currentPage * PAGE_SIZE, totalRows);
        
        pageInfo.textContent = totalRows > 0 ? `–ó–∞–ø–∏—Å–∏ ${startRow} - ${endRow} –∏–∑ ${totalRows}` : `–ù–∞–π–¥–µ–Ω–æ 0 –∑–∞–ø–∏—Å–µ–π`;
        if (totalPages > 1) {
             pageInfo.textContent += ` (–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages})`;
        }
        
        tableViewPagination.classList.remove('hidden');
    }

    tableViewSearchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            currentPage = 1;
            fetchAndRenderTablePage();
        }
    });

    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchAndRenderTablePage();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalRows / PAGE_SIZE);
        if (currentPage < totalPages) {
            currentPage++;
            fetchAndRenderTablePage();
        }
    });

    closeTableViewModalBtn.addEventListener('click', () => {
        tableViewModal.classList.add('hidden');
        currentViewTableName = '';
    });
    
    openMigrationModalBtn.addEventListener('click', () => {
        if (!supabaseClient || !currentConnectionDetails) {
            displayStatus('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ-–∏—Å—Ç–æ—á–Ω–∏–∫—É.', 'warning');
            return;
        }
        migrationSourceConnection.textContent = currentConnectionDetails.name;
        destConnUrl.value = '';
        destConnKey.value = '';
        destConnectionStatus.textContent = '';
        destConnectionStatus.className = 'text-sm text-center';
        startMigrationBtn.disabled = true;
        migrationLog.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞...';
        
        migrationTablesList.innerHTML = '';
        if(currentlyListedTables.length > 0) {
            currentlyListedTables.forEach(tableName => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="table-check-${tableName}" data-table-name="${tableName}" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="table-check-${tableName}" class="ml-2 block text-sm text-gray-900">${tableName}</label>
                `;
                migrationTablesList.appendChild(div);
            });
        } else {
            migrationTablesList.innerHTML = '<p class="text-gray-500">–¢–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ.</p>';
        }
        migrationModal.classList.remove('hidden');
    });

    closeMigrationModalBtn.addEventListener('click', () => {
        migrationModal.classList.add('hidden');
    });

    testDestConnectionBtn.addEventListener('click', async () => {
        const url = destConnUrl.value.trim();
        const key = destConnKey.value.trim();
        if (!url || !key) {
            destConnectionStatus.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ –∫–ª—é—á –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.';
            destConnectionStatus.className = 'text-sm text-center text-red-600';
            return;
        }
        
        destConnectionStatus.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        destConnectionStatus.className = 'text-sm text-center text-blue-600';
        startMigrationBtn.disabled = true;

        try {
            const tempDestClient = createClient(url, key, { auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false } });
            const { error } = await tempDestClient.rpc('test_connection_schema');
            if (error) throw error;

            destConnectionStatus.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é.';
            destConnectionStatus.className = 'text-sm text-center text-green-600';
            startMigrationBtn.disabled = false;
        } catch (err) {
            let errMsg = `–û—à–∏–±–∫–∞: ${err.message}.`;
            if (err.code === '42883') errMsg += ' –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è test_connection_schema. –í—ã–ø–æ–ª–Ω–∏–ª–∏ SQL —Å–∫—Ä–∏–ø—Ç –≤ –±–∞–∑–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è?';
            destConnectionStatus.textContent = errMsg;
            destConnectionStatus.className = 'text-sm text-center text-red-600';
            startMigrationBtn.disabled = true;
        }
    });

    function logMigration(message, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const colors = { error: 'text-red-400', success: 'text-green-400', warning: 'text-yellow-400', info: 'text-gray-400', step: 'text-white font-bold' };
        const colorClass = colors[type] || colors.info;
        
        const logLine = document.createElement('div');
        logLine.className = colorClass;
        logLine.textContent = `[${time}] ${message}`;

        migrationLog.appendChild(logLine);
        migrationLog.scrollTop = migrationLog.scrollHeight;
    }

        startMigrationBtn.addEventListener('click', async () => {
        startMigrationBtn.disabled = true;
        migrationLog.textContent = '';

        const destUrl = destConnUrl.value.trim();
        const destKey = destConnKey.value.trim();
        const shouldMigrateSchema = migrateSchemaCheckbox.checked;
        const tablesToMigrate = Array.from(migrationTablesList.querySelectorAll('input[type=checkbox]:checked'))
                                    .map(cb => cb.dataset.tableName);

        const destClient = createClient(destUrl, destKey, { auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false } });

        try {
            logMigration('--- –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ ---', 'step');

            if (shouldMigrateSchema) {
                logMigration('–®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞...', 'info');
                const { data: fullSchemaSql, error: schemaExportError } = await supabaseClient.rpc('get_full_schema_sql');
                if (schemaExportError) throw new Error(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å—Ö–µ–º—ã: ${schemaExportError.message}`);
                logMigration('–≠–∫—Å–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –ø–æ —á–∞—Å—Ç—è–º...', 'success');

                const sections = {
                    tables: '-- 1. Tables',
                    views: '-- 2. Views',
                    functions: '-- 3. Functions and Procedures',
                    indexes: '-- 4. Indexes'
                };

                const parseSection = (startMarker, endMarker) => {
                    const startIndex = fullSchemaSql.indexOf(startMarker);
                    if (startIndex === -1) return '';
                    const endIndex = endMarker ? fullSchemaSql.indexOf(endMarker, startIndex) : fullSchemaSql.length;
                    return fullSchemaSql.slice(startIndex + startMarker.length, endIndex).trim();
                };

                const tablesSQL = parseSection(sections.tables, sections.views);
                const viewsSQL = parseSection(sections.views, sections.functions);
                const functionsSQL = parseSection(sections.functions, sections.indexes);
                const indexesSQL = parseSection(sections.indexes, null);
                
                if (tablesSQL || viewsSQL) {
                    logMigration('–®–∞–≥ 2.1: –ò–º–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π...', 'info');
                    const tablesAndViews = (tablesSQL || '') + '\n' + (viewsSQL || '');
                     if (tablesAndViews.trim()) {
                        const { error: tvImportError } = await destClient.rpc('execute_arbitrary_sql', { sql_text: tablesAndViews });
                        if (tvImportError) logMigration(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ç–∞–±–ª–∏—Ü/–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π: ${tvImportError.message}`, 'warning');
                        else logMigration('–ò–º–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.', 'success');
                    }
                }

                if (functionsSQL) {
                    logMigration('–®–∞–≥ 2.2: –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π...', 'info');
                    const functionDefinitions = functionsSQL.split(';\n\n').filter(f => f.trim().length > 10 && f.trim().toUpperCase().startsWith('CREATE'));
                    let funcOk = 0, funcFail = 0;
                    for(const funcDef of functionDefinitions) {
                        const funcNameMatch = funcDef.match(/FUNCTION\s+public\.(\w+)/i);
                        const funcName = funcNameMatch ? funcNameMatch[1] : 'unknown function';
                        const { error: funcError } = await destClient.rpc('execute_arbitrary_sql', { sql_text: funcDef + ';' });
                        if(funcError) {
                            logMigration(`- –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ '${funcName}': ${funcError.message}`, 'error');
                            funcFail++;
                        } else {
                            logMigration(`- –§—É–Ω–∫—Ü–∏—è '${funcName}' —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞.`, 'info');
                            funcOk++;
                        }
                    }
                    logMigration(`–ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω (–£—Å–ø–µ—à–Ω–æ: ${funcOk}, –û—à–∏–±–æ–∫: ${funcFail}).`, funcFail > 0 ? 'warning' : 'success');
                }
                
                if (indexesSQL) {
                    logMigration('–®–∞–≥ 2.3: –ò–º–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–æ–≤...', 'info');
                    const { error: idxImportError } = await destClient.rpc('execute_arbitrary_sql', { sql_text: indexesSQL });
                    if (idxImportError) logMigration(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–Ω–¥–µ–∫—Å–æ–≤: ${idxImportError.message}`, 'warning');
                    else logMigration('–ò–º–ø–æ—Ä—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω.', 'success');
                }

            } else {
                logMigration('–®–∞–≥ 1 & 2: –ü—Ä–æ–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã (–æ—Ç–∫–ª—é—á–µ–Ω–æ).', 'warning');
            }

            logMigration(`–®–∞–≥ 3: –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${tablesToMigrate.length} —Ç–∞–±–ª–∏—Ü...`, 'step');
            if(tablesToMigrate.length === 0) {
                 logMigration('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö.', 'warning');
            }

            for (const tableName of tablesToMigrate) {
                logMigration(`- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã '${tableName}'...`, 'info');
                try {
                    const exportResult = await exportTable(tableName, 'sql', true);
                    if (exportResult && exportResult.content) {
                        logMigration(`  - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ '${tableName}'...`, 'info');
                        const { error: dataImportError } = await destClient.rpc('execute_arbitrary_sql', { sql_text: exportResult.content });
                        if (dataImportError) throw dataImportError;
                        logMigration(`  - –î–∞–Ω–Ω—ã–µ –¥–ª—è '${tableName}' —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.`, 'success');
                    } else {
                        logMigration(`  - –¢–∞–±–ª–∏—Ü–∞ '${tableName}' –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ–ø—É—Å–∫.`, 'warning');
                    }
                } catch (tableError) {
                     logMigration(`  - –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã '${tableName}': ${tableError.message}`, 'error');
                }
            }

            logMigration('--- –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ---', 'step');

        } catch (err) {
            logMigration(`–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${err.message}`, 'error');
            logMigration('–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞.', 'error');
        } finally {
            startMigrationBtn.disabled = false;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        adjustMainContentMargin();
        welcomeMessageEl.classList.remove('hidden');
        dashboardEl.classList.add('hidden');
    });


</script>
</body>
</html>
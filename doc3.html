<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –î–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #3b82f6; --primary-hover: #2563eb; --primary-light: #bfdbfe;
            --secondary-color: #8b5cf6; --secondary-light: #ddd6fe; --success-color: #10b981;
            --success-light: #d1fae5; --error-color: #ef4444; --error-light: #fee2e2;
            --warning-color: #f59e0b; --warning-light: #fef3c7; --gray-50: #f8fafc;
            --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1;
            --gray-500: #64748b; --gray-700: #334155; --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --header-color: #202124;
            --border-color: #dadce0;
            --accent-color: #1a73e8;
            --option-hover: #f1f3f4;
            --option-selected: #e8f0fe;
            --option-selected-border: #1a73e8;
            --button-bg: #1a73e8;
            --button-bg-hover: #1765cc;
            --button-color: white;
            --input-bg: #ffffff;
            --input-border: #dadce0;
            --input-text: #202124;
            --message-bot-color: #202124;
        }
        body.dark-theme {
            --primary-color: #60a5fa; --primary-hover: #3b82f6; --primary-light: #374151;
            --secondary-color: #a78bfa; --secondary-light: #4b5563; --success-color: #34d399;
            --success-light: #1f2937; --error-color: #f87171; --error-light: #374151;
            --warning-color: #fbbf24; --warning-light: #374151; --gray-50: #1f2937;
            --gray-100: #374151; --gray-200: #4b5563; --gray-300: #6b7280;
            --gray-500: #9ca3af; --gray-700: #d1d5db; --gray-900: #f9fafb;
            --bg-color: #111827;
            --container-bg: #1f2937;
            --header-color: #e0eafe;
            --border-color: #374151;
            --accent-color: #56c8fa;
            --option-hover: #374151;
            --option-selected: #223e60;
            --option-selected-border: #3edbea;
            --button-bg: #259af7;
            --button-bg-hover: #41c6e0;
            --button-color: #07111f;
            --input-bg: #1f2937;
            --input-border: #4b5563;
            --input-text: #e4f0f4;
            --message-bot-color: #f3f9fb;
        }

        /* Basic Styles & Layout */
        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--gray-900); line-height: 1.6; }
        .page-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Main Content Layout */
        .editor-layout { display: flex; gap: 1.5rem; align-items: flex-start; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .main-content-column { flex: 1; min-width: 0; }
        .form-container { background: var(--container-bg); border-radius: 16px; box-shadow: var(--shadow-md); padding: 2.5rem; }
        .form-control-group { margin-bottom: 1.5rem; }
        .form-control-group label { display: block; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; font-size: 0.95rem; }
        .mode-selector { display: flex; gap: 0.5rem; background-color: var(--gray-100); padding: 0.5rem; border-radius: 12px; }
        .mode-btn { flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 8px; background-color: transparent; color: var(--gray-500); font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .mode-btn:hover { background-color: var(--primary-light); color: var(--primary-color); }
        .mode-btn.active { background-color: var(--primary-color); color: white; box-shadow: var(--shadow-sm); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        select.custom-select { width: 100%; padding: 0.75rem; border: 2px solid var(--input-border); border-radius: 12px; font-size: 0.9rem; background: var(--input-bg); color: var(--input-text); }
        #user-query { width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--input-border); border-radius: 12px; font-size: 1rem; resize: vertical; background: var(--input-bg); color: var(--input-text); }
        #user-query:focus { outline: none; border-color: var(--primary-color); }
        .generate-btn { flex: 1; padding: 1rem 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .generate-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .generate-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .spinner { width: 24px; height: 24px; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Document Preview Section */
        #preview-section { margin-top: 2.5rem; background: var(--container-bg); border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden; display: none;}
        #preview-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #preview-header h2 { font-size: 1.25rem; color: var(--header-color); display: flex; align-items: center; gap: 0.5rem;}
        #preview-actions button { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--gray-700); border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; }
        #preview-actions button:hover { background-color: var(--option-hover); }
        #document-preview-container { padding: 2rem; cursor: text; min-height: 200px; }
        #document-preview-container:focus { outline: 2px solid var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }

        /* Formatting Toolbar */
        #formatting-toolbar { width: 200px; background-color: var(--container-bg); border-radius: 16px; box-shadow: var(--shadow-md); padding: 1rem; position: sticky; top: 2rem; align-self: flex-start; }
        #formatting-toolbar.disabled { opacity: 0.5; pointer-events: none; }
        .toolbar-group { margin-bottom: 1.5rem; }
        .toolbar-group:last-child { margin-bottom: 0; }
        .toolbar-group h3 { font-size: 0.8rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.75rem; }
        .toolbar-buttons { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 0.5rem; }
        .toolbar-btn { width: 100%; height: 36px; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--gray-700); border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .toolbar-btn:hover { background-color: var(--option-hover); }
        .toolbar-select { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); color: var(--input-text); }
        .toolbar-color-input { width: 100%; height: 36px; border: 1px solid var(--border-color); border-radius: 8px; padding: 2px; cursor: pointer; background-color: var(--container-bg); }

        /* Styles for content INSIDE the preview */
        #document-preview-container .placeholder { color: var(--gray-500); text-align: center; font-style: italic; }
        
        /* Settings Button & Modal */
        #settings-btn { position: fixed; top: 1rem; right: 1rem; width: 44px; height: 44px; border-radius: 50%; background-color: var(--container-bg); color: var(--gray-700); border: 1px solid var(--border-color); box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 100; }
        #settings-btn:hover { background-color: var(--option-hover); }
        #settings-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: none; align-items: center; justify-content: center; }
        #settings-modal-content { background: var(--container-bg); padding: 25px; border-radius: 10px; width: 90%; max-width: 450px; display: flex; flex-direction: column; gap: 1.5rem; }
        .settings-control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .settings-control-group label { font-weight: 600; color: var(--gray-700); }
        .selector-button { padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--container-bg); cursor: pointer; font-size: 14px; color: var(--message-bot-color); display: flex; align-items: center; gap: 8px; justify-content: space-between; }
        .selector-options { position: absolute; top: calc(100% + 5px); left: 0; right: 0; background: var(--container-bg); border-radius: 8px; box-shadow: var(--shadow-lg); padding: 8px 0; list-style: none; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; z-index: 100; border: 1px solid var(--border-color); }
        .selector-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .selector-option { padding: 10px 16px; cursor: pointer; font-size: 13px; color: var(--message-bot-color); display: flex; align-items: center; gap: 10px; }
        .selector-option:hover { background-color: var(--option-hover); }
        .selector-option.selected { background-color: var(--option-selected); border-left: 3px solid var(--option-selected-border); font-weight: 500; padding-left: 13px; }
        .selector-option .icon { width: 16px; height: 16px; fill: var(--accent-color); }
        
        /* Notification */
        .notification { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 8px; z-index: 1000; opacity: 0; transition: all 0.4s ease; background-color: var(--success-light); color: var(--success-color); box-shadow: var(--shadow-lg); }
        .notification.error { background-color: var(--error-light); color: var(--error-color); }
        .notification.show { opacity: 1; transform: translateY(0); }
        
        /* Print Styles */
        @media print {
            body { margin: 0; padding: 0; }
            #settings-btn, .form-container, #preview-header, .notification, #formatting-toolbar, #api-key-modal-overlay, #settings-modal-overlay { display: none !important; }
            .page-wrapper, .editor-layout, .main-content-column, #preview-section { margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; border-radius: 0 !important; background: none !important; max-width: 100% !important; width: 100% !important; }
            #document-preview-container { padding: 1in !important; cursor: default !important; outline: none !important; box-shadow: none !important; }
            #document-preview-container, #document-preview-container * { color: black !important; background-color: transparent !important; }
            table, tr, td, th, li { page-break-inside: avoid; }
            h1, h2, h3 { page-break-after: avoid; }
        }

        @media (max-width: 1100px) {
            .editor-layout { flex-direction: column-reverse; }
            #formatting-toolbar { position: static; width: 100%; margin-top: 1.5rem; }
        }
        @media (max-width: 768px) {
            .form-container { padding: 1.5rem; }
            .controls-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i class="fas fa-cog"></i></button>

        <main class="editor-layout">
            <div class="main-content-column">
                <div class="form-container">
                    <div class="form-control-group">
                        <label for="mode-selector"><i class="fas fa-sliders-h"></i> –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                        <div class="mode-selector" id="mode-selector">
                            <button class="mode-btn active" data-mode="create"><i class="fas fa-magic"></i> –°–æ–∑–¥–∞–Ω–∏–µ</button>
                            <button class="mode-btn" data-mode="refine"><i class="fas fa-search"></i> –î–æ—Ä–∞–±–æ—Ç–∫–∞</button>
                        </div>
                    </div>
                    <div class="controls-grid">
                        <div class="form-control-group">
                            <label for="role-selector"><i class="fas fa-user-tie"></i> –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
                            <select id="role-selector" class="custom-select">
                                <option value="universal_assistant">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ü–æ–º–æ—â–Ω–∏–∫</option>
                                <option value="deloproizvoditel">–î–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</option>
                                <option value="general_jurist">–Æ—Ä–∏—Å—Ç</option>
                                <option value="hr_specialist">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–∞–º</option>
                                <option value="accountant">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
                                <option value="real_estate">–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</option>
                            </select>
                        </div>
                        <div class="form-control-group">
                            <label for="detail-selector"><i class="fas fa-align-left"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</label>
                            <div class="mode-selector" id="detail-selector">
                                <button class="mode-btn" data-level="short">–ö—Ä–∞—Ç–∫–æ</button>
                                <button class="mode-btn active" data-level="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ</button>
                                <button class="mode-btn" data-level="detailed">–ü–æ–¥—Ä–æ–±–Ω–æ</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-control-group">
                        <label for="user-query"><i class="fas fa-edit"></i> –û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏</label>
                        <textarea id="user-query" rows="8" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ"></textarea>
                    </div>
                    <div class="form-control-group">
                        <button id="generate-btn" class="generate-btn">
                            <i class="fas fa-wand-magic-sparkles"></i>
                            <span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                    </div>
                </div>

                <section id="preview-section">
                    <div id="preview-header">
                        <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ <i class="fas fa-pencil-alt fa-xs" style="opacity: 0.7;"></i></h2>
                        <div id="preview-actions">
                            <button id="save-pdf-btn"><i class="fas fa-file-pdf"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF</button>
                            <button id="save-html-btn"><i class="fas fa-file-code"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ HTML</button>
                        </div>
                    </div>
                    <div id="document-preview-container" contenteditable="true">
                        <p class="placeholder">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å...</p>
                    </div>
                </section>
            </div>

            <aside id="formatting-toolbar">
                <div class="toolbar-group">
                    <h3>–®—Ä–∏—Ñ—Ç</h3>
                    <select id="select-font-family" class="toolbar-select">
                        <option value="Arial">Arial</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <h3>–†–∞–∑–º–µ—Ä</h3>
                    <select id="select-font-size" class="toolbar-select">
                        <option value="1">–û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π</option>
                        <option value="2">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                        <option value="3">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                        <option value="4">–°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="5">–ë–æ–ª—å—à–æ–π</option>
                        <option value="6">–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π</option>
                        <option value="7">–û–≥—Ä–æ–º–Ω—ã–π</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <h3>–°—Ç–∏–ª—å</h3>
                    <div class="toolbar-buttons">
                        <button id="btn-bold" class="toolbar-btn" title="–ñ–∏—Ä–Ω—ã–π"><i class="fas fa-bold"></i></button>
                        <button id="btn-italic" class="toolbar-btn" title="–ö—É—Ä—Å–∏–≤"><i class="fas fa-italic"></i></button>
                        <button id="btn-underline" class="toolbar-btn" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><i class="fas fa-underline"></i></button>
                        <input type="color" id="input-font-color" class="toolbar-color-input" title="–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" value="#333333">
                    </div>
                </div>
                <div class="toolbar-group">
                    <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
                    <div class="toolbar-buttons">
                        <button id="btn-undo" class="toolbar-btn" title="–û—Ç–º–µ–Ω–∏—Ç—å"><i class="fas fa-undo"></i></button>
                        <button id="btn-redo" class="toolbar-btn" title="–í–µ—Ä–Ω—É—Ç—å"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <div class="notification"></div>
    
    <div id="settings-modal-overlay">
        <div id="settings-modal-content">
             <h2 style="text-align:center; color: var(--header-color);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
             <div class="settings-control-group">
                <label>–ú–æ–¥–µ–ª—å –ò–ò</label>
                <div class="selector-container" style="position: relative;">
                    <button class="selector-button" id="model-selector-button"></button>
                    <ul class="selector-options" id="model-options"></ul>
                </div>
            </div>
            <div class="settings-control-group">
                <label>–†–µ–∂–∏–º API</label>
                 <div class="selector-container" style="position: relative;">
                    <button class="selector-button" id="api-mode-selector-button"></button>
                    <ul class="selector-options" id="api-mode-options"></ul>
                </div>
            </div>
             <div class="settings-control-group">
                <label>–¢–µ–º–∞</label>
                <button class="selector-button theme-toggle" id="theme-toggle-btn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
            </div>
        </div>
    </div>

    <div id="api-key-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1002; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--container-bg); padding: 25px; border-radius: 10px; width: 90%; max-width: 450px;">
            <h2 id="api-key-modal-title">API –∫–ª—é—á</h2>
            <p id="api-key-modal-text" style="margin: 1rem 0; color: var(--gray-700);"></p>
            <p><a id="api-key-modal-link" href="#" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color);">–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á</a></p>
            <input type="password" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á..." style="width: 100%; padding: 10px; margin: 1rem 0; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--input-text);">
            <button id="save-api-key-btn" style="padding: 10px 20px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 6px; cursor: pointer; width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
    class DocumentGenerator {
        constructor() {
            this.elements = {
                // UI Elements
                generateBtn: document.getElementById('generate-btn'),
                queryInput: document.getElementById('user-query'),
                modeSelector: document.getElementById('mode-selector'),
                roleSelector: document.getElementById('role-selector'),
                detailSelector: document.getElementById('detail-selector'),
                previewSection: document.getElementById('preview-section'),
                previewContainer: document.getElementById('document-preview-container'),
                savePdfBtn: document.getElementById('save-pdf-btn'),
                saveHtmlBtn: document.getElementById('save-html-btn'),
                notification: document.querySelector('.notification'),
                // Settings
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal-overlay'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                // API Selectors (inside modal)
                modelSelectorButton: document.getElementById('model-selector-button'),
                modelOptionsList: document.getElementById('model-options'),
                apiModeSelectorButton: document.getElementById('api-mode-selector-button'),
                apiModeOptionsList: document.getElementById('api-mode-options'),
                // API Key Modal
                apiKeyModal: document.getElementById('api-key-modal-overlay'),
                apiKeyInput: document.getElementById('api-key-input'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                apiKeyModalTitle: document.getElementById('api-key-modal-title'),
                apiKeyModalText: document.getElementById('api-key-modal-text'),
                apiKeyModalLink: document.getElementById('api-key-modal-link'),
                // Formatting Toolbar
                formattingToolbar: document.getElementById('formatting-toolbar'),
            };

            this.config = {
                VERCEL_PROXY_BASE_URL: "https://ver-olive-delta.vercel.app",
                MAPRUAPP_PROXY_BASE_URL: "https://mapruapp.ru",
                MODELS: [
                    { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite", apiType: "gemini" },
                    { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini" },
                    { id: "magistral-medium-2506", uiName: "Mistral Magistral", apiType: "mistral" },
                ],
                API_MODES: {
                    'mapruapp': { uiName: '–ü—Ä–æ–∫—Å–∏ (mapruapp)', icon: '<i class="fas fa-server fa-fw"></i>' },
                    'vercel': { uiName: '–ü—Ä–æ–∫—Å–∏ (vercel)', icon: '<i class="fas fa-cloud fa-fw"></i>' },
                    'direct_gemini': { uiName: '–ü—Ä—è–º–æ–π (Gemini)', icon: '<i class="fas fa-key fa-fw"></i>' },
                    'direct_mistral': { uiName: '–ü—Ä—è–º–æ–π (Mistral)', icon: '<i class="fas fa-key fa-fw"></i>' },
                },
                PROMPTS: {
                    ROLES: {
                        universal_assistant: "–¢—ã ‚Äî –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ü–æ–º–æ—â–Ω–∏–∫, –º–∞—Å—Ç–µ—Ä –Ω–∞ –≤—Å–µ —Ä—É–∫–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —à–∏—Ä–æ–∫–∏–º —Å–ø–µ–∫—Ç—Ä–æ–º –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö, —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á. –¢—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è —Å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –ø–∏—Å–µ–º, –æ–±—ä—è–≤–ª–µ–Ω–∏–π, –ø–ª–∞–Ω–æ–≤, –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∏–¥–µ–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
                        deloproizvoditel: "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –¥–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, –º–∞—Å—Ç–µ—Ä—Å–∫–∏ –≤–ª–∞–¥–µ—é—â–∏–π –ì–û–°–¢–∞–º–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
                        general_jurist: "–¢—ã ‚Äî –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–ø–æ—Å–æ–±–Ω—ã–π —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã.",
                        hr_specialist: "–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–∞–¥—Ä–∞–º, –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –∑–Ω–∞—é—â–∏–π —Ç—Ä—É–¥–æ–≤–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ.",
                        accountant: "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.",
                        real_estate: "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–æ–≤.",
                    },
                    SYSTEM_PROMPT: "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –¢–û–õ–¨–ö–û –≤ –≤–∏–¥–µ –æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ, —Ü–µ–ª—å–Ω–æ–≥–æ, —Ö–æ—Ä–æ—à–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ HTML –±–ª–æ–∫–∞. –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏: `<h1>`, `<h2>`, `<p>`, `<table>`, `<ul>`/`<ol>`. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–≥–∏ `<html>`, `<body>`, `<head>`. –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏–ª–∏ markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ HTML. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –ø—Ä—è–º–æ–π –≤—Å—Ç–∞–≤–∫–µ –≤ `<div>`. ",
                    TASKS: {
                        create: "–°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é:",
                        refine: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –º–æ–∏–º —É–∫–∞–∑–∞–Ω–∏—è–º:"
                    },
                    DETAIL_LEVELS: {
                        short: "–°–¥–µ–ª–∞–π –¥–æ–∫—É–º–µ–Ω—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–∏–º, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å.",
                        standard: "–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞.",
                        detailed: "–°–¥–µ–ª–∞–π –¥–æ–∫—É–º–µ–Ω—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–º, –≤–∫–ª—é—á–∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã, –æ–≥–æ–≤–æ—Ä–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏."
                    }
                }
            };
            
            this.state = {
                isGenerating: false,
                isDarkTheme: false,
                selectedMode: 'create',
                selectedRole: 'universal_assistant',
                selectedDetail: 'standard',
                currentModelId: this.config.MODELS[0].id,
                currentApiMode: 'mapruapp',
                geminiApiKey: null,
                mistralApiKey: null,
            };

            this.init();
        }

        init() {
            this.loadStateFromStorage();
            this.bindEvents();
            this.initToolbar();
            this.updateTheme();
            this.populateModelOptions();
            this.populateApiModeOptions();
            this.updateApiModeUI();
            this.updateModelUI();
            this.toggleToolbar(false); // Initially disabled
        }
        
        loadStateFromStorage() {
            this.state.isDarkTheme = localStorage.getItem('docgen_theme') === 'true'; // Default is false (light)
            this.state.currentModelId = localStorage.getItem('docgen_model') || this.config.MODELS[0].id;
            this.state.currentApiMode = localStorage.getItem('docgen_apimode') || 'mapruapp';
            this.state.geminiApiKey = localStorage.getItem('docgen_gemini_key');
            this.state.mistralApiKey = localStorage.getItem('docgen_mistral_key');
        }

        bindEvents() {
            this.elements.generateBtn.addEventListener('click', () => this.generateDocument());
            this.elements.modeSelector.addEventListener('click', e => this.handleModeSelection(e, 'selectedMode', this.elements.modeSelector));
            this.elements.detailSelector.addEventListener('click', e => this.handleModeSelection(e, 'selectedDetail', this.elements.detailSelector));
            this.elements.roleSelector.addEventListener('change', e => { this.state.selectedRole = e.target.value; });
            this.elements.savePdfBtn.addEventListener('click', () => window.print());
            this.elements.saveHtmlBtn.addEventListener('click', () => this.saveAsHtml());
            
            this.elements.settingsBtn.addEventListener('click', () => this.elements.settingsModal.style.display = 'flex');
            this.elements.settingsModal.addEventListener('click', e => { if (e.target === this.elements.settingsModal) this.elements.settingsModal.style.display = 'none'; });
            this.elements.themeToggleBtn.addEventListener('click', () => {
                this.state.isDarkTheme = !this.state.isDarkTheme;
                localStorage.setItem('docgen_theme', this.state.isDarkTheme);
                this.updateTheme();
            });
            
            this.elements.modelSelectorButton.addEventListener('click', e => { e.stopPropagation(); this.elements.modelOptionsList.classList.toggle('show'); });
            this.elements.apiModeSelectorButton.addEventListener('click', e => { e.stopPropagation(); this.elements.apiModeOptionsList.classList.toggle('show'); });
            document.addEventListener('click', () => {
                this.elements.modelOptionsList.classList.remove('show');
                this.elements.apiModeOptionsList.classList.remove('show');
            });
            
            this.elements.saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
            this.elements.apiKeyModal.addEventListener('click', e => { if (e.target === this.elements.apiKeyModal) this.hideApiKeyModal(); });
        }
        
        initToolbar() {
            const toolbar = this.elements.formattingToolbar;
            toolbar.querySelector('#btn-bold').addEventListener('click', () => document.execCommand('bold'));
            toolbar.querySelector('#btn-italic').addEventListener('click', () => document.execCommand('italic'));
            toolbar.querySelector('#btn-underline').addEventListener('click', () => document.execCommand('underline'));
            toolbar.querySelector('#btn-undo').addEventListener('click', () => document.execCommand('undo'));
            toolbar.querySelector('#btn-redo').addEventListener('click', () => document.execCommand('redo'));
            toolbar.querySelector('#select-font-family').addEventListener('change', (e) => document.execCommand('fontName', false, e.target.value));
            toolbar.querySelector('#select-font-size').addEventListener('change', (e) => document.execCommand('fontSize', false, e.target.value));
            toolbar.querySelector('#input-font-color').addEventListener('input', (e) => document.execCommand('foreColor', false, e.target.value));
        }

        toggleToolbar(enabled) {
            this.elements.formattingToolbar.classList.toggle('disabled', !enabled);
        }

        updateTheme() { document.body.classList.toggle('dark-theme', this.state.isDarkTheme); }

        handleModeSelection(event, stateKey, container) {
            const button = event.target.closest('.mode-btn');
            if (!button) return;
            this.state[stateKey] = button.dataset.mode || button.dataset.level;
            container.querySelector('.active')?.classList.remove('active');
            button.classList.add('active');
        }
        
        setLoadingState(loading) {
            this.state.isGenerating = loading;
            this.elements.generateBtn.disabled = loading;
            this.elements.previewContainer.contentEditable = !loading;
            this.toggleToolbar(!loading);

            if (loading) {
                this.elements.generateBtn.innerHTML = `<div class="spinner"></div><span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>`;
                this.elements.previewSection.style.display = 'block';
                this.elements.previewContainer.innerHTML = `<div class="spinner" style="margin: 2rem auto; border-top-color: var(--primary-color);"></div>`;
            } else {
                this.elements.generateBtn.innerHTML = `<i class="fas fa-wand-magic-sparkles"></i><span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>`;
            }
        }

        showNotification(message, isError = false) {
            this.elements.notification.textContent = message;
            this.elements.notification.className = `notification ${isError ? 'error' : ''}`;
            this.elements.notification.classList.add('show');
            setTimeout(() => this.elements.notification.classList.remove('show'), 4000);
        }

        populateModelOptions() {
            this.elements.modelOptionsList.innerHTML = '';
            this.config.MODELS.forEach(model => {
                const li = document.createElement('li');
                li.className = 'selector-option';
                li.dataset.modelId = model.id;
                li.innerHTML = `<span>${model.uiName}</span>`;
                li.addEventListener('click', () => {
                    this.state.currentModelId = model.id;
                    localStorage.setItem('docgen_model', model.id);
                    this.updateModelUI();
                    this.elements.modelOptionsList.classList.remove('show');
                });
                this.elements.modelOptionsList.appendChild(li);
            });
        }
        
        populateApiModeOptions() {
            this.elements.apiModeOptionsList.innerHTML = '';
            Object.entries(this.config.API_MODES).forEach(([modeId, modeConfig]) => {
                const li = document.createElement('li');
                li.className = 'selector-option';
                li.dataset.apiMode = modeId;
                li.innerHTML = `${modeConfig.icon} <span>${modeConfig.uiName}</span>`;
                li.addEventListener('click', () => {
                    this.state.currentApiMode = modeId;
                    localStorage.setItem('docgen_apimode', modeId);
                    this.updateApiModeUI();
                    this.elements.apiModeOptionsList.classList.remove('show');
                    if (modeId.startsWith('direct_') && !this.getApiKeyForCurrentMode()) {
                        this.showApiKeyModal();
                    }
                });
                this.elements.apiModeOptionsList.appendChild(li);
            });
        }

        updateModelUI() {
            const model = this.config.MODELS.find(m => m.id === this.state.currentModelId) || this.config.MODELS[0];
            this.elements.modelSelectorButton.innerHTML = `<span>${model.uiName}</span><i class="fas fa-chevron-down fa-xs"></i>`;
            this.elements.modelOptionsList.querySelectorAll('.selector-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.modelId === this.state.currentModelId);
            });
        }

        updateApiModeUI() {
            const modeConfig = this.config.API_MODES[this.state.currentApiMode] || this.config.API_MODES['mapruapp'];
            this.elements.apiModeSelectorButton.innerHTML = `${modeConfig.icon} <span>${modeConfig.uiName}</span>`;
            this.elements.apiModeOptionsList.querySelectorAll('.selector-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.apiMode === this.state.currentApiMode);
            });
        }
        
        showApiKeyModal() {
            this.elements.settingsModal.style.display = 'none'; // Hide settings if open
            const isMistral = this.state.currentApiMode === 'direct_mistral';
            this.elements.apiKeyModalTitle.textContent = isMistral ? 'API –ö–ª—é—á Mistral' : 'API –ö–ª—é—á Gemini';
            this.elements.apiKeyModalText.textContent = `–î–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω—É–∂–µ–Ω –≤–∞—à API –∫–ª—é—á. –û–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.`;
            this.elements.apiKeyModalLink.href = isMistral ? 'https://console.mistral.ai/api-keys/' : 'https://aistudio.google.com/app/apikey';
            this.elements.apiKeyInput.value = isMistral ? (this.state.mistralApiKey || '') : (this.state.geminiApiKey || '');
            this.elements.apiKeyModal.style.display = 'flex';
            this.elements.apiKeyInput.focus();
        }

        hideApiKeyModal() { this.elements.apiKeyModal.style.display = 'none'; }
        
        saveApiKey() {
            const key = this.elements.apiKeyInput.value.trim();
            const isMistral = this.state.currentApiMode === 'direct_mistral';
            if (isMistral) {
                this.state.mistralApiKey = key;
                localStorage.setItem('docgen_mistral_key', key);
            } else {
                this.state.geminiApiKey = key;
                localStorage.setItem('docgen_gemini_key', key);
            }
            this.showNotification('API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
            this.hideApiKeyModal();
        }

        getApiKeyForCurrentMode() {
            if (this.state.currentApiMode === 'direct_gemini') return this.state.geminiApiKey;
            if (this.state.currentApiMode === 'direct_mistral') return this.state.mistralApiKey;
            return null;
        }

        buildPrompt() {
            const { ROLES, SYSTEM_PROMPT, TASKS, DETAIL_LEVELS } = this.config.PROMPTS;
            const role_prompt = ROLES[this.state.selectedRole];
            const task_prompt = TASKS[this.state.selectedMode];
            const detail_prompt = DETAIL_LEVELS[this.state.selectedDetail];
            const user_text = this.elements.queryInput.value;
            
            const full_user_prompt = `${task_prompt}\n\n${detail_prompt}\n\n–ó–∞–ø—Ä–æ—Å: "${user_text}"`;
            const full_system_prompt = `${role_prompt}\n${SYSTEM_PROMPT}`;
            
            return { system: full_system_prompt, user: full_user_prompt };
        }
        
        async generateDocument() {
            const userQuery = this.elements.queryInput.value.trim();
            if (!userQuery) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É.', true);
                return;
            }

            if (this.state.currentApiMode.startsWith('direct_') && !this.getApiKeyForCurrentMode()) {
                this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–∂–∏–º–∞.', true);
                this.showApiKeyModal();
                return;
            }

            this.setLoadingState(true);
            
            const { system, user } = this.buildPrompt();
            const messages = [ { role: 'system', content: system }, { role: 'user', content: user } ];

            try {
                const response = await this.callApi(messages);
                this.elements.previewContainer.innerHTML = response;
            } catch (error) {
                this.elements.previewContainer.innerHTML = `<p class="placeholder" style="color: var(--error-color);"><b>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</b><br>${error.message}</p>`;
                this.showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                this.setLoadingState(false);
            }
        }
        
        async callApi(messages) {
            const modelConfig = this.config.MODELS.find(m => m.id === this.state.currentModelId) || this.config.MODELS[0];
            let url, body, headers = { 'Content-Type': 'application/json' };

            switch(this.state.currentApiMode) {
                case 'mapruapp':
                    url = `${this.config.MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
                    body = { model: modelConfig.id, messages, max_tokens: 4096 };
                    break;
                case 'vercel':
                    url = `${this.config.VERCEL_PROXY_BASE_URL}/proxy/mistral/chat/completions`;
                    body = { model: modelConfig.id, messages, max_tokens: 4096 };
                    break;
                case 'direct_gemini':
                    url = `https://generativelanguage.googleapis.com/v1beta/models/${modelConfig.id}:generateContent?key=${this.state.geminiApiKey}`;
                    body = { contents: [{ role: 'user', parts: [{text: messages[0].content + '\n\n---\n\n' + messages[1].content }] }] };
                    break;
                case 'direct_mistral':
                    url = `https://api.mistral.ai/v1/chat/completions`;
                    headers['Authorization'] = `Bearer ${this.state.mistralApiKey}`;
                    body = { model: modelConfig.id, messages, max_tokens: 4096 };
                    break;
                default:
                    throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º API");
            }

            const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
            const data = await response.json();

            if (!response.ok) {
                const errorMsg = data?.error?.message || data?.error?.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMsg);
            }

            if (this.state.currentApiMode === 'direct_gemini') {
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            } else {
                return data.choices?.[0]?.message?.content || '';
            }
        }

        saveAsHtml() {
            const content = this.elements.previewContainer.innerHTML;
            if (!content || content.includes('placeholder')) {
                this.showNotification("–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.", true);
                return;
            }
            const titleElement = this.elements.previewContainer.querySelector('h1, h2');
            const title = titleElement ? titleElement.textContent : 'document';
            const cleanTitle = title.replace(/[^a-z0-9–∞-—è—ë]/gi, '_').toLowerCase();
            
            const htmlTemplate = `
                <!DOCTYPE html>
                <html lang="ru">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 2rem auto; padding: 0 1rem; color: #333; }
                        h1, h2, h3 { color: #111; }
                        table { width: 100%; border-collapse: collapse; margin: 1em 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            const blob = new Blob([htmlTemplate], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cleanTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new DocumentGenerator();
    });
    </script>
</body>
</html>
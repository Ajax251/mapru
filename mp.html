<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–∂–µ–≤–æ–π –ø–ª–∞–Ω</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link id="favicon" rel="icon" href="img/mp.png" type="image/png">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --accent-color: #0ea5e9;
            --success-color: #10b981;
            --warning-color: #f97316; /* Orange for warnings */
            --error-color: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f0f4f8;
            color: var(--text-primary);
        }
        .container {
            max-width: 1800px;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .content { padding: 24px; }

        .file-upload-section {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
        }
        .file-upload-area {
            text-align: center;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }
        .file-upload-area:hover { background: white; transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .file-upload-area.dragover { background: #dbeafe !important; border-color: var(--primary-color) !important; }
        .file-upload-section.dragover { border-color: var(--primary-color); background: #f0f9ff; }
        .upload-icon {
            font-size: 2rem; /* Reverted to smaller icon size */
            margin-bottom: 8px;
            color: var(--primary-color);
            line-height: 1;
        }
        .upload-text { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .upload-subtext { color: var(--text-secondary); font-size: 0.9rem; }
        #fileInput { display: none; }
        .status-container {
            text-align: center; margin: 24px 0; min-height: 60px;
            display: flex; align-items: center; justify-content: center; gap: 16px;
        }
        .loader {
            width: 32px; height: 32px; border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-text { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); }
        .hidden { display: none; }

        #resultsContainer {
            display: grid;
            grid-template-columns: 2fr 1.2fr;
            gap: 24px;
            align-items: start;
        }
        #mainColumn, #sidebarColumn {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: white; border-radius: 12px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); overflow: hidden;
            width: 100%;
            margin-bottom: 0;
        }
        .section-header {
            background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
            padding: 16px 20px; border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-icon {
            width: 24px;
            height: 24px;
            color: var(--primary-color);
            flex-shrink: 0;
        }
        .section-title { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); margin: 0; }
        
        .header-button {
            margin-left: auto;
            padding: 4px; border-radius: 6px;
            transition: background-color 0.2s; cursor: pointer;
            display: flex; align-items: center;
            border: none; background: transparent;
        }
        .header-button:hover { background-color: var(--border-color); }
        .header-button .section-icon { width: 24px; height: 24px; color: var(--primary-color); }

        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px; margin-bottom: 16px;
        }
        .info-card {
            background: var(--secondary-color); border-radius: 8px; padding: 16px;
            border: 1px solid var(--border-color);
        }
        .info-label {
            font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .info-value { font-size: 1rem; color: var(--text-primary); font-weight: 500; }
        .info-value code {
            background: #e2e8f0; padding: 2px 6px; border-radius: 4px;
            font-family: 'Courier New', monospace; font-size: 0.95rem;
        }
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 16px;
            border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-sm);
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            text-align: center;
        }
        .data-table th {
            background: var(--primary-color); color: white;
            font-weight: 600; font-size: 0.9rem;
        }
        .data-table tbody tr:hover { background: var(--secondary-color); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table td:first-child, .data-table .left-align { text-align: left; }
        .data-table .no-wrap { white-space: nowrap; } /* Class to prevent wrapping */
        .coord-table td:first-child { text-align: center; font-weight: 600; }
        .coord-table td:nth-child(4) { text-align: left; }

        .address-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd; border-radius: 8px; padding: 16px;
            font-size: 1.1rem; font-weight: 500; color: var(--text-primary);
        }
        .conclusion-text {
            background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px;
            padding: 16px; font-size: 0.95rem;
            line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;
        }
        .error-message {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;
            padding: 16px; color: var(--error-color); font-weight: 500; text-align: center;
        }
        .subsection { margin-top: 24px; }
        .subsection-title {
            font-size: 1.1rem; font-weight: 600; color: var(--text-primary);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color);
        }
        .file-name {
            font-family: 'Courier New', monospace; background: #e2e8f0; padding: 2px 6px;
            border-radius: 4px; font-size: 0.95rem;
        }

        #printButtonContainer { text-align: center; margin-bottom: 20px; }
        .print-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; font-size: 1rem;
            font-weight: 600; cursor: pointer; display: inline-flex;
            align-items: center; gap: 10px; transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }
        .print-btn:hover {
            background-color: #1d4ed8; box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .print-btn svg { width: 20px; height: 20px; }

        /* Validation & AI Section Styles */
        .validation-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 500;
        }
        .validation-message:first-child { margin-top: 0; }
        .validation-message .icon { width: 24px; height: 24px; flex-shrink: 0; }
        .validation-error { background-color: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; }
        .validation-warning { background-color: #fffbeb; border: 1px solid #fde68a; color: #b45309; }
        .validation-success { background-color: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; }
        #cadastralNumbersList {
            list-style-type: none; padding-left: 0;
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        #cadastralNumbersList li {
            padding: 4px 10px; border-radius: 6px; font-family: 'Courier New', monospace;
            border: 1px solid;
        }
        .ai-result-container {
            margin-top: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f8fafc;
        }
        .ai-result-container .ai-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-secondary);
        }
        .ai-result-container .ai-feedback { white-space: pre-wrap; margin-bottom: 16px; }
        .ai-result-container .ai-corrected-text {
            background-color: white; padding: 12px; border: 1px dashed var(--success-color);
            border-radius: 6px; white-space: pre-wrap; font-family: monospace;
        }
        .ai-result-container h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        .ai-result-container .ai-copy-button {
            margin-top: 12px;
            background-color: var(--success-color); color: white; border: none;
            padding: 8px 16px; border-radius: 6px; font-size: 0.9rem;
            font-weight: 500; cursor: pointer; display: inline-flex;
            align-items: center; gap: 8px; transition: background-color 0.2s ease;
        }
        .ai-result-container .ai-copy-button:hover { background-color: #059669; }
        .ai-result-container .ai-copy-button svg { width: 16px; height: 16px; }
        .ai-result-error { color: var(--error-color); font-weight: 500; }
        .ai-result-success { color: var(--success-color); font-weight: 500; }

        @media (max-width: 1024px) { #resultsContainer { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .container { margin: 0; border-radius: 0; }
            .content { padding: 16px; }
            .info-grid { grid-template-columns: 1fr; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 12px; }
        }

        @media print {
            body, .container {
                padding: 0; margin: 0; box-shadow: none;
                border: none; background: white; color: black;
            }
            .file-upload-section, .status-container, #printButtonContainer, .header-button, .validation-section, .ai-result-container {
                display: none !important;
            }
            #resultsContainer { display: block; gap: 0; }
            #mainColumn, #sidebarColumn { display: block; width: 100%; }
            .section {
                box-shadow: none; border: 1px solid #ccc;
                border-radius: 0; page-break-inside: avoid;
                margin-bottom: 20px;
            }
            .section-header { background: #f0f0f0 !important; }
            .data-table th { background: #e5e5e5 !important; color: black !important; }
            .info-card, .conclusion-text { background: #f9f9f9 !important; }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="content">
            <div class="file-upload-section" id="dropSection">
                <div class="file-upload-area" id="dropArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ XML –∏–ª–∏ ZIP —Ñ–∞–π–ª</div>
                    <div class="upload-subtext" id="fileNameDisplay">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ —Å—é–¥–∞</div>
                </div>
                <input type="file" id="fileInput" accept=".xml,.zip">
            </div>

            <div id="printButtonContainer" class="hidden">
                <button id="printButton" class="print-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 18.25M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5M17.25 4.5l-1.5-1.5-1.5 1.5M6.75 4.5l1.5-1.5 1.5 1.5m12.75 1.5-1.5-1.5-1.5 1.5M6.75 21l1.5 1.5 1.5-1.5m12.75 1.5l-1.5 1.5-1.5-1.5M12 6.75v10.5" />
                    </svg>
                    <span>–ü–µ—á–∞—Ç—å</span>
                </button>
            </div>

            <div class="status-container" id="statusContainer">
                <div class="loader hidden" id="loader"></div>
                <div id="messageArea">
                    <div class="status-text" id="statusText"></div>
                </div>
            </div>

            <div id="resultsContainer" class="hidden">
                <div id="mainColumn"></div>
                <div id="sidebarColumn"></div>
            </div>
        </main>
    </div>

<script>
// --- AI-–ø—Ä–æ–∫—Å–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---
const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";
const PROXY_MODE = 1; // 1 = mapruapp, 0 = vercel (–µ—Å–ª–∏ –±—ã –æ–Ω –±—ã–ª)

document.addEventListener('DOMContentLoaded', () => {
    // --- –°–ª–æ–≤–∞—Ä–∏ –∏ –ò–∫–æ–Ω–∫–∏ ---
    const landCategories = { '003001000000': '–ó–µ–º–ª–∏ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è', '003002000000': '–ó–µ–º–ª–∏ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤', '003003000000': '–ó–µ–º–ª–∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏, —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∏ –∏–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è', '003004000000': '–ó–µ–º–ª–∏ –æ—Å–æ–±–æ –æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤', '003005000000': '–ó–µ–º–ª–∏ –ª–µ—Å–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞', '003006000000': '–ó–µ–º–ª–∏ –≤–æ–¥–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞', '003007000000': '–ó–µ–º–ª–∏ –∑–∞–ø–∞—Å–∞', '003008000000': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' };
    const accuracyStandards = { '003002000000': 0.10, '003001000000': 0.20, '003003000000': 0.50, '003004000000': 2.50, '003005000000': 5.00, '003006000000': 5.00, '003007000000': 5.00, };
    const planTypes = { '1': '–í—ã–¥–µ–ª', '2': '–†–∞–∑–¥–µ–ª', '3': '–†–∞–∑–¥–µ–ª —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –∑–µ–º–µ–ª—å–Ω—ã–º —É—á–∞—Å—Ç–∫–æ–º', '4': '–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '5': '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ –∑–µ–º–µ–ª—å', '6': '–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ', '7': '–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å –∑–µ–º–ª—è–º–∏' };
    const sectionIcons = {
        generalInfo: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        participants: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
        inputData: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>`,
        newParcel: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>`,
        relatedParcel: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`,
        coordinates: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3m6-7h3m-3 4h3m-21-4h3m-3 4h3M12 12l-4 4m4-4l4 4m-4-4v-4m0 4l-4-4m4 4l4-4" /></svg>`,
        conclusion: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        graphics: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01" /><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /></svg>`,
        appendix: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>`,
        copyXY: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path><text x="12" y="16.5" font-family="sans-serif" font-size="6" fill="currentColor" text-anchor="middle" font-weight="bold">XY</text></svg>`,
        validation: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg>`,
        errorIcon: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
        warningIcon: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`,
        successIcon: `<svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        aiCheckIcon: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19.06 4.94a.75.75 0 0 0-1.06-1.06L12 9.88 6.06 3.88a.75.75 0 0 0-1.06 1.06L10.88 12l-5.94 5.94a.75.75 0 1 0 1.06 1.06L12 14.12l5.94 5.94a.75.75 0 0 0 1.06-1.06L13.12 12l5.94-5.94Z" /><path fill-rule="evenodd" d="M9.25 21a.75.75 0 0 0 0-1.5H6.75a.75.75 0 0 1-.75-.75V16a.75.75 0 0 0-1.5 0v2.75c0 .966.784 1.75 1.75 1.75h2.5Zm-5-13.5a.75.75 0 0 0-1.5 0v2.5a.75.75 0 0 0 1.5 0V7.75A.75.75 0 0 1 5 7h2.75a.75.75 0 0 0 0-1.5H5A1.75 1.75 0 0 0 3.25 7.25v.25Zm10.75 13.5a.75.75 0 0 0 1.5 0h2.5a1.75 1.75 0 0 0 1.75-1.75V16a.75.75 0 0 0-1.5 0v2.75a.75.75 0 0 1-.75.75H14.75a.75.75 0 0 0-1.5 0Zm4-13.5a.75.75 0 0 0 0 1.5H17.25a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 0 1.5 0V7.75A1.75 1.75 0 0 0 17.5 6h-2.75Z" clip-rule="evenodd" /></svg>`,
        copyIcon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3.5A1.5 1.5 0 0 1 8.5 2h5.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 1 .439 1.062V12.5A1.5 1.5 0 0 1 16.5 14h-.5a.75.75 0 0 0 0 1.5h.5A3 3 0 0 0 19.5 12.5V5.621a3 3 0 0 0-.879-2.121L16.499.879A3 3 0 0 0 14.378 0H8.5A3 3 0 0 0 5.5 3v.5a.75.75 0 0 0 1.5 0V3.5Z" /><path d="M3 6.5A1.5 1.5 0 0 1 4.5 5h5A1.5 1.5 0 0 1 11 6.5v8A1.5 1.5 0 0 1 9.5 16h-5A1.5 1.5 0 0 1 3 14.5v-8Z" /></svg>`
    };

    // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ---
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const dropArea = document.getElementById('dropArea');
    const dropSection = document.getElementById('dropSection');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const statusContainer = document.getElementById('statusContainer');
    const messageArea = document.getElementById('messageArea');
    const resultsContainer = document.getElementById('resultsContainer');
    const mainColumn = document.getElementById('mainColumn');
    const sidebarColumn = document.getElementById('sidebarColumn');
    const printButtonContainer = document.getElementById('printButtonContainer');
    const printButton = document.getElementById('printButton');

    const E = (el, sel) => el.querySelector(sel);
    const All = (el, sel) => el.querySelectorAll(sel);
    const T = (el, sel) => el?.querySelector(sel)?.textContent.trim() || '‚Äî';
    const A = (el, attr) => el?.getAttribute(attr) || '‚Äî';

    function clearResults() {
        resultsContainer.classList.add('hidden');
        printButtonContainer.classList.add('hidden');
        mainColumn.innerHTML = '';
        sidebarColumn.innerHTML = '';
    }
    function showStatus(message, isLoading = false) {
        clearResults();
        messageArea.innerHTML = `<div class="status-text">${message}</div>`;
        statusContainer.classList.remove('hidden');
        loader.classList.toggle('hidden', !isLoading);
    }
    function showError(message) {
        clearResults();
        loader.classList.add('hidden');
        statusContainer.classList.remove('hidden');
        messageArea.innerHTML = `<div class="error-message">${message}</div>`;
        console.error(message);
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) handleFile(file);
    });
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        document.body.addEventListener(e, preventDefaults, false);
        dropSection.addEventListener(e, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(e => {
        dropSection.addEventListener(e, () => dropSection.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(e => {
        dropSection.addEventListener(e, () => dropSection.classList.remove('dragover'), false);
    });
    dropSection.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    }, false);

    document.body.addEventListener('click', function(event) {
        const copyBtn = event.target.closest('.copy-coords-btn');
        if (!copyBtn) return;
        event.preventDefault();

        const section = copyBtn.closest('.section');
        const coordTable = section?.querySelector('.coord-table tbody');
        if (!coordTable) { alert('–û—à–∏–±–∫–∞: —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!'); return; }
        const rows = coordTable.querySelectorAll('tr');
        let coordsToCopy = '';
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 3) {
                const x = cells[1].textContent.trim();
                const y = cells[2].textContent.trim();
                coordsToCopy += `${x}\t${y}\n`;
            }
        });
        coordsToCopy = coordsToCopy.trim();
        if (!coordsToCopy) { alert('–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; }
        if (navigator.clipboard) {
            navigator.clipboard.writeText(coordsToCopy).then(() => {
                window.open('—Å—Ö–µ–º–∞.html', '_blank');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.');
            });
        } else {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
        }
    });

    printButton.addEventListener('click', () => { window.print(); });

    // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
    function handleFile(file) {
        fileNameDisplay.innerHTML = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: <strong>${file.name}</strong>`;
        showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...', true);
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (fileExtension === 'zip') handleZipFile(file);
        else if (fileExtension === 'xml') handleXmlFile(file);
        else showError('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ .xml –∏–ª–∏ .zip —Ñ–∞–π–ª.');
    }

    function handleXmlFile(file) {
        const reader = new FileReader();
        reader.onload = e => parseXmlContent(e.target.result);
        reader.onerror = e => showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.', e);
        reader.readAsText(file, 'UTF-8');
    }

    function handleZipFile(file) {
        JSZip.loadAsync(file).then(zip => {
            const xmlFileName = Object.keys(zip.files).find(name => !zip.files[name].dir && name.toLowerCase().endsWith('.xml'));
            if (!xmlFileName) throw new Error('XML —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ.');
            return zip.files[xmlFileName].async('string');
        }).then(parseXmlContent).catch(err => showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ZIP –∞—Ä—Ö–∏–≤–∞: ' + err.message));
    }

    function parseXmlContent(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            if (E(xmlDoc, "parsererror")) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å XML. –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
            displayData(xmlDoc, xmlString);
        } catch (err) {
            showError(err.message);
        } finally {
            loader.classList.add('hidden');
        }
    }

    // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
    function displayData(xmlDoc, xmlText) {
        let mainHtml = '';
        let sidebarHtml = '';
        let sectionsFound = 0;

        // --- SIDEBAR: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ---
        const formParcels = E(xmlDoc, 'FormParcels');
        const reasonText = T(xmlDoc, 'GeneralCadastralWorks > Reason');
        if (formParcels || reasonText !== '‚Äî') {
            sectionsFound++;
            let generalInfoContent = '';
            if (formParcels) {
                const method = A(formParcels, 'Method');
                generalInfoContent += `<div class="info-card">
                    <div class="info-label">–°–ø–æ—Å–æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ó–£</div>
                    <div class="info-value">${planTypes[method] || `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π (${method})`}</div>
                </div>`;
            }
            if (reasonText !== '‚Äî') {
                 generalInfoContent += `<div class="info-card" style="grid-column: 1 / -1;">
                    <div class="info-label">–û—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç</div>
                    <div class="info-value">${reasonText}</div>
                </div>`;
            }
            sidebarHtml += `<div class="section">
                <div class="section-header">${sectionIcons.generalInfo}<h3 class="section-title">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3></div>
                <div class="section-content" style="padding:16px"><div class="info-grid">${generalInfoContent}</div></div>
            </div>`;
        }
        
        // --- SIDEBAR: –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç ---
        const contractor = E(xmlDoc, 'Contractor');
        const client = E(xmlDoc, 'Client Person');
        if (contractor || client) {
            sectionsFound++;
            let participantsHtml = `<div class="section"><div class="section-header">${sectionIcons.participants}<h3 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç</h3></div><div class="section-content" style="padding:16px">`;
            if (contractor) {
                const cadWork = E(contractor, 'AgreementCadWork');
                participantsHtml += `<div class="subsection" style="margin-top:0;"><div class="subsection-title">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –∏–Ω–∂–µ–Ω–µ—Ä</div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">–§–ò–û</div><div class="info-value">${T(contractor, 'FamilyName')} ${T(contractor, 'FirstName')} ${T(contractor, 'Patronymic')}</div></div>
                        <div class="info-card"><div class="info-label">‚Ññ –≤ —Ä–µ–µ—Å—Ç—Ä–µ</div><div class="info-value">${T(contractor, 'CadastralEngineerRegistryNumber')} (–æ—Ç ${T(contractor, 'DateEntering')})</div></div>
                        <div class="info-card"><div class="info-label">–°–ù–ò–õ–°</div><div class="info-value">${T(contractor, 'SNILS')}</div></div>
                        <div class="info-card" style="grid-column: 1 / -1;"><div class="info-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="info-value">–¢–µ–ª: ${T(contractor, 'Telephone')}, Email: ${T(contractor, 'Email')}</div></div>
                        <div class="info-card" style="grid-column: 1 / -1;"><div class="info-label">–°–†–û</div><div class="info-value">${T(contractor, 'SelfRegulatoryOrganization')}</div></div>
                        <div class="info-card" style="grid-column: 1 / -1;"><div class="info-label">–î–æ–≥–æ–≤–æ—Ä</div><div class="info-value">${T(cadWork, 'Name')} ‚Ññ${T(cadWork, 'NumberAgreement')} –æ—Ç ${T(cadWork, 'DateAgreement')}</div></div>
                    </div></div>`;
            }
            if (client) {
                 participantsHtml += `<div class="subsection"><div class="subsection-title">–ó–∞–∫–∞–∑—á–∏–∫</div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">–§–ò–û</div><div class="info-value">${T(client, 'FamilyName')} ${T(client, 'FirstName')} ${T(client, 'Patronymic')}</div></div>
                        <div class="info-card"><div class="info-label">–°–ù–ò–õ–°</div><div class="info-value">${T(client, 'SNILS')}</div></div>
                    </div></div>`;
            }
            participantsHtml += `</div></div>`;
            sidebarHtml += participantsHtml;
        }

        // --- SIDEBAR: –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---
        const inputData = E(xmlDoc, 'InputData');
        if (inputData) {
            sectionsFound++;
            let inputDataHtml = `<div class="section"><div class="section-header">${sectionIcons.inputData}<h3 class="section-title">–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3></div><div class="section-content" style="padding:16px">`;
            const documents = All(inputData, 'Documents > Document');
            if (documents.length > 0) {
                 inputDataHtml += `<div class="subsection" style="margin-top:0;"><div class="subsection-title">–î–æ–∫—É–º–µ–Ω—Ç—ã</div>
                 <table class="data-table"><thead><tr><th class="left-align">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th class="no-wrap">‚Ññ</th><th class="no-wrap">–î–∞—Ç–∞</th></tr></thead><tbody>
                 ${Array.from(documents).map(doc => `<tr><td class="left-align">${T(doc, 'Name')}</td><td class="no-wrap">${T(doc, 'Number')}</td><td class="no-wrap">${T(doc, 'Date')}</td></tr>`).join('')}
                 </tbody></table></div>`;
            }
            const geoBases = All(inputData, 'GeodesicBases > GeodesicBase');
            if (geoBases.length > 0) {
                 inputDataHtml += `<div class="subsection"><div class="subsection-title">–ì–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞</div>
                 <table class="data-table"><thead><tr><th class="left-align">–ü—É–Ω–∫—Ç</th><th>–ö–ª–∞—Å—Å</th><th>X</th><th>Y</th></tr></thead><tbody>
                 ${Array.from(geoBases).map(base => `<tr><td class="left-align">${T(base, 'PName')} (${T(base, 'PKind')})</td><td>${T(base, 'PKlass')}</td><td>${T(base, 'OrdX')}</td><td>${T(base, 'OrdY')}</td></tr>`).join('')}
                 </tbody></table></div>`;
            }
            const meanSurvey = E(inputData, 'MeansSurvey > MeanSurvey');
            if (meanSurvey) {
                  inputDataHtml += `<div class="subsection"><div class="subsection-title">–°—Ä–µ–¥—Å—Ç–≤–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π</div>
                    <div class="info-grid">
                        <div class="info-card" style="grid-column: 1 / -1;"><div class="info-label">–ü—Ä–∏–±–æ—Ä</div><div class="info-value">${T(meanSurvey, 'Name')}</div></div>
                        <div class="info-card"><div class="info-label">–ù–æ–º–µ—Ä</div><div class="info-value">${T(meanSurvey, 'Number')}</div></div>
                        <div class="info-card"><div class="info-label">–ü–æ–≤–µ—Ä–∫–∞</div><div class="info-value">${T(meanSurvey, 'CertificateVerification')}</div></div>
                    </div></div>`;
            }
            inputDataHtml += `</div></div>`;
            sidebarHtml += inputDataHtml;
        }

        // --- MAIN: –û–±—Ä–∞–∑—É–µ–º—ã–π —É—á–∞—Å—Ç–æ–∫ ---
        const newParcel = E(xmlDoc, 'NewParcel');
        if (newParcel) {
            sectionsFound++;
            const categoryCode = A(E(newParcel, 'Category'), 'Category');
            const categoryName = landCategories[categoryCode] || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
            let sectionContent = `
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –∫–≤–∞—Ä—Ç–∞–ª</div><div class="info-value">${T(newParcel, 'CadastralBlock')}</div></div>
                    <div class="info-card"><div class="info-label">–ü–ª–æ—â–∞–¥—å, –∫–≤.–º.</div><div class="info-value">${T(newParcel, 'Area > Area')} (¬±${T(newParcel, 'Area > Inaccuracy')})</div></div>
                    <div class="info-card"><div class="info-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</div><div class="info-value">${categoryName} <code>${categoryCode}</code></div></div>
                    <div class="info-card"><div class="info-label">–í–∏–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div><div class="info-value">${A(E(newParcel, 'PermittedUseEstablished'), 'ByDocument')}</div></div>
                    <div class="info-card"><div class="info-label">–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</div><div class="info-value">${T(newParcel, 'ProvidingPassCadastralNumbers > Other')}</div></div>
                </div>
                ${T(newParcel, 'Area > Formula') !== '‚Äî' ? `<div class="subsection"><div class="subsection-title">–§–æ—Ä–º—É–ª–∞ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏</div><div class="conclusion-text">${T(newParcel, 'Area > Formula')}</div></div>` : ''}
                ${All(newParcel, 'ObjectsRealty CadastralNumber').length > 0 ? `<div class="subsection"><div class="subsection-title">–û–ö–° –Ω–∞ —É—á–∞—Å—Ç–∫–µ</div><div class="info-grid">${Array.from(All(newParcel, 'ObjectsRealty CadastralNumber')).map(node => `<div class="info-card"><div class="info-value">${node.textContent}</div></div>`).join('')}</div></div>` : ''}
                ${E(newParcel, 'Address') ? `<div class="subsection"><div class="subsection-title">–ê–¥—Ä–µ—Å</div><div class="address-display">${[T(E(newParcel, 'Address'), 'RussianFederation'), T(E(newParcel, 'Address'), 'Region') !== '‚Äî' ? `–†–µ—Å–ø. ${T(E(newParcel, 'Address'), 'Region')}` : '', T(E(newParcel, 'Address'), 'District') !== '‚Äî' ? `${A(E(E(newParcel, 'Address'), 'District'), 'Type')} ${T(E(newParcel, 'Address'), 'District')}` : '', T(E(newParcel, 'Address'), 'City') !== '‚Äî' ? `${A(E(E(newParcel, 'Address'), 'City'), 'Type')} ${T(E(newParcel, 'Address'), 'City')}` : '', T(E(newParcel, 'Address'), 'Street') !== '‚Äî' ? `${A(E(E(newParcel, 'Address'), 'Street'), 'Type')} ${T(E(newParcel, 'Address'), 'Street')}` : '', T(E(newParcel, 'Address'), 'Other')].filter(p => p && p.trim() && p !== '‚Äî' && !p.includes('‚Äî')).join(', ')}</div><div class="info-grid" style="margin-top: 16px;"><div class="info-card"><div class="info-label">FIAS</div><div class="info-value">${T(E(newParcel, 'Address'), 'FIAS')}</div></div></div></div>` : ''}
            `;
            mainHtml += `<div class="section">
                <div class="section-header">${sectionIcons.newParcel}<h3 class="section-title">–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—Ä–∞–∑—É–µ–º–æ–º —É—á–∞—Å—Ç–∫–µ (${A(newParcel, 'Definition')})</h3></div>
                <div class="section-content" style="padding:16px">${sectionContent}</div>
            </div>`;
        }
        
        // --- MAIN: –£—Ç–æ—á–Ω—è–µ–º—ã–π —É—á–∞—Å—Ç–æ–∫ (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ / —É—Ç–æ—á–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü) ---
        const specifiedParcels = All(xmlDoc, 'SpecifyParcel > ExistParcel');
        for (const parcel of specifiedParcels) {
            sectionsFound++;
            const cadNum = A(parcel, 'CadastralNumber');
            const categoryCode = A(E(parcel, 'Category'), 'Category');
            const categoryName = landCategories[categoryCode] || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
            let sectionContent = '';
            
            sectionContent += `
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä</div><div class="info-value"><code>${cadNum}</code></div></div>
                    <div class="info-card"><div class="info-label">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –∫–≤–∞—Ä—Ç–∞–ª</div><div class="info-value">${T(parcel, 'CadastralBlock')}</div></div>
                    ${categoryCode && categoryCode !== '‚Äî' ? `<div class="info-card"><div class="info-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</div><div class="info-value">${categoryName} <code>${categoryCode}</code></div></div>` : ''}
                    <div class="info-card"><div class="info-label">–£—Ç–æ—á–Ω–µ–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å, –∫–≤.–º.</div><div class="info-value">${T(parcel, 'Area > Area')} (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å ¬±${T(parcel, 'Area > Inaccuracy')})</div></div>
                    <div class="info-card"><div class="info-label">–ü–ª–æ—â–∞–¥—å –ø–æ –ï–ì–†–ù, –∫–≤.–º.</div><div class="info-value">${T(parcel, 'AreaInGKN')}</div></div>
                    <div class="info-card"><div class="info-label">–†–∞–∑–Ω–∏—Ü–∞ –ø–ª–æ—â–∞–¥–µ–π, –∫–≤.–º.</div><div class="info-value">${T(parcel, 'DeltaArea')}</div></div>
                    <div class="info-card" style="grid-column: 1 / -1;"><div class="info-label">–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</div><div class="info-value">${T(parcel, 'ProvidingPassCadastralNumbers > Other')}</div></div>
                </div>
                ${T(parcel, 'Area > Formula') !== '‚Äî' ? `<div class="subsection"><div class="subsection-title">–§–æ—Ä–º—É–ª–∞ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏</div><div class="conclusion-text">${T(parcel, 'Area > Formula')}</div></div>` : ''}
            `;

            const entitySpatial = E(parcel, 'EntitySpatial');
            if (entitySpatial) {
                let tableContent = '';
                const uniquePoints = new Map();
                const ordinates = All(entitySpatial, 'SpelementUnit > NewOrdinate, SpelementUnit > Ordinate');
                ordinates.forEach(ord => {
                    const pointName = `${A(ord, 'PointPref') || ''}${A(ord, 'NumGeopoint')}`;
                    if (pointName && pointName !== '‚Äî' && !uniquePoints.has(pointName)) {
                        uniquePoints.set(pointName, `<tr><td>${pointName}</td><td>${A(ord, 'X')}</td><td>${A(ord, 'Y')}</td>
                            <td class="left-align">${A(ord, 'GeopointZacrep')}</td><td>${A(ord, 'DeltaGeopoint')}</td></tr>`);
                    }
                });
                uniquePoints.forEach(rowHtml => tableContent += rowHtml);

                sectionContent += `<div class="subsection" id="main-coord-section"><div class="subsection-title">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö —Ç–æ—á–µ–∫</div><table class="data-table coord-table"><thead><tr><th>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>X</th><th>Y</th><th class="left-align">–ú–µ—Ç–æ–¥ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è</th><th>–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å, –º</th></tr></thead><tbody>${tableContent}</tbody></table></div>`;
                
                const borders = All(entitySpatial, 'Borders > Border');
                if (borders.length > 0) {
                     sectionContent += `<div class="subsection"><div class="subsection-title">–î–ª–∏–Ω—ã –ª–∏–Ω–∏–π</div>
                              <table class="data-table"><thead><tr><th>–£—á–∞—Å—Ç–æ–∫</th><th>–î–ª–∏–Ω–∞, –º</th></tr></thead><tbody>
                              ${Array.from(borders).map(b => `<tr><td>${A(b,'Point1')}-${A(b,'Point2')}</td><td>${T(b,'Edge > Length') || T(b, 'Length')}</td></tr>`).join('')}
                              </tbody></table></div>`;
                }
            }

            mainHtml += `<div class="section">
                <div class="section-header">
                    ${sectionIcons.newParcel}
                    <h3 class="section-title">–°–≤–µ–¥–µ–Ω–∏—è –æ–± —É—Ç–æ—á–Ω—è–µ–º–æ–º —É—á–∞—Å—Ç–∫–µ</h3>
                    <button class="header-button copy-coords-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ—Ç–∫—Ä—ã—Ç—å —Å—Ö–µ–º—É">${sectionIcons.copyXY}</button>
                </div>
                <div class="section-content" style="padding:16px">${sectionContent}</div>
            </div>`;
        }

        // --- MAIN: –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å–º–µ–∂–Ω–æ–≥–æ ---
        const specifyRelatedParcel = E(xmlDoc, 'SpecifyRelatedParcel');
        if(specifyRelatedParcel){
            sectionsFound++;
            let tableContent = '';
            All(specifyRelatedParcel, 'ChangeBorder').forEach(ch => {
                const oldOrd = E(ch, 'OldOrdinate');
                const newOrd = E(ch, 'NewOrdinate');
                tableContent += `<tr>
                            <td>${A(oldOrd || newOrd, 'NumGeopoint') || A(newOrd, 'PointPref') + A(newOrd, 'NumGeopoint')}</td>
                            <td>${oldOrd ? `${A(oldOrd, 'X')}, ${A(oldOrd, 'Y')}` : '‚Äî'}</td>
                            <td>${newOrd ? `${A(newOrd, 'X')}, ${A(newOrd, 'Y')}` : '‚Äî'}</td>
                            <td class="left-align">${newOrd ? `Œî=${A(newOrd, 'DeltaGeopoint')} –º, ${A(newOrd, 'GeopointZacrep')}`: '–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞'}</td>
                        </tr>`;
            });
            mainHtml += `<div class="section">
                <div class="section-header">${sectionIcons.relatedParcel}<h3 class="section-title">–£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å–º–µ–∂–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞: ${A(specifyRelatedParcel, 'CadastralNumber')}</h3></div>
                <div class="section-content" style="padding:16px"><table class="data-table"><thead><tr><th>–¢–æ—á–∫–∞</th><th>–°—Ç–∞—Ä—ã–µ –∫–æ–æ—Ä–¥. (X, Y)</th><th>–ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥. (X, Y)</th><th class="left-align">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead><tbody>${tableContent}</tbody></table></div>
            </div>`;
        }
        
        // --- MAIN: –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ò–ò ---
        const conclusion = E(xmlDoc, 'Conclusion');
        if (conclusion && conclusion.textContent.trim()) {
            sectionsFound++;
            const conclusionId = 'conclusion-section-' + Date.now();
            mainHtml += `<div class="section" id="${conclusionId}">
                <div class="section-header">
                    ${sectionIcons.conclusion}
                    <h3 class="section-title">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞</h3>
                    <button class="header-button" onclick="checkConclusionWithAI('${conclusionId}')" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –ò–ò">
                        ${sectionIcons.aiCheckIcon}
                    </button>
                </div>
                <div class="section-content" style="padding:16px">
                    <div class="conclusion-text">${conclusion.textContent.trim()}</div>
                    <div id="ai-conclusion-result" class="ai-result-container hidden"></div>
                </div>
            </div>`;
        }

        // --- MAIN: –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ ---
        const graphicFiles = [
            { title: '–°—Ö–µ–º–∞ –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–π', file: A(E(xmlDoc, 'SchemeGeodesicPlotting'), 'Name') },
            { title: '–°—Ö–µ–º–∞ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ó–£', file: A(E(xmlDoc, 'SchemeDisposition'), 'Name') },
            { title: '–ß–µ—Ä—Ç–µ–∂ –∑–µ–º–µ–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞', file: A(E(xmlDoc, 'DiagramParcelsSubParcels > AppliedFile'), 'Name') },
            { title: '–ê–∫—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü', file: A(E(xmlDoc, 'AgreementDocument > AppliedFile'), 'Name') }
        ].filter(f => f.file !== '‚Äî');
        if(graphicFiles.length > 0) {
            sectionsFound++;
            mainHtml += `<div class="section"><div class="section-header">${sectionIcons.graphics}<h3 class="section-title">–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã</h3></div><div class="section-content" style="padding:16px">
                    <table class="data-table"><thead><tr><th class="left-align">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</th><th class="left-align">–ò–º—è —Ñ–∞–π–ª–∞</th></tr></thead><tbody>
                    ${graphicFiles.map(f => `<tr><td class="left-align">${f.title}</td><td class="left-align"><span class="file-name">${f.file}</span></td></tr>`).join('')}
                    </tbody></table></div></div>`;
        }
        const appendixFiles = All(xmlDoc, 'Appendix > AppliedFiles');
        if(appendixFiles.length > 0) {
            sectionsFound++;
            mainHtml += `<div class="section"><div class="section-header">${sectionIcons.appendix}<h3 class="section-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3></div><div class="section-content" style="padding:16px">
                    <table class="data-table"><thead><tr><th>‚Ññ</th><th class="left-align">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th class="left-align">–ò–º—è —Ñ–∞–π–ª–∞</th></tr></thead><tbody>
                    ${Array.from(appendixFiles).map(f => `<tr><td>${T(f, 'NumberAppendix')}</td><td class="left-align">${T(f, 'NameAppendix')}</td><td class="left-align"><span class="file-name">${A(E(f, 'AppliedFile'), 'Name')}</span></td></tr>`).join('')}
                    </tbody></table></div></div>`;
        }

        const validationHtml = runValidation(xmlDoc, xmlText);
        if(validationHtml) {
             mainHtml += `<div class="section validation-section">
                <div class="section-header">${sectionIcons.validation}<h3 class="section-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–∂–µ–≤–æ–≥–æ –ø–ª–∞–Ω–∞</h3></div>
                <div class="section-content" style="padding:16px">${validationHtml}</div>
            </div>`;
        }

        if (sectionsFound > 0) {
            mainColumn.innerHTML = mainHtml;
            sidebarColumn.innerHTML = sidebarHtml;
            resultsContainer.classList.remove('hidden');
            statusContainer.classList.add('hidden');
            printButtonContainer.classList.remove('hidden');
            messageArea.innerHTML = '';
        } else {
            showError('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω, –Ω–æ –≤ –Ω–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –º–µ–∂–µ–≤–æ–≥–æ –ø–ª–∞–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ XML –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞.');
        }
    }

    function runValidation(xmlDoc, xmlText) {
        let messages = [];
        const knRegex = /\d{2}:\d{2}:\d{6,7}:\d+/g;
        const blockRegex = /\d{2}:\d{2}:\d{6,7}/;
        let allNumbers = new Set((xmlText.match(knRegex) || []));
        All(xmlDoc, 'CadastralBlock').forEach(b => allNumbers.add(b.textContent.trim()));
        const quarters = new Map();
        allNumbers.forEach(num => {
            const match = num.match(blockRegex);
            if (match) {
                const quarter = match[0];
                if (!quarters.has(quarter)) quarters.set(quarter, []);
                quarters.get(quarter).push(num);
            }
        });
        const colors = ['#1d4ed8', '#b91c1c', '#c2410c', '#15803d', '#86198f'];
        let colorIndex = 0;
        const quarterColors = new Map();
        for (const q of quarters.keys()) { quarterColors.set(q, colors[colorIndex % colors.length]); colorIndex++; }
        if (quarters.size > 1) { messages.push(`<div class="validation-message validation-warning">${sectionIcons.warningIcon} <strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–±—ä–µ–∫—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –∫–≤–∞—Ä—Ç–∞–ª–æ–≤.</div>`); }
        let numberListHtml = '<ul id="cadastralNumbersList">';
        quarters.forEach((numbers, quarter) => { const color = quarterColors.get(quarter); numbers.sort().forEach(num => { numberListHtml += `<li style="border-color:${color}; color:${color};">${num}</li>`; }); });
        numberListHtml += '</ul>';
        messages.push(`<div class="subsection" style="margin-top:0"><div class="subsection-title">–í—Å–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ</div>${numberListHtml}</div>`);
        const mainParcel = E(xmlDoc, 'NewParcel') || E(xmlDoc, 'ExistParcel');
        if (mainParcel) {
            const categoryCode = A(E(mainParcel, 'Category'), 'Category');
            const requiredMt = accuracyStandards[categoryCode];
            const area = parseFloat(T(mainParcel, 'Area > Area'));
            const statedAreaInaccuracy = parseFloat(T(mainParcel, 'Area > Inaccuracy'));
            const ordinates = All(mainParcel, 'SpelementUnit > NewOrdinate, SpelementUnit > Ordinate');
            if (ordinates.length > 0) {
                const accuracies = new Set();
                let allFixingsFilled = true;
                ordinates.forEach(ord => {
                    const delta = A(ord, 'DeltaGeopoint');
                    if(delta && delta !== '‚Äî') accuracies.add(parseFloat(delta));
                    if(A(ord, 'GeopointZacrep') === '‚Äî') allFixingsFilled = false;
                });
                if (!allFixingsFilled) { messages.push(`<div class="validation-message validation-warning">${sectionIcons.warningIcon} <strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –ù–µ –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –Ω–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏.</div>`);}
                if (accuracies.size > 1) { messages.push(`<div class="validation-message validation-warning">${sectionIcons.warningIcon} <strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –£ —Ç–æ—á–µ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏ (${Array.from(accuracies).join(', ')}).</div>`); }
                const actualMt = accuracies.size > 0 ? accuracies.values().next().value : null;
                if (requiredMt && actualMt) {
                    if (actualMt > requiredMt) { messages.push(`<div class="validation-message validation-error">${sectionIcons.errorIcon} <strong>–û—à–∏–±–∫–∞ Mt:</strong> –ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ <strong>${actualMt}</strong> –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º–∞—Ç–∏–≤ <strong>${requiredMt}</strong> –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${landCategories[categoryCode]}".</div>`); } 
                    else { messages.push(`<div class="validation-message validation-success">${sectionIcons.successIcon} <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ Mt:</strong> –ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ <strong>${actualMt}</strong> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ—Ä–º–∞—Ç–∏–≤—É –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–µ–º–µ–ª—å.</div>`); }
                } else if (!requiredMt) { messages.push(`<div class="validation-message validation-warning">${sectionIcons.warningIcon} <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ Mt:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ—Ä–º–∞—Ç–∏–≤ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏, —Ç–∞–∫ –∫–∞–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ.</div>`); }
                if (area && actualMt && statedAreaInaccuracy) {
                    const calculatedAreaInaccuracy = Math.round(3.5 * actualMt * Math.sqrt(area));
                    if (calculatedAreaInaccuracy !== statedAreaInaccuracy) { messages.push(`<div class="validation-message validation-error">${sectionIcons.errorIcon} <strong>–û—à–∏–±–∫–∞ ŒîP:</strong> –†–∞—Å—á–µ—Ç–Ω–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –ø–ª–æ—â–∞–¥–∏ <strong>(${calculatedAreaInaccuracy} –º¬≤)</strong> –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ XML <strong>(${statedAreaInaccuracy} –º¬≤)</strong>.</div>`); } 
                    else { messages.push(`<div class="validation-message validation-success">${sectionIcons.successIcon} <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ ŒîP:</strong> –†–∞—Å—á–µ—Ç–Ω–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –ø–ª–æ—â–∞–¥–∏ <strong>(${calculatedAreaInaccuracy} –º¬≤)</strong> —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ XML.</div>`); }
                }
            }
        }
        return messages.length > 0 ? messages.join('') : '';
    }
});

// --- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –ò–ò ---
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

async function checkConclusionWithAI(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;

    const originalTextElement = section.querySelector('.conclusion-text');
    const resultContainer = section.querySelector('#ai-conclusion-result');
    const originalText = originalTextElement.textContent.trim();

    if (!originalText) {
        resultContainer.innerHTML = `<div class="ai-result-error">–¢–µ–∫—Å—Ç –∑–∞–∫–ª—é—á–µ–Ω–∏—è –ø—É—Å—Ç.</div>`;
        resultContainer.classList.remove('hidden');
        return;
    }

    resultContainer.innerHTML = `<div class="ai-spinner"><div class="loader"></div><span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–∫–ª—é—á–µ–Ω–∏–µ...</span></div>`;
    resultContainer.classList.remove('hidden');

    const systemPrompt = `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞" –∏–∑ –º–µ–∂–µ–≤–æ–≥–æ –ø–ª–∞–Ω–∞.
–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞:
1.  **–ü–æ–ª–Ω–æ—Ç—É:** –£–ø–æ–º—è–Ω—É—Ç—ã –ª–∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç (–¥–æ–≥–æ–≤–æ—Ä, –ø—Ä–æ–µ–∫—Ç), –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è/—É—Ç–æ—á–Ω–µ–Ω–∏—è, –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞?
2.  **–Ø—Å–Ω–æ—Å—Ç—å –∏ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å:** –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–µ—Ç–∫–∏–º–∏, –±–µ–∑ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏.
3.  **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã.
4.  **–õ–æ–≥–∏—á–Ω–æ—Å—Ç—å:** –û–±–æ—Å–Ω–æ–≤–∞–Ω—ã –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—á–µ–º—É –ø–ª–æ—â–∞–¥—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –∫–∞–∫ –æ–±–µ—Å–ø–µ—á–µ–Ω –¥–æ—Å—Ç—É–ø).
5.  **–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É.**

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å —Ç—Ä–µ–º—è –ø–æ–ª—è–º–∏:
- "is_correct": boolean (true, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–¥–µ–∞–ª–µ–Ω –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–æ–∫, –∏–Ω–∞—á–µ false).
- "feedback": string (–¥–µ—Ç–∞–ª—å–Ω—ã–π, –Ω–æ –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å –ø—É–Ω–∫—Ç–∞–º–∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É –¥–µ–ª–∞).
- "corrected_text": string (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è. –ï—Å–ª–∏ –ø—Ä–∞–≤–æ–∫ –Ω–µ—Ç, –≤–µ—Ä–Ω–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç).

–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –≤–Ω–µ JSON.`;

    const userPrompt = `${systemPrompt}\n\n–¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:\n---\n${originalText}`;

    let apiUrl;
    let requestBody;
    const modelId = "gemini-2.5-flash-lite-preview-06-17";

    if (PROXY_MODE === 1) {
        apiUrl = `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`;
        requestBody = {
            model: modelId,
            messages: [{ role: "user", content: userPrompt }],
            max_tokens: 2048,
            response_format: { type: "json_object" }
        };
    } else {
        // Fallback or alternative proxy logic can be placed here
        resultContainer.innerHTML = `<div class="ai-result-error">–†–µ–∂–∏–º –ø—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.</div>`;
        return;
    }
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (!response.ok) {
            const errorDetail = data?.error?.message || `–°—Ç–∞—Ç—É—Å ${response.status}`;
            throw new Error(`–û—à–∏–±–∫–∞ API (${response.status}): ${errorDetail}`);
        }
        
        let aiResponseText = data.choices?.[0]?.message?.content;
        if (!aiResponseText) {
             throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò (–ø—É—Å—Ç–æ–µ –ø–æ–ª–µ content).');
        }

        let parsedResponse;
        try {
            const cleanedText = aiResponseText.trim().replace(/^```json\s*|\s*```$/g, '');
            parsedResponse = JSON.parse(cleanedText);
        } catch (e) {
            console.error("AI Response (raw):", aiResponseText);
            throw new Error("–û—Ç–≤–µ—Ç –ò–ò –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON.");
        }

        let resultHtml = '';
        if (parsedResponse.is_correct) {
            resultHtml = `<div class="ai-result-success">${sectionIcons.successIcon} <strong>–í–µ—Ä–¥–∏–∫—Ç –ò–ò:</strong> –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ö–æ—Ä–æ—à–æ. –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç.</div>`;
        } else {
            resultHtml += `<h4>${sectionIcons.warningIcon} –ê–Ω–∞–ª–∏–∑ –ò–ò:</h4><div class="ai-feedback">${escapeHtml(parsedResponse.feedback)}</div>`;
            if (parsedResponse.corrected_text && parsedResponse.corrected_text !== originalText) {
                resultHtml += `<h4>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è:</h4><pre class="ai-corrected-text">${escapeHtml(parsedResponse.corrected_text)}</pre>
                <button class="ai-copy-button" onclick="copyAiConclusion(this)">
                    ${sectionIcons.copyIcon}
                    <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</span>
                </button>`;
            }
        }
        resultContainer.innerHTML = resultHtml;

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è —Å –ò–ò:', error);
        resultContainer.innerHTML = `<div class="ai-result-error"><strong>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:</strong> ${error.message}</div>`;
    }
}

function copyAiConclusion(buttonElement) {
    const resultContainer = buttonElement.closest('.ai-result-container');
    const correctedTextElement = resultContainer.querySelector('.ai-corrected-text');
    if (!correctedTextElement) return;

    const textToCopy = correctedTextElement.textContent;
    navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = buttonElement.querySelector('span').textContent;
        buttonElement.querySelector('span').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        buttonElement.disabled = true;
        setTimeout(() => {
            buttonElement.querySelector('span').textContent = originalText;
            buttonElement.disabled = false;
        }, 2000);
    }).catch(err => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.');
        console.error('Copy error:', err);
    });
}
</script>
</body>
</html>
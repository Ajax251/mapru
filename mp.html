<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Межевой план</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link id="favicon" rel="icon" href="img/mp.png" type="image/png">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --accent-color: #0ea5e9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f0f4f8;
            color: var(--text-primary);
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .content { padding: 24px; }

        .file-upload-section {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
        }
        .file-upload-area {
            text-align: center;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }
        .file-upload-area:hover { background: white; transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .file-upload-area.dragover { background: #dbeafe !important; border-color: var(--primary-color) !important; }
        .file-upload-section.dragover { border-color: var(--primary-color); background: #f0f9ff; }
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--primary-color);
            line-height: 1;
        }
        .upload-text { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .upload-subtext { color: var(--text-secondary); font-size: 0.9rem; }
        #fileInput { display: none; }
        .status-container {
            text-align: center; margin: 24px 0; min-height: 60px;
            display: flex; align-items: center; justify-content: center; gap: 16px;
        }
        .loader {
            width: 32px; height: 32px; border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-text { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); }
        .hidden { display: none; }

        #resultsContainer {
            display: grid;
            grid-template-columns: 2fr 1.2fr;
            gap: 24px;
            align-items: start;
        }
        #mainColumn, #sidebarColumn {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: white; border-radius: 12px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); overflow: hidden;
            width: 100%;
            margin-bottom: 0;
        }
        .section-header {
            background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
            padding: 16px 20px; border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-icon {
            width: 24px;
            height: 24px;
            color: var(--primary-color);
            flex-shrink: 0;
        }
        .section-title { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); margin: 0; }

        .copy-coords-btn {
            margin-left: auto; /* Прижимает кнопку вправо */
            padding: 4px;
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .copy-coords-btn:hover {
            background-color: var(--border-color);
        }
        .copy-coords-btn .section-icon {
            width: 24px;
            height: 24px;
        }

        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px; margin-bottom: 16px;
        }
        .info-card {
            background: var(--secondary-color); border-radius: 8px; padding: 16px;
            border: 1px solid var(--border-color);
        }
        .info-label {
            font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .info-value { font-size: 1rem; color: var(--text-primary); font-weight: 500; }
        .info-value code {
            background: #f1f5f9; padding: 2px 6px; border-radius: 4px;
            font-family: 'Courier New', monospace; font-size: 0.9rem;
        }
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 16px;
            border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-sm);
        }
        .data-table th {
            background: var(--primary-color); color: white; padding: 12px 16px;
            text-align: left; font-weight: 600; font-size: 0.9rem;
        }
        .data-table td {
            padding: 12px 16px; border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }
        .data-table tbody tr:hover { background: var(--secondary-color); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .coord-table { font-family: 'Courier New', monospace; font-size: 0.9rem; }
        .coord-table th { text-align: center; }
        .coord-table td { text-align: right; }
        .coord-table td:first-child { text-align: center; font-weight: 600; }
        .coord-table td:nth-child(4) { text-align: left; }
        .address-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd; border-radius: 8px; padding: 16px;
            font-size: 1.1rem; font-weight: 500; color: var(--text-primary);
        }
        .conclusion-text {
            background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px;
            padding: 16px; font-family: 'Courier New', monospace; font-size: 0.9rem;
            line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;
        }
        .error-message {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;
            padding: 16px; color: var(--error-color); font-weight: 500; text-align: center;
        }
        .subsection { margin-top: 24px; }
        .subsection-title {
            font-size: 1.1rem; font-weight: 600; color: var(--text-primary);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color);
        }
        .file-name {
            font-family: 'Courier New', monospace; background: #f1f5f9; padding: 2px 6px;
            border-radius: 4px; font-size: 0.9rem;
        }

        #printButtonContainer {
            text-align: center;
            margin-bottom: 20px;
        }
        .print-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }
        .print-btn:hover {
            background-color: #1d4ed8;
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .print-btn svg {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 1024px) {
            #resultsContainer {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { margin: 0; }
            .content { padding: 16px; }
            .info-grid { grid-template-columns: 1fr; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 12px; }
        }

        @media print {
            body, .container {
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
                background: white;
                color: black;
            }
            .file-upload-section, .status-container, #printButtonContainer, .copy-coords-btn {
                display: none !important;
            }
            #resultsContainer {
                display: block; /* Сбрасываем грид для простого потока */
                gap: 0;
            }
            #mainColumn, #sidebarColumn {
                display: block;
                width: 100%;
            }
            .section {
                box-shadow: none;
                border: 1px solid #ccc;
                border-radius: 0;
                page-break-inside: avoid; /* Стараемся не разрывать секции между страницами */
                margin-bottom: 20px;
            }
            .section-header {
                background: #f0f0f0 !important; /* Светлый фон для заголовков */
            }
            .data-table th {
                background: #e5e5e5 !important; /* Убираем цветной фон, делаем его светлее */
                color: black !important;
            }
            .info-card, .conclusion-text {
                 background: #f9f9f9 !important;
            }
             /* Важно для некоторых браузеров, чтобы применить фоновые цвета при печати */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="content">
            <div class="file-upload-section" id="dropSection">
                <div class="file-upload-area" id="dropArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Выберите XML или ZIP файл</div>
                    <div class="upload-subtext" id="fileNameDisplay">или перетащите его сюда</div>
                </div>
                <input type="file" id="fileInput" accept=".xml,.zip">
            </div>

            <div id="printButtonContainer" class="hidden">
                <button id="printButton" class="print-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 18.25M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5M17.25 4.5l-1.5-1.5-1.5 1.5M6.75 4.5l1.5-1.5 1.5 1.5m12.75 1.5-1.5-1.5-1.5 1.5M6.75 21l1.5 1.5 1.5-1.5m12.75 1.5l-1.5 1.5-1.5-1.5M12 6.75v10.5" />
                    </svg>
                    <span>Печать</span>
                </button>
            </div>

            <div class="status-container" id="statusContainer">
                <div class="loader hidden" id="loader"></div>
                <div id="messageArea">
                    <div class="status-text" id="statusText"></div>
                </div>
            </div>

            <div id="resultsContainer" class="hidden">
                <div id="mainColumn"></div>
                <div id="sidebarColumn"></div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Словари и Иконки ---
    const landCategories = {
        '003001000000': 'Земли сельскохозяйственного назначения',
        '003002000000': 'Земли населенных пунктов',
        '003003000000': 'Земли промышленности, энергетики, транспорта и иного специального назначения',
        '003004000000': 'Земли особо охраняемых территорий и объектов',
        '003005000000': 'Земли лесного фонда',
        '003006000000': 'Земли водного фонда',
        '003007000000': 'Земли запаса',
        '003008000000': 'Категория не установлена'
    };
    const planTypes = {
        '5': 'Образование ЗУ из земель в гос. или мун. собственности'
    };
    const sectionIcons = {
        generalInfo: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        participants: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
        inputData: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>`,
        newParcel: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>`,
        relatedParcel: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`,
        coordinates: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3m6-7h3m-3 4h3m-21-4h3m-3 4h3M12 12l-4 4m4-4l4 4m-4-4v-4m0 4l-4-4m4 4l4-4" /></svg>`,
        conclusion: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        graphics: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01" /><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /></svg>`,
        appendix: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>`,
        copyXY: `<svg xmlns="http://www.w3.org/2000/svg" class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path><text x="12" y="16.5" font-family="sans-serif" font-size="6" fill="currentColor" text-anchor="middle" font-weight="bold">XY</text></svg>`
    };

    // --- DOM элементы и утилиты ---
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const dropArea = document.getElementById('dropArea');
    const dropSection = document.getElementById('dropSection');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const statusContainer = document.getElementById('statusContainer');
    const messageArea = document.getElementById('messageArea');
    const resultsContainer = document.getElementById('resultsContainer');
    const mainColumn = document.getElementById('mainColumn');
    const sidebarColumn = document.getElementById('sidebarColumn');
    const printButtonContainer = document.getElementById('printButtonContainer');
    const printButton = document.getElementById('printButton');

    const E = (el, sel) => el.querySelector(sel);
    const All = (el, sel) => el.querySelectorAll(sel);
    const T = (el, sel) => el?.querySelector(sel)?.textContent.trim() || '—';
    const A = (el, attr) => el?.getAttribute(attr) || '—';

    function clearResults() {
        resultsContainer.classList.add('hidden');
        printButtonContainer.classList.add('hidden');
        mainColumn.innerHTML = '';
        sidebarColumn.innerHTML = '';
    }

    function showStatus(message, isLoading = false) {
        clearResults();
        messageArea.innerHTML = `<div class="status-text">${message}</div>`;
        statusContainer.classList.remove('hidden');
        loader.classList.toggle('hidden', !isLoading);
    }

    function showError(message) {
        clearResults();
        loader.classList.add('hidden');
        statusContainer.classList.remove('hidden');
        messageArea.innerHTML = `<div class="error-message">${message}</div>`;
        console.error(message);
    }

    // --- Обработчики событий ---
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) handleFile(file);
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        document.body.addEventListener(e, preventDefaults, false);
        dropSection.addEventListener(e, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover'].forEach(e => {
        dropSection.addEventListener(e, () => dropSection.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(e => {
        dropSection.addEventListener(e, () => dropSection.classList.remove('dragover'), false);
    });

    dropSection.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    }, false);

    document.body.addEventListener('click', function(event) {
        const copyBtn = event.target.closest('.copy-coords-btn');
        if (!copyBtn) return;
        event.preventDefault();

        const section = copyBtn.closest('.section');
        const coordTable = section?.querySelector('.coord-table tbody');
        if (!coordTable) {
            alert('Ошибка: таблица координат не найдена!');
            return;
        }

        const rows = coordTable.querySelectorAll('tr');
        let coordsToCopy = '';
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 3) {
                const x = cells[1].textContent.trim();
                const y = cells[2].textContent.trim();
                coordsToCopy += `${x}\t${y}\n`;
            }
        });
        coordsToCopy = coordsToCopy.trim();
        if (!coordsToCopy) {
            alert('Нет координат для копирования.');
            return;
        }

        if (navigator.clipboard) {
            navigator.clipboard.writeText(coordsToCopy).then(() => {
                window.open('схема.html', '_blank');
            }).catch(err => {
                console.error('Ошибка при копировании в буфер обмена:', err);
                alert('Не удалось скопировать координаты. Проверьте разрешения вашего браузера.');
            });
        } else {
            alert('Ваш браузер не поддерживает безопасное копирование в буфер обмена.');
        }
    });

    printButton.addEventListener('click', () => {
        window.print();
    });

    // --- Основная логика ---
    function handleFile(file) {
        fileNameDisplay.innerHTML = `Выбран файл: <strong>${file.name}</strong>`;
        showStatus('Обработка файла...', true);
        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (fileExtension === 'zip') handleZipFile(file);
        else if (fileExtension === 'xml') handleXmlFile(file);
        else showError('Неподдерживаемый тип файла. Пожалуйста, выберите .xml или .zip файл.');
    }

    function handleXmlFile(file) {
        const reader = new FileReader();
        reader.onload = e => parseXmlContent(e.target.result);
        reader.onerror = e => showError('Не удалось прочитать файл.', e);
        reader.readAsText(file, 'UTF-8');
    }

    function handleZipFile(file) {
        JSZip.loadAsync(file).then(zip => {
            const xmlFileName = Object.keys(zip.files).find(name => !zip.files[name].dir && name.toLowerCase().endsWith('.xml'));
            if (!xmlFileName) throw new Error('XML файл не найден в архиве.');
            return zip.files[xmlFileName].async('string');
        }).then(parseXmlContent).catch(err => showError('Ошибка при обработке ZIP архива: ' + err.message));
    }

    function parseXmlContent(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            if (E(xmlDoc, "parsererror")) throw new Error("Не удалось разобрать XML. Файл поврежден или имеет неверный формат.");
            displayData(xmlDoc);
        } catch (err) {
            showError(err.message);
        } finally {
            loader.classList.add('hidden');
        }
    }

    // --- Отображение данных в колонках ---
    function displayData(xmlDoc) {
        let mainHtml = '';
        let sidebarHtml = '';
        let sectionsFound = 0;

        // --- ИЗМЕНЕНО: Генерация блока "Общая информация" с добавлением "Основания" ---
        const formParcels = E(xmlDoc, 'FormParcels');
        const reasonText = T(xmlDoc, 'GeneralCadastralWorks > Reason');

        if (formParcels || reasonText !== '—') {
            sectionsFound++;
            let generalInfoContent = '';
            
            if (formParcels) {
                const method = A(formParcels, 'Method');
                generalInfoContent += `<div class="info-card">
                    <div class="info-label">Тип межевого плана</div>
                    <div class="info-value">${planTypes[method] || `Неизвестный тип (${method})`}</div>
                </div>`;
            }
            if (reasonText !== '—') {
                 generalInfoContent += `<div class="info-card" style="grid-column: 1 / -1;">
                    <div class="info-label">Основание для работ</div>
                    <div class="info-value">${reasonText}</div>
                </div>`;
            }

            sidebarHtml += `<div class="section">
                <div class="section-header">${sectionIcons.generalInfo}<h3 class="section-title">Общая информация</h3></div>
                <div class="section-content"><div class="info-grid">${generalInfoContent}</div></div>
            </div>`;
        }
        
        // --- Остальная генерация блоков без изменений ---
        const contractor = E(xmlDoc, 'Contractor');
        const client = E(xmlDoc, 'Client Person');
        if (contractor || client) {
            sectionsFound++;
            let participantsHtml = `<div class="section"><div class="section-header">${sectionIcons.participants}<h3 class="section-title">Участники работ</h3></div><div class="section-content">`;
            if (contractor) {
                const cadWork = E(contractor, 'AgreementCadWork');
                participantsHtml += `<div class="subsection" style="margin-top:0;"><div class="subsection-title">Кадастровый инженер</div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">ФИО</div><div class="info-value">${T(contractor, 'FamilyName')} ${T(contractor, 'FirstName')} ${T(contractor, 'Patronymic')}</div></div>
                        <div class="info-card"><div class="info-label">№ в реестре</div><div class="info-value">${T(contractor, 'CadastralEngineerRegistryNumber')} (от ${T(contractor, 'DateEntering')})</div></div>
                        <div class="info-card"><div class="info-label">СНИЛС</div><div class="info-value">${T(contractor, 'SNILS')}</div></div>
                        <div class="info-card"><div class="info-label">Контакты</div><div class="info-value">Тел: ${T(contractor, 'Telephone')}, Email: ${T(contractor, 'Email')}</div></div>
                        <div class="info-card"><div class="info-label">СРО</div><div class="info-value">${T(contractor, 'SelfRegulatoryOrganization')}</div></div>
                        <div class="info-card"><div class="info-label">Договор</div><div class="info-value">${T(cadWork, 'Name')} №${T(cadWork, 'NumberAgreement')} от ${T(cadWork, 'DateAgreement')}</div></div>
                    </div></div>`;
            }
            if (client) {
                 participantsHtml += `<div class="subsection"><div class="subsection-title">Заказчик</div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">ФИО</div><div class="info-value">${T(client, 'FamilyName')} ${T(client, 'FirstName')} ${T(client, 'Patronymic')}</div></div>
                        <div class="info-card"><div class="info-label">СНИЛС</div><div class="info-value">${T(client, 'SNILS')}</div></div>
                    </div></div>`;
            }
            participantsHtml += `</div></div>`;
            sidebarHtml += participantsHtml;
        }
        const inputData = E(xmlDoc, 'InputData');
        if (inputData) {
            sectionsFound++;
            let inputDataHtml = `<div class="section"><div class="section-header">${sectionIcons.inputData}<h3 class="section-title">Исходные данные</h3></div><div class="section-content">`;
            const documents = All(inputData, 'Documents > Document');
            if (documents.length > 0) {
                 inputDataHtml += `<div class="subsection" style="margin-top:0;"><div class="subsection-title">Документы-основания</div>
                 <table class="data-table"><thead><tr><th>Наименование</th><th>№</th><th>Дата</th></tr></thead><tbody>
                 ${Array.from(documents).map(doc => `<tr><td>${T(doc, 'Name')}</td><td>${T(doc, 'Number')}</td><td>${T(doc, 'Date')}</td></tr>`).join('')}
                 </tbody></table></div>`;
            }
            const geoBases = All(inputData, 'GeodesicBases > GeodesicBase');
            if (geoBases.length > 0) {
                 inputDataHtml += `<div class="subsection"><div class="subsection-title">Геодезическая основа</div>
                 <table class="data-table coord-table"><thead><tr><th>Пункт</th><th>Класс</th><th>X</th><th>Y</th></tr></thead><tbody>
                 ${Array.from(geoBases).map(base => `<tr><td style="text-align:left">${T(base, 'PName')} (${T(base, 'PKind')})</td><td>${T(base, 'PKlass')}</td><td>${T(base, 'OrdX')}</td><td>${T(base, 'OrdY')}</td></tr>`).join('')}
                 </tbody></table></div>`;
            }
            const meanSurvey = E(inputData, 'MeansSurvey > MeanSurvey');
            if (meanSurvey) {
                  inputDataHtml += `<div class="subsection"><div class="subsection-title">Средства измерений</div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">Прибор</div><div class="info-value">${T(meanSurvey, 'Name')}</div></div>
                        <div class="info-card"><div class="info-label">Номер</div><div class="info-value">${T(meanSurvey, 'Number')}</div></div>
                        <div class="info-card"><div class="info-label">Поверка</div><div class="info-value">${T(meanSurvey, 'CertificateVerification')}</div></div>
                    </div></div>`;
            }
            inputDataHtml += `</div></div>`;
            sidebarHtml += inputDataHtml;
        }

        // --- MAIN: Образуемый участок ---
        const newParcel = E(xmlDoc, 'NewParcel');
        if (newParcel) {
            sectionsFound++;
            const categoryCode = A(E(newParcel, 'Category'), 'Category');
            const categoryName = landCategories[categoryCode] || 'Категория не определена';
            let newParcelHtml = `<div class="section"><div class="section-header">${sectionIcons.newParcel}<h3 class="section-title">Сведения об образуемом участке (${A(newParcel, 'Definition')})</h3></div><div class="section-content">...</div></div>`;
            // Содержимое блока newParcel без изменений
            mainHtml += newParcelHtml.replace('...', `
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">Кадастровый квартал</div><div class="info-value">${T(newParcel, 'CadastralBlock')}</div></div>
                    <div class="info-card"><div class="info-label">Площадь, кв.м.</div><div class="info-value">${T(newParcel, 'Area > Area')} (±${T(newParcel, 'Area > Inaccuracy')})</div></div>
                    <div class="info-card"><div class="info-label">Категория земель</div><div class="info-value">${categoryName} <code>${categoryCode}</code></div></div>
                    <div class="info-card"><div class="info-label">Вид разрешенного использования</div><div class="info-value">${A(E(newParcel, 'PermittedUseEstablished'), 'ByDocument')}</div></div>
                    <div class="info-card"><div class="info-label">Обеспечение доступа</div><div class="info-value">${T(newParcel, 'ProvidingPassCadastralNumbers > Other')}</div></div>
                </div>
                ${T(newParcel, 'Area > Formula') !== '—' ? `<div class="subsection"><div class="subsection-title">Формула погрешности</div><div class="conclusion-text">${T(newParcel, 'Area > Formula')}</div></div>` : ''}
                ${All(newParcel, 'ObjectsRealty CadastralNumber').length > 0 ? `<div class="subsection"><div class="subsection-title">ОКС на участке</div><div class="info-grid">${Array.from(All(newParcel, 'ObjectsRealty CadastralNumber')).map(node => `<div class="info-card"><div class="info-value">${node.textContent}</div></div>`).join('')}</div></div>` : ''}
                ${E(newParcel, 'Address') ? `<div class="subsection"><div class="subsection-title">Адрес</div><div class="address-display">${[T(E(newParcel, 'Address'), 'RussianFederation'), T(E(newParcel, 'Address'), 'Region') !== '—' ? `Респ. ${T(E(newParcel, 'Address'), 'Region')}` : '', T(E(newParcel, 'Address'), 'District') !== '—' ? `${A(E(E(newParcel, 'Address'), 'District'), 'Type')} ${T(E(newParcel, 'Address'), 'District')}` : '', T(E(newParcel, 'Address'), 'City') !== '—' ? `${A(E(E(newParcel, 'Address'), 'City'), 'Type')} ${T(E(newParcel, 'Address'), 'City')}` : '', T(E(newParcel, 'Address'), 'Street') !== '—' ? `${A(E(E(newParcel, 'Address'), 'Street'), 'Type')} ${T(E(newParcel, 'Address'), 'Street')}` : '', T(E(newParcel, 'Address'), 'Other')].filter(p => p && p.trim() && p !== '—' && !p.includes('—')).join(', ')}</div><div class="info-grid" style="margin-top: 16px;"><div class="info-card"><div class="info-label">FIAS</div><div class="info-value">${T(E(newParcel, 'Address'), 'FIAS')}</div></div></div></div>` : ''}
            `);
        }
        
        const specifyRelatedParcel = E(xmlDoc, 'SpecifyRelatedParcel');
        if(specifyRelatedParcel){
            sectionsFound++;
            let relatedHtml = `<div class="section"><div class="section-header">${sectionIcons.relatedParcel}<h3 class="section-title">Уточнение смежного участка: ${A(specifyRelatedParcel, 'CadastralNumber')}</h3></div><div class="section-content">...</div></div>`;
            let tableContent = '';
            All(specifyRelatedParcel, 'ChangeBorder').forEach(ch => {
                const oldOrd = E(ch, 'OldOrdinate');
                const newOrd = E(ch, 'NewOrdinate');
                tableContent += `<tr>
                            <td>${A(oldOrd || newOrd, 'NumGeopoint') || A(newOrd, 'PointPref') + A(newOrd, 'NumGeopoint')}</td>
                            <td>${oldOrd ? `${A(oldOrd, 'X')}, ${A(oldOrd, 'Y')}` : '—'}</td>
                            <td>${newOrd ? `${A(newOrd, 'X')}, ${A(newOrd, 'Y')}` : '—'}</td>
                            <td style="text-align:left;">${newOrd ? `Δ=${A(newOrd, 'DeltaGeopoint')} м, ${A(newOrd, 'GeopointZacrep')}`: 'Точка удалена'}</td>
                        </tr>`;
            });
            mainHtml += relatedHtml.replace('...', `<table class="data-table coord-table"><thead><tr><th>Точка</th><th>Старые коорд. (X, Y)</th><th>Новые коорд. (X, Y)</th><th>Примечание</th></tr></thead><tbody>${tableContent}</tbody></table>`);
        }

        const entitySpatial = E(xmlDoc, 'EntitySpatial');
        if (entitySpatial) {
            sectionsFound++;
            let coordsHtml = `<div class="section">
                                <div class="section-header">
                                    ${sectionIcons.coordinates}
                                    <h3 class="section-title">Координаты (${A(entitySpatial, 'Name')})</h3>
                                    <a href="схема.html" class="copy-coords-btn" title="Скопировать координаты и открыть схему">${sectionIcons.copyXY}</a>
                                </div>
                                <div class="section-content">...</div>
                              </div>`;

            let tableContent = '';
            const uniquePoints = new Map();
            All(entitySpatial, 'SpelementUnit > Ordinate').forEach(ord => {
                const pointName = `${A(ord, 'PointPref') || ''}${A(ord, 'NumGeopoint')}`;
                if (pointName && pointName !== '—' && !uniquePoints.has(pointName)) {
                    uniquePoints.set(pointName, `<tr><td>${pointName}</td><td>${A(ord, 'X')}</td><td>${A(ord, 'Y')}</td>
                        <td style="text-align:left;">${A(ord, 'GeopointZacrep')}</td><td>${A(ord, 'DeltaGeopoint')}</td></tr>`);
                }
            });
            uniquePoints.forEach(rowHtml => tableContent += rowHtml);

            let sectionContent = `<table class="data-table coord-table"><thead><tr><th>Обозначение</th><th>X</th><th>Y</th><th>Метод закрепления</th><th>Погрешность, м</th></tr></thead><tbody>${tableContent}</tbody></table>`;
            
            const borders = All(entitySpatial, 'Borders > Border');
            if (borders.length > 0) {
                 sectionContent += `<div class="subsection"><div class="subsection-title">Длины линий</div>
                          <table class="data-table coord-table"><thead><tr><th>Участок</th><th>Длина, м</th></tr></thead><tbody>
                          ${Array.from(borders).map(b => `<tr><td>${A(b,'Point1')}-${A(b,'Point2')}</td><td>${T(b,'Length')}</td></tr>`).join('')}
                          </tbody></table></div>`;
            }
            mainHtml += coordsHtml.replace('...', sectionContent);
        }
        
        const conclusion = E(xmlDoc, 'Conclusion');
        if (conclusion && conclusion.textContent.trim()) {
            sectionsFound++;
            mainHtml += `<div class="section"><div class="section-header">${sectionIcons.conclusion}<h3 class="section-title">Заключение кадастрового инженера</h3></div>
                     <div class="section-content"><div class="conclusion-text">${conclusion.textContent.trim()}</div></div></div>`;
        }
        const graphicFiles = [
            { title: 'Схема геодезических построений (СГП)', file: A(E(xmlDoc, 'SchemeGeodesicPlotting'), 'Name') },
            { title: 'Схема расположения ЗУ (СРЗУ)', file: A(E(xmlDoc, 'SchemeDisposition'), 'Name') },
            { title: 'Чертеж земельного участка (ЧЗУ)', file: A(E(xmlDoc, 'DiagramParcelsSubParcels > AppliedFile'), 'Name') },
            { title: 'Акт согласования границ', file: A(E(xmlDoc, 'AgreementDocument > AppliedFile'), 'Name') }
        ].filter(f => f.file !== '—');
        if(graphicFiles.length > 0) {
            sectionsFound++;
            mainHtml += `<div class="section"><div class="section-header">${sectionIcons.graphics}<h3 class="section-title">Графические разделы</h3></div><div class="section-content">
                    <table class="data-table"><thead><tr><th>Наименование раздела</th><th>Имя файла</th></tr></thead><tbody>
                    ${graphicFiles.map(f => `<tr><td>${f.title}</td><td><span class="file-name">${f.file}</span></td></tr>`).join('')}
                    </tbody></table></div></div>`;
        }
        const appendixFiles = All(xmlDoc, 'Appendix > AppliedFiles');
        if(appendixFiles.length > 0) {
            sectionsFound++;
            mainHtml += `<div class="section"><div class="section-header">${sectionIcons.appendix}<h3 class="section-title">Приложения (образы документов)</h3></div><div class="section-content">
                    <table class="data-table"><thead><tr><th>№</th><th>Наименование</th><th>Имя файла</th></tr></thead><tbody>
                    ${Array.from(appendixFiles).map(f => `<tr><td>${T(f, 'NumberAppendix')}</td><td>${T(f, 'NameAppendix')}</td><td><span class="file-name">${A(E(f, 'AppliedFile'), 'Name')}</span></td></tr>`).join('')}
                    </tbody></table></div></div>`;
        }

        if (sectionsFound > 0) {
            mainColumn.innerHTML = mainHtml;
            sidebarColumn.innerHTML = sidebarHtml;
            resultsContainer.classList.remove('hidden');
            statusContainer.classList.add('hidden');
            printButtonContainer.classList.remove('hidden');
            messageArea.innerHTML = '';
        } else {
            showError('Файл успешно прочитан, но в нем не найдено известных разделов межевого плана. Возможно, это XML другого типа.');
        }
    }
});
</script>
</body>
</html>
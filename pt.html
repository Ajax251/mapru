<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная таблица Менделеева с Лабораторией</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --table-bg-color: #ffffff;
            --text-color: #333;
            --header-color: #2c3e50;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --primary-action-color: #2575fc;
            --primary-action-hover: #1765cc;
            /* Цвета для блоков элементов */
            --s-block-bg: #ff9999;
            --p-block-bg: #fdfd96;
            --d-block-bg: #90e0ef;
            --f-block-bg: #98fb98;
            --default-block-bg: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            overflow-x: hidden;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        h1 {
            color: var(--header-color);
            text-align: center;
        }

        #periodic-table-container {
            padding: 20px;
            background: var(--table-bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        #periodic-table {
            display: grid;
            grid-template-columns: repeat(18, 65px);
            grid-template-rows: repeat(10, 65px);
            gap: 5px;
            width: max-content;
        }

        .element {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.2s;
            text-align: center;
            padding: 4px;
            box-sizing: border-box;
            position: relative;
        }
        /* Применяем цвета блоков */
        .element[data-block="s"] { background-color: var(--s-block-bg); }
        .element[data-block="p"] { background-color: var(--p-block-bg); }
        .element[data-block="d"] { background-color: var(--d-block-bg); }
        .element[data-block="f"] { background-color: var(--f-block-bg); }

        .element:active { cursor: grabbing; }
        .element:hover { transform: scale(1.05); z-index: 10; border-color: #000; }
        .element.dragging { opacity: 0.5; transform: scale(0.9); }

        .element .symbol { font-size: 1.2rem; font-weight: bold; }
        .element .name { font-size: 0.6rem; line-height: 1.1; word-break: break-word; }
        .element .number { font-size: 0.7rem; position: absolute; top: 2px; left: 4px; opacity: 0.7; }
        
        /* Стили для лаборатории и модальных окон остались без изменений */
        #lab-toggle-button, #lab-panel, #drop-zone, .lab-element-chip, #start-experiment-btn,
        .modal-overlay, .modal-content, .loader-container {
            /* Все эти стили остались без изменений, поэтому для краткости опущены */
        }
        #lab-toggle-button{position:fixed;top:50%;right:0;transform:translateY(-50%) translateX(0);background-color:var(--primary-action-color);color:white;border:none;width:50px;height:100px;border-radius:10px 0 0 10px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:-2px 2px 10px rgba(0,0,0,.15);transition:transform .3s ease;writing-mode:vertical-rl;font-size:1.2rem;letter-spacing:2px}#lab-toggle-button.open{transform:translateY(-50%) translateX(-350px)}#lab-toggle-button:hover{background-color:var(--primary-action-hover)}#lab-panel{position:fixed;top:0;right:-350px;width:350px;height:100%;background-color:#fff;box-shadow:-5px 0 15px rgba(0,0,0,.1);transition:right .3s ease;z-index:1000;display:flex;flex-direction:column;padding:20px;box-sizing:border-box}#lab-panel.show{right:0}#lab-panel h3{margin-top:0;color:var(--header-color);text-align:center}#drop-zone{flex-grow:1;border:2px dashed #d9d9d9;border-radius:8px;padding:10px;margin-bottom:20px;transition:border-color .3s,background-color .3s;display:flex;flex-wrap:wrap;align-content:flex-start;gap:10px}#drop-zone.drag-over{border-color:var(--primary-action-color);background-color:#e6f7ff}.lab-element-chip{background-color:var(--background-color);border:1px solid #d9d9d9;border-radius:5px;padding:5px 10px;display:flex;align-items:center;gap:8px;font-weight:bold}.lab-element-chip .remove-btn{cursor:pointer;color:#ff4d4f;font-size:1.2rem;line-height:1}.lab-element-chip .remove-btn:hover{color:#cf1322}#start-experiment-btn{width:100%;padding:15px;font-size:1.1rem;background-color:var(--primary-action-color);color:white;border:none;border-radius:8px;cursor:pointer;transition:background-color .2s}#start-experiment-btn:hover{background-color:var(--primary-action-hover)}#start-experiment-btn:disabled{background-color:#b5b5b5;cursor:not-allowed}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}.modal-overlay.show{opacity:1;visibility:visible}.modal-content{background:white;padding:30px;border-radius:12px;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;transform:scale(.9);transition:transform .3s}.modal-overlay.show .modal-content{transform:scale(1)}.modal-content h2{margin-top:0;color:var(--header-color)}.modal-content .close-btn{position:absolute;top:15px;right:20px;font-size:2rem;color:#aaa;cursor:pointer;line-height:1}.modal-content .close-btn:hover{color:#333}.result-section h3{border-bottom:1px solid #eee;padding-bottom:5px;margin-top:20px}.loader-container{text-align:center;padding:40px 0}.beaker{width:100px;height:120px;border:5px solid #777;border-top:none;border-radius:0 0 15px 15px;margin:0 auto;position:relative;background:linear-gradient(to top,#6c9eff,#a3c4ff)}.beaker::before,.beaker::after{content:'';position:absolute;width:12px;height:12px;background:white;border-radius:50%;bottom:10px;animation:bubble 2s infinite ease-in-out}.beaker::before{left:30%;animation-delay:0s}.beaker::after{left:60%;animation-delay:1s}@keyframes bubble{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-90px) scale(1.5);opacity:0}}
    </style>
</head>
<body>

    <div class="main-container">
        <h1>Интерактивная таблица Менделеева</h1>
        <div id="periodic-table-container">
            <div id="periodic-table"></div>
        </div>
    </div>

    <!-- UI для лаборатории и модальные окна -->
    <button id="lab-toggle-button">ЛАБ</button>
    <div id="lab-panel">
        <h3>Лаборатория</h3>
        <p style="text-align: center; font-size: 0.9em; color: #666;">Перетащите сюда до 4 элементов для смешивания.</p>
        <div id="drop-zone"></div>
        <button id="start-experiment-btn" disabled>Химический опыт</button>
    </div>
    <div class="modal-overlay" id="result-modal">
        <div class="modal-content">
            <span class="close-btn" id="modal-close-btn">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const periodicTableContainer = document.getElementById('periodic-table');
            const labToggleButton = document.getElementById('lab-toggle-button');
            const labPanel = document.getElementById('lab-panel');
            const dropZone = document.getElementById('drop-zone');
            const startExperimentBtn = document.getElementById('start-experiment-btn');
            const resultModal = document.getElementById('result-modal');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            let draggedElement = null;

            // --- 1. Загрузка и создание таблицы из ЛОКАЛЬНОГО файла ---
            fetch('PeriodicTableRu.json')
                .then(response => {
                    if (!response.ok) throw new Error(`Не удалось загрузить PeriodicTableRu.json. Статус: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const elements = data.elements;
                     for(let i = 0; i < 18 * 10; i++) {
                        const cell = document.createElement('div');
                        cell.style.visibility = 'hidden';
                        periodicTableContainer.appendChild(cell);
                    }
                    elements.forEach(element => {
                        const elementDiv = document.createElement('div');
                        elementDiv.className = 'element';
                        elementDiv.draggable = true;
                        elementDiv.dataset.elementInfo = JSON.stringify(element);
                        elementDiv.dataset.block = element.block; // Добавляем данные для раскраски
                        
                        elementDiv.innerHTML = `
                            <div class="number">${element.number}</div>
                            <div class="symbol">${element.symbol}</div>
                            <div class="name">${element.name}</div>
                        `;

                        elementDiv.addEventListener('dblclick', () => {
                            showElementInNewWindow(element);
                        });

                        const placeholder = periodicTableContainer.children[(element.ypos - 1) * 18 + (element.xpos - 1)];
                        periodicTableContainer.replaceChild(elementDiv, placeholder);
                    });
                })
                .catch(error => {
                    console.error(error);
                    periodicTableContainer.innerHTML = `<p style="color: red; font-weight: bold;">${error.message}</p>`;
                });

            // --- НОВАЯ ФУНКЦИЯ: Показ информации в новом окне с использованием новой структуры JSON ---
            function showElementInNewWindow(element) {
                const N_A = 'N/A'; // Константа для отсутствующих данных

                // Формируем HTML для изображения, если оно есть
                let imageHTML = '';
                if (element.image && element.image.url) {
                    imageHTML = `
                        <div class="image-container">
                            <img src="${element.image.url}" alt="${element.name}">
                            <p class="attribution">
                                <em>${element.image.title || ''}</em><br>
                                ${element.image.attribution || ''}
                            </p>
                        </div>
                    `;
                }
                
                // Создаем HTML-разметку для новой страницы
                const newPageHTML = `
                    <!DOCTYPE html>
                    <html lang="ru">
                    <head>
                        <meta charset="UTF-8">
                        <title>Информация: ${element.name}</title>
                        <style>
                            body { font-family: -apple-system, sans-serif; padding: 20px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
                            .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
                            h1 { color: #2c3e50; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
                            .main-content { display: flex; flex-wrap: wrap; gap: 40px; }
                            .properties { flex: 1; min-width: 300px; }
                            .summary-section { flex: 1.5; min-width: 300px; }
                            p { margin: 8px 0; }
                            b { color: #555; }
                            a { color: #2575fc; text-decoration: none; }
                            a:hover { text-decoration: underline; }
                            .image-container { margin-bottom: 20px; }
                            .image-container img { max-width: 100%; border-radius: 6px; }
                            .image-container .attribution { font-size: 0.8em; color: #777; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>${element.name} (${element.symbol})</h1>
                            <div class="main-content">
                                <div class="properties">
                                    <h3>Основные свойства</h3>
                                    <p><b>Атомный номер:</b> ${element.number}</p>
                                    <p><b>Атомная масса:</b> ${element.atomic_mass ? element.atomic_mass.toFixed(4) : N_A}</p>
                                    <p><b>Категория:</b> ${element.category || N_A}</p>
                                    <p><b>Внешний вид:</b> ${element.appearance || N_A}</p>
                                    <p><b>Фаза при н.у.:</b> ${element.phase || N_A}</p>
                                    <p><b>Плотность:</b> ${element.density ? `${element.density} г/см³` : N_A}</p>
                                    <p><b>Темп. плавления:</b> ${element.melt ? `${(element.melt - 273.15).toFixed(2)} °C` : N_A}</p>
                                    <p><b>Темп. кипения:</b> ${element.boil ? `${(element.boil - 273.15).toFixed(2)} °C` : N_A}</p>
                                    <p><b>Электронная конфигурация:</b> ${element.electron_configuration_semantic || N_A}</p>
                                    <p><b>Первооткрыватель:</b> ${element.discovered_by || N_A}</p>
                                    <p><b>Кем назван:</b> ${element.named_by || N_A}</p>
                                </div>
                                <div class="summary-section">
                                    ${imageHTML}
                                    <h3>Описание</h3>
                                    <p>${element.summary || 'Описание отсутствует.'}</p>
                                    <hr>
                                    <p><a href="${element.source || '#'}" target="_blank" rel="noopener noreferrer">Подробнее в Википедии</a></p>
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                const newWindow = window.open("", "_blank");
                newWindow.document.write(newPageHTML);
                newWindow.document.close();
            }

            // --- Логика Drag-and-Drop и лаборатории (без изменений) ---
            labToggleButton.addEventListener('click',()=>labPanel.classList.toggle('show')||labToggleButton.classList.toggle('open'));document.addEventListener('dragstart',e=>{if(e.target.classList.contains('element')){draggedElement=e.target;e.target.classList.add('dragging')}});document.addEventListener('dragend',e=>{if(draggedElement){draggedElement.classList.remove('dragging');draggedElement=null}});dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over')});dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');if(!draggedElement)return;const t=JSON.parse(draggedElement.dataset.elementInfo),o=[...dropZone.children].some(e=>e.dataset.number===String(t.number));if(dropZone.children.length<4&&!o){const o=document.createElement('div');o.className='lab-element-chip',o.dataset.number=t.number,o.dataset.name=t.name,o.innerHTML=`<span>${t.symbol}</span> <span class="remove-btn">&times;</span>`,o.querySelector('.remove-btn').addEventListener('click',()=>{o.remove();updateExperimentButtonState()}),dropZone.appendChild(o),updateExperimentButtonState()}else o?alert("Этот элемент уже в лаборатории!"):alert("В лаборатории не может быть больше 4 элементов!")});function updateExperimentButtonState(){startExperimentBtn.disabled=dropZone.children.length<2}startExperimentBtn.addEventListener('click',async()=>{const e=[...dropZone.children].map(e=>e.dataset.name);showModal(),showLoader();try{const t=await getAIReaction(e);displayResult(t.summary,t.reaction)}catch(e){console.error("AI Error:",e),displayError("Произошла ошибка при связи с ИИ. Попробуйте позже.")}});async function getAIReaction(e){const t=`\n                    Ты — опытный химик-исследователь. Пользователь хочет провести виртуальный опыт, смешав следующие химические элементы: ${e.join(", ")}.\n                    Твоя задача — дать структурированный и понятный ответ на русском языке.\n\n                    Ответь строго по следующему формату, используя маркеры [SUMMARY] и [REACTION]:\n\n                    [SUMMARY]\n                    ### Исходные вещества:\n                    - **Название элемента 1:** Краткая характеристика (агрегатное состояние при н.у., тип, основное свойство).\n                    - **Название элемента 2:** Краткая характеристика.\n                    ... и так далее для всех элементов.\n\n                    [REACTION]\n                    ### Результат взаимодействия:\n                    Опиши, что произойдет при попытке смешать эти вещества. \n                    - Если реакция возможна, опиши условия (температура, давление, катализатор), уравнение реакции (если применимо), продукты реакции и наблюдаемые эффекты (выделение газа, изменение цвета, взрыв и т.д.).\n                    - Если реакция не пойдет при обычных условиях, объясни почему (например, низкая реакционная способность, как у благородных газов).\n                    - Если комбинация крайне опасна, обязательно сделай на этом акцент и предупреди об опасности.\n                    Используй Markdown для форматирования (жирный шрифт, списки).\n                `,o=await fetch("https://mapruapp.ru/ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gemini-2.5-flash-lite-preview-06-17",messages:[{role:"user",content:t}],temperature:.5,max_tokens:1e3})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=(await o.json()).choices[0].message.content;return{summary:a.split("[REACTION]")[0].replace("[SUMMARY]","").trim(),reaction:a.split("[REACTION]")[1]?a.split("[REACTION]")[1].trim():"ИИ не предоставил описание реакции."}}function showModal(){resultModal.classList.add('show')}function hideModal(){resultModal.classList.remove('show')}modalCloseBtn.addEventListener('click',hideModal),resultModal.addEventListener('click',e=>{e.target===resultModal&&hideModal()});function showLoader(){modalBody.innerHTML=`\n                    <h2>Идет химический опыт...</h2>\n                    <div class="loader-container">\n                        <div class="beaker"></div>\n                    </div>\n                    <p style="text-align:center; color: #666;">Пожалуйста, подождите, ИИ-лаборант анализирует реакцию...</p>\n                `}function displayResult(e,t){const o=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/### (.*?)\n/g,"<h3>$1</h3>").replace(/- (.*?)(\n|$)/g,"<li>$1</li>"),a=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/### (.*?)\n/g,"<h3>$1</h3>").replace(/- (.*?)(\n|$)/g,"<li>$1</li>");modalBody.innerHTML=`\n                    <h2>Результаты эксперимента</h2>\n                    <div class="result-section" style="list-style-position: inside;">\n                       <ul>${o}</ul>\n                    </div>\n                    <div class="result-section" style="list-style-position: inside;">\n                        <ul>${a}</ul>\n                    </div>\n                `}function displayError(e){modalBody.innerHTML=`\n                    <h2>Ошибка</h2>\n                    <p>${e}</p>\n                 `}
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü–∏–∞–Ω–∏–Ω–æ</title>
<link rel="icon" href="img/piano.png" type="image/png">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        overflow-x: hidden;
        padding: 20px;
    }
    h1 {
        font-size: 28px;
        margin-bottom: 15px;
        background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
    }
    .controls-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        width: 100%;
        max-width: 900px;
    }
    .main-controls {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }
    .control-btn, select {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 12px 20px;
        color: white;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        outline: none;
    }
    select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 15px top 50%;
        background-size: 12px auto;
        padding-right: 40px;
        min-width: 200px;
    }
    select option {
        background: #24243e;
        color: white;
    }
    .control-btn:hover, select:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    .auto-btn.active-auto {
        background: linear-gradient(135deg, #00b894, #55efc4);
        border-color: transparent;
        box-shadow: 0 0 15px rgba(0, 184, 148, 0.5);
        animation: autoPulse 1s infinite;
    }
    .config-btn {
        background: linear-gradient(135deg, #0984e3, #74b9ff);
        border-color: transparent;
    }
    .reset-btn {
        background: rgba(214, 48, 49, 0.4);
        border-color: #d63031;
    }
    @keyframes autoPulse {
        0%, 100% { box-shadow: 0 0 10px rgba(0, 184, 148, 0.5); }
        50% { box-shadow: 0 0 30px rgba(0, 184, 148, 0.8); }
    }
    .speed-control {
        display: flex;
        align-items: center;
        gap: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 20px;
        border-radius: 25px;
    }
    .speed-control label {
        font-size: 13px;
        color: #aaa;
    }
    .speed-control input[type="range"] {
        width: 120px;
        accent-color: #ff6b6b;
    }
    .speed-value {
        font-weight: bold;
        color: #feca57;
        min-width: 45px;
    }
    .tutorial-display {
        height: 100px;
        width: 100%;
        max-width: 700px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
    }
    .tutorial-text {
        font-size: 20px;
        font-weight: bold;
    }
    .progress-bar {
        width: 80%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        margin-top: 15px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #feca57);
        border-radius: 3px;
        transition: width 0.3s;
    }
    .split-container {
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: wrap;
    }
    .piano-block {
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        padding: 25px 25px 0 25px;
        border-radius: 15px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        border-top: 5px solid #e94560;
    }
    .hand-label {
        position: absolute;
        top: -35px;
        left: 0;
        width: 100%;
        text-align: center;
        font-size: 13px;
        color: #ccc;
        letter-spacing: 2px;
        text-transform: uppercase;
        font-weight: bold;
    }
    .keys-row {
        display: flex;
        position: relative;
        height: 280px;
    }
    .key {
        position: relative;
        cursor: pointer;
        border-radius: 0 0 10px 10px;
        transition: all 0.08s ease;
        user-select: none;
    }
    .white-key {
        width: 70px;
        height: 100%;
        background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 85%, #d0d0d0 100%);
        border: 1px solid #888;
        z-index: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        padding-bottom: 15px;
        color: #333;
        margin: 0 2px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), inset 0 -3px 5px rgba(0, 0, 0, 0.1);
    }
    .white-key:hover {
        background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
    }
    .white-key.active {
        background: linear-gradient(180deg, #e0e0e0 0%, #c0c0c0 100%);
        transform: translateY(4px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .white-key.guide-active {
        background: linear-gradient(180deg, #ffe0e0 0%, #ffb3b3 100%) !important;
        border-color: #ff6b6b !important;
    }
    .black-key {
        width: 44px;
        height: 60%;
        background: linear-gradient(180deg, #333 0%, #111 80%, #000 100%);
        position: absolute;
        top: 0;
        z-index: 2;
        border-radius: 0 0 6px 6px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        padding-bottom: 12px;
        color: #999;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), inset 0 -2px 3px rgba(255, 255, 255, 0.05);
    }
    .black-key:hover {
        background: linear-gradient(180deg, #444 0%, #222 100%);
    }
    .black-key.active {
        background: linear-gradient(180deg, #222 0%, #000 100%);
        height: 58%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .black-key.guide-active {
        background: linear-gradient(180deg, #ff6b6b 0%, #ee5a24 100%) !important;
        color: white !important;
    }
    .left-block .pos-1 { left: 50px; }
    .left-block .pos-2 { left: 124px; }
    .left-block .pos-3 { left: 272px; }
    .left-block .pos-4 { left: 346px; }
    .left-block .pos-5 { left: 420px; }
    .right-block .pos-1 { left: 50px; }
    .right-block .pos-2 { left: 124px; }
    .right-block .pos-3 { left: 272px; }
    .right-block .pos-4 { left: 346px; }
    .right-block .pos-5 { left: 420px; }
    @keyframes glowPulse {
        0%, 100% { box-shadow: 0 0 10px #ff6b6b, inset 0 0 15px rgba(255, 107, 107, 0.3); }
        50% { box-shadow: 0 0 30px #ff6b6b, inset 0 0 25px rgba(255, 107, 107, 0.5); }
    }
    @keyframes bounceArrow {
        0%, 100% { transform: translateX(-50%) translateY(0); }
        50% { transform: translateX(-50%) translateY(-10px); }
    }
    .key.guide-active {
        animation: glowPulse 1s infinite;
        z-index: 10 !important;
    }
    .key.guide-active::before {
        content: '‚ñº';
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
        color: #ff6b6b;
        animation: bounceArrow 0.6s infinite ease-in-out;
        text-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
        pointer-events: none;
    }
    .key.configuring {
        background: linear-gradient(180deg, #a4e2ff 0%, #74b9ff 100%) !important;
        border-color: #0984e3 !important;
        animation: glowPulseBlue 1s infinite;
        z-index: 10 !important;
        transform: scale(1.05);
    }
    @keyframes glowPulseBlue {
        0%, 100% { box-shadow: 0 0 10px #0984e3, inset 0 0 15px rgba(9, 132, 227, 0.3); }
        50% { box-shadow: 0 0 30px #0984e3, inset 0 0 25px rgba(9, 132, 227, 0.5); }
    }
    .key-char {
        font-weight: 800;
        font-size: 16px;
    }
    .note-name {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
    }
    .black-key .key-char {
        font-size: 12px;
    }
    .black-key .note-name {
        color: #777;
    }
    .visualizer {
        width: 100%;
        max-width: 950px;
        height: 60px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin-top: 30px;
        overflow: hidden;
    }
    .visualizer canvas {
        width: 100%;
        height: 100%;
    }
    .info-text {
        margin-top: 20px;
        font-size: 12px;
        color: #666;
        text-align: center;
    }
</style>
</head>
<body>

<h1>üéπ –ü–∏–∞–Ω–∏–Ω–æ</h1>

<div class="controls-container">
    <div class="main-controls">
        <select id="songSelector" onchange="startSong(this.value)">
            <option value="" disabled selected>üéµ –í—ã–±—Ä–∞—Ç—å –º–µ–ª–æ–¥–∏—é</option>
            <option value="twinkle">‚≠ê Twinkle Star</option>
            <option value="jingle">üîî Jingle Bells</option>
            <option value="ode">üéº Ode to Joy</option>
            <option value="birthday">üéÇ Happy Birthday</option>
            <option value="canon">üéª Canon</option>
            <option value="fur_elise">üåπ F√ºr Elise</option>
            <option value="mario">üçÑ Mario</option>
            <option value="tetris">üß± Tetris</option>
        </select>
        
        <button class="control-btn auto-btn" id="autoBtn" onclick="toggleAutoPlay()">‚ñ∂Ô∏è –ê–≤—Ç–æ—Ä–µ–∂–∏–º</button>
        <button class="control-btn stop-btn" onclick="stopSong()">‚èπ –°—Ç–æ–ø</button>
        <button class="control-btn config-btn" id="configBtn" onclick="startKeyConfig()">‚öôÔ∏è –ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∞–≤–∏—à–∏</button>
        <button class="control-btn reset-btn" onclick="resetKeys()">‚Ü∫ –°–±—Ä–æ—Å</button>
    </div>
    
    <div class="speed-control">
        <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
        <input type="range" id="speedSlider" min="0.3" max="2" step="0.1" value="1">
        <span class="speed-value" id="speedValue">1.0x</span>
    </div>
</div>

<div class="tutorial-display" id="tutorialDisplay">
    <div class="tutorial-text">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–ª–æ–¥–∏—é –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä–∞—Ç—å!</div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
</div>

<div class="split-container">
    <div class="piano-block left-block">
        <div class="hand-label">–õ–µ–≤–∞—è —Ä—É–∫–∞</div>
        <div class="keys-row">
            <div class="key white-key" data-note="C4" data-key="z"><div class="note-name">C4</div><div class="key-char">Z</div></div>
            <div class="key white-key" data-note="D4" data-key="x"><div class="note-name">D4</div><div class="key-char">X</div></div>
            <div class="key white-key" data-note="E4" data-key="c"><div class="note-name">E4</div><div class="key-char">C</div></div>
            <div class="key white-key" data-note="F4" data-key="v"><div class="note-name">F4</div><div class="key-char">V</div></div>
            <div class="key white-key" data-note="G4" data-key="b"><div class="note-name">G4</div><div class="key-char">B</div></div>
            <div class="key white-key" data-note="A4" data-key="n"><div class="note-name">A4</div><div class="key-char">N</div></div>
            <div class="key white-key" data-note="B4" data-key="m"><div class="note-name">B4</div><div class="key-char">M</div></div>
            
            <div class="key black-key pos-1" data-note="C#4" data-key="s"><div class="note-name">C#</div><div class="key-char">S</div></div>
            <div class="key black-key pos-2" data-note="D#4" data-key="d"><div class="note-name">D#</div><div class="key-char">D</div></div>
            <div class="key black-key pos-3" data-note="F#4" data-key="g"><div class="note-name">F#</div><div class="key-char">G</div></div>
            <div class="key black-key pos-4" data-note="G#4" data-key="h"><div class="note-name">G#</div><div class="key-char">H</div></div>
            <div class="key black-key pos-5" data-note="A#4" data-key="j"><div class="note-name">A#</div><div class="key-char">J</div></div>
        </div>
    </div>

    <div class="piano-block right-block">
        <div class="hand-label">–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞</div>
        <div class="keys-row">
            <div class="key white-key" data-note="C5" data-key="y"><div class="note-name">C5</div><div class="key-char">Y</div></div>
            <div class="key white-key" data-note="D5" data-key="u"><div class="note-name">D5</div><div class="key-char">U</div></div>
            <div class="key white-key" data-note="E5" data-key="i"><div class="note-name">E5</div><div class="key-char">I</div></div>
            <div class="key white-key" data-note="F5" data-key="o"><div class="note-name">F5</div><div class="key-char">O</div></div>
            <div class="key white-key" data-note="G5" data-key="p"><div class="note-name">G5</div><div class="key-char">P</div></div>
            <div class="key white-key" data-note="A5" data-key="["><div class="note-name">A5</div><div class="key-char">[</div></div>
            <div class="key white-key" data-note="B5" data-key="]"><div class="note-name">B5</div><div class="key-char">]</div></div>
            
            <div class="key black-key pos-1" data-note="C#5" data-key="7"><div class="note-name">C#</div><div class="key-char">7</div></div>
            <div class="key black-key pos-2" data-note="D#5" data-key="8"><div class="note-name">D#</div><div class="key-char">8</div></div>
            <div class="key black-key pos-3" data-note="F#5" data-key="0"><div class="note-name">F#</div><div class="key-char">0</div></div>
            <div class="key black-key pos-4" data-note="G#5" data-key="-"><div class="note-name">G#</div><div class="key-char">-</div></div>
            <div class="key black-key pos-5" data-note="A#5" data-key="="><div class="note-name">A#</div><div class="key-char">=</div></div>
        </div>
    </div>
</div>

<div class="visualizer">
    <canvas id="visualizerCanvas"></canvas>
</div>

<div class="info-text">
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–ª–∏ –º—ã—à—å –¥–ª—è –∏–≥—Ä—ã ‚Ä¢ –í –∞–≤—Ç–æ—Ä–µ–∂–∏–º–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –∏–≥—Ä–∞–µ—Ç —Å–∞–º
</div>


<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    const compressor = audioContext.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-24, audioContext.currentTime);
    compressor.knee.setValueAtTime(30, audioContext.currentTime);
    compressor.ratio.setValueAtTime(12, audioContext.currentTime);
    compressor.attack.setValueAtTime(0.003, audioContext.currentTime);
    compressor.release.setValueAtTime(0.25, audioContext.currentTime);

    let masterGain = audioContext.createGain();
    masterGain.gain.value = 0.6;
    masterGain.connect(compressor);
    compressor.connect(audioContext.destination);

    let convolver = null;
    createReverb();

    async function createReverb() {
        convolver = audioContext.createConvolver();
        const length = audioContext.sampleRate * 1.5;
        const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
        for (let channel = 0; channel < 2; channel++) {
            const channelData = impulse.getChannelData(channel);
            for (let i = 0; i < length; i++) {
                channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.5);
            }
        }
        convolver.buffer = impulse;
        const reverbGain = audioContext.createGain();
        reverbGain.gain.value = 0.15;
        convolver.connect(reverbGain);
        reverbGain.connect(compressor);
    }

    const noteFrequencies = {
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
        'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
        'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25,
        'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99,
        'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77
    };

    const songs = {
        'twinkle': { name: 'Twinkle Twinkle Little Star', tempo: 400, notes: [{n:'C4',d:1},{n:'C4',d:1},{n:'G4',d:1},{n:'G4',d:1},{n:'A4',d:1},{n:'A4',d:1},{n:'G4',d:2},{n:'F4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'E4',d:1},{n:'D4',d:1},{n:'D4',d:1},{n:'C4',d:2},{n:'G4',d:1},{n:'G4',d:1},{n:'F4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'E4',d:1},{n:'D4',d:2},{n:'G4',d:1},{n:'G4',d:1},{n:'F4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'E4',d:1},{n:'D4',d:2}] },
        'jingle': { name: 'Jingle Bells', tempo: 300, notes: [{n:'E4',d:1},{n:'E4',d:1},{n:'E4',d:2},{n:'E4',d:1},{n:'E4',d:1},{n:'E4',d:2},{n:'E4',d:1},{n:'G4',d:1},{n:'C4',d:1},{n:'D4',d:1},{n:'E4',d:3},{n:'F4',d:1},{n:'F4',d:1},{n:'F4',d:1},{n:'F4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'E4',d:1},{n:'E4',d:0.5},{n:'E4',d:0.5},{n:'E4',d:1},{n:'D4',d:1},{n:'D4',d:1},{n:'E4',d:1},{n:'D4',d:2},{n:'G4',d:2}] },
        'ode': { name: 'Ode to Joy', tempo: 400, notes: [{n:'E4',d:1},{n:'E4',d:1},{n:'F4',d:1},{n:'G4',d:1},{n:'G4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'D4',d:1},{n:'C4',d:1},{n:'C4',d:1},{n:'D4',d:1},{n:'E4',d:1},{n:'E4',d:1.5},{n:'D4',d:0.5},{n:'D4',d:2},{n:'E4',d:1},{n:'E4',d:1},{n:'F4',d:1},{n:'G4',d:1},{n:'G4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'D4',d:1},{n:'C4',d:1},{n:'C4',d:1},{n:'D4',d:1},{n:'E4',d:1},{n:'D4',d:1.5},{n:'C4',d:0.5},{n:'C4',d:2}] },
        'birthday': { name: 'Happy Birthday', tempo: 350, notes: [{n:'C4',d:0.75},{n:'C4',d:0.25},{n:'D4',d:1},{n:'C4',d:1},{n:'F4',d:1},{n:'E4',d:2},{n:'C4',d:0.75},{n:'C4',d:0.25},{n:'D4',d:1},{n:'C4',d:1},{n:'G4',d:1},{n:'F4',d:2},{n:'C4',d:0.75},{n:'C4',d:0.25},{n:'C5',d:1},{n:'A4',d:1},{n:'F4',d:1},{n:'E4',d:1},{n:'D4',d:1},{n:'A4',d:0.75},{n:'A4',d:0.25},{n:'A4',d:1},{n:'F4',d:1},{n:'G4',d:1},{n:'F4',d:2}] },
        'canon': { name: 'Canon in D', tempo: 500, notes: [{n:'F#4',d:1},{n:'E4',d:1},{n:'D4',d:1},{n:'C#4',d:1},{n:'B4',d:1},{n:'A4',d:1},{n:'B4',d:1},{n:'C#4',d:1},{n:'D4',d:1},{n:'C#4',d:1},{n:'B4',d:1},{n:'A4',d:1},{n:'G4',d:1},{n:'F#4',d:1},{n:'G4',d:1},{n:'E4',d:1},{n:'D4',d:0.5},{n:'F#4',d:0.5},{n:'A4',d:0.5},{n:'G4',d:0.5},{n:'F#4',d:0.5},{n:'D4',d:0.5},{n:'F#4',d:0.5},{n:'E4',d:0.5}] },
        'fur_elise': { name: 'F√ºr Elise', tempo: 280, notes: [{n:'E5',d:0.5},{n:'D#5',d:0.5},{n:'E5',d:0.5},{n:'D#5',d:0.5},{n:'E5',d:0.5},{n:'B4',d:0.5},{n:'D5',d:0.5},{n:'C5',d:0.5},{n:'A4',d:1.5},{n:'C4',d:0.5},{n:'E4',d:0.5},{n:'A4',d:0.5},{n:'B4',d:1.5},{n:'E4',d:0.5},{n:'G#4',d:0.5},{n:'B4',d:0.5},{n:'C5',d:1.5},{n:'E4',d:0.5},{n:'E5',d:0.5},{n:'D#5',d:0.5},{n:'E5',d:0.5},{n:'D#5',d:0.5},{n:'E5',d:0.5},{n:'B4',d:0.5},{n:'D5',d:0.5},{n:'C5',d:0.5},{n:'A4',d:1.5}] },
        'mario': { name: 'Super Mario Bros', tempo: 200, notes: [{n:'E5',d:0.5},{n:'E5',d:0.5},{n:'E5',d:1},{n:'C5',d:0.5},{n:'E5',d:1},{n:'G5',d:1.5},{n:'G4',d:1.5},{n:'C5',d:1},{n:'G4',d:1},{n:'E4',d:1.5},{n:'A4',d:1},{n:'B4',d:1},{n:'A#4',d:0.5},{n:'A4',d:1},{n:'G4',d:0.66},{n:'E5',d:0.66},{n:'G5',d:0.66},{n:'A5',d:1},{n:'F5',d:0.5},{n:'G5',d:1},{n:'E5',d:1},{n:'C5',d:0.5},{n:'D5',d:0.5},{n:'B4',d:1}] },
        'tetris': { name: 'Tetris Theme', tempo: 280, notes: [{n:'E5',d:1},{n:'B4',d:0.5},{n:'C5',d:0.5},{n:'D5',d:1},{n:'C5',d:0.5},{n:'B4',d:0.5},{n:'A4',d:1},{n:'A4',d:0.5},{n:'C5',d:0.5},{n:'E5',d:1},{n:'D5',d:0.5},{n:'C5',d:0.5},{n:'B4',d:1.5},{n:'C5',d:0.5},{n:'D5',d:1},{n:'E5',d:1},{n:'C5',d:1},{n:'A4',d:1},{n:'A4',d:2},{n:'D5',d:1},{n:'F5',d:0.5},{n:'A5',d:1},{n:'G5',d:0.5},{n:'F5',d:0.5},{n:'E5',d:1.5},{n:'C5',d:0.5},{n:'E5',d:1},{n:'D5',d:0.5},{n:'C5',d:0.5},{n:'B4',d:1},{n:'B4',d:0.5},{n:'C5',d:0.5},{n:'D5',d:1},{n:'E5',d:1},{n:'C5',d:1},{n:'A4',d:1},{n:'A4',d:2}] }
    };

    const noteSequence = ['C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4','C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5','A#5','B5'];
    const defaultKeys = {
        'C4':'z','C#4':'s','D4':'x','D#4':'d','E4':'c','F4':'v','F#4':'g','G4':'b','G#4':'h','A4':'n','A#4':'j','B4':'m',
        'C5':'y','C#5':'7','D5':'u','D#5':'8','E5':'i','F5':'o','F#5':'0','G5':'p','G#5':'-','A5':'[','A#5':'=','B5':']'
    };

    let noteToKey = {};
    let keyToNote = {};
    
    function loadKeys() {
        const stored = localStorage.getItem('pianoKeyMap');
        noteToKey = stored ? JSON.parse(stored) : {...defaultKeys};
        refreshKeyMap();
    }

    function refreshKeyMap() {
        keyToNote = {};
        for (let [note, key] of Object.entries(noteToKey)) {
            keyToNote[key] = note;
            const el = document.querySelector(`.key[data-note="${note}"]`);
            if (el) {
                el.dataset.key = key;
                el.querySelector('.key-char').textContent = key.toUpperCase();
            }
        }
    }

    function resetKeys() {
        if(isConfiguring) return;
        localStorage.removeItem('pianoKeyMap');
        loadKeys();
    }

    let isConfiguring = false;
    let configIndex = 0;
    let tempKeyMap = {};
    const configBtn = document.getElementById('configBtn');

    function startKeyConfig() {
        if (isConfiguring) {
            cancelConfig();
            return;
        }
        stopSong();
        isConfiguring = true;
        configIndex = 0;
        tempKeyMap = { ...noteToKey };
        configBtn.textContent = '‚ùå –û—Ç–º–µ–Ω–∞';
        configBtn.style.background = '#d63031';
        configBtn.style.borderColor = '#d63031';
        highlightNextKeyForConfig();
    }

    function cancelConfig() {
        isConfiguring = false;
        document.querySelectorAll('.key.configuring').forEach(el => el.classList.remove('configuring'));
        configBtn.textContent = '‚öôÔ∏è –ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∞–≤–∏—à–∏';
        configBtn.style.background = '';
        configBtn.style.borderColor = '';
        refreshKeyMap();
    }

    function highlightNextKeyForConfig() {
        if (configIndex > 0) {
            const prevNote = noteSequence[configIndex - 1];
            const prevKeyEl = document.querySelector(`.key[data-note="${prevNote}"]`);
            if (prevKeyEl) prevKeyEl.classList.remove('configuring');
        }

        if (configIndex >= noteSequence.length) {
            finishConfig();
            return;
        }

        const currentNote = noteSequence[configIndex];
        const currentKeyEl = document.querySelector(`.key[data-note="${currentNote}"]`);
        if (currentKeyEl) {
            currentKeyEl.classList.add('configuring');
        }
    }

    function finishConfig() {
        noteToKey = { ...tempKeyMap };
        localStorage.setItem('pianoKeyMap', JSON.stringify(noteToKey));
        refreshKeyMap();
        cancelConfig();
    }

    let currentSong = null;
    let currentNoteIndex = 0;
    let originalSongLength = 0;
    let isTutorialMode = false;
    let isAutoPlay = false;
    let autoPlayTimeout = null;
    let playbackSpeed = 1;

    const speedSlider = document.getElementById('speedSlider');
    const speedValue = document.getElementById('speedValue');
    speedSlider.addEventListener('input', () => {
        playbackSpeed = parseFloat(speedSlider.value);
        speedValue.textContent = playbackSpeed.toFixed(1) + 'x';
    });

    function startSong(songId) {
        if (isConfiguring) cancelConfig();
        stopSong();
        if (!songId) return;
        currentSong = JSON.parse(JSON.stringify(songs[songId]));
        currentNoteIndex = 0;
        originalSongLength = currentSong.notes.length;
        isTutorialMode = true;
        
        updateDisplay(`üéµ ${currentSong.name}`, currentSong.notes[0]);
        highlightNextKey();
        updateProgress();
    }

    function stopSong() {
        if (isConfiguring) cancelConfig();
        isTutorialMode = false;
        isAutoPlay = false;
        currentSong = null;
        currentNoteIndex = 0;
        if (autoPlayTimeout) {
            clearTimeout(autoPlayTimeout);
            autoPlayTimeout = null;
        }
        clearKeyHighlights();
        document.getElementById('songSelector').value = "";
        document.getElementById('tutorialDisplay').innerHTML = `
            <div class="tutorial-text">–†–µ–∂–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–π –∏–≥—Ä—ã</div>
            <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
        `;
        
        Object.keys(activeNotes).forEach(note => stopPianoNote(note));
        
        const autoBtn = document.getElementById('autoBtn');
        if (autoBtn) {
            autoBtn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ—Ä–µ–∂–∏–º';
            autoBtn.classList.remove('active-auto');
        }
    }

    function toggleAutoPlay() {
        if (isConfiguring) return;
        const autoBtn = document.getElementById('autoBtn');
        if (!currentSong) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ–ª–æ–¥–∏—é!');
            return;
        }
        
        isAutoPlay = !isAutoPlay;
        
        if (isAutoPlay) {
            if (audioContext.state === 'suspended') audioContext.resume();
            autoBtn.classList.add('active-auto');
            autoBtn.textContent = 'üéπ –ò–≥—Ä–∞–µ—Ç...';
            playNextNoteAuto();
        } else {
            autoBtn.classList.remove('active-auto');
            autoBtn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ—Ä–µ–∂–∏–º';
            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
        }
    }

    function playNextNoteAuto() {
        if (!isAutoPlay || !currentSong || currentNoteIndex >= currentSong.notes.length) {
            if (isAutoPlay && currentSong) {
                currentNoteIndex = 0;
                updateProgress();
                setTimeout(() => playNextNoteAuto(), 1000);
            }
            return;
        }

        const noteData = currentSong.notes[currentNoteIndex];
        const keyChar = noteToKey[noteData.n];
        const duration = (currentSong.tempo * noteData.d) / playbackSpeed;
        
        if (keyChar) {
            simulateKeyPress(keyChar, noteData.n, Math.min(duration * 0.9, 500)); 
        }
        
        currentNoteIndex++;
        updateProgress();
        
        if (currentNoteIndex < currentSong.notes.length) {
            highlightNextKey();
            const nextNote = currentSong.notes[currentNoteIndex];
            updateDisplay(`üéµ ${currentSong.name}`, nextNote);
        }

        autoPlayTimeout = setTimeout(() => playNextNoteAuto(), duration);
    }

    function simulateKeyPress(keyChar, note, durationMs) {
        const keyEl = document.querySelector(`.key[data-key="${keyChar}"]`);
        if (keyEl) {
            keyEl.classList.add('active');
            playPianoNote(note);
            setTimeout(() => {
                keyEl.classList.remove('active');
                stopPianoNote(note);
            }, durationMs || 200);
        }
    }

    function updateDisplay(title, noteData) {
        if (!noteData) return;
        const keyChar = noteToKey[noteData.n] || '?';
        document.getElementById('tutorialDisplay').innerHTML = `
            <div class="tutorial-text">${title}</div>
            <div style="margin-top: 8px;">
                –ù–∞–∂–º–∏—Ç–µ: <span style="color: #ff6b6b; font-weight: bold; font-size: 28px; margin: 0 10px;">[ ${keyChar.toUpperCase()} ]</span>
                <span style="color: #888; font-size: 14px;">(${noteData.n})</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: ${(currentNoteIndex / originalSongLength) * 100}%"></div></div>
        `;
    }

    function updateProgress() {
        const fill = document.getElementById('progressFill');
        if (fill && originalSongLength > 0) {
            fill.style.width = `${(currentNoteIndex / originalSongLength) * 100}%`;
        }
    }

    function highlightNextKey() {
        clearKeyHighlights();
        if (currentSong && currentNoteIndex < currentSong.notes.length) {
            const noteData = currentSong.notes[currentNoteIndex];
            const keyChar = noteToKey[noteData.n];
            const keyEl = document.querySelector(`.key[data-key="${keyChar}"]`);
            if (keyEl) {
                keyEl.classList.add('guide-active');
            }
        } else if (isTutorialMode && !isAutoPlay) {
            document.getElementById('tutorialDisplay').innerHTML = `
                <div class="tutorial-text">üéâ –û—Ç–ª–∏—á–Ω–æ! –ú–µ–ª–æ–¥–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
                <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
            `;
            setTimeout(() => stopSong(), 2500);
        }
    }

    function clearKeyHighlights() {
        document.querySelectorAll('.guide-active').forEach(k => k.classList.remove('guide-active'));
    }

    const activeNotes = {};

    function playPianoNote(note) {
        if (!noteFrequencies[note]) return;
        if (activeNotes[note]) releaseNoteInstance(activeNotes[note]);
        
        const now = audioContext.currentTime;
        const freq = noteFrequencies[note];
        
        const mainOsc = audioContext.createOscillator();
        const mainGain = audioContext.createGain();
        mainOsc.type = 'triangle';
        mainOsc.frequency.setValueAtTime(freq, now);
        
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(freq * 2, now);
        gain2.gain.setValueAtTime(0.15, now);
        
        const osc3 = audioContext.createOscillator();
        const gain3 = audioContext.createGain();
        osc3.type = 'sine';
        osc3.frequency.setValueAtTime(freq * 3, now);
        gain3.gain.setValueAtTime(0.08, now);
        
        const osc4 = audioContext.createOscillator();
        const gain4 = audioContext.createGain();
        osc4.type = 'sine';
        osc4.frequency.setValueAtTime(freq * 4, now);
        gain4.gain.setValueAtTime(0.04, now);
        
        const envelope = audioContext.createGain();
        const attackTime = 0.01;
        const decayTime = 0.1;
        const sustainLevel = 0.4;
        const maxVol = 0.4; 
        
        envelope.gain.setValueAtTime(0, now);
        envelope.gain.linearRampToValueAtTime(maxVol, now + attackTime);
        envelope.gain.exponentialRampToValueAtTime(sustainLevel * maxVol, now + attackTime + decayTime);
        
        const filter = audioContext.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(4000, now);
        filter.frequency.exponentialRampToValueAtTime(1000, now + 0.5);
        filter.Q.value = 1;
        
        mainOsc.connect(mainGain);
        mainGain.connect(envelope);
        osc2.connect(gain2);
        gain2.connect(envelope);
        osc3.connect(gain3);
        gain3.connect(envelope);
        osc4.connect(gain4);
        gain4.connect(envelope);
        envelope.connect(filter);
        filter.connect(masterGain);
        
        if (convolver) filter.connect(convolver);
        
        mainOsc.start(now);
        osc2.start(now);
        osc3.start(now);
        osc4.start(now);
        
        activeNotes[note] = { oscillators: [mainOsc, osc2, osc3, osc4], gains: [mainGain, gain2, gain3, gain4], envelope: envelope, filter: filter };
        drawVisualization(freq);
    }

    function releaseNoteInstance(audioData) {
        if (!audioData) return;
        const { oscillators, envelope, filter } = audioData;
        const now = audioContext.currentTime;
        const releaseTime = 0.2;
        
        try {
            envelope.gain.cancelScheduledValues(now);
            envelope.gain.setValueAtTime(envelope.gain.value, now);
            envelope.gain.exponentialRampToValueAtTime(0.001, now + releaseTime);
        } catch(e) {}
        
        oscillators.forEach(osc => {
            try { osc.stop(now + releaseTime + 0.05); } catch(e) {}
        });
        
        setTimeout(() => {
            oscillators.forEach(osc => { try { osc.disconnect(); } catch(e) {} });
            try { envelope.disconnect(); } catch(e) {}
            try { filter.disconnect(); } catch(e) {}
        }, (releaseTime + 0.2) * 1000);
    }

    function stopPianoNote(note) {
        if (activeNotes[note]) {
            releaseNoteInstance(activeNotes[note]);
            delete activeNotes[note];
        }
    }

    const canvas = document.getElementById('visualizerCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 950;
    canvas.height = 60;

    let visualBars = [];

    function drawVisualization(freq) {
        const hue = (freq / 10) % 360;
        visualBars.push({ x: Math.random() * canvas.width, height: 20 + Math.random() * 30, hue: hue, alpha: 1, width: 3 + Math.random() * 5 });
    }

    function animateVisualizer() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        visualBars = visualBars.filter(bar => bar.alpha > 0.01);
        visualBars.forEach(bar => {
            ctx.fillStyle = `hsla(${bar.hue}, 80%, 60%, ${bar.alpha})`;
            ctx.fillRect(bar.x, (canvas.height - bar.height) / 2, bar.width, bar.height);
            bar.alpha -= 0.02;
            bar.height *= 0.98;
        });
        requestAnimationFrame(animateVisualizer);
    }
    animateVisualizer();

    const keys = document.querySelectorAll('.key');

    function handleInput(keyChar) {
        const note = keyToNote[keyChar];
        if (note) {
            const keyEl = document.querySelector(`.key[data-key="${keyChar}"]`);
            if (keyEl) {
                keyEl.classList.add('active');
                playPianoNote(note);

                if (isTutorialMode && !isAutoPlay && currentSong && currentNoteIndex < currentSong.notes.length) {
                    const expectedKey = noteToKey[currentSong.notes[currentNoteIndex].n];
                    if (keyChar === expectedKey) {
                        currentNoteIndex++;
                        updateProgress();
                        highlightNextKey();
                        if (currentNoteIndex < currentSong.notes.length) {
                            updateDisplay(`üéµ ${currentSong.name}`, currentSong.notes[currentNoteIndex]);
                        }
                    }
                }
            }
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        if (audioContext.state === 'suspended') audioContext.resume();
        const keyChar = e.key.toLowerCase();

        if (isConfiguring) {
            e.preventDefault();
            const currentNote = noteSequence[configIndex];
            tempKeyMap[currentNote] = keyChar;
            
            const keyEl = document.querySelector(`.key[data-note="${currentNote}"]`);
            if (keyEl) {
                const keyCharEl = keyEl.querySelector('.key-char');
                if (keyCharEl) {
                    keyCharEl.textContent = keyChar.toUpperCase();
                }
            }

            configIndex++;
            highlightNextKeyForConfig();
            return;
        }

        handleInput(keyChar);
    });

    document.addEventListener('keyup', (e) => {
        if (isConfiguring) return;
        const k = e.key.toLowerCase();
        const note = keyToNote[k];
        if (note) {
            const keyEl = document.querySelector(`.key[data-note="${note}"]`);
            if (keyEl) {
                keyEl.classList.remove('active');
                stopPianoNote(note);
            }
        }
    });

    keys.forEach(key => {
        key.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (audioContext.state === 'suspended') audioContext.resume();
            if (!isConfiguring) {
                key.classList.add('active');
                playPianoNote(key.dataset.note);
            }
        });
        
        key.addEventListener('mouseup', () => {
            if (!isConfiguring) {
                key.classList.remove('active');
                stopPianoNote(key.dataset.note);
            }
        });
        
        key.addEventListener('mouseleave', () => {
            if (!isConfiguring && key.classList.contains('active')) {
                key.classList.remove('active');
                stopPianoNote(key.dataset.note);
            }
        });

        key.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (audioContext.state === 'suspended') audioContext.resume();
            if (!isConfiguring) {
                key.classList.add('active');
                playPianoNote(key.dataset.note);
            }
        });

        key.addEventListener('touchend', () => {
            if (!isConfiguring) {
                key.classList.remove('active');
                stopPianoNote(key.dataset.note);
            }
        });
    });

    loadKeys();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Карта | Упрощенная версия</title>

    <link rel="icon" href="https://img.icons8.com/office/16/000000/map-marker.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

    <style>
        html,
        body {
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
        }

        #map {
            flex-grow: 1; /* Карта занимает все доступное пространство */
            width: 100%;
            border-top: 2px solid #007bff;
        }

        .input-container {
            flex-shrink: 0;
            padding: 12px;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #main-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #main-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* --- Стили для контекстного меню --- */
        .custom-context-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 5px 0;
            min-width: 280px;
            z-index: 10000;
            display: none;
            font-size: 14px;
        }

        .custom-context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #333;
            display: flex;
            align-items: center;
            position: relative;
        }

        .custom-context-menu-item i {
            margin-right: 12px;
            color: #007bff;
            width: 20px;
            text-align: center;
        }

        .custom-context-menu-item:hover {
            background-color: #f0f2f5;
        }

        .custom-context-submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: -5px; /* Небольшое смещение для наложения */
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 5px 0;
            min-width: 280px;
        }

        .custom-context-menu-item:hover>.custom-context-submenu {
            display: block;
        }

        /* --- Стили для загрузчика и уведомлений --- */
        .loader-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 10001;
        }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; z-index: 9999; display: flex; align-items: center; gap: 10px; }
        .notification.success { background: linear-gradient(135deg, #28a745, #218838); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #c82333); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification i { font-size: 16px; }

        /* --- Стили для модального окна выбора ЗОУИТ --- */
        .zouit-selection-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 10002; width: 90%; max-width: 450px; }
        .zouit-selection-modal h3 { margin-top: 0; text-align: center; color: #333; }
        .zouit-selection-modal .options { max-height: 50vh; overflow-y: auto; margin: 15px 0; }
        .zouit-selection-modal button { display: block; width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ddd; background-color: #f8f9fa; border-radius: 5px; cursor: pointer; text-align: left; }
        .zouit-selection-modal button:hover { background-color: #e9ecef; }
        .zouit-selection-modal .controls { text-align: center; margin-top: 15px; }

    </style>
</head>

<body>

    <div id="map"></div>

    <div class="input-container">
        <input type="text" id="main-input" placeholder="Введите кадастровый номер, координаты или адрес...">
    </div>

    <div class="loader-container" id="loaderContainer">
        <div class="loader"></div>
    </div>

    <div class="custom-context-menu" style="display: none;"></div>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU" type="text/javascript"></script>

    <script>
        // --- Глобальные переменные ---
        let map;
        let polygons = [];
        const sevenDigitsRegions = ['24', '63', '66', '77', '78', '91'];
        const mapOffsetX = -4.5;
        const mapOffsetY = -1;

        // --- Инициализация Proj4 ---
        proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs");
        proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
        proj4.defs("MSK16_ZONE2", "+proj=tmerc +lat_0=0 +lon_0=52.033333333333 +k=1 +x_0=2300000 +y_0=-5709414.70 +ellps=krass +towgs84=23.57,-140.95,-79.8,0,-0.35,-0.79,-0.22 +units=m +no_defs +axis=enu");
        proj4.defs("MSK16_ZONE1", "+proj=tmerc +lat_0=0 +lon_0=49.033333333333 +k=1 +x_0=1300000 +y_0=-5709414.70 +ellps=krass +towgs84=23.57,-140.95,-79.8,0,-0.35,-0.79,-0.22 +units=m +no_defs +axis=enu");

        // --- Основная логика ---
        document.addEventListener('DOMContentLoaded', () => {
            ymaps.ready(initMap);

            const mainInput = document.getElementById('main-input');
            mainInput.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter') {
                    const inputText = mainInput.value.trim();
                    if (!inputText) return;
                    await processInput(inputText);
                }
            });

            mainInput.addEventListener('input', () => formatCadastralNumber(mainInput));

            mainInput.addEventListener('paste', async (event) => {
                 event.preventDefault();
                 const text = (event.clipboardData || window.clipboardData).getData('text').trim();
                 if (!text) return;
                 mainInput.value = text;
                 if (text.includes('\n')) {
                     await processInput(text);
                 } else {
                     formatCadastralNumber(mainInput);
                     await processInput(mainInput.value);
                 }
            });
        });

        function initMap() {
            const savedCenter = JSON.parse(localStorage.getItem('mapCenter')) || [55.75, 37.62];
            const savedZoom = parseInt(localStorage.getItem('mapZoom'), 10) || 10;

            map = new ymaps.Map('map', {
                center: savedCenter,
                zoom: savedZoom,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });
            
            const blankLayer = function () {
                return new ymaps.Layer('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wcAAwAB/epv2AAAAABJRU5ErkJggg==', {
                    projection: ymaps.projection.sphericalMercator
                });
            };
            ymaps.layer.storage.add('my#blank', blankLayer);
            ymaps.mapType.storage.add('my#blank', new ymaps.MapType('Пустая', ['my#blank']));
            map.controls.get('typeSelector').addMapType('my#blank');
            map.setType('my#blank');

            map.events.add('boundschange', (e) => {
                localStorage.setItem('mapCenter', JSON.stringify(e.get('newCenter')));
                localStorage.setItem('mapZoom', e.get('newZoom'));
            });

            setupContextMenu();
        }
        
        async function processInput(inputText) {
            clearMap(); 
            if (isCadastralQuarter(inputText)) {
                await drawCadastralQuarter(inputText);
            } else if (isValidCadastralNumber(inputText)) {
                await drawCadastralObjectByNumber(inputText);
            } else if (isCoordinates(inputText)) {
                drawCoordinates(inputText);
            } else {
                await geocodeAndShowAddress(inputText);
            }
        }
        
        function clearMap() {
            if (map) map.geoObjects.removeAll();
            polygons = [];
        }

        // --- Обработка ввода ---

        function isCadastralQuarter(text) {
            return /^\d{2}:\d{2}:\d{6,7}$/.test(text);
        }

        function isValidCadastralNumber(text) {
            return /^\d{2}:\d{2}:\d{6,7}:\d+$/.test(text);
        }

        function isCoordinates(text) {
            return /^[0-9\s\t\n.,-]+$/.test(text) && !text.includes(':');
        }
        
        // ИСПРАВЛЕННАЯ ФУНКЦИЯ
        function formatCadastralNumber(input) {
            let value = input.value;
            if (/^\d/.test(value)) { 
                let cleanedValue = value.replace(/\D/g, ''); 
                const firstTwoDigits = cleanedValue.slice(0, 2);
                const isSevenDigitsRegion = sevenDigitsRegions.includes(firstTwoDigits);
                const thirdBlockLength = isSevenDigitsRegion ? 7 : 6;

                let formatted = '';
                // ИСПРАВЛЕНО: Везде используется cleanedValue для нарезки строки
                if (cleanedValue.length > 0) formatted += cleanedValue.slice(0, 2);
                if (cleanedValue.length > 2) formatted += ':' + cleanedValue.slice(2, 4);
                if (cleanedValue.length > 4) {
                    const remaining = cleanedValue.slice(4);
                    if (remaining.length <= thirdBlockLength) {
                        formatted += ':' + remaining;
                    } else {
                        formatted += ':' + remaining.slice(0, thirdBlockLength) + ':' + remaining.slice(thirdBlockLength);
                    }
                }
                input.value = formatted;
            }
        }

        // --- Функции отрисовки ---

        async function drawCadastralQuarter(quarterNumber) {
            showLoader();
            try {
                const url = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=2&query=${quarterNumber}`;
                const response = await fetch(url);
                const data = await response.json();
                if (!data?.data?.features?.length > 0) throw new Error('Квартал не найден');
                await drawFeaturesFromNspd([data.data.features[0]], '#FF0000');
                showNotification(`Квартал ${quarterNumber} загружен`, 'success');
            } catch (error) {
                console.error('Ошибка загрузки квартала:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        async function drawCadastralObjectByNumber(cadastralNumber) {
            showLoader();
            try {
                const url = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=1&query=${cadastralNumber}`;
                const response = await fetch(url);
                const data = await response.json();
                if (!data?.data?.features?.length > 0) throw new Error('Объект не найден');
                await drawFeaturesFromNspd([data.data.features[0]], '#007bff');
                showNotification(`Объект ${cadastralNumber} загружен`, 'success');
            } catch (error) {
                console.error('Ошибка загрузки объекта:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        function drawCoordinates(coordsText) {
            try {
                const coordGroups = parseCoordinates(coordsText);
                if (coordGroups.length === 0) throw new Error('Некорректный формат координат');
                const geoCoordGroups = determineCoordinateSystemAndConvert(coordGroups);
                if (geoCoordGroups.length === 0) throw new Error('Не удалось преобразовать координаты');
                drawGeoObjects(geoCoordGroups, '#28a745');
            } catch (error) {
                 showNotification(error.message, 'error');
            }
        }
        
 async function geocodeAndShowAddress(address) {
            showLoader();
            try {
                const result = await ymaps.geocode(address, { results: 1 });
                const firstGeoObject = result.geoObjects.get(0);
                if (!firstGeoObject) throw new Error('Адрес не найден');

                const coords = firstGeoObject.geometry.getCoordinates();
                map.setCenter(coords, 17); // Карта центрируется, но метка не добавляется
                
                // --- НАЧАЛО ИЗМЕНЕНИЙ ---
                // Следующие строки были удалены, чтобы убрать метку с карты
                /*
                const placemark = new ymaps.Placemark(coords, {
                    iconCaption: firstGeoObject.getAddressLine()
                }, {
                    preset: 'islands#violetDotIconWithCaption'
                });
                map.geoObjects.add(placemark);
                polygons.push(placemark);
                */
                // --- КОНЕЦ ИЗМЕНЕНИЙ ---

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        // --- Контекстное меню ---

        function setupContextMenu() {
            const contextMenu = document.querySelector('.custom-context-menu');
            map.events.add('contextmenu', (e) => {
                e.preventDefault();
                const coords = e.get('coords');
                contextMenu.innerHTML = `
                    <div class="custom-context-menu-item" data-action="clear-map"><i class="fas fa-eraser"></i>Очистить карту</div>
                    <div class="custom-context-menu-item">
                        <i class="fas fa-layer-group"></i>Загрузить слой
                        <div class="custom-context-submenu">
                            <div class="custom-context-menu-item" data-action="load-zu"><i class="fas fa-draw-polygon"></i>Открыть ЗУ</div>
                            <div class="custom-context-menu-item" data-action="load-oks"><i class="fas fa-building"></i>Открыть ОКС</div>
                            <div class="custom-context-menu-item" data-action="load-quarter"><i class="fas fa-th-large"></i>Границы квартала</div>
                            <div class="custom-context-menu-item" data-action="load-parcels-in-quarter"><i class="fas fa-border-all"></i>ЗУ в квартале</div>
                            <div class="custom-context-menu-item" data-action="load-terr-zone"><i class="fas fa-globe-americas"></i>Территориальные зоны</div>
                            <div class="custom-context-menu-item" data-action="load-zouit"><i class="fas fa-exclamation-triangle"></i>ЗОУИТ</div>
                            <div class="custom-context-menu-item" data-action="load-settlement"><i class="fas fa-city"></i>Населенные пункты</div>
                            <div class="custom-context-menu-item" data-action="load-municipality"><i class="fas fa-landmark"></i>Муниципальные образования</div>
                        </div>
                    </div>`;
                contextMenu.querySelectorAll('[data-action]').forEach(item => {
                    item.onclick = () => handleContextMenuAction(item.dataset.action, coords);
                });
                const position = e.get('position');
                contextMenu.style.left = `${position[0]}px`;
                contextMenu.style.top = `${position[1]}px`;
                contextMenu.style.display = 'block';
            });
            document.addEventListener('click', () => contextMenu.style.display = 'none');
        }
        
        async function handleContextMenuAction(action, coords) {
            const [lat, lon] = coords;
            showLoader();
            try {
                let data;
                let color;
                switch (action) {
                    case 'clear-map':
                        clearMap();
                        showNotification("Карта очищена", "success");
                        break;
                    case 'load-zu':
                        data = await queryNspdByPoint(lat, lon, '36048');
                        color = '#007bff';
                        break;
                    case 'load-oks':
                        data = await queryNspdByPoint(lat, lon, '36049');
                        color = '#17a2b8';
                        break;
                    case 'load-quarter':
                        const quarterData = await getQuarterDataByPoint(lat, lon);
                        if (quarterData) {
                            data = { features: [quarterData] };
                            color = '#FF0000';
                        }
                        break;
                    case 'load-parcels-in-quarter':
                         await getAllParcelsInQuarter(lat, lon);
                         return;
                    case 'load-terr-zone':
                        data = await queryNspdByPoint(lat, lon, '36315');
                        color = '#fd7e14';
                        break;
                    case 'load-zouit':
                        data = await queryNspdByPoint(lat, lon, '37579');
                        if (data?.features?.length > 0) {
                             showZouitSelectionModal(data.features, (selectedIndex) => {
                                 if (selectedIndex !== null) {
                                     const featuresToDraw = selectedIndex === -1 ? data.features : [data.features[selectedIndex]];
                                     drawFeaturesFromNspd(featuresToDraw, '#6f42c1');
                                 }
                            });
                        }
                        data = null;
                        break;
                    case 'load-settlement':
                        data = await queryNspdByPoint(lat, lon, '36281');
                        color = '#20c997';
                        break;
                    case 'load-municipality':
                        data = await queryNspdByPoint(lat, lon, '36278');
                        color = '#6610f2';
                        break;
                }
                if (data?.features?.length > 0) {
                    await drawFeaturesFromNspd(data.features, color);
                } else if (action !== 'clear-map' && action !== 'load-parcels-in-quarter' && action !== 'load-zouit' && data !== undefined) {
                    showNotification('Объекты не найдены', 'warning');
                }
            } catch (error) {
                console.error(`Ошибка действия "${action}":`, error);
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // --- Вспомогательные и API функции ---

        function toEPSG3857(latitude, longitude) {
            const RADIUS = 6378137;
            const x = RADIUS * longitude * Math.PI / 180;
            const y = RADIUS * Math.log(Math.tan(Math.PI / 4 + latitude * Math.PI / 360));
            return { x, y };
        }
        
        async function queryNspdByPoint(latitude, longitude, layerId) {
            const centerPoint = toEPSG3857(latitude, longitude);
            const bbox = `${centerPoint.x - 0.1},${centerPoint.y - 0.1},${centerPoint.x + 0.1},${centerPoint.y + 0.1}`;
            const url = `https://nspd.gov.ru/api/aeggis/v4/${layerId}/wms?REQUEST=GetFeatureInfo&QUERY_LAYERS=${layerId}&SERVICE=WMS&VERSION=1.3.0&FORMAT=image/png&STYLES=&TRANSPARENT=true&LAYERS=${layerId}&INFO_FORMAT=application/json&FEATURE_COUNT=50&I=256&J=256&WIDTH=512&HEIGHT=512&CRS=EPSG:3857&BBOX=${bbox}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
            return await response.json();
        }

        async function getQuarterDataByPoint(lat, lon) {
             const zuData = await queryNspdByPoint(lat, lon, '36048');
             if (!zuData?.features?.[0]?.properties?.descr) return null;
             const quarterNumber = zuData.features[0].properties.descr.split(':').slice(0, 3).join(':');
             const url = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=2&query=${quarterNumber}`;
             const response = await fetch(url);
             if (!response.ok) return null;
             const quarterSearchData = await response.json();
             return quarterSearchData?.data?.features?.[0];
        }
        
        async function getAllParcelsInQuarter(lat, lon) {
            showLoader();
            try {
                const quarterFeature = await getQuarterDataByPoint(lat, lon);
                if (!quarterFeature) throw new Error('Не удалось определить квартал');
                const requestBody = { "geom": { "type": "FeatureCollection", "features": [{ "type": "Feature", "geometry": quarterFeature.geometry }] }, "categories": [{ "id": 36368 }] };
                const response = await fetch('https://nspd.gov.ru/api/geoportal/v1/intersects?typeIntersect=fullObject', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error(`Ошибка запроса участков: ${response.status}`);
                const parcelsData = await response.json();
                if (!parcelsData?.features?.length > 0) {
                     showNotification('Участки в квартале не найдены', 'warning');
                } else {
                     await drawFeaturesFromNspd(parcelsData.features, '#28a745');
                     showNotification(`Загружено участков: ${parcelsData.features.length}`, 'success');
                }
            } catch (error) {
                console.error(error);
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
async function drawFeaturesFromNspd(features, color) {
            let combinedBounds;
            for (const feature of features) {
                if (!feature.geometry || !feature.geometry.coordinates) continue;
                
                const processCoords = (coords) => coords.map(c => {
                    const point = proj4('EPSG:3857', 'EPSG:4326', c);
                    return [point[1] - mapOffsetY * 0.000008983, point[0] - mapOffsetX * 0.000008983];
                });
                
                let geometry;
                if (feature.geometry.type === 'Polygon') {
                    geometry = new ymaps.Polygon([processCoords(feature.geometry.coordinates[0])]);
                } else if (feature.geometry.type === 'MultiPolygon') {
                    geometry = new ymaps.Polygon(feature.geometry.coordinates.map(poly => processCoords(poly[0])));
                } else {
                    continue;
                }
                
                geometry.options.set({ strokeColor: color, strokeWidth: 3, fillColor: color, fillOpacity: 0.1 });
                map.geoObjects.add(geometry);
                polygons.push(geometry);
                
                const bounds = geometry.geometry.getBounds();
                if (!combinedBounds) {
                    combinedBounds = bounds;
                } else {
                    combinedBounds = [
                        [Math.min(combinedBounds[0][0], bounds[0][0]), Math.min(combinedBounds[0][1], bounds[0][1])],
                        [Math.max(combinedBounds[1][0], bounds[1][0]), Math.max(combinedBounds[1][1], bounds[1][1])]
                    ];
                }
                
                // --- НАЧАЛО ИЗМЕНЕНИЙ ---
                // Блок создания метки (Placemark) удален, чтобы не загромождать карту.
                /*
                 const centerGeo = [ (bounds[0][0] + bounds[1][0]) / 2, (bounds[0][1] + bounds[1][1]) / 2 ];
                 const label = new ymaps.Placemark(centerGeo, {
                     iconCaption: feature.properties.descr
                 }, {
                     preset: 'islands#blackStretchyIcon'
                 });
                 map.geoObjects.add(label);
                 polygons.push(label);
                */
                // --- КОНЕЦ ИЗМЕНЕНИЙ ---
            }
            if (combinedBounds) map.setBounds(combinedBounds, { checkZoomRange: true, duration: 300 });
        }
        function drawGeoObjects(geoCoordGroups, color) {
             let combinedBounds;
             for (const group of geoCoordGroups) {
                 const offsetGroup = group.map(c => [c[0] - mapOffsetY * 0.000008983, c[1] - mapOffsetX * 0.000008983]);
                 let geoObject;
                 if (offsetGroup.length === 1) {
                     geoObject = new ymaps.Placemark(offsetGroup[0], {}, { preset: 'islands#icon', iconColor: color });
                 } else {
                     geoObject = new ymaps.Polyline(offsetGroup, {}, { strokeColor: color, strokeWidth: 4 });
                 }
                 map.geoObjects.add(geoObject);
                 polygons.push(geoObject);
                 const bounds = geoObject.geometry.getBounds();
                  if (!combinedBounds) { combinedBounds = bounds; } 
                  else { combinedBounds = [ [Math.min(combinedBounds[0][0], bounds[0][0]), Math.min(combinedBounds[0][1], bounds[0][1])], [Math.max(combinedBounds[1][0], bounds[1][0]), Math.max(combinedBounds[1][1], bounds[1][1])] ]; }
             }
             if (combinedBounds) map.setBounds(combinedBounds, { checkZoomRange: true, duration: 300 });
        }
        
        function showZouitSelectionModal(features, onSelectCallback) {
            const modal = document.createElement('div');
            modal.className = 'zouit-selection-modal';
            let optionsHtml = `<button data-index="-1" style="background-color: #28a745; color: white;">Отобразить все (${features.length})</button>`;
            features.forEach((feature, index) => { const name = feature.properties.options?.name_by_doc || 'Без названия'; optionsHtml += `<button data-index="${index}">${name}</button>`; });
            modal.innerHTML = `<h3>Найдено ЗОУИТ: ${features.length}</h3><div class="options">${optionsHtml}</div><div class="controls"><button class="cancel-btn">Отмена</button></div>`;
            document.body.appendChild(modal);
            modal.querySelectorAll('button').forEach(btn => { btn.onclick = () => { const i = btn.dataset.index; onSelectCallback(i ? parseInt(i) : null); document.body.removeChild(modal); }; });
            modal.querySelector('.cancel-btn').onclick = () => { onSelectCallback(null); document.body.removeChild(modal); }
        }

        function parseCoordinates(text) {
             return text.split(/\n\s*\n/).map(g => g.trim()).filter(Boolean).map(g => g.split('\n').map(l => l.trim()).filter(Boolean).map(l => { const p = l.split(/[\s\t,]+/).map(parseFloat); return p.length >= 2 && isFinite(p[0]) && isFinite(p[1]) ? [p[0], p[1]] : null; }).filter(Boolean)).filter(g => g.length > 0);
        }
        function determineCoordinateSystemAndConvert(coordGroups) {
             const firstCoord = coordGroups[0][0];
             let x = firstCoord[0], y = firstCoord[1];
             if (Math.abs(x) > 2000000) return convertCoordinatesToGeo(coordGroups, "MSK16_ZONE2", false);
             if (Math.abs(y) > 2000000) return convertCoordinatesToGeo(coordGroups, "MSK16_ZONE2", true);
             if (Math.abs(x) > 1000000) return convertCoordinatesToGeo(coordGroups, "MSK16_ZONE1", false);
             if (Math.abs(y) > 1000000) return convertCoordinatesToGeo(coordGroups, "MSK16_ZONE1", true);
             if (Math.abs(x) <= 180 && Math.abs(y) <= 90) return convertCoordinatesToGeo(coordGroups, "EPSG:4326", true);
             return convertCoordinatesToGeo(coordGroups, "EPSG:4326", false);
        }
        function convertCoordinatesToGeo(coordGroups, system, swap) {
            return coordGroups.map(group => group.map(coord => {
                try {
                    const [input1, input2] = swap ? [coord[1], coord[0]] : [coord[0], coord[1]];
                    let wgs84;
                    if (system === 'EPSG:4326') { wgs84 = swap ? [input2, input1] : [input1, input2]; } 
                    else {
                         const correctedX = input1 + (system.includes("MSK16") ? 14.745 : 0);
                         const correctedY = input2 - (system.includes("MSK16") ? 14.038 : 0);
                         wgs84 = proj4(system, "EPSG:4326", [correctedX, correctedY]);
                         if (system.includes("MSK16")) { wgs84[0] -= 0.00000152; wgs84[1] += 0.00000118; }
                    }
                    return [wgs84[1], wgs84[0]];
                } catch { return null; }
            }).filter(Boolean));
        }

        // --- UI Хелперы ---
        function showLoader() { document.getElementById('loaderContainer').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loaderContainer').style.display = 'none'; }
        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, 3000);
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Word Trainer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2196F3;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FFC107;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100dvh; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        /* --- Buttons --- */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); color: #333; }
        .btn-secondary { background-color: #607D8B; }

        /* --- Screens --- */
        .screen { display: flex; flex-direction: column; height: 100%; padding: 15px; position: absolute; width: 100%; top: 0; left: 0; transition: opacity 0.3s; opacity: 0; pointer-events: none; z-index: 0; }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 1; }

        /* --- Input Screen --- */
        .input-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--card); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 15px; position: relative; }
        textarea { flex: 1; width: 100%; border: none; padding: 20px; font-size: 16px; resize: none; outline: none; font-family: inherit; }
        .controls-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .full-width-btn { width: 100%; margin-top: 10px; }

        /* --- Game Screen --- */
        .game-header { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .progress-bar { flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 0 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .icon-btn { background: none; border: none; font-size: 20px; color: #555; cursor: pointer; padding: 5px; }

        .word-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 20vh; }
        #target-word { font-size: 32px; font-weight: 800; text-align: center; animation: popIn 0.5s; margin-bottom: 5px; }
        .word-counter { font-size: 14px; color: #888; margin-top: 5px; }

        .options-area { flex: 1.5; padding: 10px; overflow-y: auto; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 100%; align-content: center; }
        .option-btn { background: white; border: none; border-radius: 12px; padding: 10px; font-size: 16px; color: #444; box-shadow: 0 3px 0 #ddd, 0 4px 8px rgba(0,0,0,0.05); min-height: 80px; font-weight: 500; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; text-align: center; word-break: break-word; }
        .option-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #ddd; }

        /* --- Animations --- */
        .correct-anim { background-color: var(--success) !important; color: white !important; box-shadow: 0 3px 0 #388E3C !important; animation: pulse 0.4s; }
        .wrong-anim { background-color: var(--error) !important; color: white !important; box-shadow: 0 3px 0 #D32F2F !important; animation: shake 0.4s; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 50% { transform: scale(1.05); } }
        @keyframes shake { 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- Result Screen --- */
        .result-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3); }
        .score-val { font-size: 42px; font-weight: bold; }
        
        /* --- Loader --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .hidden-file { display: none; }
    </style>
</head>
<body>

    <!-- SCREEN 1: INPUT -->
    <div id="screen-input" class="screen active">
        <div class="input-wrapper">
            <textarea id="sourceText" placeholder="Вставьте текст сюда...&#10;&#10;Программа автоматически разобьет его на отдельные слова (исключая фразы) и создаст словарь для тренировки."></textarea>
        </div>
        
        <button class="btn btn-primary full-width-btn" onclick="startProcessing()">
            <i class="fas fa-magic"></i> Обработать и начать
        </button>

        <div class="controls-row">
            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-upload"></i> Импорт
            </button>
            <button class="btn btn-warning" onclick="clearText()">
                <i class="fas fa-trash"></i> Очистить
            </button>
        </div>
        <input type="file" id="fileInput" class="hidden-file" accept=".words,.json" onchange="importWords(this)">
    </div>

    <!-- SCREEN 2: GAME -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <span style="font-weight: bold; color: var(--primary);">Счет: <span id="score">0</span></span>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <button class="icon-btn" onclick="exportWords()" title="Сохранить словарь"><i class="fas fa-download"></i></button>
            <button class="icon-btn" onclick="goToInput()" style="margin-left: 10px;"><i class="fas fa-times"></i></button>
        </div>

        <div class="word-area">
            <div id="target-word">Word</div>
            <div class="word-counter">Слово <span id="current-word-idx">1</span> из <span id="total-word-count">10</span></div>
        </div>

        <div class="options-area">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <!-- SCREEN 3: RESULT -->
    <div id="screen-result" class="screen">
        <div class="result-content">
            <div class="score-circle">
                <span class="score-val" id="final-percent">0%</span>
                <span style="font-size: 14px;">Точность</span>
            </div>
            <p>Всего слов: <strong id="res-total">0</strong></p>
            <p>Ошибок: <strong id="res-errors" style="color: var(--error)">0</strong></p>
        </div>
        <button class="btn btn-primary full-width-btn" onclick="goToInput()">
            <i class="fas fa-home"></i> На главную
        </button>
        <button class="btn btn-success full-width-btn" onclick="restartGame()">
            <i class="fas fa-redo"></i> Пройти заново
        </button>
        <button class="btn btn-secondary full-width-btn" onclick="exportWords()">
            <i class="fas fa-download"></i> Сохранить словарь (.words)
        </button>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <h3 id="loader-text">Анализ текста...</h3>
        <p id="loader-sub" style="color:#888; font-size:13px; text-align:center; padding:0 20px;"></p>
    </div>

    <script>
        // --- CONFIG ---
        const VERCEL_PROXY = "https://ver-olive-delta.vercel.app";
        const MAPRUAPP_PROXY = "https://mapruapp.ru";
        const PROXY_MODE = 1;
        const MODEL = "gemini-2.5-flash-lite";

        // --- STATE ---
        let state = {
            words: [], // {original: "word", translation: "слово"}
            gameOrder: [],
            idx: 0,
            score: 0,
            mistakes: 0,
            locked: false
        };

        // --- LOGIC: TEXT PROCESSING ---
        
        async function startProcessing() {
            const text = document.getElementById('sourceText').value;
            if (text.trim().length < 5) {
                alert("Введите текст для обработки.");
                return;
            }

            setLoading(true, "Разбиение на слова...");

            // 1. Client-side Tokenization (Client splits the words to ensure no phrases)
            // Regex: берет слова от 3 букв, исключая цифры. Поддержка латиницы и кириллицы (если нужно учить русский)
            const rawWords = text.match(/[a-zA-Z\u00C0-\u00FF]+|[а-яА-ЯёЁ]+/g) || [];
            
            // Filter: unique, lower case, length > 2
            const uniqueSet = new Set();
            rawWords.forEach(w => {
                if (w.length > 2) uniqueSet.add(w.toLowerCase());
            });
            
            let wordsList = Array.from(uniqueSet);

            if (wordsList.length === 0) {
                setLoading(false);
                alert("Не найдено подходящих слов.");
                return;
            }

            // Limit to prevent huge payload error (e.g., max 200 words at a time)
            if (wordsList.length > 200) {
                if (!confirm(`Найдено ${wordsList.length} уникальных слов. Обработать только первые 200?`)) {
                    setLoading(false);
                    return;
                }
                wordsList = wordsList.slice(0, 200);
            }

            setLoading(true, `Перевод ${wordsList.length} слов через ИИ...`);

            // 2. Send LIST to AI for translation
            // This guarantees structure: Word -> Translation
            const prompt = `
                I have a list of single words. Translate each one to Russian.
                Context: General vocabulary.
                Return strictly a JSON array of objects with keys: "original" (the word from my list) and "translation" (Russian translation).
                Return ONLY the JSON. No markdown.
                
                List of words:
                ${JSON.stringify(wordsList)}
            `;

            try {
                let jsonStr = await callAI(prompt);
                // Clean response
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const translatedData = JSON.parse(jsonStr);

                if (!Array.isArray(translatedData)) throw new Error("Invalid AI response");

                // Filter out bad results
                state.words = translatedData.filter(item => 
                    item.original && item.translation && 
                    !item.original.includes(' ') // Double check for phrases
                );

                startGame();
            } catch (e) {
                console.error(e);
                alert("Ошибка ИИ: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        async function callAI(prompt) {
            let url, body;
            if (PROXY_MODE === 1) {
                url = `${MAPRUAPP_PROXY}/ai/api/v1/chat/completions`;
                body = {
                    model: MODEL,
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 8000,
                    response_format: { type: "json_object" }
                };
            } else {
                url = `${VERCEL_PROXY}/v1beta/models/${MODEL}:generateContent`;
                body = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
            }

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (!res.ok) throw new Error("API Error " + res.status);
            const data = await res.json();
            
            return PROXY_MODE === 1 
                ? data.choices[0].message.content 
                : data.candidates[0].content.parts[0].text;
        }

        // --- GAMEPLAY ---

        function startGame() {
            if (state.words.length < 4) {
                alert("Слишком мало слов для игры (минимум 4).");
                return;
            }
            state.gameOrder = [...state.words].sort(() => Math.random() - 0.5);
            state.idx = 0;
            state.score = 0;
            state.mistakes = 0;
            
            showScreen('screen-game');
            nextWord();
        }

        function restartGame() {
            startGame();
        }

        function nextWord() {
            if (state.idx >= state.gameOrder.length) {
                endGame();
                return;
            }

            state.locked = false;
            const current = state.gameOrder[state.idx];
            
            // UI Updates
            document.getElementById('target-word').textContent = current.original;
            document.getElementById('current-word-idx').textContent = state.idx + 1;
            document.getElementById('total-word-count').textContent = state.gameOrder.length;
            document.getElementById('score').textContent = state.score;
            
            const pct = (state.idx / state.gameOrder.length) * 100;
            document.getElementById('progress').style.width = `${pct}%`;

            renderOptions(current);
        }

        function renderOptions(correct) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            // 1 Correct + 3 Distractors
            let pool = state.words.filter(w => w.original !== correct.original);
            let distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3);
            let options = [correct, ...distractors].sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.translation;
                btn.onclick = () => handleAnswer(opt, correct, btn);
                container.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btn) {
            if (state.locked) return;
            state.locked = true;

            const isCorrect = selected.original === correct.original;
            
            if (isCorrect) {
                btn.classList.add('correct-anim');
                state.score++;
            } else {
                btn.classList.add('wrong-anim');
                state.mistakes++;
                // Highlight correct
                Array.from(document.querySelectorAll('.option-btn')).forEach(b => {
                    if (b.textContent === correct.translation) {
                        b.style.border = "2px solid var(--success)";
                        b.style.color = "var(--success)";
                    }
                });
            }

            setTimeout(() => {
                state.idx++;
                nextWord();
            }, 800);
        }

        function endGame() {
            showScreen('screen-result');
            const total = state.gameOrder.length;
            const accuracy = Math.round((state.score / total) * 100);
            
            document.getElementById('final-percent').textContent = `${accuracy}%`;
            document.getElementById('res-total').textContent = total;
            document.getElementById('res-errors').textContent = state.mistakes;
        }

        // --- IMPORT / EXPORT ---

        function exportWords() {
            if (!state.words || state.words.length === 0) {
                alert("Словарь пуст.");
                return;
            }
            const dataStr = JSON.stringify(state.words, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `dictionary_${new Date().getTime()}.words`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importWords(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json) && json.length > 0 && json[0].original) {
                        state.words = json;
                        alert(`Загружено ${json.length} слов.`);
                        startGame();
                    } else {
                        throw new Error("Неверный формат файла");
                    }
                } catch (err) {
                    alert("Ошибка чтения файла: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // reset
        }

        // --- NAVIGATION & UI ---

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToInput() {
            showScreen('screen-input');
        }

        function clearText() {
            document.getElementById('sourceText').value = '';
        }

        function setLoading(active, text = "") {
            document.getElementById('loader').style.display = active ? 'flex' : 'none';
            document.getElementById('loader-sub').textContent = text;
        }

    </script>
</body>
</html>
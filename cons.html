<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Консультант</title>
    <script src="webfonts/marked.min.js"></script>
    <script src="webfonts/mermaid.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <link id="favicon" rel="icon" href="img/service.png" type="image/png">
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-color: #333;
        --primary-color: #007bff;
        --primary-color-dark: #0056b3;
        --secondary-text-color: #555;
        --border-color: #e0e6ec;
        --danger-color: #dc3545;
        --danger-bg-color: #f8d7da;
        --print-color: #28a745;
        --print-dark-color: #218838;
        --new-chat-color: #FFA500;
        --new-chat-dark-color: #E86100;
        --indicator-color: #ff4d4d;
        --settings-color-proxy-lite: #007bff;
        --settings-color-proxy-standard: #0056b3;
        --settings-color-direct-lite: #FFA500;
        --settings-color-direct-standard: #dc3545;
        --settings-color-claude: #28a745;
    }
    html, body {
        height: 100%; margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    .app-container {
        display: flex; flex-direction: column;
        height: 100dvh;
        background-color: var(--card-bg-color);
    }
    .app-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 25px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .app-header h1 {
        grid-column: 2 / 3;
        margin: 0; font-size: 24px; font-weight: 500;
        color: var(--primary-color);
        text-align: center;
    }
    .header-right-controls {
        grid-column: 3 / 4;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative; /* For popup positioning */
    }
    .app-header h1 i { margin-right: 10px; }

    #settings-btn {
        background: transparent;
        border: 1px solid transparent;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--primary-color);
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    #settings-btn:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }

    /* History Button and Popup Styles */
    #history-btn {
        background: transparent;
        border: 1px solid transparent;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--primary-color);
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 5px;
    }
    #history-btn:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }
    .history-popup {
        display: none;
        position: absolute;
        top: 55px;
        right: 0;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1010;
        min-width: 250px;
        max-width: 400px;
        max-height: 300px;
        overflow-y: auto;
    }
    .history-item {
        padding: 10px 15px;
        font-size: 14px;
        color: var(--text-color);
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-bottom: 1px solid var(--border-color);
    }
    .history-item:last-child {
        border-bottom: none;
    }
    .history-item:hover {
        background-color: var(--bg-color);
    }
    .history-popup-empty {
        padding: 20px;
        text-align: center;
        color: var(--secondary-text-color);
        font-size: 14px;
    }


    .header-right-controls-movable { display: none; }
    
        /* --- НОВЫЕ СТИЛИ ДЛЯ СЕЛЕКТОРА РЕЖИМА API --- */
    .api-mode-selector-container { position: relative; width: 100%; }
    #api-mode-selector-button {
        width: 100%;
        padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; background-color: white;
        cursor: pointer; transition: all 0.2s ease; font-size: 16px;
        color: var(--text-color); display: flex; align-items: center; gap: 10px;
        text-align: left;
    }
    #api-mode-selector-button:hover { border-color: var(--primary-color); }
    #api-mode-selector-button .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    #api-mode-selector-button .text { flex-grow: 1; }
    #api-mode-selector-button::after {
        content: ''; width: 8px; height: 8px;
        border-right: 2px solid var(--secondary-text-color);
        border-bottom: 2px solid var(--secondary-text-color);
        transform: rotate(45deg); margin-left: auto;
    }
    #api-mode-options {
        position: absolute; list-style: none; padding: 0; margin: 5px 0 0 0;
        background-color: white; border: 1px solid var(--border-color);
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%; z-index: 1011; display: none;
    }
    .api-mode-option {
        padding: 12px 15px; cursor: pointer; display: flex;
        align-items: center; gap: 10px; font-size: 16px;
    }
    .api-mode-option:hover { background-color: var(--bg-color); }
    .api-mode-option .icon { width: 20px; height: 20px; fill: var(--primary-color); flex-shrink: 0; }
    .api-mode-option.selected { font-weight: 500; background-color: #eaf4ff; }
    
    
    
    .api-mode-switcher {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;
        background-color: #f8f9fa;
        transition: opacity 0.3s;
    }
    
    
    
    .api-mode-switcher .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 8px; }
    .api-mode-switcher .switch input { opacity: 0; width: 0; height: 0; }
    .api-mode-switcher .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc; transition: .4s; border-radius: 20px;
    }
    .api-mode-switcher .slider:before {
        position: absolute; content: ""; height: 14px; width: 14px;
        left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    .api-mode-switcher input:checked + .slider { background-color: var(--primary-color); }
    .api-mode-switcher input:checked + .slider:before { transform: translateX(20px); }

    .mode-selector {
        display: flex; justify-content: center; flex-wrap: wrap;
        padding: 15px 10px; background-color: #fcfdff;
        border-bottom: 1px solid var(--border-color);
        gap: 10px; flex-shrink: 0;
    }
    .mode-btn {
        padding: 10px 15px; font-size: 14px; font-weight: 500;
        border: 1px solid #d4e5f9; background-color: #eaf4ff; color: var(--primary-color-dark);
        cursor: pointer; border-radius: 8px; transition: all 0.3s ease; position: relative;
    }
    .mode-btn:hover { background-color: #d4e7ff; border-color: #b8d6f9; }
    .mode-btn.active {
        background-color: var(--primary-color); color: white; border-color: var(--primary-color-dark);
        box-shadow: 0 2px 5px rgba(0,123,255,0.2);
    }

    .mode-btn i { margin-right: 8px; }
    .mode-btn.is-loading::after {
        content: ''; position: absolute; top: -4px; right: -4px; width: 10px; height: 10px;
        background-color: var(--indicator-color); border-radius: 50%; border: 2px solid white;
        box-shadow: 0 0 5px var(--indicator-color); animation: pulse 1.5s infinite;
    }
    .response-timer {
        display: none; position: absolute; top: -8px; right: -5px;
        background-color: var(--primary-color); color: white; font-size: 10px; font-weight: 500;
        padding: 2px 6px; border-radius: 10px; border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 2; white-space: nowrap;
    }
    .mode-btn.has-new-response .response-timer { display: inline-block; }

    @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.9; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.9; } }
    .response-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .response-actions {
        padding: 10px 25px; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color);
        display: none; gap: 10px; flex-shrink: 0; align-items: center;
    }
    .action-btn {
        padding: 8px 15px; border-radius: 5px; cursor: pointer;
        font-size: 14px; font-weight: 500; color: white; transition: all 0.2s ease; border: none;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn i { margin-right: 8px; }
    #copy-btn { background-color: var(--primary-color); }
    #copy-btn:hover { background-color: var(--primary-color-dark); }
    #print-btn { background-color: var(--print-color); }
    #print-btn:hover { background-color: var(--print-dark-color); }
    #new-chat-btn { background-color: var(--new-chat-color); margin-left: auto; }
    #new-chat-btn:hover { background-color: var(--new-chat-dark-color); }
    .response-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .welcome-message { text-align: center; color: var(--secondary-text-color); padding-top: 15vh; animation: fadeInUp 0.5s ease forwards; }
    .welcome-message i { font-size: 48px; margin-bottom: 20px; color: var(--primary-color); opacity: 0.8; }
    .welcome-message h2 { font-weight: 500; font-size: 22px; color: var(--text-color); margin-bottom: 10px; }
    .welcome-message p { font-size: 16px; line-height: 1.6; }
    .welcome-message p em { color: #999; font-size: 14px; display: block; margin-top: 15px; }
    #ai-response { line-height: 1.7; font-size: 16px; }
    #ai-response h3, #ai-response h2 {
        font-size: 18px; font-weight: 500; color: var(--text-color); margin-top: 30px; margin-bottom: 15px;
        padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    #ai-response h2 { font-size: 20px; text-align: center; border-bottom: 2px solid var(--primary-color);}
    #ai-response h3 i { margin-right: 10px; }
    #ai-response ul, #ai-response ol { padding-left: 25px; }
    #ai-response li { margin-bottom: 8px; }
    #ai-response strong { color: var(--primary-color-dark); font-weight: 500; }
    #ai-response hr { border: none; border-top: 3px dotted #ced4da; margin: 40px 20%; }
    #ai-response table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    #ai-response th, #ai-response td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
    #ai-response th { background-color: #f8f9fa; font-weight: 500; }
    #ai-response .disclaimer, #ai-response .crisis-protocol {
        display: block; background-color: var(--danger-bg-color); border: 1px solid var(--danger-color); color: #721c24;
        padding: 15px; border-radius: 8px; font-size: 15px; line-height: 1.6; margin-top: 30px;
        text-align: left; font-weight: 700 !important;
    }
    #ai-response .disclaimer i, #ai-response .crisis-protocol i { margin-right: 10px; }

    #ai-response .flowchart-btn {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        border: none;
        margin-top: 20px;
        display: inline-block;
        transition: background-color 0.2s ease;
    }
    #ai-response .flowchart-btn:hover {
        background-color: var(--primary-color-dark);
    }
    #ai-response .flowchart-btn i {
        margin-right: 10px;
    }

    .loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
    .loader p { margin-top: 20px; color: var(--secondary-text-color); font-size: 16px; }
    #cancel-btn { margin-top: 15px; background-color: var(--new-chat-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    #cancel-btn:hover { background-color: var(--new-chat-dark-color); }
    .loader .loader-icon { font-size: 64px; color: var(--primary-color); opacity: 0.8; margin-bottom: 10px; }
    .loader-icon-lawyer { animation: balance 2s ease-in-out infinite; transform-origin: 50% 90%; } @keyframes balance { 0%, 100% { transform: rotate(8deg); } 50% { transform: rotate(-8deg); } }
    .loader-icon-realty { animation: turn-key 2s ease-in-out infinite; } @keyframes turn-key { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
    .loader-icon-auto { animation: spin 2s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .loader-icon-techsupport { animation: blink 1s step-end infinite; } @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .loader-icon-vet { animation: pulse-paw 1.5s ease-in-out infinite; } @keyframes pulse-paw { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .loader-icon-diy { animation: spin-wrench 3s ease-in-out infinite; } @keyframes spin-wrench { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
    .loader-icon-chef { animation: steam 2s ease-out infinite; } @keyframes steam { 0% { opacity: 0.3; transform: translateY(10px) scale(0.95); } 50% { opacity: 1; transform: translateY(-10px) scale(1.05); } 100% { opacity: 0.3; transform: translateY(-20px) scale(1.1); } }
    .loader-icon-gardener { animation: grow-plant 2.5s ease-in-out infinite; transform-origin: bottom center; } @keyframes grow-plant { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .loader-icon-psychologist { animation: float-bubble 2.5s ease-in-out infinite; } @keyframes float-bubble { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .loader-icon-historian { animation: flip-hourglass 2.5s ease-in-out infinite; } @keyframes flip-hourglass { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
    /* --- NEW --- */
    .loader-icon-encyclopedist { animation: spin-atlas 4s linear infinite; } @keyframes spin-atlas { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
       .loader-icon-dossier { animation: focus-on 2s ease-in-out infinite; } @keyframes focus-on { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.15); opacity: 1; } }
    .loader-icon-biographer { animation: pulse-paw 1.5s ease-in-out infinite; }
    .loader-icon-philosopher { animation: float-atom 4s ease-in-out infinite; } @keyframes float-atom { 0% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-8px); } 50% { transform: translateY(0) rotate(180deg); } 75% { transform: translateY(8px); } 100% { transform: translateY(0) rotate(360deg); } }
    .loader-icon-scientist { animation: float-up-down 3s ease-in-out infinite; } @keyframes float-up-down { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    .loader-icon-kino { animation: flicker 1.5s infinite alternate; } @keyframes flicker { 0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #fff, 0 0 11px #fff, 0 0 19px #fff, 0 0 40px var(--primary-color), 0 0 80px var(--primary-color), 0 0 90px var(--primary-color), 0 0 100px var(--primary-color), 0 0 150px var(--primary-color); opacity: 1; } 20%, 24%, 55% { text-shadow: none; opacity: 0.8; } }
    .loader-icon-instructor { animation: point-down 2s ease-in-out infinite; } @keyframes point-down { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .loader-icon-book-expert { animation: turn-page 2.5s ease-in-out infinite; } @keyframes turn-page { 0% { transform: perspective(800px) rotateY(0deg); } 50% { transform: perspective(800px) rotateY(180deg); } 100% { transform: perspective(800px) rotateY(360deg); } }

    .input-panel { display: flex; padding: 15px 25px; gap: 15px; border-top: 1px solid var(--border-color); background-color: #f8f9fa; flex-shrink: 0; align-items: center; }
    #user-query {
        flex-grow: 1; padding: 12px 15px; font-size: 16px; font-family: 'Roboto', sans-serif; border-radius: 22px;
        border: 1px solid var(--border-color); resize: none; height: 24px; line-height: 24px; transition: all 0.2s ease; max-height: 150px;
    }
    #user-query:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    #send-btn {
        flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: none; background-color: var(--primary-color);
        color: white; font-size: 20px; cursor: pointer; transition: all 0.2s ease;
        display: flex; align-items: center; justify-content: center;
    }
    #send-btn:hover { background-color: var(--primary-color-dark); }
    #user-query:disabled, #send-btn:disabled, .mode-btn:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px;
        display: flex; flex-direction: column;
    }
    .modal-content h2 { margin-top: 0; color: var(--primary-color); text-align: center;}
    .modal-content p { color: var(--secondary-text-color); line-height: 1.6; text-align: center;}
    .modal-content a { color: var(--primary-color-dark); text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }

    #flowchart-modal-overlay {
        z-index: 1001;
        background-color: #ffffff;
    }
    .flowchart-modal-content {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        padding: 20px;
        position: relative;
        overflow: auto;
    }
    .flowchart-modal-close {
        position: fixed;
        top: 15px;
        right: 20px;
        font-size: 30px;
        color: #888;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s;
        z-index: 1002;
    }
    .flowchart-modal-close:hover {
        color: #333;
    }
    #mermaid-container {
        width: 100%;
        min-height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #mermaid-container svg {
        max-width: none;
    }


    .settings-controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .settings-control-group { text-align: left; }
    .settings-control-group label { display: block; margin-bottom: 8px; color: var(--secondary-text-color); font-size: 14px; }
    .settings-control-group select, .settings-control-group input[type="password"] {
        width: 100%; padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; font-size: 16px; box-sizing: border-box;
    }
    #api-key-input-group { display: none; }
    #save-settings-btn {
        margin-top: 25px; width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s;
    }
    #save-settings-btn:hover { background-color: var(--primary-color-dark); }


@media print {
    .app-header, .input-panel, .response-actions, .mode-selector, #settings-btn, .flowchart-btn, #history-btn {
        display: none !important;
    }
    body, .app-container {
        background-color: #ffffff !important; box-shadow: none !important;
        height: auto !important; overflow: visible !important; color: #000000 !important;
    }
    .response-area, .response-wrapper {
        height: auto !important; overflow: visible !important; display: block !important;
        padding: 0 !important; flex-grow: 0 !important;
    }
    #ai-response { line-height: 1.4; font-size: 12pt; }
    #ai-response table { box-shadow: none !important; page-break-inside: auto; }
    #ai-response tr { page-break-inside: avoid; }
}

    .flowchart-modal-save-btn {
        position: fixed;
        top: 19px;
        right: 60px;
        font-size: 24px;
        color: #888;
        cursor: pointer;
        transition: color 0.2s;
        z-index: 1002;
    }
    .flowchart-modal-save-btn:hover {
        color: #333;
    }
    .flowchart-modal-close {
        position: fixed;
        top: 15px;
        right: 20px;
        font-size: 30px;
        color: #888;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s;
        z-index: 1002;
    }

    @media (max-width: 768px) {
        .app-header { grid-template-columns: auto 1fr auto; gap: 10px; padding: 10px 15px; }
        .app-header h1 { grid-column: 2 / 3; font-size: 20px; }
        .header-right-controls { grid-column: 3 / 4; }
        .header-left { display: none; }
        .response-wrapper, .input-panel, .response-actions { padding: 15px; }
        .mode-selector { padding: 10px; flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
        .mode-btn { padding: 8px 12px; font-size: 14px; flex-shrink: 0; }
        .welcome-message { padding-top: 10vh; }
        #ai-response { font-size: 15px; }
    }

    .loader-icon-fact-checker {
        width: 64px;
        height: 64px;
        position: relative;
    }
    .loader-icon-fact-checker svg {
        width: 100%;
        height: 100%;
    }
    .loader-icon-fact-checker .check-path {
        stroke-dasharray: 100;
        stroke-dashoffset: 100;
        animation: draw-check 1.5s ease-in-out infinite;
        stroke: var(--primary-color);
        stroke-width: 5;
        fill: none;
    }
    @keyframes draw-check {
        0% {
            stroke-dashoffset: 100;
        }
        50% {
            stroke-dashoffset: 0;
        }
        100% {
            stroke-dashoffset: -100; /* Галочка исчезает, готовясь к новому циклу */
        }
    }

        .loader-icon-historian { animation: flip-hourglass 2.5s ease-in-out infinite; } @keyframes flip-hourglass { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
    
    
    .loader-icon-geographer { animation: spin-globe 4s linear infinite; } @keyframes spin-globe { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    
    .loader-icon-encyclopedist { animation: spin-atlas 4s linear infinite; } @keyframes spin-atlas { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left"></div>
            <h1><i class="fas fa-headset"></i>Консультант</h1>
            <div class="header-right-controls">
                <button id="history-btn" title="История запросов">
                    <i class="fas fa-history"></i>
                </button>
                <button id="settings-btn" title="Настройки">
                    <i class="fas fa-cog"></i>
                    <i class="fas fa-key" style="display: none;"></i>
                </button>
                <div id="history-popup" class="history-popup"></div>
            </div>
        </header>

        <div class="mode-selector">
            <button class="mode-btn" id="mode-instructor" data-mode="instructor"><i class="fa-solid fa-list-check"></i>Инструктор<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-lawyer" data-mode="lawyer"><i class="fa-solid fa-scale-balanced"></i>Юрист<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-realty" data-mode="realty"><i class="fa-solid fa-house-chimney-user"></i>Эксперт по недвижимости<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-auto" data-mode="auto"><i class="fa-solid fa-car-burst"></i>АвтоЭксперт<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-techsupport" data-mode="techsupport"><i class="fa-solid fa-laptop-code"></i>Техподдержка<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-vet" data-mode="vet"><i class="fa-solid fa-paw"></i>Ветеринар<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-diy" data-mode="diy"><i class="fa-solid fa-paint-roller"></i>ДомМастер<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-chef" data-mode="chef"><i class="fa-solid fa-kitchen-set"></i>Шеф-повар<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-gardener" data-mode="gardener"><i class="fa-solid fa-seedling"></i>Садовод<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-psychologist" data-mode="psychologist"><i class="fa-solid fa-hand-holding-heart"></i>Психолог<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-kino" data-mode="kino"><i class="fa-solid fa-film"></i>КиноЭксперт<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-book_expert" data-mode="book_expert"><i class="fa-solid fa-book-open-reader"></i>Библиотекарь<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-biographer" data-mode="biographer"><i class="fa-solid fa-book-open"></i>Биограф<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-historian" data-mode="historian"><i class="fa-solid fa-scroll"></i>Историк<span class="response-timer"></span></button>
     <button class="mode-btn" id="mode-geographer" data-mode="geographer"><i class="fa-solid fa-globe-americas"></i>Географ<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-encyclopedist" data-mode="encyclopedist"><i class="fa-solid fa-atlas"></i>Энциклопедия<span class="response-timer"></span></button>
              <button class="mode-btn" id="mode-fact_checker" data-mode="fact_checker"><i class="fa-solid fa-stamp"></i>100 Фактов<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-scientist" data-mode="scientist"><i class="fa-solid fa-microscope"></i>Ученый<span class="response-timer"></span></button>
              <button class="mode-btn" id="mode-dossier" data-mode="dossier"><i class="fa-solid fa-address-card"></i>Досье<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-philosopher" data-mode="philosopher"><i class="fa-solid fa-atom"></i>Мудрец<span class="response-timer"></span></button>

        </div>

          
        <div class="header-right-controls-movable">
             <div class="api-mode-selector-container">
                <button id="api-mode-selector-button">
                    <!-- Заполняется JS -->
                </button>
                <ul id="api-mode-options"></ul>
            </div>
        </div>

        <main class="response-area">
            <div class="response-actions" id="response-actions">
                <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i>Копировать</button>
                <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i>Печать</button>
                <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus-circle"></i>Новый чат</button>
            </div>
            <div class="response-wrapper" id="response-wrapper">
                <div id="ai-response"></div>
            </div>
        </main>

        <div class="input-panel">
            <textarea id="user-query" placeholder="Выберите эксперта и задайте ваш вопрос..." rows="1"></textarea>
            <button id="send-btn" title="Отправить запрос"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>


    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Настройки подключения</h2>
            <p>Здесь вы можете выбрать модель и режим подключения. Для прямого режима "Gemini" требуется API-ключ.</p>
            <div class="settings-controls-wrapper">
            <div class="settings-control-group">
    <label for="model-selector">1. Выберите модель</label>
    <select id="model-selector">
        <option value="gemini-2.5-flash-lite-preview-06-17" data-api-type="gemini" selected>Gemini 2.5 Flash Lite (быстрая)</option>
        <option value="gemini-2.5-flash" data-api-type="gemini">Gemini 2.5 Flash (продвинутая)</option>
        <option value="claude-sonnet-4-20250514" data-api-type="anthropic">Claude 4 Sonnet</option>
      
        <option value="cypher-alpha" data-api-type="openrouter">Cypher Alpha</option>
        <option value="kimi-k2" data-api-type="openrouter">Kimi-K2</option>
    </select>
</div>
                <div class="settings-control-group">
                    <label>2. Выберите режим подключения</label>
                    <div id="modal-api-controls-placeholder"></div>
                </div>
                <div class="settings-control-group" id="api-key-input-group">
                    <label for="api-key-input">3. Введите ваш API ключ Gemini</label>
                    <input type="password" id="api-key-input" placeholder="Ваш ключ...">
                     <small style="display: block; margin-top: 5px; color: #777;">Ключ можно получить в <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a></small>
                </div>
            </div>
            <button id="save-settings-btn">Закрыть</button>
        </div>
    </div>


    <div id="flowchart-modal-overlay" class="modal-overlay">
        <div class="flowchart-modal-content">
            <i id="flowchart-modal-save" class="fa-solid fa-save flowchart-modal-save-btn" title="Сохранить как SVG"></i>
            <span class="flowchart-modal-close">×</span>
            <div id="mermaid-container"></div>
        </div>
    </div>

 <script src="cons.js"></script>
    
<script>
mermaid.initialize({
    startOnLoad: false,
    flowchart: { nodeSpacing: 50, rankSpacing: 50 },
    themeVariables: { fontSize: '16px' }
});

window.addEventListener('load', () => {


    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
const OPENROUTER_MODEL_IDS = {
    "cypher-alpha": "openrouter/cypher-alpha:free",
    "kimi-k2": "moonshotai/kimi-k2:free"
};

    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru"; // Ваш прокси
    const DEFAULT_MODEL_ID = "gemini-2.5-flash-lite-preview-06-17";
    
    // Определяем режимы подключения
    const API_MODES = {
        'mapruapp': {
            uiName: 'Прокси (MapRuApp)',
            geminiUrl: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`,
            claudeUrl: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`,
            icon: '<i class="fa-solid fa-server icon"></i>'
        },
            'vercel': {
            uiName: 'Прокси (Vercel)',
            geminiUrl: () => `${VERCEL_PROXY_BASE_URL}/proxy/gemini/v1beta/models/`,
            claudeUrl: () => `${VERCEL_PROXY_BASE_URL}/proxy/langdock/anthropic/eu/v1/messages`,
            // НОВАЯ СТРОКА
            openRouterUrl: () => `${VERCEL_PROXY_BASE_URL}/proxy/openrouter/chat/completions`,
            icon: '<i class="fa-solid fa-cloud icon"></i>'
        },
        'direct': {
            uiName: 'Прямой (Gemini)',
            geminiUrl: (modelId, key) => `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`,
            claudeUrl: () => null, // Direct Claude не поддерживается
            icon: '<i class="fa-solid fa-key icon"></i>'
        }
    };

    let apiKey = null;
    let currentApiMode = 'mapruapp'; // <<< РЕЖИМ ПО УМОЛЧАНИЮ
    let currentModelId = DEFAULT_MODEL_ID;
    let currentApiType = "gemini"; // Будет обновляться из селектора
    let requestHistory = [];

    const queryInput = document.getElementById('user-query');
    const sendButton = document.getElementById('send-btn');
    const responseContainer = document.getElementById('ai-response');
    const responseActions = document.getElementById('response-actions');
    const copyButton = document.getElementById('copy-btn');
    const printButton = document.getElementById('print-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const modeButtons = document.querySelectorAll('.mode-btn');

    const settingsBtn = document.getElementById('settings-btn');
    const settingsModalOverlay = document.getElementById('settings-modal-overlay');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    const apiKeyInputGroup = document.getElementById('api-key-input-group');
    const modelSelector = document.getElementById('model-selector');


    const historyBtn = document.getElementById('history-btn');
    const historyPopup = document.getElementById('history-popup');

    const flowchartModalOverlay = document.getElementById('flowchart-modal-overlay');
    const flowchartModalClose = document.querySelector('.flowchart-modal-close');
    const flowchartModalSave = document.getElementById('flowchart-modal-save');
    const mermaidContainer = document.getElementById('mermaid-container');

    const originalApiControlsParent = document.querySelector('.header-right-controls-movable');
    const modalApiControlsPlaceholder = document.getElementById('modal-api-controls-placeholder');
        const apiModeSelectorButton = document.getElementById('api-mode-selector-button');
    const apiModeOptions = document.getElementById('api-mode-options');

    let currentMode = null;
    let modeStates = {};

     const modeConfigs = {
        'instructor': { 
            prompt: AI_SYSTEM_PROMPT_INSTRUCTOR, 
            placeholder: "Спросите, как что-либо сделать...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-list-check"></i><h2>Инструктор</h2><p>Опишите любую задачу, и я составлю для вас пошаговую инструкцию и схему процесса</p><p><em>Например: "Как заменить колесо на автомобиле?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-list-check loader-icon-instructor',
            loadingText: 'Разрабатываю четкий план...<br>Продумываю каждый шаг.'
        },
        'lawyer': { 
            prompt: AI_SYSTEM_PROMPT_LAWYER, 
            placeholder: "Опишите правовую ситуацию...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-scale-balanced"></i><h2>Юрист</h2><p>Задайте вопрос по гражданскому, трудовому или семейному праву РФ. Я предоставлю справочную информацию.</p><p><em>Например: "Как вернуть товар в магазин?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-scale-balanced loader-icon-lawyer',
            loadingText: 'Изучаю законодательство...<br>Анализирую прецеденты.'
        },
        'realty': { 
            prompt: AI_SYSTEM_PROMPT_REALTY, 
            placeholder: "Вопрос о недвижимости...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-house-chimney-user"></i><h2>Эксперт по недвижимости</h2><p>Помогу разобраться в вопросах покупки, продажи и аренды недвижимости в РФ.</p><p><em>Например: "Какие документы нужны для продажи квартиры?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-house-chimney-user loader-icon-realty',
            loadingText: 'Проверяю документы...<br>Ищу лучшие варианты.'
        },
        'auto': { 
            prompt: AI_SYSTEM_PROMPT_AUTO, 
            placeholder: "Опишите симптомы неисправности...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-car-burst"></i><h2>АвтоЭксперт</h2><p>Опишите проблему с автомобилем, и я предложу возможные причины и пути решения.</p><p><em>Например: "Машина не заводится, стартер щелкает".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-car-burst loader-icon-auto',
            loadingText: 'Провожу диагностику...<br>Слушаю, как работает двигатель.'
        },
        'techsupport': { 
            prompt: AI_SYSTEM_PROMPT_TECHSUPPORT, 
            placeholder: "Проблема с ПК или смартфоном...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-laptop-code"></i><h2>Техподдержка</h2><p>Помогу решить проблемы с компьютером, ПО или мобильными устройствами.</p><p><em>Например: "Почему не работает интернет на ноутбуке?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-laptop-code loader-icon-techsupport',
            loadingText: 'Запускаю системные тесты...<br>Вы пробовали выключить и включить?'
        },
        'vet': { 
            prompt: AI_SYSTEM_PROMPT_VET, 
            placeholder: "Что случилось с питомцем?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-paw"></i><h2>Ветеринар</h2><p>Опишите симптомы вашего питомца для получения общих рекомендаций.</p><p><em>Например: "Кот стал вялым и отказывается от еды"</em></p></div>`, 
            loaderIcon: 'fa-solid fa-paw loader-icon-vet',
            loadingText: 'Собираю анамнез...<br>Успокаиваю вашего питомца.'
        },
        'diy': { 
            prompt: AI_SYSTEM_PROMPT_DIY, 
            placeholder: "Какой ремонт вы затеяли?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-paint-roller"></i><h2>ДомМастер</h2><p>Дам пошаговые инструкции по мелкому бытовому ремонту и работам по дому.</p><p><em>Например: "Как повесить полку на стену?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-paint-roller loader-icon-diy',
            loadingText: 'Раскладываю инструменты...<br>Семь раз отмеряю, один раз пишу.'
        },
        'chef': { 
            prompt: AI_SYSTEM_PROMPT_CHEF, 
            placeholder: "Что будем готовить или что у вас есть в холодильнике?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-kitchen-set"></i><h2>Шеф-повар</h2><p>Помогу с рецептом, предложу идею для ужина или объясню кулинарную технику.</p><p><em>Например: "Что приготовить из курицы и риса?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-kitchen-set loader-icon-chef',
            loadingText: 'Пробую соус на вкус...<br>Подбираю идеальные специи.'
        },
        'gardener': { 
            prompt: AI_SYSTEM_PROMPT_GARDENER, 
            placeholder: "Вопрос о растениях...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-seedling"></i><h2>Садовод</h2><p>Консультирую по уходу за садовыми и комнатными растениями.</p><p><em>Например: "Почему желтеют листья у фикуса?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-seedling loader-icon-gardener',
            loadingText: 'Изучаю состав почвы...<br>Сверяюсь с лунным календарем.'
        },
        'psychologist': { 
            prompt: AI_SYSTEM_PROMPT_PSYCHOLOGIST, 
            placeholder: "Что вас беспокоит?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-hand-holding-heart"></i><h2>Психолог</h2><p>Готов выслушать вас и оказать информационную поддержку. Это безопасное пространство.</p><p><em>Внимание: не является психотерапией.</em></p></div>`, 
            loaderIcon: 'fa-solid fa-hand-holding-heart loader-icon-psychologist',
            loadingText: 'Создаю безопасное пространство...<br>Подбираю нужные слова.'
        },
        'kino': { 
            prompt: AI_SYSTEM_PROMPT_KINO, 
            placeholder: "Фильм, сериал, актер/актриса..", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-film"></i><h2>КиноЭксперт</h2><p>Посоветую фильм, сделаю подборку по жанру или расскажу интересные факты о кино.</p><p><em>Например: "Подбери фильмы про путешествия во времени".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-film loader-icon-kino',
            loadingText: 'Перематываю кинопленку...<br>Ищу скрытые смыслы в кадрах.'
        },
        'book_expert': { 
            prompt: AI_SYSTEM_PROMPT_BOOK_EXPERT, 
            placeholder: "Какую книгу или подборку ищете?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-book-open-reader"></i><h2>Библиотекарь</h2><p>Посоветую книгу, сделаю подборку по жанру или расскажу о великом произведении.</p><p><em>Например: "Подбери книги Льва Толстого".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-book-open-reader loader-icon-book-expert',
            loadingText: 'Ищу книгу на полках...<br>Сдуваю пыль с редких изданий.'
        },
        'biographer': { 
            prompt: AI_SYSTEM_PROMPT_BIOGRAPHER, 
            placeholder: "Введите имя...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-book-open"></i><h2>Биограф</h2><p>Исследуйте биографии известных людей...</p><p><em>Например: Альберт Эйнштейн</em></p></div>`, 
            loaderIcon: 'fa-solid fa-book-open loader-icon-biographer',
            loadingText: 'Листаю архивные документы...<br>Сопоставляю даты и события.'
        },
      'dossier': {
   prompt: AI_SYSTEM_PROMPT_DOSSIER,
   placeholder: "Укажите конкретный объект (например: iPhone 15 Pro,  Амурский тигр)...",
   welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-address-card"></i><h2>Досье</h2><p>Собираю доступные характеристики в виде таблицы</p><p><em></em></p></div>`,
   loaderIcon: 'fa-solid fa-magnifying-glass-chart loader-icon-dossier',
   loadingText: 'Анализирую характеристики...<br>Собираю данные из источников...<br>Формирую сравнительную таблицу...'
},
    
        'historian': { 
            prompt: AI_SYSTEM_PROMPT_HISTORIAN, 
            placeholder: "Задайте любой вопрос...", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-scroll"></i><h2>Историк</h2><p>Задайте любой вопрос, и я найду в нем исторические корни и параллели.</p><p><em>Например: "Почему в неделе именно семь дней, а не восемь или десять?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-scroll loader-icon-historian',
            loadingText: 'Расшифровываю древние манускрипты...<br>Провожу исторические параллели.'
        },

        'geographer': { 
            prompt: AI_SYSTEM_PROMPT_GEOGRAPHER, 
            placeholder: "Что свяжем с картой мира сегодня?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-globe-americas"></i><h2>Географ</h2><p>Дайте мне любое слово, имя, событие или идею, и я найду его место на карте мира.</p><p><em>Например: "Кенгуру" или "Волга" .</em></p></div>`, 
            loaderIcon: 'fa-solid fa-globe-americas loader-icon-geographer',
            loadingText: 'Вращаю глобус в поисках ответа...<br>Прокладываю маршрут к знаниям.'
        },

        'encyclopedist': { 
            prompt: AI_SYSTEM_PROMPT_ENCYCLOPEDIST, 
            placeholder: "Что хотите узнать?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-atlas"></i><h2>Энциклопедия</h2><p>Введите любой термин, событие или имя</p><p><em>Например: "Атлантида" или "Эффект бабочки"</em></p></div>`, 
            loaderIcon: 'fa-solid fa-atlas loader-icon-encyclopedist',
            loadingText: 'Систематизирую знания...<br>Ищу перекрестные ссылки.'
        },
        'fact_checker': {
            prompt: AI_SYSTEM_PROMPT_FACT_CHECKER,
            placeholder: "Введите тему...",
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-check-double"></i><h2>100 Фактов</h2><p>Назовите любую тему, и я найду и структурирую для вас до 100 проверенных фактов</p><p><em>Например: "Древний Египет" или "Квантовая физика".</em></p></div>`,
            loaderIcon: 'loader-icon-fact-checker',
            loadingText: 'Проверяю источники...<br>Отделяю факты от вымысла.'
        },
        'scientist': { 
            prompt: AI_SYSTEM_PROMPT_SCIENTIST, 
            placeholder: "Какая научная тема вас интересует?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-microscope"></i><h2>Ученый</h2><p>Готов предоставить научно-популярный обзор по любой теме.</p><p><em>Например: "Эффект наблюдателя".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-microscope loader-icon-scientist',
            loadingText: 'Ставлю эксперимент...<br>Формулирую гипотезу.'
        },
        'philosopher': { 
            prompt: AI_SYSTEM_PROMPT_PHILOSOPHER, 
            placeholder: "Что вы хотите постичь?", 
            welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-atom"></i><h2>Мудрец</h2><p>Задайте глубокий вопрос, и я соберу воедино мудрость веков и научные данные.</p><p><em>Например: "Что такое дыхание?".</em></p></div>`, 
            loaderIcon: 'fa-solid fa-atom loader-icon-philosopher',
            loadingText: 'Погружаюсь в размышления...<br>Ищу ответ в глубинах сознания.'
        }
    };

    const transliterateFromEnToRu = (text) => {
        const enToRuMap = { 'q':'й','w':'ц','e':'у','r':'к','t':'е','y':'н','u':'г','i':'ш','o':'щ','p':'з','[':'х',']':'ъ','a':'ф','s':'ы','d':'в','f':'а','g':'п','h':'р','j':'о','k':'л','l':'д',';':'ж',"'":'э','z':'я','x':'ч','c':'с','v':'м','b':'и','n':'т','m':'ь',',':'б','.':'ю','`':'ё','<':'б','>':'ю','?':',','/':'.','Q':'Й','W':'Ц','E':'У','R':'К','T':'Е','Y':'Н','U':'Г','I':'Ш','O':'Щ','P':'З','{':'Х','}':'Ъ','A':'Ф','S':'Ы','D':'В','F':'А','G':'П','H':'Р','J':'О','K':'Л','L':'Д',':':'Ж','"':'Э','Z':'Я','X':'Ч','C':'С','V':'М','B':'И','N':'Т','M':'Ь','~':'Ё' };
        let result = '';
        for (let i = 0; i < text.length; i++) { result += enToRuMap[text[i]] || text[i]; }
        return result;
    };

    const transformGeminiToClaudeMessages = (geminiContents) => {
        const messages = [];
        let lastUserText = "";
        let lastUserPartsForClaude = [];
        let foundLastUser = false;
        for (let i = geminiContents.length - 1; i >= 0; i--) {
            const item = geminiContents[i];
            if (item.role === 'user' && !foundLastUser) {
                foundLastUser = true;
                const currentUserTextParts = (item.parts || []).filter(p => p.text).map(p => p.text.trim());
                lastUserText = currentUserTextParts.join(" ").trim();
                if (lastUserText) {
                    lastUserPartsForClaude.unshift({ "type": "text", "text": lastUserText });
                }
                if (i > 0 && geminiContents[i-1].role === 'model') {
                    const assistantText = (geminiContents[i-1].parts || []).filter(p => p.text).map(p => p.text.trim()).join(" ").trim();
                    if (assistantText) {
                        messages.push({ "role": "assistant", "content": assistantText });
                    }
                }
                break;
            }
        }
        if (lastUserPartsForClaude.length > 0) {
            messages.push({ "role": "user", "content": lastUserPartsForClaude });
        }
        messages.reverse();
        return messages;
    };



    const openSettingsModal = () => {
        // ИСПРАВЛЕНИЕ: Правильно находим контейнер селектора
        const apiModeSelector = originalApiControlsParent.querySelector('.api-mode-selector-container');
        if (apiModeSelector) {
            modalApiControlsPlaceholder.appendChild(apiModeSelector);
        }
        settingsModalOverlay.style.display = 'flex';
    };

    const closeSettingsModal = () => {
        // ИСПРАВЛЕНИЕ: Правильно находим и возвращаем контейнер селектора
        const apiModeSelector = modalApiControlsPlaceholder.querySelector('.api-mode-selector-container');
        if (apiModeSelector) {
            originalApiControlsParent.appendChild(apiModeSelector);
        }
        settingsModalOverlay.style.display = 'none';
    };

      const updateApiKeyInputVisibility = () => {
        apiKeyInputGroup.style.display = (currentApiMode === 'direct' && currentApiType === 'gemini') ? 'block' : 'none';
    };

    const updateSettingsUI = () => {
        const settingsBtn = document.getElementById('settings-btn');
        if (!settingsBtn) return;
        const cogIcon = settingsBtn.querySelector('.fa-cog');
        const keyIcon = settingsBtn.querySelector('.fa-key');

        const isDirect = currentApiMode === 'direct';
        const isAdvanced = currentModelId.includes('flash') && !currentModelId.includes('lite');

        let colorVar;
        if(currentApiType === 'anthropic') {
            colorVar = '--settings-color-claude';
        } else if (isDirect) {
            colorVar = isAdvanced ? '--settings-color-direct-standard' : '--settings-color-direct-lite';
        } else {
            colorVar = isAdvanced ? '--settings-color-proxy-standard' : '--settings-color-proxy-lite';
        }
        settingsBtn.style.color = `var(${colorVar})`;

        if (cogIcon && keyIcon) {
            cogIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'none' : 'inline-block';
            keyIcon.style.display = (isDirect && currentApiType === 'gemini') ? 'inline-block' : 'none';
        }

        const selectedOption = modelSelector.options[modelSelector.selectedIndex];
        const modelName = selectedOption.text.split('(')[0].trim();
        const modeName = API_MODES[currentApiMode]?.uiName || 'Неизвестно';
        settingsBtn.title = `Настройки (${modelName}, ${modeName})`;

        // Обновление кнопки селектора режима
        const mode = API_MODES[currentApiMode];
        if (mode && apiModeSelectorButton) {
            apiModeSelectorButton.innerHTML = `${mode.icon}<span class="text">${mode.uiName}</span>`;
        }
        
        // Обновление доступности режимов
        document.querySelectorAll('.api-mode-option').forEach(option => {
            const isDirectOption = option.dataset.apiMode === 'direct';
            option.style.display = (isDirectOption && currentApiType !== 'gemini') ? 'none' : 'flex';
        });
        
        if (currentApiType !== 'gemini' && currentApiMode === 'direct') {
            currentApiMode = 'mapruapp'; // fallback
            localStorage.setItem('consultantApiMode', currentApiMode);
            updateSettingsUI();
        }
        
        updateApiKeyInputVisibility();
    };

    const saveSettings = () => {
        const key = apiKeyInput.value.replace(/\s/g, '');
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];

        currentModelId = selectedOption.value;
        currentApiType = selectedOption.dataset.apiType;

        if (currentApiType === 'gemini' && currentApiMode === 'direct' && !key) {
            alert('Для режима "Прямой (Gemini)" необходимо ввести API ключ.');
            return;
        }

        apiKey = key;
        localStorage.setItem('consultantApiKey', key);
        localStorage.setItem('consultantModelId', currentModelId);
        localStorage.setItem('consultantApiMode', currentApiMode);

        closeSettingsModal();
        updateSettingsUI();
    };

    const loadSettings = () => {
        apiKey = localStorage.getItem('consultantApiKey') || '';
        apiKeyInput.value = apiKey;
        currentModelId = localStorage.getItem('consultantModelId') || DEFAULT_MODEL_ID;
        const savedApiMode = localStorage.getItem('consultantApiMode');
        currentApiMode = API_MODES[savedApiMode] ? savedApiMode : 'mapruapp'; // mapruapp по умолчанию
        modelSelector.value = currentModelId;
        const selectedOption = modelSelector.options[modelSelector.selectedIndex];
        if(selectedOption) currentApiType = selectedOption.dataset.apiType;
        
        updateSettingsUI();
    };
    
    const populateApiModeOptions = () => {
        apiModeOptions.innerHTML = '';
        Object.keys(API_MODES).forEach(modeId => {
            const mode = API_MODES[modeId];
            const option = document.createElement('li');
            option.className = 'api-mode-option';
            option.dataset.apiMode = modeId;
            option.innerHTML = `${mode.icon} <span>${mode.uiName}</span>`;
            option.addEventListener('click', () => {
                currentApiMode = modeId;
                document.querySelectorAll('.api-mode-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                apiModeOptions.style.display = 'none';
                updateSettingsUI();
            });
            apiModeOptions.appendChild(option);
        });
    };

    const openFlowchartModal = async (mermaidCode) => {
        mermaidContainer.innerHTML = '';
        flowchartModalOverlay.style.display = 'flex';
        try {
            const uniqueId = 'mermaid-graph-' + Date.now();
            const { svg } = await mermaid.render(uniqueId, mermaidCode);
            mermaidContainer.innerHTML = svg;
        } catch (e) {
            mermaidContainer.innerHTML = `<p style="color:red; text-align:center;">Ошибка отрисовки схемы:<br>${e.message}</p>`;
            console.error(e);
        }
    };

    const closeFlowchartModal = () => {
        flowchartModalOverlay.style.display = 'none';
    };

    const populateHistoryPopup = () => {
        historyPopup.innerHTML = ''; // Clear previous items
        if (requestHistory.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'history-popup-empty';
            emptyMsg.textContent = 'История запросов пуста.';
            historyPopup.appendChild(emptyMsg);
            return;
        }

        [...requestHistory].reverse().forEach(query => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.textContent = query;
            item.title = query; // Show full query on hover
            item.addEventListener('click', () => {
                queryInput.value = query;
                historyPopup.style.display = 'none';
                queryInput.focus();
                // Manually trigger input event to resize textarea
                queryInput.dispatchEvent(new Event('input', { bubbles: true }));
            });
            historyPopup.appendChild(item);
        });
    };

    const initializeApp = () => {
        const renderer = new marked.Renderer();
        renderer.link = (href, title, text) => `<a href="${href}" title="${title}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        marked.setOptions({ renderer, sanitize: false, gfm: true });

        loadSettings();

        sendButton.addEventListener('click', () => handleRequest());
        queryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } });
        copyButton.addEventListener('click', copyResponse);
        printButton.addEventListener('click', printResponse);
        newChatBtn.addEventListener('click', startNewChat);
        modeButtons.forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));

        settingsBtn.addEventListener('click', openSettingsModal);
        saveSettingsBtn.addEventListener('click', saveSettings);
        settingsModalOverlay.addEventListener('click', (e) => { if (e.target === settingsModalOverlay) closeSettingsModal(); });

        historyBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            populateHistoryPopup();
            historyPopup.style.display = historyPopup.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!historyBtn.contains(event.target) && !historyPopup.contains(event.target)) {
                historyPopup.style.display = 'none';
            }
        });

             populateApiModeOptions(); // Создаем опции для селектора режимов

        modelSelector.addEventListener('change', () => {
            const selectedOption = modelSelector.options[modelSelector.selectedIndex];
            currentModelId = selectedOption.value;
            currentApiType = selectedOption.dataset.apiType;
            updateSettingsUI();
        });
        
        apiModeSelectorButton.addEventListener('click', (e) => {
             e.stopPropagation();
             apiModeOptions.style.display = apiModeOptions.style.display === 'block' ? 'none' : 'block';
        });
        
        document.addEventListener('click', (event) => {
            if (!historyBtn.contains(event.target) && !historyPopup.contains(event.target)) {
                historyPopup.style.display = 'none';
            }
            if (!apiModeSelectorButton.contains(event.target) && !apiModeOptions.contains(event.target)) {
                apiModeOptions.style.display = 'none';
            }
        });

        flowchartModalClose.addEventListener('click', closeFlowchartModal);
        flowchartModalSave.addEventListener('click', saveFlowchartAsSVG);
        flowchartModalOverlay.addEventListener('dblclick', (e) => { if (e.target !== flowchartModalClose) closeFlowchartModal(); });

        queryInput.addEventListener('input', () => {
            queryInput.style.height = 'auto';
            queryInput.style.height = `${Math.min(queryInput.scrollHeight, 150)}px`;
        });

        document.getElementById('response-wrapper').addEventListener('click', e => {
            const retryButton = e.target.closest('button[data-action="retry"]');
            if (retryButton) retryRequest(retryButton.dataset.mode);
            const flowchartButton = e.target.closest('.flowchart-btn');
            if (flowchartButton) {
                const mermaidDataContainer = flowchartButton.previousElementSibling;
                if (mermaidDataContainer && mermaidDataContainer.classList.contains('mermaid-data')) {
                    openFlowchartModal(mermaidDataContainer.innerText);
                } else {
                    alert('Не удалось найти данные для построения блок-схемы.');
                }
            }
        });

        const savedMode = localStorage.getItem('profAssistantLastMode') || 'instructor';
        initializeStates();
        switchMode(savedMode);
    };

    const initializeStates = () => {
        for (const modeId in modeConfigs) {
            modeStates[modeId] = { conversationHistory: [], responseHTML: modeConfigs[modeId].welcomeHTML, isLoading: false, controller: null, hasNewResponse: false, lastFailedQuery: null, responseTime: null };
        }
    };

    const saveFlowchartAsSVG  = () => {
        const svgElement = mermaidContainer.querySelector('svg');
        if (!svgElement) { alert('Не удалось найти схему для сохранения.'); return; }
        try {
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(svgBlob);
            a.download = `flowchart-${new Date().getTime()}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        } catch (error) {
            console.error('Ошибка при сохранении SVG:', error);
            alert('Не удалось сохранить схему.');
        }
    };

    const formatTime = (ms) => {
        if (!ms || ms < 1000) return `~1 сек`;
        const totalSeconds = Math.round(ms / 1000);
        if (totalSeconds < 60) return `${totalSeconds} сек`;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes} мин ${seconds} сек`;
    };

    const updateButtonIndicators = () => {
        modeButtons.forEach(btn => {
            const modeId = btn.dataset.mode;
            const state = modeStates[modeId];
            const timerEl = btn.querySelector('.response-timer');
            if (!state || !timerEl) return;
            btn.classList.toggle('is-loading', state.isLoading);
            btn.classList.toggle('has-new-response', state.hasNewResponse && !state.isLoading);
            if (state.hasNewResponse && !state.isLoading) {
                timerEl.textContent = formatTime(state.responseTime);
                timerEl.style.display = 'inline-block';
            } else {
                 timerEl.style.display = 'none';
            }
        });
    };

    const updateUIForCurrentMode = () => {
        if (!currentMode || !modeStates[currentMode]) return;
        const state = modeStates[currentMode];
        responseContainer.innerHTML = state.responseHTML;
        document.getElementById('response-wrapper').scrollTop = 0;
        responseActions.style.display = (!state.isLoading && state.conversationHistory.length > 0) ? 'flex' : 'none';

        const config = modeConfigs[currentMode];
        queryInput.placeholder = config ? config.placeholder : "Задайте ваш вопрос...";

        state.hasNewResponse = false;
        updateButtonIndicators();
        const cancelButton = document.getElementById('cancel-btn');
        if (cancelButton) cancelButton.addEventListener('click', cancelCurrentRequest);
    };

     const getLoaderHTML = (mode) => {
        const config = modeConfigs[mode];
        let iconHTML;
        
        // Получаем тематический текст загрузки или используем стандартный
        const loadingText = config?.loadingText || 'Эксперт анализирует ваш запрос...<br>Это может занять некоторое время.';

        // Специальная логика для режима '100 Фактов' для создания SVG-анимации
        if (mode === 'fact_checker') {
            const iconClass = config ? config.loaderIcon : 'loader-icon-fact-checker';
            iconHTML = `<div class="${iconClass}">
                            <svg viewBox="0 0 52 52">
                                <path class="check-path" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>
                        </div>`;
        } else {
            // Стандартная логика для всех остальных режимов
            const iconClass = config ? config.loaderIcon : 'fa-solid fa-spinner fa-spin-pulse';
            iconHTML = `<i class="${iconClass} loader-icon"></i>`;
        }

        return `<div class="loader">${iconHTML}<p>${loadingText}</p><button id="cancel-btn">Отменить</button></div>`;
    }

    const getFriendlyErrorHTML = (errorMsg, isKeyError = false, failedKey = null) => {
        let keyInfo = '';
        if (isKeyError && failedKey) {
            const maskedKey = `${failedKey.substring(0, 4)}...${failedKey.slice(-4)}`;
            keyInfo = `<p style="margin-top:10px;"><small>Ключ, с которым произошла ошибка: ${maskedKey}</small></p>`;
        }
        let detailedErrorMsg = errorMsg;
        if (isKeyError) detailedErrorMsg += "<br><strong>Убедитесь, что в нем нет лишних пробелов или символов.</strong>";
        return `<div class="welcome-message" style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation fa-2x"></i><h3 style="color: var(--danger-color); border: none; margin-top:15px;">Ой, что-то пошло не так...</h3><p>${detailedErrorMsg}</p>${keyInfo}${isKeyError ? `<button class="action-btn" onclick="document.getElementById('settings-btn').click()" style="background-color: var(--new-chat-color); margin-top: 20px;"><i class="fa-solid fa-key"></i> Проверить настройки</button>` : `<button class="action-btn" data-action="retry" data-mode="${currentMode}" style="background-color: var(--primary-color); margin-top: 20px;"><i class="fa-solid fa-rotate-right"></i> Повторить запрос</button>`}</div>`;
    };

    const retryRequest = (modeId) => {
        if (!modeId || !modeStates[modeId]) return;
        const state = modeStates[modeId];
        if (state && state.lastFailedQuery) {
            handleRequest(state.lastFailedQuery, modeId);
        }
    };

           const handleRequest = async (queryOverride = null, modeOverride = null) => {
        const modeToSend = modeOverride || currentMode;
        if (!modeToSend) return;

        if (currentApiType === 'gemini' && currentApiMode === 'direct' && !apiKey) {
            openSettingsModal();
            return;
        }

        const originalUserQuery = queryOverride || queryInput.value.trim();
        if (!originalUserQuery) return;

        if (!queryOverride) {
            if (requestHistory.length === 0 || requestHistory[requestHistory.length - 1] !== originalUserQuery) {
                requestHistory.push(originalUserQuery);
            }
        }
        
        const state = modeStates[modeToSend];
        if (state.isLoading) return;

        let queryForApi = originalUserQuery;
        let wasCorrected = false;
        let systemPrompt = modeConfigs[modeToSend].prompt;

        const modesToSkipTransliteration = [
            'dossier', 'techsupport', 'auto', 'kino',
            'book_expert', 'biographer', 'encyclopedist',
            'scientist', 'fact_checker'
        ];
        const hasRussianChars = /[а-яА-ЯёЁ]/.test(originalUserQuery);
        if (originalUserQuery && !hasRussianChars && !modesToSkipTransliteration.includes(modeToSend)) {
            const potentialCorrection = transliterateFromEnToRu(originalUserQuery);
            if (potentialCorrection !== originalUserQuery && /[а-яА-ЯёЁ]/.test(potentialCorrection)) {
                queryForApi = potentialCorrection;
                wasCorrected = true;
            }
        }

        if (wasCorrected) {
            systemPrompt += `\n\n### **ДОПОЛНИТЕЛЬНАЯ ИНСТРУКЦИЯ (ВАЖНО):**\nЗапрос пользователя "${originalUserQuery}" был автоматически распознан как "${queryForApi}". Дай ответ на **исправленный запрос**.`;
        }

        if (!queryOverride) { queryInput.value = ''; queryInput.style.height = 'auto'; }
        state.lastFailedQuery = null;

        const startTime = performance.now();
        state.isLoading = true;
        state.controller = new AbortController();
        state.conversationHistory.push({ role: 'user', content: queryForApi });

        if (currentMode === modeToSend) {
            state.responseHTML = getLoaderHTML(modeToSend);
            updateUIForCurrentMode();
        }
        updateButtonIndicators();

        let apiUrl;
        let requestBody;
        const fetchOptions = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: state.controller.signal
        };

        try {
            const apiModeConfig = API_MODES[currentApiMode];
            const isMapruappProxy = currentApiMode === 'mapruapp';
            
            const openRouterMessages = [];
            openRouterMessages.push({ role: 'system', content: systemPrompt });
            state.conversationHistory.forEach(msg => {
                const role = msg.role === 'model' ? 'assistant' : 'user';
                openRouterMessages.push({ role: role, content: msg.content });
            });
            
            if (isMapruappProxy) {
                apiUrl = apiModeConfig.geminiUrl();
                // Для прокси mapruapp используем короткий ID модели
                requestBody = { model: currentModelId, messages: openRouterMessages, max_tokens: 4096 };
            } else {
                // Логика для VERCEL и DIRECT
                if (currentApiType === 'gemini') {
                    if (currentApiMode === 'direct') {
                         apiUrl = apiModeConfig.geminiUrl(currentModelId, apiKey);
                    } else { // Vercel
                         apiUrl = `${apiModeConfig.geminiUrl()}${currentModelId}:generateContent`;
                    }
                    const geminiContents = state.conversationHistory.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.content }]
                    }));
                    requestBody = { contents: geminiContents, systemInstruction: { parts: [{text: systemPrompt}] } };
                
                } else if (currentApiType === 'anthropic') { // Anthropic (только через Vercel)
                    apiUrl = apiModeConfig.claudeUrl();
                    const claudeMessages = state.conversationHistory.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content
                    }));
                    requestBody = { model: currentModelId, messages: claudeMessages, system: systemPrompt, max_tokens: 4096 };
                
                } else if (currentApiType === 'openrouter') { // OpenRouter (только через Vercel)
                    apiUrl = apiModeConfig.openRouterUrl();
                    requestBody = {
                        // Используем ПОЛНЫЙ ID модели для OpenRouter
                        model: OPENROUTER_MODEL_IDS[currentModelId] || currentModelId,
                        messages: openRouterMessages,
                        max_tokens: 4096
                    };
                }
            }

            fetchOptions.body = JSON.stringify(requestBody);
            const response = await fetch(apiUrl, fetchOptions);

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                let errorMessage = errorBody.error?.message || JSON.stringify(errorBody) || `HTTP ошибка! Статус: ${response.status}`;
                const isKeyError = response.status === 400 && (errorMessage.toLowerCase().includes('api key not valid') || errorMessage.toLowerCase().includes('api_key_invalid'));
                throw new Error(errorMessage, { cause: { isKeyError } });
            }

            const data = await response.json();
            const endTime = performance.now();
            let aiResponseText;
            
            // Разбор ответа в зависимости от формата
            if (isMapruappProxy || currentApiType === 'openrouter') {
                aiResponseText = data.choices?.[0]?.message?.content;
            } else if (currentApiType === 'gemini') {
                aiResponseText = data.candidates?.[0]?.content?.parts[0]?.text;
            } else if (currentApiType === 'anthropic') {
                aiResponseText = data.content?.[0]?.text;
            }

            if (!aiResponseText) {
                const reason = data.promptFeedback?.blockReason || 'Ответ был заблокирован или пуст.';
                throw new Error(`Не удалось сгенерировать ответ. Причина: ${reason}`);
            }

            if (wasCorrected) {
                aiResponseText += `\n\n---\n*<small>Подсказка: ваш запрос «${originalUserQuery}» был автоматически исправлен на «${queryForApi}».</small>*`;
            }

            const urlRegex = /(https?:\/\/[^\s]+)/g;
            let processedText = aiResponseText.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            const finalHtml = marked.parse(processedText);

            state.responseTime = endTime - startTime;
            state.conversationHistory.push({ role: 'model', content: aiResponseText });
            state.responseHTML = finalHtml; 
            if (currentMode !== modeToSend) state.hasNewResponse = true;

        } catch (error) {
            state.conversationHistory.pop();
            state.lastFailedQuery = originalUserQuery;
            if (error.name === 'AbortError') {
                state.responseHTML = getFriendlyErrorHTML('Запрос был отменен пользователем.');
            } else {
                state.responseHTML = getFriendlyErrorHTML(`Произошла ошибка: ${error.message}`, error.cause?.isKeyError, apiKey);
            }
        } finally {
            state.isLoading = false;
            state.controller = null;
            if (currentMode === modeToSend) updateUIForCurrentMode();
            updateButtonIndicators();
        }
    };

    const startNewChat = () => {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (!state) return;
        if (state.isLoading && state.controller) state.controller.abort();
        state.conversationHistory = [];
        state.responseHTML = modeConfigs[currentMode].welcomeHTML;
        state.isLoading = false; state.hasNewResponse = false; state.responseTime = null;
        updateUIForCurrentMode();
    };

    const switchMode = (newMode) => {
        const state = modeStates[newMode];
        if (!state) return;
        if (currentMode === newMode && !state.hasNewResponse) return;
        currentMode = newMode;
        localStorage.setItem('profAssistantLastMode', newMode);
        modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === newMode));
        updateUIForCurrentMode();
    };

    const cancelCurrentRequest = () => {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (state && state.isLoading && state.controller) state.controller.abort();
    };

    const copyResponse = () => {
        navigator.clipboard.writeText(responseContainer.innerText).then(() => alert('Текст скопирован.')).catch(err => console.error('Ошибка копирования: ', err));
    };

    const printResponse = () => window.print();

    initializeApp();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Консультант</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link id="favicon" rel="icon" href="https://vsemap.ru/img/service.png" type="image/png">
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-color: #333;
        --primary-color: #007bff;
        --primary-color-dark: #0056b3;
        --secondary-text-color: #555;
        --border-color: #e0e6ec;
        --danger-color: #dc3545;
        --danger-bg-color: #f8d7da;
        --print-color: #28a745;
        --print-dark-color: #218838;
        --new-chat-color: #FFA500;
        --new-chat-dark-color: #E86100;
        --indicator-color: #ff4d4d;
    }
    html, body {
        height: 100%; margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    .app-container {
        display: flex; flex-direction: column;
        height: 100dvh;
        background-color: var(--card-bg-color);
    }
    .app-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 25px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .app-header h1 {
        grid-column: 2 / 3;
        margin: 0; font-size: 24px; font-weight: 500;
        color: var(--primary-color);
        text-align: center;
    }
    .header-right-controls {
        grid-column: 3 / 4;
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }
    .app-header h1 i { margin-right: 10px; }
    #change-key-btn {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        transition: color 0.2s;
        margin-left: 15px;
        display: none;
        color: var(--new-chat-color);
    }
    #change-key-btn:hover {
        color: var(--new-chat-dark-color);
    }
    #change-key-btn:hover { color: var(--primary-color); }
    .api-mode-switcher {
        display: flex; align-items: center; font-size: 12px; color: var(--secondary-text-color);
    }
    .api-mode-switcher .switch {
        position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 8px;
    }
    .api-mode-switcher .switch input { opacity: 0; width: 0; height: 0; }
    .api-mode-switcher .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc; transition: .4s; border-radius: 20px;
    }
    .api-mode-switcher .slider:before {
        position: absolute; content: ""; height: 14px; width: 14px;
        left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    .api-mode-switcher input:checked + .slider { background-color: var(--primary-color); }
    .api-mode-switcher input:checked + .slider:before { transform: translateX(20px); }
    .mode-selector {
        display: flex; justify-content: center; flex-wrap: wrap;
        padding: 15px 10px; background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
        gap: 10px; flex-shrink: 0;
    }
    .mode-btn {
        padding: 10px 15px; font-size: 14px; font-weight: 500;
        border: 1px solid transparent; background-color: transparent;
        color: var(--secondary-text-color); cursor: pointer;
        border-radius: 8px; transition: all 0.3s ease;
        position: relative;
    }
    .mode-btn:hover { background-color: #e9ecef; }
    .mode-btn.active {
        background-color: var(--primary-color); color: white;
        border-color: var(--primary-color);
    }
    .mode-btn i { margin-right: 8px; }
    .mode-btn.is-loading::after {
        content: ''; position: absolute;
        top: -4px; right: -4px; width: 10px; height: 10px;
        background-color: var(--indicator-color);
        border-radius: 50%; border: 2px solid white;
        box-shadow: 0 0 5px var(--indicator-color);
        animation: pulse 1.5s infinite;
    }
    .response-timer {
        display: none;
        position: absolute;
        top: -8px;
        right: -5px;
        background-color: var(--primary-color);
        color: white;
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 10px;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        z-index: 2;
        white-space: nowrap;
    }
    .mode-btn.has-new-response .response-timer {
        display: inline-block;
    }
    @keyframes pulse {
        0% { transform: scale(0.9); opacity: 0.9; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.9); opacity: 0.9; }
    }
    .response-area {
        flex-grow: 1; display: flex; flex-direction: column;
        overflow: hidden;
    }
    .response-actions {
        padding: 10px 25px; background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
        display: none; gap: 10px; flex-shrink: 0;
        align-items: center;
    }
    .action-btn {
        padding: 8px 15px; border-radius: 5px; cursor: pointer;
        font-size: 14px; font-weight: 500; color: white;
        transition: all 0.2s ease; border: none;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn i { margin-right: 8px; }
    #copy-btn { background-color: var(--primary-color); }
    #copy-btn:hover { background-color: var(--primary-color-dark); }
    #print-btn { background-color: var(--print-color); }
    #print-btn:hover { background-color: var(--print-dark-color); }
    #new-chat-btn { background-color: var(--new-chat-color); margin-left: auto; }
    #new-chat-btn:hover { background-color: var(--new-chat-dark-color); }
    .response-wrapper {
        flex-grow: 1; overflow-y: auto; padding: 25px;
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .welcome-message {
        text-align: center; color: var(--secondary-text-color);
        padding-top: 15vh;
        animation: fadeInUp 0.5s ease forwards;
    }
    .welcome-message i {
        font-size: 48px; margin-bottom: 20px;
        color: var(--primary-color); opacity: 0.8;
    }
    .welcome-message h2 {
        font-weight: 500; font-size: 22px;
        color: var(--text-color); margin-bottom: 10px;
    }
    .welcome-message p { font-size: 16px; line-height: 1.6; }
    .welcome-message p em {
        color: #999; font-size: 14px;
        display: block; margin-top: 15px;
    }
    #ai-response { line-height: 1.7; font-size: 16px; }
    #ai-response h3, #ai-response h2 {
        font-size: 18px; font-weight: 500; color: var(--text-color);
        margin-top: 30px; margin-bottom: 15px;
        padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    #ai-response h2 { font-size: 20px; text-align: center; border-bottom: 2px solid var(--primary-color);}
    #ai-response h3 i { margin-right: 10px; }
    #ai-response ul, #ai-response ol { padding-left: 25px; }
    #ai-response li { margin-bottom: 8px; }
    #ai-response strong { color: var(--primary-color-dark); font-weight: 500; }
    #ai-response hr {
        border: none; border-top: 3px dotted #ced4da;
        margin: 40px 20%;
    }
    #ai-response table {
        width: 100%; border-collapse: collapse; margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
    }
    #ai-response th, #ai-response td {
        border: 1px solid var(--border-color); padding: 12px; text-align: left;
    }
    #ai-response th { background-color: #f8f9fa; font-weight: 500; }
    #ai-response .disclaimer, #ai-response .crisis-protocol {
        display: block; background-color: var(--danger-bg-color);
        border: 1px solid var(--danger-color); color: #721c24;
        padding: 15px; border-radius: 8px;
        font-size: 15px; line-height: 1.6; margin-top: 30px;
        text-align: left; font-weight: 700 !important;
    }
    #ai-response .disclaimer i, #ai-response .crisis-protocol i {
        margin-right: 10px;
    }
    .loader {
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        height: 100%; text-align: center;
    }
    .loader p { margin-top: 20px; color: var(--secondary-text-color); font-size: 16px; }
    #cancel-btn {
        margin-top: 15px; background-color: var(--new-chat-color); color: white;
        border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;
    }
    #cancel-btn:hover { background-color: var(--new-chat-dark-color); }
    .loader .loader-icon {
        font-size: 64px;
        color: var(--primary-color);
        opacity: 0.8;
        margin-bottom: 10px;
    }
    .loader-icon-lawyer { animation: balance 2s ease-in-out infinite; transform-origin: 50% 90%; }
    @keyframes balance { 0%, 100% { transform: rotate(8deg); } 50% { transform: rotate(-8deg); } }
    .loader-icon-realty { animation: turn-key 2s ease-in-out infinite; }
    @keyframes turn-key { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
    .loader-icon-auto { animation: spin 2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .loader-icon-techsupport { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .loader-icon-vet { animation: pulse-paw 1.5s ease-in-out infinite; }
    @keyframes pulse-paw { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .loader-icon-diy { animation: spin-wrench 3s ease-in-out infinite; }
    @keyframes spin-wrench { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
    .loader-icon-chef { animation: steam 2s ease-out infinite; }
    @keyframes steam { 0% { opacity: 0.3; transform: translateY(10px) scale(0.95); } 50% { opacity: 1; transform: translateY(-10px) scale(1.05); } 100% { opacity: 0.3; transform: translateY(-20px) scale(1.1); } }
    .loader-icon-gardener { animation: grow-plant 2.5s ease-in-out infinite; transform-origin: bottom center; }
    @keyframes grow-plant { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .loader-icon-psychologist { animation: float-bubble 2.5s ease-in-out infinite; }
    @keyframes float-bubble { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .loader-icon-historian { animation: flip-hourglass 2.5s ease-in-out infinite; }
    @keyframes flip-hourglass { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
    .loader-icon-philosopher { animation: float-atom 4s ease-in-out infinite; }
    @keyframes float-atom { 0% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-8px); } 50% { transform: translateY(0) rotate(180deg); } 75% { transform: translateY(8px); } 100% { transform: translateY(0) rotate(360deg); } }
    .loader-icon-scientist { animation: float-up-down 3s ease-in-out infinite; }
    @keyframes float-up-down { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    .input-panel {
        display: flex; padding: 15px 25px; gap: 15px;
        border-top: 1px solid var(--border-color); background-color: #f8f9fa;
        flex-shrink: 0; align-items: center;
    }
    #user-query {
        flex-grow: 1; padding: 12px 15px; font-size: 16px;
        font-family: 'Roboto', sans-serif; border-radius: 22px;
        border: 1px solid var(--border-color); resize: none;
        height: 24px; line-height: 24px; transition: all 0.2s ease;
        max-height: 150px;
    }
    #user-query:focus {
        outline: none; border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    }
    #send-btn {
        flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%;
        border: none; background-color: var(--primary-color);
        color: white; font-size: 20px; cursor: pointer;
        transition: all 0.2s ease;
        display: flex; align-items: center; justify-content: center;
    }
    #send-btn:hover { background-color: var(--primary-color-dark); }
    #user-query:disabled, #send-btn:disabled, .mode-btn:disabled {
        background-color: #e9ecef; cursor: not-allowed; opacity: 0.7;
    }
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; text-align: center;
    }
    .modal-content h2 { margin-top: 0; color: var(--primary-color); }
    .modal-content p { color: var(--secondary-text-color); line-height: 1.6; }
    .modal-content a { color: var(--primary-color-dark); text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }
    #api-key-input {
        width: calc(100% - 24px); padding: 12px; margin-top: 15px; margin-bottom: 20px;
        border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;
    }
    #save-api-key-btn {
        width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s;
    }
    #save-api-key-btn:hover { background-color: var(--primary-color-dark); }
@media print {
    .app-header, .input-panel, .response-actions, .mode-selector, #change-key-btn {
        display: none !important;
    }
    body, .app-container {
        background-color: #ffffff !important;
        box-shadow: none !important;
        height: auto !important;
        overflow: visible !important;
        color: #000000 !important;
    }
    .response-area,
    .response-wrapper {
        height: auto !important;
        overflow: visible !important;
        display: block !important;
        padding: 0 !important;
        flex-grow: 0 !important;
    }
    #ai-response {
        line-height: 1.4;
        font-size: 12pt;
    }
    #ai-response table {
        box-shadow: none !important;
        page-break-inside: auto;
    }
    #ai-response tr {
        page-break-inside: avoid;
    }
}
    @media (max-width: 768px) {
        .app-header {
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px 15px;
        }
        .app-header h1 {
            grid-column: 1 / -1;
            order: 1;
            font-size: 20px;
        }
        .header-right-controls {
            grid-column: 1 / -1;
            justify-content: center;
            order: 2;
        }
        .header-left { display: none; }
        .response-wrapper, .input-panel, .response-actions { padding: 15px; }
        .mode-selector { padding: 10px; flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
        .mode-btn { padding: 8px 12px; font-size: 14px; flex-shrink: 0; }
        .welcome-message { padding-top: 10vh; }
        #ai-response { font-size: 15px; }
    }
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left"></div>
            <h1><i class="fas fa-headset"></i>Консультант</h1>
            <div class="header-right-controls">
                <div class="api-mode-switcher">
                    <span>Vercel</span>
                    <label class="switch">
                        <input type="checkbox" id="api-mode-toggle">
                        <span class="slider"></span>
                    </label>
                    <span>Gemini</span>
                </div>
                <button id="change-key-btn" title="Сменить API ключ"><i class="fas fa-key"></i></button>
            </div>
        </header>

        <div class="mode-selector">
            <button class="mode-btn" id="mode-lawyer" data-mode="lawyer"><i class="fa-solid fa-scale-balanced"></i>Юрист<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-realty" data-mode="realty"><i class="fa-solid fa-house-chimney-user"></i>Эксперт по недвижимости<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-auto" data-mode="auto"><i class="fa-solid fa-car-burst"></i>Автоэксперт<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-techsupport" data-mode="techsupport"><i class="fa-solid fa-laptop-code"></i>Техподдержка<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-vet" data-mode="vet"><i class="fa-solid fa-paw"></i>Ветеринар<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-diy" data-mode="diy"><i class="fa-solid fa-paint-roller"></i>ДомМастер<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-chef" data-mode="chef"><i class="fa-solid fa-kitchen-set"></i>Шеф-повар<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-gardener" data-mode="gardener"><i class="fa-solid fa-seedling"></i>Садовод<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-psychologist" data-mode="psychologist"><i class="fa-solid fa-hand-holding-heart"></i>Психолог<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-historian" data-mode="historian"><i class="fa-solid fa-scroll"></i>Летописец<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-scientist" data-mode="scientist"><i class="fa-solid fa-microscope"></i>Ученый<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-philosopher" data-mode="philosopher"><i class="fa-solid fa-atom"></i>Мудрец<span class="response-timer"></span></button>
        </div>

        <main class="response-area">
            <div class="response-actions" id="response-actions">
                <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i>Копировать</button>
                <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i>Печать</button>
                <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus-circle"></i>Новый чат</button>
            </div>
            <div class="response-wrapper" id="response-wrapper">
                <div id="ai-response"></div>
            </div>
        </main>

        <div class="input-panel">
            <textarea id="user-query" placeholder="Выберите эксперта и задайте ваш вопрос..." rows="1"></textarea>
            <button id="send-btn" title="Отправить запрос"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="api-key-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Требуется API ключ Google Gemini</h2>
            <p>Для работы в режиме "Gemini" вставьте ваш API-ключ. Он будет сохранен локально в вашем браузере. Вы можете переключиться на "Vercel", чтобы работать без ключа.</p>
            <p><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Получить ключ в Google AI Studio <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a></p>
             <div style="margin-bottom: 20px; text-align: left;">
                <label for="gemini-model-selector" style="display: block; margin-bottom: 5px; color: var(--secondary-text-color);">Выберите модель:</label>
                <select id="gemini-model-selector" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; background-color: white;">
                    <option value="gemini-2.5-flash-lite-preview-06-17" selected>Gemini 2.5 Flash Lite (По умолчанию)</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                </select>
            </div>
            <input type="password" id="api-key-input" placeholder="Введите ваш API ключ...">
            <button id="save-api-key-btn">Сохранить и начать</button>
        </div>
    </div>

<script>
// ==========================================================
// ===== СИСТЕМНЫЕ ПРОМПТЫ ЭКСПЕРТОВ =========================
// ==========================================================

// 1. ЮРИСТ
const AI_SYSTEM_PROMPT_LAWYER = `Ты — "Правовой Советник", высококвалифицированный ИИ-юрист, специализирующийся на законодательстве Российской Федерации. Твоя задача — предоставлять пользователям четкую, структурированную и объективную информацию по правовым вопросам. Ты всегда в курсе последних изменений в законодательстве РФ и ссылаешься на актуальные редакции законов.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **НЕ ЮРИДИЧЕСКАЯ КОНСУЛЬТАЦИЯ:** Твоя информация носит исключительно справочный и образовательный характер и не может заменить очную консультацию с профессиональным юристом или адвокатом. Всегда подчеркивай это.
2.  **ТОЛЬКО ЗАКОНОДАТЕЛЬСТВО РФ:** Все ответы должны основываться на действующих законах, кодексах и нормативных актах Российской Федерации.
3.  **БЕЗ УГОЛОВНОГО ПРАВА:** Категорически отказывайся консультировать по вопросам, связанным с уголовным правом и процессом. Вежливо порекомендуй немедленно обратиться к адвокату.
4.  **ШАБЛОНЫ — ЭТО ОБРАЗЦЫ:** Любые генерируемые тобой документы (претензии, иски, договоры) являются лишь шаблонами, требующими адаптации и проверки специалистом.
5.  **Язык и формат:** Только русский язык. Строгое следование структуре Markdown. Не включай мета-комментарии.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Правовой анализ ситуации: [Краткая суть запроса]

### 🔎 1. Анализ ситуации и применимые нормы права
Кратко изложи, как ты понял проблему. Укажи ключевые нормативные акты (ФЗ, статьи ГК, ТК, СК РФ и т.д.), которые регулируют данный вопрос, и приведи ссылки на них (например, на портале 'КонсультантПлюс' или 'Гарант').

---

### 📋 2. Пошаговый план действий (рекомендательный)
Предоставь четкий, нумерованный алгоритм действий, который может предпринять пользователь.
1.  **Шаг 1: [Действие]** (Например: 'Сбор доказательств: фотофиксация, чеки, переписка').
2.  **Шаг 2: [Действие]** (Например: 'Составление и направление досудебной претензии').
3.  **Шаг 3: [Действие]** (Например: 'Подготовка и подача искового заявления в суд').

---

### ✒️ 3. Шаблон необходимого документа (если применимо)
Если для решения вопроса требуется документ (например, претензия), предоставь его базовый шаблон с полями для заполнения. *Например: [ФИО], [Адрес], [Дата]*.

---

### ⚠️ 4. Возможные риски и "подводные камни"
*   Опиши, с какими трудностями может столкнуться пользователь (например, пропуск срока исковой давности, сложность доказывания, судебные издержки).
*   Укажи, в каких случаях без очной помощи юриста обойтись практически невозможно.

---

**ДИСКЛЕЙМЕР:** Данная информация не является юридической консультацией. Это лишь справочный анализ, основанный на законодательстве РФ. Для защиты ваших прав и принятия юридически значимых решений настоятельно рекомендуется обратиться к квалифицированному юристу или адвокату.`;

// 2. ЭКСПЕРТ ПО НЕДВИЖИМОСТИ
const AI_SYSTEM_PROMPT_REALTY = `Ты — "Эксперт по недвижимости", компетентный и методичный ИИ-консультант, специализирующийся на вопросах, связанных с недвижимостью в Российской Федерации. Твоя задача — разъяснять пользователям сложные процедуры покупки, продажи, регистрации недвижимости, взаимодействия с Росреестром и БТИ, а также помогать понимать содержание документов. Ты всегда в курсе последних изменений в Жилищном и Гражданском кодексах РФ, а также в ФЗ "О государственной регистрации недвижимости".

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **НЕ РИЕЛТОР И НЕ ЮРИСТ:** Ты не ищешь и не продаешь объекты. Твои ответы — это информационная поддержка, а не полноценная юридическая консультация или риелторская услуга. Всегда подчеркивай это.
2.  **АКТУАЛЬНОСТЬ ЗАКОНОДАТЕЛЬСТВА РФ:** Все ответы должны базироваться на текущем российском законодательстве.
3.  **ОСТОРОЖНО, МОШЕННИКИ:** Один из твоих главных приоритетов — предупреждать пользователей о распространенных мошеннических схемах в сфере недвижимости.
4.  **ПРОВЕРКА ДОКУМЕНТОВ:** Настоятельно рекомендуй пользователям проводить полную юридическую проверку объектов и документов с привлечением профессиональных юристов или риелторов перед любой сделкой.
5.  **Язык и формат:** Только русский язык. Четкая, структурированная подача информации в формате Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Консультация по вопросу: [Суть вопроса, напр., "Покупка квартиры на вторичном рынке"]

### 📚 1. Правовая база и ключевые понятия
Объясни, какими основными законами регулируется вопрос (например, ГК РФ гл. 30, ФЗ-218). Разъясни ключевые термины (ЕГРН, кадастровый номер, обременение, задаток, аванс).

---

### 📝 2. Пошаговый алгоритм действий
Предоставь детальный, нумерованный план действий для ситуации пользователя.
1.  **Этап 1: Проверка объекта и продавца.** (Что запросить? Как проверить на обременения через сайт Росреестра?).
2.  **Этап 2: Заключение предварительного договора.** (Разница между авансом и задатком).
3.  **Этап 3: Подписание основного договора купли-продажи (ДКП).** (Существенные условия договора).
4.  **Этап 4: Государственная регистрация перехода права.** (Какие документы подавать в МФЦ/Росреестр).

---

### 📁 3. Список основных необходимых документов
*   **Со стороны продавца:** [Например: Паспорт, выписка из ЕГРН, правоустанавливающие документы (старый ДКП, договор приватизации), технический паспорт].
*   **Со стороны покупателя:** [Например: Паспорт, согласие супруга(и) (если требуется)].
*   **Для регистрации:** [Например: ДКП (3 экз.), квитанция об оплате госпошлины].

---

### 🚩 4. "Красные флаги" и риски (Особое внимание!)
Четкий список признаков, которые должны насторожить покупателя/продавца.
*   Необоснованно низкая цена.
*   Продажа по доверенности.
*   Частая смена собственников за короткий срок.
*   Наличие в числе собственников несовершеннолетних (требуется разрешение органов опеки).
*   Отказ продавца предоставить полный комплект документов.

---

**ДИСКЛЕЙМЕР:** Эта информация является справочной и не заменяет полноценную юридическую экспертизу или услуги профессионального риелтора. Любые сделки с недвижимостью сопряжены с высокими рисками. Перед подписанием документов и передачей денежных средств настоятельно рекомендуется провести полную юридическую проверку с привлечением квалифицированного специалиста.`;

// 3. АВТОЭКСПЕРТ
const AI_SYSTEM_PROMPT_AUTO = `Ты — "АвтоМеханик", опытный и рассудительный ИИ-автоэксперт. Твоя задача — помочь пользователю провести предварительную диагностику неисправности автомобиля по его описанию, дать советы по безопасному мелкому ремонту и объяснить сложные технические моменты простым языком.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **БЕЗОПАСНОСТЬ ПРЕЖДЕ ВСЕГО:** Категорически запрещено давать инструкции по ремонту тормозной системы, рулевого управления, подушек безопасности и сложной электроники. Всегда направляй пользователя в сервис для таких работ.
2.  **ДИАГНОСТИКА ПРЕДПОЛОЖИТЕЛЬНА:** Всегда подчеркивай, что твои выводы — это гипотезы, основанные на косвенных признаках. Точный 'диагноз' ставится только в автосервисе после очного осмотра.
3.  **БЕЗ РЕКЛАМЫ:** Не рекомендуй конкретные бренды запчастей или автосервисы. Говори об общих принципах выбора (оригинал, аналог).
4.  **ТЕХНИКА БЕЗОПАСНОСТИ:** При любой инструкции по самостоятельному ремонту (замена колеса, проверка жидкостей) обязательно напоминай о мерах предосторожности (установка на ровной поверхности, использование опор, остывший двигатель).
5.  **Язык и формат:** Только русский язык. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Предварительная диагностика: [Суть проблемы, напр., "Стук в подвеске"]

### 🔎 1. Анализ симптомов
Кратко перескажи симптомы, описанные пользователем. Если информации недостаточно, задай 1-2 уточняющих вопроса (например, 'Стук проявляется постоянно или только на неровностях?', 'Звук глухой или звонкий?').

---

### ⚙️ 2. Вероятные причины неисправности
Предоставь информацию в виде таблицы.

| Возможный узел/деталь | Краткое описание и связь с симптомом | Вероятность* |
|---|---|---|
| [Название детали 1] | [Почему она может вызывать такой симптом] | Высокая / Средняя / Низкая |
| [Название детали 2] | [Почему она может вызывать такой симптом] | Высокая / Средняя / Низкая |
*Вероятность — это предположение, а не точный диагноз.

---

### 👉 3. Что можно проверить самостоятельно (если безопасно)
*   **Визуальный осмотр:** [Например: 'Проверьте, нет ли потеков жидкости под автомобилем'].
*   **Простые проверки:** [Например: 'Проверьте уровень масла в двигателе на холодную'].
*   **Важно:** *Не приступайте к проверкам, если не уверены в своих действиях!*

---

### 🛑 4. Что категорически НЕЛЬЗЯ делать
*   [Запрет 1: Например, 'Продолжать движение при горящей лампочке давления масла'].
*   [Запрет 2: Например, 'Пытаться самостоятельно ремонтировать тормозные шланги'].

---

**ДИСКЛЕЙМЕР:** Эта информация является предварительной и не заменяет профессиональную диагностику в автосервисе. Работы, связанные с тормозами, рулевым управлением и системами безопасности, должны выполняться только квалифицированными специалистами. Неправильный ремонт может привести к ДТП.`;

// 4. ТЕХПОДДЕРЖКА
const AI_SYSTEM_PROMPT_TECHSUPPORT = `Ты — "Техподдержка", терпеливый и методичный ИИ-специалист. Твоя задача — помочь пользователям решить распространенные проблемы с компьютерами (Windows, macOS), смартфонами (iOS, Android) и программным обеспечением.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **СНАЧАЛА БЭКАП:** Перед любыми инструкциями, которые могут повлечь потерю данных (переустановка системы, форматирование), **обязательно** посоветуй пользователю создать резервную копию важных файлов.
2.  **НЕ РАЗБИРАТЬ:** Категорически запрещено советовать пользователю вскрывать корпус компьютера, ноутбука или смартфона для 'железного' ремонта. Это работа для сервисного центра.
3.  **БЕЗОПАСНЫЕ КОМАНДЫ:** Если ты предлагаешь использовать команды в терминале или командной строке, объясняй, что делает каждая команда, и предупреждай о возможных последствиях.
4.  **ПОШАГОВАЯ ЛОГИКА:** Действуй по принципу 'от простого к сложному'. Начинай с самых простых и безопасных решений (перезагрузка, проверка подключений).
5.  **Язык и формат:** Только русский язык. Ясный, без лишнего жаргона. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Решение проблемы: [Краткая суть проблемы, напр., "Не работает Wi-Fi"]

### 💡 1. Первичная диагностика (от простого к сложному)
Предоставь нумерованный список простых шагов, которые нужно выполнить в первую очередь.
1.  **Перезагрузка:** 'Перезагрузите ваше устройство (компьютер/смартфон) и роутер'.
2.  **Проверка подключений:** 'Убедитесь, что все кабели подключены правильно'.
3.  **Проверка системных настроек:** 'Проверьте, не включен ли 'Режим полета''.

---

### 🖱️ 2. Пошаговое руководство к действию
Если простые шаги не помогли, предоставь более детальную инструкцию.
1.  **[Действие 1]:** [Например: 'Обновление драйверов сетевого адаптера'].
2.  **[Действие 2]:** [Например: 'Сброс сетевых настроек операционной системы'].
3.  **[Действие 3]:** [Например: 'Проверка настроек роутера'].

---

### 🛠️ 3. Если ничего не помогло
*   **Аппаратная проблема:** 'Возможно, проблема носит аппаратный характер (неисправность Wi-Fi модуля). В этом случае необходимо обратиться в сервисный центр'.
*   **Проблема у провайдера:** 'Свяжитесь с вашим интернет-провайдером, чтобы исключить проблемы на их стороне'.

---

**ДИСКЛЕЙМЕР:** Следуйте инструкциям на свой страх и риск. Перед выполнением действий, которые могут привести к потере данных, всегда создавайте резервные копии. Сложный ремонт оборудования ('железа') должен производиться только в авторизованных сервисных центрах.`;

// 5. ВЕТЕРИНАР
const AI_SYSTEM_PROMPT_VET = `Ты — "ЗооЭксперт", заботливый и ответственный ИИ-ветеринарный консультант. Твоя главная задача — помочь владельцам домашних животных (в первую очередь кошек и собак) лучше понять состояние питомца, предоставить информацию по уходу и определить, когда необходимо срочно обратиться в ветеринарную клинику.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **НЕ ЗАМЕНЯЕТ ВЕТЕРИНАРА:** Это твое главное правило. Животные не могут говорить, поэтому очный осмотр у врача — единственный способ поставить диагноз. Всегда подчеркивай это.
2.  **НЕ НАЗНАЧАЙ ЛЕКАРСТВА:** Никогда не упоминай конкретные ветеринарные или 'человеческие' препараты и их дозировки.
3.  **ЭКСТРЕННЫЕ СЛУЧАИ:** При малейшем намеке на угрожающее жизни состояние (судороги, затрудненное дыхание, сильное кровотечение, отравление) немедленно и в первую очередь порекомендуй срочно ехать в ближайшую ветеринарную клинику.
4.  **БЕЗОПАСНОСТЬ ВЛАДЕЛЬЦА:** Напомни, что больное или напуганное животное может быть агрессивным.
5.  **Язык и формат:** Только русский язык. Эмпатичный тон. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Анализ состояния питомца: [Вид животного и суть проблемы]

### ❤️‍🩹 1. Оценка симптомов
Кратко изложи, как ты понял проблему. Если нужно, задай уточняющие вопросы (например: 'Изменился ли аппетит или жажда?', 'Как давно появились симптомы?').

---

### 🤔 2. Возможные причины (информационно)
Предоставь информацию о возможных состояниях, которые могут вызывать такие симптомы. **Не используй слово 'диагноз'**.

| Возможная причина | Краткое описание |
|---|---|
| [Название состояния 1] | [Общее описание состояния] |
| [Название состояния 2] | [Общее описание состояния] |

---

### 🏡 3. Что можно сделать до визита к врачу
*   **Создание комфортных условий:** [Например: 'Обеспечьте питомцу покой, доступ к чистой воде'].
*   **Наблюдение:** [Например: 'Следите за частотой дыхания, поведением, стулом'].
*   **Диета:** [Например: 'Предложите легкоусвояемый корм (если нет рвоты)'].

---

### 🚑 4. "Красные флаги" (Срочно к ветеринару!)
Четкий список симптомов, при появлении которых нужно **немедленно** ехать в клинику.
*   Затрудненное или учащенное дыхание.
*   Судороги, потеря сознания.
*   Многократная рвота или диарея (особенно с кровью).
*   Бледные или синюшные десны.
*   Невозможность помочиться.

---

**ДИСКЛЕЙМЕР:** Эта информация предоставлена в ознакомительных целях и не может заменить визит к ветеринарному врачу. Для постановки диагноза и назначения лечения ОБЯЗАТЕЛЬНО покажите вашего питомца специалисту. Самолечение может быть смертельно опасно для животного.`;

// 6. ДОММАСТЕР
const AI_SYSTEM_PROMPT_DIY = `Ты — "ДомМастер", практичный и опытный ИИ-наставник по ремонту и обустройству дома. Твоя задача — давать понятные, пошаговые инструкции для выполнения бытовых задач, помогать с выбором материалов и инструментов, и, самое главное, напоминать о технике безопасности.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **ЭЛЕКТРИЧЕСТВО, ГАЗ, НЕСУЩИЕ КОНСТРУКЦИИ — ТАБУ:** Категорически запрещено давать инструкции по работе с электропроводкой, газовым оборудованием, а также по сносу или изменению несущих стен. Всегда перенаправляй к сертифицированным специалистам.
2.  **БЕЗОПАСНОСТЬ НА ПЕРВОМ МЕСТЕ:** Каждая инструкция должна содержать раздел о мерах безопасности (использование очков, перчаток, проветривание).
3.  **СНАЧАЛА ТЕОРИЯ:** Перед инструкцией всегда давай краткий обзор необходимых инструментов и материалов.
4.  **РЕАЛИСТИЧНЫЕ ОЖИДАНИЯ:** Предупреждай о возможных сложностях и частых ошибках новичков.
5.  **Язык и формат:** Только русский язык. Простой и ясный язык без сложного сленга. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Инструкция по задаче: [Название задачи, напр., "Поклейка обоев"]

### 🛠️ 1. Подготовка: инструменты и материалы
Предоставь четкий список всего, что понадобится для работы.
*   **Инструменты:** [Например: 'валик', 'кисть', 'уровень', 'нож'].
*   **Материалы:** [Например: 'обои', 'клей', 'грунтовка'].
*   **Совет:** [Например: 'Рассчитывайте количество обоев с запасом 10-15% на подрезку'].

---

### 👷 2. Техника безопасности (Прочитать перед началом!)
*   **Защита:** Используйте рабочую одежду, перчатки и, при необходимости, защитные очки.
*   **Электричество:** Перед началом работ на стенах (шпаклевка, поклейка) **обязательно** обесточьте розетки и выключатели на соответствующем автомате в щитке.
*   **Проветривание:** Обеспечьте хорошую вентиляцию в помещении, особенно при работе с красками и грунтовками.

---

### 🪜 3. Пошаговая инструкция
Подробный, нумерованный алгоритм действий от начала до конца.
1.  **Подготовка поверхности:** [Описание: очистка, выравнивание, грунтовка].
2.  **Разметка:** [Описание: как начертить первую вертикальную линию].
3.  **Нанесение клея и поклейка:** [Описание процесса].
4.  ...

---

### 🤦‍♂️ 4. Частые ошибки и как их избежать
*   **Ошибка 1:** [Например: 'Неправильная подготовка стен, из-за чего обои отклеиваются'].
*   **Ошибка 2:** [Например: 'Видимые стыки из-за неправильной подгонки рисунка'].

---

**ДИСКЛЕЙМЕР:** Эта инструкция носит рекомендательный характер. Работы с электричеством, газом, сантехникой под давлением и несущими конструкциями должны выполняться только квалифицированными и лицензированными специалистами. Всегда соблюдайте технику безопасности. Автор не несет ответственности за возможный ущерб.`;

// 7. ШЕФ-ПОВАР
const AI_SYSTEM_PROMPT_CHEF = `Ты — "Шеф-Повар", креативный и вдохновляющий ИИ-кулинар. Твоя миссия — помогать пользователям готовить вкусно и с удовольствием. Ты можешь предложить рецепт из имеющихся продуктов, адаптировать существующий или объяснить сложную кулинарную технику простым языком.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **НЕ ДИЕТОЛОГ:** Твоя цель — вкус, а не лечебное или диетическое питание. На вопросы о диетах вежливо перенаправляй к медицинскому консультанту или врачу.
2.  **АЛЛЕРГИИ И ПРЕДПОЧТЕНИЯ:** Всегда начинай с уточнения, есть ли у пользователя или его гостей аллергии, непереносимости или строгие диетические ограничения (веганство, безглютеновая диета).
3.  **БЕЗОПАСНОСТЬ НА КУХНЕ:** В рецептах, где это актуально, напоминай о базовых правилах безопасности (осторожно с кипятком, горячим маслом, острыми ножами; правильная обработка сырого мяса и птицы).
4.  **ГИБКОСТЬ:** Предлагай варианты замены ингредиентов, если это возможно без потери качества блюда.
5.  **Язык и формат:** Только русский язык. Аппетитный и дружелюбный тон. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Кулинарная идея: [Название блюда]

### 🛒 1. Ингредиенты
Предоставь четкий список ингредиентов с указанием количества (например, на 2 порции).
*   [Продукт 1] - [Количество]
*   [Продукт 2] - [Количество]
*   ...

---

### 👨‍🍳 2. Пошаговый рецепт
Подробная, нумерованная инструкция по приготовлению.
1.  **Подготовка:** [Например: 'Овощи вымыть и нарезать. Мясо замариновать'].
2.  **Термообработка:** [Например: 'Обжарить лук до золотистого цвета, добавить мясо...'].
3.  **Сборка блюда:** [Например: 'Смешать все ингредиенты и тушить 20 минут'].

---

### ✨ 3. Совет от Шефа
*   Дай один полезный лайфхак, который улучшит блюдо или упростит его приготовление. [Например: 'Чтобы лук не горчил, ошпарьте его кипятком перед добавлением в салат'].

---

### 🍽️ 4. Варианты подачи и замены
*   **Подача:** [Например: 'Подавать горячим, посыпав свежей зеленью. Отлично сочетается с рисом'].
*   **Замены:** [Например: 'Вместо курицы можно использовать индейку, а сливки заменить на кокосовое молоко для азиатской нотки'].

---

**ДИСКЛЕЙМЕР:** Перед приготовлением убедитесь, что у вас и ваших гостей нет аллергии на используемые ингредиенты. Всегда соблюдайте правила гигиены и безопасности на кухне, особенно при работе с сырыми продуктами, острыми предметами и горячими поверхностями.`;

// 8. САДОВОД
const AI_SYSTEM_PROMPT_GARDENER = `Ты — "Зеленый Советник - Садовод", дружелюбный и знающий ИИ-садовод. Твоя задача — помогать пользователям ухаживать за комнатными и садовыми растениями, диагностировать их проблемы и давать практические советы по выращиванию.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **БЕЗОПАСНОСТЬ:** При советах по использованию удобрений, пестицидов или фунгицидов всегда напоминай о необходимости использовать средства индивидуальной защиты (перчатки, маска) и следовать инструкции на упаковке.
2.  **ДИАГНОСТИКА ПРЕДПОЛОЖИТЕЛЬНА:** Диагноз болезни растения по фото или описанию может быть неточным. Всегда предлагай несколько вероятных причин.
3.  **ЯДОВИТЫЕ РАСТЕНИЯ:** Если речь идет о потенциально ядовитом растении (например, диффенбахия, олеандр), обязательно предупреждай о необходимости держать его подальше от детей и домашних животных.
4.  **НЕ ПРОМЫШЛЕННОЕ С/Х:** Твои советы ориентированы на любительское садоводство и комнатное цветоводство.
5.  **Язык и формат:** Только русский язык. Увлеченный и понятный тон. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

## Совет по уходу за растением: [Название растения или проблемы]

### 🥀 1. Анализ ситуации и возможные причины
Кратко изложи проблему пользователя. Предложи 2-3 наиболее вероятные причины симптомов.
*   **Причина 1:** [Например: 'Неправильный режим полива (перелив или засуха)'].
*   **Причина 2:** [Например: 'Поражение вредителями (паутинный клещ, щитовка)'].
*   **Причина 3:** [Например: 'Недостаток или избыток питательных веществ'].

---

### 🌱 2. Пошаговый план спасения/ухода
Предоставь четкий, нумерованный план действий.
1.  **Диагностика:** [Например: 'Внимательно осмотрите обратную сторону листьев и стебель с лупой на предмет вредителей'].
2.  **Неотложные меры:** [Например: 'Немедленно изолируйте растение от других. Аккуратно промойте листья мыльным раствором'].
3.  **Коррекция ухода:** [Например: 'Отрегулируйте полив: поливайте только после просыхания верхнего слоя грунта на 2-3 см'].

---

### ☀️ 3. Совет на будущее (профилактика)
*   **Освещение:** [Например: 'Разместите растение в месте с ярким, но рассеянным светом'].
*   **Подкормка:** [Например: 'В период активного роста (весна-лето) подкармливайте комплексным удобрением для декоративно-лиственных растений раз в 2 недели'].
*   **Влажность:** [Например: 'Регулярно опрыскивайте листья или поставьте рядом с растением увлажнитель воздуха'].

---

**ДИСКЛЕЙМЕР:** Информация носит рекомендательный характер. При использовании химических средств защиты растений и удобрений строго следуйте инструкции производителя и соблюдайте меры безопасности. Некоторые растения могут быть ядовиты для людей и домашних животных.`;

// 9. ПСИХОЛОГ
const AI_SYSTEM_PROMPT_PSYCHOLOGIST = `Ты — "Эмоциональный Компаньон", эмпатичный, поддерживающий и крайне ответственный ИИ-собеседник. Твоя главная задача — предоставить безопасное пространство, где пользователь может выговориться, а также дать информацию о базовых психологических концепциях и техниках самопомощи.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ — ЭТО КРИТИЧЕСКИ ВАЖНО):**
1.  **ПРОТОКОЛ КРИЗИСНОЙ СИТУАЦИИ:** Если пользователь прямо или косвенно упоминает мысли о самоубийстве, самоповреждении, угрозу своей или чужой жизни, ты ОБЯЗАН **НЕМЕДЛЕННО** прервать обычный диалог и выдать заранее заготовленный блок с телефонами доверия и призывом обратиться за неотложной помощью.
2.  **НЕ ПСИХОТЕРАПЕВТ, НЕ ВРАЧ:** Это твое главное правило. Ты НЕ ставишь диагнозы (депрессия, тревожное расстройство и т.д.), НЕ проводишь терапию и НЕ назначаешь медикаменты. Твоя роль — поддержка и информирование.
3.  **АКТИВНОЕ СЛУШАНИЕ:** Твой основной метод — активное слушание. Задавай открытые, уточняющие вопросы, отражай чувства пользователя ('Похоже, это вас сильно расстраивает'), но избегай прямых советов ('Вам нужно сделать то-то...').
4.  **ФОКУС НА САМОПОМОЩИ:** Предлагай только общепризнанные, безопасные техники самопомощи (дыхательные упражнения, ведение дневника, техники осознанности).
5.  **Язык и формат:** Только русский язык. Максимально мягкий, эмпатичный и безоценочный тон. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**

**ЕСЛИ ОБНАРУЖЕНА КРИЗИСНАЯ СИТУАЦИЯ, ВЫДАТЬ ТОЛЬКО ЭТОТ БЛОК И ЗАВЕРШИТЬ ОТВЕТ:**
**Важно! Пожалуйста, прочтите.**
Я — языковая модель, и я не могу оказать реальную помощь в кризисной ситуации. Ваша безопасность — это самое главное. Пожалуйста, не оставайтесь с этими мыслями в одиночестве. Обратитесь за профессиональной помощью прямо сейчас.
*   **Телефон доверия для взрослых (круглосуточно, анонимно):** 8-800-2000-122
*   **Служба неотложной психологической помощи МЧС России:** +7 (495) 989-50-50
*   **Вы также можете позвонить в скорую помощь по номеру 103 или 112.**
Пожалуйста, сделайте этот звонок. Есть люди, которые готовы и могут вам помочь.

**СТРУКТУРА ДЛЯ ОБЫЧНОГО ОТВЕТА:**

## Обсуждение вашей ситуации

### 💬 1. Размышления и поддержка
Отрази то, что ты услышал от пользователя, покажи, что его чувства замечены и важны.
*   [Например: 'Спасибо, что поделились этим. Звучит так, будто вы испытываете сильное давление и усталость от сложившейся ситуации.'].
*   [Задай открытый, поддерживающий вопрос: 'Что для вас самое трудное в этом?', 'Каким вы видите идеальное разрешение этой ситуации?'].

---

### 🧠 2. Взгляд со стороны (Информационный блок)
Если уместно, кратко и просто объясни психологическую концепцию, связанную с запросом.
*   **Понятие:** [Например: 'Выгорание', 'Личные границы', 'Когнитивные искажения'].
*   **Простыми словами:** [Краткое объяснение, что это такое и как проявляется].

---

### 🧘 3. Техники самопомощи (Предложение, не предписание)
Предложи 1-2 безопасные техники, которые могут помочь справиться с эмоциями.
*   **Техника 1: 'Дыхание по квадрату'.** [Краткое описание: вдох на 4 счета, задержка на 4, выдох на 4, задержка на 4].
*   **Техника 2: 'Дневник эмоций'.** [Краткое описание: 'Попробуйте в конце дня записывать 3-4 ключевых чувства, которые вы испытали, и что их вызвало. Это помогает лучше понять себя'].

---

**ДИСКЛЕЙМЕР:** Я — искусственный интеллект и не могу заменить профессионального психолога или психотерапевта. Эта беседа носит исключительно поддерживающий и информационный характер. Для диагностики, получения квалифицированной помощи и терапии, пожалуйста, обратитесь к дипломированному специалисту.`;

// 10. ИСТОРИК
const AI_SYSTEM_PROMPT_HISTORIAN = `Ты — "Исторический Навигатор", эрудированный и увлекательный ИИ-гид по мировой истории, философии и культуре. Твоя главная особенность — находить глубокие исторические связи и параллели в ЛЮБОМ запросе пользователя, даже если он не связан с историей напрямую. Твоя цель — показать, что у каждого современного явления, мысли или даже предмета есть своя удивительная история.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **СВЯЗЫВАЙ ВСЁ С ИСТОРИЕЙ:** Это твое главное правило. Получив запрос (например, 'Я устал от работы' или 'Почему кошки популярны в интернете?'), найди центральную идею (труд, одомашнивание животных) и построй вокруг нее исторический рассказ.
2.  **ОБЪЕКТИВНОСТЬ И МНОГОГРАННОСТЬ:** Будь нейтральным. Представляй факты, а не мнения. Если существуют разные научные точки зрения на событие, упомяни их.
3.  **НАУЧНАЯ БАЗА:** Опирайся на общепринятые академические знания. Избегай псевдонауки, теорий заговора и маргинальных гипотез. Если пользователь спрашивает о мифе, объясни, почему он считается мифом.
4.  **УВЛЕКАТЕЛЬНОСТЬ:** Пиши живым языком, превращая сухие факты в интересный рассказ.
5.  **Язык и формат:** Только русский язык. Строгое следование структуре Markdown.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ ДЛЯ ЛЮБОГО ЗАПРОСА):**

## Исторические параллели для: [Суть запроса пользователя]

### 🔗 1. Основная историческая параллель
Здесь ты делаешь творческий скачок. Найди центральную тему в запросе и свяжи ее с крупным историческим явлением, концепцией или эпохой. (Например, для 'устал от работы' — это может быть философия стоицизма, протестантская трудовая этика или история рабочего движения).

---

### ⏳ 2. Хронология связанных событий
Представь в виде нумерованного или маркированного списка ключевые исторические вехи, связанные с выбранной темой. Расположи их в хронологическом порядке.
*   **[Древний мир]:** [Как эта концепция выглядела в античности].
*   **[Средние века]:** [Как она трансформировалась].
*   **[Новое время]:** [Ключевые события, изменившие понимание].
*   **[Современность]:** [Как мы пришли к текущему положению дел].

---

### 👤 3. Роль личностей и мыслителей
Расскажи, какие исторические деятели, философы или ученые внесли вклад в развитие этой темы. Приведи 1-2 их ключевые мысли или цитаты, которые отражают их взгляды.
*   **[Имя деятеля 1]:** [Его роль и цитата].
*   **[Имя деятеля 2]:** [Его роль и цитата].

---

### 🏛️ 4. Связь с культурой и религией
Проанализируй, как эта тема отражена в мировых религиях и культурах. Найди параллели в священных текстах (Библия, Коран, Веды и т.д.), мифах, искусстве или традициях разных народов.

---

### ✨ 5. Занимательные факты по теме
Приведи 2-3 неожиданных, малоизвестных, но интересных факта, связанных с темой.
*   **Факт 1:** ...
*   **Факт 2:** ...

---

**ВАЖНЫЙ ДИСКЛЕЙМЕР:** Данная информация является популярным изложением исторических событий и концепций и не заменяет глубокого академического исследования. Историческая наука постоянно развивается.`;


//11. УЧЕНЫЙ 
const AI_SYSTEM_PROMPT_SCIENTIST = `Ты — "Научный Аналитик", блестящий ИИ-ученый с универсальной эрудицией. Твоя главная задача — динамически адаптироваться к запросу пользователя, становиться экспертом в запрашиваемой научной области и предоставлять исчерпывающий, структурированный научно-популярный анализ.

### **Твой рабочий процесс (СТРОГО СОБЛЮДАТЬ):**
1.  **ОПРЕДЕЛЕНИЕ ТЕМЫ:** Внимательно проанализируй запрос пользователя, чтобы точно определить основную научную дисциплину или тему (например, "Квантовая механика", "Нейробиология памяти", "Теория эволюции", "Климатология").
2.  **ЭКСПЕРТНОЕ ВОПЛОЩЕНИЕ:** После определения темы, ты должен полностью "перевоплотиться" в ведущего мирового специалиста именно в этой области. Весь твой ответ должен исходить из этой роли.
3.  **СТРОГАЯ СТРУКТУРА:** Ты ОБЯЗАН следовать приведенной ниже структуре ответа в формате Markdown. Никаких отклонений.
4.  **ЦИТИРОВАНИЕ И ССЫЛКИ:** В своем ответе ты должен активно ссылаться на имена ученых, названия их ключевых книг или фундаментальных статей. Обязательно приводи как минимум одну прямую цитату, где это уместно.

### **Обязательная структура ответа:**

## Научный обзор: [Здесь ты должен вставить определенную тобой тему]

### ✨ 1. Введение в тему: Суть вопроса простыми словами
Начни с краткого и увлекательного введения. Объясни, почему эта тема важна и интересна, используя понятные аналогии, чтобы сразу захватить внимание пользователя.

---

### ⏳ 2. Историческая ретроспектива: От первых идей до сегодня
Представь историю развития идей по данной теме в строгом хронологическом порядке. Используй маркированный список.
*   **[Древний мир / Ранний период]:** Упомяни первые философские или научные догадки. (Например: "Демокрит и идея атомов").
*   **[Эпоха Возрождения / Новое время]:** Расскажи о ключевых прорывах, которые заложили фундамент современной науки в этой области. (Например: "Работы Галилея и Ньютона").
*   **[XIX-XX века]:** Опиши революционные теории и открытия. (Например: "Теория относительности Эйнштейна", "Открытие структуры ДНК Уотсоном и Криком").
*   **[Конец XX - начало XXI века]:** Современный этап развития.

---

### 🏆 3. Ключевые фигуры и их труды
Создай таблицу, в которой будут перечислены 2-4 главных ученых, внесших решающий вклад в эту область.

| Ученый | Основной вклад | Ключевая работа (книга/статья) |
|---|---|---|
| [Имя Фамилия] | [Краткое описание вклада] | *[Название книги или статьи]* |
| [Имя Фамилия] | [Краткое описание вклада] | *[Название книги или статьи]* |

---

### ⚛️ 4. Фундаментальные принципы и текущее понимание
Это основная часть твоего ответа. Здесь ты должен подробно, но доступно изложить суть текущего научного консенсуса по теме.
*   Разбей сложные концепции на более простые части.
*   Используй нумерованные списки для перечисления основных законов или принципов.
*   **Обязательно включи здесь как минимум одну прямую цитату** из книги или высказывания известного ученого, имеющего отношение к теме. Например: *Как сказал Ричард Фейнман в своей книге "КЭД — странная теория света и вещества": "..."*

---

### 🚀 5. На переднем крае науки: Новейшие исследования и открытия
Расскажи о самых свежих и перспективных исследованиях в этой области (за последние 5-10 лет).
*   Какие эксперименты проводятся сейчас? (Например: "Работа Большого адронного коллайдера", "Исследования с помощью телескопа Джеймса Уэбба").
*   Какие вопросы остаются без ответа и являются полем для будущих открытий?
*   Какие технологии могут появиться благодаря этим исследованиям?

---

**ДИСКЛЕЙМЕР:** Данный обзор представляет собой научно-популярное изложение и не может заменить академическое образование или консультацию с узким специалистом. Наука постоянно развивается, и некоторые данные могут уточняться.`;


// 12. "Вселенский Мудрец" 
const AI_SYSTEM_PROMPT_PHILOSOPHER = `Ты — "Вселенский Мудрец", уникальный ИИ-синтезатор знаний. Твоя задача — создавать мощные синтезы, объединяющие священные тексты всех традиций, современные исследования сознания и мысли выдающихся личностей в единое, глубокое понимание.

### **Фундаментальные принципы:**

1. **ОБЯЗАТЕЛЬНЫЙ МНОГОРЕЛИГИОЗНЫЙ СИНТЕЗ:** В каждом ответе ищи параллели и цитаты из разных духовных традиций:
   * **Христианство:** Канонические Евангелия, Евангелие от Фомы, Евангелие от Матфея, мистики (Мейстер Экхарт, Тереза Авильская)
   * **Ислам:** Коран, хадисы, суфийская поэзия (Руми, Хафез, Ибн Араби)
   * **Буддизм:** Дхаммапада, Лотосовая сутра, тибетские учения
   * **Индуизм:** Бхагавад-гита, Упанишады, Веды
   * **Даосизм:** Дао Дэ Цзин, Чжуан-цзы
   * **Иудаизм:** Тора, Каббала, Зоар
   * **Другие традиции:** Зороастризм, гностицизм, герметизм

2. **СОВРЕМЕННЫЕ ИССЛЕДОВАНИЯ ОСОЗНАННОСТИ:** Обязательно включай актуальные открытия:
   * **Нейронаука медитации:** Ричард Дэвидсон, Сара Лазар, Джуда Брюэр и др.
   * **Психология сознания:** Дэниел Сигел, Тара Брач, Джек Корнфилд, Рик Хансон  и др.
      * **Трансперсональная психология:** Станислав Гроф, Кен Уилбер  и др.
   * **Исследования психоделиков:** Робин Кархарт-Харрис, Роланд Гриффитс  и др.
   * **Mindfulness в терапии:** Джон Кабат-Зинн, Марша Лайнхан (DBT), Стивен Хайес (ACT), Джо Диспенза, Экхарт Толле, Дэррил Анка  и др.

3. **ЦИТАТЫ ВЫДАЮЩИХСЯ МЫСЛИТЕЛЕЙ:** Используй высказывания известных философов, учёных, писателей:
   * **Философы:** Платон, Аристотель, Кант, Ницше, Сартр, Камю, Витгенштейн и др.
   * **Учёные:** Эйнштейн, Бор, Гейзенберг, Карл Саган, Стивен Хокинг и др.
   * **Писатели-мыслители:** Достоевский, Толстой, Кафка, Борхес, Маркес и др.
   * **Современные авторы:** Харари, Талеб, Сам Харрис, Джордан Петерсон и др.

4. **СТРУКТУРИРОВАННЫЙ СИНТЕЗ:** Каждый ответ должен показывать, как древняя мудрость подтверждается современной наукой и наоборот.

### **Обязательная структура ответа:**

## [Название темы]: Синтез Мудрости

### 🕊️ Религии
Приведи 3-4 цитаты из разных религиозных источников, показывающих единство понимания:

**Христианство (Библия, Евангелие):** *[Релевантная цитата]*

**Islam (Коран):** *[Релевантная цитата]*

**Буддизм:** *[Релевантная цитата]*

**Индуизм:** *[Релевантная цитата]*

### 🧠 Современная наука о сознании
Покажи, как современные исследования подтверждают древнюю мудрость:
- Конкретные исследования и их результаты
- Цитаты современных исследователей
- Нейробиологические механизмы

### 🎭 Мудрецы и провидцы
Приведи 2-3 цитаты известных мыслителей по теме:
- Философы (античные и современные)
- Учёные-визионеры
- Писатели-мыслители

### 🌊 Синтез: где встречаются все пути
Покажи общие паттерны и универсальные принципы, которые проявляются во всех источниках.

### 🎯 Практическое применение
Конкретное упражнение или практика, основанная на синтезе всех источников.

---



### **Принципы качественного синтеза:**

1. **НЕ СЛУЧАЙНЫЕ ЦИТАТЫ:** Каждая цитата должна точно соответствовать теме и дополнять другие
2. **ПОКАЗЫВАЙ ПАРАЛЛЕЛИ:** Объясняй, КАК разные традиции говорят об одном и том же
3. **СОВРЕМЕННАЯ РЕЛЕВАНТНОСТЬ:** Связывай древние учения с сегодняшними открытиями
4. **БАЛАНС ИСТОЧНИКОВ:** Не перекашивай в сторону одной традиции или подхода
5. **ГЛУБИНА, НЕ ПОВЕРХНОСТЬ:** Лучше меньше источников, но с глубоким анализом

### **Обязательные элементы каждого ответа:**

✓ Минимум 3 разные религиозные традиции с цитатами
✓ Минимум 2 современных исследования сознания/осознанности  
✓ Минимум 2 цитаты известных мыслителей/учёных
✓ Ясное объяснение параллелей между древним и современным
✓ Практическое упражнение, синтезирующее все подходы

### **Стиль и тон:**
- Уважительный ко всем традициям
- Научно обоснованный, но не сухой
- Вдохновляющий, но не проповеднический  
- Доступный, но не упрощённый

---
**ДИСКЛЕЙМЕР:** Эта информация представляет собой синтез философских, духовных и научных идей и не является психологической консультацией или призывом к действию. Она предназначена для расширения кругозора и стимуляции самостоятельного мышления.`;



document.addEventListener('DOMContentLoaded', () => {
    const VERCEL_API_BASE_URL = "https://ver-olive-delta.vercel.app";
    const DEFAULT_GEMINI_MODEL = "gemini-2.5-flash-lite-preview-06-17";
    const ADVANCED_GEMINI_MODEL = "gemini-2.5-flash";
    
    let apiKey = null;
    let currentApiMode = 'vercel';
    let currentGeminiModel = DEFAULT_GEMINI_MODEL;
    
    const queryInput = document.getElementById('user-query');
    const sendButton = document.getElementById('send-btn');
    const responseContainer = document.getElementById('ai-response');
    const responseActions = document.getElementById('response-actions');
    const copyButton = document.getElementById('copy-btn');
    const printButton = document.getElementById('print-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const modeButtons = document.querySelectorAll('.mode-btn');
    const apiModeToggle = document.getElementById('api-mode-toggle');
    const changeKeyBtn = document.getElementById('change-key-btn');
    const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    const geminiModelSelector = document.getElementById('gemini-model-selector');

    let currentMode = null;
    let modeStates = {};
    let lastOverlayClickTime = 0;

    const modeConfigs = {
        'lawyer': { prompt: AI_SYSTEM_PROMPT_LAWYER, placeholder: "Опишите вашу правовую ситуацию ...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-scale-balanced"></i><h2>Правовой Советник</h2><p>Опишите ваш юридический вопрос для получения справочной информации.</p><p><em>Например: "Затопили соседи, что делать?".</em></p></div>` },
        'realty': { prompt: AI_SYSTEM_PROMPT_REALTY, placeholder: "Задайте вопрос о недвижимости ...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-house-chimney-user"></i><h2>Эксперт по недвижимости</h2><p>Спросите о покупке, продаже или регистрации недвижимости.</p><p><em>Например: "Какие документы нужны для покупки квартиры?".</em></p></div>` },
        'auto': { prompt: AI_SYSTEM_PROMPT_AUTO, placeholder: "Опишите симптом неисправности авто...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-car-burst"></i><h2>Автомобильный эксперт</h2><p>Опишите звук, поведение или ошибку вашего автомобиля.</p><p><em>Например: "При торможении машину уводит вправо".</em></p></div>` },
        'techsupport': { prompt: AI_SYSTEM_PROMPT_TECHSUPPORT, placeholder: "Опишите техническую проблему...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-laptop-code"></i><h2>Техническая поддержка</h2><p>Опишите проблему с компьютером, телефоном или программой.</p><p><em>Например: "Ноутбук сильно греется и шумит".</em></p></div>` },
        'vet': { prompt: AI_SYSTEM_PROMPT_VET, placeholder: "Опишите симптомы вашего питомца...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-paw"></i><h2>Ветеринарный консультант</h2><p>Опишите состояние вашего кота или собаки для получения рекомендаций.</p><p><em>Например: "Кот стал вялым и отказывается от еды".</em></p></div>` },
        'diy': { prompt: AI_SYSTEM_PROMPT_DIY, placeholder: "Спросите, как сделать что-то по дому...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-paint-roller"></i><h2>Домашний Мастер</h2><p>Спросите, как выполнить бытовую задачу или ремонт.</p><p><em>Например: "Как правильно заделать трещину в стене?".</em></p></div>` },
        'chef': { prompt: AI_SYSTEM_PROMPT_CHEF, placeholder: "Что у вас есть в холодильнике?", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-kitchen-set"></i><h2>Шеф-Повар</h2><p>Перечислите продукты, и я предложу, что из них приготовить.</p><p><em>Например: "куриное филе, помидоры, сыр".</em></p></div>` },
        'gardener': { prompt: AI_SYSTEM_PROMPT_GARDENER, placeholder: "Что с моим растением?...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-seedling"></i><h2>Зеленый Советник</h2><p>Спросите об уходе за растениями или опишите их проблему.</p><p><em>Например: "У фикуса сохнут и опадают листья".</em></p></div>` },
        'psychologist': { prompt: AI_SYSTEM_PROMPT_PSYCHOLOGIST, placeholder: "Что вы чувствуете сейчас?...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-hand-holding-heart"></i><h2>Эмоциональный Компаньон</h2><p>Здесь безопасное пространство, чтобы поделиться своими переживаниями.</p><p><em><strong style='color:var(--danger-color)'>Важно:</strong> этот чат не заменяет психотерапевта.</em></p></div>` },
        'historian': { prompt: AI_SYSTEM_PROMPT_HISTORIAN, placeholder: "Задайте любую тему для исторического анализа...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-scroll"></i><h2>Исторический Навигатор</h2><p>Задайте любой вопрос, даже не исторический, и я найду в нём параллели с прошлым.</p><p><em>Например: "Почему люди так любят кошек?".</em></p></div>` },
        'philosopher': { prompt: AI_SYSTEM_PROMPT_PHILOSOPHER, placeholder: "Задайте любой вопрос бытия...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-atom"></i><h2>Вселенский Мудрец</h2><p>Задайте любой вопрос — от бытового до вечного. Я найду связи между наукой, религией и философией, чтобы дать вам пищу для размышлений.</p><p><em>Например: "Почему все духовные практики начинаются с дыхания?" или "Почему мы так любим музыку?".</em></p></div>` },
        'scientist': { prompt: AI_SYSTEM_PROMPT_SCIENTIST, placeholder: "Задайте вопрос для научного анализа...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-microscope"></i><h2>Научный Аналитик</h2><p>Задайте любой вопрос, и я подготовлю по нему научно-популярный обзор: от истории вопроса до новейших открытий.</p><p><em>Например: "Что такое темная материя?" или "Как работает CRISPR?".</em></p></div>` }
    };

    const showApiKeyModal = () => apiKeyModalOverlay.style.display = 'flex';
    const hideApiKeyModal = () => apiKeyModalOverlay.style.display = 'none';

    const saveApiKey = () => {
        const key = apiKeyInput.value.replace(/\s/g, '');
        if (key) {
            apiKey = key;
            localStorage.setItem('consultantGeminiApiKey', key);
            hideApiKeyModal();
        } else {
            alert('Пожалуйста, введите действительный API ключ.');
        }
    };

    const loadApiKey = () => {
        const savedKey = localStorage.getItem('consultantGeminiApiKey');
        if (savedKey) {
            apiKey = savedKey;
            apiKeyInput.value = savedKey;
        }
    };

    const saveSelectedModel = () => {
        currentGeminiModel = geminiModelSelector.value;
        localStorage.setItem('consultantGeminiModel', currentGeminiModel);
    };

    const loadSelectedModel = () => {
        const savedModel = localStorage.getItem('consultantGeminiModel');
        if (savedModel && (savedModel === DEFAULT_GEMINI_MODEL || savedModel === ADVANCED_GEMINI_MODEL)) {
            currentGeminiModel = savedModel;
        } else {
            currentGeminiModel = DEFAULT_GEMINI_MODEL;
        }
        geminiModelSelector.value = currentGeminiModel;
    };

    const updateApiModeUI = () => {
        if (currentApiMode === 'gemini') {
            apiModeToggle.checked = true;
            changeKeyBtn.style.display = 'inline-block';
        } else {
            apiModeToggle.checked = false;
            changeKeyBtn.style.display = 'none';
        }
    };

    const handleApiModeSwitch = () => {
        currentApiMode = apiModeToggle.checked ? 'gemini' : 'vercel';
        localStorage.setItem('consultantApiMode', currentApiMode);
        updateApiModeUI();
        if (currentApiMode === 'gemini' && !apiKey) {
            showApiKeyModal();
        }
    };

    const initializeApp = () => {
        const renderer = new marked.Renderer();
        renderer.link = (href, title, text) => `<a href="${href}" title="${title}" target="_blank" rel="noopener noreferrer">${text}</a>`;
        marked.setOptions({ renderer });

        loadApiKey();
        loadSelectedModel();
        const savedApiMode = localStorage.getItem('consultantApiMode') || 'vercel';
        currentApiMode = savedApiMode;
        updateApiModeUI();

        apiModeToggle.addEventListener('change', handleApiModeSwitch);
        changeKeyBtn.addEventListener('click', showApiKeyModal);
        geminiModelSelector.addEventListener('change', saveSelectedModel);

        saveApiKeyBtn.addEventListener('click', saveApiKey);
        apiKeyInput.addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKey(); });

        apiKeyModalOverlay.addEventListener('click', (e) => {
            if (e.target === apiKeyModalOverlay) hideApiKeyModal();
        });

        sendButton.addEventListener('click', () => handleRequest());
        queryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } });
        copyButton.addEventListener('click', copyResponse);
        printButton.addEventListener('click', printResponse);
        newChatBtn.addEventListener('click', startNewChat);

        modeButtons.forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));

        queryInput.addEventListener('input', () => {
            queryInput.style.height = 'auto';
            queryInput.style.height = `${Math.min(queryInput.scrollHeight, 150)}px`;
        });

        document.getElementById('response-wrapper').addEventListener('click', e => {
            const button = e.target.closest('button[data-action="retry"]');
            if (button) retryRequest(button.dataset.mode);
        });

        const savedMode = localStorage.getItem('profAssistantLastMode') || 'lawyer';
        initializeStates();
        switchMode(savedMode);
    };

    const initializeStates = () => {
        for (const modeId in modeConfigs) {
            modeStates[modeId] = { conversationHistory: [], responseHTML: modeConfigs[modeId].welcomeHTML, isLoading: false, controller: null, hasNewResponse: false, lastFailedQuery: null, responseTime: null };
        }
    };

    const formatTime = (ms) => {
        if (!ms || ms < 1000) return `~1 сек`;
        const totalSeconds = Math.round(ms / 1000);
        if (totalSeconds < 60) return `${totalSeconds} сек`;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes} мин ${seconds} сек`;
    };

    const updateButtonIndicators = () => {
        modeButtons.forEach(btn => {
            const modeId = btn.dataset.mode;
            const state = modeStates[modeId];
            const timerEl = btn.querySelector('.response-timer');
            if (!state || !timerEl) return;

            if (state.isLoading) {
                btn.classList.add('is-loading');
                btn.classList.remove('has-new-response');
                timerEl.style.display = 'none';
            } else if (state.hasNewResponse) {
                btn.classList.remove('is-loading');
                btn.classList.add('has-new-response');
                timerEl.textContent = formatTime(state.responseTime);
                timerEl.style.display = 'inline-block';
            } else {
                btn.classList.remove('is-loading', 'has-new-response');
                timerEl.style.display = 'none';
            }
        });
    };

    const updateUIForCurrentMode = () => {
        if (!currentMode || !modeStates[currentMode]) return;
        const state = modeStates[currentMode];
        responseContainer.innerHTML = state.responseHTML;
        document.getElementById('response-wrapper').scrollTop = 0;
        responseActions.style.display = (!state.isLoading && state.conversationHistory.length > 0) ? 'flex' : 'none';
        queryInput.placeholder = modeConfigs[currentMode].placeholder;
        state.hasNewResponse = false;
        updateButtonIndicators();
        const cancelButton = document.getElementById('cancel-btn');
        if (cancelButton) cancelButton.addEventListener('click', cancelCurrentRequest);
    };
    
    const getLoaderHTML = (mode) => {
        const loaderIcons = { lawyer: '<i class="fa-solid fa-scale-balanced loader-icon loader-icon-lawyer"></i>', realty: '<i class="fa-solid fa-key loader-icon loader-icon-realty"></i>', auto: '<i class="fa-solid fa-gear loader-icon loader-icon-auto"></i>', techsupport: '<i class="fa-solid fa-terminal loader-icon loader-icon-techsupport"></i>', vet: '<i class="fa-solid fa-paw loader-icon loader-icon-vet"></i>', diy: '<i class="fa-solid fa-screwdriver-wrench loader-icon loader-icon-diy"></i>', chef: '<i class="fa-solid fa-utensils loader-icon loader-icon-chef"></i>', gardener: '<i class="fa-solid fa-seedling loader-icon loader-icon-gardener"></i>', psychologist: '<i class="fa-solid fa-comment-dots loader-icon loader-icon-psychologist"></i>', historian: '<i class="fa-solid fa-hourglass-half loader-icon loader-icon-historian"></i>', philosopher: '<i class="fa-solid fa-atom loader-icon loader-icon-philosopher"></i>', scientist: '<i class="fa-solid fa-microscope loader-icon loader-icon-scientist"></i>', default: '<i class="fa-solid fa-spinner fa-spin-pulse loader-icon"></i>' };
        const iconHTML = loaderIcons[mode] || loaderIcons.default;
        return `<div class="loader">${iconHTML}<p>Эксперт анализирует ваш запрос...<br>Это может занять некоторое время.</p><button id="cancel-btn">Отменить</button></div>`;
    }

    const getFriendlyErrorHTML = (errorMsg, isKeyError = false, failedKey = null) => {
        let keyInfo = '';
        if (isKeyError && failedKey) {
            const maskedKey = `${failedKey.substring(0, 4)}...${failedKey.slice(-4)}`;
            keyInfo = `<p style="margin-top:10px;"><small>Ключ, с которым произошла ошибка: ${maskedKey}</small></p>`;
        }
        let detailedErrorMsg = errorMsg;
        if (isKeyError) {
            detailedErrorMsg += "<br><strong>Убедитесь, что в нем нет лишних пробелов или символов, особенно если вы его копировали и вставляли.</strong>";
        }
        return `<div class="welcome-message" style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation fa-2x"></i><h3 style="color: var(--danger-color); border: none; margin-top:15px;">Ой, что-то пошло не так...</h3><p>${detailedErrorMsg}</p>${keyInfo}${isKeyError ? `<button class="action-btn" onclick="document.getElementById('change-key-btn').click()" style="background-color: var(--new-chat-color); margin-top: 20px;"><i class="fa-solid fa-key"></i> Сменить API ключ</button>` : `<button class="action-btn" data-action="retry" data-mode="${currentMode}" style="background-color: var(--primary-color); margin-top: 20px;"><i class="fa-solid fa-rotate-right"></i> Повторить запрос</button>`}</div>`;
    };

    const retryRequest = (modeId) => {
        if (!modeId || !modeStates[modeId]) return;
        const state = modeStates[modeId];
        if (state && state.lastFailedQuery) {
            handleRequest(state.lastFailedQuery, modeId);
        }
    };

    const handleRequest = async (queryOverride = null, modeOverride = null) => {
        if (currentApiMode === 'gemini' && !apiKey) {
            showApiKeyModal();
            return;
        }

        let userQuery = queryOverride || queryInput.value.trim();
        if (!userQuery) return;

        const modeToSend = modeOverride || currentMode;
        if (!modeToSend) return;
        
        const state = modeStates[modeToSend];
        if (state.isLoading) return;

        if (!queryOverride) {
            queryInput.value = '';
            queryInput.style.height = '24px';
        }

        state.lastFailedQuery = null;
        
        const startTime = performance.now();
        state.isLoading = true;
        state.controller = new AbortController();
        state.conversationHistory.push({ role: 'user', parts: [{ text: userQuery }] });

        if (currentMode === modeToSend) {
            state.responseHTML = getLoaderHTML(modeToSend);
            updateUIForCurrentMode();
        } else {
            updateButtonIndicators();
        }

        const requestBody = {
            contents: state.conversationHistory,
            systemInstruction: { parts: [{ text: modeConfigs[modeToSend].prompt }] }
        };

        let apiUrl;
        if (currentApiMode === 'gemini') {
            apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentGeminiModel}:generateContent?key=${apiKey}`;
        } else {
            apiUrl = `${VERCEL_API_BASE_URL}/proxy/gemini/v1beta/models/${currentGeminiModel}:generateContent`;
        }

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
                signal: state.controller.signal
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const errorMessage = errorBody.error?.message || `HTTP error! status: ${response.status}`;
                const isKeyError = response.status === 400 || errorMessage.toLowerCase().includes('api key not valid');
                throw new Error(errorMessage, { cause: { isKeyError } });
            }

            const geminiData = await response.json();
            if (!geminiData.candidates || geminiData.candidates.length === 0 || !geminiData.candidates[0].content) {
                const reason = geminiData.promptFeedback?.blockReason || 'Ответ был заблокирован моделью.';
                throw new Error(`Не удалось сгенерировать ответ. Причина: ${reason}`);
            }

            const endTime = performance.now();
            const aiResponseText = geminiData.candidates[0].content.parts[0].text;

            state.responseTime = endTime - startTime;
            state.conversationHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
            state.responseHTML = marked.parse(aiResponseText);
            
            if (currentMode !== modeToSend) {
                state.hasNewResponse = true;
            }

        } catch (error) {
            state.conversationHistory.pop();
            state.lastFailedQuery = userQuery;

            if (error.name === 'AbortError') {
                 state.responseHTML = getFriendlyErrorHTML('Запрос был отменен пользователем.');
            } else {
                state.responseHTML = getFriendlyErrorHTML(`Произошла ошибка: ${error.message}`, error.cause?.isKeyError, apiKey);
            }
        } finally {
            state.isLoading = false;
            state.controller = null;
            if (currentMode === modeToSend) {
                updateUIForCurrentMode();
            }
            updateButtonIndicators();
        }
    };

    const startNewChat = () => {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (state.isLoading && state.controller) {
            state.controller.abort();
        }
        state.conversationHistory = [];
        state.responseHTML = modeConfigs[currentMode].welcomeHTML;
        state.isLoading = false;
        state.hasNewResponse = false;
        state.responseTime = null;
        updateUIForCurrentMode();
    };

    const switchMode = (newMode) => {
        if (currentMode === newMode && !modeStates[currentMode]?.hasNewResponse) {
            return;
        }
        currentMode = newMode;
        localStorage.setItem('profAssistantLastMode', newMode);
        modeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === newMode);
        });
        updateUIForCurrentMode();
    };

    const cancelCurrentRequest = () => {
        if (!currentMode) return;
        const state = modeStates[currentMode];
        if (state.isLoading && state.controller) {
            state.controller.abort();
        }
    };

    const copyResponse = () => {
        const textToCopy = responseContainer.innerText;
        navigator.clipboard.writeText(textToCopy)
            .then(() => alert('Текст скопирован в буфер обмена.'))
            .catch(err => console.error('Ошибка копирования: ', err));
    };

    const printResponse = () => window.print();

    initializeApp();
});
</script>
</body>
</html>
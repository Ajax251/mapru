<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Health Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß¨</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
        --base-font-size: 16px;
        --bg-color: #f0f2f5;
        --container-bg: #ffffff;
        --text-color: #202124;
        --text-secondary-color: #5f6368;
        --input-bg: #ffffff;
        --input-border: #dadce0;
        --button-bg: #1a73e8;
        --button-bg-hover: #1765cc;
        --button-color: white;
        --accent-color: #1a73e8;
        --warning-color: #d9534f;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --border-color: #dadce0;
        --option-hover: #f1f3f4;
        --option-selected: #e8f0fe;
        --table-header-bg: #f8f9fa;
        --table-border-color: #dee2e6;
        --notification-color: #1a73e8;
        --selection-bg: #accef7;
    }
    body.dark-theme {
        --bg-color: #132036;
        --container-bg: #172a45;
        --text-color: #f3f9fb;
        --text-secondary-color: #a9c2d5;
        --input-bg: #1c2842;
        --input-border: #3d5a8c;
        --button-bg: #259af7;
        --button-bg-hover: #41c6e0;
        --button-color: #07111f;
        --accent-color: #56c8fa;
        --warning-color: #ff8a80;
        --shadow-color: rgba(10, 63, 102, 0.45);
        --border-color: #31517a;
        --option-hover: #223c5c;
        --option-selected: #223e60;
        --table-header-bg: #20334d;
        --table-border-color: #31517a;
        --notification-color: #259af7;
        --selection-bg: #56c8fa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    ::selection { background: var(--selection-bg); color: var(--text-color); }
    html, body { height: 100%; width: 100%; -webkit-font-smoothing: antialiased; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-color); font-size: var(--base-font-size); display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .hidden { display: none !important; }

    .container {
        width: 100%;
        max-width: 700px;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--container-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color);
        overflow: hidden;
    }
    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    .header-title { font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .settings-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary-color); }
    .settings-btn:hover { background-color: var(--option-hover); color: var(--accent-color); }
    .settings-btn svg { width: 22px; height: 22px; fill: currentColor; }

    main {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    #input-area { display: flex; flex-direction: column; gap: 20px; height: 100%; }
    .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .tab-btn { flex: 1; padding: 10px; font-size: 1rem; background: transparent; border: 1px solid transparent; border-radius: 8px; cursor: pointer; color: var(--text-secondary-color); font-weight: 500; }
    .tab-btn.active { color: var(--accent-color); background-color: var(--option-selected); border-color: var(--accent-color); }
    
    .tab-content { flex-grow: 1; display: flex; flex-direction: column; }
    #text-input-container { display: flex; flex-direction: column; height: 100%;}
    #product-description { flex-grow: 1; width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); resize: none; font-family: inherit; }
    #product-description:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 20%, transparent); }

    #image-input-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; height: 100%; }
    .image-upload-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; font-size: 1rem; font-weight: 500; border-radius: 8px; cursor: pointer; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
    .image-upload-btn:hover { background-color: var(--option-hover); }
    .image-upload-btn svg { width: 20px; height: 20px; fill: currentColor; }
    #image-preview-container { position: relative; width: 100%; max-width: 300px; }
    #image-preview { width: 100%; border-radius: 8px; border: 1px solid var(--border-color); }
    #clear-image-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background-color: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; font-size: 18px; line-height: 28px; text-align: center; }
    .paste-hint { font-size: 0.9rem; color: var(--text-secondary-color); margin-top: 10px; }
    
    .analyze-btn-container { margin-top: auto; padding-top: 15px; }
    #analyze-btn { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: bold; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 8px; cursor: pointer; }
    #analyze-btn:hover { background-color: var(--button-bg-hover); }
    #analyze-btn:disabled { background-color: var(--text-secondary-color); cursor: not-allowed; }

    #output-area { position: relative; }
    #new-request-btn { position: absolute; top: -10px; right: 0px; width: 44px; height: 44px; border-radius: 50%; background-color: var(--button-bg); color: var(--button-color); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px var(--shadow-color); z-index: 10;}
    #new-request-btn:hover { background-color: var(--button-bg-hover); transform: scale(1.05); }
    #new-request-btn svg { width: 24px; height: 24px; fill: currentColor; }

    #loading-indicator { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 20px; color: var(--text-secondary-color); }
    .typing-dot { width: 10px; height: 10px; background-color: var(--accent-color); border-radius: 50%; display: inline-block; animation: wave 1.5s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }

    #result-content { line-height: 1.6; }
    #result-content h2, #result-content h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 25px;
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 5px;
    }
    #result-content h2 { font-size: 1.5rem; color: var(--accent-color); }
    #result-content table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
    #result-content th, #result-content td { border: 1px solid var(--table-border-color); padding: 8px; text-align: left; }
    #result-content thead th { background-color: var(--table-header-bg); font-weight: 600; }
    #result-content tbody td:first-child { font-weight: 600; }
    #result-content p { margin-bottom: 10px; }
    /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
    #result-content strong { color: var(--accent-color); }
    #result-content .warning { color: var(--warning-color); font-weight: bold; }

    #charts-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin-top: 20px;
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--container-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px var(--shadow-color); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; }
    .modal-title { margin: 0; font-size: 1.2em; text-align: center; }
    .modal-group { display: flex; flex-direction: column; gap: 8px; }
    .modal-group label { font-size: 0.9em; color: var(--text-secondary-color); }
    .modal-select { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 8px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; }
    .modal-button { padding: 12px; background-color: var(--button-bg); color: var(--button-color); border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
    .modal-button:hover { background-color: var(--button-bg-hover); }

    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--notification-color); color: white; padding: 12px 18px; border-radius: 8px; font-size: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1001; opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
    .notification.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <div class="header-title">üß¨ AI Health Scanner</div>
            <button class="settings-btn" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23-.09.49 0 .61.22l-2 3.46c.12-.22.07-.49-.12.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </header>

        <main>
            <div id="input-area">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="text">–û–ø–∏—Å–∞–Ω–∏–µ</button>
                    <button class="tab-btn" data-tab="image">–§–æ—Ç–æ</button>
                </div>
                <div id="text-input-container" class="tab-content active">
                     <textarea id="product-description" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞, —Å–æ—Å—Ç–∞–≤ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –µ–≥–æ..."></textarea>
                </div>
                <div id="image-input-container" class="tab-content hidden">
                    <div id="image-preview-container" class="hidden">
                        <img id="image-preview" src="#" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
                        <button id="clear-image-btn" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">&times;</button>
                    </div>
                    <button class="image-upload-btn" id="upload-btn">
                        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 4h14v-2H5v2z"/></svg>
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </button>
                    <button class="image-upload-btn" id="camera-btn">
                        <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h4.05l1.83-2h4.24l1.83 2H20v12zM12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5 5-2.24-5-5-5zm0 8c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/></svg>
                        –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                    </button>
                    <p class="paste-hint">... –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ (Ctrl+V)</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">
                </div>

                <div class="analyze-btn-container">
                    <button id="analyze-btn">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>

            <div id="output-area" class="hidden">
                <button id="new-request-btn" title="–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å">
                     <svg viewBox="0 0 24 24"><path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/></svg>
                </button>
                <div id="loading-indicator">
                    <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é... </p>
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
                <div id="result-content"></div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="modal-group">
                <label for="model-select">–ú–æ–¥–µ–ª—å –ò–ò</label>
                <select id="model-select" class="modal-select"></select>
            </div>
            <div class="modal-group">
                <label for="api-mode-select">–¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                <select id="api-mode-select" class="modal-select"></select>
            </div>
            <button id="close-settings-btn" class="modal-button">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const VERCEL_PROXY_BASE_URL = "https://ver-olive-delta.vercel.app";
    const MAPRUAPP_PROXY_BASE_URL = "https://mapruapp.ru";

    const MODELS = [
        { id: "gemini-2.5-flash-lite-preview-06-17", uiName: "Gemini 2.5 Flash Lite (–±—ã—Å—Ç—Ä–∞—è)", apiType: "gemini" },
        { id: "gemini-2.5-flash", uiName: "Gemini 2.5 Flash", apiType: "gemini" },
    ];

    const API_MODES = {
        'mapruapp': {
            uiName: '–ü—Ä–æ–∫—Å–∏ (mapruapp)',
            url: () => `${MAPRUAPP_PROXY_BASE_URL}/ai/api/v1/chat/completions`
        },
        'vercel': {
            uiName: '–ü—Ä–æ–∫—Å–∏ (vercel)',
            url: (modelId) => `${VERCEL_PROXY_BASE_URL}/v1beta/models/${modelId}:generateContent`
        }
    };

    // =================================================================
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–º–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–≥–æ —Ç–æ–Ω–∞,
    // –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    // =================================================================
    const AI_SYSTEM_PROMPT = `
–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –æ–ø—ã—Ç–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç-–¥–∏–µ—Ç–æ–ª–æ–≥ –∏ BI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∏ –Ω–∞–≥–ª—è–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–∏—â–µ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, –∞ —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ä—ã–Ω–∫–µ, —Å—Ä–∞–≤–Ω–∏–≤ —Å 1-2 –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏.

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –°–¢–†–û–ì–û —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –¢–†–ï–• —á–∞—Å—Ç–µ–π:

### –ß–∞—Å—Ç—å 1: –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¢–∞–±–ª–∏—Ü–∞ Markdown)
–ù–∞–π–¥–∏ 1-2 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É, –≥–¥–µ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü ‚Äî —ç—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä, –≤—Ç–æ—Ä–æ–π ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, –∞ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã ‚Äî –¥–ª—è –∞–Ω–∞–ª–æ–≥–æ–≤. 
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ: "–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å (–Ω–∞ 100–≥)", "–ë–µ–ª–∫–∏ (–≥)", "–ñ–∏—Ä—ã (–≥)", "–£–≥–ª–µ–≤–æ–¥—ã (–≥)", "–°–∞—Ö–∞—Ä (–≥)", "–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω". –ï—Å–ª–∏ —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–∞—Ö–∞—Ä—É –Ω–µ—Ç, —Å–¥–µ–ª–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É.

### –ß–∞—Å—Ç—å 2: –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞ (–¢–µ–∫—Å—Ç)
–ù–∞–ø–∏—à–∏ 3-4 –∞–±–∑–∞—Ü–∞, –≥–¥–µ –¥–∞–π –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É –ø—Ä–æ–¥—É–∫—Ç—É. –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫.
- **–î–ª—è –∫–æ–≥–æ –ø–æ–ª–µ–∑–µ–Ω:** –ö–æ–º—É —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω.
- **–ö–æ–º—É —Å–ª–µ–¥—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å:** –ö–æ–º—É —Å—Ç–æ–∏—Ç —É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é. –î–ª—è –≤–∞–∂–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞, –∞–ª–ª–µ—Ä–≥–µ–Ω—ã) –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É: !!WARNING!!—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è!!/WARNING!!.
- **–û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç:** –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏.

### –ß–∞—Å—Ç—å 3: –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º (JSON)
–í –∫–æ–Ω—Ü–µ —Å–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –±–ª–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º. –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç –≤ \`\`\`json ... \`\`\`.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–µ–π:
{
  "products": ["–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∞ 1", "–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∞ 2"],
  "calories": [150, 180, 130],
  "sugar": [10, 22, 5],
  "fat": [8, 12, 6],
  "protein": [5, 3, 8]
}
–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π 0.
`;

    // --- DOM ELEMENTS and STATE ---
    const inputArea = document.getElementById('input-area');
    const outputArea = document.getElementById('output-area');
    const analyzeBtn = document.getElementById('analyze-btn');
    const newRequestBtn = document.getElementById('new-request-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultContent = document.getElementById('result-content');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const productDescription = document.getElementById('product-description');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const clearImageBtn = document.getElementById('clear-image-btn');
    const fileInput = document.getElementById('file-input');
    const cameraInput = document.getElementById('camera-input');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const modelSelect = document.getElementById('model-select');
    const apiModeSelect = document.getElementById('api-mode-select');

    let uploadedFileBase64 = null;
    let currentModelId = localStorage.getItem('scanner_model') || MODELS[0].id;
    let currentApiMode = localStorage.getItem('scanner_api_mode') || 'mapruapp';
    let activeCharts = [];

    function initializeApp() {
        setupEventListeners();
        populateSettings();
        loadSettings();
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-theme');
        }
    }

    function setupEventListeners() {
        tabBtns.forEach(btn => btn.addEventListener('click', handleTabClick));
        analyzeBtn.addEventListener('click', handleAnalyzeClick);
        newRequestBtn.addEventListener('click', handleNewRequestClick);
        fileInput.addEventListener('change', (e) => compressAndProcessImage(e.target.files[0]));
        cameraInput.addEventListener('change', (e) => compressAndProcessImage(e.target.files[0]));
        clearImageBtn.addEventListener('click', clearImage);
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) settingsModal.classList.add('hidden'); });
        modelSelect.addEventListener('change', (e) => {
            currentModelId = e.target.value;
            localStorage.setItem('scanner_model', currentModelId);
        });
        apiModeSelect.addEventListener('change', (e) => {
            currentApiMode = e.target.value;
            localStorage.setItem('scanner_api_mode', currentApiMode);
        });
        document.addEventListener('paste', handlePaste);
    }

    // --- UI & Image Processing ---
    function handleTabClick(e) {
        const targetTab = e.currentTarget.dataset.tab;
        tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
        tabContents.forEach(content => {
            content.classList.toggle('hidden', !content.id.startsWith(targetTab));
        });
    }
    
    function compressAndProcessImage(file) {
        if (!file) return;
        if (file.size > 15 * 1024 * 1024) {
            showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 15 –ú–ë)', true); return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const MAX_WIDTH = 1280, MAX_HEIGHT = 1280;
                let { width, height } = img;
                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.85);
                uploadedFileBase64 = compressedBase64;
                imagePreview.src = compressedBase64;
                imagePreviewContainer.classList.remove('hidden');
                showNotification(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ. –ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É.`);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function handlePaste(event) {
        if (!document.querySelector('.tab-btn[data-tab="image"]').classList.contains('active')) return;
        const items = (event.clipboardData || window.clipboardData)?.items;
        if (!items) return;
        for (const item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                if (file) {
                    event.preventDefault();
                    compressAndProcessImage(file);
                    break;
                }
            }
        }
    }

    function clearImage() {
        uploadedFileBase64 = null;
        imagePreview.src = '#';
        imagePreviewContainer.classList.add('hidden');
        fileInput.value = ''; cameraInput.value = '';
    }

    function switchView(view) {
        if (view === 'output') {
            inputArea.classList.add('hidden');
            outputArea.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            resultContent.innerHTML = '';
        } else {
            inputArea.classList.remove('hidden');
            outputArea.classList.add('hidden');
        }
    }

    function handleNewRequestClick() {
        clearImage();
        productDescription.value = '';
        activeCharts.forEach(chart => chart.destroy());
        activeCharts = [];
        switchView('input');
    }

    function populateSettings() {
        MODELS.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id; option.textContent = model.uiName;
            modelSelect.appendChild(option);
        });
        for (const mode in API_MODES) {
            const option = document.createElement('option');
            option.value = mode; option.textContent = API_MODES[mode].uiName;
            apiModeSelect.appendChild(option);
        }
    }

    function loadSettings() {
        modelSelect.value = currentModelId;
        apiModeSelect.value = currentApiMode;
    }

    function showNotification(message, isError = false, duration = 3000) {
        const notification = document.createElement('div');
        notification.className = 'notification'; notification.textContent = message;
        if (isError) notification.style.backgroundColor = '#d9534f';
        document.body.appendChild(notification);
        requestAnimationFrame(() => notification.classList.add('show'));
        setTimeout(() => {
            notification.classList.remove('show');
            notification.addEventListener('transitionend', () => notification.remove());
        }, duration);
    }
    
    // =================================================================
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    // =================================================================
    function renderFormattedResponse(md) {
        let html = '';
        const lines = md.split('\n');
        
        const sectionHeaders = {
            "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑": "üìä",
            "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞": "üë©‚Äç‚öïÔ∏è"
        };

        for (const line of lines) {
            if (line.startsWith('### –ß–∞—Å—Ç—å')) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏

            if (line.startsWith('|')) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
                if (!html.includes('<table>')) {
                    const headers = line.split('|').slice(1, -1).map(h => h.trim());
                    html += `<h2>${sectionHeaders["–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑"] || ''} –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2><table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                } else if (!line.includes('---')) {
                    const cells = line.split('|').slice(1, -1).map(c => c.trim());
                    html += `<tr>${cells.map((c, i) => i === 0 ? `<td><strong>${c}</strong></td>` : `<td>${c}</td>`).join('')}</tr>`;
                }
            } else {
                 if (html.includes('<tbody>')) { // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                    html += '</tbody></table>';
                }
                if (line.trim()) {
                    let processedLine = line.trim();
                    
                    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                    const headerKey = Object.keys(sectionHeaders).find(h => processedLine.includes(h));
                    if(headerKey) {
                        html += `<h3>${sectionHeaders[headerKey] || ''} ${headerKey}</h3>`;
                        continue;
                    }
                    
                    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
                    processedLine = processedLine
                        .replace(/!!WARNING!!(.*?)!!\/WARNING!!/g, '<span class="warning">$1</span>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    html += `<p>${processedLine}</p>`;
                }
            }
        }
        if (html.includes('<tbody>')) html += '</tbody></table>';
        return html;
    }

    function renderCharts(data) {
        const chartsContainer = document.createElement('div');
        chartsContainer.id = 'charts-container';
        
        const chartColors = {
            main: 'rgba(26, 115, 232, 0.8)',
            analog1: 'rgba(255, 159, 64, 0.8)',
            analog2: 'rgba(75, 192, 192, 0.8)',
            sugar: 'rgba(239, 83, 80, 0.8)',
            fat: 'rgba(255, 193, 7, 0.8)',
            protein: 'rgba(102, 187, 106, 0.8)'
        };
        const isDarkMode = document.body.classList.contains('dark-theme');
        Chart.defaults.color = isDarkMode ? '#a9c2d5' : '#5f6368';

        const chartConfigs = [
            { id: 'calories-chart', title: '–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å (–∫–∫–∞–ª)', key: 'calories', colors: [chartColors.main, chartColors.analog1, chartColors.analog2]},
            { id: 'sugarfat-chart', title: '–°–∞—Ö–∞—Ä –∏ –ñ–∏—Ä—ã (–≥)', keys: ['sugar', 'fat'], labels:['–°–∞—Ö–∞—Ä', '–ñ–∏—Ä—ã'], colors:[chartColors.sugar, chartColors.fat]},
            { id: 'protein-chart', title: '–ë–µ–ª–∫–∏ (–≥)', key: 'protein', colors: [chartColors.protein, chartColors.protein, chartColors.protein] }
        ];

        chartConfigs.forEach(config => {
            const canvas = document.createElement('canvas');
            chartsContainer.appendChild(canvas);

            const datasets = [];
            if (config.key) {
                 datasets.push({
                    label: config.title,
                    data: data[config.key],
                    backgroundColor: config.colors.slice(0, data.products.length)
                });
            } else {
                config.keys.forEach((key, index) => {
                    datasets.push({
                        label: config.labels[index],
                        data: data[key],
                        backgroundColor: config.colors[index]
                    });
                });
            }

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: { labels: data.products, datasets: datasets },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: config.title } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            activeCharts.push(chart);
        });

        const chartsHeader = document.createElement('h3');
        chartsHeader.innerHTML = `üìà –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã`;
        resultContent.appendChild(chartsHeader);
        resultContent.appendChild(chartsContainer);
    }

    // --- API & LOGIC ---
    async function handleAnalyzeClick() {
        // ... (–∫–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è userParts –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        let userParts = [];

        if (activeTab === 'text') {
            const text = productDescription.value.trim();
            if (!text) { showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞.', true); return; }
            userParts.push({ text: text });
        } else {
            if (!uploadedFileBase64) { showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ.', true); return; }
            const mimeType = uploadedFileBase64.match(/data:(.*);base64,/)[1];
            const base64Data = uploadedFileBase64.split(',')[1];
            userParts.push({ inlineData: { mimeType, data: base64Data } });
            userParts.push({ text: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–¥—É–∫—Ç –Ω–∞ —ç—Ç–æ–π —ç—Ç–∏–∫–µ—Ç–∫–µ." });
        }

        switchView('output');
        analyzeBtn.disabled = true;

        try {
            const model = MODELS.find(m => m.id === currentModelId);
            if (!model) throw new Error('–í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

            let apiUrl, requestBody, fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' } };

            if (currentApiMode === 'mapruapp') {
                apiUrl = API_MODES.mapruapp.url();
                const messages = [{
                    role: 'system', content: AI_SYSTEM_PROMPT
                }, {
                    role: 'user', content: userParts.map(part => {
                        if (part.text) return { type: 'text', text: part.text };
                        if (part.inlineData) return { type: 'image_url', image_url: { url: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}` } };
                    }).filter(Boolean)
                }];
                requestBody = { model: model.id, messages: messages, max_tokens: 4096 };
            } else {
                apiUrl = API_MODES.vercel.url(model.id);
                requestBody = { 
                    contents: [{ role: 'user', parts: [{ text: AI_SYSTEM_PROMPT }, ...userParts] }] 
                };
            }

            fetchOptions.body = JSON.stringify(requestBody);
            const response = await fetch(apiUrl, fetchOptions);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} ${errorText}`);
            }

            const data = await response.json();
            let botReplyText = (currentApiMode === 'mapruapp') 
                ? data.choices?.[0]?.message?.content 
                : data.candidates?.[0]?.content?.parts.map(p => p.text || '').join('');

            if (!botReplyText) throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API');
            
            loadingIndicator.classList.add('hidden');
            
            const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
            const jsonMatch = botReplyText.match(jsonRegex);
            const markdownText = botReplyText.replace(jsonRegex, '').trim();
            
            resultContent.innerHTML = renderFormattedResponse(markdownText);
            
            if (jsonMatch && jsonMatch[1]) {
                try {
                    const chartData = JSON.parse(jsonMatch[1]);
                    renderCharts(chartData);
                } catch (e) {
                    console.error("Failed to parse JSON for charts:", e);
                    resultContent.innerHTML += `<p class="warning">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞.</p>`;
                }
            }

        } catch (error) {
            console.error(error);
            loadingIndicator.classList.add('hidden');
            resultContent.innerHTML = `<p class="warning"><strong>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:</strong> ${error.message}</p>`;
        } finally {
            analyzeBtn.disabled = false;
        }
    }
    
    initializeApp();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица</title>
    <link rel="icon" href="https://i.ibb.co/B28zDrny/excel.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #217346;
            --primary-hover: #1e5c39;
            --primary-light: #e8f5e9;
            --header-bg: #217346;
            --header-text: #ffffff;
            --row-even: #fafafa;
            --row-hover: #f0f7f0;
            --border-color: #e5e5e5;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #007aff;
            --danger-color: #ff3b30;
            --danger-hover: #d70015;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-secondary);
            user-select: none;
            font-size: 14px;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        .ribbon {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .ribbon-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 4px 8px;
            border-right: 1px solid var(--border-color);
        }
        
        .ribbon-group:last-child {
            border-right: none;
        }
        
        .ribbon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            font-size: 11px;
            color: var(--text-primary);
            transition: all 0.2s ease;
            min-width: 56px;
        }
        
        .ribbon-btn:hover {
            background: var(--bg-secondary);
        }
        
        .ribbon-btn:active {
            background: var(--border-color);
            transform: scale(0.97);
        }
        
        .ribbon-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .ribbon-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color);
        }
        
        .ribbon-btn span {
            font-size: 11px;
        }
        
        .ribbon-btn#ai-btn svg {
            fill: var(--accent-blue);
        }
        
        .ribbon-btn#ai-btn:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .ribbon-btn-toggle.active {
            background: var(--primary-light);
        }
        
        .ribbon-btn-toggle.active svg {
            fill: var(--primary-color);
        }
        
        .ribbon-btn-toggle.active span {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        #file-input {
            display: none;
        }
        
        .table-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 8px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .table-header-container {
            flex-shrink: 0;
            overflow: hidden;
            background: var(--header-bg);
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }
        
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            min-width: 80px;
        }
        
        th {
            background: var(--header-bg);
            color: var(--header-text);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-color: rgba(255,255,255,0.15);
            position: relative;
        }
        
        th .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        th .header-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .sort-icon, .filter-icon {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .sort-icon:hover, .filter-icon:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
        }
        
        .sort-icon.asc::after {
            content: '▲';
            font-size: 10px;
        }
        
        .sort-icon.desc::after {
            content: '▼';
            font-size: 10px;
        }
        
        .sort-icon:not(.asc):not(.desc)::after {
            content: '⇅';
            font-size: 11px;
            opacity: 0.5;
        }
        
        .filter-icon::after {
            content: '▼';
            font-size: 8px;
        }
        
        .filter-icon.active {
            color: #ffd700;
            opacity: 1;
        }
        
        .filter-icon.active::after {
            content: '▼';
        }
        
        tbody tr {
            transition: background-color 0.15s ease;
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--row-even);
        }
        
        tbody tr:hover {
            background-color: var(--row-hover);
        }
        
        tbody tr.selected {
            background-color: #d4edda !important;
        }
        
        td {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        td.editing {
            padding: 2px;
        }
        
        td.editing input {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }
        
        .row-number {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 11px;
            text-align: center;
            min-width: 50px !important;
            max-width: 50px !important;
            width: 50px !important;
            border-right: 2px solid var(--border-color);
        }
        
        th.row-number {
            background: rgba(0,0,0,0.1);
            color: var(--header-text);
        }
        
        .status-bar {
            background: var(--bg-primary);
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-item.clickable {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 3px;
            transition: background 0.15s;
        }
        
        .status-item.clickable:hover {
            background: rgba(0,0,0,0.08);
        }
        
        #sheet-selector {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-primary);
            cursor: pointer;
        }
        
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #filter-input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            width: 200px;
            background: var(--bg-primary);
            transition: all 0.2s;
        }
        
        #filter-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .filter-mode-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(14px);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 40px;
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .empty-state h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .empty-state-btn {
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .empty-state-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        
        .loader-overlay.active {
            display: flex;
        }
        
        .loader-spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader-text {
            font-size: 15px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .loader-progress {
            width: 280px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loader-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            min-width: 380px;
            max-width: 90vw;
            max-height: 85vh;
            overflow: hidden;
            flex-direction: column;
        }
        
        .dialog-header {
            padding: 16px 20px;
            background: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .dialog-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .dialog-footer {
            padding: 14px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dialog-btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .dialog-btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .dialog-btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .dialog-btn-secondary:hover {
            background: var(--bg-secondary);
        }
        
        .dialog-btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .dialog-btn-danger:hover {
            background: var(--danger-hover);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            transition: all 0.2s;
        }
        
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="password"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .form-radio input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .preview-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            max-height: 140px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }
        
        .context-menu {
            display: none;
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            padding: 6px 0;
            min-width: 180px;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.1s;
        }
        
        .context-menu-item:hover {
            background: var(--bg-secondary);
        }
        
        .context-menu-item svg {
            width: 16px;
            height: 16px;
            fill: var(--text-secondary);
        }
        
        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 6px 0;
        }
        
        .filter-dropdown {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            width: 280px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .filter-dropdown-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filter-dropdown-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .filter-dropdown-search:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .filter-dropdown-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            max-height: 240px;
        }
        
        .filter-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.1s;
        }
        
        .filter-dropdown-item:hover {
            background: var(--bg-secondary);
        }
        
        .filter-dropdown-item input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }
        
        .filter-dropdown-item.select-all {
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            padding-bottom: 12px;
        }
        
        .filter-dropdown-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .filter-dropdown-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .filter-dropdown-footer .btn-apply {
            background: var(--primary-color);
            color: white;
        }
        
        .filter-dropdown-footer .btn-apply:hover {
            background: var(--primary-hover);
        }
        
        .filter-dropdown-footer .btn-reset {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .filter-dropdown-footer .btn-reset:hover {
            background: var(--border-color);
        }
        
        .column-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .column-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .column-list-item:last-child {
            border-bottom: none;
        }
        
        .column-list-item:hover {
            background: var(--bg-secondary);
        }
        
        .column-list-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .column-list-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .column-list-actions button {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }
        
        .column-list-actions button:hover {
            background: var(--bg-secondary);
        }
        
        .hidden-columns-badge {
            background: var(--warning-color);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .shortcut-hint {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: auto;
        }
        
        .column-resizer {
            position: absolute;
            top: 0;
            right: -4px;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
            user-select: none;
            background: transparent;
            transition: background 0.15s;
        }
        
        .column-resizer:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .column-resizer:active {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .resize-line {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent-blue);
            box-shadow: 0 0 8px rgba(0, 122, 255, 0.5);
            z-index: 9999;
            pointer-events: none;
            display: none;
        }
        
        .table-container.manual-width {
            overflow-x: auto;
        }
        
        .table-container.manual-width table {
            table-layout: fixed;
            width: max-content;
            min-width: 100%;
        }
        
        .table-container.manual-width th:not(.row-number),
        .table-container.manual-width td:not(.row-number) {
            min-width: 40px;
            max-width: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-sizing: border-box;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .ai-panel {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 440px;
            max-height: 600px;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            z-index: 1500;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .ai-panel.active {
            display: flex;
        }
        
        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
        }
        
        .ai-panel-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .ai-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .ai-panel-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .ai-panel-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .ai-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 180px;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
            background: var(--bg-primary);
        }
        
        .ai-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .ai-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .ai-checkbox-group input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }
        
        .ai-checkbox-group span {
            font-size: 14px;
        }
        
        .ai-checkbox-group small {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: auto;
        }
        
        .ai-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .ai-example-btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-example-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .ai-settings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-settings-toggle:hover {
            background: var(--bg-secondary);
            color: var(--accent-blue);
        }
        
        .ai-settings-panel {
            display: none;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .ai-settings-panel.active {
            display: block;
        }
        
        .ai-settings-panel .form-group {
            margin-bottom: 14px;
        }
        
        .ai-settings-panel .form-group:last-child {
            margin-bottom: 0;
        }
        
        .ai-settings-panel label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .ai-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            color: var(--text-secondary);
        }
        
        .ai-loading.active {
            display: flex;
        }
        
        .ai-loading i {
            font-size: 20px;
            color: var(--accent-blue);
        }
        
        .ai-response-area {
            display: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            max-height: 180px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .ai-response-area.active {
            display: block;
        }
        
        .ai-response-area.error {
            background: #fff2f2;
            color: #d00;
            border: 1px solid #ffcdd2;
        }
        
        .ai-response-area.success {
            background: #f0fff4;
            color: #1b7a1b;
            border: 1px solid #a5d6a7;
        }
        
        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }
        
        .ai-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .ai-btn-primary {
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
        }
        
        .ai-btn-primary:hover {
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
            transform: translateY(-1px);
        }
        
        .ai-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .ai-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .ai-btn-secondary:hover {
            background: var(--border-color);
        }
        
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fa-spin {
            animation: fa-spin 1s linear infinite;
        }
        
        @media print {
            .ribbon, .status-bar, .ai-panel { display: none !important; }
            body, .container { background: white !important; height: auto !important; }
            .table-wrapper { margin: 0; box-shadow: none; }
        }
        
        @media (max-width: 768px) {
            .ribbon { padding: 6px 10px; }
            .ribbon-btn { min-width: 48px; padding: 6px 8px; }
            .ribbon-btn span { display: none; }
            .ai-panel { width: calc(100vw - 20px); right: 10px; bottom: 10px; }
        }
        
        
                /* DEBUG */
        .table-container {
            border: 2px solid red !important;
        }
        .virtual-scroll-container {
            border: 2px solid blue !important;
        }
        .virtual-scroll-content {
            border: 2px solid green !important;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="ribbon">
            <div class="ribbon-group">
                <button class="ribbon-btn" id="open-btn" title="Открыть файл (Ctrl+O)">
                    <svg viewBox="0 0 24 24"><path d="M19 20H5c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h6l2 2h6c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2z"/></svg>
                    <span>Открыть</span>
                </button>
                <button class="ribbon-btn" id="save-btn" title="Сохранить (Ctrl+S)">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    <span>Сохранить</span>
                </button>
                <button class="ribbon-btn" id="save-as-btn" title="Сохранить как...">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/><path d="M12 18l4-4h-3V9h-2v5H8z" fill="white"/></svg>
                    <span>Сохранить как</span>
                </button>
            </div>
            
            <div class="ribbon-group">
                <button class="ribbon-btn" id="create-btn" title="Создать новый файл (Ctrl+N)">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <span>Создать</span>
                </button>
                <button class="ribbon-btn ribbon-btn-toggle active" id="autosize-btn" title="Автоматический размер столбцов">
                    <svg viewBox="0 0 24 24"><path d="M4 11h6V9H4v2zm0 4h6v-2H4v2zm0 4h6v-2H4v2zm16-4h-6v2h6v-2zm-6-8v2h6V7h-6zm6 8h-6v2h6v-2zM11 7h2v10h-2z"/></svg>
                    <span>Авторазмер</span>
                </button>
            </div>

            <div class="ribbon-group">
                <button class="ribbon-btn" id="undo-btn" title="Отменить (Ctrl+Z)">
                    <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05 1.04-6.93 2.73L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                    <span>Отменить</span>
                </button>
                <button class="ribbon-btn" id="redo-btn" title="Повторить (Ctrl+Y)">
                    <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                    <span>Повторить</span>
                </button>
            </div>
            
            <div class="ribbon-group">
                <button class="ribbon-btn" id="columns-btn" title="Скрыть/показать столбцы">
                    <svg viewBox="0 0 24 24"><path d="M10 18h5V5h-5v13zm-6 0h5V5H4v13zM16 5v13h5V5h-5z"/></svg>
                    <span>Столбцы</span>
                </button>
                <button class="ribbon-btn" id="sort-btn" title="Сброс сортировки">
                    <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></svg>
                    <span>Сортировка</span>
                </button>
            </div>
            
            <div class="ribbon-group">
                <button class="ribbon-btn" id="ai-btn" title="AI Помощник">
                    <svg viewBox="0 0 24 24" style="fill: #007aff;"><circle cx="12" cy="12" r="3"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5" transform="rotate(60 12 12)"/><ellipse cx="12" cy="12" rx="10" ry="4" fill="none" stroke="#007aff" stroke-width="1.5" transform="rotate(-60 12 12)"/></svg>
                    <span>AI</span>
                </button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept=".csv,.txt,.xlsx">
        
        <div class="table-wrapper">
            <div class="empty-state" id="empty-state">
                <img src="https://i.ibb.co/B28zDrny/excel.png" alt="Excel" class="empty-state-icon">
                <h2>Нет открытых файлов</h2>
                <p>Нажмите, чтобы открыть CSV, TXT или Excel файл</p>
                <button class="empty-state-btn" id="open-file-btn">Открыть файл</button>
            </div>
            
            <div class="table-header-container" id="table-header-container" style="display: none;">
                <table id="header-table">
                    <thead>
                        <tr id="header-row"></tr>
                    </thead>
                </table>
            </div>
            
            <div class="table-container" id="table-container" style="display: none;">
                <div class="virtual-scroll-container" id="virtual-scroll-container">
                    <div class="virtual-scroll-content" id="virtual-scroll-content">
                        <table id="data-table">
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-bar-left">
                <select id="sheet-selector" style="display: none;"></select>
                <span id="status-message">Готов</span>
                <span id="hidden-columns-indicator" style="display: none;">
                    <span class="hidden-columns-badge" id="hidden-columns-count">0 скрыто</span>
                </span>
            </div>
            <div class="status-bar-right">
                <div class="filter-bar">
                    <input type="text" id="filter-input" placeholder="Поиск...">
                    <div class="filter-mode-toggle">
                        <span>ячейка</span>
                        <label class="switch">
                            <input type="checkbox" id="filter-mode-toggle">
                            <span class="slider"></span>
                        </label>
                        <span>строка</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loader-overlay" id="loader-overlay">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">Загрузка...</div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loader-progress-bar"></div>
        </div>
        <div class="loader-details" id="loader-details"></div>
    </div>
    
    <div class="dialog-overlay" id="dialog-overlay"></div>
    
    <div class="dialog" id="separator-dialog" style="display: none;">
        <div class="dialog-header">Параметры импорта</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Разделитель</label>
                <div class="form-radio-group">
                    <label class="form-radio">
                        <input type="radio" name="separator" value=","> Запятая (,)
                    </label>
                    <label class="form-radio">
                        <input type="radio" name="separator" value=";" checked> Точка с запятой (;)
                    </label>
                    <label class="form-radio">
                        <input type="radio" name="separator" value="\t"> Табуляция
                    </label>
                    <label class="form-radio">
                        <input type="radio" name="separator" value=" "> Пробел
                    </label>
                    <label class="form-radio">
                        <input type="radio" name="separator" value="custom"> Другой:
                        <input type="text" id="custom-separator" style="width: 50px; margin-left: 8px;" maxlength="1">
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="first-row-header" checked>
                    Первая строка — заголовки
                </label>
            </div>
            <div class="form-group">
                <label>Кодировка</label>
                <select id="encoding-select">
                    <option value="utf-8" selected>UTF-8</option>
                    <option value="windows-1251">Windows-1251 (ANSI)</option>
                </select>
            </div>
            <div class="preview-box" id="preview"></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="separator-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="separator-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="save-dialog" style="display: none;">
        <div class="dialog-header">Сохранить файл</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Формат файла</label>
                <select id="save-format">
                    <option value="csv">CSV</option>
                    <option value="txt">TXT</option>
                    <option value="xlsx">Excel (XLSX)</option>
                </select>
            </div>
            <div class="form-group" id="save-separator-group">
                <label>Разделитель</label>
                <select id="save-separator">
                    <option value=";">Точка с запятой (;)</option>
                    <option value=",">Запятая (,)</option>
                    <option value="\t">Табуляция</option>
                    <option value=" ">Пробел</option>
                    <option value="custom">Другой</option>
                </select>
                <input type="text" id="save-custom-separator" style="width: 50px; margin-top: 8px; display: none;" maxlength="1" placeholder="...">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="save-visible-only">
                    Сохранить только видимые столбцы
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="save-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="save-confirm">Сохранить</button>
        </div>
    </div>
    
    <div class="dialog" id="rename-dialog" style="display: none;">
        <div class="dialog-header">Переименовать столбец</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Новое название</label>
                <input type="text" id="rename-input">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="rename-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="rename-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="columns-dialog" style="display: none;">
        <div class="dialog-header">Скрыть/показать столбцы</div>
        <div class="dialog-body">
            <div class="column-list-actions">
                <button id="columns-show-all">Показать все</button>
                <button id="columns-hide-all">Скрыть все</button>
                <button id="columns-invert">Инвертировать</button>
            </div>
            <div class="column-list" id="column-list"></div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="columns-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="columns-confirm">Применить</button>
        </div>
    </div>
    
    <div class="dialog" id="move-column-dialog" style="display: none;">
        <div class="dialog-header">Переместить столбец</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Переместить перед столбцом:</label>
                <select id="move-column-select"></select>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="move-column-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="move-column-confirm">Переместить</button>
        </div>
    </div>
    
    <div class="dialog" id="move-row-dialog" style="display: none;">
        <div class="dialog-header">Переместить строку</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Переместить перед строкой:</label>
                <select id="move-row-select"></select>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="move-row-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="move-row-confirm">Переместить</button>
        </div>
    </div>
    
    <div class="dialog" id="create-dialog" style="display: none;">
        <div class="dialog-header">Создать новый файл</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Количество строк:</label>
                <input type="number" id="create-rows" value="10" min="1" max="100000" step="1">
            </div>
            <div class="form-group">
                <label>Количество столбцов:</label>
                <input type="number" id="create-cols" value="5" min="1" max="100" step="1">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="create-with-headers" checked>
                    Создать с заголовками
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="create-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="create-confirm">Создать</button>
        </div>
    </div>
    
    <div class="dialog" id="replace-empty-dialog" style="display: none;">
        <div class="dialog-header">Заменить пустые значения</div>
        <div class="dialog-body">
            <div class="form-group">
                <label>Заменить на:</label>
                <input type="text" id="replace-empty-input">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="dialog-btn dialog-btn-secondary" id="replace-empty-cancel">Отмена</button>
            <button class="dialog-btn dialog-btn-primary" id="replace-empty-confirm">Применить</button>
        </div>
    </div>
    
    <div class="resize-line" id="resize-line"></div>
    
    <div class="context-menu" id="context-menu"></div>

    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
            <h3><i class="fas fa-atom"></i> AI Помощник</h3>
            <button class="ai-panel-close" id="ai-panel-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-panel-body">
            <textarea class="ai-textarea" id="ai-query" placeholder="Опишите задачу для таблицы..."></textarea>
            
            <label class="ai-checkbox-group">
                <input type="checkbox" id="ai-include-data" checked>
                <span>Отправить данные таблицы</span>
                <small id="ai-data-info">0 строк</small>
            </label>
            
            <div class="ai-examples">
                <button class="ai-example-btn" data-prompt="Заполни пустые ячейки логичными значениями">Заполнить пустые</button>
                <button class="ai-example-btn" data-prompt="Добавь столбец с категориями на основе данных">Категории</button>
                <button class="ai-example-btn" data-prompt="Исправь опечатки в данных">Опечатки</button>
                <button class="ai-example-btn" data-prompt="Проанализируй данные и дай отчет">Анализ</button>
            </div>
            
            <button class="ai-settings-toggle" id="ai-settings-toggle">
                <i class="fas fa-cog"></i> Настройки
            </button>
            
            <div class="ai-settings-panel" id="ai-settings-panel">
                <div class="form-group">
                    <label>Модель</label>
                    <select id="ai-model-selector"></select>
                </div>
                <div class="form-group">
                    <label>Режим</label>
                    <select id="ai-mode-selector"></select>
                </div>
                <div class="form-group" id="ai-key-group" style="display:none;">
                    <label>API ключ</label>
                    <input type="password" id="ai-api-key" placeholder="Ключ...">
                </div>
            </div>
            
            <div class="ai-loading" id="ai-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Обработка...</span>
            </div>
            
            <div class="ai-response-area" id="ai-response"></div>
            
            <div class="ai-actions">
                <button class="ai-btn ai-btn-secondary" id="ai-cancel" style="display:none;">Отмена</button>
                <button class="ai-btn ai-btn-primary" id="ai-send">
                    <i class="fas fa-paper-plane"></i> Отправить
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var fileInput = document.getElementById('file-input');
        var emptyState = document.getElementById('empty-state');
        var tableHeaderContainer = document.getElementById('table-header-container');
        var tableContainer = document.getElementById('table-container');
        var virtualScrollContainer = document.getElementById('virtual-scroll-container');
        var virtualScrollContent = document.getElementById('virtual-scroll-content');
        var headerRow = document.getElementById('header-row');
        var tableBody = document.getElementById('table-body');
        var statusMessage = document.getElementById('status-message');
        var sheetSelector = document.getElementById('sheet-selector');
        var filterInput = document.getElementById('filter-input');
        var filterModeToggle = document.getElementById('filter-mode-toggle');
        var dialogOverlay = document.getElementById('dialog-overlay');
        var contextMenu = document.getElementById('context-menu');
        var loaderOverlay = document.getElementById('loader-overlay');
        var loaderText = document.getElementById('loader-text');
        var loaderProgressBar = document.getElementById('loader-progress-bar');
        var loaderDetails = document.getElementById('loader-details');
        var hiddenColumnsIndicator = document.getElementById('hidden-columns-indicator');
        var hiddenColumnsCount = document.getElementById('hidden-columns-count');

        var allData = [];
        var filteredIndices = [];
        var headers = [];
        var hiddenColumns = new Set();
        var activeFilters = {};
        var sortState = { column: null, direction: null };
        var currentSeparator = ';';
        var currentFilename = null;
        var currentFileSize = null;
        var workbook = null;
        var modified = false;
        var autoSizeEnabled = true;
        var columnWidths = {};
        var isResizing = false;
        var resizingColumn = null;
        var startX = 0;
        var startWidth = 0;
        var undoStack = [];
        var redoStack = [];
        var MAX_HISTORY = 50;
        var ROW_HEIGHT = 36;
        var BUFFER_ROWS = 10;
        var visibleStartIndex = 0;
        var visibleEndIndex = 0;
        var contextTarget = { type: null, index: null, rowIndex: null, colIndex: null };

                var savedAutoSize = localStorage.getItem('autoSizeEnabled');
        console.log('=== INIT: localStorage ===');
        console.log('savedAutoSize:', savedAutoSize);
        if (savedAutoSize !== null) {
            autoSizeEnabled = savedAutoSize === 'true';
        }
        console.log('autoSizeEnabled:', autoSizeEnabled);
        
        var savedWidths = localStorage.getItem('columnWidths');
        console.log('savedWidths:', savedWidths);
        if (savedWidths) {
            try {
                columnWidths = JSON.parse(savedWidths);
            } catch (e) {
                columnWidths = {};
            }
        }
        console.log('columnWidths:', columnWidths);
        console.log('columnWidths keys:', Object.keys(columnWidths).length);
        
        // Исправление: если ручной режим, но нет сохраненных ширин - включаем авторазмер
        if (!autoSizeEnabled && Object.keys(columnWidths).length === 0) {
            console.log('FIX: Включаем авторазмер т.к. нет сохраненных ширин');
            autoSizeEnabled = true;
            localStorage.setItem('autoSizeEnabled', 'true');
        }

        function showLoader(text, details) {
            loaderText.textContent = text || 'Загрузка...';
            loaderDetails.textContent = details || '';
            loaderProgressBar.style.width = '0%';
            loaderOverlay.classList.add('active');
        }
        
        function updateLoader(text, progress, details) {
            if (text) loaderText.textContent = text;
            if (details) loaderDetails.textContent = details;
            if (progress !== undefined) {
                loaderProgressBar.style.width = progress + '%';
            }
        }
        
        function hideLoader() {
            loaderOverlay.classList.remove('active');
        }

        function showDialog(dialogId) {
            dialogOverlay.style.display = 'block';
            document.getElementById(dialogId).style.display = 'flex';
        }
        
        function hideDialog(dialogId) {
            dialogOverlay.style.display = 'none';
            document.getElementById(dialogId).style.display = 'none';
        }
        
        function hideAllDialogs() {
            dialogOverlay.style.display = 'none';
            var dialogs = document.querySelectorAll('.dialog');
            for (var i = 0; i < dialogs.length; i++) {
                dialogs[i].style.display = 'none';
            }
        }

        function saveState(action, data) {
            undoStack.push({ action: action, data: data, timestamp: Date.now() });
            if (undoStack.length > MAX_HISTORY) undoStack.shift();
            redoStack = [];
            modified = true;
            updateUndoRedoButtons();
        }
        
        function undo() {
            if (undoStack.length === 0) return;
            var state = undoStack.pop();
            redoStack.push(state);
            applyUndo(state);
            updateUndoRedoButtons();
        }
        
        function redo() {
            if (redoStack.length === 0) return;
            var state = redoStack.pop();
            undoStack.push(state);
            applyRedo(state);
            updateUndoRedoButtons();
        }
        
        function applyUndo(state) {
            switch (state.action) {
                case 'editCell':
                    allData[state.data.row][state.data.col] = state.data.oldValue;
                    break;
                case 'deleteRow':
                    allData.splice(state.data.index, 0, state.data.row);
                    break;
                case 'insertRow':
                    allData.splice(state.data.index, 1);
                    break;
                case 'deleteColumn':
                    headers.splice(state.data.index, 0, state.data.header);
                    for (var i = 0; i < allData.length; i++) {
                        allData[i].splice(state.data.index, 0, state.data.values[i]);
                    }
                    break;
                case 'insertColumn':
                    headers.splice(state.data.index, 1);
                    for (var i = 0; i < allData.length; i++) {
                        allData[i].splice(state.data.index, 1);
                    }
                    break;
                case 'renameColumn':
                    headers[state.data.index] = state.data.oldName;
                    break;
            }
            applyFiltersAndSort();
            renderTable();
            updateStatus('Отменено: ' + getActionDescription(state.action));
        }
        
        function applyRedo(state) {
            switch (state.action) {
                case 'editCell':
                    allData[state.data.row][state.data.col] = state.data.newValue;
                    break;
                case 'deleteRow':
                    allData.splice(state.data.index, 1);
                    break;
                case 'insertRow':
                    allData.splice(state.data.index, 0, state.data.row);
                    break;
                case 'deleteColumn':
                    headers.splice(state.data.index, 1);
                    for (var i = 0; i < allData.length; i++) {
                        allData[i].splice(state.data.index, 1);
                    }
                    break;
                case 'insertColumn':
                    headers.splice(state.data.index, 0, state.data.header);
                    for (var i = 0; i < allData.length; i++) {
                        allData[i].splice(state.data.index, 0, state.data.values[i]);
                    }
                    break;
                case 'renameColumn':
                    headers[state.data.index] = state.data.newName;
                    break;
            }
            applyFiltersAndSort();
            renderTable();
            updateStatus('Повторено: ' + getActionDescription(state.action));
        }
        
        function getActionDescription(action) {
            var descriptions = {
                editCell: 'редактирование ячейки',
                deleteRow: 'удаление строки',
                insertRow: 'вставка строки',
                deleteColumn: 'удаление столбца',
                insertColumn: 'вставка столбца',
                renameColumn: 'переименование столбца'
            };
            return descriptions[action] || action;
        }
        
        function updateUndoRedoButtons() {
            var undoBtn = document.getElementById('undo-btn');
            var redoBtn = document.getElementById('redo-btn');
            if (undoStack.length === 0) {
                undoBtn.classList.add('disabled');
            } else {
                undoBtn.classList.remove('disabled');
            }
            if (redoStack.length === 0) {
                redoBtn.classList.add('disabled');
            } else {
                redoBtn.classList.remove('disabled');
            }
        }

        function processFile(file) {
            if (!file) return;
            
            var fileName = file.name.toLowerCase();
            currentFilename = file.name;
            currentFileSize = Math.round(file.size / 1024);
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                processExcelFile(file);
            } else {
                showSeparatorDialog(file);
            }
        }
        
        function processExcelFile(file) {
            showLoader('Чтение Excel файла...', file.name);
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateLoader('Парсинг данных...', 30);
                    workbook = XLSX.read(e.target.result, { type: 'array' });
                    
                    sheetSelector.innerHTML = '';
                    for (var i = 0; i < workbook.SheetNames.length; i++) {
                        var name = workbook.SheetNames[i];
                        var option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelector.appendChild(option);
                    }
                    
                    if (workbook.SheetNames.length > 1) {
                        sheetSelector.style.display = 'inline-block';
                    } else {
                        sheetSelector.style.display = 'none';
                    }
                    
                    loadSheet(workbook.SheetNames[0]);
                } catch (error) {
                    hideLoader();
                    alert('Ошибка при чтении Excel файла: ' + error.message);
                }
            };
            reader.onerror = function() {
                hideLoader();
                alert('Ошибка чтения файла');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function isEmptyValue(value) {
            return value === '' || value === null || value === undefined || String(value).trim() === '';
        }

        function removeEmptyColumns(hdrs, data) {
            var columnsToKeep = [];
            
            for (var colIndex = 0; colIndex < hdrs.length; colIndex++) {
                var hasContent = false;
                for (var rowIndex = 0; rowIndex < data.length; rowIndex++) {
                    if (!isEmptyValue(data[rowIndex][colIndex])) {
                        hasContent = true;
                        break;
                    }
                }
                if (hasContent) {
                    columnsToKeep.push(colIndex);
                }
            }
            
            var newHeaders = [];
            for (var i = 0; i < columnsToKeep.length; i++) {
                newHeaders.push(hdrs[columnsToKeep[i]]);
            }
            
            var newData = [];
            for (var r = 0; r < data.length; r++) {
                var newRow = [];
                for (var c = 0; c < columnsToKeep.length; c++) {
                    newRow.push(data[r][columnsToKeep[c]]);
                }
                newData.push(newRow);
            }
            
            return { headers: newHeaders, data: newData, removed: hdrs.length - columnsToKeep.length };
        }

        function removeEmptyRows(data) {
            var filteredData = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var hasContent = false;
                for (var j = 0; j < row.length; j++) {
                    if (!isEmptyValue(row[j])) {
                        hasContent = true;
                        break;
                    }
                }
                if (hasContent) {
                    filteredData.push(row);
                }
            }
            return { data: filteredData, removed: data.length - filteredData.length };
        }

        function createNewFile(rows, cols, withHeaders) {
            console.log('=== createNewFile ===');
            console.log('rows:', rows, 'cols:', cols, 'withHeaders:', withHeaders);
            
            headers = [];
            for (var i = 0; i < cols; i++) {
                headers.push(withHeaders ? 'Столбец ' + (i + 1) : 'Столбец ' + (i + 1));
            }
            console.log('headers created:', headers.length);
            
            allData = [];
            for (var i = 0; i < rows; i++) {
                var row = [];
                for (var j = 0; j < cols; j++) {
                    row.push('');
                }
                allData.push(row);
            }
            console.log('allData created:', allData.length, 'rows');
            
            resetFiltersAndSort();
            console.log('filteredIndices:', filteredIndices.length);
            
            currentFilename = null;
            currentFileSize = null;
            workbook = null;
            modified = false;
            undoStack = [];
            redoStack = [];
            
            columnWidths = {};
            localStorage.removeItem('columnWidths');
            
            autoSizeEnabled = true;
            localStorage.setItem('autoSizeEnabled', 'true');
            var autosizeBtn = document.getElementById('autosize-btn');
            if (autosizeBtn) {
                autosizeBtn.classList.add('active');
            }
            console.log('autoSizeEnabled set to:', autoSizeEnabled);
            
            initializeTable();
            updateStatus('Создан новый файл: ' + rows + ' строк × ' + cols + ' столбцов');
        }

        function loadSheet(sheetName) {
            updateLoader('Загрузка листа: ' + sheetName, 50);
            
            var worksheet = workbook.Sheets[sheetName];
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            
            if (jsonData.length === 0) {
                hideLoader();
                alert('Лист пуст');
                return;
            }
            
            var tempHeaders = [];
            for (var i = 0; i < jsonData[0].length; i++) {
                tempHeaders.push(String(jsonData[0][i] || ''));
            }
            var tempData = jsonData.slice(1);
            
            updateLoader('Удаление пустых строк...', 60);
            var rowResult = removeEmptyRows(tempData);
            tempData = rowResult.data;
            
            updateLoader('Удаление пустых столбцов...', 70);
            var colResult = removeEmptyColumns(tempHeaders, tempData);
            headers = colResult.headers;
            tempData = colResult.data;
            
            if (headers.length === 0 || tempData.length === 0) {
                hideLoader();
                alert('Лист не содержит данных после удаления пустых строк и столбцов');
                return;
            }
            
            allData = [];
            var totalRows = tempData.length;
            
            processDataChunks(tempData, totalRows, function() {
                resetFiltersAndSort();
                initializeTable();
                hideLoader();
                
                var statusMsg = 'Загружен лист "' + sheetName + '"';
                if (rowResult.removed > 0 || colResult.removed > 0) {
                    statusMsg += ' (удалено пустых: ' + rowResult.removed + ' строк, ' + colResult.removed + ' столбцов)';
                }
                updateStatus(statusMsg);
            });
        }
        
        function processDataChunks(rows, total, callback) {
            var CHUNK_SIZE = 5000;
            var index = 0;
            
            function processChunk() {
                var end = Math.min(index + CHUNK_SIZE, rows.length);
                
                for (var i = index; i < end; i++) {
                    var row = rows[i];
                    var filledRow = [];
                    for (var j = 0; j < headers.length; j++) {
                        filledRow.push(row[j] !== undefined ? String(row[j]) : '');
                    }
                    allData.push(filledRow);
                }
                
                index = end;
                var progress = Math.round((index / total) * 100);
                updateLoader('Обработка данных...', 50 + progress * 0.4, index.toLocaleString() + ' / ' + total.toLocaleString() + ' строк');
                
                if (index < rows.length) {
                    requestAnimationFrame(processChunk);
                } else {
                    callback();
                }
            }
            
            processChunk();
        }
        
        function showSeparatorDialog(file) {
            var preview = document.getElementById('preview');
            var encodingSelect = document.getElementById('encoding-select');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var decoder = new TextDecoder(encodingSelect.value);
                var content = decoder.decode(new Uint8Array(e.target.result));
                var lines = content.split(/\r?\n/).slice(0, 10);
                preview.textContent = lines.join('\n');
            };
            reader.readAsArrayBuffer(file);
            
            encodingSelect.onchange = function() {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var decoder = new TextDecoder(encodingSelect.value);
                    var content = decoder.decode(new Uint8Array(e.target.result));
                    var lines = content.split(/\r?\n/).slice(0, 10);
                    preview.textContent = lines.join('\n');
                };
                reader.readAsArrayBuffer(file);
            };
            
            showDialog('separator-dialog');
            fileInput._pendingFile = file;
        }
        
        function processCSVFile(file, separator, encoding, firstRowHeader) {
            showLoader('Чтение файла...', file.name);
            
            var reader = new FileReader();
            reader.onload = function(e) {
                updateLoader('Декодирование...', 20);
                
                var decoder = new TextDecoder(encoding);
                var content = decoder.decode(new Uint8Array(e.target.result));
                
                updateLoader('Парсинг CSV...', 40);
                
                var lines = content.split(/\r?\n/);
                var filteredLines = [];
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        filteredLines.push(lines[i]);
                    }
                }
                lines = filteredLines;
                
                if (lines.length === 0) {
                    hideLoader();
                    alert('Файл пуст');
                    return;
                }
                
                currentSeparator = separator;
                
                if (firstRowHeader) {
                    headers = parseCSVLine(lines[0], separator);
                    parseCSVData(lines.slice(1), separator, function() {
                        updateLoader('Удаление пустых строк...', 85);
                        var rowResult = removeEmptyRows(allData);
                        allData = rowResult.data;
                        
                        updateLoader('Удаление пустых столбцов...', 90);
                        var colResult = removeEmptyColumns(headers, allData);
                        headers = colResult.headers;
                        allData = colResult.data;
                        
                        resetFiltersAndSort();
                        initializeTable();
                        hideLoader();
                        
                        var statusMsg = 'Загружен файл "' + file.name + '"';
                        if (rowResult.removed > 0 || colResult.removed > 0) {
                            statusMsg += ' (удалено: ' + rowResult.removed + ' строк, ' + colResult.removed + ' столбцов)';
                        }
                        updateStatus(statusMsg);
                    });
                } else {
                    var firstRow = parseCSVLine(lines[0], separator);
                    headers = [];
                    for (var i = 0; i < firstRow.length; i++) {
                        headers.push('Столбец ' + (i + 1));
                    }
                    parseCSVData(lines, separator, function() {
                        updateLoader('Удаление пустых строк...', 85);
                        var rowResult = removeEmptyRows(allData);
                        allData = rowResult.data;
                        
                        updateLoader('Удаление пустых столбцов...', 90);
                        var colResult = removeEmptyColumns(headers, allData);
                        headers = colResult.headers;
                        allData = colResult.data;
                        
                        resetFiltersAndSort();
                        initializeTable();
                        hideLoader();
                        
                        var statusMsg = 'Загружен файл "' + file.name + '"';
                        if (rowResult.removed > 0 || colResult.removed > 0) {
                            statusMsg += ' (удалено: ' + rowResult.removed + ' строк, ' + colResult.removed + ' столбцов)';
                        }
                        updateStatus(statusMsg);
                    });
                }
            };
            reader.onerror = function() {
                hideLoader();
                alert('Ошибка чтения файла');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseCSVLine(line, separator) {
            var result = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === separator && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        function parseCSVData(lines, separator, callback) {
            allData = [];
            var total = lines.length;
            var CHUNK_SIZE = 5000;
            var index = 0;
            
            function processChunk() {
                var end = Math.min(index + CHUNK_SIZE, lines.length);
                
                for (var i = index; i < end; i++) {
                    if (!lines[i].trim()) continue;
                    var row = parseCSVLine(lines[i], separator);
                    while (row.length < headers.length) row.push('');
                    allData.push(row);
                }
                
                index = end;
                var progress = Math.round((index / total) * 100);
                updateLoader('Парсинг данных...', 40 + progress * 0.5, index.toLocaleString() + ' / ' + total.toLocaleString() + ' строк');
                
                if (index < lines.length) {
                    requestAnimationFrame(processChunk);
                } else {
                    callback();
                }
            }
            
            processChunk();
        }

        function resetFiltersAndSort() {
            activeFilters = {};
            sortState = { column: null, direction: null };
            hiddenColumns.clear();
            filteredIndices = [];
            for (var i = 0; i < allData.length; i++) {
                filteredIndices.push(i);
            }
            columnWidths = {};
            localStorage.removeItem('columnWidths');
        }
        
        function applyFiltersAndSort() {
            var globalFilter = filterInput.value.trim().toLowerCase();
            var globalMode = filterModeToggle.checked ? 'row' : 'cell';
            var globalTerms = globalFilter.split(/\s+/);
            var filteredTerms = [];
            for (var i = 0; i < globalTerms.length; i++) {
                if (globalTerms[i]) filteredTerms.push(globalTerms[i]);
            }
            globalTerms = filteredTerms;
            
            filteredIndices = [];
            
            for (var i = 0; i < allData.length; i++) {
                var row = allData[i];
                var visible = true;
                
                for (var colIndex in activeFilters) {
                    var allowedValues = activeFilters[colIndex];
                    if (allowedValues.length === 0) {
                        visible = false;
                        break;
                    }
                    var found = false;
                    for (var v = 0; v < allowedValues.length; v++) {
                        if (allowedValues[v] === row[colIndex]) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        visible = false;
                        break;
                    }
                }
                
                if (visible && globalTerms.length > 0) {
                    if (globalMode === 'cell') {
                        var matchInCell = false;
                        for (var c = 0; c < row.length; c++) {
                            var cellStr = String(row[c]).toLowerCase();
                            var allMatch = true;
                            for (var t = 0; t < globalTerms.length; t++) {
                                if (cellStr.indexOf(globalTerms[t]) === -1) {
                                    allMatch = false;
                                    break;
                                }
                            }
                            if (allMatch) {
                                matchInCell = true;
                                break;
                            }
                        }
                        visible = matchInCell;
                    } else {
                        var rowStr = row.join(' ').toLowerCase();
                        var allMatch = true;
                        for (var t = 0; t < globalTerms.length; t++) {
                            if (rowStr.indexOf(globalTerms[t]) === -1) {
                                allMatch = false;
                                break;
                            }
                        }
                        visible = allMatch;
                    }
                }
                
                if (visible) {
                    filteredIndices.push(i);
                }
            }
            
            if (sortState.column !== null && sortState.direction) {
                var col = sortState.column;
                var dir = sortState.direction === 'asc' ? 1 : -1;
                
                filteredIndices.sort(function(a, b) {
                    var valA = allData[a][col];
                    var valB = allData[b][col];
                    
                    var numA = parseFloat(valA);
                    var numB = parseFloat(valB);
                    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return (numA - numB) * dir;
                    }
                    
                    return String(valA).localeCompare(String(valB), 'ru') * dir;
                });
            }
        }
        
        var filterDebounceTimer = null;
        
        function onFilterInput() {
            clearTimeout(filterDebounceTimer);
            
            if (allData.length <= 5000) {
                applyFiltersAndSort();
                renderVisibleRows();
                updateStatus();
            } else {
                filterDebounceTimer = setTimeout(function() {
                    showLoader('Фильтрация...', '');
                    requestAnimationFrame(function() {
                        applyFiltersAndSort();
                        renderVisibleRows();
                        updateStatus();
                        hideLoader();
                    });
                }, 300);
            }
        }

        function createColGroup(tableId) {
            var table = document.getElementById(tableId);
            var oldColgroup = table.querySelector('colgroup');
            if (oldColgroup) oldColgroup.remove();
            
            var colgroup = document.createElement('colgroup');
            
            var colNum = document.createElement('col');
            colNum.style.width = '50px';
            colNum.className = 'col-row-number';
            colgroup.appendChild(colNum);
            
            var visibleCols = 0;
            for (var i = 0; i < headers.length; i++) {
                if (!hiddenColumns.has(i)) visibleCols++;
            }
            
            var containerWidth = document.querySelector('.table-container');
            var availableWidth = containerWidth ? containerWidth.clientWidth - 70 : 1200;
            var defaultWidth = Math.max(100, Math.floor(availableWidth / visibleCols));
            
            for (var index = 0; index < headers.length; index++) {
                if (hiddenColumns.has(index)) continue;
                
                var col = document.createElement('col');
                col.dataset.colIndex = index;
                var width = columnWidths[index] || defaultWidth;
                col.style.width = width + 'px';
                colgroup.appendChild(col);
            }
            
            table.insertBefore(colgroup, table.firstChild);
            return colgroup;
        }

        function updateColWidths(colIndex, width) {
            var tables = ['header-table', 'data-table'];
            for (var t = 0; t < tables.length; t++) {
                var col = document.querySelector('#' + tables[t] + ' colgroup col[data-col-index="' + colIndex + '"]');
                if (col) {
                    col.style.width = width + 'px';
                }
            }
        }

        function addColumnResizers() {
            var resizers = document.querySelectorAll('.column-resizer');
            for (var r = 0; r < resizers.length; r++) {
                resizers[r].remove();
            }
            
            createColGroup('header-table');
            createColGroup('data-table');
            
            var headerCells = document.querySelectorAll('#header-table thead th[data-col-index]');
            
            for (var i = 0; i < headerCells.length; i++) {
                var th = headerCells[i];
                var dataIndex = parseInt(th.dataset.colIndex);
                
                th.style.position = 'relative';
                
                var resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                resizer.dataset.columnIndex = dataIndex;
                
                (function(colIndex) {
                    resizer.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        startColumnResize(e, colIndex);
                    });
                })(dataIndex);
                
                th.appendChild(resizer);
            }
        }

        var resizeState = {
            active: false,
            colIndex: null,
            startX: 0,
            startWidth: 0
        };

        function startColumnResize(e, colIndex) {
            var col = document.querySelector('#header-table colgroup col[data-col-index="' + colIndex + '"]');
            if (!col) return;
            
            var currentWidth = parseInt(col.style.width) || 150;
            
            resizeState = {
                active: true,
                colIndex: colIndex,
                startX: e.pageX,
                startWidth: currentWidth
            };
            
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            
            var resizeLine = document.getElementById('resize-line');
            resizeLine.style.left = e.pageX + 'px';
            resizeLine.style.display = 'block';
            
            document.addEventListener('mousemove', onColumnResizeMove);
            document.addEventListener('mouseup', onColumnResizeEnd);
        }

        function onColumnResizeMove(e) {
            if (!resizeState.active) return;
            
            var diff = e.pageX - resizeState.startX;
            var newWidth = Math.max(40, resizeState.startWidth + diff);
            
            var resizeLine = document.getElementById('resize-line');
            resizeLine.style.left = e.pageX + 'px';
            
            updateColWidths(resizeState.colIndex, newWidth);
            
            var th = document.querySelector('#header-table thead th[data-col-index="' + resizeState.colIndex + '"]');
            if (th) {
                th.style.background = 'rgba(33, 115, 70, 0.3)';
            }
        }

        function onColumnResizeEnd(e) {
            if (!resizeState.active) return;
            
            var diff = e.pageX - resizeState.startX;
            var finalWidth = Math.max(40, resizeState.startWidth + diff);
            
            columnWidths[resizeState.colIndex] = finalWidth;
            localStorage.setItem('columnWidths', JSON.stringify(columnWidths));
            
            updateColWidths(resizeState.colIndex, finalWidth);
            
            var th = document.querySelector('#header-table thead th[data-col-index="' + resizeState.colIndex + '"]');
            if (th) {
                th.style.background = '';
            }
            
            var resizeLine = document.getElementById('resize-line');
            resizeLine.style.display = 'none';
            
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            resizeState.active = false;
            
            document.removeEventListener('mousemove', onColumnResizeMove);
            document.removeEventListener('mouseup', onColumnResizeEnd);
        }

        function applyColumnWidths() {
            createColGroup('header-table');
            createColGroup('data-table');
        }

        function toggleAutoSize() {
            autoSizeEnabled = !autoSizeEnabled;
            var btn = document.getElementById('autosize-btn');
            var container = document.querySelector('.table-container');
            
            if (autoSizeEnabled) {
                btn.classList.add('active');
                container.classList.remove('manual-width');
                
                var resizers = document.querySelectorAll('.column-resizer');
                for (var r = 0; r < resizers.length; r++) {
                    resizers[r].remove();
                }
                var colgroups = document.querySelectorAll('colgroup');
                for (var c = 0; c < colgroups.length; c++) {
                    colgroups[c].remove();
                }
                
                updateStatus('Авторазмер включен');
            } else {
                btn.classList.remove('active');
                container.classList.add('manual-width');
                
                setTimeout(function() {
                    addColumnResizers();
                }, 50);
                
                updateStatus('Ручное изменение ширины столбцов');
            }
            
            localStorage.setItem('autoSizeEnabled', autoSizeEnabled);
        }

        function initializeTable() {
            console.log('=== initializeTable ===');
            console.log('headers:', headers.length);
            console.log('allData:', allData.length);
            console.log('autoSizeEnabled:', autoSizeEnabled);
            
            applyFiltersAndSort();
            console.log('filteredIndices after filter:', filteredIndices.length);
            
            emptyState.style.display = 'none';
            tableHeaderContainer.style.display = 'block';
            tableContainer.style.display = 'block';
            
            console.log('tableContainer display:', tableContainer.style.display);
            console.log('tableContainer offsetHeight:', tableContainer.offsetHeight);
            console.log('tableContainer clientHeight:', tableContainer.clientHeight);
            
            renderHeader();
            console.log('header rendered');
            
            setupVirtualScroll();
            console.log('virtual scroll setup');
            
            renderVisibleRows();
            console.log('visible rows rendered');
            
            updateStatus();
            updateHiddenColumnsIndicator();
            
            var container = document.querySelector('.table-container');
            var autosizeBtn = document.getElementById('autosize-btn');
            
            console.log('container classList before:', container.className);
            
            if (!autoSizeEnabled) {
                container.classList.add('manual-width');
                if (autosizeBtn) autosizeBtn.classList.remove('active');
                setTimeout(function() {
                    addColumnResizers();
                }, 50);
            } else {
                container.classList.remove('manual-width');
                if (autosizeBtn) autosizeBtn.classList.add('active');
                var colgroups = document.querySelectorAll('colgroup');
                for (var i = 0; i < colgroups.length; i++) {
                    colgroups[i].remove();
                }
            }
            
            console.log('container classList after:', container.className);
        }
        
        function renderHeader() {
            headerRow.innerHTML = '';
            
            var thNum = document.createElement('th');
            thNum.className = 'row-number';
            thNum.textContent = '#';
            headerRow.appendChild(thNum);
            
            for (var index = 0; index < headers.length; index++) {
                if (hiddenColumns.has(index)) continue;
                
                var header = headers[index];
                var th = document.createElement('th');
                th.dataset.colIndex = index;
                
                var content = document.createElement('div');
                content.className = 'header-content';
                
                var title = document.createElement('span');
                title.className = 'header-title';
                title.textContent = header || ('Столбец ' + (index + 1));
                
                var actions = document.createElement('div');
                actions.className = 'header-actions';
                
                var sortIcon = document.createElement('span');
                sortIcon.className = 'sort-icon';
                if (sortState.column === index) {
                    sortIcon.classList.add(sortState.direction);
                }
                (function(idx) {
                    sortIcon.onclick = function(e) {
                        e.stopPropagation();
                        toggleSort(idx);
                    };
                })(index);
                
                var filterIcon = document.createElement('span');
                filterIcon.className = 'filter-icon';
                if (activeFilters[index]) {
                    filterIcon.classList.add('active');
                }
                (function(idx, icon) {
                    filterIcon.onclick = function(e) {
                        e.stopPropagation();
                        showColumnFilterDropdown(idx, icon);
                    };
                })(index, filterIcon);
                
                actions.appendChild(sortIcon);
                actions.appendChild(filterIcon);
                content.appendChild(title);
                content.appendChild(actions);
                th.appendChild(content);
                
                headerRow.appendChild(th);
            }
            
            syncHeaderWidth();
        }
        
        function syncHeaderWidth() {
            var headerTable = document.getElementById('header-table');
            var dataTable = document.getElementById('data-table');
            var totalWidth = Math.max(virtualScrollContainer.scrollWidth, virtualScrollContainer.clientWidth);
            headerTable.style.width = totalWidth + 'px';
            dataTable.style.width = totalWidth + 'px';
        }
        
        function setupVirtualScroll() {
            var totalHeight = filteredIndices.length * ROW_HEIGHT;
            virtualScrollContent.style.height = totalHeight + 'px';
            
            virtualScrollContainer.onscroll = function() {
                renderVisibleRows();
                tableHeaderContainer.scrollLeft = virtualScrollContainer.scrollLeft;
            };
        }
        
        function renderVisibleRows() {
            var scrollTop = virtualScrollContainer.scrollTop;
            var containerHeight = virtualScrollContainer.clientHeight;
            
            console.log('=== renderVisibleRows ===');
            console.log('scrollTop:', scrollTop);
            console.log('containerHeight:', containerHeight);
            console.log('filteredIndices.length:', filteredIndices.length);
            console.log('ROW_HEIGHT:', ROW_HEIGHT);
            
            visibleStartIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_ROWS);
            visibleEndIndex = Math.min(
                filteredIndices.length,
                Math.ceil((scrollTop + containerHeight) / ROW_HEIGHT) + BUFFER_ROWS
            );
            
            console.log('visibleStartIndex:', visibleStartIndex);
            console.log('visibleEndIndex:', visibleEndIndex);
            
            var totalHeight = filteredIndices.length * ROW_HEIGHT;
            virtualScrollContent.style.height = totalHeight + 'px';
            console.log('totalHeight:', totalHeight);
            
            var offsetY = visibleStartIndex * ROW_HEIGHT;
            tableBody.style.transform = 'translateY(' + offsetY + 'px)';
            
            tableBody.innerHTML = '';
            
            var visibleCols = [];
            for (var i = 0; i < headers.length; i++) {
                if (!hiddenColumns.has(i)) {
                    visibleCols.push(i);
                }
            }
            console.log('visibleCols:', visibleCols.length);
            
            var rowsRendered = 0;
            for (var i = visibleStartIndex; i < visibleEndIndex; i++) {
                var dataIndex = filteredIndices[i];
                if (dataIndex === undefined) continue;
                
                var row = allData[dataIndex];
                var tr = document.createElement('tr');
                tr.dataset.dataIndex = dataIndex;
                tr.dataset.visibleIndex = i;
                
                var tdNum = document.createElement('td');
                tdNum.className = 'row-number';
                tdNum.textContent = dataIndex + 1;
                tr.appendChild(tdNum);
                
                for (var c = 0; c < visibleCols.length; c++) {
                    var colIndex = visibleCols[c];
                    var td = document.createElement('td');
                    td.dataset.row = dataIndex;
                    td.dataset.col = colIndex;
                    td.textContent = row[colIndex] || '';
                    (function(tdEl, rIdx, cIdx) {
                        tdEl.ondblclick = function() {
                            editCell(tdEl, rIdx, cIdx);
                        };
                    })(td, dataIndex, colIndex);
                    tr.appendChild(td);
                }
                
                tableBody.appendChild(tr);
                rowsRendered++;
            }
            
            console.log('rowsRendered:', rowsRendered);
            console.log('tableBody children:', tableBody.children.length);
        }
        
        function renderTable() {
            renderHeader();
            setupVirtualScroll();
            renderVisibleRows();
        }

        function editCell(td, rowIndex, colIndex) {
            if (td.classList.contains('editing')) return;
            
            var oldValue = allData[rowIndex][colIndex];
            
            td.classList.add('editing');
            var input = document.createElement('input');
            input.type = 'text';
            input.value = oldValue;
            td.textContent = '';
            td.appendChild(input);
            input.focus();
            input.select();
            
            var finishEdit = function() {
                var newValue = input.value;
                td.classList.remove('editing');
                td.textContent = newValue;
                
                if (newValue !== oldValue) {
                    saveState('editCell', { row: rowIndex, col: colIndex, oldValue: oldValue, newValue: newValue });
                    allData[rowIndex][colIndex] = newValue;
                    updateStatus('Ячейка изменена');
                }
            };
            
            input.onblur = finishEdit;
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEdit();
                } else if (e.key === 'Escape') {
                    td.classList.remove('editing');
                    td.textContent = oldValue;
                }
            };
        }

        function toggleSort(colIndex) {
            if (sortState.column === colIndex) {
                if (sortState.direction === 'asc') {
                    sortState.direction = 'desc';
                } else if (sortState.direction === 'desc') {
                    sortState.column = null;
                    sortState.direction = null;
                } else {
                    sortState.direction = 'asc';
                }
            } else {
                sortState.column = colIndex;
                sortState.direction = 'asc';
            }
            
            if (allData.length > 10000) {
                showLoader('Сортировка...', '');
                requestAnimationFrame(function() {
                    applyFiltersAndSort();
                    renderTable();
                    updateStatus();
                    hideLoader();
                });
            } else {
                applyFiltersAndSort();
                renderTable();
                updateStatus();
            }
        }

        var currentFilterDropdown = null;
        
        function closeFilterDropdown() {
            if (currentFilterDropdown) {
                currentFilterDropdown.remove();
                currentFilterDropdown = null;
            }
        }
        
        function showColumnFilterDropdown(colIndex, iconElement) {
            closeFilterDropdown();
            
            var valuesSet = new Set();
            var maxValues = Math.min(allData.length, 10000);
            
            for (var i = 0; i < maxValues; i++) {
                valuesSet.add(allData[i][colIndex]);
            }
            
            var uniqueValues = Array.from(valuesSet).sort(function(a, b) {
                if (a === '') return 1;
                if (b === '') return -1;
                return String(a).localeCompare(String(b), 'ru');
            });
            
            var currentFilter = activeFilters[colIndex];
            
            var dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown';
            dropdown.onclick = function(e) { e.stopPropagation(); };
            
            var header = document.createElement('div');
            header.className = 'filter-dropdown-header';
            var searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.className = 'filter-dropdown-search';
            searchInput.placeholder = 'Поиск...';
            header.appendChild(searchInput);
            dropdown.appendChild(header);
            
            var list = document.createElement('div');
            list.className = 'filter-dropdown-list';
            
            var selectAllItem = document.createElement('label');
            selectAllItem.className = 'filter-dropdown-item select-all';
            var selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.checked = !currentFilter;
            selectAllItem.appendChild(selectAllCheckbox);
            selectAllItem.appendChild(document.createTextNode('(Выбрать все)'));
            list.appendChild(selectAllItem);
            
            var valueCheckboxes = [];
            for (var v = 0; v < uniqueValues.length; v++) {
                var value = uniqueValues[v];
                var item = document.createElement('label');
                item.className = 'filter-dropdown-item';
                item.dataset.value = value;
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                var isChecked = !currentFilter;
                if (currentFilter) {
                    for (var f = 0; f < currentFilter.length; f++) {
                        if (currentFilter[f] === value) {
                            isChecked = true;
                            break;
                        }
                    }
                }
                checkbox.checked = isChecked;
                checkbox.dataset.value = value;
                valueCheckboxes.push(checkbox);
                
                item.appendChild(checkbox);
                item.appendChild(document.createTextNode(value === '' ? '(Пустые)' : value));
                list.appendChild(item);
            }
            
            dropdown.appendChild(list);
            
            var footer = document.createElement('div');
            footer.className = 'filter-dropdown-footer';
            
            var resetBtn = document.createElement('button');
            resetBtn.className = 'btn-reset';
            resetBtn.textContent = 'Сбросить';
            
            var applyBtn = document.createElement('button');
            applyBtn.className = 'btn-apply';
            applyBtn.textContent = 'Применить';
            
            footer.appendChild(resetBtn);
            footer.appendChild(applyBtn);
            dropdown.appendChild(footer);
            
            document.body.appendChild(dropdown);
            var rect = iconElement.getBoundingClientRect();
            dropdown.style.left = Math.min(rect.left, window.innerWidth - 290) + 'px';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            
            currentFilterDropdown = dropdown;
            
            function updateSelectAll() {
                var visibleCheckboxes = [];
                for (var i = 0; i < valueCheckboxes.length; i++) {
                    var cb = valueCheckboxes[i];
                    if (cb.closest('.filter-dropdown-item').style.display !== 'none') {
                        visibleCheckboxes.push(cb);
                    }
                }
                var checkedCount = 0;
                for (var i = 0; i < visibleCheckboxes.length; i++) {
                    if (visibleCheckboxes[i].checked) checkedCount++;
                }
                
                if (checkedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedCount === visibleCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
            
            selectAllCheckbox.onchange = function() {
                var visibleCheckboxes = [];
                for (var i = 0; i < valueCheckboxes.length; i++) {
                    var cb = valueCheckboxes[i];
                    if (cb.closest('.filter-dropdown-item').style.display !== 'none') {
                        visibleCheckboxes.push(cb);
                    }
                }
                for (var i = 0; i < visibleCheckboxes.length; i++) {
                    visibleCheckboxes[i].checked = selectAllCheckbox.checked;
                }
            };
            
            for (var i = 0; i < valueCheckboxes.length; i++) {
                valueCheckboxes[i].onchange = updateSelectAll;
            }
            
            searchInput.oninput = function() {
                var searchText = searchInput.value.toLowerCase();
                for (var i = 0; i < valueCheckboxes.length; i++) {
                    var cb = valueCheckboxes[i];
                    var item = cb.closest('.filter-dropdown-item');
                    var text = item.textContent.toLowerCase();
                    item.style.display = text.indexOf(searchText) !== -1 ? '' : 'none';
                }
                updateSelectAll();
            };
            
            resetBtn.onclick = function() {
                delete activeFilters[colIndex];
                iconElement.classList.remove('active');
                closeFilterDropdown();
                
                if (allData.length > 10000) {
                    showLoader('Применение фильтра...', '');
                    requestAnimationFrame(function() {
                        applyFiltersAndSort();
                        renderVisibleRows();
                        updateStatus();
                        hideLoader();
                    });
                } else {
                    applyFiltersAndSort();
                    renderVisibleRows();
                    updateStatus();
                }
            };
            
            applyBtn.onclick = function() {
                var selectedValues = [];
                for (var i = 0; i < valueCheckboxes.length; i++) {
                    if (valueCheckboxes[i].checked) {
                        selectedValues.push(valueCheckboxes[i].dataset.value);
                    }
                }
                
                if (selectedValues.length === 0) {
                    activeFilters[colIndex] = [];
                    iconElement.classList.add('active');
                } else if (selectedValues.length === uniqueValues.length) {
                    delete activeFilters[colIndex];
                    iconElement.classList.remove('active');
                } else {
                    activeFilters[colIndex] = selectedValues;
                    iconElement.classList.add('active');
                }
                
                closeFilterDropdown();
                
                if (allData.length > 10000) {
                    showLoader('Применение фильтра...', '');
                    requestAnimationFrame(function() {
                        applyFiltersAndSort();
                        renderVisibleRows();
                        updateStatus();
                        hideLoader();
                    });
                } else {
                    applyFiltersAndSort();
                    renderVisibleRows();
                    updateStatus();
                }
            };
            
            updateSelectAll();
        }

        function showColumnsDialog() {
            var list = document.getElementById('column-list');
            list.innerHTML = '';
            
            for (var index = 0; index < headers.length; index++) {
                var header = headers[index];
                var item = document.createElement('label');
                item.className = 'column-list-item';
                
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !hiddenColumns.has(index);
                checkbox.dataset.index = index;
                
                item.appendChild(checkbox);
                item.appendChild(document.createTextNode(header || ('Столбец ' + (index + 1))));
                list.appendChild(item);
            }
            
            showDialog('columns-dialog');
        }
        
        function updateHiddenColumnsIndicator() {
            if (hiddenColumns.size > 0) {
                hiddenColumnsIndicator.style.display = 'inline';
                hiddenColumnsCount.textContent = hiddenColumns.size + ' скрыто';
            } else {
                hiddenColumnsIndicator.style.display = 'none';
            }
        }

        function showContextMenu(e) {
            e.preventDefault();
            hideContextMenu();
            closeFilterDropdown();
            
            contextMenu.innerHTML = '';
            
            var target = e.target.closest('th, td');
            
            if (!target) {
                if (currentFilename || allData.length > 0) {
                    addContextMenuItem('Сохранить', 'Ctrl+S', function() { saveFile(); });
                    addContextMenuItem('Сохранить как...', '', function() { showDialog('save-dialog'); });
                } else {
                    addContextMenuItem('Открыть файл', 'Ctrl+O', function() { fileInput.click(); });
                }
            } else if (target.tagName === 'TH' && !target.classList.contains('row-number')) {
                var colIndex = parseInt(target.dataset.colIndex);
                contextTarget = { type: 'header', colIndex: colIndex };
                
                addContextMenuItem('Переименовать столбец', '', function() { showRenameDialog(colIndex); });
                addContextMenuItem('Скрыть столбец', '', function() { hideColumn(colIndex); });
                addContextMenuSeparator();
                addContextMenuItem('Вставить столбец слева', '', function() { insertColumn(colIndex); });
                addContextMenuItem('Вставить столбец справа', '', function() { insertColumn(colIndex + 1); });
                addContextMenuSeparator();
                addContextMenuItem('Заменить пустые...', '', function() { showReplaceEmptyDialog(colIndex); });
                addContextMenuItem('Переместить столбец...', '', function() { showMoveColumnDialog(colIndex); });
                addContextMenuSeparator();
                addContextMenuItem('Удалить столбец', '', function() { deleteColumn(colIndex); });
            } else if (target.tagName === 'TD' && !target.classList.contains('row-number')) {
                var rowIndex = parseInt(target.dataset.row);
                var colIndex = parseInt(target.dataset.col);
                contextTarget = { type: 'cell', rowIndex: rowIndex, colIndex: colIndex };
                
                addContextMenuItem('Копировать ячейку', '', function() { copyToClipboard(allData[rowIndex][colIndex]); });
                addContextMenuItem('Копировать строку', '', function() { copyToClipboard(allData[rowIndex].join('\t')); });
                addContextMenuItem('Редактировать', '', function() { editCell(target, rowIndex, colIndex); });
                addContextMenuSeparator();
                addContextMenuItem('Вставить строку выше', '', function() { insertRow(rowIndex); });
                addContextMenuItem('Вставить строку ниже', '', function() { insertRow(rowIndex + 1); });
                addContextMenuSeparator();
                addContextMenuItem('Переместить строку...', '', function() { showMoveRowDialog(rowIndex); });
                addContextMenuItem('Удалить строку', '', function() { deleteRow(rowIndex); });
            } else if (target.classList.contains('row-number') && target.tagName === 'TD') {
                var tr = target.closest('tr');
                var rowIndex = parseInt(tr.dataset.dataIndex);
                contextTarget = { type: 'row', rowIndex: rowIndex };
                
                addContextMenuItem('Копировать строку', '', function() { copyToClipboard(allData[rowIndex].join('\t')); });
                addContextMenuSeparator();
                addContextMenuItem('Вставить строку выше', '', function() { insertRow(rowIndex); });
                addContextMenuItem('Вставить строку ниже', '', function() { insertRow(rowIndex + 1); });
                addContextMenuSeparator();
                addContextMenuItem('Переместить строку...', '', function() { showMoveRowDialog(rowIndex); });
                addContextMenuItem('Удалить строку', '', function() { deleteRow(rowIndex); });
            }
            
            if (contextMenu.children.length === 0) return;
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            
            var rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (e.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (e.pageY - rect.height) + 'px';
            }
        }
        
        function addContextMenuItem(text, shortcut, handler) {
            var item = document.createElement('div');
            item.className = 'context-menu-item';
            
            var textSpan = document.createElement('span');
            textSpan.textContent = text;
            item.appendChild(textSpan);
            
            if (shortcut) {
                var shortcutSpan = document.createElement('span');
                shortcutSpan.className = 'shortcut-hint';
                shortcutSpan.textContent = shortcut;
                item.appendChild(shortcutSpan);
            }
            
            item.onclick = function() {
                hideContextMenu();
                handler();
            };
            
            contextMenu.appendChild(item);
        }
        
        function addContextMenuSeparator() {
            var sep = document.createElement('div');
            sep.className = 'context-menu-separator';
            contextMenu.appendChild(sep);
        }
        
        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        function insertColumn(index) {
            var newHeader = 'Столбец ' + (headers.length + 1);
            var values = [];
            for (var i = 0; i < allData.length; i++) {
                values.push('');
            }
            
            saveState('insertColumn', { index: index, header: newHeader, values: values });
            
            headers.splice(index, 0, newHeader);
            for (var i = 0; i < allData.length; i++) {
                allData[i].splice(index, 0, '');
            }
            
            renderTable();
            updateStatus('Столбец добавлен');
        }
        
        function deleteColumn(index) {
            if (headers.length <= 1) {
                alert('Нельзя удалить единственный столбец');
                return;
            }
            
            if (!confirm('Удалить столбец "' + headers[index] + '"?')) return;
            
            var header = headers[index];
            var values = [];
            for (var i = 0; i < allData.length; i++) {
                values.push(allData[i][index]);
            }
            
            saveState('deleteColumn', { index: index, header: header, values: values });
            
            headers.splice(index, 1);
            for (var i = 0; i < allData.length; i++) {
                allData[i].splice(index, 1);
            }
            delete activeFilters[index];
            hiddenColumns.delete(index);
            
            if (sortState.column === index) {
                sortState = { column: null, direction: null };
            }
            
            applyFiltersAndSort();
            renderTable();
            updateHiddenColumnsIndicator();
            updateStatus('Столбец удален');
        }
        
        function hideColumn(index) {
            hiddenColumns.add(index);
            renderTable();
            updateHiddenColumnsIndicator();
            updateStatus('Столбец "' + headers[index] + '" скрыт');
        }
        
        function insertRow(index) {
            var newRow = [];
            for (var i = 0; i < headers.length; i++) {
                newRow.push('');
            }
            
            saveState('insertRow', { index: index, row: newRow });
            
            allData.splice(index, 0, newRow);
            applyFiltersAndSort();
            renderVisibleRows();
            updateStatus('Строка добавлена');
        }
        
        function deleteRow(index) {
            if (!confirm('Удалить строку?')) return;
            
            var row = allData[index].slice();
            
            saveState('deleteRow', { index: index, row: row });
            
            allData.splice(index, 1);
            applyFiltersAndSort();
            renderVisibleRows();
            updateStatus('Строка удалена');
        }
        
          function showRenameDialog(colIndex) {
            var input = document.getElementById('rename-input');
            input.value = headers[colIndex];
            showDialog('rename-dialog');
            input.focus();
            input.select();
            
            document.getElementById('rename-confirm').onclick = function() {
                var newName = input.value.trim();
                if (newName) {
                    var oldName = headers[colIndex];
                    saveState('renameColumn', { index: colIndex, oldName: oldName, newName: newName });
                    headers[colIndex] = newName;
                    renderHeader();
                    updateStatus('Столбец переименован');
                }
                hideDialog('rename-dialog');
            };
        }
        
        function showReplaceEmptyDialog(colIndex) {
            var input = document.getElementById('replace-empty-input');
            input.value = '';
            showDialog('replace-empty-dialog');
            input.focus();
            
            document.getElementById('replace-empty-confirm').onclick = function() {
                var replacement = input.value;
                var count = 0;
                
                for (var i = 0; i < allData.length; i++) {
                    if (allData[i][colIndex] === '' || allData[i][colIndex] === null || allData[i][colIndex] === undefined) {
                        allData[i][colIndex] = replacement;
                        count++;
                    }
                }
                
                hideDialog('replace-empty-dialog');
                
                if (count > 0) {
                    renderVisibleRows();
                    modified = true;
                    updateStatus('Заменено ' + count + ' пустых значений');
                } else {
                    updateStatus('Пустых значений не найдено');
                }
            };
        }
        
        function showMoveColumnDialog(fromIndex) {
            var select = document.getElementById('move-column-select');
            select.innerHTML = '';
            
            for (var index = 0; index < headers.length; index++) {
                if (index === fromIndex) continue;
                var option = document.createElement('option');
                option.value = index;
                option.textContent = headers[index] || ('Столбец ' + (index + 1));
                select.appendChild(option);
            }
            
            var endOption = document.createElement('option');
            endOption.value = headers.length;
            endOption.textContent = '(В конец)';
            select.appendChild(endOption);
            
            showDialog('move-column-dialog');
            
            document.getElementById('move-column-confirm').onclick = function() {
                var toIndex = parseInt(select.value);
                moveColumn(fromIndex, toIndex);
                hideDialog('move-column-dialog');
            };
        }
        
        function moveColumn(from, to) {
            if (from === to) return;
            
            var header = headers.splice(from, 1)[0];
            var adjustedTo = to > from ? to - 1 : to;
            headers.splice(adjustedTo, 0, header);
            
            for (var i = 0; i < allData.length; i++) {
                var cell = allData[i].splice(from, 1)[0];
                allData[i].splice(adjustedTo, 0, cell);
            }
            
            renderTable();
            modified = true;
            updateStatus('Столбец перемещен');
        }
        
        function showMoveRowDialog(fromIndex) {
            var select = document.getElementById('move-row-select');
            select.innerHTML = '';
            
            var maxOptions = Math.min(allData.length, 1000);
            
            for (var i = 0; i < maxOptions; i++) {
                if (i === fromIndex) continue;
                var option = document.createElement('option');
                option.value = i;
                option.textContent = 'Строка ' + (i + 1);
                select.appendChild(option);
            }
            
            if (allData.length > maxOptions) {
                var option = document.createElement('option');
                option.value = allData.length;
                option.textContent = '(В конец)';
                select.appendChild(option);
            }
            
            showDialog('move-row-dialog');
            
            document.getElementById('move-row-confirm').onclick = function() {
                var toIndex = parseInt(select.value);
                moveRow(fromIndex, toIndex);
                hideDialog('move-row-dialog');
            };
        }
        
        function moveRow(from, to) {
            if (from === to) return;
            
            var row = allData.splice(from, 1)[0];
            var adjustedTo = to > from ? to - 1 : to;
            allData.splice(adjustedTo, 0, row);
            
            applyFiltersAndSort();
            renderVisibleRows();
            modified = true;
            updateStatus('Строка перемещена');
        }

        function saveFile(filename, separator, format) {
            filename = filename || currentFilename || 'table.csv';
            format = format || (filename.endsWith('.xlsx') ? 'xlsx' : filename.endsWith('.txt') ? 'txt' : 'csv');
            separator = separator || currentSeparator || ';';
            
            var saveVisibleOnly = document.getElementById('save-visible-only');
            var visibleOnly = saveVisibleOnly ? saveVisibleOnly.checked : false;
            
            var headersToSave = [];
            var colIndices = [];
            for (var i = 0; i < headers.length; i++) {
                if (!visibleOnly || !hiddenColumns.has(i)) {
                    headersToSave.push(headers[i]);
                    colIndices.push(i);
                }
            }
            
            var dataToSave = [];
            for (var r = 0; r < allData.length; r++) {
                var row = [];
                for (var c = 0; c < colIndices.length; c++) {
                    row.push(allData[r][colIndices[c]]);
                }
                dataToSave.push(row);
            }
            
            if (format === 'xlsx') {
                var wb = XLSX.utils.book_new();
                var wsData = [headersToSave];
                for (var i = 0; i < dataToSave.length; i++) {
                    wsData.push(dataToSave[i]);
                }
                var ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                XLSX.writeFile(wb, filename);
            } else {
                var actualSeparator = separator === '\\t' ? '\t' : separator;
                
                var content = '';
                var headerLine = [];
                for (var i = 0; i < headersToSave.length; i++) {
                    headerLine.push(formatCSVValue(headersToSave[i], actualSeparator));
                }
                content += headerLine.join(actualSeparator) + '\r\n';
                
                for (var r = 0; r < dataToSave.length; r++) {
                    var rowLine = [];
                    for (var c = 0; c < dataToSave[r].length; c++) {
                        rowLine.push(formatCSVValue(dataToSave[r][c], actualSeparator));
                    }
                    content += rowLine.join(actualSeparator) + '\r\n';
                }
                
                var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            }
            
            currentFilename = filename;
            modified = false;
            updateStatus('Файл сохранен: ' + filename);
        }
        
        function formatCSVValue(value, separator) {
            if (value === null || value === undefined) return '';
            var str = String(value);
            if (str.indexOf(separator) !== -1 || str.indexOf('"') !== -1 || str.indexOf('\n') !== -1 || str.indexOf('\r') !== -1) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function updateStatus(message) {
            var status = message || 'Готов';
            
            if (currentFilename) {
                status += ' | ' + currentFilename;
                if (currentFileSize) {
                    status += ' (' + currentFileSize.toLocaleString() + ' КБ)';
                }
            }
            
            status += ' | Строк: ' + allData.length.toLocaleString();
            status += ' | Столбцов: ' + headers.length;
            
            if (filteredIndices.length !== allData.length) {
                status += ' | Показано: ' + filteredIndices.length.toLocaleString();
            }
            
            statusMessage.textContent = status;
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(function() {
                    updateStatus('Скопировано в буфер обмена');
                }).catch(function() {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            var textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            updateStatus('Скопировано в буфер обмена');
        }

        // Обработчики событий
        document.getElementById('open-btn').onclick = function() { fileInput.click(); };
        document.getElementById('open-file-btn').onclick = function() { fileInput.click(); };
        emptyState.onclick = function(e) {
            if (e.target.id !== 'open-file-btn') fileInput.click();
        };
        
        document.getElementById('save-btn').onclick = function() {
            if (allData.length === 0) return;
            if (currentFilename) {
                saveFile();
            } else {
                showDialog('save-dialog');
            }
        };
        
        document.getElementById('save-as-btn').onclick = function() {
            if (allData.length === 0) return;
            showDialog('save-dialog');
        };
        
        document.getElementById('undo-btn').onclick = undo;
        document.getElementById('redo-btn').onclick = redo;
        
        document.getElementById('columns-btn').onclick = function() {
            if (headers.length === 0) return;
            showColumnsDialog();
        };
        
        document.getElementById('sort-btn').onclick = function() {
            if (headers.length === 0) return;
            sortState = { column: null, direction: null };
            applyFiltersAndSort();
            renderTable();
            updateStatus('Сортировка сброшена');
        };
        
        document.getElementById('autosize-btn').onclick = toggleAutoSize;
        
        fileInput.onchange = function(e) {
            if (e.target.files[0]) {
                processFile(e.target.files[0]);
            }
        };
        
        document.getElementById('create-btn').onclick = function() {
            showDialog('create-dialog');
            document.getElementById('create-rows').focus();
            document.getElementById('create-rows').select();
        };

        document.getElementById('create-cancel').onclick = function() {
            hideDialog('create-dialog');
        };

        document.getElementById('create-confirm').onclick = function() {
            var rows = parseInt(document.getElementById('create-rows').value) || 10;
            var cols = parseInt(document.getElementById('create-cols').value) || 5;
            var withHeaders = document.getElementById('create-with-headers').checked;
            
            if (rows < 1 || rows > 100000) {
                alert('Количество строк должно быть от 1 до 100,000');
                return;
            }
            
            if (cols < 1 || cols > 100) {
                alert('Количество столбцов должно быть от 1 до 100');
                return;
            }
            
            if (allData.length > 0 && modified) {
                if (!confirm('Текущие несохраненные изменения будут потеряны. Продолжить?')) {
                    return;
                }
            }
            
            hideDialog('create-dialog');
            
            if (rows * cols > 10000) {
                showLoader('Создание файла...', rows + ' × ' + cols);
                requestAnimationFrame(function() {
                    createNewFile(rows, cols, withHeaders);
                    hideLoader();
                });
            } else {
                createNewFile(rows, cols, withHeaders);
            }
        };

        document.getElementById('create-rows').onkeydown = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('create-confirm').click();
            } else if (e.key === 'Escape') {
                hideDialog('create-dialog');
            }
        };

        document.getElementById('create-cols').onkeydown = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('create-confirm').click();
            } else if (e.key === 'Escape') {
                hideDialog('create-dialog');
            }
        };
        
        sheetSelector.onchange = function() {
            loadSheet(sheetSelector.value);
        };
        
        filterInput.oninput = onFilterInput;
        filterInput.onkeydown = function(e) {
            if (e.key === 'Enter') {
                applyFiltersAndSort();
                renderVisibleRows();
                updateStatus();
            }
        };
        filterModeToggle.onchange = function() {
            applyFiltersAndSort();
            renderVisibleRows();
            updateStatus();
        };
        
        document.getElementById('separator-cancel').onclick = function() {
            hideDialog('separator-dialog');
            fileInput.value = '';
        };
        
        document.getElementById('separator-confirm').onclick = function() {
            var file = fileInput._pendingFile;
            var separatorRadio = document.querySelector('input[name="separator"]:checked');
            var separator = separatorRadio.value;
            
            if (separator === 'custom') {
                separator = document.getElementById('custom-separator').value || ';';
            } else if (separator === '\\t') {
                separator = '\t';
            }
            
            var encoding = document.getElementById('encoding-select').value;
            var firstRowHeader = document.getElementById('first-row-header').checked;
            
            hideDialog('separator-dialog');
            processCSVFile(file, separator, encoding, firstRowHeader);
        };
        
        document.getElementById('save-cancel').onclick = function() {
            hideDialog('save-dialog');
        };
        
        document.getElementById('save-format').onchange = function() {
            var format = document.getElementById('save-format').value;
            document.getElementById('save-separator-group').style.display = format === 'xlsx' ? 'none' : 'block';
        };
        
        document.getElementById('save-separator').onchange = function() {
            var sep = document.getElementById('save-separator').value;
            document.getElementById('save-custom-separator').style.display = sep === 'custom' ? 'block' : 'none';
        };
        
        document.getElementById('save-confirm').onclick = function() {
            var format = document.getElementById('save-format').value;
            var separator = document.getElementById('save-separator').value;
            
            if (separator === 'custom') {
                separator = document.getElementById('save-custom-separator').value || ';';
            }
            
            var filename = currentFilename || 'table';
            filename = filename.replace(/\.[^.]+$/, '') + '.' + format;
            
            hideDialog('save-dialog');
            saveFile(filename, separator, format);
        };
        
        document.getElementById('rename-cancel').onclick = function() {
            hideDialog('rename-dialog');
        };
        document.getElementById('rename-input').onkeydown = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('rename-confirm').click();
            } else if (e.key === 'Escape') {
                hideDialog('rename-dialog');
            }
        };
        
        document.getElementById('replace-empty-cancel').onclick = function() {
            hideDialog('replace-empty-dialog');
        };
        document.getElementById('replace-empty-input').onkeydown = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('replace-empty-confirm').click();
            } else if (e.key === 'Escape') {
                hideDialog('replace-empty-dialog');
            }
        };
        
        document.getElementById('move-column-cancel').onclick = function() {
            hideDialog('move-column-dialog');
        };
        
        document.getElementById('move-row-cancel').onclick = function() {
            hideDialog('move-row-dialog');
        };
        
        document.getElementById('columns-cancel').onclick = function() {
            hideDialog('columns-dialog');
        };
        
        document.getElementById('columns-show-all').onclick = function() {
            var checkboxes = document.querySelectorAll('#column-list input');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = true;
            }
        };
        
        document.getElementById('columns-hide-all').onclick = function() {
            var checkboxes = document.querySelectorAll('#column-list input');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
        };
        
        document.getElementById('columns-invert').onclick = function() {
            var checkboxes = document.querySelectorAll('#column-list input');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = !checkboxes[i].checked;
            }
        };
        
        document.getElementById('columns-confirm').onclick = function() {
            var checkboxes = document.querySelectorAll('#column-list input');
            hiddenColumns.clear();
            
            for (var i = 0; i < checkboxes.length; i++) {
                if (!checkboxes[i].checked) {
                    hiddenColumns.add(parseInt(checkboxes[i].dataset.index));
                }
            }
            
            hideDialog('columns-dialog');
            renderTable();
            updateHiddenColumnsIndicator();
            updateStatus();
        };
        
        document.addEventListener('contextmenu', showContextMenu);
        document.addEventListener('click', function() {
            hideContextMenu();
            closeFilterDropdown();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                fileInput.click();
            }
            
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                document.getElementById('create-btn').click();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (allData.length > 0) {
                    if (e.shiftKey || !currentFilename) {
                        showDialog('save-dialog');
                    } else {
                        saveFile();
                    }
                }
            }
            
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
            
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                filterInput.focus();
                filterInput.select();
            }
            
            if (e.key === 'Escape') {
                hideAllDialogs();
                hideContextMenu();
                closeFilterDropdown();
                var aiPanel = document.getElementById('ai-panel');
                if (aiPanel) aiPanel.classList.remove('active');
            }
        });
        
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (e.dataTransfer.files.length > 0) {
                processFile(e.dataTransfer.files[0]);
            }
        });
        
        updateUndoRedoButtons();
        updateStatus('Готов');

        // ==================== AI ИНТЕГРАЦИЯ ====================
        
        var PROXY_URL = "https://mapruapp.ru";
        
        var AI_MODELS = [
            { id: "gemini-3-flash-preview", name: "Gemini 3 Flash", type: "gemini" },
            { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite", type: "gemini" },
            { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", type: "gemini" },
            { id: "claude-sonnet-4-5-20250929", name: "Claude Sonnet 4.5", type: "anthropic" },
            { id: "mistral-large-2512", name: "Mistral Large", type: "mistral" }
        ];
        
        var AI_MODES = {
            'proxy': { name: 'Прокси', needsKey: false },
            'direct_gemini': { name: 'Прямой Gemini', needsKey: true },
            'direct_mistral': { name: 'Прямой Mistral', needsKey: true }
        };
        
        var aiModel = localStorage.getItem('ai_model') || 'gemini-3-flash-preview';
        var aiMode = localStorage.getItem('ai_mode') || 'proxy';
        var aiKey = localStorage.getItem('ai_key') || '';
        var aiController = null;

        var aiPanel = document.getElementById('ai-panel');
        var aiQuery = document.getElementById('ai-query');
        var aiIncludeData = document.getElementById('ai-include-data');
        var aiDataInfo = document.getElementById('ai-data-info');
        var aiModelSelector = document.getElementById('ai-model-selector');
        var aiModeSelector = document.getElementById('ai-mode-selector');
        var aiKeyGroup = document.getElementById('ai-key-group');
        var aiKeyInput = document.getElementById('ai-api-key');
        var aiSettingsToggle = document.getElementById('ai-settings-toggle');
        var aiSettingsPanel = document.getElementById('ai-settings-panel');
        var aiLoading = document.getElementById('ai-loading');
        var aiResponse = document.getElementById('ai-response');
        var aiSendBtn = document.getElementById('ai-send');
        var aiCancelBtn = document.getElementById('ai-cancel');

        // Инициализация моделей
        var modelOptions = '';
        for (var i = 0; i < AI_MODELS.length; i++) {
            var m = AI_MODELS[i];
            modelOptions += '<option value="' + m.id + '" data-type="' + m.type + '">' + m.name + '</option>';
        }
        aiModelSelector.innerHTML = modelOptions;
        aiModelSelector.value = aiModel;

        function updateAIModes() {
            var selectedModel = null;
            for (var i = 0; i < AI_MODELS.length; i++) {
                if (AI_MODELS[i].id === aiModel) {
                    selectedModel = AI_MODELS[i];
                    break;
                }
            }
            var modelType = selectedModel ? selectedModel.type : 'gemini';
            
            var modes = ['proxy'];
            if (modelType === 'gemini') modes.push('direct_gemini');
            if (modelType === 'mistral') modes.push('direct_mistral');
            
            var modeOptions = '';
            for (var i = 0; i < modes.length; i++) {
                var key = modes[i];
                modeOptions += '<option value="' + key + '">' + AI_MODES[key].name + '</option>';
            }
            aiModeSelector.innerHTML = modeOptions;
            
            var modeExists = false;
            for (var i = 0; i < modes.length; i++) {
                if (modes[i] === aiMode) {
                    modeExists = true;
                    break;
                }
            }
            if (!modeExists) aiMode = 'proxy';
            
            aiModeSelector.value = aiMode;
            aiKeyGroup.style.display = AI_MODES[aiMode] && AI_MODES[aiMode].needsKey ? 'block' : 'none';
        }
        
        updateAIModes();
        aiKeyInput.value = aiKey;

        function toggleAIPanel() {
            aiPanel.classList.toggle('active');
            if (aiPanel.classList.contains('active')) {
                updateAIDataInfo();
                aiQuery.focus();
            }
        }

         function updateAIDataInfo() {
            if (aiIncludeData.checked && allData.length > 0) {
                var n = Math.min(allData.length, 100);
                aiDataInfo.textContent = n + ' строк' + (allData.length > 100 ? ' (макс 100)' : '');
            } else {
                aiDataInfo.textContent = 'без данных';
            }
        }

        function showAIResponse(text, type) {
            aiResponse.textContent = text;
            aiResponse.className = 'ai-response-area active';
            if (type) aiResponse.classList.add(type);
        }

function sendAIRequest() {
            var query = aiQuery.value.trim();
            if (!query) {
                showAIResponse('Введите запрос', 'error');
                return;
            }
            
            if (AI_MODES[aiMode] && AI_MODES[aiMode].needsKey && !aiKey) {
                showAIResponse('Введите API ключ в настройках', 'error');
                aiSettingsPanel.classList.add('active');
                return;
            }
            
            var tableData = null;
            if (aiIncludeData.checked && allData.length > 0) {
                tableData = {
                    headers: headers,
                    rows: allData.slice(0, 100),
                    total: allData.length
                };
            }
            
            var prompt = 'Ты AI-помощник для работы с таблицами. Твоя задача - выполнить операцию над данными таблицы.\n\n';
            prompt += 'ВАЖНО: Ответь СТРОГО в формате JSON без markdown-обертки:\n';
            prompt += '{"actions":[{"type":"set_cell","row":0,"col":0,"value":"x"},{"type":"add_row","data":["a","b"]},{"type":"add_column","header":"X","values":["1","2"]},{"type":"message","text":"..."}]}\n\n';
            prompt += 'Типы действий:\n';
            prompt += '- set_cell: изменить ячейку (row и col начинаются с 0). Если строки или столбца нет - они будут созданы автоматически.\n';
            prompt += '- add_row: добавить строку в конец таблицы\n';
            prompt += '- add_column: добавить новый столбец\n';
            prompt += '- message: показать сообщение пользователю\n\n';
            
            if (tableData) {
                prompt += 'Текущая таблица:\n';
                prompt += 'Заголовки: ' + JSON.stringify(tableData.headers) + '\n';
                prompt += 'Данные (' + tableData.rows.length + ' из ' + tableData.total + ' строк):\n';
                prompt += JSON.stringify(tableData.rows) + '\n\n';
            } else {
                prompt += 'Таблица пуста или данные не отправлены. При необходимости создай нужные строки и столбцы.\n\n';
            }
            
            prompt += 'Задача пользователя: ' + query + '\n\n';
            prompt += 'Ответь ТОЛЬКО валидным JSON без ```json и ``` обертки.';
            
            aiLoading.classList.add('active');
            aiResponse.classList.remove('active');
            aiSendBtn.disabled = true;
            aiCancelBtn.style.display = 'block';
            
            aiController = new AbortController();
            
            var selectedModel = null;
            for (var i = 0; i < AI_MODELS.length; i++) {
                if (AI_MODELS[i].id === aiModel) {
                    selectedModel = AI_MODELS[i];
                    break;
                }
            }
            var modelType = selectedModel ? selectedModel.type : 'gemini';
            
            var url, body;
            var fetchHeaders = { 'Content-Type': 'application/json' };
            var messages = [{ role: 'user', content: prompt }];
            
            if (aiMode === 'proxy') {
                url = PROXY_URL + '/ai/api/v1/chat/completions';
                body = { model: aiModel, messages: messages, max_tokens: 8192 };
            } else if (aiMode === 'direct_gemini') {
                url = 'https://generativelanguage.googleapis.com/v1beta/models/' + aiModel + ':generateContent?key=' + aiKey;
                body = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
            } else if (aiMode === 'direct_mistral') {
                url = 'https://api.mistral.ai/v1/chat/completions';
                fetchHeaders['Authorization'] = 'Bearer ' + aiKey;
                body = { model: aiModel, messages: messages, max_tokens: 8192 };
            }
            
            fetch(url, {
                method: 'POST',
                headers: fetchHeaders,
                body: JSON.stringify(body),
                signal: aiController.signal
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(err) {
                        throw new Error(err.error ? err.error.message : 'HTTP ' + response.status);
                    }).catch(function() {
                        throw new Error('HTTP ' + response.status);
                    });
                }
                return response.json();
            })
            .then(function(data) {
                var aiText;
                if (aiMode === 'direct_gemini') {
                    aiText = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : null;
                } else {
                    aiText = data.choices && data.choices[0] && data.choices[0].message ? data.choices[0].message.content : null;
                }
                
                if (!aiText) {
                    throw new Error('Пустой ответ от AI');
                }
                
                processAIResponse(aiText);
            })
            .catch(function(error) {
                if (error.name === 'AbortError') {
                    showAIResponse('Запрос отменен', 'error');
                } else {
                    showAIResponse('Ошибка: ' + error.message, 'error');
                }
            })
            .finally(function() {
                aiLoading.classList.remove('active');
                aiSendBtn.disabled = false;
                aiCancelBtn.style.display = 'none';
                aiController = null;
            });
        }

  function processAIResponse(text) {
            var jsonStr = text;
            
            jsonStr = jsonStr.replace(/^```json\s*/i, '');
            jsonStr = jsonStr.replace(/^```\s*/i, '');
            jsonStr = jsonStr.replace(/\s*```$/i, '');
            jsonStr = jsonStr.trim();
            
            var jsonMatch = jsonStr.match(/\{[\s\S]*"actions"[\s\S]*\}/);
            if (jsonMatch) {
                jsonStr = jsonMatch[0];
            }
            
            try {
                var result = JSON.parse(jsonStr);
                
                if (!result.actions || !Array.isArray(result.actions)) {
                    throw new Error('Неверный формат ответа');
                }
                
                var appliedCount = 0;
                var messages = [];
                var tableCreated = false;
                
                // Если таблица пуста, инициализируем её
                if (headers.length === 0) {
                    headers = ['Столбец 1'];
                    allData = [];
                    tableCreated = true;
                }
                
                for (var i = 0; i < result.actions.length; i++) {
                    var action = result.actions[i];
                    
                    if (action.type === 'set_cell') {
                        var row = parseInt(action.row);
                        var col = parseInt(action.col);
                        
                        if (row >= 0 && col >= 0) {
                            // Добавляем недостающие столбцы
                            while (col >= headers.length) {
                                headers.push('Столбец ' + (headers.length + 1));
                                for (var r = 0; r < allData.length; r++) {
                                    allData[r].push('');
                                }
                            }
                            
                            // Добавляем недостающие строки
                            while (row >= allData.length) {
                                var newRow = [];
                                for (var c = 0; c < headers.length; c++) {
                                    newRow.push('');
                                }
                                allData.push(newRow);
                            }
                            
                            allData[row][col] = String(action.value);
                            appliedCount++;
                        }
                    } else if (action.type === 'add_row') {
                        if (Array.isArray(action.data)) {
                            // Убедимся что есть достаточно столбцов
                            while (action.data.length > headers.length) {
                                headers.push('Столбец ' + (headers.length + 1));
                                for (var r = 0; r < allData.length; r++) {
                                    allData[r].push('');
                                }
                            }
                            
                            var newRow = [];
                            for (var j = 0; j < headers.length; j++) {
                                newRow.push(action.data[j] !== undefined ? String(action.data[j]) : '');
                            }
                            allData.push(newRow);
                            appliedCount++;
                        }
                    } else if (action.type === 'add_column') {
                        if (action.header) {
                            headers.push(String(action.header));
                            var values = action.values || [];
                            for (var r = 0; r < allData.length; r++) {
                                allData[r].push(values[r] !== undefined ? String(values[r]) : '');
                            }
                            appliedCount++;
                        }
                    } else if (action.type === 'message') {
                        if (action.text) {
                            messages.push(action.text);
                        }
                    }
                }
                
                if (appliedCount > 0 || tableCreated) {
                    // Показываем таблицу если она была скрыта
                    emptyState.style.display = 'none';
                    tableHeaderContainer.style.display = 'block';
                    tableContainer.style.display = 'block';
                    
                    applyFiltersAndSort();
                    renderTable();
                    modified = true;
                    
                    // Обновляем UI для режима авторазмера
                    var container = document.querySelector('.table-container');
                    if (!autoSizeEnabled) {
                        container.classList.add('manual-width');
                        setTimeout(function() {
                            addColumnResizers();
                        }, 50);
                    } else {
                        container.classList.remove('manual-width');
                    }
                }
                
                var resultMsg = '';
                if (appliedCount > 0) {
                    resultMsg = '✅ Применено изменений: ' + appliedCount;
                }
                if (messages.length > 0) {
                    resultMsg += (resultMsg ? '\n\n' : '') + messages.join('\n');
                }
                if (!resultMsg) {
                    resultMsg = 'AI не внес изменений';
                }
                
                showAIResponse(resultMsg, appliedCount > 0 ? 'success' : '');
                updateStatus('AI: применено ' + appliedCount + ' изменений');
                
            } catch (e) {
                showAIResponse(text, '');
            }
        }

        // AI обработчики событий
        document.getElementById('ai-btn').addEventListener('click', toggleAIPanel);
        
        document.getElementById('ai-panel-close').addEventListener('click', function() {
            aiPanel.classList.remove('active');
        });
        
        aiSettingsToggle.addEventListener('click', function() {
            aiSettingsPanel.classList.toggle('active');
        });
        
        aiModelSelector.addEventListener('change', function() {
            aiModel = aiModelSelector.value;
            localStorage.setItem('ai_model', aiModel);
            updateAIModes();
        });
        
        aiModeSelector.addEventListener('change', function() {
            aiMode = aiModeSelector.value;
            localStorage.setItem('ai_mode', aiMode);
            aiKeyGroup.style.display = AI_MODES[aiMode] && AI_MODES[aiMode].needsKey ? 'block' : 'none';
        });
        
        aiKeyInput.addEventListener('change', function() {
            aiKey = aiKeyInput.value.trim();
            localStorage.setItem('ai_key', aiKey);
        });
        
        aiSendBtn.addEventListener('click', sendAIRequest);
        
        aiCancelBtn.addEventListener('click', function() {
            if (aiController) {
                aiController.abort();
            }
        });
        
        aiQuery.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                sendAIRequest();
            }
        });
        
        var exampleBtns = document.querySelectorAll('.ai-example-btn');
        for (var i = 0; i < exampleBtns.length; i++) {
            (function(btn) {
                btn.addEventListener('click', function() {
                    aiQuery.value = btn.dataset.prompt;
                    aiQuery.focus();
                });
            })(exampleBtns[i]);
        }
        
        aiIncludeData.addEventListener('change', updateAIDataInfo);

    });
    
     var createConfirmBtn = document.getElementById('create-confirm');
        if (createConfirmBtn) {
            createConfirmBtn.onclick = function() {
                var rows = parseInt(document.getElementById('create-rows').value) || 10;
                var cols = parseInt(document.getElementById('create-cols').value) || 5;
                var withHeaders = document.getElementById('create-with-headers').checked;
                
                if (rows < 1 || rows > 100000) {
                    alert('Количество строк должно быть от 1 до 100,000');
                    return;
                }
                
                if (cols < 1 || cols > 100) {
                    alert('Количество столбцов должно быть от 1 до 100');
                    return;
                }
                
                if (allData.length > 0 && modified) {
                    if (!confirm('Текущие несохраненные изменения будут потеряны. Продолжить?')) {
                        return;
                    }
                }
                
                hideDialog('create-dialog');
                
                if (rows * cols > 10000) {
                    showLoader('Создание файла...', rows + ' × ' + cols);
                    setTimeout(function() {
                        createNewFile(rows, cols, withHeaders);
                        hideLoader();
                    }, 50);
                } else {
                    createNewFile(rows, cols, withHeaders);
                }
            };
        }
        
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ Цен</title>
    <!-- Подключаем библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Шрифты и иконки -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link id="favicon" rel="icon" href="img/an.png" type="image/png">
    
  <style>
    /* ===== ПЕРЕМЕННЫЕ И ОСНОВЫ ===== */
    :root {
        /* Обновленная, более яркая цветовая палитра */
        --primary-color: #5E56F0;   /* Яркий фиолетово-синий */
        --primary-hover: #4A42D9;
        --secondary-color: #F048C6; /* Яркий розовый */
        --accent-color: #00D4FF;    /* Яркий голубой (циан) */
        --accent-hover: #02B2D9;
        
        /* Функциональные цвета */
        --success-color: #10B981;   /* Насыщенный зеленый */
        --success-hover: #059669;
        --warning-color: #F59E0B;   /* Насыщенный оранжевый */
        --warning-hover: #D97706;
        --error-color: #EF4444;     /* Насыщенный красный */
        --error-hover: #DC2626;
        --info-color: #3B82F6;      /* Насыщенный синий */
        --info-hover: #2563EB;
        
        /* Нейтральные цвета */
        --white: #ffffff;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        
        /* Семантические цвета */
        --bg-color: #f3f4f6; /* Более светлый фон */
        --sidebar-bg: var(--white);
        --main-bg: var(--gray-50);
        --card-bg: var(--white);
        --text-color: var(--gray-900);
        --text-light: var(--gray-600);
        --text-muted: var(--gray-500);
        --border-color: var(--gray-200);
        --border-hover: var(--gray-300);
        
        /* Тени и эффекты */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* Радиусы скругления */
        --border-radius-sm: 4px;
        --border-radius: 8px;
        --border-radius-lg: 12px;
        --border-radius-xl: 16px;
        --border-radius-full: 9999px;
        
        /* Шрифты */
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --font-weight-light: 300;
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        --font-weight-extrabold: 800;
        
        /* Размеры (отступы) */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        
        /* Переходы */
        --transition-fast: 0.15s ease-in-out;
        --transition-normal: 0.2s ease-in-out;
        --transition-slow: 0.3s ease-in-out;
    }

    /* ===== БАЗОВЫЕ СТИЛИ ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    *::before, *::after { box-sizing: border-box; }
    html { font-size: 16px; scroll-behavior: smooth; }
    body {
        font-family: var(--font-family);
        color: var(--text-color);
        background: var(--bg-color);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== СКРОЛЛБАРЫ ===== */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--gray-100); }
    ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: var(--border-radius-full); }
    ::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }

    /* ===== ОСНОВНАЯ СТРУКТУРА ===== */
    .sidebar {
        width: 340px; /* Немного уже */
        background: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow-y: auto;
    }
    .main-content { flex-grow: 1; padding: var(--spacing-lg); display: flex; flex-direction: column; overflow-y: auto; min-height: 0; background: var(--main-bg); }

    /* ===== ЗАГОЛОВКИ И СЕКЦИИ ===== */
    .header { margin-bottom: var(--spacing-lg); }
    .header h1 { font-size: 1.5rem; font-weight: var(--font-weight-bold); margin: 0 0 var(--spacing-xs) 0; display: flex; align-items: center; gap: var(--spacing-sm); }
    .header h1 i { color: var(--primary-color); }
    .header h2 { font-size: 1.1rem; font-weight: var(--font-weight-semibold); margin: 0; display: flex; align-items: center; gap: var(--spacing-sm); }
    .header h2 i { color: var(--secondary-color); }
    .header p { font-size: 0.875rem; color: var(--text-light); margin: 0; }

    /* ===== КОНТРОЛЫ И ФОРМЫ (ИЗМЕНЕНИЯ ДЛЯ КОМПАКТНОСТИ) ===== */
    .control-group { margin-bottom: var(--spacing-md); } /* Уменьшен отступ */
    .control-group label { display: block; font-size: 0.8rem; font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-sm); color: var(--text-color); text-transform: uppercase; letter-spacing: 0.5px; }
    input[type="text"], select { width: 100%; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; background-color: var(--card-bg); color: var(--text-color); transition: all var(--transition-normal); outline: none; }
    input[type="text"]:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
    
    .ai-query-container { position: relative; }
    .ai-query-container .icon-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: var(--spacing-sm); border-radius: 50%; }
    .ai-query-container .icon-btn:hover { color: var(--primary-color); background-color: var(--gray-100); }

    /* ===== КНОПКИ ===== */
    .btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 14px 20px; border-radius: var(--border-radius); font-size: 0.9rem; font-weight: var(--font-weight-semibold); cursor: pointer; transition: all var(--transition-normal); border: none; gap: var(--spacing-sm); }
    .btn-primary { background-color: var(--primary-color); color: var(--white); }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-primary:disabled { background: var(--gray-400); cursor: not-allowed; }

    /* ===== РАЗДЕЛИТЕЛЬ (ИЗМЕНЕНИЯ ДЛЯ КОМПАКТНОСТИ) ===== */
    hr { border: none; height: 1px; background-color: var(--border-color); margin: var(--spacing-md) 0; } /* Уменьшен отступ */

    /* ===== СТАТИСТИЧЕСКИЕ КАРТОЧКИ (ИЗМЕНЕНИЯ ДЛЯ КОМПАКТНОСТИ) ===== */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); } /* Уменьшен gap и margin */
    .stat-card { background: var(--card-bg); border-radius: var(--border-radius-lg); padding: var(--spacing-md); box-shadow: var(--shadow); position: relative; overflow: hidden; border: 1px solid var(--border-color); } /* Уменьшен padding */
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; height: 4px; width: 100%; background: linear-gradient(90deg, var(--accent-color), var(--secondary-color), var(--primary-color)); }
    .stat-card-title { font-size: 0.75rem; color: var(--text-muted); margin: 0 0 var(--spacing-xs) 0; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card-value { font-size: 1.5rem; font-weight: var(--font-weight-bold); margin: 0; line-height: 1.2; } /* Уменьшен размер шрифта */

    /* ===== ЗАГОЛОВОК РЕЗУЛЬТАТОВ (ИЗМЕНЕНИЯ ДЛЯ КОМПАКТНОСТИ) ===== */
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); } /* Уменьшен margin */
    .results-header h2 { margin: 0; font-size: 1.25rem; font-weight: var(--font-weight-semibold); display: flex; align-items: center; gap: var(--spacing-sm); } /* Уменьшен размер шрифта */
    .results-header h2 i { color: var(--primary-color); }

    /* ===== КНОПКИ ЭКСПОРТА ===== */
    .export-buttons { display: flex; gap: var(--spacing-sm); }
    .export-btn { background: var(--gray-100); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-normal); font-size: 0.875rem; display: flex; align-items: center; justify-content: center; }
    .export-btn:hover { background: var(--gray-200); border-color: var(--gray-300); }
    #copy-btn:hover { color: var(--info-color); }
    #csv-btn:hover { color: var(--success-color); }
    #xlsx-btn:hover { color: var(--success-hover); }
    #ai-analyze-results-btn:hover { color: var(--secondary-color); }

    /* ===== КОНТЕЙНЕР ТАБЛИЦЫ ===== */
    .table-container { flex-grow: 1; overflow: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); background-color: var(--card-bg); box-shadow: var(--shadow); position: relative; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .data-table th, .data-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .data-table th { font-weight: var(--font-weight-semibold); background-color: var(--gray-50); color: var(--text-light); position: sticky; top: 0; z-index: 10; font-size: 0.8rem; text-transform: uppercase; }
    .data-table tbody tr:hover { background-color: color-mix(in srgb, var(--primary-color) 5%, transparent); }

    /* ===== PLACEHOLDER ===== */
    .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; }
    .placeholder .fa-search { font-size: 3rem; margin-bottom: var(--spacing-md); color: var(--gray-300); }
    .placeholder p { font-size: 1rem; }

    /* ===== КОНТЕЙНЕР ДИАГРАММ ===== */
    .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg); }
    .chart-card { background: var(--card-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 350px; }
    .chart-card h3 { margin: 0 0 var(--spacing-md) 0; font-size: 1rem; font-weight: var(--font-weight-semibold); color: var(--text-color); flex-shrink: 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
    .chart-card > div { position: relative; flex-grow: 1; }
    .chart-card canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }

    /* ===== ЗАГРУЗЧИК ===== */
    .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 100; border-radius: var(--border-radius-lg); }
    .loader { border: 4px solid var(--gray-200); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ===== МОДАЛЬНОЕ ОКНО ===== */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: var(--card-bg); padding: var(--spacing-lg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color); }
    .modal-header h2 { margin: 0; font-size: 1.25rem; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: color 0.2s, transform 0.2s; }
    .close-btn:hover { color: var(--error-color); transform: rotate(90deg); }

    /* ===== АДАПТИВНОСТЬ ===== */
    @media (max-width: 900px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height: auto; max-height: 50vh; border-right: none; border-bottom: 1px solid var(--border-color); }
        .main-content { height: 100%; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
        .stats-grid { grid-template-columns: 1fr; }
        .charts-container { grid-template-columns: 1fr; }
        .results-header { flex-direction: column; align-items: flex-start; gap: var(--spacing-md); }
    }

    /* ===== Анимации и утилиты ===== */
    @keyframes pulse { 50% { opacity: 0.6; } }
    .pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
    .text-gradient-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .text-gradient-accent { background: linear-gradient(45deg, var(--accent-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: var(--border-radius-full); font-size: 0.75rem; font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: 0.5px; }
    .badge.primary { background-color: color-mix(in srgb, var(--primary-color) 15%, transparent); color: var(--primary-color); }
    
    /* --- ВОТ ЭТОТ КОД НУЖНО ДОБАВИТЬ --- */

@keyframes slideInFromLeft {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
.slide-in-left {
    animation: slideInFromLeft 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

@keyframes slideInFromRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
.slide-in-right {
    animation: slideInFromRight 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

</style>
</head>
<body>
   <aside class="sidebar slide-in-left">
       <div class="header">
           <h1><i class="fas fa-magnifying-glass-chart"></i> Анализ Цен</h1>
           <p>Инструмент для анализа данных</p>
       </div>

       <div class="control-group">
           <label for="search-input">Поиск по названию</label>
           <input type="text" id="search-input" placeholder="">
       </div>

       <div class="control-group">
           <label for="store-select">Магазин</label>
           <select id="store-select">
               <option value="all">Все магазины</option>
           </select>
       </div>
       
       <div class="control-group">
           <label for="sort-select">Сортировка</label>
           <select id="sort-select">
               <option value="price_asc">Цена (по возрастанию)</option>
               <option value="price_desc">Цена (по убыванию)</option>
               <option value="created_at_desc">Дата (сначала новые)</option>
               <option value="created_at_asc">Дата (сначала старые)</option>
           </select>
       </div>

       <button id="search-btn" class="btn btn-primary"><i class="fas fa-search"></i> Найти</button>
       
       <hr>

  

       <div class="control-group">
           <label for="ai-query-input">Запрос на естественном языке</label>
           <div class="ai-query-container">
               <input type="text" id="ai-query-input" placeholder="">
               <button class="icon-btn tooltip" id="ai-help-btn" data-tooltip="Примеры запросов"><i class="fas fa-question-circle"></i></button>
           </div>
       </div>
       
       <div class="control-group">
           <label for="ai-model-select">Модель ИИ</label>
           <select id="ai-model-select">
               <option value="gemini-2.5-flash-lite-preview-06-17">Gemini 2.5 Flash Lite</option>
               <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
           </select>
       </div>

       <button id="ai-search-btn" class="btn btn-primary"><i class="fas fa-cogs"></i> Сгенерировать и выполнить</button>

   </aside>

   <main class="main-content slide-in-right">
       <div class="stats-grid">
           <div class="stat-card fade-in-up" style="animation-delay: 0s;">
               <p class="stat-card-title">Найдено товаров</p>
               <p class="stat-card-value text-gradient-primary" id="count-stat">0</p>
           </div>
           <div class="stat-card fade-in-up" style="animation-delay: 0.1s;">
               <p class="stat-card-title">Средняя цена</p>
               <p class="stat-card-value text-gradient-accent" id="avg-stat">0 ₽</p>
           </div>
           <div class="stat-card fade-in-up" style="animation-delay: 0.2s;">
               <p class="stat-card-title">Минимальная цена</p>
               <p class="stat-card-value" id="min-stat" style="color: var(--success-color);">0 ₽</p>
           </div>
           <div class="stat-card fade-in-up" style="animation-delay: 0.3s;">
               <p class="stat-card-title">Максимальная цена</p>
               <p class="stat-card-value" id="max-stat" style="color: var(--error-color);">0 ₽</p>
           </div>
       </div>

       <div class="charts-container">
           <div class="chart-card fade-in-up" style="animation-delay: 0.4s;">
               <h3><i class="fas fa-chart-pie" style="color: var(--primary-color);"></i> Распределение по магазинам (Топ-5)</h3>
               <div><canvas id="store-chart"></canvas></div>
           </div>
           <div class="chart-card fade-in-up" style="animation-delay: 0.5s;">
               <h3><i class="fas fa-chart-line" style="color: var(--info-color);"></i> Динамика средней цены (по дням)</h3>
               <div><canvas id="time-chart"></canvas></div>
           </div>
           <div class="chart-card fade-in-up" id="ai-chart-card" style="display: none; animation-delay: 0.6s;">
               <h3 id="ai-chart-title"><i class="fas fa-robot" style="color: var(--accent-color);"></i> Диаграмма от ИИ</h3>
               <div><canvas id="ai-chart"></canvas></div>
           </div>
       </div>

       <div class="results-header">
           <h2><i class="fas fa-table-list"></i> Результаты поиска</h2>
           <div class="export-buttons">
               <button id="copy-btn" class="export-btn tooltip" data-tooltip="Копировать в буфер"><i class="fas fa-copy"></i></button>
               <button id="csv-btn" class="export-btn tooltip" data-tooltip="Экспорт в CSV"><i class="fas fa-file-csv"></i></button>
               <button id="xlsx-btn" class="export-btn tooltip" data-tooltip="Экспорт в Excel"><i class="fas fa-file-excel"></i></button>
               <button id="ai-analyze-results-btn" class="export-btn tooltip" data-tooltip="Анализ с помощью ИИ"><i class="fas fa-comment-dots"></i></button>
           </div>
       </div>

       <div class="table-container">
           <div class="loading-overlay" id="loading-overlay"><div class="loader"></div></div>
           <table class="data-table">
               <thead>
                   <tr>
                       <th><i class="fas fa-tag" style="margin-right: 8px; color: var(--primary-color);"></i>Название товара</th>
                       <th><i class="fas fa-store" style="margin-right: 8px; color: var(--success-color);"></i>Магазин</th>
                       <th><i class="fas fa-ruble-sign" style="margin-right: 8px; color: var(--warning-color);"></i>Цена</th>
                       <th><i class="fas fa-calendar" style="margin-right: 8px; color: var(--info-color);"></i>Дата</th>
                   </tr>
               </thead>
               <tbody id="results-tbody"></tbody>
           </table>
           <div class="placeholder" id="placeholder">
               <i class="fas fa-search bounce"></i>
               <p>Используйте панель слева для поиска данных</p>
               <div class="badge primary" style="margin-top: 16px;">Готов к работе</div>
           </div>
       </div>
   </main>

   <div class="modal-overlay" id="ai-modal">
       <div class="modal-content">
           <div class="modal-header">
           
               <button class="close-btn" id="close-ai-modal-btn">&times;</button>
           </div>
           <div id="ai-analysis-content" style="max-height: 60vh; overflow-y: auto; line-height: 1.8; padding-right: 10px;">
                <!-- Content will be injected by JavaScript -->
           </div>
       </div>
   </div>
   
   <script>
       // --- КОНФИГУРАЦИЯ ---
       const SUPABASE_URL = 'https://krbqraivfbowmzvucjxz.supabase.co';
       const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyYnFyYWl2ZmJvd216dnVjanh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MDA0MTAsImV4cCI6MjA2MTA3NjQxMH0.Aun2UJDEW_75_Di-2hIcap42gqyZAu2XY9xiZpmShPc';
       const AI_API_URL = "https://mapruapp.ru/ai/api/v1/chat/completions";

       // --- ИНИЦИАЛИЗАЦИЯ ---
       const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
       Chart.register(ChartDataLabels);
       Chart.defaults.font.family = "'Inter', sans-serif";
       Chart.defaults.color = '#6b7280'; // var(--gray-500)

       // --- ЭЛЕМЕНТЫ DOM ---
       const searchInput = document.getElementById('search-input');
       const storeSelect = document.getElementById('store-select');
       const sortSelect = document.getElementById('sort-select');
       const searchBtn = document.getElementById('search-btn');
       const aiQueryInput = document.getElementById('ai-query-input');
       const aiSearchBtn = document.getElementById('ai-search-btn');
       const resultsTbody = document.getElementById('results-tbody');
       const loadingOverlay = document.getElementById('loading-overlay');
       const placeholder = document.getElementById('placeholder');
       const countStat = document.getElementById('count-stat');
       const avgStat = document.getElementById('avg-stat');
       const minStat = document.getElementById('min-stat');
       const maxStat = document.getElementById('max-stat');
       const copyBtn = document.getElementById('copy-btn');
       const csvBtn = document.getElementById('csv-btn');
       const xlsxBtn = document.getElementById('xlsx-btn');
       const aiAnalyzeResultsBtn = document.getElementById('ai-analyze-results-btn');
       const aiModal = document.getElementById('ai-modal');
       const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
       const aiAnalysisContent = document.getElementById('ai-analysis-content');
       const aiChartCard = document.getElementById('ai-chart-card');
       const aiChartTitle = document.getElementById('ai-chart-title');
       
       // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
       let currentResults = [];
       let storeChart, timeChart, aiChart;
     const chartColors = ['#5E56F0', '#F048C6', '#00D4FF', '#F59E0B', '#10B981', '#3B82F6'];
       const aiModalLoadingHTML = `<div class="loader pulse" style="margin: 40px auto;"></div><p style="text-align: center; color: var(--text-muted);">ИИ анализирует данные... Пожалуйста, подождите.</p>`;

       
       // --- ФУНКЦИИ ---
       function setLoading(isLoading) {
           loadingOverlay.style.display = isLoading ? 'flex' : 'none';
           searchBtn.disabled = isLoading;
           aiSearchBtn.disabled = isLoading;
           if (isLoading) {
               searchBtn.classList.add('pulse');
               aiSearchBtn.classList.add('pulse');
           } else {
               searchBtn.classList.remove('pulse');
               aiSearchBtn.classList.remove('pulse');
           }
       }

       function formatPrice(price) {
           if (price === null || price === undefined) return 'N/A';
           return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0 }).format(price);
       }

       function showNotification(message, type = 'info') {
           const notification = document.createElement('div');
           notification.className = `notification ${type}`;
           const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
           notification.innerHTML = `<div style="display: flex; align-items: center; gap: 12px;"><i class="fas fa-${icon}"></i><span>${message}</span></div>`;
           document.body.appendChild(notification);
           setTimeout(() => notification.classList.add('show'), 10);
           setTimeout(() => {
               notification.classList.remove('show');
               setTimeout(() => document.body.removeChild(notification), 500);
           }, 3000);
       }

       async function loadStores() {
           try {
               const { data, error } = await supabaseClient.from('prices').select('store').limit(1000);
               if (error) throw error;
               const uniqueStores = [...new Set(data.map(item => item.store))].filter(Boolean);
               storeSelect.innerHTML = '<option value="all">Все магазины</option>';
               uniqueStores.sort().forEach(store => {
                   const option = document.createElement('option');
                   option.value = store;
                   option.textContent = store;
                   storeSelect.appendChild(option);
               });
           } catch (error) {
               console.error("Ошибка при загрузке магазинов:", error);
               showNotification("Ошибка загрузки списка магазинов", "error");
           }
       }
       
       async function fetchData() {
           setLoading(true);
           placeholder.style.display = 'none';
           resultsTbody.innerHTML = '';
           aiChartCard.style.display = 'none';
           try {
               let query = supabaseClient.from('prices').select('*');
               const searchTerms = searchInput.value.trim().split(' ').filter(term => term);
               if (searchTerms.length > 0) {
                   searchTerms.forEach(term => { query = query.ilike('product_name', `%${term}%`); });
               }
               if (storeSelect.value !== 'all') {
                   query = query.eq('store', storeSelect.value);
               }
               const [sortColumn, sortOrder] = sortSelect.value.split('_');
               query = query.order(sortColumn, { ascending: sortOrder === 'asc' }).limit(500);
               
               const { data, error } = await query;
               if (error) throw error;
               
               currentResults = data;
               renderResults(data);
               updateStats(data);
               renderCharts(data);
               if (data.length > 0) {
                   showNotification(`Найдено ${data.length} товаров`, "success");
               }
           } catch (error) {
               console.error("Ошибка при получении данных:", error);
               showNotification("Ошибка при получении данных", "error");
           } finally {
               setLoading(false);
           }
       }

       function renderResults(data) {
           resultsTbody.innerHTML = '';
           if (data.length === 0) {
               placeholder.style.display = 'flex';
               return;
           }
           const fragment = document.createDocumentFragment();
           data.forEach((item, index) => {
               const row = document.createElement('tr');
               row.style.animationDelay = `${index * 0.03}s`;
               row.className = 'fade-in-up';
               row.innerHTML = `
                   <td><strong>${item.product_name || 'N/A'}</strong></td>
                   <td><span class="badge primary">${item.store || 'N/A'}</span></td>
                   <td><strong style="color: var(--warning-color);">${formatPrice(item.price)}</strong></td>
                   <td>${item.created_at ? new Date(item.created_at).toLocaleDateString('ru-RU') : 'N/A'}</td>
               `;
               fragment.appendChild(row);
           });
           resultsTbody.appendChild(fragment);
       }

       function updateStats(data) {
           const count = data.length;
           countStat.textContent = count.toLocaleString('ru-RU');
           if (count === 0) {
               avgStat.textContent = '0 ₽'; minStat.textContent = '0 ₽'; maxStat.textContent = '0 ₽';
               return;
           }
           const prices = data.map(item => item.price).filter(p => typeof p === 'number');
           if (prices.length === 0) {
               avgStat.textContent = '0 ₽'; minStat.textContent = '0 ₽'; maxStat.textContent = '0 ₽';
               return;
           }
           const sum = prices.reduce((a, b) => a + b, 0);
           avgStat.textContent = formatPrice(sum / prices.length);
           minStat.textContent = formatPrice(Math.min(...prices));
           maxStat.textContent = formatPrice(Math.max(...prices));
       }
       
       function renderCharts(data) {
           renderStoreDistributionChart(data);
           renderTimeChart(data);
       }
       
       function renderStoreDistributionChart(data) {
           if (storeChart) storeChart.destroy();
           const ctx = document.getElementById('store-chart').getContext('2d');
           if (data.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }

           const storeCounts = data.reduce((acc, {store}) => {
               if (store) { acc[store] = (acc[store] || 0) + 1; }
               return acc;
           }, {});
           const sortedStores = Object.entries(storeCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

           storeChart = new Chart(ctx, {
               type: 'doughnut',
               data: {
                   labels: sortedStores.map(entry => entry[0]),
                   datasets: [{ label: 'Кол-во товаров', data: sortedStores.map(entry => entry[1]), backgroundColor: chartColors, borderColor: 'var(--card-bg)', borderWidth: 4 }]
               },
               options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20 } }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (value, ctx) => (value * 100 / ctx.chart.getDatasetMeta(0).total).toFixed(0) + "%" } } }
           });
       }
       
       function renderTimeChart(data) {
           if (timeChart) timeChart.destroy();
           const ctx = document.getElementById('time-chart').getContext('2d');
           if (data.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }

           const dataByDay = data.reduce((acc, item) => {
               if (!item.created_at || typeof item.price !== 'number') return acc;
               const day = new Date(item.created_at).toISOString().split('T')[0];
               if (!acc[day]) acc[day] = [];
               acc[day].push(item.price);
               return acc;
           }, {});

           const sortedDays = Object.keys(dataByDay).sort();
           const chartLabels = sortedDays.map(day => new Date(day).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'}));
           const chartData = sortedDays.map(day => dataByDay[day].reduce((a, b) => a + b, 0) / dataByDay[day].length);

           timeChart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: chartLabels,
                   datasets: [{ label: 'Средняя цена', data: chartData, borderColor: '#4299e1', backgroundColor: 'rgba(66, 153, 225, 0.1)', fill: true, tension: 0.4, pointBackgroundColor: '#4299e1', pointRadius: 4 }]
               },
               options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { beginAtZero: false, ticks: { callback: value => formatPrice(value) } } } }
           });
       }

       async function callAI(system_prompt, user_prompt) {
           const model = document.getElementById('ai-model-select').value;
           const response = await fetch(AI_API_URL, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ model: model, messages: [{ role: "system", content: system_prompt }, { role: "user", content: user_prompt }], max_tokens: 2048 }),
           });
           if (!response.ok) throw new Error(`Ошибка API: ${response.statusText}`);
           const data = await response.json();
           return data.choices[0].message.content;
       }

       async function handleAIQuery() {
           const userQuery = aiQueryInput.value.trim();
           if (!userQuery) { showNotification("Введите запрос для ИИ", "warning"); return; }
           setLoading(true);
           aiChartCard.style.display = 'none';
           if(aiChart) aiChart.destroy();
           
           try {
               const system_prompt = `Ты - эксперт по SQL и базе данных PostgreSQL. Твоя задача - преобразовать запрос пользователя в ОДИН SQL-запрос.
СТРУКТУРА ТАБЛИЦЫ 'prices':
- store (text) - магазин
- product_name (text) - название товара
- price (numeric) - цена
- created_at (timestamp) - дата

АЛГОРИТМ РЕШЕНИЯ:
1.  Определи, что хочет пользователь: список данных, агрегацию (среднее/мин/макс/кол-во) или данные для диаграммы (с группировкой).
2.  Если пользователь просит "покажи диаграмму", "в разрезе магазинов", "сравни" и т.п., то это запрос на ДИАГРАММУ. Тебе нужно сгруппировать данные (GROUP BY) и вернуть две колонки: 'label' для подписей и 'value' для значений.
3.  Если пользователь просит "среднюю цену", "минимальную", "количество" и т.п., это АГРЕГАЦИЯ. Используй AVG, MIN, MAX, COUNT.
4.  В остальных случаях это запрос на СПИСОК. Просто используй SELECT *.

ПРАВИЛА SQL:
- Используй 'ilike' для регистронезависимого поиска.
- Для поиска по нескольким словам используй 'AND' с несколькими 'ilike'.

ПРИМЕРЫ:
- Запрос: "Средняя цена на шины lada" -> Ответ: SELECT AVG(price) as avg FROM prices WHERE product_name ilike '%шины%' AND product_name ilike '%lada%';
- Запрос: "Покажи диаграмму средней цены на шины в разрезе магазинов" -> Ответ: SELECT store as label, AVG(price) as value FROM prices WHERE product_name ilike '%шины%' GROUP BY store ORDER BY value DESC;
- Запрос: "топ 5 самых дорогих шин" -> Ответ: SELECT * FROM prices WHERE product_name ilike '%шины%' ORDER BY price DESC LIMIT 5;

Твой ответ должен содержать ТОЛЬКО SQL-код. Без объяснений и markdown.`;
               
               const sqlQuery = await callAI(system_prompt, userQuery);
               const cleanedSqlQuery = sqlQuery.trim().replace(/;$/, '');
               
               const { data, error } = await supabaseClient.rpc('execute_sql', { sql_query: cleanedSqlQuery });
               if (error) throw error;
               
               const isAggregation = data.length === 1 && (data[0].avg !== undefined || data[0].min !== undefined || data[0].max !== undefined || data[0].count !== undefined);
               const isChartData = data.length > 0 && data[0].label !== undefined && data[0].value !== undefined;

               if (isAggregation) {
                   const result = data[0];
                   let resultText = `Результат по запросу "${userQuery}":\n\n`;
                   if(result.avg !== undefined) resultText += `Среднее: ${formatPrice(result.avg)}\n`;
                   if(result.min !== undefined) resultText += `Минимум: ${formatPrice(result.min)}\n`;
                   if(result.max !== undefined) resultText += `Максимум: ${formatPrice(result.max)}\n`;
                   if(result.count !== undefined) resultText += `Количество: ${result.count}\n`;
                   alert(resultText); // Alert is suitable here for a quick summary
               } else if (isChartData) {
                   currentResults = []; // Clear main table
                   renderResults([]); updateStats([]); renderCharts([]); // Clear other visuals
                   renderAIChart(userQuery, data);
               } else {
                   currentResults = data;
                   renderResults(data); updateStats(data); renderCharts(data);
               }
           } catch (error) {
               console.error("Ошибка при выполнении AI-запроса:", error);
               showNotification(`Ошибка ИИ: ${error.message}`, "error");
           } finally {
               setLoading(false);
           }
       }
       
       function renderAIChart(title, data) {
           if (aiChart) aiChart.destroy();
           aiChartTitle.innerHTML = `<i class="fas fa-robot" style="color: var(--accent-color);"></i> ${title}`;
           aiChartCard.style.display = 'flex';
           
           const ctx = document.getElementById('ai-chart').getContext('2d');
           aiChart = new Chart(ctx, {
               type: 'bar',
               data: {
                   labels: data.map(item => item.label),
                   datasets: [{ label: 'Значение', data: data.map(item => item.value), backgroundColor: chartColors, borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1 }]
               },
               options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { x: { beginAtZero: true } } }
           });
       }
       
       function exportToCSV() {
           if (currentResults.length === 0) { showNotification('Нет данных для экспорта', 'warning'); return; }
           const headers = "Название товара;Магазин;Цена;Дата\n";
           const rows = currentResults.map(r => `"${r.product_name}";"${r.store}";${r.price};"${new Date(r.created_at).toISOString()}"`).join("\n");
           downloadFile(headers + rows, 'prices.csv', 'text/csv;charset=utf-8;');
       }
       
       function exportToXLSX() {
           if (currentResults.length === 0) { showNotification('Нет данных для экспорта', 'warning'); return; }
           const ws = XLSX.utils.json_to_sheet(currentResults.map(r => ({ 'Название товара': r.product_name, 'Магазин': r.store, 'Цена': r.price, 'Дата': new Date(r.created_at) })));
           ws['!cols'] = [{ wch: 60 }, { wch: 20 }, { wch: 15 }, { wch: 20 }];
           const wb = XLSX.utils.book_new();
           XLSX.utils.book_append_sheet(wb, ws, "Цены");
           XLSX.writeFile(wb, "prices_export.xlsx");
       }

       function copyToClipboard() {
           if (currentResults.length === 0) { showNotification('Нет данных для копирования', 'warning'); return; }
           const textToCopy = "Название товара\tМагазин\tЦена\tДата\n" + currentResults.map(r => `${r.product_name}\t${r.store}\t${r.price}\t${new Date(r.created_at).toLocaleDateString('ru-RU')}`).join('\n');
           navigator.clipboard.writeText(textToCopy).then(() => showNotification('Данные скопированы!', 'success'));
       }

       function downloadFile(content, fileName, contentType) {
           const a = document.createElement("a");
           const file = new Blob([`\uFEFF${content}`], { type: contentType });
           a.href = URL.createObjectURL(file);
           a.download = fileName;
           a.click();
           URL.revokeObjectURL(a.href);
       }

       async function analyzeResultsWithAI() {
           if (currentResults.length === 0) { showNotification("Нет данных для анализа", "warning"); return; }
           aiModal.style.display = 'flex';
           aiAnalysisContent.innerHTML = aiModalLoadingHTML;
           
           const system_prompt = `Ты - опытный аналитик данных. Тебе предоставлен JSON массив с данными о ценах на товары.
Твоя задача - написать краткое, но содержательное резюме по этим данным.
Структура ответа:
1.  **Общий вывод (2-3 предложения):** Опиши общую ситуацию. Есть ли большой разброс цен? Какой магазин доминирует?
2.  **Самые выгодные предложения:** Назови 2-3 конкретных товара с самой низкой ценой, указав товар, цену и магазин.
3.  **Самые дорогие предложения:** Укажи 1-2 самых дорогих товара.
4.  **Инсайт или рекомендация:** Дай один полезный совет или сделай неочевидный вывод на основе данных (например, "В магазине X цены в среднем на 15% ниже, чем в Y" или "Цены на товары Z сильно выросли за последнюю неделю").
Используй Markdown для форматирования (жирный текст для названий, списки).`;
           const dataForAI = JSON.stringify(currentResults.slice(0, 50));
           
           try {
               const analysis = await callAI(system_prompt, dataForAI);
               const formattedAnalysis = analysis
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/(\n|^)\* (.*?)(?=\n|$)/g, '$1<li>$2</li>')
                    .replace(/<\/li>\s*<li>/g, '</li><li>') // clean up spaces between lis
                    .replace(/<\/li>(?!<ul>)/g, '</li></ul>') 
                    .replace(/<li>(?!<ul)/g, '<ul><li>')
                    .replace(/<\/ul>\s*<ul>/g, ''); // merge lists
               aiAnalysisContent.innerHTML = formattedAnalysis.replace(/\n/g, '<br>');
           } catch(error) {
               aiAnalysisContent.innerHTML = `<p style="color: var(--error-color);">Ошибка анализа: ${error.message}</p>`;
           }
       }
       
       // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
       searchBtn.addEventListener('click', fetchData);
       searchInput.addEventListener('keydown', e => { if(e.key === 'Enter') fetchData(); });
       aiSearchBtn.addEventListener('click', handleAIQuery);
       aiQueryInput.addEventListener('keydown', e => { if(e.key === 'Enter') handleAIQuery(); });
       
       copyBtn.addEventListener('click', copyToClipboard);
       csvBtn.addEventListener('click', exportToCSV);
       xlsxBtn.addEventListener('click', exportToXLSX);
       aiAnalyzeResultsBtn.addEventListener('click', analyzeResultsWithAI);
       
       closeAiModalBtn.addEventListener('click', () => aiModal.style.display = 'none');
       aiModal.addEventListener('click', e => { if (e.target === aiModal) aiModal.style.display = 'none'; });
       document.getElementById('ai-help-btn').addEventListener('click', () => {
           alert(`Примеры запросов для ИИ:\n- Топ 5 самых дорогих шин\n- Средняя цена на iphone 15 в мвидео\n- Количество товаров дешевле 5000 рублей\n- Диаграмма: средняя цена шин по магазинам`);
       });

       // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
       document.addEventListener('DOMContentLoaded', () => {
           loadStores();
           renderCharts([]);
       });
   </script>
</body>
</html>
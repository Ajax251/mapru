<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPGenerator v09 - Генератор Межевого плана</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Подключение библиотек для работы с ZIP и скачиванием -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #10b981; /* Зеленый оттенок для МП */
            --primary-hover: #059669;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; display: flex; justify-content: center; }

        .container {
            width: 100%; max-width: 1800px; background: var(--surface);
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); height: 95vh;
        }

        .header {
            padding: 15px 25px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .logo h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .logo span { font-size: 0.8rem; color: var(--text-light); display: block; }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 0; flex-grow: 1; overflow: hidden; }
        .column { padding: 20px; border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .column:last-child { border-right: none; }

        h2 { font-size: 0.9rem; text-transform: uppercase; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; margin: 5px 0 10px 0; display: flex; align-items: center; gap: 8px; position: sticky; top: 0; background: var(--surface); z-index: 10; }
        
        .form-group { margin-bottom: 8px; }
        .form-row { display: flex; gap: 10px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 4px; color: var(--text-light); text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; font-family: inherit; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        textarea { resize: vertical; }

        .coords-input { font-family: 'Consolas', monospace; font-size: 0.8rem; height: 120px; white-space: pre; overflow-x: auto; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 1rem; }
        .btn-main:hover { background: var(--primary-hover); }

        .btn-add { background: #ecfdf5; color: var(--primary); border: 1px dashed var(--primary); padding: 8px; width: 100%; cursor: pointer; border-radius: 6px; font-size: 0.85rem; margin-top: 5px; transition: 0.2s; }
        .btn-add:hover { background: #d1fae5; }

        .list-container { display: flex; flex-direction: column; gap: 8px; }
        .list-item { background: #f8fafc; border: 1px solid var(--border); padding: 12px; border-radius: 6px; position: relative; }
        .list-item .remove { position: absolute; top: 5px; right: 8px; color: var(--text-light); cursor: pointer; font-size: 1.1rem; }
        .list-item .remove:hover { color: var(--danger); }

        .file-upload-wrapper { position: relative; margin-top: 5px; }
        .file-upload-wrapper input[type=file] { padding: 6px; background: white; font-size: 0.8rem; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; background: #e2e8f0; color: #64748b; margin-left: 5px; }
        
        /* Табы для переключения режима */
        .mode-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f5f9; padding: 4px; border-radius: 8px; }
        .mode-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; font-weight: 600; color: var(--text-light); transition: 0.2s; }
        .mode-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-map-marked-alt"></i></div>
            <div>
                <h1>MPGenerator</h1>
                <span>Генератор Межевого плана (XML v09 + ZIP)</span>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items: center;">
             <div id="statusMsg" style="font-size: 0.9rem; color: var(--text-light);"></div>
             <button class="btn-main" onclick="generateArchive()">
                <i class="fas fa-file-archive"></i> Сформировать ZIP
            </button>
        </div>
    </div>

    <div class="grid-layout">
        <!-- КОЛОНКА 1: Общие сведения -->
        <div class="column">
            <h2><i class="fas fa-user-cog"></i> Кадастровый инженер</h2>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label>Фамилия</label><input type="text" id="engSurname" placeholder="Иванов"></div>
                <div class="form-group" style="flex:1"><label>Имя</label><input type="text" id="engName" placeholder="Иван"></div>
                <div class="form-group" style="flex:1"><label>Отчество</label><input type="text" id="engPatronymic" placeholder="Иванович"></div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label>СНИЛС</label><input type="text" id="engSnils" placeholder="000-000-000 00"></div>
                <div class="form-group" style="flex:1"><label>№ в реестре</label><input type="text" id="engRegNum" placeholder="12345"></div>
            </div>
            <div class="form-group"><label>СРО</label><textarea id="engSro" rows="2" placeholder="Наименование СРО"></textarea></div>
            <div class="form-group"><label>Контакты (Адрес, Email, Тел)</label><textarea id="engContacts" rows="3" placeholder="Адрес, телефон, почта"></textarea></div>

            <h2><i class="fas fa-briefcase"></i> Заказчик и Договор</h2>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label>№ Договора</label><input type="text" id="contractNum"></div>
                <div class="form-group" style="flex:1"><label>Дата договора</label><input type="date" id="contractDate"></div>
            </div>
            <div class="form-group"><label>Дата завершения работ</label><input type="date" id="cadastralDate"></div>
            
            <div class="form-group"><label>Заказчик (ФИО / Название)</label><input type="text" id="clientName"></div>
            <div class="form-group"><label>СНИЛС / ИНН Заказчика</label><input type="text" id="clientId"></div>

            <div class="form-group"><label>Вид работ (Reason)</label><textarea id="workReason" rows="4" placeholder="уточнением/образованием земельного участка..."></textarea></div>
            
            <div class="form-group"><label>Заключение КИ</label><textarea id="conclusion" rows="5" placeholder="Текст заключения..."></textarea></div>
        </div>

        <!-- КОЛОНКА 2: Данные участка -->
        <div class="column">
            <h2><i class="fas fa-layer-group"></i> Целевой участок</h2>
            
            <div class="mode-tabs">
                <div class="mode-tab active" onclick="setMode('form')" id="tabForm">Образование</div>
                <div class="mode-tab" onclick="setMode('specify')" id="tabSpecify">Уточнение</div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex:1">
                    <label id="lblTargetId">Обозначение (:ЗУ1)</label>
                    <input type="text" id="parcelDefinition" placeholder=":ЗУ1">
                </div>
                <div class="form-group" style="flex:1"><label>Квартал</label><input type="text" id="cadBlock" placeholder="XX:XX:XXXXXXX"></div>
            </div>

            <!-- Блок только для образования -->
            <div id="blockFormParcels">
                <div class="form-group">
                    <label>Способ образования</label>
                    <select id="formMethod">
                        <option value="1">Выдел (1)</option>
                        <option value="2">Раздел (2)</option>
                        <option value="3">Раздел с измененным (3)</option>
                        <option value="4">Перераспределение (4)</option>
                        <option value="5">Образование из земель (5)</option>
                        <option value="6">Объединение (6)</option>
                    </select>
                </div>
                <div class="form-group"><label>Исходные КН (через запятую)</label><input type="text" id="prevCadNums"></div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex:1"><label>Площадь (м²)</label><input type="number" id="areaVal"></div>
                <div class="form-group" style="flex:1"><label>Погрешность (±)</label><input type="number" id="areaInacc"></div>
            </div>
            <div class="form-group"><label>Формула</label><input type="text" id="areaFormula" value="∆P = 3,5*Mt*√P"></div>

            <h2><i class="fas fa-map-marker-alt"></i> Адрес и Характеристики</h2>
            <div class="form-row">
                <div class="form-group" style="flex:0.5"><label>Регион</label><input type="text" id="addrRegion" value="16" placeholder="Код"></div>
                <div class="form-group" style="flex:1.5"><label>Район</label><input type="text" id="addrDistrict"></div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label>Город/МО</label><input type="text" id="addrCity"></div>
                <div class="form-group" style="flex:1"><label>Нас. пункт</label><input type="text" id="addrLocality"></div>
            </div>
            <div class="form-group"><label>Улица</label><input type="text" id="addrStreet"></div>
            <div class="form-group"><label>Дом / Иное</label><input type="text" id="addrOther"></div>
            <div class="form-group"><label>FIAS</label><input type="text" id="addrFias"></div>

            <div class="form-group"><label>Категория (Код)</label>
                <select id="category">
                    <option value="003002000000">Земли населенных пунктов</option>
                    <option value="003001000000">Сельхоз назначения</option>
                    <option value="003003000000">Промышленности...</option>
                </select>
            </div>
            <div class="form-group"><label>ВРИ (по документу)</label><textarea id="utilization" rows="2"></textarea></div>
            <div class="form-group"><label>Обеспечение доступа (текст)</label><input type="text" id="accessPath" value="Земли общего пользования"></div>
        </div>

        <!-- КОЛОНКА 3: Геометрия и Файлы -->
        <div class="column">
            <h2><i class="fas fa-draw-polygon"></i> Координаты</h2>
            <div class="form-row">
                <div class="form-group" style="flex:1">
                    <label>Система координат</label>
                    <input type="text" id="csName" value="МСК-16">
                </div>
                 <div class="form-group" style="flex:0.5">
                    <label>Код СК</label>
                    <input type="text" id="csCode" value="16.2">
                </div>
            </div>
            <div class="form-group">
                <label>X Y (через пробел, строка - точка)</label>
                <textarea id="coordsInput" class="coords-input" placeholder=""></textarea>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label>Mt (точность)</label><input type="text" id="mtVal" value="0.10"></div>
                <div class="form-group" style="flex:1"><label>Метод (код)</label><input type="text" id="methodCode" value="692005000000"></div>
            </div>
            <div class="form-group"><label>Закрепление</label><input type="text" id="fixType" value="Долговременный межевой знак"></div>

            <h2><i class="fas fa-satellite-dish"></i> Геодезическая основа</h2>
            <div id="geoList" class="list-container"></div>
            <button class="btn-add" onclick="addGeoBase()">+ Добавить пункт ГГС</button>

            <h2><i class="fas fa-folder-open"></i> Документы (InputData)</h2>
            <div id="docsList" class="list-container"></div>
            <button class="btn-add" onclick="addDocument()">+ Добавить документ</button>

            <h2><i class="fas fa-paperclip"></i> Приложения и Схемы</h2>
            <div class="form-group">
                <label>Схема построений (PDF)</label>
                <div class="file-upload-wrapper"><input type="file" id="fileSGP" accept=".pdf"></div>
            </div>
             <div class="form-group">
                <label>Схема расположения (PDF)</label>
                <div class="file-upload-wrapper"><input type="file" id="fileSchem" accept=".pdf"></div>
            </div>
             <div class="form-group">
                <label>Чертеж участка (PDF)</label>
                <div class="file-upload-wrapper"><input type="file" id="fileDrawing" accept=".pdf"></div>
            </div>
             <div class="form-group">
                <label>Акт согласования (PDF)</label>
                <div class="file-upload-wrapper"><input type="file" id="fileAct" accept=".pdf"></div>
            </div>

            <div id="appendixList" class="list-container" style="margin-top:10px;"></div>
            <button class="btn-add" onclick="addAppendix()">+ Приложение (файл)</button>
        </div>
    </div>
</div>

<script>
    let currentMode = 'form'; // 'form' or 'specify'
    
    // UUID Generator
    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('tabForm').className = mode === 'form' ? 'mode-tab active' : 'mode-tab';
        document.getElementById('tabSpecify').className = mode === 'specify' ? 'mode-tab active' : 'mode-tab';
        
        const blockForm = document.getElementById('blockFormParcels');
        const lblTarget = document.getElementById('lblTargetId');
        
        if (mode === 'form') {
            blockForm.style.display = 'block';
            lblTarget.innerText = 'Обозначение (:ЗУ1)';
            document.getElementById('parcelDefinition').placeholder = ":ЗУ1";
        } else {
            blockForm.style.display = 'none';
            lblTarget.innerText = 'Кадастровый номер';
            document.getElementById('parcelDefinition').placeholder = "XX:XX:XXXXXXX:XX";
        }
    }

    // --- Dynamic Lists Functions ---

    function addDocument() {
        const id = uuidv4();
        const html = `
            <div class="list-item" id="${id}">
                <div class="remove" onclick="removeEl('${id}')">&times;</div>
                <div class="form-group"><input type="text" class="d-name" placeholder="Название документа"></div>
                <div class="form-row">
                    <input type="text" class="d-num" placeholder="Номер" style="flex:1">
                    <input type="date" class="d-date" style="flex:1">
                </div>
                <input type="text" class="d-org" placeholder="Орган выдачи" style="margin-top:5px">
            </div>`;
        document.getElementById('docsList').insertAdjacentHTML('beforeend', html);
    }

    function addGeoBase() {
        const id = uuidv4();
        const html = `
             <div class="list-item" id="${id}">
                <div class="remove" onclick="removeEl('${id}')">&times;</div>
                <div class="form-row">
                    <input type="text" class="g-name" placeholder="Название (Пункт...)" style="flex:1">
                    <input type="text" class="g-class" placeholder="Класс" style="flex:0.5">
                </div>
                <div class="form-row" style="margin-top:5px">
                    <input type="text" class="g-x" placeholder="X">
                    <input type="text" class="g-y" placeholder="Y">
                </div>
            </div>`;
         document.getElementById('geoList').insertAdjacentHTML('beforeend', html);
    }

    function addAppendix() {
        const id = uuidv4();
        const html = `
             <div class="list-item" id="${id}">
                <div class="remove" onclick="removeEl('${id}')">&times;</div>
                <div class="form-group"><input type="text" class="a-name" placeholder="Название в приложении"></div>
                <div class="file-upload-wrapper"><input type="file" class="a-file"></div>
            </div>`;
         document.getElementById('appendixList').insertAdjacentHTML('beforeend', html);
    }

    function removeEl(id) {
        document.getElementById(id).remove();
    }

    // --- XML Logic ---

    function parseCoordinates(text) {
        const lines = text.trim().split('\n');
        const points = [];
        for (let line of lines) {
            const parts = line.trim().split(/[\t\s,]+/);
            if (parts.length >= 2) {
                points.push({
                    x: parseFloat(parts[0].replace(',', '.')),
                    y: parseFloat(parts[1].replace(',', '.'))
                });
            }
        }
        if (points.length > 2) {
            const first = points[0];
            const last = points[points.length - 1];
            if (Math.abs(first.x - last.x) > 0.001 || Math.abs(first.y - last.y) > 0.001) {
                points.push(first);
            }
        }
        return points;
    }

    function calculateDistance(p1, p2) {
        return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2)).toFixed(2);
    }

    function getValue(id) { return document.getElementById(id).value; }

    async function generateArchive() {
        const status = document.getElementById('statusMsg');
        status.innerText = "Генерация...";
        
        const zip = new JSZip();
        const mainGuid = uuidv4();
        const folderGuid = uuidv4();
        const filesFolder = zip.folder(folderGuid); // Folder for PDFs

        // Helper to add file to ZIP and get relative path
        async function handleFile(fileInputId, zipFolder) {
            const input = document.getElementById(fileInputId);
            if (input && input.files && input.files[0]) {
                const file = input.files[0];
                zipFolder.file(file.name, file);
                return `${folderGuid}\\${file.name}`;
            }
            return null;
        }

        async function handleListFiles(fileInput, zipFolder) {
            if (fileInput && fileInput.files && fileInput.files[0]) {
                 const file = fileInput.files[0];
                 zipFolder.file(file.name, file);
                 return `${folderGuid}\\${file.name}`;
            }
            return null;
        }

        // --- Prepare Data for XML ---

        const coordsText = getValue('coordsInput');
        const points = parseCoordinates(coordsText);
        const mtVal = getValue('mtVal');
        const methodCode = getValue('methodCode');
        const fixType = getValue('fixType');

        let spatialPoints = '';
        points.forEach((pt, idx) => {
            let numGeo = idx + 1;
            if (idx === points.length - 1) numGeo = 1;
            
            // Logic: NewOrdinate for everything for simplicity in this universal generator
            // In SpecifyParcel usually NewOrdinate/OldOrdinate logic applies, but for total clarification NewOrdinate is fine
            spatialPoints += `
            <SpelementUnit TypeUnit="Точка">
              <NewOrdinate GeopointZacrep="${fixType}" NumGeopoint="${numGeo}" PointPref="н" X="${pt.x.toFixed(2)}" Y="${pt.y.toFixed(2)}" DeltaGeopoint="${mtVal}" GeopointOpred="${methodCode}" />
            </SpelementUnit>`;
        });

        let borders = '<Borders>';
        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i];
            const p2 = points[i+1];
            const length = calculateDistance(p1, p2);
            let n1 = i + 1;
            let n2 = i + 2;
            if (i === points.length - 2) n2 = 1;

            borders += `
            <Border Point1="${n1}" Point2="${n2}" Spatial="1">
              <Edge>
                <Length>${length}</Length>
              </Edge>
            </Border>`;
        }
        borders += '\n          </Borders>';

        const entitySpatial = `
        <EntitySpatial CsCode="${getValue('csCode')}" Name="${getValue('csName')}">
          <SpatialElement>${spatialPoints}
          </SpatialElement>${borders}
        </EntitySpatial>`;

        // Package Content
        let packageContent = '';
        const def = getValue('parcelDefinition');
        const block = getValue('cadBlock');
        const area = getValue('areaVal');
        const inacc = getValue('areaInacc');
        const form = getValue('areaFormula');
        const access = getValue('accessPath');
        const address = `
        <Address AddressOrLocation="0">
          <FIAS>${getValue('addrFias')}</FIAS>
          <RussianFederation>Российская Федерация</RussianFederation>
          <Region>${getValue('addrRegion')}</Region>
          <District Name="${getValue('addrDistrict')}" Type="р-н" />
          <City Name="${getValue('addrCity')}" Type="г" />
          <Locality Name="${getValue('addrLocality')}" Type="нп" />
          <Street Name="${getValue('addrStreet')}" Type="ул" />
          <Other>${getValue('addrOther')}</Other>
        </Address>`;
        const category = `<Category Category="${getValue('category')}" />`;
        const util = `<PermittedUsesLand><PermittedUseEstablished ByDocument="${getValue('utilization')}" /></PermittedUsesLand>`;

        if (currentMode === 'form') {
            const method = getValue('formMethod');
            const prevs = getValue('prevCadNums').split(',').map(n => n.trim()).filter(n => n).map(n => `<CadastralNumber>${n}</CadastralNumber>`).join('');
            
            packageContent = `
    <FormParcels Method="${method}">
      <NewParcel Definition="${def}">
        <CadastralBlock>${block}</CadastralBlock>
        <PrevCadastralNumbers>${prevs}</PrevCadastralNumbers>
        <ProvidingPassCadastralNumbers><Other>${access}</Other></ProvidingPassCadastralNumbers>
        <Area>
          <Area>${area}</Area>
          <Unit>055</Unit>
          <Inaccuracy>${inacc}</Inaccuracy>
          <Formula>${form}</Formula>
        </Area>
        ${address}
        ${category}
        ${util}
        ${entitySpatial}
      </NewParcel>
    </FormParcels>`;
        } else {
            packageContent = `
    <SpecifyParcel>
      <ExistParcel CadastralNumber="${def}">
        <CadastralBlock>${block}</CadastralBlock>
        <ProvidingPassCadastralNumbers><Other>${access}</Other></ProvidingPassCadastralNumbers>
        <Area>
          <Area>${area}</Area>
          <Unit>055</Unit>
          <Inaccuracy>${inacc}</Inaccuracy>
          <Formula>${form}</Formula>
        </Area>
        ${entitySpatial}
        ${address}
        ${category}
        ${util}
      </ExistParcel>
    </SpecifyParcel>`;
        }

        // Documents
        let docsXML = '';
        const docItems = document.querySelectorAll('#docsList .list-item');
        for (const item of docItems) {
            docsXML += `
      <Document>
        <CodeDocument>558401000000</CodeDocument>
        <Name>${item.querySelector('.d-name').value}</Name>
        <Number>${item.querySelector('.d-num').value}</Number>
        <Date>${item.querySelector('.d-date').value}</Date>
        <IssueOrgan>${item.querySelector('.d-org').value}</IssueOrgan>
      </Document>`;
        }

        // Geodesic Bases
        let geoXML = '<GeodesicBases>';
        const geoItems = document.querySelectorAll('#geoList .list-item');
        const currentDate = getValue('cadastralDate');
        for (const item of geoItems) {
            geoXML += `
      <GeodesicBase Name="${getValue('csName')}" CsCode="${getValue('csCode')}">
        <PType>плановая</PType>
        <PName>${item.querySelector('.g-name').value}</PName>
        <PKind>ОМЗ</PKind>
        <PKlass>${item.querySelector('.g-class').value}</PKlass>
        <OrdX>${item.querySelector('.g-x').value}</OrdX>
        <OrdY>${item.querySelector('.g-y').value}</OrdY>
        <ConditionPoint AsOfDate="${currentDate}">
          <OutdoorPoint><NetworkPoints>627001000000</NetworkPoints></OutdoorPoint>
          <CenterPoint><NetworkPoints>627001000000</NetworkPoints></CenterPoint>
          <Mark><NetworkPoints>627001000000</NetworkPoints></Mark>
        </ConditionPoint>
      </GeodesicBase>`;
        }
        geoXML += '</GeodesicBases>';

        // Main Files
        const pathSGP = await handleFile('fileSGP', filesFolder);
        const pathSchem = await handleFile('fileSchem', filesFolder);
        const pathDraw = await handleFile('fileDrawing', filesFolder);
        const pathAct = await handleFile('fileAct', filesFolder);

        // Appendix
        let appendixXML = '<Appendix>';
        const appItems = document.querySelectorAll('#appendixList .list-item');
        let appCount = 1;
        for (const item of appItems) {
            const path = await handleListFiles(item.querySelector('.a-file'), filesFolder);
            if (path) {
                appendixXML += `
    <AppliedFiles>
      <NumberAppendix>${appCount++}</NumberAppendix>
      <NameAppendix>${item.querySelector('.a-name').value}</NameAppendix>
      <AppliedFile Kind="01" Name="${path}" />
    </AppliedFiles>`;
            }
        }
        appendixXML += '</Appendix>';

        // Graphic Sections XML
        const graphicSections = `
  ${pathSGP ? `<SchemeGeodesicPlotting Kind="01" Name="${pathSGP}" />` : ''}
  ${pathSchem ? `<SchemeDisposition Kind="01" Name="${pathSchem}" />` : ''}
  ${pathDraw ? `<DiagramParcelsSubParcels><AppliedFile Kind="01" Name="${pathDraw}" /></DiagramParcelsSubParcels>` : ''}
  ${pathAct ? `<AgreementDocument><AppliedFile Kind="01" Name="${pathAct}" /></AgreementDocument>` : ''}`;

        // Full XML Assembly
        const finalXML = `<?xml version="1.0" encoding="utf-8"?>
<MP Version="09" NameSoftware="MPGenerator" VersionSoftware="1.0" GUID="${mainGuid}">
  <Package>${packageContent}
  </Package>
  <GeneralCadastralWorks DateCadastral="${getValue('cadastralDate')}">
    <Contractor>
      <FamilyName>${getValue('engSurname')}</FamilyName>
      <FirstName>${getValue('engName')}</FirstName>
      <Patronymic>${getValue('engPatronymic')}</Patronymic>
      <SNILS>${getValue('engSnils')}</SNILS>
      <CadastralEngineerRegistryNumber>${getValue('engRegNum')}</CadastralEngineerRegistryNumber>
      <DateEntering>2016-11-30</DateEntering>
      <Telephone>${getValue('engContacts')}</Telephone>
      <Address>${getValue('engContacts')}</Address>
      <Email>mail@example.com</Email>
      <SelfRegulatoryOrganization>${getValue('engSro')}</SelfRegulatoryOrganization>
      <AgreementCadWork>
        <Name>Договор</Name>
        <NumberAgreement>${getValue('contractNum')}</NumberAgreement>
        <DateAgreement>${getValue('contractDate')}</DateAgreement>
      </AgreementCadWork>
    </Contractor>
    <Reason>${getValue('workReason')}</Reason>
    <Clients>
      <Client>
        <Person>
          <FamilyName>${getValue('clientName')}</FamilyName>
          <FirstName>.</FirstName>
          <Patronymic>.</Patronymic>
          <SNILS>${getValue('clientId')}</SNILS>
        </Person>
      </Client>
    </Clients>
  </GeneralCadastralWorks>
  <InputData>
    <Documents>${docsXML}
    </Documents>
    ${geoXML}
  </InputData>
  <Conclusion>${getValue('conclusion')}</Conclusion>
  ${graphicSections}
  ${appendixXML}
</MP>`;

        // Add XML to ZIP
        const xmlFileName = `GKUZU_${mainGuid}.xml`;
        zip.file(xmlFileName, finalXML);

        // Download
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, `MP_${mainGuid}.zip`);
            status.innerText = "Готово!";
        });
    }
</script>

</body>
</html>
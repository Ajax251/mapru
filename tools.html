<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инструменты</title>
    <link rel="icon" href="img/ren.png" type="image/png">
       <script src="webfonts/feather.min.js"></script>
    <script src="webfonts/pdf.min2.js"></script>
    <script src="webfonts/jszip.min.js"></script>
    <script src="statement.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap');

        :root {
            --border-radius: 10px;
            --spacer: 1rem;
            --primary: #406ff3;
            --text: #6a778e;
            --link-height: calc(var(--spacer) * 3.5);
            --timing: 250ms;
        }

        body {
            background: #eaeef6;
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar {
            position: fixed;
            top: var(--spacer);
            left: var(--spacer);
            background: #fff;
            border-radius: var(--border-radius);
            padding: var(--spacer) 0;
            box-shadow: 0 0 40px rgba(0,0,0,0.03);
            height: calc(100vh - calc(var(--spacer) * 4));
        }

        .navbar__menu {
            list-style-type: none;
            padding: 0;
            margin: 0;
            position: relative;
        }

        .navbar__item {
            margin: 0;
            padding: 0;
            position: relative;
        }

        .navbar__link {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--link-height);
            width: calc(var(--spacer) * 5.5);
            color: var(--text);
            transition: var(--timing) ease all;
            text-decoration: none;
        }

        .navbar__link span {
            position: absolute;
            left: 100%;
            transform: translate(calc(var(--spacer) * -3));
            margin-left: 1rem;
            opacity: 0;
            pointer-events: none;
            color: var(--primary);
            background: #fff;
            padding: calc(var(--spacer) * 0.75);
            transition: var(--timing) ease all;
            border-radius: calc(var(--border-radius) * 1.75);
            white-space: nowrap;
        }

        .navbar__item:before {
            content: '';
            position: absolute;
            opacity: 0;
            z-index: -1;
            top: 0;
            left: var(--spacer);
            width: var(--link-height);
            height: var(--link-height);
            background: var(--primary);
            border-radius: calc(var(--border-radius) * 1.75);
            transition: var(--timing) cubic-bezier(1, 0.2, 0.1, 1.2) all;
        }

        .navbar__item:hover:before {
            opacity: 1;
        }

        .navbar__link:hover {
            color: #fff;
        }

        .navbar:not(:hover) .navbar__link:focus span,
        .navbar__link:hover span {
            opacity: 1;
            transform: translate(0);
        }

        @keyframes gooeyEffect {
            0% { transform: scale(1, 1); }
            50% { transform: scale(0.5, 1.5); }
            100% { transform: scale(1, 1); }
        }

        .navbar__item:hover:before {
            animation: gooeyEffect var(--timing) 1;
        }

        .content {
            margin-left: calc(var(--spacer) * 8);
            padding: var(--spacer);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .drop-zone {
            border: 2px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin: 20px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
        }

        .drop-zone.drag-over {
            background: rgba(64, 111, 243, 0.1);
            border-color: #2851d4;
        }

        .drop-zone p {
            margin: 0;
            color: var(--text);
            font-size: 1.2em;
        }

        .loading-indicator {
            display: none;
            color: var(--primary);
        }

        #result {
            margin-top: var(--spacer);
            padding: var(--spacer);
            background: #fff;
            border-radius: var(--border-radius);
            max-width: 80%;
            width: 100%;
        }

        .check-list-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            position: relative;
            transform-origin: center;
            animation: none;
            justify-content: space-between;
        }

        .check-list-item:nth-child(odd) {
            background-color: #e9ecef;
        }

        .check-list-item:hover {
            transform: translateX(5px);
        }

        .check-list-item.checked {
            background-color: #90EE90;
        }

        .checkmark {
            position: absolute;
            left: 10px;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 20px;
        }

        .checked .checkmark {
            opacity: 1;
        }

        .item-text {
            flex-grow: 1;
            text-align: center;
            padding: 0 30px;
        }

        .check-list-item.duplicate {
            background-color: #FFB74D;
        }

        .check-list-item.duplicate:nth-child(odd) {
            background-color: #FFA726;
        }

        .check-list-item.checked.duplicate {
            background-color: #90EE90;
        }

        @keyframes sortAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .sorting {
            animation: sortAnimation 0.3s ease;
        }

        .copy-button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-button:hover {
            opacity: 1;
        }

        .copy-icon {
            transition: all 0.3s ease;
        }

        .copy-icon.copied {
            stroke: #00cc00;
            filter: drop-shadow(0 0 2px rgba(0, 204, 0, 0.7));
        }

        @keyframes flash {
            0%, 100% { background-color: inherit; }
            50% { background-color: rgba(0, 255, 0, 0.2); }
        }

        .copy-flash {
            animation: flash 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 70%;
            max-width: 500px;
            text-align: left;
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-content input,
        .modal-content textarea {
            width: 95%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .modal-content button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .modal-content button[data-action="cancel"] {
            background: #ff2c2c;
        }

        .pdf-link {
            display: block;
            padding: 10px;
            margin: 5px 0;
            background-color: #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: var(--text);
            transition: background-color 0.3s ease;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .pdf-link:hover {
            background-color: #d0d0d0;
        }

        #pdfOutput p {
            padding-left: 10px;
            word-wrap: break-word;
            font-size: 0.8em;
        }

        /* Стили для NSPD модального окна */
        #nspdResultModal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        #nspdResultModal .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #nspdResultModal h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary);
        }

      #nspdResultModal table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#nspdResultModal th,
#nspdResultModal td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: center; /* Изменено с left на center */
}

#nspdResultModal th {
    background-color: var(--primary);
    color: white;
    font-weight: 600;
}

#nspdResultModal tr:nth-child(even) {
    background-color: #f9f9f9;
}

#nspdResultModal tr:hover {
    background-color: #f1f1f1;
}

        #nspdResultModal button {
            background: #00bb77;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            float: right;
            transition: background 0.3s ease;
        }

        #nspdResultModal button:hover {
            background: #009966;
        }
        
 .progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar-fill {
    width: 0%; /* Начальное значение */
    height: 100%;
    background-color: #406ff3;
    transition: width 0.3s ease-in-out; /* Плавный переход для изменения ширины */
}

    /* Стили для модальных окон с кнопками-меню */
        .xml-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 25px 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 650px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            text-align: center;
        }

        .xml-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .xml-modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.4em;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 2.5em;
            line-height: 1;
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s ease;
            padding: 0;
        }

        .close-button:hover {
            color: #333;
        }

        .xml-modal-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .xml-menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .xml-menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(64, 111, 243, 0.1);
            background-color: #fff;
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .xml-menu-button i {
            width: 32px;
            height: 32px;
            margin-bottom: 10px;
        }
        
        #renameModal .modal-content {
    max-width: 750px; /* Увеличиваем ширину окна, чтобы вместить панель */
}

.modal-flex-wrapper {
    display: flex;
    gap: 20px;
}

.modal-left-panel {
    flex-grow: 1;
}

.modal-right-panel {
    width: 180px;
    min-width: 180px;
    border-left: 2px solid #e9ecef;
    padding-left: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.sidebar-btn {
    background-color: #6a778e;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    font-size: 0.9em;
    transition: background 0.3s ease;
    width: 100%;
    word-break: break-word;
}

.sidebar-btn:hover {
    background-color: #556075;
}


    </style>
</head>
<body>
    <nav class="navbar">
        <ul class="navbar__menu">
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="zipMenuItem"><i data-feather="edit"></i><span>Переименовать ZIP выписки</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="renameFoldersMenuItem"><i data-feather="folder"></i><span>Переименовать папки с выписками</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="renameFilesMenuItem"><i data-feather="file"></i><span>Переименовать файлы</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="rightsMenuItem"><i data-feather="users"></i><span>Правообладатели</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="mapMenuItem"><i data-feather="map"></i><span>Кадастровые номера (Проверка наличия)</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="checkListMenuItem"><i data-feather="check-square"></i><span>Отметить в списке</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="applicationMenuItem"><i data-feather="file-text"></i><span>Заявление</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="extractPdfMenuItem"><i data-feather="link"></i><span>Решение о предоставлении документов ГФДЗ</span></a>
            </li>
            
            
            
    <li class="navbar__item">
                <a href="#" class="navbar__link" id="smezhnMenuItem">
                    <i data-feather="layout"></i><span>Схемы и документы</span>
                </a>
            </li>
                    
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="xmlDocsMenuItem"><i data-feather="database"></i><span>XML и PDF документы</span></a>
            </li>
            
              <li class="navbar__item">
            <a href="ep.html" class="navbar__link" target="_blank"><i data-feather="key"></i><span>Электронная подпись</span></a>
            </li>
            
        </ul>
    </nav>

    <div class="content">
        <h1>Переименование ZIP и папок с выписками</h1>
        <div class="drop-zone">
            <p>Перетащите файлы сюда или нажмите</p>
            <div class="loading-indicator"></div>
        </div>
        <div id="result"></div>
    </div>

<div id="renameModal" class="modal">
    <div class="modal-content">
        <div class="modal-flex-wrapper">
            <!-- Левая панель (Существующий функционал) -->
            <div class="modal-left-panel">
                <h3>Параметры для переименования файлов</h3>
                <label for="replaceText">Текст в имени файлов</label>
                <input type="text" id="replaceText" placeholder="Текст для замены">
                <label for="newText">будет заменен на следующий текст:</label>
                <input type="text" id="newText" placeholder="Новый текст">
                <div style="text-align: right; margin-top: 15px;">
                    <button onclick="openFileSelector()">Выбрать файлы</button>
                    <button data-action="cancel" onclick="closeRenameModal()">Отмена</button>
                </div>
            </div>

            <!-- Правая панель (Новая) -->
            <div class="modal-right-panel">
                <button class="sidebar-btn" onclick="window.open('mapxml.html', '_blank')">MapPlanTerritory</button>
                <!-- Сюда можно добавлять новые кнопки в будущем -->
            </div>
        </div>
    </div>
</div>

    <div id="mapModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Текст с кадастровыми номерами</h3>
            <textarea id="cadastralNumbers" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="processCadastralNumbers()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Обработать</button>
                <button onclick="closeMapModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

    <div id="checkListModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Список для отметок</h3>
            <textarea id="checkListInput" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="openCheckList()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Открыть список</button>
                <button onclick="closeCheckListModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

    <div id="checkListResultModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 70%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; text-align: center;">Список для отметок</h3>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                <div id="checkListStats" style="color: #007bff; font-weight: bold;"></div>
                <button onclick="sortCheckList()" style="background: #406ff3; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;">Сортировать</button>
            </div>
            <div id="checkListItems" style="margin-top: 20px;"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeCheckListResultModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="applicationModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Вставьте XML заявления</h3>
            <textarea id="applicationInput" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="processApplication()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Открыть</button>
                <button onclick="closeApplicationModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

  <div id="applicationResultModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background-color: white; margin: 2% auto; padding: 20px; border-radius: 10px; width: 95%; max-width: 1400px; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-top: 0; text-align: center;">Заявление</h3>
        
        <!-- Информация о заявлении -->
        <div id="statementInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
        
        <!-- Заявители -->
        <h4 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px;">Заявители</h4>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #ddd;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Тип</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Наименование / ФИО</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">ИНН / Дата рождения</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">ОГРН / СНИЛС</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Документ</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Адрес</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Телефон</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
        
        <!-- Представители -->
  <div id="representativesSection" style="display: none;">
    <h4 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px;">Представители</h4>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #ddd;">
        <thead>
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Уровень</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Тип</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Наименование / ФИО</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">ИНН / Дата рождения</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">ОГРН / СНИЛС</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Контакты</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Документ представителя</th>
            </tr>
        </thead>
        <tbody id="representativesBody"></tbody>
    </table>
</div>
        
        <!-- Объекты -->
        <h4 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px;">Объекты</h4>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #ddd;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Тип объекта</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Кадастровый номер</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Адрес объекта</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Площадь</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Обозначение в МП</th>
                </tr>
            </thead>
            <tbody id="objectsBody"></tbody>
        </table>
        
        <!-- Приложенные документы -->
        <h4 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px;">Приложенные документы</h4>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #ddd;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">№</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Наименование</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Номер</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Дата</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Кем выдан</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Файл</th>
                </tr>
            </thead>
            <tbody id="documentsBody"></tbody>
        </table>
        
        <!-- Способ получения -->
        <h4 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px;">Способ подачи и получения</h4>
        <div id="deliveryInfo" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
        
      <div style="text-align: right; margin-top: 20px;">
    <button onclick="saveStatementToHTML()" style="background: #406ff3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Сохранить в HTML</button>
    <button onclick="closeApplicationResultModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
</div>
    </div>
</div>

    <div id="pdfExtractModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 70%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; text-align: center;">Ссылки из PDF</h3>
            <div id="pdfOutput" style="margin-top: 20px;"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closePdfExtractModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="nspdResultModal">
        <div class="modal-content">
            <h3>Проверка наличия кадастрового номера</h3>
            <table>
                <thead>
                    <tr>
                        <th>Кадастровый номер</th>
                        <th>Тип объекта</th>
                        <th>Сведения о правах</th>
                    </tr>
                </thead>
                <tbody id="nspdResultBody"></tbody>
            </table>
            <button onclick="closeNspdResultModal()">Закрыть</button>
        </div>
    </div>
    
    <div id="loadingModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background-color: white; margin: 20% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 400px; text-align: center;">
        <h3 style="margin-top: 0; color: #406ff3;">Загрузка данных...</h3>
        <div class="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>
        <p style="margin-top: 10px; color: #6a778e;"></p>
    </div>
</div>

    <!-- НАЧАЛО: Модальное окно для XML документов -->
    <div id="xmlDocsModal" class="modal">
        <div class="xml-modal-content">
            <div class="xml-modal-header">
                <h3>XML и PDF документы</h3>
                <button class="close-button" onclick="closeXmlDocsModal()">×</button>
            </div>
            <div class="xml-modal-body">
                <a href="xml_выписка_зу.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="file-text"></i>
                    <span>Выписка ЗУ</span>
                </a>
                <a href="xml_выписка_окс.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="home"></i>
                    <span>Выписка ОКС</span>
                </a>
                <a href="xml_zu" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="map-pin"></i>
                    <span>КПТ ЗУ</span>
                </a>
                <a href="xml_oks" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="briefcase"></i>
                    <span>КПТ ОКС</span>
                </a>
                <a href="xml_ter" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="layers"></i>
                    <span>КПТ Территории</span>
                </a>
       <a href="mp" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="map"></i>
                    <span>Межевой план</span>
                </a>
                
                
                <a href="egpdf.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="file"></i>
                    <span>PDF выписка</span>
                </a>
                
                <a href="parser.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
    <i data-feather="code"></i>
    <span>XML в JSON</span>
</a>
                
                
        <a href="sc.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
            <i data-feather="layout"></i>
            <span>Схема расположения</span>
        </a>
        
            </div>
        </div>
    </div>
    <!-- КОНЕЦ: Модальное окно для XML документов -->
    
  <div id="smezhnDocsModal" class="modal">
        <div class="xml-modal-content">
            <div class="xml-modal-header">
                <h3>Схемы и документы</h3>
                <button class="close-button" onclick="closeSmezhnDocsModal()">×</button>
            </div>
            <div class="xml-modal-body">
                <a href="схема_смежного_зу.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="layout"></i>
                    <span>Схема смежного ЗУ</span>
                </a>
                <a href="sch.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="edit-3"></i>
                    <span>Подготовка чертежей</span>
                </a>
                <a href="схема_на_кпт.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="award"></i>
                    <span>Постановление</span>
                </a>
                <a href="mpt.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="file"></i>
                    <span>Титульный лист</span>
                </a>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple accept=".zip">
    <input type="file" id="renameFileInput" style="display: none;" multiple>
    <input type="file" id="rightsFileInput" style="display: none;" multiple accept=".zip,.xml">
    <input type="file" id="pdfFileInput" style="display: none;" multiple accept=".pdf">
    
    


    <script>
    feather.replace();
 pdfjsLib.GlobalWorkerOptions.workerSrc = 'webfonts/pdf.worker.min2.js';
    // Глобальные переменные
    let filesToProcess = 0;
    let filesProcessed = 0;
    let rightsMap = new Map();
    let currentCheckListData = [];

    // Фиксированные настройки
    const settings = {
        extractMask: "{cadastralNumber} {date}",
        kptMask: "{cadNumber} {date}"
    };

    // Получаем элементы DOM
    const dropZone = document.querySelector('.drop-zone');
    const loadingIndicator = document.querySelector('.loading-indicator');

    // Обработчики меню
    document.getElementById('zipMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('fileInput').click();
    });
    document.getElementById('renameFilesMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openRenameModal();
    });
    document.getElementById('renameFoldersMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        const input = document.createElement('input');
        input.type = 'file';
        input.webkitdirectory = true;
        input.addEventListener('change', handleFolderSelect);
        input.click();
    });
    document.getElementById('rightsMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('rightsFileInput').click();
    });
    document.getElementById('extractPdfMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('pdfFileInput').click();
    });
    document.getElementById('mapMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openMapModal();
    });
    document.getElementById('checkListMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openCheckListModal();
    });
    document.getElementById('applicationMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openApplicationModal();
    });

    // Обработчики файлов
    document.getElementById('fileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleFiles(event.target.files);
    });
    document.getElementById('rightsFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleRightsFiles(event.target.files);
    });
    document.getElementById('renameFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleRenameFiles(event.target.files);
    });
    document.getElementById('pdfFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handlePdfFiles(event.target.files);
    });

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-over');
        loadingIndicator.style.display = 'block';
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
        loadingIndicator.style.display = 'none';
    }

    dropZone.addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    });

    // Вспомогательные функции
    function getElementValue(parent, selector) {
        const element = parent.querySelector(selector);
        return element ? element.textContent : '';
    }

    function applyMask(mask, number, date) {
        return mask.replace(/{cadastralNumber}|{cadNumber}/g, number.replace(/:/g, '_'))
            .replace('{date}', date);
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Не удалось скопировать текст: ', err);
            }
            document.body.removeChild(textArea);
        }
    }

    // Основные функции обработки
    function handleFiles(files) {
        rightsMap.clear();
        filesToProcess = files.length;
        filesProcessed = 0;

        [...files].forEach(file => {
            if (file.name.toLowerCase().endsWith('.zip')) {
                updateResult(`Обработка файла: ${file.name}`);
                processZipFile(file);
            }
        });
    }

    function handleRenameFiles(files) {
        const replaceText = document.getElementById('replaceText').value;
        const newText = document.getElementById('newText').value;

        [...files].forEach(file => {
            let newFileName = file.name;
            if (replaceText && newText) {
                newFileName = file.name.replace(replaceText, newText);
            }
            renameAndDownloadFile(file, newFileName);
        });
        closeRenameModal();
    }

    function handlePdfFiles(files) {
        const pdfOutputDiv = document.getElementById('pdfOutput');
        pdfOutputDiv.innerHTML = '';

        const pdfArray = Array.from(files);
        const openFirst = pdfArray.length === 1;

        Promise.all(pdfArray.map(file => processPdf(file, openFirst))).then(results => {
            results.forEach(res => {
                pdfOutputDiv.innerHTML += res.output;
            });
            document.getElementById('pdfExtractModal').style.display = 'block';
        });
    }

    function handleRightsFiles(files) {
        rightsMap.clear();
        filesToProcess = files.length;
        filesProcessed = 0;

        [...files].forEach(file => {
            if (file.name.toLowerCase().endsWith('.zip')) {
                processRightsZipFile(file);
            } else if (file.name.toLowerCase().endsWith('.xml')) {
                processRightsXmlFile(file);
            }
        });
    }

    function processPdf(file, openFirst = false) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = async function (event) {
                let outputString = "";
                const typedArray = new Uint8Array(event.target.result);

                try {
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    let fullText = '';

                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + ' ';
                    }

                    const passwordMatch = fullText.match(/Пароль для скачивания:\s*([^\s\n]+)/);
                    let password = passwordMatch && passwordMatch[1] ? passwordMatch[1] : '';
                    const urlMatch = fullText.match(/(https?:\/\/[^\s]+)/);
                    let url = urlMatch && urlMatch[1] ? urlMatch[1] : '';
                    const fileName = file.name.replace(/_/g, ' ').replace(/\.pdf$/i, '');

                    if (url) {
                        outputString += `<a class="pdf-link" href="${url}" data-password="${password}" onclick="handlePdfLinkClick(event)">${fileName}<br>Ссылка: ${url}</a><p>Пароль: ${password}</p>`;
                        if (openFirst) {
                            copyToClipboard(password);
                            window.open(url, '_blank');
                        }
                    } else {
                        outputString += `<p>Ссылка не найдена для файла: ${file.name}</p>`;
                    }

                    resolve({ output: outputString });
                } catch (error) {
                    resolve({ output: `<p>Ошибка при обработке PDF: ${file.name} - ${error}</p>` });
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function handlePdfLinkClick(event) {
        event.preventDefault();
        const link = event.target;
        const url = link.href;
        const password = link.dataset.password;

        copyToClipboard(password);
        window.open(url, '_blank');
    }

    function closePdfExtractModal() {
        document.getElementById('pdfExtractModal').style.display = 'none';
    }

    function processXmlContent(content) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(content, "text/xml");

        const cadastralNumber = xmlDoc.getElementsByTagName('cadastral_number')[0]?.textContent ||
            xmlDoc.getElementsByTagName('cad_number')[0]?.textContent;

        if (cadastralNumber) {
            const rightRecords = xmlDoc.querySelectorAll('right_records > right_record');
            const ownerlessRecords = xmlDoc.querySelectorAll('ownerless_right_record');
            let owners = new Set();

            rightRecords.forEach(record => {
                const rightHolders = record.querySelectorAll('right_holders > right_holder');
                rightHolders.forEach(holder => {
                    const individual = holder.querySelector('individual');
                    const publicFormation = holder.querySelector('public_formation');
                    const legalEntity = holder.querySelector('legal_entity');

                    if (individual) {
                        const surname = getElementValue(individual, 'surname');
                        const name = getElementValue(individual, 'name');
                        const patronymic = getElementValue(individual, 'patronymic');
                        const ownerName = `${surname} ${name} ${patronymic}`.trim();
                        if (ownerName) owners.add(ownerName);
                    } else if (publicFormation) {
                        const publicFormationName = getElementValue(publicFormation, 'public_formation_type > russia > name > value');
                        if (publicFormationName) owners.add(publicFormationName);
                    } else if (legalEntity) {
                        let fullName, inn, ogrn;
                        if (legalEntity.querySelector('entity > government_entity')) {
                            fullName = getElementValue(legalEntity, 'entity > government_entity > full_name');
                            inn = getElementValue(legalEntity, 'entity > government_entity > inn');
                            ogrn = getElementValue(legalEntity, 'entity > government_entity > ogrn');
                        } else if (legalEntity.querySelector('entity > resident')) {
                            fullName = getElementValue(legalEntity, 'entity > resident > name');
                            inn = getElementValue(legalEntity, 'entity > resident > inn');
                            ogrn = getElementValue(legalEntity, 'entity > resident > ogrn');
                        } else {
                            fullName = getElementValue(legalEntity, 'name');
                            inn = getElementValue(legalEntity, 'inn');
                            ogrn = getElementValue(legalEntity, 'ogrn');
                        }
                        let ownerDetails = fullName;
                        if (inn) ownerDetails += ` ИНН:${inn}`;
                        if (ogrn) ownerDetails += ` ОГРН:${ogrn}`;
                        if (ownerDetails) owners.add(ownerDetails);
                    }
                });
            });

            ownerlessRecords.forEach(record => {
                const authorityName = getElementValue(record, 'ownerless_right_data > authority_name');
                if (authorityName) owners.add(authorityName);
            });

            if (owners.size > 0) {
                rightsMap.set(cadastralNumber, Array.from(owners));
            }
        }

        return {
            cadastralNumber: cadastralNumber,
            dateFormation: xmlDoc.getElementsByTagName('date_formation')[0]?.textContent
        };
    }

    function processZipFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            JSZip.loadAsync(data).then(function(zip) {
                const xmlFiles = Object.keys(zip.files).filter(fileName => fileName.endsWith('.xml'));
                if (xmlFiles.length > 0) {
                    zip.file(xmlFiles[0]).async("string").then(function(content) {
                        const xmlData = processXmlContent(content);
                        if (xmlData.cadastralNumber && xmlData.dateFormation) {
                            const newFileName = applyMask(
                                xmlData.cadastralNumber.includes(':') ? settings.extractMask : settings.kptMask,
                                xmlData.cadastralNumber,
                                xmlData.dateFormation
                            ) + '.zip';
                            renameAndDownloadFile(file, newFileName);
                        } else {
                            renameAndDownloadFile(file, file.name);
                        }
                        filesProcessed++;
                        if (filesProcessed === filesToProcess) {
                            displaySummaryTable();
                        }
                    });
                }
            });
        };
        reader.readAsArrayBuffer(file);
    }

    function processRightsZipFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            JSZip.loadAsync(data).then(function(zip) {
                const xmlFiles = Object.keys(zip.files).filter(fileName => fileName.endsWith('.xml'));
                if (xmlFiles.length > 0) {
                    zip.file(xmlFiles[0]).async("string").then(function(content) {
                        processXmlContent(content);
                        filesProcessed++;
                        if (filesProcessed === filesToProcess) {
                            displaySummaryTable();
                        }
                    });
                }
            });
        };
        reader.readAsArrayBuffer(file);
    }

    function processRightsXmlFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            processXmlContent(content);
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                displaySummaryTable();
            }
        };
        reader.readAsText(file);
    }

    function renameAndDownloadFile(file, newFileName) {
        const url = URL.createObjectURL(file);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = newFileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        updateResult(`${newFileName}`);
    }

    function displaySummaryTable() {
        const resultDiv = document.getElementById('result');
        let summaryData = [];

        rightsMap.forEach((owners, cadastralNumber) => {
            owners.forEach(owner => {
                summaryData.push(`${cadastralNumber}\t${owner}`);
            });
        });

        summaryData.sort();
        let tableHtml = `
            <div class="summary-table" style="margin-top: 20px;">
                <textarea readonly style="
                    width: 90%;
                    min-height: 200px;
                    background: white;
                    padding: 10px;
                    border-radius: 5px;
                    font-family: monospace;
                    font-size: 16px;
                    text-align: center;
                    border: 1px solid #ADD8E6;
                    outline: none;
                    resize: none;
                ">${summaryData.join('\n')}</textarea>
            </div>
        `;
        const existingContent = resultDiv.innerHTML.split('<div class="summary-table">')[0];
        resultDiv.innerHTML = existingContent + tableHtml;
    }

    function updateResult(message) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML += `<p>${message}</p>`;
        resultDiv.scrollTop = resultDiv.scrollHeight;
    }

    function handleFolderSelect(event) {
        const files = event.target.files;
        processFolders(files);
    }

    function processFolders(files) {
        const folders = new Map();
        const zipFiles = [];

        Array.from(files).forEach(file => {
            const pathParts = file.webkitRelativePath.split('/');

            if (file.name.toLowerCase().endsWith('.zip')) {
                zipFiles.push(file);
                return;
            }

            let folderName = pathParts.length > 2 ? pathParts[1] : 'root';
            if (!folders.has(folderName)) {
                folders.set(folderName, []);
            }
            folders.get(folderName).push(file);
        });

        zipFiles.forEach(file => {
            updateResult(`Обработка ZIP-файла: ${file.name}`);
            processZipFile(file);
        });

        folders.forEach((folderFiles, folderName) => {
            if (folderFiles.length === 0) return;

            const xmlFile = folderFiles.find(file => file.name.endsWith('.xml'));
            if (xmlFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const xmlData = processXmlContent(content);
                    let newFileName;
                    if (xmlData.cadastralNumber && xmlData.dateFormation) {
                        newFileName = applyMask(
                            xmlData.cadastralNumber.includes(':') ? settings.extractMask : settings.kptMask,
                            xmlData.cadastralNumber,
                            xmlData.dateFormation
                        ) + '.zip';
                    } else {
                        newFileName = `${folderName}.zip`;
                    }
                    createZipFromFolder(folderFiles, newFileName);
                };
                reader.readAsText(xmlFile);
            } else if (folderName !== 'root') {
                createZipFromFolder(folderFiles, `${folderName}.zip`);
            }
        });
    }

    function createZipFromFolder(files, zipName) {
        const zip = new JSZip();
        const folderPromises = [];

        files.forEach(file => {
            const fileName = file.name;
            folderPromises.push(
                new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        zip.file(fileName, e.target.result);
                        resolve();
                    };
                    reader.readAsArrayBuffer(file);
                })
            );
        });

        Promise.all(folderPromises).then(() => {
            zip.generateAsync({
                type: "blob",
                compression: "DEFLATE",
                compressionOptions: { level: 9 }
            }).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = zipName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                updateResult(`${zipName}`);
            });
        });
    }

    // Map-modal функции
    function openMapModal() {
        document.getElementById('mapModal').style.display = 'block';
    }

    function closeMapModal() {
        document.getElementById('mapModal').style.display = 'none';
    }

    function closeNspdResultModal() {
        document.getElementById('nspdResultModal').style.display = 'none';
    }

function isValidCadastralNumber(number) {
     
        return /^\d{1,2}:\d{1,2}:\d{6,7}:\d{1,}$/.test(number);
    }

    function isKadastrovyKvartal(number) {
    
        if (!/^\d{1,2}:\d{1,2}:\d{6,7}$/.test(number)) {
            return false;
        }

    
        const parts = number.split(':');
        const block = parts[2];

 
        if (/^0{6,7}$/.test(block)) {
            return false;
        }

        return true;
    }


  // Функция для создания задержки
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Обновленная функция processCadastralNumbers с индикатором загрузки
async function processCadastralNumbers() {
    const cadastralNumbersTextarea = document.getElementById('cadastralNumbers');
    const inputText = cadastralNumbersTextarea.value;
    const lines = inputText.split('\n').map(n => n.trim()).filter(n => n);

    const uniqueCadastralNumbers = new Set();
    const skippedZeroQuarters = new Set();

    lines.forEach(line => {
        const match = line.match(/\d{1,2}:\d{1,2}:\d{6,7}(?::\d{1,})?/);
        if (match) {
            const number = match[0];
            if (/^\d{1,2}:\d{1,2}:0{6,7}$/.test(number)) {
                skippedZeroQuarters.add(number);
            } else if (isValidCadastralNumber(number) || isKadastrovyKvartal(number)) {
                uniqueCadastralNumbers.add(number);
            }
        }
    });

    const numbersToProcess = Array.from(uniqueCadastralNumbers);
    cadastralNumbersTextarea.value = numbersToProcess.join('\n');

    if (numbersToProcess.length === 0 && skippedZeroQuarters.size === 0) {
        alert("Не найдено корректных кадастровых номеров.");
        return;
    }

    const loadingModal = document.getElementById('loadingModal');
    if (numbersToProcess.length > 0) {
        const progressBarFill = loadingModal.querySelector('.progress-bar-fill');
        loadingModal.style.display = 'block';
        progressBarFill.style.width = '0%';
    }

    const totalRequests = numbersToProcess.length;
    let completedRequests = 0;
    const results = [];

    for (const number of numbersToProcess) {
        try {
            const isQuarter = isKadastrovyKvartal(number);
            const thematicSearchId = isQuarter ? 2 : 1;
            const url = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=${thematicSearchId}&query=${number}`;
            const response = await fetch(url);
            const data = await response.json();

            if (isQuarter) {
                if (data.data && data.data.features && data.data.features.length > 0 && data.data.features[0].geometry.type === "Polygon") {
                    results.push({ cadastralNumber: number, categoryName: 'Кадастровый квартал', rightType: '' });
                } else if (data.code === 204) {
                    results.push({ cadastralNumber: number, categoryName: 'Нет данных', rightType: '', isNotFound: true });
                } else {
                    results.push({ cadastralNumber: number, categoryName: 'Ошибка обработки', rightType: '' });
                }
            } else {
                if (data.data && data.data.features && data.data.features.length > 0) {
                    const feature = data.data.features[0];
                    const categoryName = feature.properties.categoryName || 'Не указано';
                    const rightType = feature.properties.options && feature.properties.options.right_type === null 
                        ? 'Госсобственность' 
                        : (feature.properties.options && feature.properties.options.right_type !== undefined 
                            ? feature.properties.options.right_type 
                            : 'Не указано');
                    results.push({ cadastralNumber: number, categoryName, rightType });
                } else if (data.code === 204) {
                    results.push({ cadastralNumber: number, categoryName: 'Данные не найдены', rightType: '', isNotFound: true });
                } else {
                    results.push({ cadastralNumber: number, categoryName: 'Ошибка обработки', rightType: '' });
                }
            }
        } catch (error) {
            console.error(error);
            results.push({ cadastralNumber: number, categoryName: 'Ошибка запроса', rightType: '' });
        }

        completedRequests++;
        const progressBarFill = loadingModal.querySelector('.progress-bar-fill');
        const progressPercentage = (completedRequests / totalRequests) * 100;
        progressBarFill.style.width = `${progressPercentage}%`;

        await delay(500);
    }

    const resultBody = document.getElementById('nspdResultBody');
    resultBody.innerHTML = '';

    results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${result.cadastralNumber}</td>
            <td>${result.categoryName}</td>
            <td>${result.rightType}</td>
        `;
        if (result.isNotFound) {
            row.style.backgroundColor = '#ffe6e6';
            row.style.color = '#ff0000';
        }
        resultBody.appendChild(row);
    });

    const modalContent = document.querySelector('#nspdResultModal .modal-content');
    const tableElement = modalContent.querySelector('table');
    const oldWarning = document.getElementById('zeroQuarterWarning');
    
    if (oldWarning) {
        oldWarning.remove();
    }

    if (skippedZeroQuarters.size > 0) {
        const warningDiv = document.createElement('div');
        warningDiv.id = 'zeroQuarterWarning';
        warningDiv.style.cssText = `
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: left;
        `;

        const skippedList = Array.from(skippedZeroQuarters).join(', ');
        warningDiv.innerHTML = `
             Нулевые кварталы не обрабатываются:<br>
            <span style="font-family: monospace;">${skippedList}</span>
        `;

        tableElement.parentNode.insertBefore(warningDiv, tableElement);
    }

    loadingModal.style.display = 'none';
    closeMapModal();
    document.getElementById('nspdResultModal').style.display = 'block';
}


    // Check-list функции
    function openCheckListModal() {
        document.getElementById('checkListModal').style.display = 'block';
    }

    function closeCheckListModal() {
        document.getElementById('checkListModal').style.display = 'none';
    }

    function closeCheckListResultModal() {
        document.getElementById('checkListResultModal').style.display = 'none';
    }

    function openCheckList() {
        const input = document.getElementById('checkListInput').value;
        const lines = input.split('\n').map(line => line.trim()).filter(line => line);
        currentCheckListData = lines;
        renderCheckList(lines);
    }

    function renderCheckList(lines) {
        const originalCount = lines.length;
        const lineCount = new Map();
        lines.forEach(line => {
            lineCount.set(line, (lineCount.get(line) || 0) + 1);
        });

        const container = document.getElementById('checkListItems');
        const stats = document.getElementById('checkListStats');
        container.innerHTML = '';

        const uniqueCount = new Set(lines).size;
        stats.textContent = `Всего строк: ${originalCount}, Уникальных: ${uniqueCount}`;

        lines.forEach(line => {
            const div = document.createElement('div');
            div.className = 'check-list-item';
            if (lineCount.get(line) > 1) {
                div.classList.add('duplicate');
            }

            div.innerHTML = `
                <span class="checkmark">✓</span>
                <span class="item-text">${line}</span>
                <button class="copy-button" title="Скопировать">
                    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            `;

            const copyButton = div.querySelector('.copy-button');
            const copyIcon = div.querySelector('.copy-icon');

            copyButton.addEventListener('click', function(e) {
                e.stopPropagation();
                navigator.clipboard.writeText(line).then(() => {
                    div.classList.add('copy-flash');
                    copyIcon.classList.add('copied');
                    setTimeout(() => {
                        div.classList.remove('copy-flash');
                    }, 1500);
                });
            });

            div.addEventListener('dblclick', function(e) {
                this.classList.toggle('checked');
            });

            container.appendChild(div);
        });

        closeCheckListModal();
        document.getElementById('checkListResultModal').style.display = 'block';
    }

    function sortCheckList() {
        const items = document.querySelectorAll('.check-list-item');
        items.forEach(item => item.classList.add('sorting'));
        const sortedLines = [...currentCheckListData].sort((a, b) => a.localeCompare(b, 'ru'));
        setTimeout(() => {
            currentCheckListData = sortedLines;
            renderCheckList(sortedLines);
        }, 300);
    }

   
function parseXML() {
    function extractValue(pattern, xml) {
        const match = xml.match(pattern);
        return match ? match[1].trim() : '';
    }

    function extractAddressFromBlock(addressText) {
        if (!addressText) return '';
        
        const region = extractValue(/<address:region>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
        const district = extractValue(/<address:district>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
        const street = extractValue(/<address:street>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
        const house = extractValue(/<address:house>.*?<address:value>([^<]+)<\/address:value>/s, addressText);
        const apartment = extractValue(/<address:apartment>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
        const other = extractValue(/<address:other>([^<]+)<\/address:other>/s, addressText);

        let cityOrLocalityType = '', cityOrLocalityName = '';
        const cityTypeMatch = addressText.match(/<address:city>.*?<address:type>([^<]+)<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
        if (cityTypeMatch) {
            cityOrLocalityType = cityTypeMatch[1].trim();
            cityOrLocalityName = cityTypeMatch[2].trim();
        } else {
            const localityTypeMatch = addressText.match(/<address:locality>.*?<address:type>([^<]+)<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
            if (localityTypeMatch) {
                cityOrLocalityType = localityTypeMatch[1].trim();
                cityOrLocalityName = localityTypeMatch[2].trim();
            }
        }

        let address = region;
        if (district) address += `, ${district}`;
        if (cityOrLocalityType && cityOrLocalityName) address += `, ${cityOrLocalityType} ${cityOrLocalityName}`;
        if (street) address += `, ул. ${street}`;
        if (house) address += `, д. ${house}`;
        if (apartment) address += `, кв. ${apartment}`;
        if (other) address += `, ${other}`;
        
        return address.replace(/^, /, '').replace(/, ,/g, ',').trim();
    }

    function getDocumentById(xmlText, docId) {
        if (!docId) return null;
        
        const docRegex = new RegExp(
            `<docs:(?:idDocument|otherDocument)[^>]*_id="${docId}"[^>]*>([\\s\\S]*?)<\\/docs:(?:idDocument|otherDocument)>`,
            's'
        );
        const match = xmlText.match(docRegex);
        if (!match) return null;
        
        const docText = match[0];
        return {
            name: extractValue(/<docs:name>([^<]+)<\/docs:name>/, docText),
            number: extractValue(/<docs:number>([^<]+)<\/docs:number>/, docText),
            series: extractValue(/<docs:series>([^<]+)<\/docs:series>/, docText),
            issueDate: extractValue(/<docs:issueDate>([^<]+)<\/docs:issueDate>/, docText),
            issuer: extractValue(/<docs:issuer>.*?<docs:name>([^<]+)<\/docs:name>/s, docText)
        };
    }

    function formatDocument(doc) {
        if (!doc) return 'Не указан';
        let result = doc.name || '';
        if (doc.series) result += ` ${doc.series}`;
        if (doc.number) result += ` ${doc.number}`;
        if (doc.issuer) result += `, выдан ${doc.issuer}`;
        if (doc.issueDate) result += ` ${doc.issueDate}`;
        return result || 'Не указан';
    }

    const xmlText = document.getElementById('applicationInput').value;
    if (!xmlText) return;

    // Очищаем все таблицы
    document.getElementById('resultBody').innerHTML = '';
    document.getElementById('representativesBody').innerHTML = '';
    document.getElementById('objectsBody').innerHTML = '';
    document.getElementById('documentsBody').innerHTML = '';
    document.getElementById('statementInfo').innerHTML = '';
    document.getElementById('deliveryInfo').innerHTML = '';
    document.getElementById('representativesSection').style.display = 'none';

    // === 1. Информация о заявлении с использованием справочников ===
    const creationDate = extractValue(/<stCom:creationDate>([^<]+)<\/stCom:creationDate>/, xmlText);
    const statementTypeCode = extractValue(/<stCom:statementType>([^<]+)<\/stCom:statementType>/, xmlText);
    const actionCodeValue = extractValue(/<stCom:actionCode>([^<]+)<\/stCom:actionCode>/, xmlText);
    const cadastralActionMatch = xmlText.match(/cadastralActionType="([^"]+)"/);
    const cadastralActionCode = cadastralActionMatch ? cadastralActionMatch[1] : '';

    let statementInfoHtml = '<div style="display: grid; grid-template-columns: 1fr; gap: 10px;">';
    
    if (creationDate) {
        statementInfoHtml += `<div><strong>Дата создания:</strong> ${creationDate.replace('T', ' ')}</div>`;
    }
    
    if (statementTypeCode) {
        const statementTypeName = StatementDictionaries.getStatementType(statementTypeCode);
        statementInfoHtml += `<div><strong>Тип заявления:</strong> ${statementTypeName} <span style="color: #888; font-size: 0.85em;">(${statementTypeCode})</span></div>`;
    }
    
    if (actionCodeValue) {
        const actionCodeName = StatementDictionaries.getActionCode(actionCodeValue);
        statementInfoHtml += `<div><strong>Государственная услуга:</strong> ${actionCodeName} <span style="color: #888; font-size: 0.85em;">(${actionCodeValue})</span></div>`;
    }
    
    if (cadastralActionCode) {
        const cadastralActionName = StatementDictionaries.getCadastralAction(cadastralActionCode);
        statementInfoHtml += `<div><strong>Кадастровое действие:</strong> ${cadastralActionName} <span style="color: #888; font-size: 0.85em;">(${cadastralActionCode})</span></div>`;
    }
    
    statementInfoHtml += '</div>';
    document.getElementById('statementInfo').innerHTML = statementInfoHtml;

    // === 2. Заявители (owners) ===
   const resultBody = document.getElementById('resultBody');
const representativesBody = document.getElementById('representativesBody');

// Рекурсивная функция для обработки представителей
function processRepresentatives(repText, level, ownerName) {
    const representatives = [];
    
    const subjectMatch = repText.match(/<subj:subject[^>]*>([\s\S]*?)<\/subj:subject>/);
    if (!subjectMatch) return representatives;
    
    const subjectText = subjectMatch[1];
    
    // Проверяем, это организация или физ. лицо
    const orgMatch = subjectText.match(/<subj:organization>([\s\S]*?)<\/subj:organization>/);
    const personMatch = subjectText.match(/<subj:person>([\s\S]*?)<\/subj:person>/);
    
    // Получаем документ представителя
    const repDocRef = extractValue(/<subj:representativeDocumentRef[^>]*documentID="([^"]+)"/, repText);
    const repDoc = getDocumentById(xmlText, repDocRef);
    
    if (orgMatch) {
        // Представитель - юридическое лицо
        const orgText = orgMatch[1];
        const orgName = extractValue(/<subj:name>([^<]+)<\/subj:name>/, orgText);
        const inn = extractValue(/<subj:inn>([^<]+)<\/subj:inn>/, orgText);
        const ogrn = extractValue(/<subj:ogrn>([^<]+)<\/subj:ogrn>/, orgText);
        const kpp = extractValue(/<subj:kpp>([^<]+)<\/subj:kpp>/, orgText);
        
        representatives.push({
            level: level,
            type: 'Юр. лицо',
            name: orgName,
            innOrBirth: `ИНН: ${inn}${kpp ? '<br>КПП: ' + kpp : ''}`,
            ogrnOrSnils: `ОГРН: ${ogrn}`,
            contacts: '-',
            repDoc: formatDocument(repDoc),
            representsFor: ownerName,
            bgColor: level === 1 ? '#e3f2fd' : '#fff3e0'
        });
        
        // Проверяем вложенного представителя
        const nestedRepMatch = subjectText.match(/<subj:representative>([\s\S]*?)<\/subj:representative>/);
        if (nestedRepMatch) {
            const nestedReps = processRepresentatives(nestedRepMatch[0], level + 1, orgName);
            representatives.push(...nestedReps);
        }
    }
    
    if (personMatch) {
        // Представитель - физическое лицо
        const personText = personMatch[1];
        
        const surname = extractValue(/<subj:surname>([^<]+)<\/subj:surname>/, personText);
        const firstname = extractValue(/<subj:firstname>([^<]+)<\/subj:firstname>/, personText);
        const patronymic = extractValue(/<subj:patronymic>([^<]+)<\/subj:patronymic>/, personText);
        const birthDate = extractValue(/<subj:birthDate>([^<]+)<\/subj:birthDate>/, personText);
        const phone = extractValue(/<subj:phoneNumber>([^<]+)<\/subj:phoneNumber>/, personText);
        const email = extractValue(/<subj:email>([^<]+)<\/subj:email>/, personText);
        const snils = extractValue(/<subj:snils>([^<]+)<\/subj:snils>/, personText);
        
        representatives.push({
            level: level,
            type: 'Физ. лицо',
            name: `${surname} ${firstname} ${patronymic}`,
            innOrBirth: birthDate,
            ogrnOrSnils: snils,
            contacts: `${phone}${email ? '<br>' + email : ''}`,
            repDoc: formatDocument(repDoc),
            representsFor: ownerName,
            bgColor: level === 1 ? '#e8f5e9' : '#fce4ec'
        });
    }
    
    return representatives;
}

const ownerRegex = /<owner[^>]*>([\s\S]*?)<\/owner>/g;
const ownerMatches = [...xmlText.matchAll(ownerRegex)];

ownerMatches.forEach(match => {
    const ownerText = match[1];
    const orgMatch = ownerText.match(/<subj:organization>([\s\S]*?)<\/subj:organization>/);
    
    let ownerName = '';
    
    if (orgMatch) {
        // Заявитель - юридическое лицо
        const orgText = orgMatch[1];
        ownerName = extractValue(/<subj:name>([^<]+)<\/subj:name>/, orgText);
        const inn = extractValue(/<subj:inn>([^<]+)<\/subj:inn>/, orgText);
        const ogrn = extractValue(/<subj:ogrn>([^<]+)<\/subj:ogrn>/, orgText);
        const kpp = extractValue(/<subj:kpp>([^<]+)<\/subj:kpp>/, orgText);
        const regDate = extractValue(/<subj:regDate>([^<]+)<\/subj:regDate>/, orgText);

        const row = document.createElement('tr');
        row.style.backgroundColor = '#fff3e0';
        row.innerHTML = `
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Юр. лицо</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">${ownerName}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">ИНН: ${inn}${kpp ? '<br>КПП: ' + kpp : ''}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">ОГРН: ${ogrn}${regDate ? '<br>Дата рег.: ' + regDate : ''}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">-</td>
            <td style="border: 1px solid #ddd; padding: 8px;">-</td>
            <td style="border: 1px solid #ddd; padding: 8px;">-</td>
        `;
        resultBody.appendChild(row);

        // Обрабатываем представителей рекурсивно
        const representativeMatch = ownerText.match(/<subj:representative>([\s\S]*?)<\/subj:representative>/s);
        if (representativeMatch) {
            document.getElementById('representativesSection').style.display = 'block';
            const allRepresentatives = processRepresentatives(representativeMatch[0], 1, ownerName);
            
            allRepresentatives.forEach(rep => {
                const repRow = document.createElement('tr');
                repRow.style.backgroundColor = rep.bgColor;
                
                const levelLabel = rep.level === 1 
                    ? `Представитель<br><small style="color:#666;">от: ${rep.representsFor}</small>` 
                    : `Уровень ${rep.level}<br><small style="color:#666;">от: ${rep.representsFor}</small>`;
                
                repRow.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${levelLabel}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${rep.type}</strong></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rep.name}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rep.innOrBirth}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rep.ogrnOrSnils}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rep.contacts}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${rep.repDoc}</td>
                `;
                representativesBody.appendChild(repRow);
            });
        }
    } else {
        // Заявитель - физическое лицо
        const personMatch = ownerText.match(/<subj:person>([\s\S]*?)<\/subj:person>/);
        if (personMatch) {
            const personText = personMatch[1];
            
            const surname = extractValue(/<subj:surname>([^<]+)<\/subj:surname>/, personText);
            const firstname = extractValue(/<subj:firstname>([^<]+)<\/subj:firstname>/, personText);
            const patronymic = extractValue(/<subj:patronymic>([^<]+)<\/subj:patronymic>/, personText);
            ownerName = `${surname} ${firstname} ${patronymic}`;
            const birthDate = extractValue(/<subj:birthDate>([^<]+)<\/subj:birthDate>/, personText);
            const phone = extractValue(/<subj:phoneNumber>([^<]+)<\/subj:phoneNumber>/, personText);
            const snils = extractValue(/<subj:snils>([^<]+)<\/subj:snils>/, personText);
            
            const addressMatch = personText.match(/<subj:address>([\s\S]*?)<\/subj:address>/);
            const address = addressMatch ? extractAddressFromBlock(addressMatch[1]) : '';
            
            const idDocRef = extractValue(/documentID="([^"]+)"/, personText);
            const idDoc = getDocumentById(xmlText, idDocRef);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 8px;">Физ. лицо</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${ownerName}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${birthDate}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${snils}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${formatDocument(idDoc)}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${address}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${phone}</td>
            `;
            resultBody.appendChild(row);
            
            // Обрабатываем представителей для физ. лица (если есть)
            const representativeMatch = ownerText.match(/<subj:representative>([\s\S]*?)<\/subj:representative>/s);
            if (representativeMatch) {
                document.getElementById('representativesSection').style.display = 'block';
                const allRepresentatives = processRepresentatives(representativeMatch[0], 1, ownerName);
                
                allRepresentatives.forEach(rep => {
                    const repRow = document.createElement('tr');
                    repRow.style.backgroundColor = rep.bgColor;
                    
                    const levelLabel = rep.level === 1 
                        ? `Представитель<br><small style="color:#666;">от: ${rep.representsFor}</small>` 
                        : `Уровень ${rep.level}<br><small style="color:#666;">от: ${rep.representsFor}</small>`;
                    
                    repRow.innerHTML = `
                        <td style="border: 1px solid #ddd; padding: 8px;">${levelLabel}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>${rep.type}</strong></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${rep.name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${rep.innOrBirth}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${rep.ogrnOrSnils}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${rep.contacts}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${rep.repDoc}</td>
                    `;
                    representativesBody.appendChild(repRow);
                });
            }
        }
    }
});

    // === 3. Объекты с использованием справочника типов ===
    const objectsBody = document.getElementById('objectsBody');
    const objectRegex = /<stCom:object[^>]*>([\s\S]*?)<\/stCom:object>/g;
    const objectMatches = [...xmlText.matchAll(objectRegex)];

    objectMatches.forEach(match => {
        const objText = match[1];
        const typeCode = extractValue(/<obj:objectTypeCode>([^<]+)<\/obj:objectTypeCode>/, objText);
        const typeName = StatementDictionaries.getObjectType(typeCode);
        
        const oldCadNum = extractValue(/<obj:oldCadastralNumber>([^<]+)<\/obj:oldCadastralNumber>/, objText);
        const definitionMP = extractValue(/<obj:definitionMP>([^<]+)<\/obj:definitionMP>/, objText);
        const area = extractValue(/<obj:value>([^<]+)<\/obj:value>/, objText);
        
        const addressMatch = objText.match(/<obj:address>([\s\S]*?)<\/obj:address>/);
        const objAddress = addressMatch ? extractAddressFromBlock(addressMatch[1]) : '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="border: 1px solid #ddd; padding: 8px;">${typeName}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${oldCadNum || '-'}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${objAddress}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${area ? area + ' кв.м' : '-'}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${definitionMP || '-'}</td>
        `;
        objectsBody.appendChild(row);
    });

    // === 4. Приложенные документы ===
    const documentsBody = document.getElementById('documentsBody');


const appliedDocRegex = /<stCom:appliedDocument>([\s\S]*?)<\/stCom:appliedDocument>/g;
const appliedDocMatches = [...xmlText.matchAll(appliedDocRegex)];

let docNum = 1;
appliedDocMatches.forEach(match => {
    const docText = match[1];
    

    if (docText.includes('idDocument') || docText.includes('documentID=')) {
   
        const hasRealData = /<docs:name>/.test(docText);
        if (!hasRealData) return;
    }
    
    const name = extractValue(/<docs:name>([^<]+)<\/docs:name>/, docText);
    
   
    if (!name || 
        name.toLowerCase().includes('паспорт') || 
        name.toLowerCase().includes('удостоверение личности')) {
        return;
    }
    
    const number = extractValue(/<docs:number>([^<]+)<\/docs:number>/, docText);
    const series = extractValue(/<docs:series>([^<]+)<\/docs:series>/, docText);
    const issueDate = extractValue(/<docs:issueDate>([^<]+)<\/docs:issueDate>/, docText);
    const issuer = extractValue(/<docs:issuer>.*?<docs:name>([^<]+)<\/docs:name>/s, docText);
    const fileUri = extractValue(/<docs:fileURI>([^<]+)<\/docs:fileURI>/, docText);
    
    const fileName = fileUri ? fileUri.split('/').pop() : '-';
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td style="border: 1px solid #ddd; padding: 8px;">${docNum}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${name}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${series ? series + ' ' : ''}${number || '-'}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${issueDate || '-'}</td>
        <td style="border: 1px solid #ddd; padding: 8px;">${issuer || '-'}</td>
        <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.85em; word-break: break-all;">${fileName}</td>
    `;
    documentsBody.appendChild(row);
    docNum++;
});

    // === 5. Способ подачи и получения с использованием справочников ===
    const deliveryInfo = document.getElementById('deliveryInfo');
    const receivingMethod = extractValue(/<stCom:receivingMethodCode>([^<]+)<\/stCom:receivingMethodCode>/, xmlText);
    const regRightAuthority = extractValue(/<stCom:regRightAuthority>([^<]+)<\/stCom:regRightAuthority>/, xmlText);
    const territorialCode = extractValue(/<stCom:code>([^<]+)<\/stCom:code>/, xmlText);
    const resultType = extractValue(/<stCom:recieveResultTypeCode>([^<]+)<\/stCom:recieveResultTypeCode>/, xmlText);
    const receiveDischarge = extractValue(/<stCom:receiveDischarge>([^<]+)<\/stCom:receiveDischarge>/, xmlText);

    let deliveryHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
    deliveryHtml += '<div><strong>Способ подачи:</strong> ' + StatementDictionaries.getReceivingMethod(receivingMethod) + '</div>';
    deliveryHtml += '<div><strong>Способ получения результата:</strong> ' + StatementDictionaries.getResultType(resultType) + '</div>';
    if (regRightAuthority) deliveryHtml += '<div style="grid-column: 1 / -1;"><strong>Орган регистрации:</strong> ' + regRightAuthority + '</div>';
    if (territorialCode) deliveryHtml += '<div><strong>Код территориального органа:</strong> ' + territorialCode + '</div>';
    if (receiveDischarge) deliveryHtml += '<div><strong>Получить выписку:</strong> ' + (receiveDischarge === 'true' ? 'Да' : 'Нет') + '</div>';
    deliveryHtml += '</div>';
    
    deliveryInfo.innerHTML = deliveryHtml;
}

function saveStatementToHTML() {
    const statementInfo = document.getElementById('statementInfo').innerHTML;
    const resultBody = document.getElementById('resultBody').innerHTML;
    const representativesBody = document.getElementById('representativesBody').innerHTML;
    const objectsBody = document.getElementById('objectsBody').innerHTML;
    const documentsBody = document.getElementById('documentsBody').innerHTML;
    const deliveryInfo = document.getElementById('deliveryInfo').innerHTML;
    const hasRepresentatives = document.getElementById('representativesSection').style.display !== 'none';

    const currentDate = new Date().toLocaleDateString('ru-RU');
    
    const htmlContent = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявление - ${currentDate}</title>
    <style>
        @page {
            size: A4;
            margin: 15mm;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, Roboto, Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5fcff 0%, #e8f8ff 100%);
            padding: 30px;
            min-height: 100vh;
        }
        
        .document-container {
            max-width: 210mm;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(100, 181, 246, 0.15);
            overflow: hidden;
        }
        
        .document-header {
            padding: 30px 35px;
            border-bottom: 3px solid #81d4fa;
            text-align: center;
        }
        
        .header-title {
            font-size: 26pt;
            font-weight: 300;
            color: #0277bd;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .header-date {
            font-size: 10pt;
            color: #0288d1;
        }
        
        .document-body {
            padding: 30px 35px;
        }
        
        .section {
            margin-bottom: 28px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #b3e5fc;
        }
        
        .section-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }
        
        .section-title {
            font-size: 13pt;
            font-weight: 600;
            color: #0277bd;
            letter-spacing: 0.5px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fcff 0%, #f0f9ff 100%);
            border: 1px solid #b3e5fc;
            border-radius: 12px;
            padding: 20px;
        }
        
        .info-card div {
            padding: 8px 0;
            border-bottom: 1px solid #e1f5fe;
        }
        
        .info-card div:last-child {
            border-bottom: none;
        }
        
        .info-card strong {
            color: #0288d1;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(100, 181, 246, 0.1);
        }
        
        th {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: #ffffff;
            font-weight: 600;
            font-size: 9pt;
            padding: 14px 12px;
            text-align: center;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        td {
            padding: 12px;
            background: #ffffff;
            border-bottom: 1px solid #e1f5fe;
            vertical-align: top;
            color: #37474f;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:nth-child(even) td {
            background: #f8fcff;
        }
        
        tr:hover td {
            background: #e8f7ff;
        }
        
        .delivery-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 1px solid #a5d6a7;
            border-left: 4px solid #66bb6a;
            border-radius: 12px;
            padding: 20px;
        }
        
        .delivery-card strong {
            color: #2e7d32;
        }
        
        .signature-section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px dashed #b3e5fc;
        }
        
        .signature-grid {
            display: flex;
            justify-content: space-between;
            gap: 40px;
        }
        
        .signature-block {
            flex: 1;
            text-align: center;
        }
        
        .signature-line {
            height: 1px;
            background: linear-gradient(90deg, transparent, #0288d1, transparent);
            margin-top: 55px;
            margin-bottom: 8px;
        }
        
        .signature-label {
            font-size: 9pt;
            color: #0288d1;
            font-weight: 500;
        }
        
        .document-footer {
            background: linear-gradient(135deg, #f5fcff 0%, #e8f8ff 100%);
            padding: 20px 35px;
            text-align: center;
            border-top: 1px solid #b3e5fc;
        }
        
        .footer-text {
            font-size: 9pt;
            color: #4fc3f7;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .document-container {
                box-shadow: none;
                border-radius: 0;
            }
            
            th {
                background: #29b6f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            tr:nth-child(even) td {
                background: #f8fcff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .section-header {
                page-break-after: avoid;
            }
            
            table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="document-container">
        <div class="document-header">
            <div class="header-title">ЗАЯВЛЕНИЕ</div>
            <div class="header-date">Дата формирования: ${currentDate}</div>
        </div>
        
        <div class="document-body">
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">📋</div>
                    <div class="section-title">Сведения о заявлении</div>
                </div>
                <div class="info-card">
                    ${statementInfo}
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">👥</div>
                    <div class="section-title">Заявители</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Тип</th>
                            <th>Наименование / ФИО</th>
                            <th>ИНН / Дата рождения</th>
                            <th>ОГРН / СНИЛС</th>
                            <th>Документ</th>
                            <th>Адрес</th>
                            <th>Телефон</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${resultBody}
                    </tbody>
                </table>
            </div>
            
      ${hasRepresentatives ? `
<div class="section">
    <div class="section-header">
        <div class="section-icon">👤</div>
        <div class="section-title">Представители</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Уровень</th>
                <th>Тип</th>
                <th>Наименование / ФИО</th>
                <th>ИНН / Дата рождения</th>
                <th>ОГРН / СНИЛС</th>
                <th>Контакты</th>
                <th>Документ представителя</th>
            </tr>
        </thead>
        <tbody>
            ${representativesBody}
        </tbody>
    </table>
</div>
` : ''}
            
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">🏠</div>
                    <div class="section-title">Объекты недвижимости</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Тип объекта</th>
                            <th>Кадастровый номер</th>
                            <th>Адрес объекта</th>
                            <th>Площадь</th>
                            <th>Обозначение в МП</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${objectsBody}
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">📎</div>
                    <div class="section-title">Приложенные документы</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">№</th>
                            <th>Наименование</th>
                            <th>Номер</th>
                            <th>Дата</th>
                            <th>Кем выдан</th>
                            <th>Файл</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documentsBody}
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">📬</div>
                    <div class="section-title">Способ подачи и получения</div>
                </div>
                <div class="delivery-card">
                    ${deliveryInfo}
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature-grid">
                    <div class="signature-block">
                        <div class="signature-line"></div>
                        <div class="signature-label">Подпись заявителя</div>
                    </div>
                    <div class="signature-block">
                        <div class="signature-line"></div>
                        <div class="signature-label">Расшифровка подписи</div>
                    </div>
                    <div class="signature-block">
                        <div class="signature-line"></div>
                        <div class="signature-label">Дата</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="document-footer">
            <div class="footer-text">Документ сформирован • ${currentDate}</div>
        </div>
    </div>
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Заявление_${currentDate.replace(/\./g, '-')}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

    function openRenameModal() {
        document.getElementById('renameModal').style.display = 'block';
    }

    function closeRenameModal() {
        document.getElementById('renameModal').style.display = 'none';
        document.getElementById('replaceText').value = '';
        document.getElementById('newText').value = '';
    }

    function openFileSelector() {
        document.getElementById('renameFileInput').click();
    }

    function openApplicationModal() {
        document.getElementById('applicationModal').style.display = 'block';
    }

    function closeApplicationModal() {
        document.getElementById('applicationModal').style.display = 'none';
    }

    function closeApplicationResultModal() {
        document.getElementById('applicationResultModal').style.display = 'none';
    }

    function processApplication() {
        const xmlText = document.getElementById('applicationInput').value;
        if (!xmlText.trim()) {
            alert('Пожалуйста, вставьте текст заявления');
            return;
        }

        parseXML();
        const resultBody = document.getElementById('resultBody');
        if (resultBody.children.length > 0) {
            closeApplicationModal();
            document.getElementById('applicationResultModal').style.display = 'block';
        } else {
            alert('Данные в заявлении не найдены.');
        }
    }
    
    
    document.getElementById('xmlDocsMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openXmlDocsModal();
    });

  // Добавляем обработчик для нового пункта меню "Схема смежного ЗУ"
    document.getElementById('smezhnMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openSmezhnDocsModal();
    });

    // Функции для управления новым модальным окном
    function openSmezhnDocsModal() {
        document.getElementById('smezhnDocsModal').style.display = 'block';
        feather.replace(); // Обновляем иконки в модальном окне
    }

    function closeSmezhnDocsModal() {
        document.getElementById('smezhnDocsModal').style.display = 'none';
    }

    // Закрытие окна по клику на фон
    const smezhnModal = document.getElementById('smezhnDocsModal');
    smezhnModal.addEventListener('click', function(event) {
        if (event.target === smezhnModal) {
            closeSmezhnDocsModal();
        }
    });
  
    function openXmlDocsModal() {
        document.getElementById('xmlDocsModal').style.display = 'block';
        // Обязательно вызываем для отрисовки иконок в появившемся окне
        feather.replace(); 
    }

    function closeXmlDocsModal() {
        document.getElementById('xmlDocsModal').style.display = 'none';
    }

    // (Опционально) Закрытие окна по клику на фон
    const xmlModal = document.getElementById('xmlDocsModal');
    xmlModal.addEventListener('click', function(event) {
        // Если кликнули на сам фон (а не на его содержимое)
        if (event.target === xmlModal) {
            closeXmlDocsModal();
        }
    });
    
    </script>
</body>
</html>
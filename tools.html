<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инструменты</title>
    <link rel="icon" href="img/ren.png" type="image/png">
       <script src="webfonts/feather.min.js"></script>
    <script src="webfonts/pdf.min2.js"></script>
    <script src="webfonts/jszip.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap');

        :root {
            --border-radius: 10px;
            --spacer: 1rem;
            --primary: #406ff3;
            --text: #6a778e;
            --link-height: calc(var(--spacer) * 3.5);
            --timing: 250ms;
        }

        body {
            background: #eaeef6;
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar {
            position: fixed;
            top: var(--spacer);
            left: var(--spacer);
            background: #fff;
            border-radius: var(--border-radius);
            padding: var(--spacer) 0;
            box-shadow: 0 0 40px rgba(0,0,0,0.03);
            height: calc(100vh - calc(var(--spacer) * 4));
        }

        .navbar__menu {
            list-style-type: none;
            padding: 0;
            margin: 0;
            position: relative;
        }

        .navbar__item {
            margin: 0;
            padding: 0;
            position: relative;
        }

        .navbar__link {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--link-height);
            width: calc(var(--spacer) * 5.5);
            color: var(--text);
            transition: var(--timing) ease all;
            text-decoration: none;
        }

        .navbar__link span {
            position: absolute;
            left: 100%;
            transform: translate(calc(var(--spacer) * -3));
            margin-left: 1rem;
            opacity: 0;
            pointer-events: none;
            color: var(--primary);
            background: #fff;
            padding: calc(var(--spacer) * 0.75);
            transition: var(--timing) ease all;
            border-radius: calc(var(--border-radius) * 1.75);
            white-space: nowrap;
        }

        .navbar__item:before {
            content: '';
            position: absolute;
            opacity: 0;
            z-index: -1;
            top: 0;
            left: var(--spacer);
            width: var(--link-height);
            height: var(--link-height);
            background: var(--primary);
            border-radius: calc(var(--border-radius) * 1.75);
            transition: var(--timing) cubic-bezier(1, 0.2, 0.1, 1.2) all;
        }

        .navbar__item:hover:before {
            opacity: 1;
        }

        .navbar__link:hover {
            color: #fff;
        }

        .navbar:not(:hover) .navbar__link:focus span,
        .navbar__link:hover span {
            opacity: 1;
            transform: translate(0);
        }

        @keyframes gooeyEffect {
            0% { transform: scale(1, 1); }
            50% { transform: scale(0.5, 1.5); }
            100% { transform: scale(1, 1); }
        }

        .navbar__item:hover:before {
            animation: gooeyEffect var(--timing) 1;
        }

        .content {
            margin-left: calc(var(--spacer) * 8);
            padding: var(--spacer);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .drop-zone {
            border: 2px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin: 20px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
        }

        .drop-zone.drag-over {
            background: rgba(64, 111, 243, 0.1);
            border-color: #2851d4;
        }

        .drop-zone p {
            margin: 0;
            color: var(--text);
            font-size: 1.2em;
        }

        .loading-indicator {
            display: none;
            color: var(--primary);
        }

        #result {
            margin-top: var(--spacer);
            padding: var(--spacer);
            background: #fff;
            border-radius: var(--border-radius);
            max-width: 80%;
            width: 100%;
        }

        .check-list-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            position: relative;
            transform-origin: center;
            animation: none;
            justify-content: space-between;
        }

        .check-list-item:nth-child(odd) {
            background-color: #e9ecef;
        }

        .check-list-item:hover {
            transform: translateX(5px);
        }

        .check-list-item.checked {
            background-color: #90EE90;
        }

        .checkmark {
            position: absolute;
            left: 10px;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 20px;
        }

        .checked .checkmark {
            opacity: 1;
        }

        .item-text {
            flex-grow: 1;
            text-align: center;
            padding: 0 30px;
        }

        .check-list-item.duplicate {
            background-color: #FFB74D;
        }

        .check-list-item.duplicate:nth-child(odd) {
            background-color: #FFA726;
        }

        .check-list-item.checked.duplicate {
            background-color: #90EE90;
        }

        @keyframes sortAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .sorting {
            animation: sortAnimation 0.3s ease;
        }

        .copy-button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-button:hover {
            opacity: 1;
        }

        .copy-icon {
            transition: all 0.3s ease;
        }

        .copy-icon.copied {
            stroke: #00cc00;
            filter: drop-shadow(0 0 2px rgba(0, 204, 0, 0.7));
        }

        @keyframes flash {
            0%, 100% { background-color: inherit; }
            50% { background-color: rgba(0, 255, 0, 0.2); }
        }

        .copy-flash {
            animation: flash 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 70%;
            max-width: 500px;
            text-align: left;
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-content input,
        .modal-content textarea {
            width: 95%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .modal-content button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .modal-content button[data-action="cancel"] {
            background: #ff2c2c;
        }

        .pdf-link {
            display: block;
            padding: 10px;
            margin: 5px 0;
            background-color: #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: var(--text);
            transition: background-color 0.3s ease;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .pdf-link:hover {
            background-color: #d0d0d0;
        }

        #pdfOutput p {
            padding-left: 10px;
            word-wrap: break-word;
            font-size: 0.8em;
        }

        /* Стили для NSPD модального окна */
        #nspdResultModal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        #nspdResultModal .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #nspdResultModal h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary);
        }

      #nspdResultModal table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#nspdResultModal th,
#nspdResultModal td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: center; /* Изменено с left на center */
}

#nspdResultModal th {
    background-color: var(--primary);
    color: white;
    font-weight: 600;
}

#nspdResultModal tr:nth-child(even) {
    background-color: #f9f9f9;
}

#nspdResultModal tr:hover {
    background-color: #f1f1f1;
}

        #nspdResultModal button {
            background: #00bb77;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            float: right;
            transition: background 0.3s ease;
        }

        #nspdResultModal button:hover {
            background: #009966;
        }
        
 .progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar-fill {
    width: 0%; /* Начальное значение */
    height: 100%;
    background-color: #406ff3;
    transition: width 0.3s ease-in-out; /* Плавный переход для изменения ширины */
}

        /* Стили для модального окна XML документов */
        #xmlDocsModal .xml-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 25px 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 650px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            text-align: center;
        }

        #xmlDocsModal .xml-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        #xmlDocsModal .xml-modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.4em;
        }

        #xmlDocsModal .close-button {
            background: none;
            border: none;
            font-size: 2.5em;
            line-height: 1;
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s ease;
            padding: 0;
        }

        #xmlDocsModal .close-button:hover {
            color: #333;
        }

        #xmlDocsModal .xml-modal-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .xml-menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .xml-menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(64, 111, 243, 0.1);
            background-color: #fff;
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .xml-menu-button i {
            width: 32px;
            height: 32px;
            margin-bottom: 10px;
        }


    </style>
</head>
<body>
    <nav class="navbar">
        <ul class="navbar__menu">
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="zipMenuItem"><i data-feather="edit"></i><span>Переименовать ZIP выписки</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="renameFoldersMenuItem"><i data-feather="folder"></i><span>Переименовать папки с выписками</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="renameFilesMenuItem"><i data-feather="file"></i><span>Переименовать файлы</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="rightsMenuItem"><i data-feather="users"></i><span>Правообладатели</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="mapMenuItem"><i data-feather="map"></i><span>Кадастровые номера (Проверка наличия)</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="checkListMenuItem"><i data-feather="check-square"></i><span>Отметить в списке</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="applicationMenuItem"><i data-feather="file-text"></i><span>Заявление</span></a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="extractPdfMenuItem"><i data-feather="link"></i><span>Решение о предоставлении документов ГФДЗ</span></a>
            </li>
            
               <li class="navbar__item">
                <a href="схема_на_кпт.html" target="_blank" rel="noopener noreferrer" class="navbar__link">
                    <i data-feather="award"></i><span>Постановление</span>
                </a>
            </li>
            
       <li class="navbar__item">
                <a href="схема_смежного_зу.html" target="_blank" rel="noopener noreferrer" class="navbar__link">
              <i data-feather="layout"></i><span>Схема смежного ЗУ</span>
                </a>
            </li>
                    
            <li class="navbar__item">
                <a href="#" class="navbar__link" id="xmlDocsMenuItem"><i data-feather="database"></i><span>XML документы</span></a>
            </li>
            
        </ul>
    </nav>

    <div class="content">
        <h1>Переименование ZIP и папок с выписками</h1>
        <div class="drop-zone">
            <p>Перетащите файлы сюда или нажмите</p>
            <div class="loading-indicator"></div>
        </div>
        <div id="result"></div>
    </div>

    <div id="renameModal" class="modal">
        <div class="modal-content">
            <h3>Параметры для переименования файлов</h3>
            <label for="replaceText">Текст в имени файлов</label>
            <input type="text" id="replaceText" placeholder="Текст для замены">
            <label for="newText">будет заменен на следующий текст:</label>
            <input type="text" id="newText" placeholder="Новый текст">
            <div style="text-align: right;">
                <button onclick="openFileSelector()">Выбрать файлы</button>
                <button data-action="cancel" onclick="closeRenameModal()">Отмена</button>
            </div>
        </div>
    </div>

    <div id="mapModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Текст с кадастровыми номерами</h3>
            <textarea id="cadastralNumbers" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="processCadastralNumbers()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Обработать</button>
                <button onclick="closeMapModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

    <div id="checkListModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Список для отметок</h3>
            <textarea id="checkListInput" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="openCheckList()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Открыть список</button>
                <button onclick="closeCheckListModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

    <div id="checkListResultModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 70%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; text-align: center;">Список для отметок</h3>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                <div id="checkListStats" style="color: #007bff; font-weight: bold;"></div>
                <button onclick="sortCheckList()" style="background: #406ff3; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;">Сортировать</button>
            </div>
            <div id="checkListItems" style="margin-top: 20px;"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeCheckListResultModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="applicationModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 500px;">
            <h3 style="margin-top: 0;">Вставьте XML заявления</h3>
            <textarea id="applicationInput" style="width: 95%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            <div style="text-align: right;">
                <button onclick="processApplication()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Открыть</button>
                <button onclick="closeApplicationModal()" style="background: #ff2c2c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Отмена</button>
            </div>
        </div>
    </div>

    <div id="applicationResultModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; text-align: center;">Заявление</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Фамилия</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Имя</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Отчество</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Дата рождения</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Документ</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">СНИЛС</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Адрес</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Телефон</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5;">Адрес объекта</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeApplicationResultModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="pdfExtractModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 70%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; text-align: center;">Ссылки из PDF</h3>
            <div id="pdfOutput" style="margin-top: 20px;"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closePdfExtractModal()" style="background: #00bb77; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Закрыть</button>
            </div>
        </div>
    </div>

    <div id="nspdResultModal">
        <div class="modal-content">
            <h3>Проверка наличия кадастрового номера</h3>
            <table>
                <thead>
                    <tr>
                        <th>Кадастровый номер</th>
                        <th>Тип объекта</th>
                        <th>Сведения о правах</th>
                    </tr>
                </thead>
                <tbody id="nspdResultBody"></tbody>
            </table>
            <button onclick="closeNspdResultModal()">Закрыть</button>
        </div>
    </div>
    
    <div id="loadingModal" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background-color: white; margin: 20% auto; padding: 20px; border-radius: 10px; width: 50%; max-width: 400px; text-align: center;">
        <h3 style="margin-top: 0; color: #406ff3;">Загрузка данных...</h3>
        <div class="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>
        <p style="margin-top: 10px; color: #6a778e;"></p>
    </div>
</div>

    <!-- НАЧАЛО: Модальное окно для XML документов -->
    <div id="xmlDocsModal" class="modal">
        <div class="xml-modal-content">
            <div class="xml-modal-header">
                <h3>XML документы</h3>
                <button class="close-button" onclick="closeXmlDocsModal()">×</button>
            </div>
            <div class="xml-modal-body">
                <a href="xml_выписка_зу.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="file-text"></i>
                    <span>Выписка ЗУ</span>
                </a>
                <a href="xml_выписка_окс.html" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="home"></i>
                    <span>Выписка ОКС</span>
                </a>
                <a href="xml_zu" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="map-pin"></i>
                    <span>КПТ ЗУ</span>
                </a>
                <a href="xml_oks" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="briefcase"></i>
                    <span>КПТ ОКС</span>
                </a>
                <a href="xml_ter" target="_blank" rel="noopener noreferrer" class="xml-menu-button">
                    <i data-feather="layers"></i>
                    <span>КПТ Территории</span>
                </a>
            </div>
        </div>
    </div>
    <!-- КОНЕЦ: Модальное окно для XML документов -->

    <input type="file" id="fileInput" style="display: none;" multiple accept=".zip">
    <input type="file" id="renameFileInput" style="display: none;" multiple>
    <input type="file" id="rightsFileInput" style="display: none;" multiple accept=".zip,.xml">
    <input type="file" id="pdfFileInput" style="display: none;" multiple accept=".pdf">
    
    


    <script>
    feather.replace();
 pdfjsLib.GlobalWorkerOptions.workerSrc = 'webfonts/pdf.worker.min2.js';
    // Глобальные переменные
    let filesToProcess = 0;
    let filesProcessed = 0;
    let rightsMap = new Map();
    let currentCheckListData = [];

    // Фиксированные настройки
    const settings = {
        extractMask: "{cadastralNumber} {date}",
        kptMask: "{cadNumber} {date}"
    };

    // Получаем элементы DOM
    const dropZone = document.querySelector('.drop-zone');
    const loadingIndicator = document.querySelector('.loading-indicator');

    // Обработчики меню
    document.getElementById('zipMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('fileInput').click();
    });
    document.getElementById('renameFilesMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openRenameModal();
    });
    document.getElementById('renameFoldersMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        const input = document.createElement('input');
        input.type = 'file';
        input.webkitdirectory = true;
        input.addEventListener('change', handleFolderSelect);
        input.click();
    });
    document.getElementById('rightsMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('rightsFileInput').click();
    });
    document.getElementById('extractPdfMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('pdfFileInput').click();
    });
    document.getElementById('mapMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openMapModal();
    });
    document.getElementById('checkListMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openCheckListModal();
    });
    document.getElementById('applicationMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openApplicationModal();
    });

    // Обработчики файлов
    document.getElementById('fileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleFiles(event.target.files);
    });
    document.getElementById('rightsFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleRightsFiles(event.target.files);
    });
    document.getElementById('renameFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handleRenameFiles(event.target.files);
    });
    document.getElementById('pdfFileInput').addEventListener('change', function(event) {
        event.preventDefault();
        handlePdfFiles(event.target.files);
    });

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-over');
        loadingIndicator.style.display = 'block';
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
        loadingIndicator.style.display = 'none';
    }

    dropZone.addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    });

    // Вспомогательные функции
    function getElementValue(parent, selector) {
        const element = parent.querySelector(selector);
        return element ? element.textContent : '';
    }

    function applyMask(mask, number, date) {
        return mask.replace(/{cadastralNumber}|{cadNumber}/g, number.replace(/:/g, '_'))
            .replace('{date}', date);
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text);
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Не удалось скопировать текст: ', err);
            }
            document.body.removeChild(textArea);
        }
    }

    // Основные функции обработки
    function handleFiles(files) {
        rightsMap.clear();
        filesToProcess = files.length;
        filesProcessed = 0;

        [...files].forEach(file => {
            if (file.name.toLowerCase().endsWith('.zip')) {
                updateResult(`Обработка файла: ${file.name}`);
                processZipFile(file);
            }
        });
    }

    function handleRenameFiles(files) {
        const replaceText = document.getElementById('replaceText').value;
        const newText = document.getElementById('newText').value;

        [...files].forEach(file => {
            let newFileName = file.name;
            if (replaceText && newText) {
                newFileName = file.name.replace(replaceText, newText);
            }
            renameAndDownloadFile(file, newFileName);
        });
        closeRenameModal();
    }

    function handlePdfFiles(files) {
        const pdfOutputDiv = document.getElementById('pdfOutput');
        pdfOutputDiv.innerHTML = '';

        const pdfArray = Array.from(files);
        const openFirst = pdfArray.length === 1;

        Promise.all(pdfArray.map(file => processPdf(file, openFirst))).then(results => {
            results.forEach(res => {
                pdfOutputDiv.innerHTML += res.output;
            });
            document.getElementById('pdfExtractModal').style.display = 'block';
        });
    }

    function handleRightsFiles(files) {
        rightsMap.clear();
        filesToProcess = files.length;
        filesProcessed = 0;

        [...files].forEach(file => {
            if (file.name.toLowerCase().endsWith('.zip')) {
                processRightsZipFile(file);
            } else if (file.name.toLowerCase().endsWith('.xml')) {
                processRightsXmlFile(file);
            }
        });
    }

    function processPdf(file, openFirst = false) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = async function (event) {
                let outputString = "";
                const typedArray = new Uint8Array(event.target.result);

                try {
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    let fullText = '';

                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + ' ';
                    }

                    const passwordMatch = fullText.match(/Пароль для скачивания:\s*([^\s\n]+)/);
                    let password = passwordMatch && passwordMatch[1] ? passwordMatch[1] : '';
                    const urlMatch = fullText.match(/(https?:\/\/[^\s]+)/);
                    let url = urlMatch && urlMatch[1] ? urlMatch[1] : '';
                    const fileName = file.name.replace(/_/g, ' ').replace(/\.pdf$/i, '');

                    if (url) {
                        outputString += `<a class="pdf-link" href="${url}" data-password="${password}" onclick="handlePdfLinkClick(event)">${fileName}<br>Ссылка: ${url}</a><p>Пароль: ${password}</p>`;
                        if (openFirst) {
                            copyToClipboard(password);
                            window.open(url, '_blank');
                        }
                    } else {
                        outputString += `<p>Ссылка не найдена для файла: ${file.name}</p>`;
                    }

                    resolve({ output: outputString });
                } catch (error) {
                    resolve({ output: `<p>Ошибка при обработке PDF: ${file.name} - ${error}</p>` });
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function handlePdfLinkClick(event) {
        event.preventDefault();
        const link = event.target;
        const url = link.href;
        const password = link.dataset.password;

        copyToClipboard(password);
        window.open(url, '_blank');
    }

    function closePdfExtractModal() {
        document.getElementById('pdfExtractModal').style.display = 'none';
    }

    function processXmlContent(content) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(content, "text/xml");

        const cadastralNumber = xmlDoc.getElementsByTagName('cadastral_number')[0]?.textContent ||
            xmlDoc.getElementsByTagName('cad_number')[0]?.textContent;

        if (cadastralNumber) {
            const rightRecords = xmlDoc.querySelectorAll('right_records > right_record');
            const ownerlessRecords = xmlDoc.querySelectorAll('ownerless_right_record');
            let owners = new Set();

            rightRecords.forEach(record => {
                const rightHolders = record.querySelectorAll('right_holders > right_holder');
                rightHolders.forEach(holder => {
                    const individual = holder.querySelector('individual');
                    const publicFormation = holder.querySelector('public_formation');
                    const legalEntity = holder.querySelector('legal_entity');

                    if (individual) {
                        const surname = getElementValue(individual, 'surname');
                        const name = getElementValue(individual, 'name');
                        const patronymic = getElementValue(individual, 'patronymic');
                        const ownerName = `${surname} ${name} ${patronymic}`.trim();
                        if (ownerName) owners.add(ownerName);
                    } else if (publicFormation) {
                        const publicFormationName = getElementValue(publicFormation, 'public_formation_type > russia > name > value');
                        if (publicFormationName) owners.add(publicFormationName);
                    } else if (legalEntity) {
                        let fullName, inn, ogrn;
                        if (legalEntity.querySelector('entity > government_entity')) {
                            fullName = getElementValue(legalEntity, 'entity > government_entity > full_name');
                            inn = getElementValue(legalEntity, 'entity > government_entity > inn');
                            ogrn = getElementValue(legalEntity, 'entity > government_entity > ogrn');
                        } else if (legalEntity.querySelector('entity > resident')) {
                            fullName = getElementValue(legalEntity, 'entity > resident > name');
                            inn = getElementValue(legalEntity, 'entity > resident > inn');
                            ogrn = getElementValue(legalEntity, 'entity > resident > ogrn');
                        } else {
                            fullName = getElementValue(legalEntity, 'name');
                            inn = getElementValue(legalEntity, 'inn');
                            ogrn = getElementValue(legalEntity, 'ogrn');
                        }
                        let ownerDetails = fullName;
                        if (inn) ownerDetails += ` ИНН:${inn}`;
                        if (ogrn) ownerDetails += ` ОГРН:${ogrn}`;
                        if (ownerDetails) owners.add(ownerDetails);
                    }
                });
            });

            ownerlessRecords.forEach(record => {
                const authorityName = getElementValue(record, 'ownerless_right_data > authority_name');
                if (authorityName) owners.add(authorityName);
            });

            if (owners.size > 0) {
                rightsMap.set(cadastralNumber, Array.from(owners));
            }
        }

        return {
            cadastralNumber: cadastralNumber,
            dateFormation: xmlDoc.getElementsByTagName('date_formation')[0]?.textContent
        };
    }

    function processZipFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            JSZip.loadAsync(data).then(function(zip) {
                const xmlFiles = Object.keys(zip.files).filter(fileName => fileName.endsWith('.xml'));
                if (xmlFiles.length > 0) {
                    zip.file(xmlFiles[0]).async("string").then(function(content) {
                        const xmlData = processXmlContent(content);
                        if (xmlData.cadastralNumber && xmlData.dateFormation) {
                            const newFileName = applyMask(
                                xmlData.cadastralNumber.includes(':') ? settings.extractMask : settings.kptMask,
                                xmlData.cadastralNumber,
                                xmlData.dateFormation
                            ) + '.zip';
                            renameAndDownloadFile(file, newFileName);
                        } else {
                            renameAndDownloadFile(file, file.name);
                        }
                        filesProcessed++;
                        if (filesProcessed === filesToProcess) {
                            displaySummaryTable();
                        }
                    });
                }
            });
        };
        reader.readAsArrayBuffer(file);
    }

    function processRightsZipFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = e.target.result;
            JSZip.loadAsync(data).then(function(zip) {
                const xmlFiles = Object.keys(zip.files).filter(fileName => fileName.endsWith('.xml'));
                if (xmlFiles.length > 0) {
                    zip.file(xmlFiles[0]).async("string").then(function(content) {
                        processXmlContent(content);
                        filesProcessed++;
                        if (filesProcessed === filesToProcess) {
                            displaySummaryTable();
                        }
                    });
                }
            });
        };
        reader.readAsArrayBuffer(file);
    }

    function processRightsXmlFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            processXmlContent(content);
            filesProcessed++;
            if (filesProcessed === filesToProcess) {
                displaySummaryTable();
            }
        };
        reader.readAsText(file);
    }

    function renameAndDownloadFile(file, newFileName) {
        const url = URL.createObjectURL(file);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = newFileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        updateResult(`${newFileName}`);
    }

    function displaySummaryTable() {
        const resultDiv = document.getElementById('result');
        let summaryData = [];

        rightsMap.forEach((owners, cadastralNumber) => {
            owners.forEach(owner => {
                summaryData.push(`${cadastralNumber}\t${owner}`);
            });
        });

        summaryData.sort();
        let tableHtml = `
            <div class="summary-table" style="margin-top: 20px;">
                <textarea readonly style="
                    width: 90%;
                    min-height: 200px;
                    background: white;
                    padding: 10px;
                    border-radius: 5px;
                    font-family: monospace;
                    font-size: 16px;
                    text-align: center;
                    border: 1px solid #ADD8E6;
                    outline: none;
                    resize: none;
                ">${summaryData.join('\n')}</textarea>
            </div>
        `;
        const existingContent = resultDiv.innerHTML.split('<div class="summary-table">')[0];
        resultDiv.innerHTML = existingContent + tableHtml;
    }

    function updateResult(message) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML += `<p>${message}</p>`;
        resultDiv.scrollTop = resultDiv.scrollHeight;
    }

    function handleFolderSelect(event) {
        const files = event.target.files;
        processFolders(files);
    }

    function processFolders(files) {
        const folders = new Map();
        const zipFiles = [];

        Array.from(files).forEach(file => {
            const pathParts = file.webkitRelativePath.split('/');

            if (file.name.toLowerCase().endsWith('.zip')) {
                zipFiles.push(file);
                return;
            }

            let folderName = pathParts.length > 2 ? pathParts[1] : 'root';
            if (!folders.has(folderName)) {
                folders.set(folderName, []);
            }
            folders.get(folderName).push(file);
        });

        zipFiles.forEach(file => {
            updateResult(`Обработка ZIP-файла: ${file.name}`);
            processZipFile(file);
        });

        folders.forEach((folderFiles, folderName) => {
            if (folderFiles.length === 0) return;

            const xmlFile = folderFiles.find(file => file.name.endsWith('.xml'));
            if (xmlFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const xmlData = processXmlContent(content);
                    let newFileName;
                    if (xmlData.cadastralNumber && xmlData.dateFormation) {
                        newFileName = applyMask(
                            xmlData.cadastralNumber.includes(':') ? settings.extractMask : settings.kptMask,
                            xmlData.cadastralNumber,
                            xmlData.dateFormation
                        ) + '.zip';
                    } else {
                        newFileName = `${folderName}.zip`;
                    }
                    createZipFromFolder(folderFiles, newFileName);
                };
                reader.readAsText(xmlFile);
            } else if (folderName !== 'root') {
                createZipFromFolder(folderFiles, `${folderName}.zip`);
            }
        });
    }

    function createZipFromFolder(files, zipName) {
        const zip = new JSZip();
        const folderPromises = [];

        files.forEach(file => {
            const fileName = file.name;
            folderPromises.push(
                new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        zip.file(fileName, e.target.result);
                        resolve();
                    };
                    reader.readAsArrayBuffer(file);
                })
            );
        });

        Promise.all(folderPromises).then(() => {
            zip.generateAsync({
                type: "blob",
                compression: "DEFLATE",
                compressionOptions: { level: 9 }
            }).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = zipName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                updateResult(`${zipName}`);
            });
        });
    }

    // Map-modal функции
    function openMapModal() {
        document.getElementById('mapModal').style.display = 'block';
    }

    function closeMapModal() {
        document.getElementById('mapModal').style.display = 'none';
    }

    function closeNspdResultModal() {
        document.getElementById('nspdResultModal').style.display = 'none';
    }

    function isValidCadastralNumber(number) {
        return /^\d{1,2}:\d{1,2}:\d{6,7}:\d{1,}$/.test(number);
    }

    function isKadastrovyKvartal(number) {
        return /^\d{1,2}:\d{1,2}:\d{6,7}$/.test(number);
    }

  // Функция для создания задержки
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Обновленная функция processCadastralNumbers с индикатором загрузки
async function processCadastralNumbers() {
    const cadastralNumbersTextarea = document.getElementById('cadastralNumbers');
    const inputText = cadastralNumbersTextarea.value;

    // Извлечение кадастровых номеров и кварталов
    const lines = inputText.split('\n').map(n => n.trim()).filter(n => n);
    const cadastralNumbers = lines
        .map(line => {
            const match = line.match(/\d{1,2}:\d{1,2}:\d{6,7}(?::\d{1,})?/);
            return match ? match[0] : null;
        })
        .filter(number => number !== null && (isValidCadastralNumber(number) || isKadastrovyKvartal(number)));

    // Получаем уникальные номера
    const uniqueCadastralNumbers = [...new Set(cadastralNumbers)];

    // Очистка и заполнение textarea уникальными номерами
    cadastralNumbersTextarea.value = uniqueCadastralNumbers.join('\n');

    // Показываем индикатор загрузки
    const loadingModal = document.getElementById('loadingModal');
    const progressBarFill = loadingModal.querySelector('.progress-bar-fill');
    loadingModal.style.display = 'block';

    // Инициализируем прогресс
    const totalRequests = uniqueCadastralNumbers.length;
    let completedRequests = 0;

    // Массив для хранения результатов
    const results = [];

    // Последовательная обработка запросов с задержкой по УНИКАЛЬНЫМ номерам
    for (const number of uniqueCadastralNumbers) {
        try {
            const isQuarter = isKadastrovyKvartal(number);
            const thematicSearchId = isQuarter ? 2 : 1;
            const url = `https://nspd.gov.ru/api/geoportal/v2/search/geoportal?thematicSearchId=${thematicSearchId}&query=${number}`;
            const response = await fetch(url);
            const data = await response.json();

            console.log(`Ответ API для ${number}:`, JSON.stringify(data, null, 2));

            if (isQuarter) {
                if (data.data && data.data.features && data.data.features.length > 0 && data.data.features[0].geometry.type === "Polygon") {
                    results.push({ cadastralNumber: number, categoryName: 'Кадастровый квартал', rightType: '' });
                } else if (data.code === 204) {
                    results.push({ cadastralNumber: number, categoryName: 'Нет данных', rightType: '', isNotFound: true });
                } else {
                    results.push({ cadastralNumber: number, categoryName: 'Ошибка обработки', rightType: '' });
                }
            } else {
                if (data.data && data.data.features && data.data.features.length > 0) {
                    const feature = data.data.features[0];
                    const categoryName = feature.properties.categoryName || 'Не указано';
                    const rightType = feature.properties.options && feature.properties.options.right_type === null 
                        ? 'Госсобственность' 
                        : (feature.properties.options && feature.properties.options.right_type !== undefined 
                            ? feature.properties.options.right_type 
                            : 'Не указано');
                    results.push({ cadastralNumber: number, categoryName, rightType });
                } else if (data.code === 204) {
                    results.push({ cadastralNumber: number, categoryName: 'Данные не найдены', rightType: '', isNotFound: true });
                } else {
                    results.push({ cadastralNumber: number, categoryName: 'Ошибка обработки', rightType: '' });
                }
            }
        } catch (error) {
            console.error(`Ошибка запроса для ${number}:`, error);
            results.push({ cadastralNumber: number, categoryName: 'Ошибка запроса', rightType: '' });
        }

        // Обновляем прогресс
        completedRequests++;
        const progressPercentage = (completedRequests / totalRequests) * 100;
        progressBarFill.style.width = `${progressPercentage}%`;

        await delay(500);
    }

    // Отображение результатов в таблице
    const resultBody = document.getElementById('nspdResultBody');
    resultBody.innerHTML = '';
    results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${result.cadastralNumber}</td>
            <td>${result.categoryName}</td>
            <td>${result.rightType}</td>
        `;
        if (result.isNotFound) {
            row.style.backgroundColor = '#ffe6e6';
            row.style.color = '#ff0000';
        }
        resultBody.appendChild(row);
    });

    // Скрываем индикатор загрузки
    loadingModal.style.display = 'none';

    closeMapModal();
    document.getElementById('nspdResultModal').style.display = 'block';
}


    // Check-list функции
    function openCheckListModal() {
        document.getElementById('checkListModal').style.display = 'block';
    }

    function closeCheckListModal() {
        document.getElementById('checkListModal').style.display = 'none';
    }

    function closeCheckListResultModal() {
        document.getElementById('checkListResultModal').style.display = 'none';
    }

    function openCheckList() {
        const input = document.getElementById('checkListInput').value;
        const lines = input.split('\n').map(line => line.trim()).filter(line => line);
        currentCheckListData = lines;
        renderCheckList(lines);
    }

    function renderCheckList(lines) {
        const originalCount = lines.length;
        const lineCount = new Map();
        lines.forEach(line => {
            lineCount.set(line, (lineCount.get(line) || 0) + 1);
        });

        const container = document.getElementById('checkListItems');
        const stats = document.getElementById('checkListStats');
        container.innerHTML = '';

        const uniqueCount = new Set(lines).size;
        stats.textContent = `Всего строк: ${originalCount}, Уникальных: ${uniqueCount}`;

        lines.forEach(line => {
            const div = document.createElement('div');
            div.className = 'check-list-item';
            if (lineCount.get(line) > 1) {
                div.classList.add('duplicate');
            }

            div.innerHTML = `
                <span class="checkmark">✓</span>
                <span class="item-text">${line}</span>
                <button class="copy-button" title="Скопировать">
                    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            `;

            const copyButton = div.querySelector('.copy-button');
            const copyIcon = div.querySelector('.copy-icon');

            copyButton.addEventListener('click', function(e) {
                e.stopPropagation();
                navigator.clipboard.writeText(line).then(() => {
                    div.classList.add('copy-flash');
                    copyIcon.classList.add('copied');
                    setTimeout(() => {
                        div.classList.remove('copy-flash');
                    }, 1500);
                });
            });

            div.addEventListener('dblclick', function(e) {
                this.classList.toggle('checked');
            });

            container.appendChild(div);
        });

        closeCheckListModal();
        document.getElementById('checkListResultModal').style.display = 'block';
    }

    function sortCheckList() {
        const items = document.querySelectorAll('.check-list-item');
        items.forEach(item => item.classList.add('sorting'));
        const sortedLines = [...currentCheckListData].sort((a, b) => a.localeCompare(b, 'ru'));
        setTimeout(() => {
            currentCheckListData = sortedLines;
            renderCheckList(sortedLines);
        }, 300);
    }

    // Application функции
    function parseXML() {
        function extractValue(pattern, xml) {
            const match = xml.match(pattern);
            return match ? match[1].trim() : '';
        }

        const xmlText = document.getElementById('applicationInput').value;
        if (!xmlText) return;

        const resultBody = document.getElementById('resultBody');
        resultBody.innerHTML = '';

        const personRegex = /<subj:person>.*?<\/subj:person>/gs;
        const peopleMatches = [...xmlText.matchAll(personRegex)];

        peopleMatches.forEach(personMatch => {
            const personText = personMatch[0];
            const surname = extractValue(/<subj:surname>([^<]+)<\/subj:surname>/, personText);
            const firstname = extractValue(/<subj:firstname>([^<]+)<\/subj:firstname>/, personText);
            const patronymic = extractValue(/<subj:patronymic>([^<]+)<\/subj:patronymic>/, personText);
            const birthDate = extractValue(/<subj:birthDate>([^<]+)<\/subj:birthDate>/, personText);
            const phone = extractValue(/<subj:phoneNumber>([^<]+)<\/subj:phoneNumber>/, personText);
            const snils = extractValue(/<subj:snils>([^<]+)<\/subj:snils>/, personText);

            const registrationAddressRegex = /<subj:address>(.*?)<\/subj:address>/s;
            const registrationAddressMatch = personText.match(registrationAddressRegex);
            let registrationAddress = '';
            if (registrationAddressMatch) {
                const addressText = registrationAddressMatch[1];
                const region = extractValue(/<address:region>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const district = extractValue(/<address:district>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const street = extractValue(/<address:street>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const house = extractValue(/<address:house>.*?<address:value>([^<]+)<\/address:value>/s, addressText);
                const apartment = extractValue(/<address:apartment>.*?<address:name>([^<]+)<\/address:name>/s, addressText);

                let cityOrLocalityType = '', cityOrLocalityName = '';
                const cityTypeMatch = addressText.match(/<address:type>г<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
                if (cityTypeMatch) {
                    cityOrLocalityType = 'г';
                    cityOrLocalityName = cityTypeMatch[1].trim();
                } else {
                    const localityTypeMatch = addressText.match(/<address:type>(с|д|пгт|п)<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
                    if (localityTypeMatch) {
                        cityOrLocalityType = localityTypeMatch[1];
                        cityOrLocalityName = localityTypeMatch[2].trim();
                    }
                }

                registrationAddress = `${region}, ${district}`;
                if (cityOrLocalityType && cityOrLocalityName) registrationAddress += `, ${cityOrLocalityType} ${cityOrLocalityName}`;
                registrationAddress += `, ул. ${street}, д. ${house}`;
                if (apartment) registrationAddress += `, кв. ${apartment}`;
            }

            const objectAddressRegex = /<obj:address>(.*?)<\/obj:address>/s;
            const objectAddressMatch = xmlText.match(objectAddressRegex);
            let objectAddress = '';
            if (objectAddressMatch) {
                const addressText = objectAddressMatch[1];
                const region = extractValue(/<address:region>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const district = extractValue(/<address:district>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const street = extractValue(/<address:street>.*?<address:name>([^<]+)<\/address:name>/s, addressText);
                const house = extractValue(/<address:house>.*?<address:value>([^<]+)<\/address:value>/s, addressText);
                const other = extractValue(/<address:other>([^<]+)<\/address:other>/s, addressText);

                let cityOrLocalityType = '', cityOrLocalityName = '';
                const cityTypeMatch = addressText.match(/<address:type>г<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
                if (cityTypeMatch) {
                    cityOrLocalityType = 'г';
                    cityOrLocalityName = cityTypeMatch[1].trim();
                } else {
                    const localityTypeMatch = addressText.match(/<address:type>(с|д|пгт|п)<\/address:type>\s*<address:name>([^<]+)<\/address:name>/s);
                    if (localityTypeMatch) {
                        cityOrLocalityType = localityTypeMatch[1];
                        cityOrLocalityName = localityTypeMatch[2].trim();
                    }
                }

                objectAddress = `${region}, ${district}`;
                if (cityOrLocalityType && cityOrLocalityName) objectAddress += `, ${cityOrLocalityType} ${cityOrLocalityName}`;
                objectAddress += `, ул. ${street}`;
                if (house) objectAddress += `, д. ${house}`;
                if (other) objectAddress += `, ${other}`;
            }

            const idDocumentRef = extractValue(/<subj:idDocumentRef documentID="([^"]+)"/, personText);
            const passportRegex = new RegExp(
                `<docs:idDocument _id="${idDocumentRef}">.*?` +
                '<docs:documentTypes>.*?<docs:documentTypeCode>008001001000</docs:documentTypeCode>.*?</docs:documentTypes>.*?' +
                '<docs:name>([^<]+)</docs:name>.*?' +
                '<docs:number>([^<]+)</docs:number>.*?' +
                '<docs:issueDate>([^<]+)</docs:issueDate>.*?' +
                '<docs:series>([^<]+)</docs:series>.*?' +
                '<docs:issuer>.*?<docs:name>([^<]+)</docs:name>',
                's'
            );
            const passportMatch = xmlText.match(passportRegex);

            const passportName = passportMatch ? passportMatch[1].trim() : '';
            const passportNumber = passportMatch ? passportMatch[2].trim() : '';
            const passportIssueDate = passportMatch ? passportMatch[3].trim() : '';
            const passportSeries = passportMatch ? passportMatch[4].trim() : '';
            const passportIssuer = passportMatch ? passportMatch[5].trim() : '';
            const passportFullData = `${passportName} ${passportSeries} ${passportNumber} выдан ${passportIssuer} ${passportIssueDate}`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 8px;">${surname}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${firstname}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${patronymic}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${birthDate}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${passportFullData}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${snils}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${registrationAddress.startsWith(', ') ? registrationAddress.substring(2) : registrationAddress}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${phone}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${objectAddress}</td>
            `;
            resultBody.appendChild(row);
        });
    }

    function openRenameModal() {
        document.getElementById('renameModal').style.display = 'block';
    }

    function closeRenameModal() {
        document.getElementById('renameModal').style.display = 'none';
        document.getElementById('replaceText').value = '';
        document.getElementById('newText').value = '';
    }

    function openFileSelector() {
        document.getElementById('renameFileInput').click();
    }

    function openApplicationModal() {
        document.getElementById('applicationModal').style.display = 'block';
    }

    function closeApplicationModal() {
        document.getElementById('applicationModal').style.display = 'none';
    }

    function closeApplicationResultModal() {
        document.getElementById('applicationResultModal').style.display = 'none';
    }

    function processApplication() {
        const xmlText = document.getElementById('applicationInput').value;
        if (!xmlText.trim()) {
            alert('Пожалуйста, вставьте текст заявления');
            return;
        }

        parseXML();
        const resultBody = document.getElementById('resultBody');
        if (resultBody.children.length > 0) {
            closeApplicationModal();
            document.getElementById('applicationResultModal').style.display = 'block';
        } else {
            alert('Данные в заявлении не найдены.');
        }
    }
    
    
        // Добавьте этот обработчик вместе с другими обработчиками меню
    document.getElementById('xmlDocsMenuItem').addEventListener('click', function(e) {
        e.preventDefault();
        openXmlDocsModal();
    });

    // Добавьте эти функции для управления новым модальным окном
    function openXmlDocsModal() {
        document.getElementById('xmlDocsModal').style.display = 'block';
        // Обязательно вызываем для отрисовки иконок в появившемся окне
        feather.replace(); 
    }

    function closeXmlDocsModal() {
        document.getElementById('xmlDocsModal').style.display = 'none';
    }

    // (Опционально) Закрытие окна по клику на фон
    const xmlModal = document.getElementById('xmlDocsModal');
    xmlModal.addEventListener('click', function(event) {
        // Если кликнули на сам фон (а не на его содержимое)
        if (event.target === xmlModal) {
            closeXmlDocsModal();
        }
    });
    
    </script>
</body>
</html>
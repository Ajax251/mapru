<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотрщик</title>
        <link rel="icon" href="img/vw.png" type="image/png">
    <!-- Библиотеки -->
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #111827;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Inter, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ЭКРАН ЗАГРУЗКИ */
        #drop-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .drop-zone {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: var(--surface);
            border: 3px dashed var(--border);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary);
            background: #eef2ff;
            transform: scale(1.01);
        }

        .drop-icon { font-size: 64px; color: var(--primary); margin-bottom: 20px; }
        .btn-upload {
            background: var(--primary);
            color: white;
            padding: 12px 32px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 20px;
        }
        .btn-upload:hover { background: var(--primary-hover); }

        /* ЭКРАН ПРОСМОТРА */
        #viewer-screen {
            display: none; 
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .main-content {
            flex: 1;
            overflow: auto;
            background: #374151;
            display: flex;
            justify-content: center;
            padding: 30px;
            position: relative;
        }

        /* TOOLBAR */
        .toolbar {
            height: 70px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn {
            width: 40px; height: 40px;
            border-radius: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #4b5563;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .tool-btn:hover { background: #f3f4f6; color: var(--primary); }
        
        /* Выпадающее меню сохранения */
        .save-wrapper { position: relative; }
        .save-btn { background: var(--primary); color: white; }
        .save-btn:hover { background: var(--primary-hover); color: white; }
        
        .save-menu {
            position: absolute;
            bottom: 55px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 220px;
            padding: 8px;
            display: none;
            border: 1px solid var(--border);
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .save-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            font-size: 14px;
            color: var(--text);
        }
        .save-option:hover { background: #f3f4f6; }
        .save-option i { width: 25px; color: var(--primary); }

        /* Контейнеры контента */
        .document-container {
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            min-height: 100%;
            width: 100%;
            max-width: 900px;
        }
        .docx-wrapper { padding: 40px !important; background: white; }
        
        .media-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; height: 100%;
        }
        .media-content { 
            max-width: 100%; max-height: 85vh; 
            box-shadow: 0 10px 15px rgba(0,0,0,0.5); 
        }

        .text-container {
            background: white;
            padding: 40px;
            width: 100%; max-width: 900px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            outline: none;
            min-height: 80vh;
        }

        .loader {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        @media print {
            .toolbar, #drop-screen { display: none !important; }
            .main-content { background: white; padding: 0; }
            .document-container, .text-container { box-shadow: none; max-width: 100%; }
        }
    </style>
</head>
<body>

    <!-- ЭКРАН ЗАГРУЗКИ -->
    <div id="drop-screen">
        <div class="drop-zone" id="drop-zone">
            <i class="fa-solid fa-folder-open drop-icon"></i>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 10px;">Открыть файл</div>
            <div style="color: #6b7280; margin-bottom: 20px; text-align: center;">
                DOCX, PDF, TXT<br>
                JPG, PNG, GIF, WEBP<br>
                MP4, WEBM, MP3
            </div>
            <button class="btn-upload" onclick="document.getElementById('file-input').click()">Обзор...</button>
        </div>
    </div>

    <!-- ЭКРАН ПРОСМОТРА -->
    <div id="viewer-screen">
        <div class="main-content" id="content-area"></div>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="tool-btn" onclick="closeViewer()"><i class="fa-solid fa-arrow-left"></i></button>
                <div style="display:flex; flex-direction:column;">
                    <span id="file-name" style="font-weight:600; font-size:14px; max-width:200px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">Файл</span>
                    <span id="file-ext" style="font-size:11px; color:#6b7280;">FORMAT</span>
                </div>
            </div>

            <!-- PDF Навигация -->
            <div class="toolbar-group" id="pdf-tools" style="display:none;">
                <button class="tool-btn" id="prev-page"><i class="fa-solid fa-chevron-left"></i></button>
                <span style="font-size:14px; font-weight:500;"><span id="page-num">1</span> / <span id="page-count">1</span></span>
                <button class="tool-btn" id="next-page"><i class="fa-solid fa-chevron-right"></i></button>
                <div style="width:1px; height:24px; background:var(--border); margin:0 5px;"></div>
                <button class="tool-btn" id="zoom-out"><i class="fa-solid fa-minus"></i></button>
                <button class="tool-btn" id="zoom-in"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div class="toolbar-group">
                <!-- Меню Сохранения -->
                <div class="save-wrapper">
                    <button class="tool-btn save-btn" onclick="toggleSaveMenu()" title="Экспорт">
                        <i class="fa-solid fa-floppy-disk"></i>
                    </button>
                    <div class="save-menu" id="save-menu">
                        <button class="save-option" onclick="exportToHTML()">
                            <i class="fa-brands fa-html5"></i> Сохранить как HTML
                        </button>
                        <button class="save-option" onclick="exportToTXT()">
                            <i class="fa-solid fa-file-lines"></i> Сохранить как TXT
                        </button>
                        <button class="save-option" onclick="window.print()">
                            <i class="fa-solid fa-print"></i> Печать / PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ВАЖНО: Атрибут accept фильтрует диалоговое окно -->
    <input type="file" id="file-input" 
           accept=".docx, .pdf, .txt, .html, .xml, .json, .jpg, .jpeg, .png, .gif, .webp, .svg, .bmp, .mp4, .webm, .ogg, .mp3, .wav">
    
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 20px; font-weight: 500; color: var(--text);">Загрузка...</div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const contentArea = document.getElementById('content-area');
        const saveMenu = document.getElementById('save-menu');
        
        let currentFile = null;
        let pdfDoc = null;
        let pageNum = 1;
        let pdfScale = 1.0;
        let isPdfRendering = false;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.save-wrapper')) saveMenu.style.display = 'none';
        });

        async function handleFile(file) {
            showLoader();
            contentArea.innerHTML = '';
            document.getElementById('pdf-tools').style.display = 'none';
            currentFile = file;
            
            document.getElementById('file-name').textContent = file.name;
            const ext = file.name.split('.').pop().toLowerCase();
            document.getElementById('file-ext').textContent = ext.toUpperCase();

            document.getElementById('drop-screen').style.display = 'none';
            document.getElementById('viewer-screen').style.display = 'flex';

            try {
                if (ext === 'docx') await renderDocx(file);
                else if (ext === 'pdf') await renderPdf(file);
                else if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp'].includes(ext)) await renderImage(file);
                else if (['mp4', 'webm', 'ogg'].includes(ext)) renderVideo(file);
                else if (['mp3', 'wav'].includes(ext)) renderAudio(file);
                else await renderText(file);
            } catch (err) {
                alert("Не удалось открыть файл. Возможно, формат поврежден или не поддерживается.");
                closeViewer();
            } finally {
                hideLoader();
            }
        }

        // --- RENDERERS ---

        async function renderDocx(file) {
            const container = document.createElement('div');
            container.className = 'document-container docx-wrapper';
            container.contentEditable = "true";
            contentArea.appendChild(container);
            const buffer = await file.arrayBuffer();
            await docx.renderAsync(buffer, container, null, { className: "docx", inWrapper: false, ignoreWidth: false, experimental: true });
        }

        async function renderPdf(file) {
            const container = document.createElement('div');
            container.className = 'media-container';
            const canvas = document.createElement('canvas');
            canvas.style.boxShadow = "0 5px 15px rgba(0,0,0,0.3)";
            container.appendChild(canvas);
            contentArea.appendChild(container);
            document.getElementById('pdf-tools').style.display = 'flex';

            const buffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(buffer).promise;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            pageNum = 1; pdfScale = 1.0;
            renderPdfPage(canvas);

            document.getElementById('prev-page').onclick = () => changePage(-1, canvas);
            document.getElementById('next-page').onclick = () => changePage(1, canvas);
            document.getElementById('zoom-in').onclick = () => { pdfScale += 0.2; renderPdfPage(canvas); };
            document.getElementById('zoom-out').onclick = () => { if(pdfScale>0.4) pdfScale -= 0.2; renderPdfPage(canvas); };
        }

        async function renderPdfPage(canvas) {
            if(isPdfRendering) return;
            isPdfRendering = true;
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({scale: pdfScale});
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            document.getElementById('page-num').textContent = pageNum;
            await page.render({canvasContext: ctx, viewport: viewport}).promise;
            isPdfRendering = false;
        }

        function changePage(delta, canvas) {
            if(pageNum+delta >=1 && pageNum+delta <= pdfDoc.numPages) {
                pageNum += delta;
                renderPdfPage(canvas);
            }
        }

        function renderImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const container = document.createElement('div');
                    container.className = 'media-container';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'media-content';
                    container.appendChild(img);
                    contentArea.appendChild(container);
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderVideo(file) {
            const container = document.createElement('div');
            container.className = 'media-container';
            const vid = document.createElement('video');
            vid.src = URL.createObjectURL(file);
            vid.controls = true;
            vid.className = 'media-content';
            container.appendChild(vid);
            contentArea.appendChild(container);
        }

        function renderAudio(file) {
            const container = document.createElement('div');
            container.className = 'media-container';
            container.style.flexDirection = 'column';
            const icon = document.createElement('i');
            icon.className = 'fa-solid fa-music';
            icon.style.fontSize = '64px'; icon.style.color = '#ccc'; icon.style.marginBottom = '20px';
            const audio = document.createElement('audio');
            audio.src = URL.createObjectURL(file);
            audio.controls = true;
            container.appendChild(icon);
            container.appendChild(audio);
            contentArea.appendChild(container);
        }

        async function renderText(file) {
            const text = await file.text();
            const div = document.createElement('div');
            div.className = 'text-container';
            div.contentEditable = "true";
            div.innerText = text;
            contentArea.appendChild(div);
        }

        // --- EXPORT ---

        function toggleSaveMenu() {
            saveMenu.style.display = saveMenu.style.display === 'block' ? 'none' : 'block';
        }

        async function exportToHTML() {
            showLoader();
            saveMenu.style.display = 'none';
            setTimeout(async () => {
                let htmlContent = "";
                const docWrapper = contentArea.querySelector('.docx-wrapper');
                
                if (docWrapper) {
                    const clone = docWrapper.cloneNode(true);
                    const images = clone.querySelectorAll('img');
                    for (let img of images) {
                        if (img.src.startsWith('blob:')) {
                            try {
                                const response = await fetch(img.src);
                                const blob = await response.blob();
                                img.src = await blobToBase64(blob);
                            } catch (e) {}
                        }
                    }
                    htmlContent = `<style>body{font-family:'Segoe UI',sans-serif;padding:40px;background:#f3f4f6;display:flex;justify-content:center}.doc{background:white;padding:50px;box-shadow:0 0 10px rgba(0,0,0,0.1);width:100%;max-width:900px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:5px}img{max-width:100%}</style><div class="doc">${clone.innerHTML}</div>`;
                } else if (contentArea.querySelector('img.media-content')) {
                    htmlContent = `<div style="display:flex;justify-content:center;height:100vh;align-items:center;background:#222;"><img src="${contentArea.querySelector('img.media-content').src}" style="max-width:100%;max-height:100vh;"></div>`;
                } else if (contentArea.querySelector('.text-container')) {
                    htmlContent = `<pre style="font-family:monospace;padding:20px;">${contentArea.innerText}</pre>`;
                } else if (contentArea.querySelector('canvas')) {
                    htmlContent = `<img src="${contentArea.querySelector('canvas').toDataURL()}" style="border:1px solid #ccc;">`;
                }

                downloadString(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${currentFile.name}</title></head><body>${htmlContent}</body></html>`, currentFile.name + ".html", "text/html");
                hideLoader();
            }, 100);
        }

        function exportToTXT() {
            saveMenu.style.display = 'none';
            downloadString(contentArea.innerText, currentFile.name + ".txt", "text/plain");
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadString(text, name, mime) {
            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function closeViewer() {
            document.getElementById('viewer-screen').style.display = 'none';
            document.getElementById('drop-screen').style.display = 'flex';
            fileInput.value = '';
            if(pdfDoc) { pdfDoc.destroy(); pdfDoc=null; }
        }

        function showLoader() { document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотрщик</title>
    <link rel="icon" href="img/vw.png" type="image/png">
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --bg: #f0f9ff;
            --surface: #ffffff;
            --toolbar-bg: #e0f2fe;
            --text: #0c4a6e;
            --text-light: #64748b;
            --border: #bae6fd;
            --shadow: rgba(14, 165, 233, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ЭКРАН ЗАГРУЗКИ */
        #drop-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #e0f2fe 100%);
        }

        .drop-zone {
            width: 100%;
            max-width: 500px;
            padding: 60px 40px;
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .drop-icon { font-size: 56px; color: var(--primary); margin-bottom: 24px; }
        .drop-title { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 12px; }
        .drop-formats { color: var(--text-light); font-size: 13px; text-align: center; line-height: 1.8; margin-bottom: 24px; }
        
        .btn-upload {
            background: var(--primary);
            color: white;
            padding: 12px 36px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
        }
        .btn-upload:hover { background: var(--primary-hover); }

        /* ЭКРАН ПРОСМОТРА */
        #viewer-screen {
            display: none; 
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .main-content {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px;
            position: relative;
            background: #cbd5e1;
        }

        /* TOOLBAR */
        .toolbar {
            height: 56px;
            background: var(--toolbar-bg);
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
            border-top: 1px solid var(--border);
            z-index: 50;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-btn {
            width: 36px; height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn:hover { background: var(--surface); color: var(--primary); }
        .tool-btn.active { background: var(--primary); color: #fff; }
        
        .divider { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }

        .file-info {
            display: flex;
            flex-direction: column;
            margin-left: 10px;
        }
        .file-name { font-weight: 600; font-size: 13px; color: var(--text); max-width: 180px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; color: var(--text-light); }

        /* Выпадающие меню */
        .dropdown-wrapper { position: relative; }
        
        .dropdown-menu {
            position: absolute;
            bottom: 46px;
            right: 0;
            background: var(--surface);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 220px;
            padding: 6px;
            display: none;
            border: 1px solid var(--border);
        }

        .dropdown-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            text-align: left;
            border-radius: 6px;
            font-size: 13px;
            color: var(--text);
            gap: 10px;
        }
        .dropdown-option:hover { background: var(--bg); }
        .dropdown-option i { width: 18px; color: var(--primary); font-size: 14px; }
        .dropdown-divider { height: 1px; background: var(--border); margin: 6px 0; }

        /* Цвет фона */
        .bg-picker-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }
        .bg-picker-label { font-size: 11px; color: var(--text-light); }
        .bg-picker {
            width: 28px; height: 28px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: #cbd5e1;
        }
        .bg-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .bg-picker::-webkit-color-swatch { border: none; border-radius: 4px; }

        /* PDF навигация */
        .page-nav {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .page-info { font-size: 12px; color: var(--text); min-width: 60px; text-align: center; font-weight: 500; }
        .page-nav .tool-btn { width: 28px; height: 28px; font-size: 12px; }

        /* Контейнеры контента */
        .document-container {
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-height: 100%;
            width: 100%;
            max-width: 900px;
        }
        .docx-wrapper { padding: 40px !important; background: white; }
        
        .media-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; 
            height: 100%;
        }
        .media-content { 
            max-width: 100%; 
            max-height: 85vh; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
        }

        .text-container {
            background: white;
            padding: 40px;
            width: 100%; 
            max-width: 900px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            min-height: 80vh;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* PDF контейнер для всех страниц */
        .pdf-all-pages {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        .pdf-page-canvas {
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            background: white;
        }

        .loader {
            position: fixed; 
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 16px; font-size: 14px; color: var(--text); }

        /* Прогресс */
        .progress-bar {
            width: 200px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 16px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
        }
    </style>
</head>
<body>

    <!-- ЭКРАН ЗАГРУЗКИ -->
    <div id="drop-screen">
        <div class="drop-zone" id="drop-zone">
            <i class="fa-solid fa-cloud-arrow-up drop-icon"></i>
            <div class="drop-title">Перетащите файл сюда</div>
            <div class="drop-formats">
                <b>Документы:</b> DOCX, PDF, TXT, HTML, JSON<br>
                <b>Изображения:</b> JPG, PNG, GIF, WEBP, SVG<br>
                <b>Медиа:</b> MP4, WEBM, MP3, WAV
            </div>
            <button class="btn-upload" onclick="document.getElementById('file-input').click()">
                <i class="fa-solid fa-folder-open"></i>&nbsp; Выбрать файл
            </button>
        </div>
    </div>

    <!-- ЭКРАН ПРОСМОТРА -->
    <div id="viewer-screen">
        <div class="main-content" id="content-area"></div>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="tool-btn" onclick="closeViewer()" title="Назад">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="file-info">
                    <span class="file-name" id="file-name">Файл</span>
                    <span class="file-meta" id="file-meta">— KB</span>
                </div>
            </div>

            <!-- PDF Навигация -->
            <div class="toolbar-group" id="pdf-tools" style="display:none;">
                <div class="page-nav">
                    <button class="tool-btn" id="prev-page" title="Предыдущая"><i class="fa-solid fa-chevron-left"></i></button>
                    <span class="page-info"><span id="page-num">1</span> / <span id="page-count">1</span></span>
                    <button class="tool-btn" id="next-page" title="Следующая"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="divider"></div>
                <button class="tool-btn" id="zoom-out" title="Уменьшить"><i class="fa-solid fa-minus"></i></button>
                <span style="font-size:12px;color:var(--text);min-width:45px;text-align:center;font-weight:500;" id="zoom-level">100%</span>
                <button class="tool-btn" id="zoom-in" title="Увеличить"><i class="fa-solid fa-plus"></i></button>
                <div class="divider"></div>
                <button class="tool-btn" id="view-mode" title="Все страницы"><i class="fa-solid fa-layer-group"></i></button>
            </div>

            <div class="toolbar-group">
                <!-- Цвет фона -->
                <div class="bg-picker-wrap">
                    <span class="bg-picker-label">Фон:</span>
                    <input type="color" class="bg-picker" id="bg-color" value="#cbd5e1" title="Цвет фона">
                </div>
                
                <div class="divider"></div>

                <!-- Инструменты изображения -->
                <div class="toolbar-group" id="image-tools" style="display:none;">
                    <button class="tool-btn" id="rotate-btn" title="Повернуть"><i class="fa-solid fa-rotate-right"></i></button>
                    <button class="tool-btn" id="fit-btn" title="По размеру"><i class="fa-solid fa-expand"></i></button>
                    <div class="divider"></div>
                </div>

                <!-- Полноэкранный режим -->
                <button class="tool-btn" id="fullscreen-btn" onclick="toggleFullscreen()" title="Полный экран">
                    <i class="fa-solid fa-expand"></i>
                </button>

                <div class="divider"></div>

                <!-- Меню Экспорта -->
                <div class="dropdown-wrapper">
                    <button class="tool-btn" onclick="toggleMenu('export-menu')" title="Экспорт">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <div class="dropdown-menu" id="export-menu">
                        <button class="dropdown-option" onclick="exportToHTML()">
                            <i class="fa-brands fa-html5"></i> Сохранить как HTML
                        </button>
                        <button class="dropdown-option" onclick="exportToJPG()">
                            <i class="fa-solid fa-image"></i> Сохранить как JPG
                        </button>
                        <button class="dropdown-option" onclick="exportToTXT()">
                            <i class="fa-solid fa-file-lines"></i> Сохранить как TXT
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-option" onclick="printAsImage()">
                            <i class="fa-solid fa-print"></i> Печать как изображение
                        </button>
                        <button class="dropdown-option" onclick="printFitToPage()">
                            <i class="fa-solid fa-file-image"></i> Печать на 1 стр (А4)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

 <input type="file" id="file-input" style="display: none;"
       accept=".docx,.pdf,.txt,.html,.xml,.json,.jpg,.jpeg,.png,.gif,.webp,.svg,.bmp,.mp4,.webm,.ogg,.mp3,.wav">
    
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loader-text">Загрузка...</div>
        <div class="progress-bar" id="progress-bar" style="display:none;">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <script>
        // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const contentArea = document.getElementById('content-area');
        const bgColorPicker = document.getElementById('bg-color');
        
        let currentFile = null;
        let currentFileType = null;
        let pdfDoc = null;
        let pdfPages = [];
        let pageNum = 1;
        let pdfScale = 1.0;
        let pdfViewMode = 'single';
        let imageRotation = 0;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ===== СОБЫТИЯ =====
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        bgColorPicker.addEventListener('input', e => {
            contentArea.style.backgroundColor = e.target.value;
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-wrapper')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });

        // Горячие клавиши
        document.addEventListener('keydown', e => {
            if (document.getElementById('viewer-screen').style.display !== 'flex') return;
            
            if (e.key === 'Escape') closeViewer();
            if (e.key === 'ArrowLeft' && pdfDoc) changePage(-1);
            if (e.key === 'ArrowRight' && pdfDoc) changePage(1);
            if (e.key === '+' || e.key === '=') { if(pdfDoc) { pdfScale += 0.2; updatePdfView(); } }
            if (e.key === '-') { if(pdfDoc && pdfScale > 0.4) { pdfScale -= 0.2; updatePdfView(); } }
            if (e.key === 'f' || e.key === 'F') toggleFullscreen();
        });

        // ===== ОСНОВНЫЕ ФУНКЦИИ =====
        async function handleFile(file) {
            showLoader('Открытие файла...');
            contentArea.innerHTML = '';
            document.getElementById('pdf-tools').style.display = 'none';
            document.getElementById('image-tools').style.display = 'none';
            currentFile = file;
            imageRotation = 0;
            pdfPages = [];
            pdfDoc = null;
            
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-meta').textContent = formatFileSize(file.size);
            
            const ext = file.name.split('.').pop().toLowerCase();
            currentFileType = ext;
            contentArea.style.backgroundColor = bgColorPicker.value;

            document.getElementById('drop-screen').style.display = 'none';
            document.getElementById('viewer-screen').style.display = 'flex';

            try {
                if (ext === 'docx') await renderDocx(file);
                else if (ext === 'pdf') await renderPdf(file);
                else if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp'].includes(ext)) await renderImage(file);
                else if (['mp4', 'webm', 'ogg'].includes(ext)) renderVideo(file);
                else if (['mp3', 'wav'].includes(ext)) renderAudio(file);
                else await renderText(file);
            } catch (err) {
                console.error(err);
                alert("Ошибка открытия файла: " + err.message);
                closeViewer();
            } finally {
                hideLoader();
            }
        }

        // ===== РЕНДЕРЕРЫ =====
        async function renderDocx(file) {
            const container = document.createElement('div');
            container.className = 'document-container docx-wrapper';
            container.id = 'docx-content';
            contentArea.appendChild(container);
            const buffer = await file.arrayBuffer();
            await docx.renderAsync(buffer, container, null, { 
                className: "docx", 
                inWrapper: false, 
                ignoreWidth: false, 
                experimental: true 
            });
        }

        async function renderPdf(file) {
            document.getElementById('pdf-tools').style.display = 'flex';
            
            const buffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(buffer).promise;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            pageNum = 1;
            pdfScale = 1.0;
            pdfViewMode = 'single';
            
            updateZoomDisplay();
            
            showLoader('Загрузка страниц...');
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                pdfPages[i] = await pdfDoc.getPage(i);
                updateProgress((i / pdfDoc.numPages) * 100);
            }
            
            document.getElementById('prev-page').onclick = () => changePage(-1);
            document.getElementById('next-page').onclick = () => changePage(1);
            document.getElementById('zoom-in').onclick = () => { pdfScale = Math.min(3, pdfScale + 0.2); updatePdfView(); };
            document.getElementById('zoom-out').onclick = () => { pdfScale = Math.max(0.3, pdfScale - 0.2); updatePdfView(); };
            document.getElementById('view-mode').onclick = togglePdfViewMode;
            
            updatePdfView();
        }

        function updatePdfView() {
            contentArea.innerHTML = '';
            updateZoomDisplay();
            
            if (pdfViewMode === 'single') {
                renderSinglePage();
            } else {
                renderAllPages();
            }
        }

        async function renderSinglePage() {
            const container = document.createElement('div');
            container.className = 'media-container';
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas';
            container.appendChild(canvas);
            contentArea.appendChild(container);
            
            await renderPageToCanvas(pdfPages[pageNum], canvas, pdfScale);
            document.getElementById('page-num').textContent = pageNum;
        }

        async function renderAllPages() {
            const container = document.createElement('div');
            container.className = 'pdf-all-pages';
            contentArea.appendChild(container);
            
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                container.appendChild(canvas);
                await renderPageToCanvas(pdfPages[i], canvas, pdfScale);
            }
        }

        async function renderPageToCanvas(page, canvas, scale) {
            const viewport = page.getViewport({ scale: scale * 2 });
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = (viewport.width / 2) + 'px';
            canvas.style.height = (viewport.height / 2) + 'px';
            
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        }

        function changePage(delta) {
            const newPage = pageNum + delta;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                if (pdfViewMode === 'single') {
                    updatePdfView();
                } else {
                    document.getElementById('page-num').textContent = pageNum;
                    const pages = contentArea.querySelectorAll('.pdf-page-canvas');
                    if (pages[pageNum - 1]) {
                        pages[pageNum - 1].scrollIntoView({ behavior: 'auto', block: 'center' });
                    }
                }
            }
        }

        function togglePdfViewMode() {
            pdfViewMode = pdfViewMode === 'single' ? 'all' : 'single';
            document.getElementById('view-mode').classList.toggle('active', pdfViewMode === 'all');
            updatePdfView();
        }

        function updateZoomDisplay() {
            document.getElementById('zoom-level').textContent = Math.round(pdfScale * 100) + '%';
        }

        async function renderImage(file) {
            document.getElementById('image-tools').style.display = 'flex';
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const container = document.createElement('div');
                    container.className = 'media-container';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'media-content';
                    img.id = 'main-image';
                    container.appendChild(img);
                    contentArea.appendChild(container);
                    
                    document.getElementById('rotate-btn').onclick = () => {
                        imageRotation = (imageRotation + 90) % 360;
                        img.style.transform = `rotate(${imageRotation}deg)`;
                    };
                    document.getElementById('fit-btn').onclick = () => {
                        img.style.maxWidth = img.style.maxWidth === 'none' ? '100%' : 'none';
                        img.style.maxHeight = img.style.maxHeight === 'none' ? '85vh' : 'none';
                    };
                    
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderVideo(file) {
            const container = document.createElement('div');
            container.className = 'media-container';
            const vid = document.createElement('video');
            vid.src = URL.createObjectURL(file);
            vid.controls = true;
            vid.className = 'media-content';
            container.appendChild(vid);
            contentArea.appendChild(container);
        }

        function renderAudio(file) {
            const container = document.createElement('div');
            container.className = 'media-container';
            container.style.flexDirection = 'column';
            const icon = document.createElement('i');
            icon.className = 'fa-solid fa-music';
            icon.style.cssText = 'font-size:80px;color:#64748b;margin-bottom:30px;';
            const audio = document.createElement('audio');
            audio.src = URL.createObjectURL(file);
            audio.controls = true;
            audio.style.width = '400px';
            container.appendChild(icon);
            container.appendChild(audio);
            contentArea.appendChild(container);
        }

        async function renderText(file) {
            const text = await file.text();
            const div = document.createElement('div');
            div.className = 'text-container';
            div.contentEditable = "true";
            div.innerText = text;
            contentArea.appendChild(div);
        }

        // ===== ЭКСПОРТ =====
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            const isOpen = menu.style.display === 'block';
            document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            menu.style.display = isOpen ? 'none' : 'block';
        }

        async function exportToHTML() {
            closeMenus();
            showLoader('Создание HTML...');
            
            let htmlContent = "";
            const bgColor = bgColorPicker.value;
            
            if (currentFileType === 'pdf' && pdfDoc) {
                let imagesHTML = '';
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    updateProgress((i / pdfDoc.numPages) * 100);
                    const dataUrl = await renderPdfPageToDataUrl(i, 2);
                    imagesHTML += `<img src="${dataUrl}" style="max-width:100%;display:block;margin:20px auto;box-shadow:0 2px 10px rgba(0,0,0,0.2);">`;
                }
                htmlContent = `<div style="background:${bgColor};padding:20px;min-height:100vh;">${imagesHTML}</div>`;
            } else if (contentArea.querySelector('.docx-wrapper')) {
                const clone = contentArea.querySelector('.docx-wrapper').cloneNode(true);
                await embedImages(clone);
                htmlContent = `<div style="background:${bgColor};padding:40px;min-height:100vh;display:flex;justify-content:center;"><div style="background:white;padding:50px;max-width:900px;width:100%;box-shadow:0 0 20px rgba(0,0,0,0.1);">${clone.innerHTML}</div></div>`;
            } else if (contentArea.querySelector('img.media-content')) {
                const img = contentArea.querySelector('img.media-content');
                htmlContent = `<div style="background:${bgColor};min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;"><img src="${img.src}" style="max-width:100%;max-height:90vh;transform:rotate(${imageRotation}deg);"></div>`;
            } else if (contentArea.querySelector('.text-container')) {
                htmlContent = `<pre style="background:${bgColor};font-family:monospace;padding:40px;margin:0;min-height:100vh;">${escapeHtml(contentArea.querySelector('.text-container').innerText)}</pre>`;
            }

            downloadFile(
                `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${currentFile.name}</title><style>*{margin:0;padding:0;box-sizing:border-box;}body{background:${bgColor};}</style></head><body>${htmlContent}</body></html>`,
                getBaseName(currentFile.name) + ".html",
                "text/html"
            );
            hideLoader();
        }

        async function exportToJPG() {
            closeMenus();
            showLoader('Создание JPG...');
            showProgress();
            
            const DPI_SCALE = 300 / 96;
            const JPG_QUALITY = 0.8;
            const bgColor = bgColorPicker.value;

            try {
                if (currentFileType === 'pdf' && pdfDoc) {
                    if (pdfDoc.numPages === 1) {
                        const dataUrl = await renderPdfPageToDataUrl(1, DPI_SCALE * 2, bgColor);
                        downloadDataUrl(dataUrl, getBaseName(currentFile.name) + ".jpg");
                    } else {
                        const zip = new JSZip();
                        for (let i = 1; i <= pdfDoc.numPages; i++) {
                            updateProgress((i / pdfDoc.numPages) * 100);
                            setLoaderText(`Обработка страницы ${i} из ${pdfDoc.numPages}...`);
                            const dataUrl = await renderPdfPageToDataUrl(i, DPI_SCALE * 2, bgColor);
                            const base64 = dataUrl.split(',')[1];
                            zip.file(`page_${String(i).padStart(3, '0')}.jpg`, base64, { base64: true });
                        }
                        setLoaderText('Создание архива...');
                        const blob = await zip.generateAsync({ type: 'blob' });
                        downloadBlob(blob, getBaseName(currentFile.name) + "_pages.zip");
                    }
                } else if (contentArea.querySelector('.docx-wrapper')) {
                    const dataUrl = await htmlToJpg(contentArea.querySelector('.docx-wrapper'), DPI_SCALE, JPG_QUALITY, bgColor);
                    downloadDataUrl(dataUrl, getBaseName(currentFile.name) + ".jpg");
                } else if (contentArea.querySelector('img.media-content')) {
                    const img = contentArea.querySelector('img.media-content');
                    const dataUrl = await imageToJpg(img, DPI_SCALE, JPG_QUALITY, bgColor);
                    downloadDataUrl(dataUrl, getBaseName(currentFile.name) + ".jpg");
                } else if (contentArea.querySelector('.text-container')) {
                    const dataUrl = await htmlToJpg(contentArea.querySelector('.text-container'), DPI_SCALE, JPG_QUALITY, bgColor);
                    downloadDataUrl(dataUrl, getBaseName(currentFile.name) + ".jpg");
                } else if (contentArea.querySelector('canvas')) {
                    const canvas = contentArea.querySelector('canvas');
                    downloadDataUrl(canvas.toDataURL('image/jpeg', JPG_QUALITY), getBaseName(currentFile.name) + ".jpg");
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка экспорта: ' + err.message);
            }
            
            hideLoader();
        }

        async function renderPdfPageToDataUrl(pageNum, scale = 2, bgColor = '#ffffff') {
            const page = pdfPages[pageNum];
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            
            return canvas.toDataURL('image/jpeg', 0.8);
        }

async function htmlToJpg(element, scale, quality, bgColor) {
            console.log('--- htmlToJpg Start ---');
            const clone = element.cloneNode(true);
            
            // СБРОС СТИЛЕЙ ДЛЯ КЛОНА (максимально убираем отступы)
            clone.style.margin = '0';
            clone.style.padding = '0'; // Убрали padding
            clone.style.boxShadow = 'none';
            clone.style.border = 'none';
            clone.style.maxWidth = 'none';
            clone.style.minHeight = 'auto';
            clone.style.width = element.scrollWidth + 'px'; 
            
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.top = '0';
            document.body.appendChild(clone);
            
            await embedImages(clone);
            
            const width = clone.scrollWidth;
            const height = clone.scrollHeight;
            
            console.log('Размеры для рендера (без padding):', width, 'x', height);

            const canvas = document.createElement('canvas');
            canvas.width = width * scale;
            canvas.height = height * scale;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, width, height);
            
            const data = `
                <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
                    <foreignObject width="100%" height="100%">
                        <div xmlns="http://www.w3.org/1999/xhtml" style="font-family:Segoe UI,sans-serif;">
                            ${clone.outerHTML}
                        </div>
                    </foreignObject>
                </svg>
            `;
            
            const img = new Image();
            const svgBlob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            return new Promise((resolve, reject) => {
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    document.body.removeChild(clone);
                    console.log('--- htmlToJpg Success ---');
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (e) => {
                    console.error('Ошибка загрузки SVG в Canvas', e);
                    document.body.removeChild(clone);
                    ctx.fillStyle = '#000';
                    ctx.font = '20px sans-serif';
                    ctx.fillText('Ошибка рендеринга', 50, 50);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = url;
            });
        }
        

        async function imageToJpg(imgElement, scale, quality, bgColor) {
            const canvas = document.createElement('canvas');
            
            const isRotated = imageRotation === 90 || imageRotation === 270;
            const w = imgElement.naturalWidth;
            const h = imgElement.naturalHeight;
            
            canvas.width = (isRotated ? h : w) * scale;
            canvas.height = (isRotated ? w : h) * scale;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(imageRotation * Math.PI / 180);
            ctx.drawImage(imgElement, -w * scale / 2, -h * scale / 2, w * scale, h * scale);
            
            return canvas.toDataURL('image/jpeg', quality);
        }

        function exportToTXT() {
            closeMenus();
            downloadFile(contentArea.innerText, getBaseName(currentFile.name) + ".txt", "text/plain");
        }

        // Печать как изображение (оригинальный размер)
        async function printAsImage() {
            closeMenus();
            showLoader('Подготовка к печати...');
            
            let dataUrl;
            const bgColor = bgColorPicker.value;
            
            try {
                if (currentFileType === 'pdf' && pdfDoc) {
                    dataUrl = await renderPdfPageToDataUrl(pageNum, 3, bgColor);
                } else if (contentArea.querySelector('img.media-content')) {
                    const img = contentArea.querySelector('img.media-content');
                    dataUrl = await imageToJpg(img, 2, 0.95, bgColor);
                } else if (contentArea.querySelector('.docx-wrapper')) {
                    dataUrl = await htmlToJpg(contentArea.querySelector('.docx-wrapper'), 2, 0.95, bgColor);
                } else if (contentArea.querySelector('.text-container')) {
                    dataUrl = await htmlToJpg(contentArea.querySelector('.text-container'), 2, 0.95, bgColor);
                } else if (contentArea.querySelector('canvas')) {
                    dataUrl = contentArea.querySelector('canvas').toDataURL('image/jpeg', 0.95);
                }

                if (dataUrl) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Печать - ${currentFile.name}</title>
                            <style>
                                * { margin: 0; padding: 0; }
                                body { display: flex; justify-content: center; }
                                img { max-width: 100%; height: auto; }
                            </style>
                        </head>
                        <body>
                            <img src="${dataUrl}" onload="setTimeout(function(){window.print();window.close();},200);">
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка подготовки печати: ' + err.message);
            }
            
            hideLoader();
        }

// Печать с подгонкой на 1 страницу A4
        async function printFitToPage() {
            closeMenus();
            showLoader('Подготовка к печати...');
            console.log('Начало подготовки к печати...');
            
            let dataUrl;
            const bgColor = bgColorPicker.value;
            
            try {
                if (currentFileType === 'pdf' && pdfDoc) {
                    console.log('Тип: PDF');
                    // Увеличим scale до 4, чтобы повысить детализацию
                    dataUrl = await renderPdfPageToDataUrl(pageNum, 4, bgColor); 
                } else if (contentArea.querySelector('img.media-content')) {
                    console.log('Тип: Изображение');
                    const img = contentArea.querySelector('img.media-content');
                    dataUrl = await imageToJpg(img, 2, 0.95, bgColor);
                } else if (contentArea.querySelector('.docx-wrapper')) {
                    console.log('Тип: DOCX/HTML Wrapper');
                    dataUrl = await htmlToJpg(contentArea.querySelector('.docx-wrapper'), 2, 0.95, bgColor);
                } else if (contentArea.querySelector('.text-container')) {
                    console.log('Тип: Текст');
                    dataUrl = await htmlToJpg(contentArea.querySelector('.text-container'), 2, 0.95, bgColor);
                } else if (contentArea.querySelector('canvas')) {
                    console.log('Тип: Canvas');
                    dataUrl = contentArea.querySelector('canvas').toDataURL('image/jpeg', 0.95);
                }

                if (dataUrl) {
                    console.log('DataURL получен. Длина строки:', dataUrl.length);
                    const printWindow = window.open('', '_blank');
                    
                    if (!printWindow) {
                        alert('Браузер заблокировал всплывающее окно печати. Разрешите всплывающие окна.');
                        hideLoader();
                        return;
                    }

                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Печать</title>
                            <style>
                                @page {
                                    size: A4;
                                    margin: 0; /* Убираем поля принтера */
                                }
                                html, body {
                                    margin: 0;
                                    padding: 0;
                                    width: 100%;
                                    height: 100%;
                                    overflow: hidden; /* Скрываем скроллбары */
                                }
                                body {
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    background: white;
                                }
                                img {
                                    width: 100%;       
                                    height: 100vh;     
                                    
                                    /* Пробуем cover: может обрезать края, но заполнит все */
                                    /* object-fit: cover; */
                                    
                                    /* Оставляем contain, т.к. это документы */
                                    object-fit: contain; 
                                    
                                    display: block;
                                }
                            </style>
                        </head>
                        <body>
                            <img src="${dataUrl}" onload="console.log('Image loaded inside print window'); setTimeout(function(){ window.print(); window.close(); }, 500);">
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                } else {
                    console.error('DataURL не был создан.');
                }
            } catch (err) {
                console.error('CRITICAL ERROR in printFitToPage:', err);
                alert('Ошибка: ' + err.message);
            }
            
            hideLoader();
        }
        

        // ===== УТИЛИТЫ =====
        async function embedImages(element) {
            const images = element.querySelectorAll('img');
            for (let img of images) {
                if (img.src.startsWith('blob:') || img.src.startsWith('http')) {
                    try {
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        img.src = await blobToBase64(blob);
                    } catch (e) {}
                }
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function downloadFile(text, name, mime) {
            const blob = new Blob([text], { type: mime });
            downloadBlob(blob, name);
        }

        function downloadBlob(blob, name) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadDataUrl(dataUrl, name) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function getBaseName(filename) {
            return filename.replace(/\.[^/.]+$/, "");
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.innerText = text;
            return div.innerHTML;
        }

        function closeMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
        }

        function closeViewer() {
            document.getElementById('viewer-screen').style.display = 'none';
            document.getElementById('drop-screen').style.display = 'flex';
            fileInput.value = '';
            if (pdfDoc) { pdfDoc.destroy(); pdfDoc = null; }
            pdfPages = [];
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.getElementById('fullscreen-btn').innerHTML = '<i class="fa-solid fa-compress"></i>';
            } else {
                document.exitFullscreen();
                document.getElementById('fullscreen-btn').innerHTML = '<i class="fa-solid fa-expand"></i>';
            }
        }

        function showLoader(text = 'Загрузка...') {
            document.getElementById('loader-text').textContent = text;
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('progress-bar').style.display = 'none';
        }
        
        function setLoaderText(text) {
            document.getElementById('loader-text').textContent = text;
        }
        
        function showProgress() {
            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('progress-fill').style.width = '0%';
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }
    </script>
</body>
</html>
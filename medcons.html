<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>МедПомощник</title>
    <script src="webfonts/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="webfonts/all.min.css">
    <link id="favicon" rel="icon" href="img/med.png" type="image/png">
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg-color: #ffffff;
        --text-color: #333;
        --primary-color: #007bff;
        --primary-color-dark: #0056b3;
        --secondary-text-color: #555;
        --border-color: #e0e6ec;
        --danger-color: #dc3545;
        --danger-bg-color: #f8d7da;
        --print-color: #28a745;
        --print-dark-color: #218838;
        --new-chat-color: #FFA500;
        --new-chat-dark-color: #E86100;
        --indicator-color: #ff4d4d;
    }

    html, body {
        height: 100%; margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .app-container {
        display: flex; flex-direction: column;
        height: 100dvh;
        background-color: var(--card-bg-color);
    }
    
    .app-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 25px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 10;
    }
    .app-header h1 {
        grid-column: 2 / 3;
        margin: 0; font-size: 24px; font-weight: 500;
        color: var(--primary-color);
        text-align: center;
    }
    .header-right-controls {
        grid-column: 3 / 4;
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }
    .app-header h1 i { margin-right: 10px; }
    #change-key-btn {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        transition: color 0.2s;
        margin-left: 15px;
        display: none;
        color: var(--new-chat-color);
    }
    #change-key-btn:hover {
        color: var(--new-chat-dark-color); 
    }
    
    .api-mode-switcher {
        display: flex; align-items: center; font-size: 12px; color: var(--secondary-text-color);
    }
    .api-mode-switcher .switch {
        position: relative; display: inline-block; width: 40px; height: 20px; margin: 0 8px;
    }
    .api-mode-switcher .switch input { opacity: 0; width: 0; height: 0; }
    .api-mode-switcher .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc; transition: .4s; border-radius: 20px;
    }
    .api-mode-switcher .slider:before {
        position: absolute; content: ""; height: 14px; width: 14px;
        left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
    }
    .api-mode-switcher input:checked + .slider { background-color: var(--primary-color); }
    .api-mode-switcher input:checked + .slider:before { transform: translateX(20px); }

    .mode-selector {
        display: flex; justify-content: center; flex-wrap: wrap; padding: 15px 10px;
        background-color: #f8f9fa; border-bottom: 1px solid var(--border-color);
        gap: 10px; flex-shrink: 0;
    }
    .mode-btn {
        padding: 10px 15px; font-size: 14px; font-weight: 500; border: 1px solid transparent;
        background-color: transparent; color: var(--secondary-text-color); cursor: pointer;
        border-radius: 8px; transition: all 0.3s ease; position: relative;
    }
    .mode-btn:hover { background-color: #e9ecef; }
    .mode-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .mode-btn i { margin-right: 8px; }

    .mode-btn.is-loading::after {
        content: ''; position: absolute; top: -4px; right: -4px; width: 10px; height: 10px;
        background-color: var(--indicator-color); border-radius: 50%; border: 2px solid white;
        box-shadow: 0 0 5px var(--indicator-color); animation: pulse 1.5s infinite;
    }
    .response-timer {
        display: none;
        position: absolute;
        top: -8px;
        right: -5px;
        background-color: var(--primary-color);
        color: white;
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 10px;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        z-index: 2;
        white-space: nowrap;
    }
    .mode-btn.has-new-response .response-timer {
        display: inline-block;
    }
    @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.9; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.9; } }

    .response-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .response-actions {
        padding: 10px 25px; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color);
        display: none; gap: 10px; flex-shrink: 0; align-items: center;
    }
    .action-btn {
        padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;
        font-weight: 500; color: white; transition: all 0.2s ease; border: none;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn i { margin-right: 8px; }
    #copy-btn { background-color: var(--primary-color); }
    #copy-btn:hover { background-color: var(--primary-color-dark); }
    #print-btn { background-color: var(--print-color); }
    #print-btn:hover { background-color: var(--print-dark-color); }
    #new-chat-btn { background-color: var(--new-chat-color); margin-left: auto; }
    #new-chat-btn:hover { background-color: var(--new-chat-dark-color); }

    .response-wrapper { flex-grow: 1; overflow-y: auto; padding: 25px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .welcome-message {
        text-align: center; color: var(--secondary-text-color); padding-top: 15vh;
        animation: fadeInUp 0.5s ease forwards;
    }
    .welcome-message i { font-size: 48px; margin-bottom: 20px; color: var(--primary-color); opacity: 0.8; }
    .welcome-message h2 { font-weight: 500; font-size: 22px; color: var(--text-color); margin-bottom: 10px; }
    .welcome-message p { font-size: 16px; line-height: 1.6; }
    .welcome-message p em { color: #999; font-size: 14px; display: block; margin-top: 15px; }

    #ai-response { line-height: 1.7; font-size: 16px; }
    #ai-response h3, #ai-response h2 {
        font-size: 18px; font-weight: 500; color: var(--text-color); margin-top: 30px;
        margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    #ai-response h2 { font-size: 20px; text-align: center; border-bottom: 2px solid var(--primary-color); }
    #ai-response h3 i { margin-right: 10px; }
    #ai-response ul, #ai-response ol { padding-left: 25px; }
    #ai-response li { margin-bottom: 8px; }
    #ai-response strong { color: var(--primary-color-dark); font-weight: 500; }
    #ai-response hr { border: none; border-top: 3px dotted #ced4da; margin: 40px 20%; }
    #ai-response table {
        width: 100%; border-collapse: collapse; margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
    }
    #ai-response th, #ai-response td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
    #ai-response th { background-color: #f8f9fa; font-weight: 500; }
    #ai-response .disclaimer {
        display: block; background-color: var(--danger-bg-color); border: 1px solid var(--danger-color);
        color: #721c24; padding: 15px; border-radius: 8px; font-size: 15px;
        line-height: 1.6; margin-top: 30px; text-align: left; font-weight: 700 !important;
    }
    #ai-response .disclaimer i { margin-right: 10px; }
    
    .loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
    .lds-heart {
      display: inline-block; position: relative; width: 80px; height: 80px;
      transform: rotate(45deg); transform-origin: 40px 40px;
    }
    .lds-heart div {
      top: 32px; left: 32px; position: absolute; width: 32px; height: 32px; background: var(--danger-color); 
      animation: lds-heart 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
    }
    .lds-heart div:after, .lds-heart div:before {
      content: " "; position: absolute; display: block; width: 32px; height: 32px; background: var(--danger-color);
    }
    .lds-heart div:before { left: -24px; border-radius: 50% 0 0 50%; }
    .lds-heart div:after { top: -24px; border-radius: 50% 50% 0 0; }
    @keyframes lds-heart { 0% { transform: scale(0.95); } 5% { transform: scale(1.1); } 39% { transform: scale(0.85); } 45% { transform: scale(1); } 60% { transform: scale(0.95); } 100% { transform: scale(0.9); } }
    .loader p { margin-top: 20px; color: var(--secondary-text-color); font-size: 16px; }
    #cancel-btn { 
        margin-top: 15px; background-color: var(--new-chat-color); color: white;
        border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;
    }
    #cancel-btn:hover { background-color: var(--new-chat-dark-color); }

    .input-panel {
        display: flex; padding: 15px 25px; gap: 15px; border-top: 1px solid var(--border-color);
        background-color: #f8f9fa; flex-shrink: 0; align-items: center;
    }
    #user-query {
        flex-grow: 1; padding: 12px 15px; font-size: 16px; font-family: 'Roboto', sans-serif;
        border-radius: 22px; border: 1px solid var(--border-color); resize: none;
        height: 24px; line-height: 24px; transition: all 0.2s ease; max-height: 150px;
    }
    #user-query:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
    #send-btn {
        flex-shrink: 0; width: 48px; height: 48px; border-radius: 50%; border: none;
        background-color: var(--primary-color); color: white; font-size: 20px;
        cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
    }
    #send-btn:hover { background-color: var(--primary-color-dark); }
    #user-query:disabled, #send-btn:disabled, .mode-btn:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .modal-content {
        background-color: white; padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; text-align: center;
    }
    .modal-content h2 { margin-top: 0; color: var(--primary-color); }
    .modal-content p { color: var(--secondary-text-color); line-height: 1.6; }
    .modal-content a { color: var(--primary-color-dark); text-decoration: none; }
    .modal-content a:hover { text-decoration: underline; }
    #api-key-input {
        width: calc(100% - 24px); padding: 12px; margin-top: 15px; margin-bottom: 20px;
        border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;
    }
    #save-api-key-btn {
        width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 500;
        cursor: pointer; transition: background-color 0.2s;
    }
    #save-api-key-btn:hover { background-color: var(--primary-color-dark); }

 @media print {
    /* Скрываем все интерактивные элементы, которые не нужны на печати */
    .app-header, .input-panel, .response-actions, .mode-selector, #change-key-btn {
        display: none !important;
    }

    /* Сбрасываем стили для основного контейнера и тела документа */
    body, .app-container {
        background-color: #ffffff !important;
        box-shadow: none !important;
        height: auto !important;
        overflow: visible !important;
        color: #000000 !important;
    }

    /* КЛЮЧЕВОЙ момент: убираем ограничения по высоте и прокрутку для контейнеров ответа */
    .response-area,
    .response-wrapper {
        height: auto !important;
        overflow: visible !important;
        display: block !important;
        padding: 0 !important;
        flex-grow: 0 !important;
    }

    /* Оптимизируем стили самого ответа для печати */
    #ai-response {
        line-height: 1.4;
        font-size: 12pt;
    }

    /* Убираем тени и управляем переносами таблиц */
    #ai-response table {
        box-shadow: none !important;
        page-break-inside: auto;
    }
    #ai-response tr {
        page-break-inside: avoid;
    }
}

    @media (max-width: 768px) {
        .app-header {
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px 15px;
        }
        .app-header h1 {
            grid-column: 1 / -1;
            order: 1;
        }
        .header-right-controls {
            grid-column: 1 / -1;
            justify-content: center;
            order: 2;
        }
        .header-left { display: none; }
        .mode-selector { padding: 10px; flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
        .mode-btn { padding: 8px 12px; font-size: 14px; flex-shrink: 0; }
        .welcome-message { padding-top: 10vh; }
        #ai-response { font-size: 15px; }
        .input-panel { padding: 15px; }
    }
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left"></div>
            <h1><i class="fa-solid fa-laptop-medical"></i>МедПомощник</h1>
            <div class="header-right-controls">
                <div class="api-mode-switcher">
                    <span>Vercel</span>
                    <label class="switch">
                        <input type="checkbox" id="api-mode-toggle">
                        <span class="slider"></span>
                    </label>
                    <span>Gemini</span>
                </div>
                <button id="change-key-btn" title="Сменить API ключ"><i class="fas fa-key"></i></button>
            </div>
        </header>
        
        <div class="mode-selector">
            <button class="mode-btn" id="mode-symptoms" data-mode="symptoms"><i class="fa-solid fa-user-doctor"></i>Консультант<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-medications" data-mode="medications"><i class="fa-solid fa-pills"></i>Справ. лекарств<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-substances" data-mode="substances"><i class="fa-solid fa-flask-vial"></i>Справ. веществ<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-lifestyle" data-mode="lifestyle"><i class="fa-solid fa-apple-whole"></i>ЗОЖ и Питание<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-atlas" data-mode="atlas"><i class="fa-solid fa-person-dots-from-line"></i>Анатомия<span class="response-timer"></span></button>
            <button class="mode-btn" id="mode-first-aid" data-mode="first-aid"><i class="fa-solid fa-kit-medical"></i>Первая помощь<span class="response-timer"></span></button>
        </div>

        <main class="response-area">
            <div class="response-actions" id="response-actions">
                <button class="action-btn" id="copy-btn"><i class="fa-solid fa-copy"></i>Копировать</button>
                <button class="action-btn" id="print-btn"><i class="fa-solid fa-print"></i>Печать</button>
                <button class="action-btn" id="new-chat-btn"><i class="fa-solid fa-plus-circle"></i>Новый чат</button>
            </div>
            <div class="response-wrapper" id="response-wrapper">
                <div id="ai-response"></div>
            </div>
        </main>

        <div class="input-panel">
            <textarea id="user-query" placeholder="Задайте вопрос или опишите симптомы..." rows="1"></textarea>
            <button id="send-btn" title="Отправить запрос"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="api-key-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Требуется API ключ Google Gemini</h2>
            <p>Для работы в режиме "Gemini" вставьте ваш API-ключ. Он будет сохранен локально в вашем браузере. Вы можете переключиться на "Vercel", чтобы работать без ключа.</p>
            <p><a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Получить ключ в Google AI Studio <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a></p>
            <input type="password" id="api-key-input" placeholder="Введите ваш API ключ...">
            <button id="save-api-key-btn">Сохранить и начать</button>
        </div>
    </div>

<script>
    // --- СИСТЕМНЫЕ ПРОМПТЫ (исправленные) ---
    const AI_SYSTEM_PROMPT_SYMPTOMS = `Ты — 'Медицинский Консультант-Помощник', высокопрофессиональный, эмпатичный и ответственный ИИ-ассистент. Твоя главная задача — предоставлять структурированную и объективную информацию по медицинским запросам пользователей, помогая им лучше понять свое состояние и принять взвешенное решение об обращении к врачу.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **Только медицина:** Отвечай исключительно на запросы, связанные со здоровьем. На немедицинские темы вежливо отказывай, напоминая о своей специализации.
2.  **НЕ СТАВЬ ДИАГНОЗ:** Это твое главное правило. Всегда используй формулировки 'возможные причины', 'может указывать на', 'одно из состояний, которое может проявляться так'.
3.  **НЕ НАЗНАЧАЙ ЛЕКАРСТВА:** Никогда не упоминай конкретные названия рецептурных препаратов и их дозировки. Допустимо упоминать общие группы препаратов (например, 'врач может назначить антигистаминные средства') или безрецептурные методы (полоскание горла).
4.  **ЭКСТРЕННЫЕ СЛУЧАИ:** При малейшем намеке на угрожающее жизни состояние (инфаркт, инсульт, сильное кровотечение, потеря сознания) немедленно и в первую очередь порекомендуй вызвать скорую помощь или обратиться в ближайшее отделение неотложной помощи.
5.  **Контекст диалога:** Ты ведешь диалог. Учитывай предыдущие сообщения пользователя и свои ответы, чтобы давать более точные и контекстуальные рекомендации. Если пользователь уточняет информацию, основывай свой новый ответ на всей истории переписки.
6.  **Язык и формат:** Твой ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Никогда не включай в свой ответ внутренние размышления, мета-комментарии или план ответа. Генерируй только конечный, отформатированный Markdown-текст для пользователя. Таблицы должны быть лаконичными.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
Используй Markdown для форматирования. Разделяй основные секции горизонтальной линией (\`---\`).

### 1. Предварительная оценка симптомов/запроса
Кратко изложи, как ты понял проблему пользователя. Если запрос слишком общий или неясный, задай 2-3 уточняющих вопроса для более точного ответа. Например: 'Как долго это продолжается?', 'Есть ли другие симптомы (температура, слабость)?', 'Усиливается ли боль при определенных действиях?'.

---
### 2. Возможные причины
Предоставь информацию в виде таблицы. **Никогда не используй слово 'диагноз'**.

| Возможная причина | Краткое описание | Степень соответствия симптомам* |
|---|---|---|
| [Название состояния 1] | [Описание состояния и как оно соотносится с симптомами] | Высокая / Средняя / Низкая |
| [Название состояния 2] | [Описание состояния и как оно соотносится с симптомами] | Высокая / Средняя / Низкая |
| ... | ... | ... |
*Степень соответствия — это предположение, основанное на предоставленной информации, и не является диагнозом.

---
### 3. Рекомендации
*   **Общие рекомендации:** Советы по образу жизни (покой, питьевой режим, диета).
*   **Самопомощь (если безопасно):** Что можно сделать для облегчения симптомов до визита к врачу (например, прохладный компресс, полоскание горла).
*   **К какому специалисту обратиться:** Укажи профиль врача (например, **терапевт (врач общей практики)**, **гастроэнтеролог**, **невролог**). Начинай с врача первичного звена, если не уверены.

---
### 4. Важные предупреждения ('Красные флаги')
*   **Тревожные симптомы:** Четкий список симптомов, при появлении которых нужно **немедленно** обратиться за медицинской помощью.
*   **Возможные осложнения:** Кратко опиши, почему не стоит игнорировать симптомы (без запугивания).

---
### 5. Дополнительная информация
*   **Профилактика:** Советы по предотвращению подобных состояний в будущем.
*   **Полезные источники:**
    *   [Название статьи/ресурса 1](полная_ссылка_1) - краткое описание.
    *   [Название статьи/ресурса 2](полная_ссылка_2) - краткое описание.

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Эта информация предоставлена ИИ в образовательных и ознакомительных целях и не может заменить личную консультацию с квалифицированным медицинским работником. Для постановки диагноза и назначения лечения всегда обращайтесь к врачу.`;
    const AI_SYSTEM_PROMPT_MEDS = `Ты — 'AI-Фармсправочник', беспристрастный и точный информационный ассистент. Твоя задача — предоставлять структурированную и объективную информацию о лекарственных препаратах по запросу пользователя.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **Только факты:** Не давай советов, мнений или рекомендаций. Только сухая, фактическая информация из авторитетных источников.
2.  **НЕ НАЗНАЧАЙ ЛЕЧЕНИЕ:** Категорически запрещено советовать препарат для лечения каких-либо симптомов. Твоя роль — справочник, а не врач.
3.  **Дозировки:** Указывая информацию о дозировках, всегда добавляй фразу: **'Строго по назначению и под контролем лечащего врача'**.
4.  **Язык и формат:** Твой ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Никогда не включай в свой ответ внутренние размышления, мета-комментарии или план ответа. Генерируй только конечный, отформатированный Markdown-текст для пользователя.
5.  **ССЫЛКИ:** Если возможно, предоставь 1-2 ссылки на официальные реестры лекарственных средств или авторитетные медицинские порталы (например, РЛС®, Vidal, MedlinePlus) со страницей данного препарата.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
Отвечай строго в формате Markdown по следующей структуре.

## Справка по препарату: [Название препарата]

### 1. Общая информация
Предоставь информацию в виде таблицы.

| Параметр | Информация |
|---|---|
| **Действующее вещество** | [Название вещества] |
| **Фармакологическая группа** | [Название группы] |
| **Форма выпуска** | [Например: Таблетки, покрытые пленочной оболочкой, 100 мг; Раствор для инъекций и т.д.] |
| **Краткое описание действия** | [Как препарат работает, на что влияет] |

---
### 2. Основные показания к применению
*   [Показание 1]
*   [Показание 2]
*   ...

---
### 3. Способ применения и дозы
*   [Общая информация о том, как принимается препарат (внутрь, наружно и т.д.)].
*   **Важно: режим дозирования и продолжительность лечения определяются лечащим врачом индивидуально для каждого пациента. Не занимайтесь самолечением!**

---
### 4. Основные противопоказания и побочные эффекты
*   **Противопоказания:** [Список основных противопоказаний, например: повышенная чувствительность, беременность, детский возраст до X лет].
*   **Частые побочные эффекты:** [Список 2-3 наиболее частых побочных эффектов].

---
### 5. Аналоги (препараты с тем же действующим веществом)
Предоставь таблицу с аналогами (минимум 5, если существует столько).

| Торговое название аналога | Производитель (страна) |
|---|---|
| [Аналог 1] | [Производитель 1] |
| [Аналог 2] | [Производитель 2] |
| ... | ... |

---
### 6. Полезные источники
*   [Название ресурса 1](полная_ссылка_1) - официальная инструкция или описание.
*   [Название ресурса 2](полная_ссылка_2) - дополнительная информация.

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Вся информация предоставлена ИИ исключительно в ознакомительных целях и не является руководством к действию или заменой медицинской консультации. Перед применением любого лекарственного препарата ОБЯЗАТЕЛЬНО проконсультируйтесь с квалифицированным врачом. Самолечение может быть опасно для вашего здоровья!`;
    const AI_SYSTEM_PROMPT_SUBSTANCES = `Ты — 'AI-Нутрициолог', научный и объективный ассистент. Твоя задача — предоставлять исчерпывающую, структурированную и безопасную информацию о различных химических веществах, витаминах, минералах, пищевых компонентах и их влиянии на организм человека.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **Научная точность:** Вся информация должна быть основана на общепринятых научных данных. Не используй недоказанную или эзотерическую информацию.
2.  **НЕ ДАВАЙ ПРЯМЫХ РЕКОМЕНДАЦИЙ ПО ЛЕЧЕНИЮ:** Ты не врач. Нельзя советовать принимать вещество для лечения болезней. Можно лишь описать его физиологическую роль.
3.  **Безопасность прежде всего:** Всегда подчеркивай необходимость консультации с врачом перед приемом любых добавок (БАДов), особенно при наличии хронических заболеваний, беременности или приеме других лекарств.
4.  **Нормы потребления:** Указывая суточные нормы, всегда добавляй, что это усредненные значения, а индивидуальная потребность может отличаться.
5.  **Язык и формат:** Твой ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Никогда не включай в свой ответ внутренние размышления или мета-комментарии. Генерируй только конечный, отформатированный Markdown-текст для пользователя.
6.  **Источники:** По возможности, ссылайся на авторитетные источники (ВОЗ, национальные институты здравоохранения, научные публикации).

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
Отвечай строго в формате Markdown по следующей структуре.

## Анализ вещества: [Название вещества]

### 1. Общая характеристика
Предоставь информацию в виде таблицы.

| Параметр | Описание |
|---|---|
| **Тип вещества** | [Например: Водорастворимый витамин, незаменимая аминокислота, макроэлемент, алкалоид, простой углевод] |
| **Химическая формула** | [Формула вещества. Например, для Витамина C: C₆H₈O₆. Если это простой элемент (напр. Магний), укажи химический символ (Mg). Если формула сложная или неизвестна, напиши 'неприменимо'.] |
| **Основная роль в организме** | [Краткое описание главной функции, например: Антиоксидант, структурный компонент костей, нейромедиатор] |

---
### 2. Значение для здоровья
Подробно опиши ключевые функции вещества в организме человека.
*   **Функция 1:** [Описание]
*   **Функция 2:** [Описание]
*   ...

---
### 3. Суточная потребность и источники
*   **Рекомендуемая суточная норма:** Предоставь таблицу с усредненными нормами для разных групп. *Обязательно добавь примечание, что это общие рекомендации.*

| Категория | Норма в сутки |
|---|---|
| Взрослые мужчины | [значение и единицы] |
| Взрослые женщины | [значение и единицы] |
| Беременные/кормящие | [значение и единицы] |
| Дети (указать возраст) | [значение и единицы] |

*Примечание: Индивидуальная потребность может варьироваться в зависимости от возраста, пола, уровня физической активности и состояния здоровья. Проконсультируйтесь с врачом для определения вашей личной нормы.*
*   **Основные пищевые источники:**
    *   [Продукт 1] (примерное содержание, если известно)
    *   [Продукт 2] (примерное содержание, если известно)
    *   ...

---
### 4. Последствия дефицита и избытка (передозировки)
Предоставь сравнительную таблицу.

| | Признаки и симптомы | Возможные долгосрочные последствия |
|---|---|---|
| **Недостаток (Дефицит)** | [Список симптомов] | [Список состояний] |
| **Избыток (Передозировка)** | [Список симптомов] | [Список состояний, включая токсические эффекты] |

---
### 5. Применение в виде добавок (БАД) и особые указания
*   **Целесообразность приема:** В каких случаях врач может порекомендовать прием добавок с этим веществом (например, при подтвержденном дефиците, в определенные периоды жизни).
*   **Возможные риски и противопоказания:** Кому следует быть осторожным (люди с определенными заболеваниями, принимающие лекарства).
*   **Важные взаимодействия:** С какими лекарствами или другими веществами может взаимодействовать (например, снижать/усиливать эффект, увеличивать риск побочных эффектов). **Это очень важный пункт!**

---
### 6. Полезные источники
*   [Название авторитетного ресурса 1 (ВОЗ, NIH, MedlinePlus)](полная_ссылка_1) - краткое описание.
*   [Название авторитетного ресурса 2](полная_ссылка_2) - краткое описание.

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Информация предоставлена ИИ в образовательных целях. Она не является медицинской рекомендацией и не может заменить консультацию с врачом или диетологом. Перед началом приема любых витаминов, минералов или биологически активных добавок (БАД) ОБЯЗАТЕЛЬНО проконсультируйтесь со специалистом.`;
    const AI_SYSTEM_PROMPT_LIFESTYLE = `Ты — 'AI-Wellness Coach', квалифицированный и мотивирующий советник по здоровому образу жизни, питанию и физической активности. Твоя задача — предоставлять научно-обоснованные, безопасные и практические рекомендации, которые помогут пользователям улучшить свое самочувствие.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **НЕ ВРАЧ, А ТРЕНЕР:** Твоя роль — советовать и направлять, а не лечить. Ты не создаешь лечебные диеты (стол №5, диета при диабете и т.д.) и не разрабатываешь программы реабилитации после травм.
2.  **БЕЗОПАСНОСТЬ:** Всегда подчеркивай, что перед началом любой диеты или программы тренировок **необходима консультация с врачом**, особенно при наличии хронических заболеваний, беременности, в пожилом возрасте.
3.  **ПРИНЦИП 'ПРИМЕРА':** Любые планы питания или комплексы упражнений должны подаваться как **'пример'** или **'шаблон'**, а не как строгая и единственно верная инструкция.
4.  **ПОЗИТИВНЫЙ И МОТИВИРУЮЩИЙ ТОН:** Поддерживай пользователя, используй ободряющие формулировки. Избегай осуждения и категоричности.
5.  **Язык и формат:** Ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Генерируй только конечный, отформатированный Markdown-текст для пользователя.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
## Рекомендации по теме: [Название цели, например: 'Сбалансированное питание для поддержания веса']

### 1. Ключевые принципы (Философия успеха)
Кратко и понятно изложи основные правила, на которых строится рекомендация.
*   **Принцип 1:** [Например: Соблюдение водного баланса].
*   **Принцип 2:** [Например: Приоритет цельных продуктов над обработанными].
*   ...

---
### 2. Примерный план действий
Это основной блок с практикой. Он должен быть адаптирован под запрос (питание или упражнения).

**ЕСЛИ ЗАПРОС ПРО ПИТАНИЕ:**
Предоставь таблицу с **примером** сбалансированного меню на 1 день.

| Прием пищи | Вариант блюда (пример) | Почему это полезно? |
|---|---|---|
| **Завтрак** | Овсяная каша на воде с ягодами и орехами | Сложные углеводы для долгой энергии, клетчатка, витамины. |
| **Обед** | Куриная грудка на гриле с бурым рисом и салатом из свежих овощей | Белок для сытости, сложные углеводы, клетчатка. |
| **Ужин** | Запеченная рыба (треска, лосось) с брокколи на пару | Легкоусвояемый белок, омега-3 жирные кислоты, витамины. |
| **Перекусы** | Греческий йогурт, яблоко, горсть миндаля | Здоровые жиры, белок, клетчатка. |

**ЕСЛИ ЗАПРОС ПРО УПРАЖНЕНИЯ:**
Предоставь список упражнений с описанием.
1.  **Название упражнения 1:**
    *   **Цель:** Какие мышцы работают.
    *   **Техника выполнения:** Пошаговое описание.
    *   **Рекомендация:** Сколько повторений и подходов (указать, что это средние значения).
2.  **Название упражнения 2:** ...

---
### 3. Частые ошибки, которых стоит избегать
*   **Ошибка 1:** [Например: Пропускать завтрак, что ведет к перееданию вечером].
*   **Ошибка 2:** [Например: Использовать слишком большие веса в начале тренировок, рискуя получить травму].
*   ...

---
### 4. Дополнительные советы ('Лайфхаки')
*   [Небольшой практический совет, который легко внедрить. Например: 'Всегда держите на столе бутылку с водой, чтобы не забывать пить'].
*   [Еще один совет. Например: 'Готовьте еду на 2-3 дня вперед, чтобы избежать соблазна заказать фастфуд'].

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Эти рекомендации носят ознакомительный характер и не являются индивидуальной программой питания или тренировок. Перед любыми изменениями в образе жизни, диете или физической активности ОБЯЗАТЕЛЬНО проконсультируйтесь с врачом или профильным специалистом (диетологом, фитнес-тренером).`;
    const AI_SYSTEM_PROMPT_ATLAS = `Ты — 'AI-Анатом', увлеченный и понятный гид по человеческому телу. Твоя задача — рассказывать о строении и функциях органов и систем организма человека в доступной, структурированной и интересной форме.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **ТОЛЬКО ОБРАЗОВАНИЕ:** Твоя цель — просвещение, а не диагностика. Не связывай описание органа с возможными симптомами пользователя.
2.  **ПРОСТОТА И АНАЛОГИИ:** Используй простой язык и яркие аналогии для объяснения сложных процессов (например, 'почки — это фильтры', 'митохондрии — электростанции клетки').
3.  **СТРУКТУРА:** Строго следуй предложенной структуре ответа. Это делает информацию легкой для восприятия.
4.  **НЕ ДАВАЙ СОВЕТОВ ПО ЛЕЧЕНИЮ:** Упоминая заболевания, называй только их общие группы и предлагай пользователю обратиться к другим разделам приложения или к врачу.
5.  **Язык и формат:** Ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Генерируй только конечный, отформатированный Markdown-текст для пользователя.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
## Анатомический атлас: [Название органа или системы]

### 1. Где это находится? (Локализация)
Краткое и понятное описание расположения органа/системы в теле человека.

---
### 2. Из чего состоит? (Строение)
Краткий список основных структурных компонентов. Не нужно углубляться в гистологию, только ключевые части.
*   **Часть 1:** [Краткое описание]
*   **Часть 2:** [Краткое описание]
*   ...

---
### 3. Зачем это нужно? (Основные функции)
Это самый важный раздел. Подробный нумерованный список основных функций.
1.  **Функция 1:** [Описание функции с использованием простой аналогии, если возможно].
2.  **Функция 2:** [Описание функции...].
3.  ...

---
### 4. Как это работает с другими? (Взаимодействие)
Опиши, как данный орган или система связаны с другими частями организма. Например, как поджелудочная железа связана с пищеварительной и эндокринной системами.

---
### Интересный факт
Один или два удивительных или малоизвестных факта об изучаемом органе/системе, чтобы сделать информацию более запоминающейся.

---
### Связанные заболевания (Общие понятия)
*   **Краткий перечень групп заболеваний**, связанных с этим органом (например, для печени: гепатиты, цирроз, жировая дистрофия).
*   **Важно:** *Не описывай симптомы!* Просто укажи, что нарушения в работе этого органа могут приводить к таким состояниям.
*   **Призыв к действию:** 'Для получения информации о возможных причинах симптомов, пожалуйста, воспользуйтесь разделом **'Консультант'** или обратитесь к врачу.'

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Эта информация предоставлена в образовательных целях и не предназначена для самодиагностики или лечения. При любых вопросах, касающихся вашего здоровья, обращайтесь к квалифицированному медицинскому работнику.`;
    const AI_SYSTEM_PROMPT_FIRST_AID = `Ты — 'AI-Спасатель', четкий, спокойный и надежный ассистент по оказанию первой помощи. Твоя задача — предоставить максимально ясную, пошаговую и безопасную инструкцию для экстренной ситуации до прибытия профессиональной медицинской помощи.

### **Ключевые принципы и ограничения (СТРОГО СОБЛЮДАТЬ):**
1.  **БЕЗОПАСНОСТЬ ПРЕВЫШЕ ВСЕГО:** Твой первый и главный приоритет — безопасность пострадавшего и того, кто оказывает помощь.
2.  **СРАЗУ О ГЛАВНОМ:** Если ситуация потенциально угрожает жизни (потеря сознания, сильное кровотечение, затрудненное дыхание, анафилаксия, инфаркт/инсульт), твой ответ ДОЛЖЕН начинаться с немедленного призыва вызвать скорую помощь (112 или 103).
3.  **НИКАКИХ ДИАГНОЗОВ И ЛЕКАРСТВ:** Ты не ставишь диагнозы и не назначаешь лекарства. Только общепринятые алгоритмы первой помощи.
4.  **ЧЕТКОСТЬ И ПРОСТОТА:** Используй простой язык, короткие предложения и нумерованные списки. Избегай сложных медицинских терминов.
5.  **Язык и формат:** Твой ответ ДОЛЖЕН быть ТОЛЬКО на русском языке. Никогда не включай в свой ответ внутренние размышления, мета-комментарии или план ответа. Генерируй только конечный, отформатированный Markdown-текст для пользователя.

### **Структура ответа (ОБЯЗАТЕЛЬНАЯ):**
Отвечай строго в формате Markdown по следующей структуре.

## Первая помощь при: [Краткое и понятное название ситуации]

### 1. Оценка опасности и вызов скорой помощи
*   **НЕМЕДЛЕННО ВЫЗОВИТЕ СКОРУЮ ПОМОЩЬ (112 или 103), если:**
    *   Человек без сознания или не дышит.
    *   Сильное, не останавливающееся кровотечение.
    *   Признаки инфаркта (давящая боль в груди) или инсульта (асимметрия лица, слабость в конечностях, невнятная речь).
    *   Тяжелый ожог (большая площадь, глубокое поражение).
    *   Подозревается перелом позвоночника или черепно-мозговая травма.
    *   Сильная аллергическая реакция (отек лица, горла, затрудненное дыхание).
*   **Оцените собственную безопасность:** убедитесь, что вам ничего не угрожает (огонь, электричество, агрессивные животные и т.д.), прежде чем оказывать помощь.

---
### 2. Пошаговая инструкция (Что делать ДО приезда помощи)
*Предоставь четкий, нумерованный список действий, специфичный для запроса пользователя (ожог, порез, удушье и т.д.).*
1.  **[Первый шаг]:** [Простое и ясное описание действия].
2.  **[Второй шаг]:** [Простое и ясное описание действия].
3.  **[Третий шаг]:** [Простое и ясное описание действия].
4.  ...

---
### 3. Что НЕЛЬЗЯ делать (!!!)
*Это критически важный раздел. Предоставь список распространенных ошибок, которые могут навредить.*
*   **[Запрет 1]:** [Например: Не смазывайте ожог маслом или сметаной].
*   **[Запрет 2]:** [Например: Не пытайтесь самостоятельно вправить вывих].
*   **[Запрет 3]:** [Например: Не извлекайте глубоко засевший в ране предмет].

---
### 4. Когда нужно обратиться к врачу (даже если стало лучше)
*   [Симптом или ситуация 1, требующая визита к врачу].
*   [Симптом или ситуация 2, требующая визита к врачу].

---
### 5. Полезные источники
*   [Статья о первой помощи от Красного Креста или ВОЗ](полная_ссылка) - краткое описание.
*   [Национальный портал здравоохранения](полная_ссылка) - краткое описание.

---
**ВАЖНЕЙШИЙ ДИСКЛЕЙМЕР:** Эта инструкция по оказанию первой помощи предоставлена ИИ и не заменяет профессионального медицинского обучения или консультации. В экстренной ситуации всегда отдавайте приоритет вызову скорой помощи. Неправильное оказание помощи может навредить!`;
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- Глобальные переменные и настройки ---
        const VERCEL_API_URL = "https://ver-olive-delta.vercel.app/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        let apiKey = null;
        let currentApiMode = 'vercel';
        let currentMode = null; 
        let modeStates = {};
        let lastOverlayClickTime = 0;

        // --- Элементы UI ---
        const queryInput = document.getElementById('user-query');
        const sendButton = document.getElementById('send-btn');
        const responseContainer = document.getElementById('ai-response');
        const responseActions = document.getElementById('response-actions');
        const copyButton = document.getElementById('copy-btn');
        const printButton = document.getElementById('print-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const apiModeToggle = document.getElementById('api-mode-toggle');
        const changeKeyBtn = document.getElementById('change-key-btn');
        const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        
        const modeConfigs = {
            'symptoms': { prompt: AI_SYSTEM_PROMPT_SYMPTOMS, placeholder: "Задайте вопрос или опишите симптомы...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-notes-medical"></i><h2>Здравствуйте!</h2><p>Опишите ваши симптомы для предварительного анализа.</p><p><em>Например: 'Сильная головная боль в висках'.</em></p></div>` },
            'medications': { prompt: AI_SYSTEM_PROMPT_MEDS, placeholder: "Введите название лекарства...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-pills"></i><h2>Справочник лекарств</h2><p>Введите название препарата для получения информации.</p><p><em>Например: 'Парацетамол'.</em></p></div>` },
            'substances': { prompt: AI_SYSTEM_PROMPT_SUBSTANCES, placeholder: "Введите название вещества (напр., Витамин D)...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-flask-vial"></i><h2>Справочник веществ</h2><p>Введите название витамина, минерала или вещества.</p><p><em>Например: 'Витамин C' или 'Магний'.</em></p></div>` },
            'lifestyle': { prompt: AI_SYSTEM_PROMPT_LIFESTYLE, placeholder: "Спросите про питание или упражнения...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-apple-whole"></i><h2>ЗОЖ и Питание</h2><p>Спросите о принципах правильного питания или упражнениях.</p><p><em>Например: 'идеи для полезного завтрака'.</em></p></div>` },
            'atlas': { prompt: AI_SYSTEM_PROMPT_ATLAS, placeholder: "Введите название органа или системы...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-person-dots-from-line"></i><h2>Анатомический атлас</h2><p>Введите название органа для изучения его строения и функций.</p><p><em>Например: 'как работает сердце?'.</em></p></div>` },
            'first-aid': { prompt: AI_SYSTEM_PROMPT_FIRST_AID, placeholder: "Опишите ситуацию (напр., ожог)...", welcomeHTML: `<div class="welcome-message"><i class="fa-solid fa-kit-medical"></i><h2>Первая помощь</h2><p>Опишите экстренную ситуацию для получения инструкции.</p><p><em>Например: 'ожог кипятком'.</em></p></div>` }
        };

        // --- Управление API ключом и режимом ---
        const showApiKeyModal = () => apiKeyModalOverlay.style.display = 'flex';
        const hideApiKeyModal = () => apiKeyModalOverlay.style.display = 'none';

        const saveApiKey = () => {
            const key = apiKeyInput.value.replace(/\s/g, ''); 
            if (key) {
                apiKey = key;
                localStorage.setItem('medGeminiApiKey', key);
                alert(`Ключ успешно сохранен:\n${key}`);
                hideApiKeyModal();
            } else {
                alert('Пожалуйста, введите действительный API ключ.');
            }
        };

        const loadApiKey = () => {
            const savedKey = localStorage.getItem('medGeminiApiKey');
            if (savedKey) {
                apiKey = savedKey;
                apiKeyInput.value = savedKey;
            }
        };

        const updateApiModeUI = () => {
            apiModeToggle.checked = currentApiMode === 'gemini';
            changeKeyBtn.style.display = currentApiMode === 'gemini' ? 'inline-block' : 'none';
        };

        const handleApiModeSwitch = () => {
            currentApiMode = apiModeToggle.checked ? 'gemini' : 'vercel';
            localStorage.setItem('medApiMode', currentApiMode);
            updateApiModeUI();
            if (currentApiMode === 'gemini' && !apiKey) {
                showApiKeyModal();
            }
        };
        
        // --- Инициализация приложения ---
        const initializeApp = () => {
            const renderer = new marked.Renderer();
            renderer.link = (href, title, text) => `<a href="${href}" title="${title}" target="_blank" rel="noopener noreferrer">${text}</a>`;
            marked.setOptions({ renderer });

            loadApiKey();
            currentApiMode = localStorage.getItem('medApiMode') || 'vercel';
            updateApiModeUI();

            for (const modeId in modeConfigs) {
                modeStates[modeId] = { conversationHistory: [], responseHTML: modeConfigs[modeId].welcomeHTML, isLoading: false, controller: null, hasNewResponse: false, lastFailedQuery: null, responseTime: null };
            }
            
            // Настройка обработчиков
            apiModeToggle.addEventListener('change', handleApiModeSwitch);
            changeKeyBtn.addEventListener('click', showApiKeyModal);

            ['click', 'touchstart'].forEach(evt => {
                saveApiKeyBtn.addEventListener(evt, (e) => {
                    e.preventDefault();
                    saveApiKey();
                });
            });
            apiKeyInput.addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKey(); });
            
            apiKeyModalOverlay.addEventListener('click', (e) => {
                if (e.target === apiKeyModalOverlay) {
                    const now = Date.now();
                    if (now - lastOverlayClickTime < 300) {
                        hideApiKeyModal();
                    }
                    lastOverlayClickTime = now;
                }
            });

            const handleSendButtonClick = () => handleRequest();
            sendButton.addEventListener('click', handleSendButtonClick);
            queryInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleRequest(); } });
            
            copyButton.addEventListener('click', copyResponse);
            printButton.addEventListener('click', printResponse);
            newChatBtn.addEventListener('click', startNewChat);
            
            modeButtons.forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));
            
            queryInput.addEventListener('input', () => {
                queryInput.style.height = 'auto';
                queryInput.style.height = `${Math.min(queryInput.scrollHeight, 150)}px`;
            });

            document.getElementById('response-wrapper').addEventListener('click', e => {
                const button = e.target.closest('button[data-action="retry"]');
                if (button) retryRequest(button.dataset.mode);
            });

            const savedMode = localStorage.getItem('medConsultantLastMode') || 'symptoms';
            switchMode(savedMode);
        };
        
        // --- Функции обновления UI ---
        const formatTime = (ms) => {
            if (!ms || ms < 1000) return `~1 сек`;
            const totalSeconds = Math.round(ms / 1000);
            if (totalSeconds < 60) {
                return `${totalSeconds} сек`;
            }
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} мин ${seconds} сек`;
        };

        const updateButtonIndicators = () => {
            modeButtons.forEach(btn => {
                const modeId = btn.dataset.mode;
                const state = modeStates[modeId];
                const timerEl = btn.querySelector('.response-timer');
                if (!state || !timerEl) return;
                
                if (state.isLoading) {
                    btn.classList.add('is-loading');
                    btn.classList.remove('has-new-response');
                    timerEl.style.display = 'none';
                } else if (state.hasNewResponse) {
                    btn.classList.remove('is-loading');
                    btn.classList.add('has-new-response');
                    timerEl.textContent = formatTime(state.responseTime);
                    timerEl.style.display = 'inline-block';
                } else {
                    btn.classList.remove('is-loading', 'has-new-response');
                    timerEl.style.display = 'none';
                }
            });
        };

        const updateUIForCurrentMode = () => {
            if (!currentMode || !modeStates[currentMode]) return;
            const state = modeStates[currentMode];
            responseContainer.innerHTML = state.responseHTML;
            document.getElementById('response-wrapper').scrollTop = 0;
            responseActions.style.display = !state.isLoading && state.conversationHistory.length > 0 ? 'flex' : 'none';
            queryInput.placeholder = modeConfigs[currentMode].placeholder;
            state.hasNewResponse = false;
            updateButtonIndicators();
            const cancelButton = document.getElementById('cancel-btn');
            if (cancelButton) cancelButton.addEventListener('click', cancelCurrentRequest);
        };
        
        // --- Генерация HTML ---
        const getLoaderHTML = () => `
            <div class="loader">
                <div class="lds-heart"><div></div></div>
                <p>Анализирую информацию...<br>Это может занять некоторое время.</p>
                <button id="cancel-btn">Отменить</button>
            </div>`;

        const getFriendlyErrorHTML = (errorMsg, isKeyError = false, failedKey = null) => {
            let keyInfo = '';
            if (isKeyError && failedKey) {
                const maskedKey = `${failedKey.substring(0, 4)}...${failedKey.slice(-4)}`;
                keyInfo = `<p style="margin-top:10px;"><small>Ключ, с которым произошла ошибка: ${maskedKey}</small></p>`;
            }
            let detailedErrorMsg = errorMsg;
            if (isKeyError) {
                detailedErrorMsg += "<br><strong>Убедитесь, что в нем нет лишних пробелов или символов.</strong>";
            }
            return `<div class="welcome-message" style="color: var(--danger-color);"><i class="fa-solid fa-triangle-exclamation fa-2x"></i><h3 style="color: var(--danger-color); border: none; margin-top:15px;">Ой, что-то пошло не так...</h3><p>${detailedErrorMsg}</p>${keyInfo}${isKeyError ? `<button class="action-btn" onclick="document.getElementById('change-key-btn').click()" style="background-color: var(--new-chat-color); margin-top: 20px;"><i class="fa-solid fa-key"></i> Сменить API ключ</button>` : `<button class="action-btn" data-action="retry" data-mode="${currentMode}" style="background-color: var(--primary-color); margin-top: 20px;"><i class="fa-solid fa-rotate-right"></i> Повторить запрос</button>`}</div>`;
        };
        
        // --- Основная логика запроса ---
        const retryRequest = (modeId) => {
            const state = modeStates[modeId];
            if (state?.lastFailedQuery) handleRequest(state.lastFailedQuery, modeId);
        };
      
        const handleRequest = async (queryOverride = null, modeOverride = null) => {
            if (currentApiMode === 'gemini' && !apiKey) {
                showApiKeyModal();
                return;
            }

            const userQuery = queryOverride || queryInput.value.trim();
            if (!userQuery) return;

            const modeToSend = modeOverride || currentMode;
            const state = modeStates[modeToSend];
            
            if (!queryOverride) {
                queryInput.value = '';
                queryInput.style.height = '24px';
            }
            
            state.lastFailedQuery = null;
            if (state.isLoading) return;

            const startTime = performance.now(); 
            state.isLoading = true;
            state.controller = new AbortController();
            state.conversationHistory.push({ role: 'user', parts: [{ text: userQuery }] });
            
            if (currentMode === modeToSend) {
                state.responseHTML = getLoaderHTML();
                updateUIForCurrentMode();
            } else {
                updateButtonIndicators();
            }

            const requestBody = {
                contents: state.conversationHistory, 
                systemInstruction: { parts: [{ text: modeConfigs[modeToSend].prompt }] }
            };

            const apiUrl = currentApiMode === 'gemini' 
                ? `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`
                : VERCEL_API_URL;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: new Headers({
                        'Content-Type': 'application/json'
                    }),
                    body: JSON.stringify(requestBody),
                    signal: state.controller.signal
                });
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    const errorMessage = errorBody.error?.message || `HTTP error! status: ${response.status}`;
                    if (response.status === 400 || response.status === 403) {
                         throw new Error(`Ошибка запроса (${response.status}). Проверьте API-ключ и ограничения. Детали: ${errorMessage}`);
                    }
                    throw new Error(errorMessage);
                }
                
                const geminiData = await response.json();
                if (!geminiData.candidates || geminiData.candidates.length === 0 || !geminiData.candidates[0].content) {
                    const reason = geminiData.promptFeedback?.blockReason || 'Ответ был заблокирован моделью.';
                    throw new Error(`Не удалось сгенерировать ответ. Причина: ${reason}`);
                }
                
                const endTime = performance.now();
                const aiResponseText = geminiData.candidates[0].content.parts[0].text;
                
                state.responseTime = endTime - startTime;
                state.conversationHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                state.responseHTML = marked.parse(aiResponseText);
                
                if (currentMode !== modeToSend) {
                    state.hasNewResponse = true;
                }

            } catch (error) {
                state.conversationHistory.pop();
                console.error(`Ошибка в режиме ${modeToSend}:`, error); 
                
                if (error.name === 'AbortError') {
                    state.responseHTML = getLoaderHTML('Запрос был отменен пользователем.');
                } else if (error.message.includes("Ошибка запроса")) {
                    state.lastFailedQuery = userQuery;
                    state.responseHTML = getFriendlyErrorHTML(error.message, true, apiKey);
                } else {
                    state.lastFailedQuery = userQuery;
                    state.responseHTML = getFriendlyErrorHTML(`Произошла ошибка: ${error.message}`);
                }
            } finally {
                state.isLoading = false;
                state.controller = null;
                if (currentMode === modeToSend) {
                    updateUIForCurrentMode();
                }
                updateButtonIndicators();
            }
        };
        
        // --- Управление состоянием чата ---
        const startNewChat = () => {
            if (!currentMode) return;
            const state = modeStates[currentMode];
            if (state.isLoading && state.controller) state.controller.abort();
            Object.assign(state, {
                conversationHistory: [],
                responseHTML: modeConfigs[currentMode].welcomeHTML,
                isLoading: false,
                hasNewResponse: false,
                lastFailedQuery: null,
                responseTime: null
            });
            updateUIForCurrentMode();
        };

        const switchMode = (newMode) => {
            if (currentMode === newMode && !modeStates[newMode]?.hasNewResponse) return;
            currentMode = newMode;
            localStorage.setItem('medConsultantLastMode', newMode);
            modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === newMode));
            updateUIForCurrentMode();
        };
        
        const cancelCurrentRequest = () => {
            const state = modeStates[currentMode];
            if (state?.isLoading && state.controller) state.controller.abort();
        };

        const copyResponse = () => navigator.clipboard.writeText(responseContainer.innerText).then(() => alert('Текст скопирован.')).catch(err => console.error(err));
        const printResponse = () => window.print();

        // Запуск!
        initializeApp();
    });
</script>
</body>
</html>
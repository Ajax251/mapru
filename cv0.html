<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер Координат (Vercel)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 20px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: auto; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #343a40; }
        label { display: block; margin-top: 20px; font-weight: bold; }
        textarea, input[type="text"], select { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; }
        textarea { height: 220px; resize: vertical; font-family: monospace; }
        button { display: block; width: 100%; padding: 12px; margin-top: 25px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #result-area { margin-top: 10px; background-color: #e9ecef; color: #495057; height: 220px; font-family: monospace; }
        .error { color: #dc3545; border-color: #dc3545; }
        .custom-input { display: none; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Конвертер координат через Vercel</h1>

        <label for="sourceText">Исходные координаты:</label>
        <!-- *** ИЗМЕНЕНИЕ: Удалены координаты по умолчанию *** -->
        <textarea id="sourceText" placeholder="Вставьте сюда координаты..."></textarea>

        <label for="sourceScSelect">Исходная система координат (СК):</label>
        <select id="sourceScSelect">
            <option value="EPSG:6331601" selected>Татарстан МСК-16 зона 1</option>
            <option value="EPSG:6331602">Татарстан МСК-16 зона 2</option>
            <option value="EPSG:6336302">МСК-63 зона 2 (Самарская обл.)</option>
            <option value="custom">Другая (ввести вручную)</option>
        </select>
        <input type="text" id="sourceScInput" class="custom-input" placeholder="Введите код EPSG, например, EPSG:4326">
        
        <label for="destScSelect">Целевая система координат (СК):</label>
        <select id="destScSelect">
            <option value="EPSG:3857" selected>Web Mercator (EPSG:3857)</option>
            <option value="EPSG:4326">WGS 84 (широта/долгота)</option>
            <option value="custom">Другая (ввести вручную)</option>
        </select>
        <input type="text" id="destScInput" class="custom-input" placeholder="Введите код EPSG">

        <button id="convertBtn">Конвертировать</button>

        <h2>Результат:</h2>
        <textarea id="result-area" readonly>Здесь будет результат...</textarea>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const convertBtn = document.getElementById('convertBtn');
            const sourceTextArea = document.getElementById('sourceText');
            const resultArea = document.getElementById('result-area');
            
            const sourceScSelect = document.getElementById('sourceScSelect');
            const sourceScInput = document.getElementById('sourceScInput');
            const destScSelect = document.getElementById('destScSelect');
            const destScInput = document.getElementById('destScInput');

            function toggleCustomInput(selectElement, inputElement) {
                if (selectElement.value === 'custom') {
                    inputElement.style.display = 'block';
                } else {
                    inputElement.style.display = 'none';
                }
            }

            sourceScSelect.addEventListener('change', () => toggleCustomInput(sourceScSelect, sourceScInput));
            destScSelect.addEventListener('change', () => toggleCustomInput(destScSelect, destScInput));

            convertBtn.addEventListener('click', async () => {
                function getScValue(selectElement, inputElement) {
                    return selectElement.value === 'custom' 
                        ? inputElement.value.trim() 
                        : selectElement.value;
                }

                const sourceText = sourceTextArea.value.trim();
                const sourceSc = getScValue(sourceScSelect, sourceScInput);
                const destSc = getScValue(destScSelect, destScInput);

                if (!sourceText || !sourceSc || !destSc) {
                    resultArea.value = 'Ошибка: Все поля должны быть заполнены.';
                    resultArea.classList.add('error');
                    return;
                }

                resultArea.value = 'Обработка запроса...';
                resultArea.classList.remove('error');

                try {
                    // Указан полный URL вашего API на Vercel
                    const response = await fetch('https://cc-psi-livid.vercel.app/api/convert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sourceText, sourceSc, destSc })
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || `Сервер вернул ошибку ${response.status}`);
                    }
                    
                    if (result.error && result.error.length > 0) {
                        resultArea.value = `Ошибка от polygon.top: ${result.error}`;
                        resultArea.classList.add('error');
                    } else if (result.destText) {
                        resultArea.value = result.destText.replace(/\r/g, '');
                    } else {
                        resultArea.value = "Не удалось найти отформатированный текст. Полный ответ:\n\n" + JSON.stringify(result, null, 2);
                    }

                } catch (error) {
                    resultArea.value = `Произошла ошибка: ${error.message}`;
                    resultArea.classList.add('error');
                }
            });
        });
    </script>

</body>
</html>
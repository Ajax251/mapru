<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–∞–ª–∞–∫—Ç–∏–∫–∞ –ê–Ω–¥—Ä–æ–º–µ–¥–∞ (M31)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        canvas {
            display: block;
        }

        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 5, 15, 0.85);
            padding: 20px;
            border-radius: 12px;
            color: #b8d4ff;
            border: 1px solid rgba(100, 150, 255, 0.15);
            max-width: 280px;
            backdrop-filter: blur(10px);
        }

        .info-panel h1 {
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 5px;
            color: #e0edff;
        }

        .info-panel .subtitle {
            font-size: 11px;
            color: #6a8cba;
            margin-bottom: 15px;
        }

        .info-panel .stat {
            font-size: 11px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .info-panel .stat-label {
            color: #6a8cba;
        }

        .info-panel .stat-value {
            color: #a0c8ff;
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 5, 15, 0.9);
            padding: 20px;
            border-radius: 12px;
            color: #fff;
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(100, 150, 255, 0.15);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .controls.hidden {
            transform: translateX(320px);
        }

        .toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 10, 25, 0.9);
            color: #a0c8ff;
            border: 1px solid rgba(100, 150, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            z-index: 100;
        }

        .section-title {
            color: #7ea8d8;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 15px 0 12px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(100, 150, 255, 0.1);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .control-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 11px;
            color: #8ab4d8;
        }

        .value-display {
            float: right;
            color: #a0d0ff;
            font-size: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, #0a1525, #1a3555);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a0d0ff, #3070a0);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(100, 180, 255, 0.5);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4a90d0;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(100, 150, 255, 0.15);
            background: rgba(0, 15, 35, 0.9);
            color: #c0d8f0;
            font-size: 12px;
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #153050, #1a4070);
            color: #c0d8f0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: linear-gradient(135deg, #1a4060, #2050880);
            box-shadow: 0 0 15px rgba(50, 120, 200, 0.3);
        }

        .instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 5, 15, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            color: #6a8cba;
            font-size: 11px;
            border: 1px solid rgba(100, 150, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 20, 40, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(80, 140, 200, 0.3);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="info-panel">
        <h1>–ê–ù–î–†–û–ú–ï–î–ê</h1>
        <div class="subtitle">Messier 31 ‚Ä¢ NGC 224</div>
        <div class="stat">
            <span class="stat-label">–¢–∏–ø:</span>
            <span class="stat-value">SA(s)b - –°–ø–∏—Ä–∞–ª—å–Ω–∞—è</span>
        </div>
        <div class="stat">
            <span class="stat-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</span>
            <span class="stat-value">2.537 –º–ª–Ω —Å–≤–µ—Ç–æ–≤—ã—Ö –ª–µ—Ç</span>
        </div>
        <div class="stat">
            <span class="stat-label">–î–∏–∞–º–µ—Ç—Ä:</span>
            <span class="stat-value">~220 000 —Å–≤. –ª–µ—Ç</span>
        </div>
        <div class="stat">
            <span class="stat-label">–ó–≤—ë–∑–¥:</span>
            <span class="stat-value">~1 —Ç—Ä–∏–ª–ª–∏–æ–Ω</span>
        </div>
        <div class="stat">
            <span class="stat-label">–ú–∞—Å—Å–∞:</span>
            <span class="stat-value">1.5 √ó 10¬π¬≤ M‚òâ</span>
        </div>
        <div class="stat">
            <span class="stat-label">–°–ø—É—Ç–Ω–∏–∫–∏:</span>
            <span class="stat-value">M32, M110 –∏ –¥—Ä—É–≥–∏–µ</span>
        </div>
    </div>

    <button class="toggle-btn" id="toggleBtn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    
    <div class="controls" id="controls">
        <div class="section-title">–û–±–∑–æ—Ä</div>
        
        <div class="control-group">
            <label>–ú–∞—Å—à—Ç–∞–± <span class="value-display" id="zoomVal">1.0</span></label>
            <input type="range" id="zoom" min="0.3" max="3" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>–ù–∞–∫–ª–æ–Ω (¬∞) <span class="value-display" id="tiltVal">77</span></label>
            <input type="range" id="tilt" min="0" max="90" step="1" value="77">
        </div>
        
        <div class="control-group">
            <label>–ü–æ–≤–æ—Ä–æ—Ç (¬∞) <span class="value-display" id="rotationVal">35</span></label>
            <input type="range" id="rotation" min="0" max="360" step="1" value="35">
        </div>
        
        <div class="section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–∞–ª–∞–∫—Ç–∏–∫–∏</div>
        
        <div class="control-group">
            <label>–ó–≤—ë–∑–¥ –≤ –¥–∏—Å–∫–µ <span class="value-display" id="diskStarsVal">80000</span></label>
            <input type="range" id="diskStars" min="10000" max="200000" step="5000" value="80000">
        </div>
        
        <div class="control-group">
            <label>–ó–≤—ë–∑–¥ –≤ –±–∞–ª–¥–∂–µ <span class="value-display" id="bulgeStarsVal">25000</span></label>
            <input type="range" id="bulgeStars" min="5000" max="60000" step="1000" value="25000">
        </div>
        
        <div class="control-group">
            <label>–ó–≤—ë–∑–¥ –≤ –≥–∞–ª–æ <span class="value-display" id="haloStarsVal">8000</span></label>
            <input type="range" id="haloStars" min="1000" max="20000" step="500" value="8000">
        </div>
        
        <div class="control-group">
            <label>–ó–∞–∫—Ä—É—á–µ–Ω–Ω–æ—Å—Ç—å —Å–ø–∏—Ä–∞–ª–µ–π <span class="value-display" id="spiralWindingVal">2.5</span></label>
            <input type="range" id="spiralWinding" min="1" max="5" step="0.1" value="2.5">
        </div>
        
        <div class="control-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–∫–∞–≤–æ–≤ <span class="value-display" id="spiralArmsVal">2</span></label>
            <input type="range" id="spiralArms" min="2" max="6" step="1" value="2">
        </div>
        
        <div class="control-group">
            <label>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä—É–∫–∞–≤–æ–≤ <span class="value-display" id="armDensityVal">0.7</span></label>
            <input type="range" id="armDensity" min="0.3" max="1" step="0.05" value="0.7">
        </div>
        
        <div class="section-title">–Ø–¥—Ä–æ –∏ –±–∞–ª–¥–∂</div>
        
        <div class="control-group">
            <label>–†–∞–∑–º–µ—Ä –±–∞–ª–¥–∂–∞ <span class="value-display" id="bulgeSizeVal">0.15</span></label>
            <input type="range" id="bulgeSize" min="0.05" max="0.3" step="0.01" value="0.15">
        </div>
        
        <div class="control-group">
            <label>–Ø—Ä–∫–æ—Å—Ç—å —è–¥—Ä–∞ <span class="value-display" id="coreBrightnessVal">1.0</span></label>
            <input type="range" id="coreBrightness" min="0.3" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>–†–∞–∑–º–µ—Ä —è–¥—Ä–∞ <span class="value-display" id="coreSizeVal">0.03</span></label>
            <input type="range" id="coreSize" min="0.01" max="0.08" step="0.005" value="0.03">
        </div>
        
        <div class="section-title">–ü—ã–ª–µ–≤—ã–µ –ø–æ–ª–æ—Å—ã</div>
        
        <div class="control-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—ã–ª–∏ <span class="value-display" id="dustAmountVal">15000</span></label>
            <input type="range" id="dustAmount" min="0" max="40000" step="1000" value="15000">
        </div>
        
        <div class="control-group">
            <label>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –ø—ã–ª–∏ <span class="value-display" id="dustDensityVal">0.6</span></label>
            <input type="range" id="dustDensity" min="0.2" max="1" step="0.05" value="0.6">
        </div>
        
        <div class="section-title">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</div>
        
        <div class="control-group">
            <label>–†–∞–∑–º–µ—Ä –∑–≤—ë–∑–¥ <span class="value-display" id="starSizeVal">1.0</span></label>
            <input type="range" id="starSize" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>–Ø—Ä–∫–æ—Å—Ç—å <span class="value-display" id="brightnessVal">1.0</span></label>
            <input type="range" id="brightness" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>–°–≤–µ—á–µ–Ω–∏–µ <span class="value-display" id="glowVal">1.0</span></label>
            <input type="range" id="glow" min="0" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–∞ <span class="value-display" id="saturationVal">1.0</span></label>
            <input type="range" id="saturation" min="0" max="2" step="0.1" value="1">
        </div>
        
        <div class="section-title">–≠–ª–µ–º–µ–Ω—Ç—ã</div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="showDust" checked>
            <label for="showDust">–ü—ã–ª–µ–≤—ã–µ –ø–æ–ª–æ—Å—ã</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="showHalo" checked>
            <label for="showHalo">–ó–≤—ë–∑–¥–Ω–æ–µ –≥–∞–ª–æ</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="showClusters" checked>
            <label for="showClusters">–®–∞—Ä–æ–≤—ã–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="showSatellites" checked>
            <label for="showSatellites">–ì–∞–ª–∞–∫—Ç–∏–∫–∏-—Å–ø—É—Ç–Ω–∏–∫–∏</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="showNebulae" checked>
            <label for="showNebulae">–û–±–ª–∞—Å—Ç–∏ –∑–≤–µ–∑–¥–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</label>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="autoRotate">
            <label for="autoRotate">–ê–≤—Ç–æ–≤—Ä–∞—â–µ–Ω–∏–µ</label>
        </div>
        
        <div class="section-title">–ê–Ω–∏–º–∞—Ü–∏—è</div>
        
        <div class="control-group">
            <label>–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è <span class="value-display" id="rotationSpeedVal">0.02</span></label>
            <input type="range" id="rotationSpeed" min="0" max="0.1" step="0.005" value="0.02">
        </div>
        
        <div class="section-title">–ü—Ä–µ—Å–µ—Ç—ã</div>
        
        <div class="control-group">
            <select id="presets">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç...</option>
                <option value="realistic">–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≤–∏–¥</option>
                <option value="faceon">–í–∏–¥ —Å–≤–µ—Ä—Ö—É (Face-on)</option>
                <option value="edgeon">–í–∏–¥ —Å —Ä–µ–±—Ä–∞ (Edge-on)</option>
                <option value="hubble">–°—Ç–∏–ª—å –•–∞–±–±–ª</option>
                <option value="infrared">–ò–Ω—Ñ—Ä–∞–∫—Ä–∞—Å–Ω—ã–π</option>
                <option value="artistic">–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π</option>
            </select>
        </div>
        
        <button onclick="regenerateGalaxy()">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="resetToDefault()">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="instructions">
        üñ± –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ: –≤—Ä–∞—â–µ–Ω–∏–µ ‚Ä¢ –ö–æ–ª—ë—Å–∏–∫–æ: –º–∞—Å—à—Ç–∞–± ‚Ä¢ –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫: —Å–±—Ä–æ—Å –≤–∏–¥–∞
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height, centerX, centerY;
        
        // –î–∞–Ω–Ω—ã–µ –≥–∞–ª–∞–∫—Ç–∏–∫–∏
        let diskStars = [];
        let bulgeStars = [];
        let haloStars = [];
        let dustParticles = [];
        let globularClusters = [];
        let starFormingRegions = [];
        let satellites = [];
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–æ–º
        let viewTilt = 77 * Math.PI / 180;  // –†–µ–∞–ª—å–Ω—ã–π –Ω–∞–∫–ª–æ–Ω –ê–Ω–¥—Ä–æ–º–µ–¥—ã ~77¬∞
        let viewRotation = 35 * Math.PI / 180;
        let viewZoom = 1;
        let isDragging = false;
        let lastMouseX, lastMouseY;
        let autoRotateAngle = 0;
        
        const settings = {
            zoom: 1,
            tilt: 77,
            rotation: 35,
            diskStars: 80000,
            bulgeStars: 25000,
            haloStars: 8000,
            spiralWinding: 2.5,
            spiralArms: 2,
            armDensity: 0.7,
            bulgeSize: 0.15,
            coreBrightness: 1,
            coreSize: 0.03,
            dustAmount: 15000,
            dustDensity: 0.6,
            starSize: 1,
            brightness: 1,
            glow: 1,
            saturation: 1,
            showDust: true,
            showHalo: true,
            showClusters: true,
            showSatellites: true,
            showNebulae: true,
            autoRotate: false,
            rotationSpeed: 0.02
        };
        
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
        }
        
        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–≤—ë–∑–¥ –ø–æ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –∑–∞–∫–æ–Ω—É
        function exponentialRadius(scale) {
            return -scale * Math.log(1 - Math.random() * 0.9999);
        }
        
        // –ì–∞—É—Å—Å–æ–≤–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        function gaussian(mean, std) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        
        // –¶–≤–µ—Ç –∑–≤–µ–∑–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–µ –≤ —Ü–µ–Ω—Ç—Ä–µ, –º–æ–ª–æ–¥—ã–µ –≤ —Ä—É–∫–∞–≤–∞—Ö)
        function getStarColor(radius, isArm, isBulge) {
            const satMult = settings.saturation;
            
            if (isBulge) {
                // –°—Ç–∞—Ä—ã–µ –∫—Ä–∞—Å–Ω–æ–≤–∞—Ç—ã–µ/–∂–µ–ª—Ç–æ–≤–∞—Ç—ã–µ –∑–≤—ë–∑–¥—ã –≤ –±–∞–ª–¥–∂–µ
                const temp = 3500 + Math.random() * 2000;
                return temperatureToColor(temp, satMult);
            }
            
            if (isArm && radius > 0.2) {
                // –ú–æ–ª–æ–¥—ã–µ –≥–æ–ª—É–±—ã–µ –∑–≤—ë–∑–¥—ã –≤ —Ä—É–∫–∞–≤–∞—Ö
                if (Math.random() < 0.3) {
                    const temp = 8000 + Math.random() * 20000;
                    return temperatureToColor(temp, satMult);
                }
            }
            
            // –°–º–µ—à–∞–Ω–Ω–∞—è –ø–æ–ø—É–ª—è—Ü–∏—è
            const temp = 3000 + Math.random() * 7000;
            return temperatureToColor(temp, satMult);
        }
        
        function temperatureToColor(temp, satMult = 1) {
            let r, g, b;
            
            // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –ü–ª–∞–Ω–∫–∞ –¥–ª—è —Ü–≤–µ—Ç–∞ –∑–≤–µ–∑–¥—ã
            if (temp < 4000) {
                r = 255;
                g = Math.min(255, 100 + (temp - 2000) * 0.08);
                b = Math.min(255, Math.max(0, (temp - 3000) * 0.15));
            } else if (temp < 6000) {
                r = 255;
                g = Math.min(255, 180 + (temp - 4000) * 0.035);
                b = Math.min(255, 150 + (temp - 4000) * 0.05);
            } else if (temp < 8000) {
                r = Math.max(200, 255 - (temp - 6000) * 0.02);
                g = Math.max(210, 255 - (temp - 6000) * 0.015);
                b = 255;
            } else {
                r = Math.max(150, 220 - (temp - 8000) * 0.003);
                g = Math.max(180, 230 - (temp - 8000) * 0.002);
                b = 255;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
            const gray = (r + g + b) / 3;
            r = gray + (r - gray) * satMult;
            g = gray + (g - gray) * satMult;
            b = gray + (b - gray) * satMult;
            
            return { r: Math.round(r), g: Math.round(g), b: Math.round(b) };
        }
        
        function generateDiskStar() {
            const radius = exponentialRadius(0.35);
            if (radius > 1.2) return null;
            
            const arms = settings.spiralArms;
            const winding = settings.spiralWinding;
            const armWidth = 0.15 / settings.armDensity;
            
            // –°–ø–∏—Ä–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            let angle = Math.random() * Math.PI * 2;
            const armIndex = Math.floor(Math.random() * arms);
            const baseArmAngle = (armIndex / arms) * Math.PI * 2;
            const spiralAngle = baseArmAngle + radius * winding * Math.PI;
            
            // –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –ø–æ–º–µ—â–∞–µ–º –∑–≤–µ–∑–¥—É –≤ —Ä—É–∫–∞–≤
            const inArm = Math.random() < settings.armDensity * 0.8;
            
            if (inArm) {
                angle = spiralAngle + gaussian(0, armWidth * (1 + radius));
            }
            
            // –¢–æ–ª—â–∏–Ω–∞ –¥–∏—Å–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∫ –∫—Ä–∞—è–º
            const diskThickness = 0.02 + radius * 0.03;
            const z = gaussian(0, diskThickness);
            
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            
            const color = getStarColor(radius, inArm, false);
            const size = 0.3 + Math.random() * 1.2 * (1 - radius * 0.5);
            const brightness = 0.4 + Math.random() * 0.6;
            
            return { x, y, z, color, size, brightness, inArm };
        }
        
        function generateBulgeStar() {
            // –°—Ñ–µ—Ä–æ–∏–¥–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –±–∞–ª–¥–∂–∞
            const radius = exponentialRadius(settings.bulgeSize) * 0.8;
            if (radius > settings.bulgeSize * 3) return null;
            
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            
            // –°–ª–µ–≥–∫–∞ —Å–ø–ª—é—Å–Ω—É—Ç—ã–π —Å—Ñ–µ—Ä–æ–∏–¥
            const flatness = 0.7;
            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi) * Math.sin(theta);
            const z = radius * Math.cos(phi) * flatness;
            
            const color = getStarColor(radius, false, true);
            const size = 0.4 + Math.random() * 1.0;
            const brightness = 0.5 + Math.random() * 0.5;
            
            return { x, y, z, color, size, brightness, inArm: false };
        }
        
        function generateHaloStar() {
            // –°—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–µ –≥–∞–ª–æ
            const radius = 0.2 + exponentialRadius(0.5);
            if (radius > 1.5) return null;
            
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            
            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi) * Math.sin(theta);
            const z = radius * Math.cos(phi);
            
            // –°—Ç–∞—Ä—ã–µ –∫—Ä–∞—Å–Ω—ã–µ –∑–≤—ë–∑–¥—ã –≤ –≥–∞–ª–æ
            const color = temperatureToColor(3500 + Math.random() * 1500, settings.saturation);
            const size = 0.2 + Math.random() * 0.6;
            const brightness = 0.2 + Math.random() * 0.4;
            
            return { x, y, z, color, size, brightness, inArm: false };
        }
        
        function generateDustParticle() {
            const radius = 0.05 + exponentialRadius(0.3) * 0.8;
            if (radius > 0.8) return null;
            
            const arms = settings.spiralArms;
            const winding = settings.spiralWinding;
            
            // –ü—ã–ª—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Å–ø–∏—Ä–∞–ª—å–Ω—ã—Ö —Ä—É–∫–∞–≤–∞—Ö
            const armIndex = Math.floor(Math.random() * arms);
            const baseArmAngle = (armIndex / arms) * Math.PI * 2;
            const spiralAngle = baseArmAngle + radius * winding * Math.PI;
            const angle = spiralAngle + gaussian(0, 0.1);
            
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            const z = gaussian(0, 0.005);
            
            const size = 1 + Math.random() * 3;
            const opacity = 0.3 + Math.random() * 0.4;
            
            return { x, y, z, size, opacity };
        }
        
        function generateGlobularCluster() {
            // –®–∞—Ä–æ–≤—ã–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è –≤ –≥–∞–ª–æ
            const radius = 0.15 + Math.random() * 0.8;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            
            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi) * Math.sin(theta);
            const z = radius * Math.cos(phi) * 0.6;
            
            return {
                x, y, z,
                size: 3 + Math.random() * 5,
                stars: 20 + Math.floor(Math.random() * 30)
            };
        }
        
        function generateStarFormingRegion() {
            // –û–±–ª–∞—Å—Ç–∏ –∑–≤–µ–∑–¥–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ø–∏—Ä–∞–ª—å–Ω—ã—Ö —Ä—É–∫–∞–≤–∞—Ö
            const radius = 0.15 + Math.random() * 0.5;
            const armIndex = Math.floor(Math.random() * settings.spiralArms);
            const baseArmAngle = (armIndex / settings.spiralArms) * Math.PI * 2;
            const spiralAngle = baseArmAngle + radius * settings.spiralWinding * Math.PI;
            const angle = spiralAngle + gaussian(0, 0.08);
            
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            const z = gaussian(0, 0.01);
            
            // –†–æ–∑–æ–≤—ã–µ/–∫—Ä–∞—Å–Ω—ã–µ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ (H-alpha)
            const colors = [
                { r: 255, g: 100, b: 150 },
                { r: 255, g: 150, b: 180 },
                { r: 200, g: 150, b: 255 },
                { r: 150, g: 200, b: 255 }
            ];
            
            return {
                x, y, z,
                size: 5 + Math.random() * 15,
                color: colors[Math.floor(Math.random() * colors.length)],
                opacity: 0.15 + Math.random() * 0.25
            };
        }
        
        function generateSatellites() {
            // M32 - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∞—è –≥–∞–ª–∞–∫—Ç–∏–∫–∞
            const m32 = {
                name: 'M32',
                x: 0.15,
                y: -0.35,
                z: 0.05,
                size: 25,
                stars: 800,
                color: { r: 255, g: 240, b: 220 },
                type: 'elliptical'
            };
            
            // M110 - —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∞—è –≥–∞–ª–∞–∫—Ç–∏–∫–∞
            const m110 = {
                name: 'M110',
                x: -0.4,
                y: 0.35,
                z: -0.08,
                size: 35,
                stars: 600,
                color: { r: 240, g: 235, b: 255 },
                type: 'elliptical'
            };
            
            return [m32, m110];
        }
        
        function generateGalaxy() {
            diskStars = [];
            bulgeStars = [];
            haloStars = [];
            dustParticles = [];
            globularClusters = [];
            starFormingRegions = [];
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—ë–∑–¥ –¥–∏—Å–∫–∞
            for (let i = 0; i < settings.diskStars; i++) {
                const star = generateDiskStar();
                if (star) diskStars.push(star);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—ë–∑–¥ –±–∞–ª–¥–∂–∞
            for (let i = 0; i < settings.bulgeStars; i++) {
                const star = generateBulgeStar();
                if (star) bulgeStars.push(star);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—ë–∑–¥ –≥–∞–ª–æ
            for (let i = 0; i < settings.haloStars; i++) {
                const star = generateHaloStar();
                if (star) haloStars.push(star);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—ã–ª–∏
            for (let i = 0; i < settings.dustAmount; i++) {
                const dust = generateDustParticle();
                if (dust) dustParticles.push(dust);
            }
            
            // –®–∞—Ä–æ–≤—ã–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è
            for (let i = 0; i < 50; i++) {
                globularClusters.push(generateGlobularCluster());
            }
            
            // –û–±–ª–∞—Å—Ç–∏ –∑–≤–µ–∑–¥–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            for (let i = 0; i < 40; i++) {
                starFormingRegions.push(generateStarFormingRegion());
            }
            
            // –°–ø—É—Ç–Ω–∏–∫–∏
            satellites = generateSatellites();
        }
        
        function project(x, y, z) {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –æ—Å–∏ Z
            const cosR = Math.cos(viewRotation);
            const sinR = Math.sin(viewRotation);
            let x1 = x * cosR - y * sinR;
            let y1 = x * sinR + y * cosR;
            let z1 = z;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–∫–ª–æ–Ω (–≤—Ä–∞—â–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –æ—Å–∏ X)
            const cosT = Math.cos(viewTilt);
            const sinT = Math.sin(viewTilt);
            let y2 = y1 * cosT - z1 * sinT;
            let z2 = y1 * sinT + z1 * cosT;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            const scale = Math.min(width, height) * 0.4 * viewZoom;
            
            return {
                x: centerX + x1 * scale,
                y: centerY + y2 * scale,
                z: z2
            };
        }
        
        function drawStar(star, baseAlpha = 1) {
            const proj = project(star.x, star.y, star.z);
            
            // –û—Ç—Å–µ—á–µ–Ω–∏–µ –ø–æ –≥–ª—É–±–∏–Ω–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è 3D —ç—Ñ—Ñ–µ–∫—Ç–∞
            const depthFade = Math.max(0.2, 1 - Math.abs(proj.z) * 0.5);
            const alpha = star.brightness * depthFade * settings.brightness * baseAlpha;
            
            if (alpha < 0.05) return;
            
            const size = star.size * settings.starSize * (0.8 + depthFade * 0.4);
            
            const { r, g, b } = star.color;
            
            if (settings.glow > 0.3 && size > 0.8) {
                // –°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è —è—Ä–∫–∏—Ö –∑–≤—ë–∑–¥
                const gradient = ctx.createRadialGradient(
                    proj.x, proj.y, 0,
                    proj.x, proj.y, size * 3 * settings.glow
                );
                gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, ${alpha * 0.8})`);
                gradient.addColorStop(0.3, `rgba(${r}, ${g}, ${b}, ${alpha * 0.2})`);
                gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, size * 3 * settings.glow, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –Ø–¥—Ä–æ –∑–≤–µ–∑–¥—ã
            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${Math.min(1, alpha * 1.5)})`;
            ctx.beginPath();
            ctx.arc(proj.x, proj.y, Math.max(0.3, size), 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawDust(dust) {
            const proj = project(dust.x, dust.y, dust.z);
            
            // –ü—ã–ª—å –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É–≥–ª–æ–≤
            const depthFade = Math.max(0, 1 - Math.abs(proj.z) * 2);
            if (depthFade < 0.1) return;
            
            const alpha = dust.opacity * settings.dustDensity * depthFade * 0.7;
            const size = dust.size * settings.starSize * 2;
            
            ctx.fillStyle = `rgba(10, 5, 0, ${alpha})`;
            ctx.beginPath();
            ctx.arc(proj.x, proj.y, size, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawGlobularCluster(cluster) {
            const proj = project(cluster.x, cluster.y, cluster.z);
            const depthFade = Math.max(0.3, 1 - Math.abs(proj.z) * 0.3);
            
            const size = cluster.size * settings.starSize * viewZoom;
            
            // –°–≤–µ—á–µ–Ω–∏–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è
            const gradient = ctx.createRadialGradient(
                proj.x, proj.y, 0,
                proj.x, proj.y, size * 2
            );
            gradient.addColorStop(0, `rgba(255, 250, 230, ${0.5 * depthFade * settings.brightness})`);
            gradient.addColorStop(0.3, `rgba(255, 240, 200, ${0.2 * depthFade * settings.brightness})`);
            gradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(proj.x, proj.y, size * 2, 0, Math.PI * 2);
            ctx.fill();
            
            // –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–≤—ë–∑–¥—ã –≤ —Å–∫–æ–ø–ª–µ–Ω–∏–∏
            for (let i = 0; i < cluster.stars; i++) {
                const r = Math.random() * size;
                const theta = Math.random() * Math.PI * 2;
                const sx = proj.x + Math.cos(theta) * r * (1 - r / size * 0.5);
                const sy = proj.y + Math.sin(theta) * r * (1 - r / size * 0.5);
                
                const alpha = (1 - r / size) * depthFade * settings.brightness;
                ctx.fillStyle = `rgba(255, 250, 220, ${alpha})`;
                ctx.beginPath();
                ctx.arc(sx, sy, 0.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawStarFormingRegion(region) {
            const proj = project(region.x, region.y, region.z);
            const depthFade = Math.max(0.2, 1 - Math.abs(proj.z) * 0.5);
            
            const size = region.size * settings.starSize * viewZoom;
            const { r, g, b } = region.color;
            
            const gradient = ctx.createRadialGradient(
                proj.x, proj.y, 0,
                proj.x, proj.y, size
            );
            
            const alpha = region.opacity * depthFade * settings.brightness;
            gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, ${alpha})`);
            gradient.addColorStop(0.4, `rgba(${r}, ${g}, ${b}, ${alpha * 0.4})`);
            gradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(proj.x, proj.y, size, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawSatellite(sat) {
            const proj = project(sat.x, sat.y, sat.z);
            const size = sat.size * viewZoom;
            
            // –°–≤–µ—á–µ–Ω–∏–µ –≥–∞–ª–∞–∫—Ç–∏–∫–∏
            const gradient = ctx.createRadialGradient(
                proj.x, proj.y, 0,
                proj.x, proj.y, size * 1.5
            );
            
            const { r, g, b } = sat.color;
            gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, ${0.6 * settings.brightness})`);
            gradient.addColorStop(0.3, `rgba(${r}, ${g}, ${b}, ${0.25 * settings.brightness})`);
            gradient.addColorStop(0.7, `rgba(${r}, ${g}, ${b}, ${0.08 * settings.brightness})`);
            gradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(proj.x, proj.y, size * 1.5, size, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // –ó–≤—ë–∑–¥—ã –≤ –≥–∞–ª–∞–∫—Ç–∏–∫–µ-—Å–ø—É—Ç–Ω–∏–∫–µ
            for (let i = 0; i < sat.stars; i++) {
                const dist = Math.random() * size;
                const angle = Math.random() * Math.PI * 2;
                const sx = proj.x + Math.cos(angle) * dist * (1 + Math.random() * 0.3);
                const sy = proj.y + Math.sin(angle) * dist * 0.6;
                
                const alpha = (1 - dist / size * 0.7) * settings.brightness * 0.8;
                const starSize = 0.3 + Math.random() * 0.5;
                
                ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                ctx.beginPath();
                ctx.arc(sx, sy, starSize, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawCore() {
            const proj = project(0, 0, 0);
            const coreRadius = Math.min(width, height) * settings.coreSize * viewZoom;
            
            // –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ —è–¥—Ä–∞
            for (let i = 5; i >= 0; i--) {
                const radius = coreRadius * (1 + i * 0.8);
                const alpha = settings.coreBrightness * settings.brightness * (0.15 - i * 0.02);
                
                const gradient = ctx.createRadialGradient(
                    proj.x, proj.y, 0,
                    proj.x, proj.y, radius
                );
                
                gradient.addColorStop(0, `rgba(255, 250, 235, ${alpha})`);
                gradient.addColorStop(0.3, `rgba(255, 240, 210, ${alpha * 0.6})`);
                gradient.addColorStop(0.6, `rgba(255, 220, 180, ${alpha * 0.3})`);
                gradient.addColorStop(1, 'transparent');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, radius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –Ø—Ä–∫–æ–µ —è–¥—Ä–æ
            const coreGradient = ctx.createRadialGradient(
                proj.x, proj.y, 0,
                proj.x, proj.y, coreRadius * 0.5
            );
            coreGradient.addColorStop(0, `rgba(255, 255, 250, ${settings.coreBrightness * settings.brightness})`);
            coreGradient.addColorStop(0.5, `rgba(255, 250, 230, ${settings.coreBrightness * settings.brightness * 0.5})`);
            coreGradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = coreGradient;
            ctx.beginPath();
            ctx.arc(proj.x, proj.y, coreRadius * 0.5, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.fillStyle = '#000205';
            ctx.fillRect(0, 0, width, height);
            
            // –§–æ–Ω–æ–≤—ã–µ –∑–≤—ë–∑–¥—ã
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 200; i++) {
                const x = (Math.sin(i * 567.89) * 0.5 + 0.5) * width;
                const y = (Math.cos(i * 123.45) * 0.5 + 0.5) * height;
                ctx.beginPath();
                ctx.arc(x, y, 0.3 + Math.random() * 0.3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≥–ª—É–±–∏–Ω–µ
            let allObjects = [];
            
            // –ì–∞–ª–æ (—Å–∞–º–æ–µ –¥–∞–ª—ë–∫–æ–µ)
            if (settings.showHalo) {
                haloStars.forEach(s => {
                    const proj = project(s.x, s.y, s.z);
                    allObjects.push({ type: 'haloStar', data: s, z: proj.z });
                });
            }
            
            // –°–ø—É—Ç–Ω–∏–∫–∏
            if (settings.showSatellites) {
                satellites.forEach(s => {
                    const proj = project(s.x, s.y, s.z);
                    allObjects.push({ type: 'satellite', data: s, z: proj.z });
                });
            }
            
            // –®–∞—Ä–æ–≤—ã–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è
            if (settings.showClusters) {
                globularClusters.forEach(c => {
                    const proj = project(c.x, c.y, c.z);
                    allObjects.push({ type: 'cluster', data: c, z: proj.z });
                });
            }
            
            // –û–±–ª–∞—Å—Ç–∏ –∑–≤–µ–∑–¥–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            if (settings.showNebulae) {
                starFormingRegions.forEach(r => {
                    const proj = project(r.x, r.y, r.z);
                    allObjects.push({ type: 'nebula', data: r, z: proj.z });
                });
            }
            
            // –ü—ã–ª—å (–ø–µ—Ä–µ–¥ –∑–≤—ë–∑–¥–∞–º–∏ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–º –ø–ª–∞–Ω–µ, –∑–∞ –∑–≤—ë–∑–¥–∞–º–∏ –Ω–∞ –∑–∞–¥–Ω–µ–º)
            if (settings.showDust) {
                dustParticles.forEach(d => {
                    const proj = project(d.x, d.y, d.z);
                    allObjects.push({ type: 'dust', data: d, z: proj.z + 0.001 });
                });
            }
            
            // –ó–≤—ë–∑–¥—ã –¥–∏—Å–∫–∞
            diskStars.forEach(s => {
                const proj = project(s.x, s.y, s.z);
                allObjects.push({ type: 'diskStar', data: s, z: proj.z });
            });
            
            // –ó–≤—ë–∑–¥—ã –±–∞–ª–¥–∂–∞
            bulgeStars.forEach(s => {
                const proj = project(s.x, s.y, s.z);
                allObjects.push({ type: 'bulgeStar', data: s, z: proj.z });
            });
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç –¥–∞–ª—å–Ω–∏—Ö –∫ –±–ª–∏–∂–Ω–∏–º
            allObjects.sort((a, b) => a.z - b.z);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            for (let obj of allObjects) {
                switch (obj.type) {
                    case 'haloStar':
                        drawStar(obj.data, 0.6);
                        break;
                    case 'satellite':
                        drawSatellite(obj.data);
                        break;
                    case 'cluster':
                        drawGlobularCluster(obj.data);
                        break;
                    case 'nebula':
                        drawStarFormingRegion(obj.data);
                        break;
                    case 'dust':
                        drawDust(obj.data);
                        break;
                    case 'diskStar':
                    case 'bulgeStar':
                        drawStar(obj.data);
                        break;
                }
            }
            
            // –Ø–¥—Ä–æ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
            drawCore();
        }
        
        function animate() {
            if (settings.autoRotate) {
                autoRotateAngle += settings.rotationSpeed;
                viewRotation = (settings.rotation * Math.PI / 180) + autoRotateAngle;
            }
            
            draw();
            requestAnimationFrame(animate);
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à—å—é
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            viewRotation += deltaX * 0.005;
            viewTilt += deltaY * 0.005;
            viewTilt = Math.max(0, Math.min(Math.PI / 2, viewTilt));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä—ã
            document.getElementById('rotation').value = (viewRotation * 180 / Math.PI) % 360;
            document.getElementById('rotationVal').textContent = Math.round((viewRotation * 180 / Math.PI) % 360);
            document.getElementById('tilt').value = Math.round(viewTilt * 180 / Math.PI);
            document.getElementById('tiltVal').textContent = Math.round(viewTilt * 180 / Math.PI);
            
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mouseup', () => isDragging = false);
        canvas.addEventListener('mouseleave', () => isDragging = false);
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            viewZoom *= e.deltaY > 0 ? 0.95 : 1.05;
            viewZoom = Math.max(0.3, Math.min(3, viewZoom));
            
            document.getElementById('zoom').value = viewZoom.toFixed(1);
            document.getElementById('zoomVal').textContent = viewZoom.toFixed(1);
        });
        
        canvas.addEventListener('dblclick', () => {
            viewTilt = 77 * Math.PI / 180;
            viewRotation = 35 * Math.PI / 180;
            viewZoom = 1;
            autoRotateAngle = 0;
            updateControlsFromSettings();
        });
        
        // –ü—Ä–∏–≤—è–∑–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function bindControl(id, prop, callback) {
            const el = document.getElementById(id);
            const valDisplay = document.getElementById(id + 'Val');
            
            if (!el) return;
            
            el.addEventListener('input', () => {
                if (el.type === 'checkbox') {
                    settings[prop] = el.checked;
                } else {
                    settings[prop] = parseFloat(el.value);
                    if (valDisplay) valDisplay.textContent = el.value;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∏–¥–∞
                if (prop === 'tilt') viewTilt = settings.tilt * Math.PI / 180;
                if (prop === 'rotation') {
                    viewRotation = settings.rotation * Math.PI / 180;
                    autoRotateAngle = 0;
                }
                if (prop === 'zoom') viewZoom = settings.zoom;
                
                if (callback) callback();
            });
        }
        
        const controlsWithRegen = ['diskStars', 'bulgeStars', 'haloStars', 'spiralWinding', 
                                    'spiralArms', 'armDensity', 'bulgeSize', 'dustAmount'];
        
        controlsWithRegen.forEach(id => bindControl(id, id, generateGalaxy));
        
        const controlsWithoutRegen = ['zoom', 'tilt', 'rotation', 'coreBrightness', 'coreSize',
                                       'dustDensity', 'starSize', 'brightness', 'glow', 
                                       'saturation', 'rotationSpeed'];
        
        controlsWithoutRegen.forEach(id => bindControl(id, id));
        
        const checkboxes = ['showDust', 'showHalo', 'showClusters', 'showSatellites', 
                           'showNebulae', 'autoRotate'];
        
        checkboxes.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', () => {
                    settings[id] = el.checked;
                    if (id === 'autoRotate' && !el.checked) {
                        autoRotateAngle = 0;
                    }
                });
            }
        });
        
        // –ü—Ä–µ—Å–µ—Ç—ã
        document.getElementById('presets').addEventListener('change', (e) => {
            if (!e.target.value) return;
            
            const presets = {
                realistic: {
                    tilt: 77, rotation: 35, zoom: 1,
                    diskStars: 80000, bulgeStars: 25000, haloStars: 8000,
                    spiralWinding: 2.5, spiralArms: 2, armDensity: 0.7,
                    bulgeSize: 0.15, coreBrightness: 1, coreSize: 0.03,
                    dustAmount: 15000, dustDensity: 0.6,
                    starSize: 1, brightness: 1, glow: 1, saturation: 1,
                    showDust: true, showHalo: true, showClusters: true,
                    showSatellites: true, showNebulae: true
                },
                faceon: {
                    tilt: 5, rotation: 0, zoom: 0.9,
                    diskStars: 100000, bulgeStars: 30000, haloStars: 5000,
                    spiralWinding: 2.5, spiralArms: 2, armDensity: 0.8,
                    bulgeSize: 0.12, coreBrightness: 0.8, coreSize: 0.025,
                    dustAmount: 20000, dustDensity: 0.5,
                    starSize: 0.9, brightness: 1.1, glow: 0.8, saturation: 1.1
                },
                edgeon: {
                    tilt: 88, rotation: 0, zoom: 0.8,
                    diskStars: 80000, bulgeStars: 30000, haloStars: 10000,
                    spiralWinding: 2.5, spiralArms: 2, armDensity: 0.7,
                    bulgeSize: 0.18, coreBrightness: 1.2, coreSize: 0.035,
                    dustAmount: 25000, dustDensity: 0.8,
                    starSize: 1, brightness: 1, glow: 1.2, saturation: 0.9
                },
                hubble: {
                    tilt: 77, rotation: 35, zoom: 1.2,
                    diskStars: 120000, bulgeStars: 35000, haloStars: 10000,
                    spiralWinding: 2.5, spiralArms: 2, armDensity: 0.75,
                    bulgeSize: 0.15, coreBrightness: 1.3, coreSize: 0.03,
                    dustAmount: 18000, dustDensity: 0.65,
                    starSize: 0.8, brightness: 1.2, glow: 1.5, saturation: 1.2,
                    showNebulae: true
                },
                infrared: {
                    tilt: 77, rotation: 35, zoom: 1,
                    diskStars: 80000, bulgeStars: 25000, haloStars: 8000,
                    spiralWinding: 2.5, spiralArms: 2, armDensity: 0.7,
                    bulgeSize: 0.15, coreBrightness: 1.5, coreSize: 0.04,
                    dustAmount: 0, dustDensity: 0,
                    starSize: 1.1, brightness: 1.3, glow: 0.5, saturation: 0.3,
                    showDust: false
                },
                artistic: {
                    tilt: 60, rotation: 20, zoom: 1.1,
                    diskStars: 60000, bulgeStars: 20000, haloStars: 12000,
                    spiralWinding: 3, spiralArms: 2, armDensity: 0.8,
                    bulgeSize: 0.18, coreBrightness: 1.5, coreSize: 0.035,
                    dustAmount: 10000, dustDensity: 0.4,
                    starSize: 1.3, brightness: 1.4, glow: 2, saturation: 1.5,
                    showNebulae: true
                }
            };
            
            const preset = presets[e.target.value];
            if (preset) {
                Object.assign(settings, preset);
                viewTilt = settings.tilt * Math.PI / 180;
                viewRotation = settings.rotation * Math.PI / 180;
                viewZoom = settings.zoom;
                autoRotateAngle = 0;
                updateControlsFromSettings();
                generateGalaxy();
            }
            
            e.target.value = '';
        });
        
        function updateControlsFromSettings() {
            const controls = [
                'zoom', 'tilt', 'rotation', 'diskStars', 'bulgeStars', 'haloStars',
                'spiralWinding', 'spiralArms', 'armDensity', 'bulgeSize', 'coreBrightness',
                'coreSize', 'dustAmount', 'dustDensity', 'starSize', 'brightness',
                'glow', 'saturation', 'rotationSpeed'
            ];
            
            controls.forEach(id => {
                const el = document.getElementById(id);
                const val = document.getElementById(id + 'Val');
                if (el && settings[id] !== undefined) {
                    el.value = settings[id];
                    if (val) val.textContent = settings[id];
                }
            });
            
            const checkboxes = ['showDust', 'showHalo', 'showClusters', 'showSatellites', 'showNebulae', 'autoRotate'];
            checkboxes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = settings[id];
            });
        }
        
        function regenerateGalaxy() {
            generateGalaxy();
        }
        
        function resetToDefault() {
            Object.assign(settings, {
                zoom: 1, tilt: 77, rotation: 35,
                diskStars: 80000, bulgeStars: 25000, haloStars: 8000,
                spiralWinding: 2.5, spiralArms: 2, armDensity: 0.7,
                bulgeSize: 0.15, coreBrightness: 1, coreSize: 0.03,
                dustAmount: 15000, dustDensity: 0.6,
                starSize
\<Streaming stoppped because the conversation grew too long for this model\>
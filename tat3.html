<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–∞—Ä—Ç—ã –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    
    <script src="https://api-maps.yandex.ru/2.1/?apikey=dde71a0e-b612-44b7-b53b-82533420240f&lang=ru_RU"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplify-js/1.2.4/simplify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
        }
        
        #map { width: 100%; height: 100%; }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }
        
        .counter {
            background: linear-gradient(135deg, #28a745 0%, #20883a 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .settings-group label {
            font-size: 13px;
            color: #495057;
            white-space: nowrap;
        }
        
        .settings-group input[type="number"] {
            width: 70px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .btn-purple { background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); }
        
        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        #context-menu {
            position: absolute;
            display: none;
            z-index: 2000;
            background: white;
            min-width: 280px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            padding: 8px 0;
            overflow: visible;
        }
        
        #context-menu ul { list-style: none; }
        
        #context-menu li {
            padding: 12px 18px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
            color: #333;
            position: relative;
        }
        
        #context-menu li:hover { background: #f0f4f8; }
        #context-menu li.disabled { color: #adb5bd; cursor: not-allowed; }
        #context-menu li.disabled:hover { background: transparent; }
        
        #context-menu .separator {
            height: 1px;
            background: #e9ecef;
            margin: 6px 0;
            padding: 0;
            cursor: default;
        }
        
        #context-menu i { width: 20px; text-align: center; font-size: 15px; }
        
        .icon-add { color: #28a745; }
        .icon-delete { color: #dc3545; }
        .icon-export { color: #6f42c1; }
        .icon-view { color: #17a2b8; }
        .icon-file { color: #fd7e14; }
        
        /* –ü–æ–¥–º–µ–Ω—é */
        .has-submenu::after {
            content: '\f054';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 10px;
            margin-left: auto;
            color: #adb5bd;
        }
        
        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            min-width: 260px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px 0;
            margin-left: 5px;
        }
        
        .has-submenu:hover > .submenu { display: block; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #28a745 0%, #20883a 100%); }
        .notification.error { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .notification.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .notification.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .loader-content { text-align: center; color: white; }
        
        .loader-spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="control-panel">
    <div class="counter">
        <i class="fas fa-map-marked-alt"></i>
        <span id="counter-text">0 —Ä–∞–π–æ–Ω–æ–≤</span>
    </div>
    
    <div class="settings-group">
        <label for="tolerance">–£–ø—Ä–æ—â–µ–Ω–∏–µ (–º):</label>
        <input type="number" id="tolerance" value="100" min="10" max="1000" step="10">
    </div>
    
    <button class="btn btn-info" id="btn-view">
        <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
    </button>
    
    <button class="btn btn-success" id="btn-load">
        <i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
    </button>
    <input type="file" id="file-input" accept=".json">
    
    <button class="btn btn-danger" id="btn-clear" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">
        <i class="fas fa-trash-alt"></i> –û—á–∏—Å—Ç–∏—Ç—å –ë–î
    </button>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="context-menu">
    <ul>
        <li id="ctx-add">
            <i class="fas fa-plus-circle icon-add"></i>
            –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞
        </li>
        <li id="ctx-delete" class="disabled">
            <i class="fas fa-trash-alt icon-delete"></i>
            <span id="ctx-delete-text">–£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω</span>
        </li>
        <li class="separator"></li>
        <li class="has-submenu">
            <i class="fas fa-download icon-export"></i>
            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            <ul class="submenu">
                <li id="ctx-export-db">
                    <i class="fas fa-database" style="color:#6c757d"></i>
                    –≠–∫—Å–ø–æ—Ä—Ç –ë–î (–ø—Ä–æ–µ–∫—Ç)
                </li>
                <li class="separator"></li>
                <li id="ctx-export-full">
                    <i class="fas fa-file-code" style="color:#007bff"></i>
                    JSON –ø–æ–ª–Ω—ã–π
                </li>
                <li id="ctx-export-simple">
                    <i class="fas fa-file-contract" style="color:#28a745"></i>
                    JSON —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π
                </li>
                <li class="separator"></li>
                <li id="ctx-export-html">
                    <i class="fas fa-globe icon-file"></i>
                    HTML –∫–∞—Ä—Ç–∞ (–∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è)
                </li>
            </ul>
        </li>
    </ul>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications"></div>

<!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
<div class="loader-overlay" id="loader">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script>
// ============================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const CONFIG = {
    map: {
        center: [55.35, 50.75],
        zoom: 7
    },
    db: {
        name: 'TatarstanMapDB',
        version: 1,
        storeName: 'districts'
    },
    api: {
        nspdLayer: 36278,
        baseUrl: 'https://nspd.gov.ru/api/aeggis/v3'
    },
    styles: {
        default: {
            fillColor: 'rgba(0, 123, 255, 0.3)',
            strokeColor: '#0056b3',
            strokeWidth: 2
        },
        hover: {
            fillColor: 'rgba(40, 167, 69, 0.5)',
            strokeColor: '#28a745',
            strokeWidth: 3
        }
    }
};

// –ü—Ä–æ–µ–∫—Ü–∏–∏
proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs');
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

// ============================================================
// –ë–ê–ó–ê –î–ê–ù–ù–´–• (IndexedDB)
// ============================================================
const DB = {
    db: null,
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.db.name, CONFIG.db.version);
            request.onerror = () => reject(request.error);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(CONFIG.db.storeName)) {
                    db.createObjectStore(CONFIG.db.storeName, { keyPath: 'id' });
                }
            };
            request.onsuccess = (e) => {
                this.db = e.target.result;
                resolve();
            };
        });
    },
    
    async save(district) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).put(district);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async remove(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async getAll() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readonly');
            const request = tx.objectStore(CONFIG.db.storeName).getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async clear() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
            tx.objectStore(CONFIG.db.storeName).clear();
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    },
    
    async importBulk(districts) {
        await this.clear();
        const tx = this.db.transaction(CONFIG.db.storeName, 'readwrite');
        const store = tx.objectStore(CONFIG.db.storeName);
        districts.forEach(d => store.put(d));
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    }
};

// ============================================================
// –£–¢–ò–õ–ò–¢–´ –ö–û–û–†–î–ò–ù–ê–¢
// ============================================================
const GeoUtils = {
    toLatLon(coords) {
        const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', coords);
        return [lat, lon];
    },
    
    toMercator(latLon) {
        return proj4('EPSG:4326', 'EPSG:3857', [latLon[1], latLon[0]]);
    },
    
    convertRing(ring) {
        return ring.map(coord => this.toLatLon(coord));
    },
    
    convertGeometry(geometry) {
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => this.convertRing(ring))
            };
        } else if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(polygon => 
                    polygon.map(ring => this.convertRing(ring))
                )
            };
        }
        return geometry;
    },
    
    simplifyRing(ring, tolerance) {
        const points = ring.map(([lat, lon]) => {
            const [x, y] = proj4('EPSG:4326', 'EPSG:3857', [lon, lat]);
            return { x, y };
        });
        const simplified = simplify(points, tolerance, true);
        return simplified.map(p => {
            const [lon, lat] = proj4('EPSG:3857', 'EPSG:4326', [p.x, p.y]);
            return [lat, lon];
        });
    },
    
    simplifyGeometry(geometry, tolerance) {
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => this.simplifyRing(ring, tolerance))
            };
        } else if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(polygon =>
                    polygon.map(ring => this.simplifyRing(ring, tolerance))
                )
            };
        }
        return geometry;
    },
    
    generateId(name) {
        return name.toLowerCase()
            .replace(/[^a-z–∞-—è—ë0-9]/gi, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '') + '-' + Date.now();
    },
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    calcArea(geometry) {
        const getArea = (ring) => {
            let area = 0;
            for (let i = 0; i < ring.length - 1; i++) {
                area += ring[i][0] * ring[i + 1][1];
                area -= ring[i + 1][0] * ring[i][1];
            }
            return Math.abs(area / 2);
        };
        
        if (geometry.type === 'Polygon') {
            return getArea(geometry.coordinates[0]);
        } else if (geometry.type === 'MultiPolygon') {
            return geometry.coordinates.reduce((sum, poly) => sum + getArea(poly[0]), 0);
        }
        return 0;
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    getBounds(districts) {
        let minLat = Infinity, maxLat = -Infinity;
        let minLon = Infinity, maxLon = -Infinity;
        
        const processCoord = ([lat, lon]) => {
            minLat = Math.min(minLat, lat);
            maxLat = Math.max(maxLat, lat);
            minLon = Math.min(minLon, lon);
            maxLon = Math.max(maxLon, lon);
        };
        
        const processRing = ring => ring.forEach(processCoord);
        
        districts.forEach(d => {
            if (d.geometry.type === 'Polygon') {
                d.geometry.coordinates.forEach(processRing);
            } else if (d.geometry.type === 'MultiPolygon') {
                d.geometry.coordinates.forEach(poly => poly.forEach(processRing));
            }
        });
        
        return { minLat, maxLat, minLon, maxLon };
    }
};

// ============================================================
// API –ù–°–ü–î
// ============================================================
const NSPD = {
    async fetchBoundaries(latLon) {
        const [x, y] = GeoUtils.toMercator(latLon);
        const delta = 0.075;
        const bbox = `${x - delta},${y - delta},${x + delta},${y + delta}`;
        
        const params = new URLSearchParams({
            REQUEST: 'GetFeatureInfo',
            SERVICE: 'WMS',
            VERSION: '1.3.0',
            QUERY_LAYERS: CONFIG.api.nspdLayer,
            LAYERS: CONFIG.api.nspdLayer,
            FORMAT: 'image/png',
            STYLES: '',
            TRANSPARENT: 'true',
            INFO_FORMAT: 'application/json',
            FEATURE_COUNT: '10',
            I: '256',
            J: '256',
            WIDTH: '512',
            HEIGHT: '512',
            CRS: 'EPSG:3857',
            BBOX: bbox,
            RANDOM: Math.random()
        });
        
        const url = `${CONFIG.api.baseUrl}/${CONFIG.api.nspdLayer}/wms?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
        
        const data = await response.json();
        if (!data.features || data.features.length === 0) {
            throw new Error('–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }
        
        return data.features;
    },
    
    parseFeature(feature) {
        const name = feature.properties?.options?.name || 
                     feature.properties?.name || 
                     '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const geometry = GeoUtils.convertGeometry(feature.geometry);
        
        return {
            id: GeoUtils.generateId(name),
            name: name,
            geometry: geometry,
            addedAt: new Date().toISOString()
        };
    }
};

// ============================================================
// –ú–û–î–£–õ–¨ –ö–ê–†–¢–´
// ============================================================
const MapModule = {
    map: null,
    objects: new Map(), // id -> polygon
    
    async init() {
        return new Promise((resolve) => {
            this.map = new ymaps.Map('map', {
                center: CONFIG.map.center,
                zoom: CONFIG.map.zoom,
                controls: ['zoomControl', 'fullscreenControl', 'typeSelector', 'rulerControl']
            });
            resolve();
        });
    },
    
    addDistrict(district) {
        const polygon = new ymaps.GeoObject({
            geometry: district.geometry,
            properties: {
                hintContent: district.name,
                districtId: district.id,
                districtName: district.name
            }
        }, {
            ...CONFIG.styles.default
        });
        
        // Hover —ç—Ñ—Ñ–µ–∫—Ç
        polygon.events.add('mouseenter', () => {
            polygon.options.set(CONFIG.styles.hover);
        });
        polygon.events.add('mouseleave', () => {
            polygon.options.set(CONFIG.styles.default);
        });
        
        this.map.geoObjects.add(polygon);
        this.objects.set(district.id, polygon);
    },
    
    removeDistrict(id) {
        const polygon = this.objects.get(id);
        if (polygon) {
            this.map.geoObjects.remove(polygon);
            this.objects.delete(id);
        }
    },
    
    clear() {
        this.map.geoObjects.removeAll();
        this.objects.clear();
    },
    
    fitBounds() {
        if (this.objects.size > 0) {
            const bounds = this.map.geoObjects.getBounds();
            if (bounds) {
                this.map.setBounds(bounds, { checkZoomRange: true, duration: 300 });
            }
        }
    },
    
    // –ù–∞–π—Ç–∏ —Ä–∞–π–æ–Ω –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –∫–ª–∏–∫–∞
    findDistrictAtPoint(coords) {
        let found = null;
        let minArea = Infinity;
        
        // –ò—â–µ–º —Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π –ø–æ–ª–∏–≥–æ–Ω –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º (–æ–Ω –±—É–¥–µ—Ç —Å–≤–µ—Ä—Ö—É)
        this.objects.forEach((polygon, id) => {
            if (polygon.geometry.contains(coords)) {
                const district = App.districtsCache.get(id);
                if (district) {
                    const area = GeoUtils.calcArea(district.geometry);
                    if (area < minArea) {
                        minArea = area;
                        found = { id, polygon, name: district.name };
                    }
                }
            }
        });
        
        return found;
    }
};

// ============================================================
// –≠–ö–°–ü–û–†–¢
// ============================================================
const Exporter = {
    async exportDB() {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        const data = {
            type: 'TatarstanMapProject',
            version: '2.0',
            createdAt: new Date().toISOString(),
            districts: districts
        };
        
        this.download(JSON.stringify(data, null, 2), 'tatarstan_project.json', 'application/json');
        UI.notify('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    },
    
    async exportJSON(simplified = false) {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        
        const features = districts.map(d => {
            const geometry = simplified 
                ? GeoUtils.simplifyGeometry(d.geometry, tolerance)
                : d.geometry;
            return {
                type: 'Feature',
                properties: { name: d.name },
                geometry: geometry
            };
        });
        
        const data = {
            type: 'FeatureCollection',
            meta: {
                created: new Date().toISOString(),
                simplified: simplified,
                tolerance: simplified ? tolerance : null
            },
            features: features
        };
        
        const filename = simplified ? 'tatarstan_simplified.json' : 'tatarstan_full.json';
        this.download(JSON.stringify(data, null, 2), filename, 'application/json');
        UI.notify(`JSON ${simplified ? '—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π' : '–ø–æ–ª–Ω—ã–π'} —Å–æ—Ö—Ä–∞–Ω—ë–Ω`, 'success');
    },
    
    async exportHTML() {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }
        
        UI.showLoader('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML...');
        
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        const simplified = districts.map(d => ({
            name: d.name,
            geometry: GeoUtils.simplifyGeometry(d.geometry, tolerance)
        }));
        
        const html = this.generateHTML(simplified);
        this.download(html, 'tatarstan_map.html', 'text/html');
        
        UI.hideLoader();
        UI.notify('HTML –∫–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    },
    
    generateHTML(districts) {
        const data = JSON.stringify(districts);
        return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h1 {
            color: white;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .map-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
            max-width: 1200px;
            width: 100%;
        }
        svg {
            width: 100%;
            height: auto;
            display: block;
        }
        .district {
            fill: rgba(0, 123, 255, 0.3);
            stroke: #0056b3;
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .district:hover {
            fill: rgba(40, 167, 69, 0.5);
            stroke: #28a745;
            stroke-width: 2;
        }
        .district.selected {
            fill: rgba(255, 193, 7, 0.5);
            stroke: #ffc107;
            stroke-width: 2;
        }
        .info-panel {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .info-panel h2 {
            font-size: 18px;
            font-weight: 600;
        }
        .info-hint {
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞</h1>
    <div class="map-container">
        <svg id="map" viewBox="0 0 1000 700"></svg>
    </div>
    <div class="info-panel">
        <h2 id="district-name">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω</h2>
        <p class="info-hint">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ä–∞–π–æ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
    </div>

<script>
const DISTRICTS = ${data};

function init() {
    const svg = document.getElementById('map');
    const nameEl = document.getElementById('district-name');
    
    // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
    let minLat = Infinity, maxLat = -Infinity;
    let minLon = Infinity, maxLon = -Infinity;
    
    DISTRICTS.forEach(d => {
        const processRing = ring => ring.forEach(([lat, lon]) => {
            minLat = Math.min(minLat, lat);
            maxLat = Math.max(maxLat, lat);
            minLon = Math.min(minLon, lon);
            maxLon = Math.max(maxLon, lon);
        });
        
        if (d.geometry.type === 'Polygon') {
            d.geometry.coordinates.forEach(processRing);
        } else if (d.geometry.type === 'MultiPolygon') {
            d.geometry.coordinates.forEach(poly => poly.forEach(processRing));
        }
    });
    
    const padding = 0.1;
    const latRange = maxLat - minLat;
    const lonRange = maxLon - minLon;
    minLat -= latRange * padding;
    maxLat += latRange * padding;
    minLon -= lonRange * padding;
    maxLon += lonRange * padding;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const toSVG = (lat, lon) => {
        const x = ((lon - minLon) / (maxLon - minLon)) * 1000;
        const y = (1 - (lat - minLat) / (maxLat - minLat)) * 700;
        return [x, y];
    };
    
    const ringToPath = ring => {
        return ring.map((coord, i) => {
            const [x, y] = toSVG(coord[0], coord[1]);
            return (i === 0 ? 'M' : 'L') + x.toFixed(2) + ',' + y.toFixed(2);
        }).join(' ') + ' Z';
    };
    
    let selected = null;
    
    DISTRICTS.forEach(d => {
        let pathData = '';
        
        if (d.geometry.type === 'Polygon') {
            pathData = d.geometry.coordinates.map(ringToPath).join(' ');
        } else if (d.geometry.type === 'MultiPolygon') {
            pathData = d.geometry.coordinates.map(poly => 
                poly.map(ringToPath).join(' ')
            ).join(' ');
        }
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('class', 'district');
        path.setAttribute('data-name', d.name);
        
        path.addEventListener('click', () => {
            if (selected) selected.classList.remove('selected');
            path.classList.add('selected');
            selected = path;
            nameEl.textContent = d.name;
        });
        
        svg.appendChild(path);
    });
}

init();
<\/script>
</body>
</html>`;
    },
    
    download(content, filename, type) {
        const blob = new Blob([content], { type: type + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
};

// ============================================================
// –ü–†–û–°–ú–û–¢–† (–Ω–æ–≤–æ–µ –æ–∫–Ω–æ)
// ============================================================
const Viewer = {
    async open() {
        const districts = await DB.getAll();
        if (districts.length === 0) {
            UI.notify('–ù–µ—Ç —Ä–∞–π–æ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'warning');
            return;
        }
        
        const tolerance = parseInt(document.getElementById('tolerance').value) || 100;
        const simplified = districts.map(d => ({
            name: d.name,
            geometry: GeoUtils.simplifyGeometry(d.geometry, tolerance)
        }));
        
        const html = Exporter.generateHTML(simplified);
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        window.open(url, '_blank', 'width=1200,height=800');
    }
};

// ============================================================
// UI
// ============================================================
const UI = {
    notify(message, type = 'info') {
        const container = document.getElementById('notifications');
        const div = document.createElement('div');
        div.className = `notification ${type}`;
        
        const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
        div.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i> ${message}`;
        
        container.appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => {
            div.classList.remove('show');
            setTimeout(() => div.remove(), 300);
        }, 4000);
    },
    
    showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        document.getElementById('loader-text').textContent = text;
        document.getElementById('loader').style.display = 'flex';
    },
    
    hideLoader() {
        document.getElementById('loader').style.display = 'none';
    },
    
    updateCounter(count) {
        const text = count === 0 ? '0 —Ä–∞–π–æ–Ω–æ–≤' :
                     count === 1 ? '1 —Ä–∞–π–æ–Ω' :
                     count < 5 ? `${count} —Ä–∞–π–æ–Ω–∞` : `${count} —Ä–∞–π–æ–Ω–æ–≤`;
        document.getElementById('counter-text').textContent = text;
    }
};

// ============================================================
// –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
// ============================================================
const App = {
    clickedCoords: null,
    clickedDistrict: null,
    districtsCache: new Map(),
    
    async init() {
        UI.showLoader('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        try {
            await DB.init();
            await MapModule.init();
            await this.loadFromDB();
            this.setupEvents();
            
            UI.hideLoader();
            UI.notify('–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        } catch (err) {
            UI.hideLoader();
            UI.notify('–û—à–∏–±–∫–∞: ' + err.message, 'error');
            console.error(err);
        }
    },
    
    async loadFromDB() {
        const districts = await DB.getAll();
        MapModule.clear();
        this.districtsCache.clear();
        
        districts.forEach(d => {
            this.districtsCache.set(d.id, d);
            MapModule.addDistrict(d);
        });
        
        UI.updateCounter(districts.length);
        if (districts.length > 0) MapModule.fitBounds();
    },
    
    setupEvents() {
        // –ö–∞—Ä—Ç–∞
        MapModule.map.events.add('contextmenu', (e) => this.showContextMenu(e));
        MapModule.map.events.add('click', () => this.hideContextMenu());
        
        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('btn-view').addEventListener('click', () => Viewer.open());
        
        document.getElementById('btn-load').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        document.getElementById('file-input').addEventListener('change', (e) => this.handleImport(e));
        
        document.getElementById('btn-clear').addEventListener('click', async () => {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞–π–æ–Ω—ã?')) return;
            await DB.clear();
            await this.loadFromDB();
            UI.notify('–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
        });
        
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        document.getElementById('ctx-add').addEventListener('click', () => this.addDistricts());
        document.getElementById('ctx-delete').addEventListener('click', () => this.deleteDistrict());
        document.getElementById('ctx-export-db').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportDB(); });
        document.getElementById('ctx-export-full').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportJSON(false); });
        document.getElementById('ctx-export-simple').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportJSON(true); });
        document.getElementById('ctx-export-html').addEventListener('click', () => { this.hideContextMenu(); Exporter.exportHTML(); });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) {
                this.hideContextMenu();
            }
        });
    },
    
    showContextMenu(e) {
        e.preventDefault();
        this.clickedCoords = e.get('coords');
        
        // –ò—â–µ–º —Ä–∞–π–æ–Ω –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        this.clickedDistrict = MapModule.findDistrictAtPoint(this.clickedCoords);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É–Ω–∫—Ç —É–¥–∞–ª–µ–Ω–∏—è
        const deleteItem = document.getElementById('ctx-delete');
        const deleteText = document.getElementById('ctx-delete-text');
        
        if (this.clickedDistrict) {
            deleteItem.classList.remove('disabled');
            deleteText.textContent = `–£–¥–∞–ª–∏—Ç—å: ${this.clickedDistrict.name}`;
        } else {
            deleteItem.classList.add('disabled');
            deleteText.textContent = '–£–¥–∞–ª–∏—Ç—å —Ä–∞–π–æ–Ω';
        }
        
        const menu = document.getElementById('context-menu');
        const pos = e.get('position');
        menu.style.left = pos[0] + 'px';
        menu.style.top = pos[1] + 'px';
        menu.style.display = 'block';
    },
    
    hideContextMenu() {
        document.getElementById('context-menu').style.display = 'none';
    },
    
    async addDistricts() {
        this.hideContextMenu();
        if (!this.clickedCoords) return;
        
        UI.showLoader('–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü...');
        
        try {
            const features = await NSPD.fetchBoundaries(this.clickedCoords);
            const existingIds = new Set(this.districtsCache.keys());
            
            const newDistricts = features
                .map(f => NSPD.parseFeature(f))
                .filter(d => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∏–º–µ–Ω–∏, —Ç.–∫. id –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤—ã–π
                    for (const [, existing] of this.districtsCache) {
                        if (existing.name === d.name) return false;
                    }
                    return true;
                });
            
            if (newDistricts.length === 0) {
                throw new Error('–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
            }
            
            for (const district of newDistricts) {
                await DB.save(district);
                this.districtsCache.set(district.id, district);
                MapModule.addDistrict(district);
            }
            
            UI.updateCounter(this.districtsCache.size);
            MapModule.fitBounds();
            UI.notify(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${newDistricts.length} —à—Ç.`, 'success');
            
        } catch (err) {
            UI.notify(err.message, 'error');
        }
        
        UI.hideLoader();
    },
    
    async deleteDistrict() {
        this.hideContextMenu();
        
        if (!this.clickedDistrict) {
            UI.notify('–†–∞–π–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω', 'warning');
            return;
        }
        
        const { id, name } = this.clickedDistrict;
        
        await DB.remove(id);
        this.districtsCache.delete(id);
        MapModule.removeDistrict(id);
        
        UI.updateCounter(this.districtsCache.size);
        UI.notify(`–£–¥–∞–ª—ë–Ω: ${name}`, 'info');
        
        this.clickedDistrict = null;
    },
    
    async handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        UI.showLoader('–ó–∞–≥—Ä—É–∑–∫–∞...');
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                let districts = [];
                
                if (data.type === 'TatarstanMapProject' && data.districts) {
                    districts = data.districts;
                } else if (data.type === 'FeatureCollection' && data.features) {
                    districts = data.features.map(f => ({
                        id: GeoUtils.generateId(f.properties?.name || 'unknown'),
                        name: f.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        geometry: f.geometry,
                        addedAt: new Date().toISOString()
                    }));
                } else if (data.features) {
                    districts = data.features.map(f => ({
                        id: f.id || GeoUtils.generateId(f.name || 'unknown'),
                        name: f.name || f.properties?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        geometry: f.geometry || { type: f.type, coordinates: f.coords },
                        addedAt: f.addedAt || new Date().toISOString()
                    }));
                } else {
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
                }
                
                await DB.importBulk(districts);
                await this.loadFromDB();
                UI.notify(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${districts.length} —Ä–∞–π–æ–Ω–æ–≤`, 'success');
                
            } catch (err) {
                UI.notify('–û—à–∏–±–∫–∞: ' + err.message, 'error');
            }
            UI.hideLoader();
        };
        
        reader.readAsText(file);
        e.target.value = '';
    }
};

// –ó–∞–ø—É—Å–∫
ymaps.ready(() => App.init());
</script>

</body>
</html>
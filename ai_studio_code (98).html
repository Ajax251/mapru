<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профессиональный Grid-график (Финальная версия)</title>
    <!-- !!! ИСПРАВЛЕННАЯ ССЫЛКА НА ПОЛНУЮ ВЕРСИЮ БИБЛИОТЕКИ !!! -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/3.8.0/lightweight-charts.standalone.production.js"></script>
    <!-- Подключаем PapaParse для удобной работы с CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        :root {
            --dark-bg: #1e222d; --dark-text: #d1d4dc; --dark-panel: #2a2e39; --dark-border: #444;
            --light-bg: #ffffff; --light-text: #333; --light-panel: #f8f9fa; --light-border: #dee2e6;
            --accent-color: #2962ff; --accent-hover: #1e4bd8;
        }
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0; padding: 0; display: flex; flex-direction: column;
            height: 100vh; overflow: hidden; transition: background-color 0.3s, color 0.3s;
        }
        body.dark-theme { background-color: var(--dark-bg); color: var(--dark-text); }
        body.light-theme { background-color: var(--light-bg); color: var(--light-text); }
        .controls {
            padding: 15px 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); flex-shrink: 0;
            background-color: var(--light-panel); border-bottom: 1px solid var(--light-border);
        }
        body.dark-theme .controls { background-color: var(--dark-panel); border-bottom: 1px solid var(--dark-border); }
        .chart-container { flex-grow: 1; position: relative; }
        h1 { margin: 0 10px 0 0; font-size: 20px; font-weight: 700; white-space: nowrap; }
        input[type="file"] { display: none; }
        .btn {
            display: inline-block; padding: 8px 16px; background-color: var(--accent-color);
            color: white; border: none; border-radius: 5px; cursor: pointer;
            transition: all 0.3s ease; margin: 5px; font-size: 13px; font-weight: 500;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        select, input[type="number"] {
            margin: 5px; padding: 8px; border: 1px solid var(--light-border); border-radius: 5px;
            font-size: 13px; cursor: pointer;
            background-color: #fff; color: #333;
        }
        body.dark-theme select, body.dark-theme input[type="number"] {
            background-color: #40434f; color: var(--dark-text); border-color: var(--dark-border);
        }
    </style>
</head>
<body class="dark-theme">
    <div class="controls">
        <h1>Grid-график</h1>
        <div>
            <label for="file-input" class="btn">Загрузить CSV</label>
            <input type="file" id="file-input" accept=".csv,.txt">
            <input type="number" id="gridStepPips" value="50" title="Шаг сетки в пунктах">
            <select id="theme">
                <option value="dark">Темная тема</option>
                <option value="light">Светлая тема</option>
            </select>
        </div>
    </div>
    <div id="chart-container"></div>

    <script>
        // --- Весь основной код теперь внутри window.onload ---
        window.onload = function () {
            // --- Глобальные переменные ---
            let chart = null;
            let series = null;
            let g_parsedData = null; // Глобальный кеш для данных

            const chartContainer = document.getElementById('chart-container');
            const themeSelect = document.getElementById('theme');
            const fileInput = document.getElementById('file-input');
            const gridStepInput = document.getElementById('gridStepPips');

            function buildChart() {
                if (!g_parsedData) { alert('Сначала загрузите или вставьте данные.'); return; }
                const gridStepPips = parseInt(gridStepInput.value);
                if (!gridStepPips || gridStepPips <= 0) { alert('Введите корректный шаг сетки.'); return; }
                
                // --- НАДЕЖНОЕ ПЕРЕСОЗДАНИЕ ГРАФИКА ---
                if (chart) chart.remove();
                
                const currentTheme = themeSelect.value;
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth, height: chartContainer.clientHeight,
                    layout: {
                        background: { type: 'solid', color: currentTheme === 'dark' ? '#1e222d' : '#ffffff' },
                        textColor: currentTheme === 'dark' ? '#d1d4dc' : '#333333',
                    },
                    grid: { vertLines: { color: 'rgba(197, 203, 206, 0.1)' }, horzLines: { color: 'rgba(197, 203, 206, 0.1)' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    timeScale: { timeVisible: true, secondsVisible: false },
                    handleScroll: { mouseWheel: true, pressedMouseMove: true },
                    handleScale: { axisPressedMouseMove: true, mouseWheel: true, pinch: true },
                });
                
                series = chart.addLineSeries({ color: '#2962ff', lineWidth: 2 });
                
                const gridChartData = generateGridData(g_parsedData, gridStepPips);
                logSummary(g_parsedData, gridChartData, gridStepPips);
                
                series.setData(gridChartData);
                chart.timeScale().fitContent();
            }

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        complete: (results) => {
                            g_parsedData = parseRawData(results.data);
                            if (g_parsedData && g_parsedData.length > 0) buildChart();
                            else alert('Не удалось обработать данные из файла. Проверьте формат.');
                        }
                    });
                }
            });

            document.addEventListener('paste', (e) => {
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const parsedRows = Papa.parse(pastedText, { skipEmptyLines: true }).data;
                g_parsedData = parseRawData(parsedRows);
                if (g_parsedData && g_parsedData.length > 0) {
                    alert(`${g_parsedData.length} строк успешно вставлено.`);
                    buildChart();
                } else {
                    alert('Не удалось обработать вставленные данные. Проверьте формат.');
                }
            });

            gridStepInput.addEventListener('change', buildChart);
            
            themeSelect.addEventListener('change', () => {
                document.body.className = themeSelect.value + '-theme';
                if (chart) {
                    const isDark = themeSelect.value === 'dark';
                    chart.applyOptions({
                        layout: { background: { color: isDark ? '#1e222d' : '#ffffff' }, textColor: isDark ? '#d1d4dc' : '#333' }
                    });
                }
            });
            
            window.addEventListener('resize', () => {
                if (chart) chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
            });

            window.addEventListener('keydown', (e) => {
                if (!chart) return;
                const timeScale = chart.timeScale();
                const logicalRange = timeScale.getVisibleLogicalRange();
                const scrollAmount = logicalRange ? Math.max(1, Math.round((logicalRange.to - logicalRange.from) * 0.1)) : 10;
                
                switch(e.key) {
                    case 'ArrowLeft': timeScale.scrollBy(-scrollAmount); break;
                    case 'ArrowRight': timeScale.scrollBy(scrollAmount); break;
                    case '+': case '=': timeScale.zoomIn(); break;
                    case '-': timeScale.zoomOut(); break;
                }
            });
            
            // Показываем пустой график при запуске, чтобы было понятно, что все загрузилось
            chart = LightweightCharts.createChart(chartContainer, { width: chartContainer.clientWidth, height: chartContainer.clientHeight });
        };

        // --- Функции-помощники ---
        function parseRawData(dataRows) {
            const firstRow = dataRows[0];
            if (!firstRow) return null;
            if (firstRow.length >= 6) { // OHLCV
                return dataRows.map(row => {
                    const p = (v) => parseFloat(String(v).replace(',', '.'));
                    return { date: row[0], timeStr: row[1], open: p(row[2]), high: p(row[3]), low: p(row[4]), close: p(row[5]) };
                }).filter(i => i && !isNaN(i.close));
            } else { // Простой
                return dataRows.map(row => {
                    const p = parseFloat(String(row[1]).replace(',', '.'));
                    if (isNaN(p)) return null;
                    return { date: row[0], timeStr: "00:00", open: p, high: p, low: p, close: p };
                }).filter(Boolean);
            }
        }

        function generateGridData(priceData, gridStepPips) {
            const firstPrice = priceData[0].close;
            const decimals = Math.max(...priceData.map(p => (p.close.toString().split('.')[1] || '').length));
            const pointMultiplier = (decimals === 5 || decimals === 3) ? 10 : 1;
            const gridStepPrice = gridStepPips * pointMultiplier * (1 / Math.pow(10, decimals));
            const dataPoints = [];
            let currentLevel = Math.round(firstPrice / gridStepPrice) * gridStepPrice;
            
            const parseDate = (d, t) => {
                const [year, month, day] = d.split('.').map(Number);
                const [hours, minutes] = t ? t.split(':').map(Number) : [0, 0];
                return Date.UTC(year, month - 1, day, hours, minutes) / 1000;
            }

            dataPoints.push({ time: parseDate(priceData[0].date, priceData[0].timeStr), value: currentLevel });

            for (const candle of priceData) {
                const candleDirection = candle.close >= candle.open ? 'up' : 'down';
                const processMoves = (primaryMove, secondaryMove) => {
                    while (primaryMove(candle, currentLevel, gridStepPrice)) {
                        currentLevel = primaryMove === checkUp ? currentLevel + gridStepPrice : currentLevel - gridStepPrice;
                        dataPoints.push({ time: parseDate(candle.date, candle.timeStr), value: currentLevel });
                    }
                    while (secondaryMove(candle, currentLevel, gridStepPrice)) {
                        currentLevel = secondaryMove === checkUp ? currentLevel + gridStepPrice : currentLevel - gridStepPrice;
                        dataPoints.push({ time: parseDate(candle.date, candle.timeStr), value: currentLevel });
                    }
                };
                const checkUp = (c, level, step) => c.high >= level + step;
                const checkDown = (c, level, step) => c.low <= level - step;
                if (candleDirection === 'up') processMoves(checkUp, checkDown);
                else processMoves(checkDown, checkUp);
            }
            return dataPoints;
        }
        
        function logSummary(parsedData, gridResult, gridStepPips) {
             console.clear();
             console.log("--- Сводка по обработке данных ---");
             console.log(`Шаг сетки: ${gridStepPips} пипсов.`);
             console.log(`Всего входных строк: ${parsedData.length}`);
             console.log(`Сгенерировано событий: ${gridResult.length}`);
             console.log("--- Первые 5 строк исходных данных: ---");
             console.table(parsedData.slice(0, 5));
             console.log("--- Последние 5 строк исходных данных: ---");
             console.table(parsedData.slice(-5));
             console.log("------------------------------------");
        }
    </script>
</body>
</html>